This file is a merged representation of the entire codebase, combined into a single document by Repomix.

# File Summary

## Purpose
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.

## File Format
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  a. A header with the file path (## File: path/to/file)
  b. The full contents of the file in a code block

## Usage Guidelines
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.

## Notes
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)

# Directory Structure
```
.gitignore
CHANGELOG.md
eslint.config.mjs
lib/supabase.ts
LICENSE
next.config.ts
package.json
postcss.config.mjs
public/.nojekyll
public/file.svg
public/globe.svg
public/next.svg
public/vercel.svg
public/window.svg
README.md
repomix-output.xml
src/app/admin/calendar/_components/CalendarSidebarWrapper.tsx
src/app/admin/calendar/layout.tsx
src/app/admin/calendar/page.tsx
src/app/admin/grid/page.tsx
src/app/admin/layout.tsx
src/app/admin/page.tsx
src/app/admin/projects/[id]/page.tsx
src/app/admin/projects/new/page.tsx
src/app/admin/projects/page.tsx
src/app/admin/settings/page.tsx
src/app/admin/staff/page.tsx
src/app/ca-nhan/page.tsx
src/app/dich-vu/page.tsx
src/app/du-an/[slug]/page.tsx
src/app/du-an/[slug]/ProjectClientPage.tsx
src/app/error.tsx
src/app/favicon.ico
src/app/gioi-thieu/page.tsx
src/app/globals.css
src/app/layout.tsx
src/app/loading.tsx
src/app/login/page.tsx
src/app/not-found.tsx
src/app/page.tsx
src/app/providers.tsx
src/app/styles/BtsSection.module.css
src/app/styles/DichVu.module.css
src/app/styles/ProjectArticle.module.css
src/app/thoi-trang/page.tsx
src/app/thuong-mai/page.tsx
src/assets/about/about.webp
src/assets/about/avatar.webp
src/assets/about/carousel_01_2020.webp
src/assets/about/carousel_02_2022.webp
src/assets/about/carousel_03_2024.webp
src/assets/about/carousel_04_2025.webp
src/assets/project/ca-nhan/Personal_01_thumnails.webp
src/assets/project/ca-nhan/Personal_02_02.webp
src/assets/project/ca-nhan/Personal_02_03.webp
src/assets/project/ca-nhan/Personal_02_04.webp
src/assets/project/ca-nhan/Personal_02_05.webp
src/assets/project/ca-nhan/Personal_02_06.webp
src/assets/project/ca-nhan/Personal_02_07.webp
src/assets/project/ca-nhan/Personal_02_08.webp
src/assets/project/ca-nhan/Personal_02_09.webp
src/assets/project/ca-nhan/Personal_02_thumnails.webp
src/assets/project/thoi-trang/Fashion_01_thumnails.webp
src/assets/project/thoi-trang/Fashion_02_thumnails.webp
src/assets/project/thoi-trang/Fashion_03_thumnails.webp
src/assets/project/thuong-mai/Commercial_01_thumnails.webp
src/assets/project/thuong-mai/Commercial_02_01.webp
src/assets/project/thuong-mai/Commercial_02_02.webp
src/assets/project/thuong-mai/Commercial_02_03.webp
src/assets/project/thuong-mai/Commercial_02_thumnails.webp
src/assets/section_01/hero-background.webp
src/assets/section_04/bts_01.jpg
src/assets/section_04/bts_02.jpg
src/assets/section_04/bts_03.jpg
src/assets/section_04/bts_04.jpg
src/assets/section_04/bts_05.jpg
src/assets/section_04/bts_06.jpg
src/assets/service/section_01/room_A.webp
src/assets/service/section_01/room_B.webp
src/assets/service/section_01/room_C.webp
src/assets/service/section_01/room_D.webp
src/assets/service/section_02/aputure-amaran-300c.webp
src/assets/service/section_02/devices.webp
src/assets/service/section_02/GODOX-DP600III-V.webp
src/assets/service/section_02/GODOX-GD-DP400II-V.webp
src/assets/service/section_02/GODOX-QR-P120.webp
src/assets/service/section_02/GODOX-QR-P150T.webp
src/assets/service/section_02/GODOX-QR-P60T.webp
src/assets/service/section_02/GODOX-QR-P90.webp
src/assets/service/section_02/GODOX-QS-1200.webp
src/assets/service/section_02/GODOX-QS-400.webp
src/assets/service/section_02/GODOX-QS-800.webp
src/assets/service/section_02/GODOX-QT400IIIM.webp
src/assets/service/section_02/GODOX-QT600II.webp
src/components/AboutMilestonesSection.tsx
src/components/AboutPhilosophySection.tsx
src/components/admin/calendar/BookingCalendar.tsx
src/components/admin/calendar/BookingCreateModal.tsx
src/components/admin/calendar/BookingDetailModal.tsx
src/components/admin/calendar/CalendarSidebar.tsx
src/components/admin/calendar/CustomToolbar.tsx
src/components/admin/calendar/NavCalendarWidget.tsx
src/components/admin/CreateStaffModal.tsx
src/components/admin/DashboardActions.tsx
src/components/admin/DashboardCalendar.tsx
src/components/admin/DashboardFilter.tsx
src/components/admin/DeleteProjectButton.tsx
src/components/admin/GrowthChart.tsx
src/components/admin/PortfolioGridEditor.tsx
src/components/admin/ProjectForm.tsx
src/components/admin/ProjectTable.tsx
src/components/admin/SettingsForm.tsx
src/components/admin/SortableProjectItem.tsx
src/components/admin/StaffPageHeader.tsx
src/components/admin/StaffTable.tsx
src/components/admin/TodaySchedule.tsx
src/components/AnimatedProfileImage.tsx
src/components/BrandScroller.tsx
src/components/BtsSection.tsx
src/components/ContactSection.tsx
src/components/Container.tsx
src/components/Footer.tsx
src/components/Header.tsx
src/components/HeroSection.tsx
src/components/HomePageContent.tsx
src/components/LayoutWrapper.tsx
src/components/PhilosophyBackground.tsx
src/components/PortfolioSection.tsx
src/components/progressive-carousel.tsx
src/components/project-grid.tsx
src/components/ProjectMasonryGrid.tsx
src/components/ProjectNavigation.tsx
src/components/ProjectShowcase.tsx
src/components/scroll-text-marque.tsx
src/components/ScrollingText.tsx
src/components/ScrollToTopButton.tsx
src/components/Spinner.tsx
src/components/ThemeToggle.tsx
src/components/ui/ConfirmModal.tsx
src/components/ui/ModalPortal.tsx
src/components/ui/SelectBox.tsx
src/context/CalendarContext.tsx
src/data/bts.ts
src/data/projects-master-data.ts
src/fonts/cameliya-regular.ttf
src/lib/actions.ts
src/lib/actions/booking-details.ts
src/lib/actions/bookings.ts
src/lib/actions/customers.ts
src/lib/actions/project.ts
src/lib/actions/settings.ts
src/lib/actions/stats.ts
src/lib/actions/studio.ts
src/lib/actions/users.ts
src/lib/constants.ts
src/lib/image-utils.ts
src/lib/seed-helpers.ts
src/lib/supabase/client.ts
src/lib/supabase/server.ts
src/lib/utils.ts
src/middleware.ts
src/types/grid-project.ts
src/types/supabase.ts
tailwind.config.ts
tsconfig.json
```

# Files

## File: repomix-output.xml
```xml
This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.gitignore
CHANGELOG.md
eslint.config.mjs
lib/supabase.ts
LICENSE
next.config.ts
package.json
postcss.config.mjs
public/.nojekyll
public/file.svg
public/globe.svg
public/next.svg
public/vercel.svg
public/window.svg
README.md
src/app/admin/calendar/_components/CalendarSidebarWrapper.tsx
src/app/admin/calendar/layout.tsx
src/app/admin/calendar/page.tsx
src/app/admin/grid/page.tsx
src/app/admin/layout.tsx
src/app/admin/page.tsx
src/app/admin/projects/[id]/page.tsx
src/app/admin/projects/new/page.tsx
src/app/admin/projects/page.tsx
src/app/admin/settings/page.tsx
src/app/admin/staff/page.tsx
src/app/ca-nhan/page.tsx
src/app/dich-vu/page.tsx
src/app/du-an/[slug]/page.tsx
src/app/du-an/[slug]/ProjectClientPage.tsx
src/app/error.tsx
src/app/favicon.ico
src/app/gioi-thieu/page.tsx
src/app/globals.css
src/app/layout.tsx
src/app/loading.tsx
src/app/login/page.tsx
src/app/not-found.tsx
src/app/page.tsx
src/app/providers.tsx
src/app/styles/BtsSection.module.css
src/app/styles/DichVu.module.css
src/app/styles/ProjectArticle.module.css
src/app/thoi-trang/page.tsx
src/app/thuong-mai/page.tsx
src/assets/about/about.webp
src/assets/about/avatar.webp
src/assets/about/carousel_01_2020.webp
src/assets/about/carousel_02_2022.webp
src/assets/about/carousel_03_2024.webp
src/assets/about/carousel_04_2025.webp
src/assets/project/ca-nhan/Personal_01_thumnails.webp
src/assets/project/ca-nhan/Personal_02_02.webp
src/assets/project/ca-nhan/Personal_02_03.webp
src/assets/project/ca-nhan/Personal_02_04.webp
src/assets/project/ca-nhan/Personal_02_05.webp
src/assets/project/ca-nhan/Personal_02_06.webp
src/assets/project/ca-nhan/Personal_02_07.webp
src/assets/project/ca-nhan/Personal_02_08.webp
src/assets/project/ca-nhan/Personal_02_09.webp
src/assets/project/ca-nhan/Personal_02_thumnails.webp
src/assets/project/thoi-trang/Fashion_01_thumnails.webp
src/assets/project/thoi-trang/Fashion_02_thumnails.webp
src/assets/project/thoi-trang/Fashion_03_thumnails.webp
src/assets/project/thuong-mai/Commercial_01_thumnails.webp
src/assets/project/thuong-mai/Commercial_02_01.webp
src/assets/project/thuong-mai/Commercial_02_02.webp
src/assets/project/thuong-mai/Commercial_02_03.webp
src/assets/project/thuong-mai/Commercial_02_thumnails.webp
src/assets/section_01/hero-background.webp
src/assets/section_04/bts_01.jpg
src/assets/section_04/bts_02.jpg
src/assets/section_04/bts_03.jpg
src/assets/section_04/bts_04.jpg
src/assets/section_04/bts_05.jpg
src/assets/section_04/bts_06.jpg
src/assets/service/section_01/room_A.webp
src/assets/service/section_01/room_B.webp
src/assets/service/section_01/room_C.webp
src/assets/service/section_01/room_D.webp
src/assets/service/section_02/aputure-amaran-300c.webp
src/assets/service/section_02/devices.webp
src/assets/service/section_02/GODOX-DP600III-V.webp
src/assets/service/section_02/GODOX-GD-DP400II-V.webp
src/assets/service/section_02/GODOX-QR-P120.webp
src/assets/service/section_02/GODOX-QR-P150T.webp
src/assets/service/section_02/GODOX-QR-P60T.webp
src/assets/service/section_02/GODOX-QR-P90.webp
src/assets/service/section_02/GODOX-QS-1200.webp
src/assets/service/section_02/GODOX-QS-400.webp
src/assets/service/section_02/GODOX-QS-800.webp
src/assets/service/section_02/GODOX-QT400IIIM.webp
src/assets/service/section_02/GODOX-QT600II.webp
src/components/AboutMilestonesSection.tsx
src/components/AboutPhilosophySection.tsx
src/components/admin/calendar/BookingCalendar.tsx
src/components/admin/calendar/BookingCreateModal.tsx
src/components/admin/calendar/BookingDetailModal.tsx
src/components/admin/calendar/CalendarSidebar.tsx
src/components/admin/calendar/CustomToolbar.tsx
src/components/admin/calendar/NavCalendarWidget.tsx
src/components/admin/CreateStaffModal.tsx
src/components/admin/DashboardActions.tsx
src/components/admin/DashboardCalendar.tsx
src/components/admin/DashboardFilter.tsx
src/components/admin/DeleteProjectButton.tsx
src/components/admin/GrowthChart.tsx
src/components/admin/PortfolioGridEditor.tsx
src/components/admin/ProjectForm.tsx
src/components/admin/ProjectTable.tsx
src/components/admin/SettingsForm.tsx
src/components/admin/SortableProjectItem.tsx
src/components/admin/StaffPageHeader.tsx
src/components/admin/StaffTable.tsx
src/components/admin/TodaySchedule.tsx
src/components/AnimatedProfileImage.tsx
src/components/BrandScroller.tsx
src/components/BtsSection.tsx
src/components/ContactSection.tsx
src/components/Container.tsx
src/components/Footer.tsx
src/components/Header.tsx
src/components/HeroSection.tsx
src/components/HomePageContent.tsx
src/components/LayoutWrapper.tsx
src/components/PhilosophyBackground.tsx
src/components/PortfolioSection.tsx
src/components/progressive-carousel.tsx
src/components/project-grid.tsx
src/components/ProjectMasonryGrid.tsx
src/components/ProjectNavigation.tsx
src/components/ProjectShowcase.tsx
src/components/scroll-text-marque.tsx
src/components/ScrollingText.tsx
src/components/ScrollToTopButton.tsx
src/components/Spinner.tsx
src/components/ThemeToggle.tsx
src/components/ui/ConfirmModal.tsx
src/components/ui/ModalPortal.tsx
src/components/ui/SelectBox.tsx
src/context/CalendarContext.tsx
src/data/bts.ts
src/data/projects-master-data.ts
src/fonts/cameliya-regular.ttf
src/lib/actions.ts
src/lib/actions/booking-details.ts
src/lib/actions/bookings.ts
src/lib/actions/customers.ts
src/lib/actions/project.ts
src/lib/actions/settings.ts
src/lib/actions/stats.ts
src/lib/actions/studio.ts
src/lib/actions/users.ts
src/lib/constants.ts
src/lib/image-utils.ts
src/lib/seed-helpers.ts
src/lib/supabase/client.ts
src/lib/supabase/server.ts
src/lib/utils.ts
src/middleware.ts
src/types/grid-project.ts
src/types/supabase.ts
tailwind.config.ts
tsconfig.json
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="src/components/admin/calendar/BookingDetailModal.tsx">
// src/components/admin/calendar/BookingDetailModal.tsx
'use client';

import React, { useState, useEffect, useCallback } from 'react';
import { Check, Trash2, Plus, DollarSign, User, FileText, RotateCcw, Loader2, Camera, Coffee, AlertCircle, LogIn, LogOut } from 'lucide-react';
import { toast } from 'sonner';
import ModalPortal from '@/components/ui/ModalPortal';
import { getBookingDetails, addBookingService, removeBookingService, checkInCustomer, checkOutCustomer, confirmPayment, finalizeBooking } from '@/lib/actions/booking-details';
import { ServiceItem } from '@/lib/actions/studio';
import { format } from 'date-fns';
import { calculateBilling, fmtMoney, formatDuration } from '@/lib/utils';

interface BookingDetailModalProps {
  isOpen: boolean;
  onClose: () => void;
  bookingId: number | null;
  servicesList: ServiceItem[];
}

interface BookingItemDetail {
    booking_item_id: number;
    room_id: number;
    start_dt: string;
    end_dt: string;
    price_snapshot: number;
    rooms: {
        name: string | null;
        code: string | null;
    } | null;
}

interface BookingServiceDetail {
    booking_service_id: number;
    quantity: number;
    unit_price_snapshot: number;
    computed_amount: number;
    type: string;
    services: {
        name: string;
        unit: string;
        price: number;
        category: string;
    } | null;
}

interface BookingDetail {
    booking_id: number;
    status: string;
    deposit_amount: number;
    check_in_at?: string;
    check_out_at?: string;
    customers: {
        full_name: string | null;
        phone: string | null;
    } | null;
    booking_items: BookingItemDetail[];       
    booking_services: BookingServiceDetail[]; 
}

// Định nghĩa kiểu dữ liệu cho BillingInfo
interface FeeDetail {
    isBillable: boolean;
    minutes: number;
    billableHours: number;
    amount: number;
    message: string;
}

interface BillingInfo {
    totalSurcharge: number;
    earlyFee: FeeDetail;
    otFee: FeeDetail;
    surchargeMessages?: string[];
}

// Giá trị mặc định để tránh lỗi undefined
const DEFAULT_FEE: FeeDetail = {
    isBillable: false,
    minutes: 0,
    billableHours: 0,
    amount: 0,
    message: ''
};

const DEFAULT_BILLING: BillingInfo = {
    totalSurcharge: 0,
    earlyFee: DEFAULT_FEE,
    otFee: DEFAULT_FEE
};

export default function BookingDetailModal({ isOpen, onClose, bookingId, servicesList }: BookingDetailModalProps) {
  const [booking, setBooking] = useState<BookingDetail | null>(null);
  const [loading, setLoading] = useState(false);
  
  // State Tabs
  const [activeTab, setActiveTab] = useState<'equipment' | 'fnb' | 'surcharge'>('equipment');
  const [isAddingService, setIsAddingService] = useState(false);
  const [selectedServiceId, setSelectedServiceId] = useState<string>('');
  const [qty, setQty] = useState(1);
  const [otPrice] = useState(300000); // Giá OT mặc định

  const fetchDetails = useCallback(async () => {
    if (!bookingId) return;
    setLoading(true);
    const res = await getBookingDetails(bookingId);
    if (res.success) {
        setBooking(res.data as unknown as BookingDetail);
    } else {
        toast.error(res.error);
    }
    setLoading(false);
  }, [bookingId]);

  useEffect(() => {
    if (isOpen && bookingId) {
      fetchDetails();
    } else {
        setBooking(null);
    }
  }, [isOpen, bookingId, fetchDetails]);

  // --- ACTIONS ---
  const handleCheckIn = async () => {
      if (!booking || !booking.booking_items || booking.booking_items.length === 0) return;
      const roomId = booking.booking_items[0].room_id; 
      const bookedStart = booking.booking_items[0].start_dt;
      
      const res = await checkInCustomer(booking.booking_id, roomId, bookedStart);
      if(res.success) { toast.success("Checked-in thành công!"); fetchDetails(); }
      else toast.error(res.error);
  }

  const handleCheckOut = async () => {
      if (!booking) return;
      const res = await checkOutCustomer(booking.booking_id);
      if(res.success) { toast.success("Đã dừng giờ (Check-out)!"); fetchDetails(); }
      else toast.error(res.error);
  }

  const handlePayment = async (totalToPay: number) => {
      if (!booking) return;
      if(!confirm(`Xác nhận khách đã thanh toán ${fmtMoney(totalToPay)}?`)) return;

      const res = await confirmPayment(booking.booking_id, totalToPay);
      if(res.success) { toast.success("Thanh toán thành công!"); fetchDetails(); }
      else toast.error(res.error);
  }

  const handleFinalize = async () => {
      if (!booking) return;
      const res = await finalizeBooking(booking.booking_id);
      if(res.success) { toast.success("Đơn hàng đã đóng!"); fetchDetails(); onClose(); }
      else toast.error(res.error);
  }

  const handleAddService = async () => {
     if (!selectedServiceId || !booking) return;
     const service = servicesList.find(s => s.service_id === Number(selectedServiceId));
     if (!service) return;

     const res = await addBookingService(booking.booking_id, service.service_id, qty, service.price);
     if (res.success) {
         toast.success("Đã thêm dịch vụ");
         setIsAddingService(false);
         fetchDetails();
     } else {
         toast.error(res.error);
     }
  };

  const handleRemoveService = async (id: number) => {
      const res = await removeBookingService(id);
      if (res.success) {
          toast.success("Đã xóa");
          fetchDetails();
      }
  };

  // --- LOGIC TÍNH TOÁN ---
  // 1. Lấy thông tin OT/Checkin sớm từ utils
  const billingInfo: BillingInfo = booking && booking.booking_items.length > 0 ? calculateBilling(
    new Date(booking.booking_items[0].start_dt),
    new Date(booking.booking_items[0].end_dt),
    booking.check_in_at ? new Date(booking.check_in_at) : null,
    booking.check_out_at ? new Date(booking.check_out_at) : null,
    otPrice, 
    { earlyGrace: 40, otFree: 60 }
  ) : DEFAULT_BILLING;

  // 2. Tổng hợp tiền
  const calculateTotal = () => {
     if (!booking) return 0;
     const roomTotal = booking.booking_items?.reduce((sum, item) => sum + (item.price_snapshot || 0), 0) || 0;
     const serviceTotal = booking.booking_services?.reduce((sum, s) => sum + (s.computed_amount || 0), 0) || 0;
     const surchargeTotal = billingInfo.totalSurcharge || 0;

     return roomTotal + serviceTotal + surchargeTotal;
  };

  const dropdownServices = servicesList.filter(s => s.category === activeTab);
  
  const totalAmount = calculateTotal();
  const deposit = booking?.deposit_amount || 0;
  const remaining = totalAmount - deposit;

  // Tạo mảng thông báo surcharge để hiển thị
  const surchargeMessages = [];
  if (billingInfo.earlyFee.message) surchargeMessages.push(billingInfo.earlyFee.message);
  if (billingInfo.otFee.message) surchargeMessages.push(billingInfo.otFee.message);

  if (!isOpen) return null;

  return (
    <ModalPortal isOpen={isOpen} onClose={onClose} title={`Chi tiết đơn #${bookingId}`} className="max-w-4xl">
       {loading || !booking ? (
           <div className="p-10 flex justify-center items-center">
               <Loader2 className="animate-spin" />
           </div>
       ) : (
           <div className="flex flex-col md:flex-row h-[80vh] md:h-auto">
               
               {/* CỘT TRÁI */}
               <div className="flex-1 p-6 overflow-y-auto bg-[var(--admin-bg)]/50 space-y-6">
                   
                   {/* 1. HEADER INFO & STATUS TAG */}
                   <div className="flex justify-between items-start">
                       <div>
                           <div className="flex items-center gap-2">
                                <h2 className="text-lg font-bold text-[var(--admin-fg)]">{booking.customers?.full_name}</h2>
                                <button 
                                   onClick={fetchDetails}
                                   className="p-1.5 hover:bg-gray-200 rounded-full text-gray-500 transition-colors cursor-pointer"
                                   title="Làm mới dữ liệu"
                                >
                                   <RotateCcw size={14} />
                                </button>
                           </div>
                           <div className="text-sm text-[var(--admin-sub)] flex items-center gap-1"><User size={14}/> {booking.customers?.phone}</div>
                       </div>
                       <div className="text-right">
                            <span className={`px-2 py-1 rounded text-xs font-bold uppercase ${
                                booking.status === 'checked_in' ? 'bg-green-100 text-green-700' : 
                                booking.status === 'checked_out' ? 'bg-red-100 text-red-700' :
                                booking.status === 'pending' ? 'bg-yellow-100 text-yellow-700' :
                                booking.status === 'confirmed' ? 'bg-blue-100 text-blue-700' :
                                booking.status === 'paid' ? 'bg-purple-100 text-purple-700' :
                                booking.status === 'completed' ? 'bg-gray-200 text-gray-600' : 'bg-blue-100 text-blue-700'
                            }`}>
                                {booking.status === 'checked_in' ? 'Khách đang ở Stu' :
                                 booking.status === 'checked_out' ? 'Khách đã rời Stu' :
                                 booking.status === 'paid' ? 'Đã thanh toán' :
                                 booking.status === 'confirmed' ? 'Đã xác nhận' :
                                 booking.status}
                            </span>
                       </div>
                   </div>

                   {/* 2. TIMELINE */}
                   <div className="bg-[var(--admin-card)] p-4 rounded-xl border border-[var(--admin-border)] shadow-sm">
                        <div className="grid grid-cols-2 gap-6 mb-2">
                            <div className="space-y-4 border-r border-[var(--admin-border)] pr-4">
                                {booking.booking_items.map(item => (
                                    <div key={item.booking_item_id}>
                                        <div className="font-bold text-sm text-[var(--admin-fg)] mb-1">{item.rooms?.name}</div>
                                        <div className="flex justify-between text-xs">
                                            <div>
                                                <div className="text-[10px] text-[var(--admin-sub)] uppercase">Giờ đặt lịch</div>
                                                <div className="font-bold">{format(new Date(item.start_dt), 'HH:mm')}</div>
                                            </div>
                                            <div>
                                                <div className="text-[10px] text-[var(--admin-sub)] uppercase">Giờ kết lịch</div>
                                                <div className="font-bold">{format(new Date(item.end_dt), 'HH:mm')}</div>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                            <div className="space-y-4">
                                <div className="flex justify-between text-xs">
                                    <div>
                                        <div className="text-[10px] text-[var(--admin-sub)] uppercase flex items-center gap-1"><LogIn size={10}/> Check-in</div>
                                        <div className={`font-bold ${booking.check_in_at ? 'text-green-600' : 'text-gray-400'}`}>
                                            {booking.check_in_at ? format(new Date(booking.check_in_at), 'HH:mm') : '--:--'}
                                        </div>
                                    </div>
                                    <div>
                                        <div className="text-[10px] text-[var(--admin-sub)] uppercase flex items-center gap-1"><LogOut size={10}/> Check-out</div>
                                        <div className={`font-bold ${booking.check_out_at ? 'text-blue-600' : 'text-gray-400'}`}>
                                            {booking.check_out_at ? format(new Date(booking.check_out_at), 'HH:mm') : '--:--'}
                                        </div>
                                    </div>
                                </div>
                                {surchargeMessages.length > 0 && (
                                    <div className="bg-[var(--admin-card)] mt-3 text-xs text-[var(--admin-primary)]">
                                        {surchargeMessages.map((msg, idx) => (
                                            <div key={idx}>• {msg}</div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        </div>
                   </div>

                   {/* 3. DỊCH VỤ (TABS) */}
                   <div className="bg-[var(--admin-card)] rounded-xl border border-[var(--admin-border)] shadow-sm overflow-hidden">
                       <div className="flex border-b border-[var(--admin-border)]">
                           <button onClick={() => setActiveTab('equipment')} className={`flex-1 py-3 text-xs font-bold uppercase flex justify-center gap-2 cursor-pointer ${activeTab === 'equipment' ? 'bg-[var(--admin-bg)] text-[var(--admin-primary)] border-b-2 border-[var(--admin-primary)]' : 'text-[var(--admin-sub)]'}`}>
                               <Camera size={14}/> Thiết bị
                           </button>
                           <button onClick={() => setActiveTab('fnb')} className={`flex-1 py-3 text-xs font-bold uppercase flex justify-center gap-2 cursor-pointer ${activeTab === 'fnb' ? 'bg-[var(--admin-bg)] text-[var(--admin-primary)] border-b-2 border-[var(--admin-primary)]' : 'text-[var(--admin-sub)]'}`}>
                               <Coffee size={14}/> F&B
                           </button>
                           <button onClick={() => setActiveTab('surcharge')} className={`flex-1 py-3 text-xs font-bold uppercase flex justify-center gap-2 cursor-pointer ${activeTab === 'surcharge' ? 'bg-[var(--admin-bg)] text-[var(--admin-primary)] border-b-2 border-[var(--admin-primary)]' : 'text-[var(--admin-sub)]'}`}>
                               <AlertCircle size={14}/> Phụ phí
                           </button>
                       </div>

                       <div className="p-4">
                           <div className="flex justify-between items-center mb-3">
                               <div className="text-xs font-bold text-[var(--admin-sub)] uppercase">Danh sách {activeTab}</div>
                               {booking.status !== 'completed' && booking.status !== 'paid' && (
                                   <button onClick={() => setIsAddingService(!isAddingService)} className="text-[10px] bg-[var(--admin-primary)]/10 text-[var(--admin-primary)] px-2 py-1 rounded font-bold flex items-center gap-1 cursor-pointer hover:bg-[var(--admin-primary)]/20 transition-colors">
                                       <Plus size={12}/> {isAddingService ? 'Đóng' : 'Thêm'}
                                   </button>
                               )}
                           </div>

                           {isAddingService && (
                               <div className="bg-[var(--admin-bg)] p-3 rounded border border-[var(--admin-border)] mb-3 animate-fade-in-up">
                                   <div className="flex gap-2 mb-2">
                                       <select className="flex-1 p-1 text-sm border rounded bg-[var(--admin-card)]" 
                                               value={selectedServiceId} onChange={e => setSelectedServiceId(e.target.value)}>
                                           <option value="">-- Chọn dịch vụ --</option>
                                           {dropdownServices.map((s) => (
                                               <option key={s.service_id} value={s.service_id}>{s.name} - {fmtMoney(s.price)}</option>
                                           ))}
                                       </select>
                                       <input type="number" value={qty} onChange={e => setQty(Number(e.target.value))} className="w-12 text-center border rounded bg-[var(--admin-card)] text-sm"/>
                                   </div>
                                   <div className="flex justify-end gap-2">
                                       <button onClick={handleAddService} className="text-xs bg-[var(--admin-fg)] text-[var(--admin-bg)] px-3 py-1 rounded font-bold">Lưu</button>
                                   </div>
                               </div>
                           )}

                           <div className="space-y-2 max-h-40 overflow-y-auto table-scrollbar">
                               {booking.booking_services
                                   ?.filter(s => s.services?.category === activeTab)
                                   .map((s) => (
                                   <div key={s.booking_service_id} className="flex justify-between items-center p-2 border-b border-[var(--admin-border)] last:border-0">
                                       <div>
                                           <div className="text-sm font-medium">{s.services?.name}</div>
                                           <div className="text-xs text-[var(--admin-sub)]">{s.quantity} x {fmtMoney(s.unit_price_snapshot || 0)}</div>
                                       </div>
                                       <div className="flex items-center gap-3">
                                           <span className="text-sm font-mono">{fmtMoney(s.computed_amount || 0)}</span>
                                           {booking.status !== 'completed' && booking.status !== 'paid' && (
                                                <button onClick={() => handleRemoveService(s.booking_service_id)} className="text-[var(--admin-sub)] hover:text-red-500">
                                                    <Trash2 size={14}/>
                                                </button>
                                           )}
                                       </div>
                                   </div>
                               ))}
                           </div>
                       </div>
                   </div>
               </div>

               {/* CỘT PHẢI: BILL & ACTIONS */}
               <div className="w-full md:w-96 bg-[var(--admin-card)] border-l border-[var(--admin-border)] p-6 flex flex-col justify-between shadow-xl z-10">
                   <div>
                       <div className="flex items-center gap-2 mb-6 pb-4 border-b border-[var(--admin-border)]">
                           <FileText size={20} className="text-[var(--admin-primary)]"/>
                           <h3 className="font-bold text-[var(--admin-fg)] uppercase tracking-widest">Hóa Đơn</h3>
                       </div>

                       <div className="bg-[var(--admin-bg)]/30 p-4 rounded-xl border border-[var(--admin-border)] space-y-3 font-mono text-sm">
                            
                            {/* 1. TIỀN PHÒNG & DỊCH VỤ (CỐ ĐỊNH) */}
                            <div className="space-y-2">
                                <div className="flex justify-between items-center">
                                    <span className="text-[var(--admin-sub)] font-medium">Tiền phòng</span>
                                    <span className="font-bold text-[var(--admin-fg)]">
                                        {fmtMoney(booking.booking_items?.reduce((a, b) => a + (b.price_snapshot || 0), 0) || 0)}
                                    </span>
                                </div>
                                <div className="flex justify-between items-center">
                                    <span className="text-[var(--admin-sub)] font-medium">Dịch vụ</span>
                                    <span className="font-bold text-[var(--admin-fg)]">
                                        {fmtMoney(booking.booking_services?.reduce((a, b) => a + (b.computed_amount || 0), 0) || 0)}
                                    </span>
                                </div>
                            </div>

                            {/* 2. PHỤ PHÍ THỜI GIAN (CHECK-IN/OUT) */}
                            {(booking.check_in_at || booking.check_out_at) && (
                                <div className="border-t border-dashed border-[var(--admin-border)] pt-2 space-y-2">
                                    
                                    {/* Check-in Sớm */}
                                    {booking.check_in_at && (
                                        <div className={`rounded-lg p-2 text-xs bg ${billingInfo.earlyFee.isBillable ? 'border border-orange-100' : 'bg-transparent'}`}>
                                            <div className="flex justify-between items-center mb-1">
                                                <div className="flex items-center gap-1.5 text-[var(--admin-sub)]">
                                                    <LogIn size={12} className="text-[var(--admin-fg)]"/>
                                                    <span className="text-[var(--admin-fg)]">Vào: <strong className="text-[var(--admin-fg)]">{format(new Date(booking.check_in_at), 'HH:mm')}</strong></span>
                                                </div>
                                                {/* Tag trạng thái */}
                                                {billingInfo.earlyFee.minutes > 0 && (
                                                    <span className={`px-1.5 py-0.5 rounded text-[10px] font-bold uppercase ${billingInfo.earlyFee.isBillable ? 'bg-orange-100 text-orange-700' : 'bg-green-100 text-green-700'}`}>
                                                        {billingInfo.earlyFee.isBillable ? 'Phụ thu' : 'Miễn phí'}
                                                    </span>
                                                )}
                                            </div>

                                            {/* Dòng tính tiền Check-in sớm */}
                                            {billingInfo.earlyFee.isBillable && (
                                                <div className="flex justify-between items-start pl-4">
                                                    <div className="flex flex-col">
                                                        <span className="text-orange-700 font-medium">+ Check-in sớm {formatDuration(billingInfo.earlyFee.minutes)}</span>
                                                        <span className="text-[10px] text-orange-600/70">
                                                            ({formatDuration(billingInfo.earlyFee.billableHours * 60)} x {fmtMoney(otPrice)})
                                                        </span>
                                                    </div>
                                                    <span className="font-bold text-orange-700">{fmtMoney(billingInfo.earlyFee.amount)}</span>
                                                </div>
                                            )}
                                        </div>
                                    )}

                                    {/* OT (Check-out Trễ) */}
                                    {booking.check_out_at && (
                                        <div className={`rounded-lg p-2 text-xs ${billingInfo.otFee.isBillable ? 'border border-red-100' : 'bg-transparent'}`}>
                                            <div className="flex justify-between items-center mb-1">
                                                <div className="flex items-center gap-1.5 text-[var(--admin-sub)]">
                                                    <LogOut size={12} className="text-[var(--admin-fg)]"/>
                                                    <span className="text-[var(--admin-fg)]">Ra: <strong className="text-[var(--admin-fg)]">{format(new Date(booking.check_out_at), 'HH:mm')}</strong></span>
                                                </div>
                                                {/* Tag trạng thái */}
                                                {billingInfo.otFee.minutes > 0 && (
                                                    <span className={`px-1.5 py-0.5 rounded text-[10px] font-bold uppercase ${billingInfo.otFee.isBillable ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`}>
                                                        {billingInfo.otFee.isBillable ? 'Phụ thu' : 'Miễn phí'}
                                                    </span>
                                                )}
                                            </div>

                                            {/* Dòng tính tiền OT */}
                                            {billingInfo.otFee.isBillable && (
                                                <div className="flex justify-between items-start pl-4">
                                                    <div className="flex flex-col">
                                                        <span className="text-red-700 font-medium">+ OT {formatDuration(billingInfo.otFee.minutes)}</span>
                                                        <span className="text-[10px] text-red-600/70">
                                                            ({formatDuration(billingInfo.otFee.billableHours * 60)} x {fmtMoney(otPrice)})
                                                        </span>
                                                    </div>
                                                    <span className="font-bold text-red-700">{fmtMoney(billingInfo.otFee.amount)}</span>
                                                </div>
                                            )}
                                        </div>
                                    )}
                                </div>
                            )}

                            {/* 3. ĐÃ CỌC & TỔNG KẾT */}
                            <div className="border-t border-[var(--admin-border)] pt-3 space-y-3">
                                <div className="flex justify-between items-center text-green-600 text-xs font-medium">
                                    {fmtMoney(deposit) !== '0 VNĐ' && (
                                        <>
                                            <span>Đã cọc trước</span>
                                            <span>- {fmtMoney(deposit)}</span>
                                        </>
                                    )} else (
                                         <>
                                            <span>Chưa cọc</span>
                                        </>
                                    )
                                </div>

                                <div className="flex justify-between items-center bg-[var(--admin-primary)]/5 p-3 rounded-lg border border-[var(--admin-primary)]/20">
                                    <span className="text-base font-bold text-[var(--admin-primary)] uppercase tracking-tight">Cần thanh toán</span>
                                    <span className="text-xl font-extrabold text-[var(--admin-primary)]">
                                        {fmtMoney(remaining)}
                                    </span>
                                </div>
                            </div>
                        </div>
                   </div>

                   {/* ACTIONS BUTTONS */}
                   <div className="space-y-3 mt-8">
                       {/* 1. CHECK-IN */}
                       {booking.status === 'confirmed' && (
                           <button onClick={handleCheckIn} className="w-full py-4 bg-green-600 text-white rounded-xl 
                           font-bold shadow-lg shadow-green-200 hover:bg-green-700 transition-all flex justify-center items-center gap-2 cursor-pointer">
                               <LogIn size={20}/> CHECK-IN KHÁCH
                           </button>
                       )}

                       {/* 2. CHECK-OUT */}
                       {booking.status === 'checked_in' && (
                           <button onClick={handleCheckOut} className="w-full py-4 text-white rounded-xl 
                           font-bold shadow-lg transition-all flex justify-center items-center gap-2 cursor-pointer">
                               <LogOut size={20}/> KHÁCH RỜI (DỪNG GIỜ)
                           </button>
                       )}

                       {/* 3. THANH TOÁN */}
                       {booking.status === 'checked_out' && (
                           <div className="space-y-2">
                               <button onClick={() => handlePayment(remaining)} className="w-full py-4 bg-[var(--admin-primary)] text-white rounded-xl font-bold 
                               shadow-lg hover:opacity-90 flex justify-center items-center gap-2 cursor-pointer">
                                   <DollarSign size={20}/> XÁC NHẬN ĐÃ THU TIỀN
                               </button>
                           </div>
                       )}

                       {/* 4. HOÀN TẤT */}
                       {booking.status === 'paid' && (
                           <div className="space-y-2">
                               <div className="text-center text-xs text-blue-600 font-medium bg-blue-50 p-2 rounded">
                                   Đã thanh toán. Kiểm tra phòng và đóng đơn.
                               </div>
                               <button onClick={handleFinalize} className="w-full py-3 border border-gray-300 bg-white text-gray-700 rounded-xl 
                               font-bold hover:bg-gray-50 flex justify-center items-center gap-2 cursor-pointer">
                                   <Check size={20}/> HOÀN TẤT ĐƠN
                               </button>
                           </div>
                       )}

                       {booking.status === 'completed' && (
                           <div className="bg-gray-100 text-gray-500 text-center py-3 rounded-xl font-bold text-sm border border-gray-200">
                               ĐƠN ĐÃ HOÀN TẤT
                           </div>
                       )}

                        {booking.status !== 'completed' && (
                            <button onClick={onClose} className="w-full py-3 text-[var(--admin-sub)] hover:bg-[var(--admin-hover)] 
                            rounded-xl font-medium transition-colors cursor-pointer">
                                Đóng
                            </button>
                        )}
                   </div>
               </div>
           </div>
       )}
    </ModalPortal>
  );
}
</file>

<file path="src/lib/actions/booking-details.ts">
// src/lib/actions/booking-details.ts
'use server'

import { createClient } from '@/lib/supabase/server'
import { revalidatePath } from 'next/cache'

// 1. Lấy chi tiết Booking
export async function getBookingDetails(bookingId: number) {
  const supabase = await createClient();
  
  const { data, error } = await supabase
    .from('bookings')
    .select(`
      *,
      customers (*),
      booking_items (
        *, 
        rooms (name, code)
      ),
      booking_services (
        *, 
        services (name, price, unit, category)
      )
    `)
    .eq('booking_id', bookingId)
    .single();

  if (error) return { success: false, error: error.message };
  return { success: true, data };
}

// 2. Thêm dịch vụ
export async function addBookingService(bookingId: number, serviceId: number, quantity: number, price: number) {
  const supabase = await createClient();

  const { error } = await supabase.from('booking_services').insert({
    booking_id: bookingId,
    service_id: serviceId,
    quantity: quantity,
    unit_price_snapshot: price,
    computed_amount: quantity * price,
    type: 'surcharge' 
  });
  
  if (error) return { success: false, error: error.message };
  revalidatePath('/admin');
  return { success: true };
}

// 3. Xóa dịch vụ
export async function removeBookingService(bookingServiceId: number) {
  const supabase = await createClient();
  const { error } = await supabase.from('booking_services').delete().eq('booking_service_id', bookingServiceId);
  
  if (error) return { success: false, error: error.message };
  revalidatePath('/admin');
  return { success: true };
}

// Định nghĩa Type Status khớp với DB (Logic của App)
export type BookingStatus = 
  | "pending"       
  | "confirmed"     
  | "checked_in"    
  | "checked_out"   
  | "paid"          
  | "completed"     
  | "cancelled";    

// 4. CHECK-IN
export async function checkInCustomer(bookingId: number, roomId: number, bookedStart: string) {
  const supabase = await createClient();
  const now = new Date(); 

  const { data: settingData } = await supabase
    .from('settings')
    .select('value')
    .eq('key', 'EARLY_CHECKIN_GRACE_MINUTES')
    .single();
  const graceMinutes = Number(settingData?.value || 40);

  const bookedStartDate = new Date(bookedStart);
  const diffMinutes = (bookedStartDate.getTime() - now.getTime()) / 60000;

  if (diffMinutes > graceMinutes) {
      const { data: conflicts } = await supabase
        .from('booking_items')
        .select('booking_item_id')
        .eq('room_id', roomId)
        .neq('booking_id', bookingId) 
        .lt('start_dt', bookedStartDate.toISOString()) 
        .gt('end_dt', now.toISOString());

      if (conflicts && conflicts.length > 0) {
          return { success: false, error: "Không thể check-in sớm: Đang có khách khác sử dụng phòng." };
      }
  }

  const { error } = await supabase
    .from('bookings')
    .update({ 
        status: 'checked_in',
        check_in_at: now.toISOString()
    })
    .eq('booking_id', bookingId);

  if (error) return { success: false, error: error.message };
  revalidatePath('/admin');
  return { success: true };
}

// 5. CHECK-OUT (FIX LỖI TYPE Ở ĐÂY)
export async function checkOutCustomer(bookingId: number) {
    const supabase = await createClient();
    const now = new Date();

    const { error } = await supabase
        .from('bookings')
        .update({ 
            status: 'checked_out', 
            check_out_at: now.toISOString() 
        })
        .eq('booking_id', bookingId);

    if (error) return { success: false, error: error.message };
    revalidatePath('/admin');
    return { success: true };
}

// 6. CONFIRM PAYMENT (FIX LỖI TYPE Ở ĐÂY)
export async function confirmPayment(bookingId: number, totalActual: number) {
    const supabase = await createClient();

    const { error } = await supabase
        .from('bookings')
        .update({ 
            // FIX: Ép kiểu 'as any'
            status: 'paid', 
            total_actual: totalActual
        })
        .eq('booking_id', bookingId);

    if (error) return { success: false, error: error.message };
    revalidatePath('/admin');
    return { success: true };
}

// 7. FINALIZE
export async function finalizeBooking(bookingId: number) {
    const supabase = await createClient();

    const { error } = await supabase
        .from('bookings')
        .update({ 
            status: 'completed' 
        })
        .eq('booking_id', bookingId);

    if (error) return { success: false, error: error.message };
    revalidatePath('/admin');
    return { success: true };
}

// 8. UPDATE STATUS CHUNG (FIX LỖI TYPE Ở ĐÂY)
export async function updateBookingStatus(bookingId: number, status: string, totalActual?: number) {
  const supabase = await createClient();
  
  const payload: { status: BookingStatus; total_actual?: number } = { 
    status: status as BookingStatus 
  };
  if (totalActual !== undefined) payload.total_actual = totalActual;
  
  // FIX: Ép kiểu payload 'as any' để Supabase client chấp nhận status mới
  const { error } = await supabase.from('bookings').update(payload).eq('booking_id', bookingId);
  
  if (error) return { success: false, error: error.message };
  revalidatePath('/admin');
  return { success: true };
}
</file>

<file path="CHANGELOG.md">
# Changelog

Mọi thay đổi quan trọng của dự án sẽ được ghi lại tại đây.

## [1.0.0] - 2025-11-17

### 🎉 Initial Release
Phiên bản chính thức đầu tiên của Website Portfolio.

### ✨ Tính năng mới
- **Trang chủ:** Hoàn thiện Hero Section, Showcase, Portfolio Grid.
- **Trang Dịch vụ:** Bảng giá, Thiết bị, Quy định, và phần Hậu trường (BTS).
- **Trang Giới thiệu:** Câu chuyện thương hiệu và Cột mốc phát triển.
- **Trang Dự án:** - 3 chuyên mục: Thời trang, Thương mại, Cá nhân.
  - Trang chi tiết dự án với nội dung động (Article Body).
- **Hệ thống:**
  - Dark/Light Mode.
  - Responsive hoàn chỉnh (Mobile/Tablet/Desktop).
  - SEO Metadata động cho từng dự án.

### 🔧 Kỹ thuật
- Cấu hình `next.config.ts` cho GitHub Pages (basePath, output export).
- Thiết lập quy trình deploy tự động qua `npm run deploy`.
- Tối ưu hóa `sizes` cho hình ảnh Next.js.

### 🚧 Backlog (Dự kiến phát triển sau)
- Trang Magazine (Tạp chí).
</file>

<file path="eslint.config.mjs">
import { dirname } from "path";
import { fileURLToPath } from "url";
import { FlatCompat } from "@eslint/eslintrc";

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

const compat = new FlatCompat({
  baseDirectory: __dirname,
});

const eslintConfig = [
  ...compat.extends("next/core-web-vitals", "next/typescript"),
  {
    ignores: [
      "node_modules/**",
      ".next/**",
      "out/**",
      "build/**",
      "next-env.d.ts",
    ],
  },
];

export default eslintConfig;
</file>

<file path="lib/supabase.ts">
// src/lib/supabase.ts
import { createClient } from '@supabase/supabase-js';

// Lấy biến môi trường và kiểm tra xem có tồn tại không
const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;

if (!supabaseUrl || !supabaseKey) {
  throw new Error('Missing Supabase environment variables');
}

export const supabase = createClient(supabaseUrl, supabaseKey);
</file>

<file path="LICENSE">
MIT License

Copyright (c) 2025 Trần Hải Đăng

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.
</file>

<file path="postcss.config.mjs">
const config = {
  plugins: ["@tailwindcss/postcss"],
};

export default config;
</file>

<file path="public/.nojekyll">

</file>

<file path="public/file.svg">
<svg fill="none" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path d="M14.5 13.5V5.41a1 1 0 0 0-.3-.7L9.8.29A1 1 0 0 0 9.08 0H1.5v13.5A2.5 2.5 0 0 0 4 16h8a2.5 2.5 0 0 0 2.5-2.5m-1.5 0v-7H8v-5H3v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1M9.5 5V2.12L12.38 5zM5.13 5h-.62v1.25h2.12V5zm-.62 3h7.12v1.25H4.5zm.62 3h-.62v1.25h7.12V11z" clip-rule="evenodd" fill="#666" fill-rule="evenodd"/></svg>
</file>

<file path="public/globe.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><g clip-path="url(#a)"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.27 14.1a6.5 6.5 0 0 0 3.67-3.45q-1.24.21-2.7.34-.31 1.83-.97 3.1M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16m.48-1.52a7 7 0 0 1-.96 0H7.5a4 4 0 0 1-.84-1.32q-.38-.89-.63-2.08a40 40 0 0 0 3.92 0q-.25 1.2-.63 2.08a4 4 0 0 1-.84 1.31zm2.94-4.76q1.66-.15 2.95-.43a7 7 0 0 0 0-2.58q-1.3-.27-2.95-.43a18 18 0 0 1 0 3.44m-1.27-3.54a17 17 0 0 1 0 3.64 39 39 0 0 1-4.3 0 17 17 0 0 1 0-3.64 39 39 0 0 1 4.3 0m1.1-1.17q1.45.13 2.69.34a6.5 6.5 0 0 0-3.67-3.44q.65 1.26.98 3.1M8.48 1.5l.01.02q.41.37.84 1.31.38.89.63 2.08a40 40 0 0 0-3.92 0q.25-1.2.63-2.08a4 4 0 0 1 .85-1.32 7 7 0 0 1 .96 0m-2.75.4a6.5 6.5 0 0 0-3.67 3.44 29 29 0 0 1 2.7-.34q.31-1.83.97-3.1M4.58 6.28q-1.66.16-2.95.43a7 7 0 0 0 0 2.58q1.3.27 2.95.43a18 18 0 0 1 0-3.44m.17 4.71q-1.45-.12-2.69-.34a6.5 6.5 0 0 0 3.67 3.44q-.65-1.27-.98-3.1" fill="#666"/></g><defs><clipPath id="a"><path fill="#fff" d="M0 0h16v16H0z"/></clipPath></defs></svg>
</file>

<file path="public/next.svg">
<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 394 80"><path fill="#000" d="M262 0h68.5v12.7h-27.2v66.6h-13.6V12.7H262V0ZM149 0v12.7H94v20.4h44.3v12.6H94v21h55v12.6H80.5V0h68.7zm34.3 0h-17.8l63.8 79.4h17.9l-32-39.7 32-39.6h-17.9l-23 28.6-23-28.6zm18.3 56.7-9-11-27.1 33.7h17.8l18.3-22.7z"/><path fill="#000" d="M81 79.3 17 0H0v79.3h13.6V17l50.2 62.3H81Zm252.6-.4c-1 0-1.8-.4-2.5-1s-1.1-1.6-1.1-2.6.3-1.8 1-2.5 1.6-1 2.6-1 1.8.3 2.5 1a3.4 3.4 0 0 1 .6 4.3 3.7 3.7 0 0 1-3 1.8zm23.2-33.5h6v23.3c0 2.1-.4 4-1.3 5.5a9.1 9.1 0 0 1-3.8 3.5c-1.6.8-3.5 1.3-5.7 1.3-2 0-3.7-.4-5.3-1s-2.8-1.8-3.7-3.2c-.9-1.3-1.4-3-1.4-5h6c.1.8.3 1.6.7 2.2s1 1.2 1.6 1.5c.7.4 1.5.5 2.4.5 1 0 1.8-.2 2.4-.6a4 4 0 0 0 1.6-1.8c.3-.8.5-1.8.5-3V45.5zm30.9 9.1a4.4 4.4 0 0 0-2-3.3 7.5 7.5 0 0 0-4.3-1.1c-1.3 0-2.4.2-3.3.5-.9.4-1.6 1-2 1.6a3.5 3.5 0 0 0-.3 4c.3.5.7.9 1.3 1.2l1.8 1 2 .5 3.2.8c1.3.3 2.5.7 3.7 1.2a13 13 0 0 1 3.2 1.8 8.1 8.1 0 0 1 3 6.5c0 2-.5 3.7-1.5 5.1a10 10 0 0 1-4.4 3.5c-1.8.8-4.1 1.2-6.8 1.2-2.6 0-4.9-.4-6.8-1.2-2-.8-3.4-2-4.5-3.5a10 10 0 0 1-1.7-5.6h6a5 5 0 0 0 3.5 4.6c1 .4 2.2.6 3.4.6 1.3 0 2.5-.2 3.5-.6 1-.4 1.8-1 2.4-1.7a4 4 0 0 0 .8-2.4c0-.9-.2-1.6-.7-2.2a11 11 0 0 0-2.1-1.4l-3.2-1-3.8-1c-2.8-.7-5-1.7-6.6-3.2a7.2 7.2 0 0 1-2.4-5.7 8 8 0 0 1 1.7-5 10 10 0 0 1 4.3-3.5c2-.8 4-1.2 6.4-1.2 2.3 0 4.4.4 6.2 1.2 1.8.8 3.2 2 4.3 3.4 1 1.4 1.5 3 1.5 5h-5.8z"/></svg>
</file>

<file path="public/vercel.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1155 1000"><path d="m577.3 0 577.4 1000H0z" fill="#fff"/></svg>
</file>

<file path="public/window.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path fill-rule="evenodd" clip-rule="evenodd" d="M1.5 2.5h13v10a1 1 0 0 1-1 1h-11a1 1 0 0 1-1-1zM0 1h16v11.5a2.5 2.5 0 0 1-2.5 2.5h-11A2.5 2.5 0 0 1 0 12.5zm3.75 4.5a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5M7 4.75a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0m1.75.75a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5" fill="#666"/></svg>
</file>

<file path="src/app/admin/calendar/_components/CalendarSidebarWrapper.tsx">
'use client'
import CalendarSidebar from '@/components/admin/calendar/CalendarSidebar'

// Định nghĩa Type tối thiểu mà Sidebar cần
interface RoomBasic {
  room_id: number;
  name: string | null;
  code: string | null;
  // Cho phép nhận thêm các trường thừa khác (như branch_id...) mà không báo lỗi
  [key: string]: unknown; 
}

// Thay any[] bằng RoomBasic[]
export default function CalendarSidebarWrapper({ rooms }: { rooms: RoomBasic[] }) {
  return (
    <CalendarSidebar 
      // Ép kiểu rooms về dạng Sidebar cần (nếu CalendarSidebarProps bên trong chặt chẽ hơn)
      // Nhưng thường thì RoomBasic[] là đủ an toàn rồi.
      rooms={rooms.map(r => ({
          room_id: r.room_id,
          name: r.name || 'Không tên', // Xử lý null tại đây
          code: r.code || 'NO-CODE'
      }))} 
      onCreateClick={() => {
        const title = prompt("Tạo booking nhanh:");
        if(title) alert("Đã tạo: " + title);
      }} 
    />
  )
}
</file>

<file path="src/app/admin/calendar/layout.tsx">
export default async function CalendarLayout({
  children,
}: {
  children: React.ReactNode
}) {
  // Lấy dữ liệu phòng từ Server để render Sidebar

  return (
    <div className="flex h-[calc(100vh-136px)] overflow-hidden bg-[var(--admin-bg)] ">
      <main className="flex-1 flex flex-col min-w-0 overflow-hidden m-4 
       shadow-sm">
        {children}
      </main>
    </div>
  )
}
</file>

<file path="src/app/admin/calendar/page.tsx">
// src/app/admin/calendar/page.tsx
import { getBookingsForCalendar } from '@/lib/actions/bookings'
import { getRooms, getServices } from '@/lib/actions/studio'
import DashboardCalendar from '@/components/admin/DashboardCalendar'; 
import { getCurrentUserProfile } from '../../../lib/actions/users';
import { getCustomers } from '@/lib/actions/customers';
import { getCleanupMinutes } from '@/lib/actions/settings';

export default async function CalendarPage() {
  const today = new Date()
  const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1).toISOString()
  const endOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).toISOString()

  const bookings = await getBookingsForCalendar(startOfMonth, endOfMonth)
  const rooms = await getRooms()
  const services = await getServices()
  const customers = await getCustomers()
  const userProfile = await getCurrentUserProfile()
  const cleanupMinutes = await getCleanupMinutes();
  return (
    // h-full để tràn viền container cha
    <div className="h-full w-full bg-[var(--admin-card)] rounded-xl 
     shadow-sm overflow-hidden">
        {/* Truyền full data vào, không cần sidebar wrapper nữa */}
        <DashboardCalendar 
          rooms={rooms} 
          bookings={bookings} 
          services={services}
          customers={customers}
          currentUserId={Number(userProfile?.user_id || 0)} 
          cleanupMinutes={cleanupMinutes}
        />
    </div>
  )
}
</file>

<file path="src/app/loading.tsx">
// src/app/loading.tsx
import { Loader2 } from "lucide-react";

export default function Loading() {
  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-[var(--background)]">
      <div className="flex flex-col items-center gap-4">
        <Loader2 className="h-10 w-10 animate-spin text-[var(--foreground)]" />
        <p className="text-sm text-[var(--sub-text)] font-medium tracking-widest uppercase animate-pulse">
          Loading Oni Studio...
        </p>
      </div>
    </div>
  );
}
</file>

<file path="src/app/styles/BtsSection.module.css">
/* src/styles/BtsSection.module.css */

.btsSection {
  position: relative; /* Quan trọng để .stickyImageWrapper hoạt động */
  background-color: var(--background);
  color: var(--foreground);
}

/* --- 1. PHẦN ẢNH NỀN STICKY --- */

.stickyImageWrapper {
  position: sticky;
  top: 0;
  height: 100vh; /* Ảnh nền chiếm 100% chiều cao viewport */
  width: 100%;
  /* z-index: 0; (mặc định) */
}

.imageContainer {
  position: absolute;
  inset: 0;
  opacity: 0;
  transition: opacity 1s cubic-bezier(0.4, 0, 0.2, 1);
}

.imageActive {
  opacity: 1;
}

/* Lớp phủ mờ tối (gradient) để chữ dễ đọc hơn */
.imageOverlay {
  position: absolute;
  inset: 0;
  background: linear-gradient(
    to top,
    rgba(0, 0, 0, 1) 0%,
    rgba(0, 0, 0, 0.5) 40%,
    transparent 100%
  );
}


/* --- 2. PHẦN NỘI DUNG CUỘN (OVERLAY) --- */

/* Tiêu đề section (nằm ở trên cùng) */
.sectionHeader {
  /* Đặt tương đối để đè lên trên ảnh */
  position: relative; 
  z-index: 2;
  text-align: center;
  /* Đẩy tiêu đề xuống 1 chút */
  padding-top: 20vh;
  padding-bottom: 20vh;
  /* Chữ trắng cho dễ đọc */
  color: #ffffff;
  text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
}

.sectionTitle {
  font-size: 2.25rem; /* text-3xl */
  font-weight: 300; /* font-light */
}

.sectionSubtitle {
  font-size: 1.125rem; /* text-lg */
  opacity: 0.9;
  margin-top: 0.5rem;
}

@media (min-width: 768px) {
  .sectionTitle {
    font-size: 3rem; /* md:text-5xl */
  }
  .sectionSubtitle {
    font-size: 1.25rem; /* md:text-xl */
  }
}

/* Cột chứa các "cảnh" text */
.textColumn {
  position: relative;
  z-index: 2; /* Đảm bảo text cuộn TRÊN ảnh */
  width: 100%;
}

/* --- Nội dung từng "Cảnh" (Scene) --- */
.scene {
  /* Mỗi scene cao 100vh để khớp với 1 ảnh */
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  justify-content: center; /* Căn giữa nội dung theo chiều dọc */
  color: #ffffff; /* Chữ trắng */
  text-shadow: 0 2px 10px rgba(0, 0, 0, 0.7);
}

.sceneContent {
  /* Căn lề trái (hoặc giữa) cho nội dung text */
  text-align: left;
  max-width: 800px; /* Giới hạn chiều rộng khối text */
  padding: 1rem 1.5rem;

  opacity: 0.3; /* Mờ đi khi không active */
  transform: translateY(20px);
  transition: opacity 0.5s ease-out, transform 0.5s ease-out;
}

@media (min-width: 768px) {
  .sceneContent {
    /* Trên desktop, đẩy khối text sang bên trái */
    margin-left: 10%; 
  }
}

.sceneActive {
  opacity: 1;
  transform: translateY(0);
}

.sceneCategory {
  font-size: 0.875rem; /* text-sm */
  text-transform: uppercase;
  letter-spacing: 0.1em;
  opacity: 0.8;
}

.sceneTitle {
  font-size: 2.25rem; /* text-2xl */
  font-weight: 300; /* font-light */
  margin: 0.5rem 0 1rem 0;
}

@media (min-width: 768px) {
  .sceneTitle {
    font-size: 3rem; /* md:text-3xl */
  }
}

.sceneDescription {
  font-size: 1rem;
  line-height: 1.7;
  opacity: 0.9;
  margin-bottom: 1.5rem;
}

.sceneLink {
  color: #ffffff;
  font-weight: 500;
  display: inline-block;
  transition: transform 0.3s ease;
  border-bottom: 1px solid rgba(255, 255, 255, 0.5);
  padding-bottom: 2px;
}
.sceneLink:hover {
  transform: translateX(4px);
  border-bottom-color: #ffffff;
}
</file>

<file path="src/app/styles/DichVu.module.css">
/* Bố cục 2 cột trên Desktop */
.stickyLayout {
  display: flex;
  flex-direction: row;
  gap: 4rem; /* Khoảng cách giữa 2 cột */
}

/* Cột 1: Menu */
.stickyNav {
  /* Cột menu chiếm 1/3 (khoảng 30%) */
  flex-basis: 33.33%; 
  max-width: 300px; /* Giới hạn chiều rộng tối đa */
  
  /* Phần quan trọng: Dính lại */
  position: sticky;
  
  /* Dính cách top (chừa chỗ cho Header của bạn) */
  top: 120px; 
  
  /* Tự căn chỉnh chiều cao */
  align-self: flex-start; 
}

.stickyNav ul {
  list-style: none;
  padding: 0;
  margin: 0;
  display: flex;
  flex-direction: column;
  gap: 1.25rem; /* Khoảng cách giữa các mục menu */
}

.stickyNav a {
  text-decoration: none;
  font-size: 1.1rem; /* 17.6px */
  font-weight: 500;
  color: var(--foreground);
  opacity: 0.6; /* Màu chữ mờ mặc định */
  transition: all 0.2s ease-in-out;
}

.stickyNav a:hover {
  opacity: 0.8; /* Sáng hơn khi hover */
}

/* Đây là class Active khi cuộn tới */
.stickyNav a.active {
  color: var(--foreground);
  opacity: 1; /* Rõ nét */
  font-weight: 700;
  border-left: 3px solid var(--foreground);
  padding-left: 10px;
}

/* Cột 2: Nội dung */
.contentColumn {
  /* Cột nội dung chiếm phần còn lại */
  flex: 1;
  min-width: 0; /* Sửa lỗi flexbox overflow */
}

/* Mỗi Section nội dung */
.sceneContent {
  /* Thêm khoảng cách lớn giữa các section */
  margin-bottom: 4rem; /* 64px */
  padding-bottom: 4rem; /* 64px */
  border-bottom: 1px solid var(--foreground);
}
.sceneContent:last-child {
  border-bottom: none;
  margin-bottom: 0;
  padding-bottom: 0;
}

/* Tiêu đề của mỗi Section */
.contentTitle {
  font-size: 2.25rem; /* 36px (to hơn, rõ ràng hơn) */
  font-weight: 600;
  margin-bottom: 2rem; /* 32px */
}

/* CSS cho ô màu phông nền */
.colorSwatch {
  width: 24px;
  height: 24px;
  border-radius: 50%;
  border: 1px solid var(--foreground);
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

/* --- Responsive cho Di Động (md: 768px) --- */
@media (max-width: 768px) {
  /* Xếp chồng 2 cột */
  .stickyLayout {
    flex-direction: column;
    gap: 2rem;
  }

  .stickyNav {
    position: relative;
    top: 0;
    flex-basis: auto;
    width: 100%;
    max-width: 100%;
    
    /* Chuyển thành hàng ngang cho gọn */
    border-bottom: 1px solid var(--foreground);
    padding-bottom: 1rem;
  }
  
  .stickyNav ul {
    flex-direction: row; /* Hàng ngang */
    gap: 1.5rem;
    overflow-x: auto; /* Cho phép cuộn ngang nếu không đủ chỗ */
  }

  /* Link trên di động */
  .stickyNav a {
    white-space: nowrap; /* Không cho chữ xuống hàng */
  }

  .stickyNav a.active {
    transform: none; /* Bỏ hiệu ứng translate */
    border-left: none;
    padding-left: 0;
  }

  .contentColumn {
    flex-basis: auto;
    width: 100%;
  }

  .contentTitle {
    font-size: 1.875rem; /* 30px trên mobile */
  }
}
</file>

<file path="src/components/admin/calendar/BookingCalendar.tsx">
'use client'

import { 
  Calendar, 
  momentLocalizer, 
  Views, 
  View, 
  EventProps, 
  SlotInfo,
  EventPropGetter,
} from 'react-big-calendar'
import moment from 'moment'
import 'moment/locale/vi'
import 'react-big-calendar/lib/css/react-big-calendar.css'
import React, { useState, useMemo, useCallback } from 'react'
import CustomToolbar from './CustomToolbar'
import withDragAndDrop, { EventInteractionArgs } from 'react-big-calendar/lib/addons/dragAndDrop'
import 'react-big-calendar/lib/addons/dragAndDrop/styles.css'
import { ROOM_COLORS } from '@/lib/constants';

// Cấu hình Moment tiếng Việt
moment.locale('vi')
const localizer = momentLocalizer(moment)

// --- TYPE DEFINITIONS ---
interface BookingInfo {
  booking_id: number; // Đảm bảo field này tồn tại nếu bạn dùng nested
  status: string | null;
  customers: {
    full_name: string | null;
  } | null;
}

export interface BookingItem {
  booking_item_id: number;
  // QUAN TRỌNG: Thêm booking_id vào đây (FK từ bảng booking_items)
  booking_id: number; 
  start_dt: string;
  end_dt: string;
  room_id: number;
  bookings: BookingInfo | null;
}

export interface CalendarResource {
  id: number;
  title: string;
}

interface Room {
  room_id: number;
  name: string | null;
  code: string | null;
  status: 'available' | 'maintenance' | 'inactive';
  is_equipment_room?: boolean;
}

export interface CalendarEvent {
  id: string | number;
  title: string;       
  start: Date;
  end: Date;
  resourceId: number;  
  type: 'booking' | 'cleanup';
  status?: string;
  allDay?: boolean;
  resource?: { 
    bookingId?: number; 
  };
}

interface BookingCalendarProps {
  bookings: BookingItem[]; 
  rooms: Room[];
  date: Date;
  cleanupMinutes?: number;
  onNavigate: (newDate: Date) => void;
  onSelectSlot?: (info: { start: Date; end: Date; resourceId: number }) => void;
  // Prop quan trọng để nhận sự kiện click
  onSelectEvent?: (event: CalendarEvent) => void; 
  onEventDrop?: (args: EventInteractionArgs<CalendarEvent>) => void;
  onEventResize?: (args: EventInteractionArgs<CalendarEvent>) => void;
}

const DnDCalendar = withDragAndDrop<CalendarEvent, CalendarResource>(Calendar)

// --- CUSTOM EVENT COMPONENT ---
const CustomEvent = ({ event }: EventProps<CalendarEvent>) => {
  return (
    <div className="h-full w-full flex flex-col px-1.5 py-0.5 leading-snug overflow-hidden relative group">
      <div className="absolute left-0 top-0 bottom-0 w-[3px] bg-black/20"></div>
      
      {event.type === 'cleanup' ? (
        <div className="flex items-center gap-1 text-[10px] italic opacity-75">
          <span>🧹</span> <span>Dọn dẹp</span>
        </div>
      ) : (
        <>
          <div className="font-bold text-[11px] truncate mt-0.5">
            {event.title}
          </div>
          <div className="text-[10px] opacity-90 truncate flex items-center gap-1">
             <span className={`w-1.5 h-1.5 rounded-full ${event.status === 'confirmed' ? 'bg-white' : 'bg-white/50'}`}></span>
             <span className="capitalize">{event.status === 'confirmed' ? 'Đã cọc' : event.status}</span>
          </div>
        </>
      )}
    </div>
  )
}

export default function BookingCalendar({ 
  bookings,
  rooms,
  date, 
  cleanupMinutes = 60,
  onNavigate,
  onSelectSlot,
  onSelectEvent, // 1. Nhận prop này từ cha
  onEventDrop, 
  onEventResize 
}: BookingCalendarProps) {
  
  const [view, setView] = useState<View>(Views.DAY)

  // Mapping Events
  const events: CalendarEvent[] = useMemo(() => {
    const list: CalendarEvent[] = []
    bookings.forEach((b) => {
      // 2. SỬA LOGIC LẤY BOOKING ID
      // Lấy trực tiếp b.booking_id (FK) thay vì b.bookings?.booking_id (Nested) để chắc chắn có dữ liệu
      const bookingId = b.booking_id || b.bookings?.booking_id;

      list.push({
        id: b.booking_item_id,
        title: b.bookings?.customers?.full_name || 'Khách vãng lai', 
        start: new Date(b.start_dt),
        end: new Date(b.end_dt),
        resourceId: b.room_id, 
        type: 'booking',
        status: b.bookings?.status || 'unknown',
        allDay: false,
        // Lưu bookingId vào đây
        resource: { bookingId: bookingId } 
      })

      // Logic Cleanup
      const cleanupStart = new Date(b.end_dt);
      const cleanupEnd = moment(b.end_dt).add(cleanupMinutes, 'minutes').toDate();

      list.push({
        id: `cleanup-${b.booking_item_id}`,
        title: `Dọn dẹp (${cleanupMinutes}p)`,
        start: cleanupStart,
        end: cleanupEnd,
        resourceId: b.room_id,
        type: 'cleanup',
        allDay: false
      })
    })
    return list
  }, [bookings, cleanupMinutes])

  const resources: CalendarResource[] = useMemo(() => {
    return rooms
    .filter(r => r.status === 'available' && !r.is_equipment_room)
    .map(r => ({ id: r.room_id, title: r.name || `Room ${r.code}` }))
  }, [rooms])

  // Styling logic
  const eventStyleGetter: EventPropGetter<CalendarEvent> = useCallback((event) => {
    const resourceIndex = resources.findIndex(r => r.id === event.resourceId);
    let color = resourceIndex >= 0 ? ROOM_COLORS[resourceIndex % ROOM_COLORS.length] : '#6b7280';

    // Logic màu OT
    const now = new Date();
    if (event.status === 'checked_in' && now > event.end) {
        color = 'var(--admin-ot)'; 
    } else if (event.status === 'completed') {
        color = 'var(--status-completed)';
    }

    if (event.type === 'cleanup') {
      return {
        style: {
          backgroundColor: 'var(--admin-bg)',
          backgroundImage: 'repeating-linear-gradient(45deg, transparent, transparent 5px, rgba(0,0,0,0.05) 5px, rgba(0,0,0,0.05) 10px)',
          color: 'var(--admin-sub)',
          border: '1px dashed var(--admin-border)',
          fontSize: '10px',
          pointerEvents: 'none',
          cursor: 'default',
          borderRadius: '4px',
          zIndex: 1
        }
      }
    }

    return {
      style: {
        backgroundColor: color,
        border: 'none',
        color: '#fff',
        borderRadius: '4px',
        opacity: event.status === 'cancelled' ? 0.5 : 1, 
        boxShadow: '0 2px 4px rgba(0,0,0,0.1)',
        zIndex: 10,
        cursor: 'pointer' // Thêm cursor pointer để biết click được
      }
    }
  }, [resources])

  const handleSelectSlotInternal = useCallback((slotInfo: SlotInfo) => {
    if (!slotInfo.resourceId) return
    if (onSelectSlot) {
      onSelectSlot({
        start: slotInfo.start as Date,
        end: slotInfo.end as Date,
        resourceId: Number(slotInfo.resourceId)
      })
    }
  }, [onSelectSlot])

  return (
    <div className="h-full w-full bg-[var(--admin-card)] text-[var(--admin-fg)] font-sans">
      <DnDCalendar
        localizer={localizer}
        events={events}
        resources={view === Views.DAY ? resources : undefined} 
        resourceIdAccessor={(r: CalendarResource) => r.id}
        resourceTitleAccessor={(r: CalendarResource) => r.title}
        view={view}
        onView={setView}
        date={date}
        onNavigate={onNavigate}
        components={{
          toolbar: CustomToolbar,
          event: CustomEvent,
          resourceHeader: ({ label }) => (
             <div className="text-sm font-bold text-[var(--admin-fg)] py-1">{label}</div>
          )
        }}
        eventPropGetter={eventStyleGetter}
        selectable
        onSelectSlot={handleSelectSlotInternal}
        onSelectEvent={onSelectEvent} 
        draggableAccessor={() => true} 
        resizable 
        onEventDrop={onEventDrop}     
        onEventResize={onEventResize} 
        step={30} 
        timeslots={2} 
        min={new Date(0, 0, 0, 0, 0, 0)} 
        max={new Date(0, 0, 0, 23, 59, 59)} 
        views={[Views.DAY, Views.WEEK, Views.MONTH, Views.AGENDA]} 
        defaultView={Views.DAY} 
      />
    </div>
  )
}
</file>

<file path="src/components/admin/calendar/BookingCreateModal.tsx">
'use client';

import React, { useState, useEffect, useMemo, useRef } from 'react';
import { X, User, Check, Plus, Trash2, Loader2, Calendar as CalendarIcon, ChevronDown, Search } from 'lucide-react';
import { toast } from 'sonner';
import { 
  format, addMinutes, startOfDay, startOfMonth, endOfMonth, 
  eachDayOfInterval, getDay, isSameDay, addMonths, subMonths 
} from 'date-fns';
import { vi } from 'date-fns/locale';
import { createBooking } from '@/lib/actions/bookings';
import { createCustomer } from '@/lib/actions/customers';
import { RoomWithBranch, ServiceItem } from '@/lib/actions/studio';
import { CustomerRow } from '@/lib/actions/customers';
import ModalPortal from '@/components/ui/ModalPortal';

// --- HELPER: Tạo danh sách khung giờ 15 phút ---
const generateTimeOptions = () => {
  const times = [];
  const start = startOfDay(new Date());
  for (let i = 0; i < 24 * 4; i++) {
    const t = addMinutes(start, i * 15);
    times.push(format(t, 'HH:mm'));
  }
  return times;
};
const formatCurrency = (val: number) => new Intl.NumberFormat('vi-VN').format(val);

const TIME_OPTIONS = generateTimeOptions();

// --- SUB-COMPONENT: DATE SELECTOR (MINI CALENDAR) ---
interface DateSelectorProps {
  value: Date;
  onChange: (date: Date) => void;
  align?: 'left' | 'right';
}

const DateSelector = ({ value, onChange, align = 'left' }: DateSelectorProps) => {
  const [isOpen, setIsOpen] = useState(false);
  // State viewDate để user lướt xem tháng khác mà không đổi ngày đã chọn
  const [viewDate, setViewDate] = useState(value);
  const containerRef = useRef<HTMLDivElement>(null);

  // Sync viewDate khi mở lại hoặc value đổi
  useEffect(() => {
    if (isOpen) setViewDate(value);
  }, [isOpen, value]);

  useEffect(() => {
    const handleClickOutside = (e: MouseEvent) => {
      if (containerRef.current && !containerRef.current.contains(e.target as Node)) {
        setIsOpen(false);
      }
    };
    if (isOpen) document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [isOpen]);

  // Logic tạo lịch
  const daysInMonth = useMemo(() => {
    return eachDayOfInterval({
      start: startOfMonth(viewDate),
      end: endOfMonth(viewDate),
    });
  }, [viewDate]);

  const startDay = getDay(startOfMonth(viewDate));
  // Điều chỉnh để Thứ 2 là đầu tuần (0: CN, 1: T2,... 6: T7) -> Muốn T2 index 0
  // getDay: 0(CN), 1(T2)... 
  // Map: T2(1)->0, T3(2)->1, ... CN(0)->6
  const paddingDaysCount = startDay === 0 ? 6 : startDay - 1;
  const paddingDays = Array(paddingDaysCount).fill(null);

  return (
    <div ref={containerRef} className="relative inline-block ml-2">
      <span 
        onClick={(e) => { e.stopPropagation(); setIsOpen(!isOpen); }}
        className={`text-xs font-medium cursor-pointer transition-all border-b border-transparent
          ${isOpen 
            ? 'text-[var(--admin-primary)] border-[var(--admin-primary)]' 
            : 'text-[var(--admin-sub)] hover:text-[var(--admin-fg)] hover:border-[var(--admin-sub)]'
          }
        `}
      >
        {format(value, 'dd/MM', { locale: vi })}
      </span>

      {isOpen && (
        <div onClick={(e) => e.stopPropagation()}
            className={`
                absolute top-full mt-2 p-3 bg-[var(--admin-card)] border border-[var(--admin-border)] 
                rounded-xl shadow-xl z-[60] w-64 animate-in fade-in zoom-in-95 duration-100
                ${align === 'right' ? 'right-0' : 'left-0'} /* Căn phải nếu align=right */
            `}>
           {/* Header: Tháng & Nav */}
           <div className="flex items-center justify-between mb-3">
              <button onClick={() => setViewDate(subMonths(viewDate, 1))} className="hover:bg-[var(--admin-hover)] p-1 rounded text-[var(--admin-sub)] text-xs">‹</button>
              <div className="text-[11px] font-bold text-[var(--admin-fg)] uppercase tracking-wider">
                  Tháng {format(viewDate, 'MM/yyyy')}
              </div>
              <button onClick={() => setViewDate(addMonths(viewDate, 1))} className="hover:bg-[var(--admin-hover)] p-1 rounded text-[var(--admin-sub)] text-xs">›</button>
          </div>
          
          {/* Thứ trong tuần */}
          <div className="grid grid-cols-7 text-center text-[9px] gap-y-2 text-[var(--admin-sub)] font-medium mb-1">
              <span>T2</span><span>T3</span><span>T4</span><span>T5</span><span>T6</span><span>T7</span><span className="text-red-400">CN</span>
          </div>

          {/* Lưới ngày */}
          <div className="grid grid-cols-7 text-center text-[10px] gap-1">
              {paddingDays.map((_, i) => <span key={`pad-${i}`} />)}
              {daysInMonth.map(d => {
                  const isSelected = isSameDay(d, value);
                  const isToday = isSameDay(d, new Date());
                  return (
                      <span 
                          key={d.toString()} 
                          onClick={() => { onChange(d); setIsOpen(false); }}
                          className={`
                              cursor-pointer h-7 w-7 flex items-center justify-center rounded-full transition-all
                              ${isSelected 
                                  ? 'bg-[var(--admin-primary)] text-white font-bold shadow-md' 
                                  : isToday 
                                      ? 'text-[var(--admin-primary)] font-bold border border-[var(--admin-primary)]'
                                      : 'text-[var(--admin-fg)] hover:bg-[var(--admin-hover)]'
                              }
                          `}
                      >
                          {format(d, 'd')}
                      </span>
                  )
              })}
          </div>
        </div>
      )}
    </div>
  );
};

// --- SUB-COMPONENT: TIME SELECTOR (Modified to include DateSelector) ---
interface TimeSelectorProps {
  label: string;
  timeValue: string;
  dateValue: Date;
  onTimeChange: (val: string) => void;
  onDateChange: (val: Date) => void;
  className?: string;
  align?: 'left' | 'right';
}

const TimeSelector = ({ 
    label, timeValue, dateValue, onTimeChange, onDateChange, className, 
    align = 'left' // Mặc định left
}: TimeSelectorProps) => {
  const [isOpen, setIsOpen] = useState(false);
  const containerRef = useRef<HTMLDivElement>(null);

  useEffect(() => {
    const handleClickOutside = (e: MouseEvent) => {
      if (containerRef.current && !containerRef.current.contains(e.target as Node)) {
        setIsOpen(false);
      }
    };
    if (isOpen) document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [isOpen]);

  return (
    <div className={`relative ${className}`}>
      <span className="text-[10px] font-bold text-[var(--admin-sub)] uppercase mb-1 block tracking-wider">
        {label}
      </span>
      <div 
        className="flex items-baseline gap-1 select-none"
      >
        {/* TIME TRIGGER */}
        <div 
            ref={containerRef}
            onClick={() => setIsOpen(!isOpen)}
            className="flex items-center gap-1 cursor-pointer group"
        >
            <span className={`text-2xl font-bold text-[var(--admin-fg)] border-b-2 border-transparent transition-all
            ${isOpen ? 'border-[var(--admin-primary)] text-[var(--admin-primary)]' : 'group-hover:border-[var(--admin-sub)]'}
            `}>
            {timeValue}
            </span>
            <ChevronDown size={14} className={`text-[var(--admin-sub)] transition-transform ${isOpen ? 'rotate-180' : ''}`} />
        </div>

        {/* DATE TRIGGER (Tách riêng để không bị lẫn sự kiện click) */}
        <DateSelector value={dateValue} onChange={onDateChange} align={align} />
      </div>

      {/* DROPDOWN CHỌN GIỜ */}
      {isOpen && (
        <div ref={containerRef} className={`absolute top-full mt-2 w-32 max-h-60 overflow-y-auto bg-[var(--admin-card)] border border-[var(--admin-border)] rounded-xl shadow-xl z-50 table-scrollbar animate-in fade-in zoom-in-95 duration-100
          ${align === 'right' ? 'right-0' : 'left-0'}
        `}>
          {TIME_OPTIONS.map((t) => (
            <div
              key={t}
              onClick={() => { onTimeChange(t); setIsOpen(false); }}
              className={`px-4 py-2 text-sm cursor-pointer transition-colors flex items-center justify-between
                ${t === timeValue ? 'bg-[var(--admin-primary)] text-white font-bold' : 'text-[var(--admin-fg)] hover:bg-[var(--admin-hover)]'}
              `}
            >
              {t}
              {t === timeValue && <Check size={14} />}
            </div>
          ))}
        </div>
      )}
    </div>
  );
};

// --- MAIN COMPONENT ---

interface BookingCreateModalProps {
  isOpen: boolean;
  onClose: () => void;
  initialData: {
    start: Date;
    end: Date;
    roomId: number;
  };
  rooms: RoomWithBranch[];
  services: ServiceItem[];
  customers: CustomerRow[];
  currentUserId: number;
}

export default function BookingCreateModal({
  isOpen,
  onClose,
  initialData,
  rooms,
  services,
  customers: initialCustomers,
  currentUserId
}: BookingCreateModalProps) {
  
  // --- STATES ---
  const [customers, setCustomers] = useState<CustomerRow[]>(initialCustomers);
  const [isSubmitting, setIsSubmitting] = useState(false);
  
  // Thời gian (Giờ:Phút)
  const [startTimeStr, setStartTimeStr] = useState('');
  const [endTimeStr, setEndTimeStr] = useState('');
  
  // Ngày đặt (Tách riêng để quản lý chọn ngày)
  const [bookingDate, setBookingDate] = useState<Date>(new Date());
  
  const [selectedRoomId, setSelectedRoomId] = useState(initialData.roomId);
  const [selectedCustomerId, setSelectedCustomerId] = useState<number | ''>('');
  const [note, setNote] = useState('');
  const [deposit, setDeposit] = useState<number>(0);
  const [selectedServices, setSelectedServices] = useState<{ id: number; quantity: number }[]>([]);

  // CUSTOMER SEARCH STATES
  const [isCreatingCustomer, setIsCreatingCustomer] = useState(false);
  const [customerSearch, setCustomerSearch] = useState(''); 
  const [isCustomerDropdownOpen, setIsCustomerDropdownOpen] = useState(false); 
  const customerInputRef = useRef<HTMLDivElement>(null);

  // New Customer Form States
  const [newCustomerName, setNewCustomerName] = useState('');
  const [newCustomerPhone, setNewCustomerPhone] = useState('');
  const [isCreatingCustLoading, setIsCreatingCustLoading] = useState(false);

  // --- 1. Tách các giá trị nguyên thủy (Primitives) để so sánh ổn định ---
  // .getTime() trả về số (number), React so sánh số theo giá trị chứ không theo địa chỉ bộ nhớ
  const initStartMillis = initialData.start.getTime();
  const initEndMillis = initialData.end.getTime();
  const initRoomId = initialData.roomId;

  // Sync Data khi mở Modal
  useEffect(() => {
    if (isOpen) {
      // --- 2. Dùng các biến nguyên thủy để set state ---
      // Tạo lại Date từ timestamp để đảm bảo an toàn
      const startDate = new Date(initStartMillis);
      const endDate = new Date(initEndMillis);

      setStartTimeStr(format(startDate, 'HH:mm'));
      setEndTimeStr(format(endDate, 'HH:mm'));
      setBookingDate(startDate); 
      
      setSelectedRoomId(initRoomId);
      
      // Reset form
      setSelectedCustomerId('');
      setNote('');
      setDeposit(0);
      setSelectedServices([]);
      
      // Reset Customer Search
      setIsCreatingCustomer(false);
      setCustomerSearch('');
      setIsCustomerDropdownOpen(false);
      setNewCustomerName('');
      setNewCustomerPhone('');
    }
  }, [
      // --- 3. Dependency Array chỉ chứa Primitive Values ---
      // ESLint sẽ hài lòng vì ta dùng chính xác các biến này bên trong
      isOpen, 
      initStartMillis, 
      initEndMillis, 
      initRoomId
  ]);

  useEffect(() => {
    setCustomers(initialCustomers);
  }, [initialCustomers]);

  useEffect(() => {
    const handleClickOutside = (e: MouseEvent) => {
      if (customerInputRef.current && !customerInputRef.current.contains(e.target as Node)) {
        setIsCustomerDropdownOpen(false);
      }
    };
    if (isCustomerDropdownOpen) {
      document.addEventListener('mousedown', handleClickOutside);
    }
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [isCustomerDropdownOpen]);

  // --- LOGIC SEARCH KHÁCH HÀNG ---
  const filteredCustomers = useMemo(() => {
    if (!customerSearch.trim()) return customers;
    const lowerTerm = customerSearch.toLowerCase();
    return customers.filter(c => 
      c.full_name.toLowerCase().includes(lowerTerm) || 
      (c.phone && c.phone.includes(lowerTerm))
    );
  }, [customers, customerSearch]);

  const handleSelectCustomer = (customer: CustomerRow) => {
    setSelectedCustomerId(customer.customer_id);
    setCustomerSearch(customer.full_name); 
    setIsCustomerDropdownOpen(false);
  };

  // --- LOGIC TÍNH TOÁN ---
  const durationHours = useMemo(() => {
    const [startH, startM] = startTimeStr.split(':').map(Number);
    const [endH, endM] = endTimeStr.split(':').map(Number);
    if (isNaN(startH) || isNaN(endH)) return 0;
    
    let duration = (endH + endM / 60) - (startH + startM / 60);
    if (duration < 0) duration += 24;
    return Math.max(0, duration);
  }, [startTimeStr, endTimeStr]);

  const roomPricePerHour = 500000;
  const roomTotal = durationHours * roomPricePerHour;

  const servicesTotal = selectedServices.reduce((acc, item) => {
    const service = services.find(s => s.service_id === item.id);
    return acc + (service ? service.price * item.quantity : 0);
  }, 0);

  const grandTotal = roomTotal + servicesTotal;

  // --- HANDLERS ---

  const handleCreateCustomer = async () => {
    if (!newCustomerName.trim() || !newCustomerPhone.trim()) {
      toast.error('Vui lòng nhập tên và số điện thoại');
      return;
    }
    setIsCreatingCustLoading(true);
    
    const formData = new FormData();
    formData.append('full_name', newCustomerName);
    formData.append('phone', newCustomerPhone);
    formData.append('customer_type', 'regular');

    const res = await createCustomer(formData);
    
    setIsCreatingCustLoading(false);

    if (res.success && res.data) {
      toast.success('Đã thêm khách hàng mới!');
      const newCust = res.data as CustomerRow;
      setCustomers([newCust, ...customers]);
      
      setSelectedCustomerId(newCust.customer_id);
      setCustomerSearch(newCust.full_name);
      
      setIsCreatingCustomer(false); 
    } else {
      toast.error(res.error || 'Lỗi tạo khách hàng');
    }
  };

  const handleAddService = (serviceId: string) => {
    const id = Number(serviceId);
    if (!id) return;
    
    const existing = selectedServices.find(s => s.id === id);
    if (existing) {
      setSelectedServices(prev => prev.map(s => s.id === id ? { ...s, quantity: s.quantity + 1 } : s));
    } else {
      setSelectedServices(prev => [...prev, { id, quantity: 1 }]);
    }
  };

  const handleSubmit = async () => {
    if (!selectedCustomerId) {
      toast.error('Chưa chọn khách hàng');
      return;
    }

    // TỔNG HỢP NGÀY VÀ GIỜ
    const baseDate = format(bookingDate, 'yyyy-MM-dd'); // Sử dụng ngày đã chọn
    const startISO = `${baseDate}T${startTimeStr}:00`;
    const endISO = `${baseDate}T${endTimeStr}:00`;

    if (new Date(startISO) >= new Date(endISO)) {
        toast.error('Giờ kết thúc phải sau giờ bắt đầu');
        return;
    }

    setIsSubmitting(true);

    try {
      const payload = {
        customerId: Number(selectedCustomerId),
        staffId: currentUserId,
        deposit: deposit,
        discount: 0,
        notes: note,
        items: [{
          roomId: selectedRoomId,
          startDt: new Date(startISO).toISOString(),
          endDt: new Date(endISO).toISOString(),
          price: roomTotal
        }],
        services: selectedServices.map(s => {
          const sv = services.find(x => x.service_id === s.id)!;
          return {
            serviceId: s.id,
            quantity: s.quantity,
            price: sv.price,
            type: sv.type
          };
        })
      };

      const result = await createBooking(payload);

      if (result.success) {
        toast.success('Đặt lịch thành công!');
        onClose();
        window.location.reload(); 
      } else {
        toast.error(result.error);
      }
    } catch (error) {
      const msg = (error as Error).message || 'Lỗi kết nối hệ thống';
      toast.error(msg);
    } finally {
      setIsSubmitting(false);
    }
  };

  return (
    <ModalPortal isOpen={isOpen} onClose={onClose} title="Tạo Lịch Mới" className="max-w-3xl">
      <div className="flex flex-col md:flex-row h-[80vh] md:h-auto">
        
        {/* --- LEFT COLUMN: INPUT FORM --- */}
        <div className="flex-1 p-6 space-y-6 overflow-y-auto table-scrollbar">
          
          {/* 1. KHU VỰC CHỌN GIỜ & NGÀY */}
          <div className="bg-[var(--admin-bg)] p-5 rounded-2xl border border-[var(--admin-border)] flex items-center justify-between gap-4">
             {/* Chọn Bắt đầu (Bao gồm cả Giờ và Ngày) */}
             <TimeSelector 
                label="Bắt đầu" 
                timeValue={startTimeStr} 
                dateValue={bookingDate} 
                onTimeChange={setStartTimeStr}
                onDateChange={setBookingDate} // Cập nhật ngày chung
             />
             
             <div className="h-8 w-[1px] bg-[var(--admin-border)]"></div>
             
             {/* Chọn Kết thúc (Dùng chung ngày với bắt đầu cho đơn giản hóa UI) */}
             <TimeSelector 
                label="Kết thúc" 
                timeValue={endTimeStr} 
                dateValue={bookingDate} 
                onTimeChange={setEndTimeStr}
                onDateChange={setBookingDate}
                className="text-right flex flex-col items-end"
                align="right"
             />
          </div>

          {/* ... PHẦN CÒN LẠI GIỮ NGUYÊN ... */}
          
          {/* 2. CHỌN PHÒNG */}
          <div>
             <label className="text-xs font-bold text-[var(--admin-sub)] uppercase mb-2 block">Phòng Studio</label>
             <div className="relative">
                <select
                    className="w-full p-3 pl-10 bg-[var(--admin-card)] border border-[var(--admin-border)] rounded-xl appearance-none outline-none focus:border-[var(--admin-primary)] focus:ring-1 focus:ring-[var(--admin-primary)] transition-all cursor-pointer text-[var(--admin-fg)] font-medium"
                    value={selectedRoomId}
                    onChange={(e) => setSelectedRoomId(Number(e.target.value))}
                >
                    {rooms.filter(r => r.status === 'available'
                      && !(r.is_equipment_room === true)
                    ).map(r => (
                        <option key={r.room_id} value={r.room_id}>{r.name || r.code}</option>
                    ))}
                </select>
                <div className="absolute left-3 top-3.5 text-[var(--admin-sub)]">
                    <CalendarIcon size={18} />
                </div>
                <div className="absolute right-3 top-3.5 pointer-events-none text-[var(--admin-sub)]">
                    <ChevronDown size={16} />
                </div>
             </div>
          </div>

          {/* 3. KHÁCH HÀNG */}
          <div className="space-y-2" ref={customerInputRef}>
             <div className="flex justify-between items-center mb-1">
                <label className="text-xs font-bold text-[var(--admin-sub)] uppercase">Khách Hàng</label>
                {!isCreatingCustomer && (
                    <button 
                        onClick={() => setIsCreatingCustomer(true)}
                        className="text-[10px] bg-[var(--admin-primary)]/10 text-[var(--admin-primary)] px-2 py-1 rounded-md font-bold hover:bg-[var(--admin-primary)] hover:text-white transition-colors flex items-center gap-1"
                    >
                        <Plus size={12} /> TẠO MỚI
                    </button>
                )}
             </div>

             {isCreatingCustomer ? (
                // FORM TẠO KHÁCH INLINE
                <div className="bg-[var(--admin-bg)] p-4 rounded-xl border border-[var(--admin-border)] space-y-3 animate-fade-in-up">
                    <div className="flex items-center justify-between mb-2">
                        <span className="text-sm font-bold text-[var(--admin-fg)]">Thông tin khách mới</span>
                        <button onClick={() => setIsCreatingCustomer(false)} className="text-[var(--admin-sub)] hover:text-[var(--admin-fg)]"><X size={16}/></button>
                    </div>
                    <input 
                        className="w-full p-2.5 rounded-lg border border-[var(--admin-border)] bg-[var(--admin-card)] text-sm focus:border-[var(--admin-primary)] outline-none"
                        placeholder="Họ và tên *"
                        value={newCustomerName}
                        onChange={e => setNewCustomerName(e.target.value)}
                    />
                    <input 
                        className="w-full p-2.5 rounded-lg border border-[var(--admin-border)] bg-[var(--admin-card)] text-sm focus:border-[var(--admin-primary)] outline-none"
                        placeholder="Số điện thoại *"
                        value={newCustomerPhone}
                        onChange={e => setNewCustomerPhone(e.target.value)}
                    />
                    <button 
                        onClick={handleCreateCustomer}
                        disabled={isCreatingCustLoading}
                        className="w-full py-2 bg-[var(--admin-fg)] text-[var(--admin-bg)] rounded-lg text-sm font-bold hover:opacity-90 flex justify-center items-center gap-2"
                    >
                        {isCreatingCustLoading ? <Loader2 className="animate-spin" size={14}/> : <Check size={14}/>} Lưu khách hàng
                    </button>
                </div>
             ) : (
                // SEARCHABLE INPUT
                <div className="relative">
                    <div className="relative">
                        <User size={18} className="absolute left-3 top-3.5 text-[var(--admin-sub)]" />
                        <input
                            type="text"
                            placeholder="Tìm tên hoặc SĐT khách..."
                            className="w-full p-3 pl-10 pr-10 bg-[var(--admin-card)] border border-[var(--admin-border)] rounded-xl outline-none focus:border-[var(--admin-primary)] focus:ring-1 focus:ring-[var(--admin-primary)] transition-all text-[var(--admin-fg)]"
                            value={customerSearch}
                            onChange={(e) => {
                                setCustomerSearch(e.target.value);
                                setIsCustomerDropdownOpen(true);
                                if (e.target.value === '') setSelectedCustomerId('');
                            }}
                            onFocus={() => setIsCustomerDropdownOpen(true)}
                        />
                        {customerSearch && (
                            <button 
                                onClick={() => { setCustomerSearch(''); setSelectedCustomerId(''); }}
                                className="absolute right-3 top-3.5 text-[var(--admin-sub)] hover:text-[var(--admin-fg)]"
                            >
                                <X size={16} />
                            </button>
                        )}
                        {!customerSearch && <Search size={16} className="absolute right-3 top-3.5 text-[var(--admin-sub)]" />}
                    </div>

                    {/* DROPDOWN RESULTS */}
                    {isCustomerDropdownOpen && (
                        <div className="absolute top-full left-0 right-0 mt-1 max-h-48 overflow-y-auto bg-[var(--admin-card)] border border-[var(--admin-border)] rounded-xl shadow-lg z-50 table-scrollbar animate-in fade-in zoom-in-95 duration-100">
                            {filteredCustomers.length === 0 ? (
                                <div className="p-3 text-center text-sm text-[var(--admin-sub)] italic">
                                    Không tìm thấy khách hàng.
                                </div>
                            ) : (
                                filteredCustomers.map(c => (
                                    <div
                                        key={c.customer_id}
                                        onClick={() => handleSelectCustomer(c)}
                                        className="px-4 py-3 hover:bg-[var(--admin-hover)] cursor-pointer border-b border-[var(--admin-border)] last:border-0"
                                    >
                                        <div className="text-sm font-bold text-[var(--admin-fg)]">{c.full_name}</div>
                                        <div className="text-xs text-[var(--admin-sub)]">{c.phone || 'Không có SĐT'}</div>
                                    </div>
                                ))
                            )}
                        </div>
                    )}
                </div>
             )}
          </div>

          {/* 4. DỊCH VỤ THÊM */}
          <div>
             <label className="text-xs font-bold text-[var(--admin-sub)] uppercase mb-2 block">Dịch vụ đi kèm</label>
             <div className="relative">
                <select
                    className="w-full p-3 pl-10 bg-[var(--admin-card)] border border-[var(--admin-border)] rounded-xl appearance-none outline-none focus:border-[var(--admin-primary)] transition-all cursor-pointer text-[var(--admin-fg)] text-sm"
                    onChange={(e) => {
                        handleAddService(e.target.value);
                        e.target.value = ''; 
                    }}
                >
                    <option value="">+ Thêm dịch vụ...</option>
                    {services.map(s => (
                        <option key={s.service_id} value={s.service_id}>
                            {s.name} (+{new Intl.NumberFormat('vi-VN').format(s.price)}đ)
                        </option>
                    ))}
                </select>
                <Plus size={18} className="absolute left-3 top-3.5 text-[var(--admin-sub)]" />
             </div>

             {/* List dịch vụ đã chọn */}
             {selectedServices.length > 0 && (
                 <div className="mt-3 space-y-2">
                    {selectedServices.map(item => {
                        const sInfo = services.find(s => s.service_id === item.id);
                        return (
                            <div key={item.id} className="flex justify-between items-center bg-[var(--admin-bg)] p-2 rounded-lg border border-[var(--admin-border)] animate-fade-in-row">
                                <span className="text-sm font-medium text-[var(--admin-fg)]">{sInfo?.name}</span>
                                <div className="flex items-center gap-3">
                                    <span className="text-xs text-[var(--admin-sub)]">x{item.quantity}</span>
                                    <button 
                                        onClick={() => setSelectedServices(prev => prev.filter(x => x.id !== item.id))}
                                        className="text-[var(--admin-sub)] hover:text-red-500 transition-colors"
                                    >
                                        <Trash2 size={14}/>
                                    </button>
                                </div>
                            </div>
                        )
                    })}
                 </div>
             )}
          </div>

          <div className="grid grid-cols-2 gap-4">
             {/* Tiền cọc */}
             <div>
                <label className="text-xs font-bold text-[var(--admin-sub)] uppercase mb-2 block">
                  Tiền cọc (VNĐ)
                </label>
                <div className="relative">
                  <input 
                    type="text" // Dùng text để format
                    className="w-full p-3 rounded-xl bg-[var(--admin-card)] border border-[var(--admin-border)] focus:border-[var(--admin-primary)] outline-none font-mono text-sm font-bold"
                    placeholder="0"
                    // Hiển thị dạng 300.000
                    value={deposit > 0 ? formatCurrency(deposit) : ''} 
                    onChange={e => {
                        // Chỉ giữ lại số
                        const rawValue = e.target.value.replace(/[^0-9]/g, '');
                        setDeposit(Number(rawValue));
                    }}
                  />
                </div>
                {deposit > 0 && (
                  <div className="text-right mt-1">
                     <span className="text-[10px] text-[var(--admin-sub)] italic">
                        {deposit.toLocaleString('vi-VN')} đ
                     </span>
                  </div>
                )}
             </div>
             {/* Ghi chú */}
             <div>
                <label className="text-xs font-bold text-[var(--admin-sub)] uppercase mb-2 block">Ghi chú</label>
                <input 
                    className="w-full p-3 rounded-xl bg-[var(--admin-card)] border border-[var(--admin-border)] focus:border-[var(--admin-primary)] outline-none text-sm"
                    placeholder="..."
                    value={note}
                    onChange={e => setNote(e.target.value)}
                />
             </div>
          </div>

        </div>

        {/* --- RIGHT COLUMN: SUMMARY & ACTIONS --- */}
        <div className="w-full md:w-80 bg-[var(--admin-bg)] border-t md:border-t-0 md:border-l border-[var(--admin-border)] p-6 flex flex-col justify-between">
            <div className="space-y-6">
                <h3 className="text-sm font-bold text-[var(--admin-sub)] uppercase tracking-wider">Chi tiết thanh toán</h3>
                
                <div className="space-y-3">
                    <div className="flex justify-between text-sm">
                        <span className="text-[var(--admin-sub)]">Tiền phòng ({durationHours.toFixed(1)}h)</span>
                        <span className="font-medium text-[var(--admin-fg)]">{new Intl.NumberFormat('vi-VN').format(roomTotal)} VNĐ</span>
                    </div>
                    <div className="flex justify-between text-sm">
                        <span className="text-[var(--admin-sub)]">Dịch vụ</span>
                        <span className="font-medium text-[var(--admin-fg)]">{new Intl.NumberFormat('vi-VN').format(servicesTotal)} VNĐ</span>
                    </div>
                    <div className="border-t border-[var(--admin-border)] my-2"></div>
                    <div className="flex justify-between text-base font-bold">
                        <span className="text-[var(--admin-fg)]">TỔNG CỘNG</span>
                        <span className="text-[var(--admin-primary)] text-lg">{new Intl.NumberFormat('vi-VN').format(grandTotal)} VNĐ</span>
                    </div>
                    {deposit > 0 && (
                        <div className="flex justify-between text-sm text-green-600">
                            <span>Đã cọc</span>
                            <span>-{new Intl.NumberFormat('vi-VN').format(deposit)} VNĐ</span>
                        </div>
                    )}
                </div>
            </div>

            <div className="mt-8 space-y-3">
                <button 
                    onClick={handleSubmit}
                    disabled={isSubmitting}
                    className="w-full py-3.5 bg-[var(--admin-primary)] text-white rounded-xl font-bold hover:opacity-90 shadow-lg shadow-indigo-500/20 transition-all flex items-center justify-center gap-2 disabled:opacity-70"
                >
                    {isSubmitting ? <Loader2 className="animate-spin"/> : <Check size={18}/>}
                    Xác nhận Đặt Lịch
                </button>
                <button 
                    onClick={onClose}
                    className="w-full py-3 border border-[var(--admin-border)] text-[var(--admin-sub)] hover:text-[var(--admin-fg)] hover:bg-[var(--admin-hover)] rounded-xl font-medium transition-colors"
                >
                    Hủy bỏ
                </button>
            </div>
        </div>

      </div>
    </ModalPortal>
  );
}
</file>

<file path="src/components/admin/calendar/CalendarSidebar.tsx">
'use client'


interface Room {
  room_id: number;
  name: string;
  code: string;
}

interface CalendarSidebarProps {
  rooms: Room[];
  onCreateClick: () => void;
}

export default function CalendarSidebar({ rooms, onCreateClick }: CalendarSidebarProps) {
  // Mockup Mini Calendar (Chỉ giao diện)
  const days = Array.from({ length: 35 }, (_, i) => i + 1)

  return (
    <aside className="w-[256px] flex-shrink-0 flex flex-col gap-6 pr-4 border-r border-[var(--admin-border)] bg-[var(--admin-bg)] h-full overflow-y-auto pt-4 pl-2">
      
      {/* 1. Nút TẠO (FAB Style) */}
      <div>
        <button 
          onClick={onCreateClick}
          className="flex items-center gap-3 bg-[var(--admin-card)] text-[var(--admin-fg)] px-5 py-3 rounded-full shadow-md hover:shadow-lg transition-all border border-[var(--admin-border)]"
        >
          <svg width="24" height="24" viewBox="0 0 24 24" className="fill-current text-[var(--admin-primary)]">
            <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
          </svg>
          <span className="font-medium">Tạo lịch hẹn</span>
        </button>
      </div>

      {/* 2. Mini Calendar (Mockup) */}
      <div className="px-2">
        <div className="flex justify-between mb-4 text-sm font-semibold text-[var(--admin-fg)]">
          <span>Tháng 12 2025</span>
          <div className="flex gap-2">
            <button className="hover:bg-[var(--admin-hover)] rounded-full p-1">‹</button>
            <button className="hover:bg-[var(--admin-hover)] rounded-full p-1">›</button>
          </div>
        </div>
        <div className="grid grid-cols-7 text-center text-xs gap-y-3 text-[var(--admin-sub)]">
          <span>T2</span><span>T3</span><span>T4</span><span>T5</span><span>T6</span><span>T7</span><span>CN</span>
          {days.map(d => (
            <span key={d} className={`
              cursor-pointer h-7 w-7 flex items-center justify-center rounded-full hover:bg-[var(--admin-hover)]
              ${d === 1 ? 'bg-[var(--admin-primary)] text-white' : ''}
            `}>
              {d > 31 ? d - 31 : d}
            </span>
          ))}
        </div>
      </div>

      {/* 3. Lịch của tôi (Filters) */}
      <div className="px-2">
        <h3 className="text-xs font-medium text-[var(--admin-sub)] uppercase mb-3 flex justify-between">
          Phòng Studio
          <button className="hover:bg-[var(--admin-hover)] p-1 rounded">
             ^
          </button>
        </h3>
        <ul className="space-y-2">
          {rooms.map(room => (
            <li key={room.room_id} className="flex items-center gap-2">
              <input 
                type="checkbox" 
                defaultChecked 
                className="w-4 h-4 rounded text-[var(--admin-primary)] focus:ring-0 cursor-pointer"
                style={{ accentColor: 'var(--admin-primary)' }}
              />
              <span className="text-sm text-[var(--admin-fg)] truncate">{room.name}</span>
            </li>
          ))}
          {/* Hardcode thêm mục Dọn dẹp */}
          <li className="flex items-center gap-2">
              <input 
                type="checkbox" 
                defaultChecked 
                className="w-4 h-4 rounded cursor-pointer"
                style={{ accentColor: '#7f8c8d' }}
              />
              <span className="text-sm text-[var(--admin-fg)]">🧹 Lịch Dọn dẹp</span>
            </li>
        </ul>
      </div>
    </aside>
  )
}
</file>

<file path="src/components/admin/calendar/CustomToolbar.tsx">
'use client'

import { ToolbarProps, View, Views } from 'react-big-calendar'
import { ChevronLeft, ChevronRight, ChevronDown } from 'lucide-react'
import { CalendarEvent } from './BookingCalendar'
import { useState, useRef, useEffect } from 'react'
import moment from 'moment'

export default function CustomToolbar({ 
  label, 
  date,
  onNavigate, 
  onView, 
  view, 
}: ToolbarProps<CalendarEvent, object>) {

  const [isViewMenuOpen, setIsViewMenuOpen] = useState(false)
  const menuRef = useRef<HTMLDivElement>(null)

  // Đóng menu khi click ra ngoài
  useEffect(() => {
    function handleClickOutside(event: MouseEvent) {
      if (menuRef.current && !menuRef.current.contains(event.target as Node)) {
        setIsViewMenuOpen(false)
      }
    }
    document.addEventListener("mousedown", handleClickOutside)
    return () => document.removeEventListener("mousedown", handleClickOutside)
  }, [])

  const navigate = (action: 'PREV' | 'NEXT' | 'TODAY') => {
    onNavigate(action)
  }

  const handleViewChange = (v: View) => {
    onView(v)
    setIsViewMenuOpen(false)
  }

  // Label Mapping
  const viewLabels: Record<string, string> = {
    month: 'Tháng',
    week: 'Tuần',
    day: 'Ngày',
    agenda: 'Lịch biểu'
  }

  const getCustomLabel = () => {
    switch (view) {
      case 'day':
        // Format: 04 Tháng 12 2025
        return moment(date).format('DD [Tháng] MM, YYYY'); 
      case 'month':
        // Format: Tháng 12 2025
        return moment(date).format('[Tháng] MM, YYYY');
      case 'week':
        // View tuần thì dùng label mặc định của thư viện (xử lý khoảng ngày 01-07) sẽ tốt hơn
        return label; 
      default:
        return label;
    }
  }
  return (
    <div className="flex items-center justify-between px-4 py-3 
    border-b border-[var(--admin-border)] bg-[var(--admin-card)]">
      
      {/* LEFT: Logo/Title & Navigation */}
      <div className="flex items-center gap-6">
        {/* Nút Hôm nay */}
        <button
          onClick={() => navigate('TODAY')}
          className="px-4 py-2 text-sm font-medium 
          border border-[var(--admin-border)] rounded hover:bg-[var(--admin-hover)] 
          transition-colors text-[var(--admin-fg)] cursor-pointer"
        >
          Hôm nay
        </button>

        {/* Navigation Arrows */}
        <div className="flex items-center gap-1 text-[var(--admin-fg)]">
          <button 
            onClick={() => navigate('PREV')}
            className="p-2 rounded-full hover:bg-[var(--admin-hover)] transition-colors"
            title="Trước"
          >
            <ChevronLeft size={20} />
          </button>
          <button 
            onClick={() => navigate('NEXT')}
            className="p-2 rounded-full hover:bg-[var(--admin-hover)] transition-colors"
            title="Sau"
          >
            <ChevronRight size={20} />
          </button>
        </div>

        {/* Label (Tháng 12, 2025) */}
        <h2 className="text-xl font-normal text-[var(--admin-fg)] min-w-[150px]">
          {getCustomLabel()}
        </h2>
      </div>

      {/* RIGHT: View Switcher & Settings */}
      <div className="flex items-center gap-3">
        {/* Search & Settings Icons (Mockup UI) */}
        {/* <div className="flex items-center gap-2 text-[var(--admin-sub)] mr-2">
            <button className="p-2 hover:bg-[var(--admin-hover)] rounded-full"><span className="sr-only">Search</span>🔍</button>
            <button className="p-2 hover:bg-[var(--admin-hover)] rounded-full"><span className="sr-only">Settings</span>⚙️</button>
        </div> */}

        {/* View Dropdown */}
        <div className="relative" ref={menuRef}>
          <button 
            onClick={() => setIsViewMenuOpen(!isViewMenuOpen)}
            className="flex items-center gap-2 px-3 py-2 text-sm font-medium border border-[var(--admin-border)] rounded hover:bg-[var(--admin-hover)] transition-colors text-[var(--admin-fg)] bg-[var(--admin-card)] min-w-[100px] justify-between"
          >
            <span>{viewLabels[view] || view}</span>
            <ChevronDown size={14} className="opacity-70" />
          </button>

          {isViewMenuOpen && (
            <div className="absolute right-0 top-full mt-1 w-40 bg-[var(--admin-card)] border border-[var(--admin-border)] rounded shadow-lg z-50 py-1">
              {[Views.DAY, Views.WEEK, Views.MONTH, Views.AGENDA].map((v) => (
                <button
                  key={v}
                  onClick={() => handleViewChange(v)}
                  className={`w-full text-left px-4 py-2 text-sm hover:bg-[var(--admin-hover)] flex items-center justify-between
                    ${view === v ? 'bg-[var(--admin-primary)]/10 text-[var(--admin-primary)]' : 'text-[var(--admin-fg)]'}
                  `}
                >
                   {viewLabels[v]}
                   {view === v && <span>✓</span>}
                </button>
              ))}
            </div>
          )}
        </div>
      </div>
    </div>
  )
}
</file>

<file path="src/components/admin/calendar/NavCalendarWidget.tsx">
'use client'

import { useState, useEffect, useMemo } from 'react'
import { useRouter, usePathname } from 'next/navigation';
import { CalendarIcon, ChevronDown, Check, Plus } from 'lucide-react';
import { format, startOfMonth, endOfMonth, eachDayOfInterval, getDay, isSameDay, addMonths, subMonths } from 'date-fns';
import { useCalendar } from '@/context/CalendarContext';
import { ROOM_COLORS } from '@/lib/constants'; //

interface Room {
  room_id: number;
  name: string | null;
  status?: 'available' | 'maintenance' | 'inactive';
  is_equipment_room?: boolean | null;
}

export default function NavCalendarWidget({ rooms }: { rooms: Room[] }) {
  const router = useRouter();
  const pathname = usePathname();
  const [isExpanded, setIsExpanded] = useState(true); 
  
  const { 
    date, 
    setDate, 
    setCreateModalOpen, 
    visibleRoomIds, 
    toggleRoomVisibility,
    setVisibleRoomIds
  } = useCalendar();


  const availableRooms = useMemo(() => {
    return rooms.filter(r => 
        r.status === 'available' && 
        !(r.is_equipment_room === true)
    );
  }, [rooms]);

  // Khởi tạo: Mặc định chọn tất cả phòng khi mới load
  useEffect(() => {
    if (availableRooms.length > 0 && visibleRoomIds.length === 0) {
        const allIds = availableRooms.map(r => r.room_id);
        setVisibleRoomIds(allIds);
    }
  }, [availableRooms, visibleRoomIds.length, setVisibleRoomIds]);

  // Logic chuyển trang
  const navigateToCalendar = () => {
    if (pathname !== '/admin/calendar') {
        router.push('/admin/calendar');
    }
  };

  // Logic Mini Calendar
  const currentMonthStart = startOfMonth(date);
  const currentMonthEnd = endOfMonth(date);
  const daysInMonth = eachDayOfInterval({ start: currentMonthStart, end: currentMonthEnd });
  const startDayOfWeek = getDay(currentMonthStart); 
  const paddingCount = startDayOfWeek === 0 ? 6 : startDayOfWeek - 1;
  const paddingDays = Array.from({ length: paddingCount });

  const handleDateClick = (d: Date) => {
    setDate(d);
    navigateToCalendar();
    if (!isExpanded) setIsExpanded(true);
  };

  const handleQuickCreate = (e: React.MouseEvent) => {
    e.stopPropagation();
    setCreateModalOpen(true);
    navigateToCalendar(); 
  };

  return (
    <div className="my-1">
      {/* Header Button */}
      <div className="flex items-stretch gap-[1px]"> 
        <button 
          onClick={() => { navigateToCalendar() }}
          className={`flex-1 flex items-center gap-3 px-4 py-2.5 text-sm font-medium rounded-l-lg cursor-pointer transition-all duration-200 
            ${pathname === '/admin/calendar' 
              ? 'bg-[var(--admin-bg)] text-[var(--admin-primary)] shadow-md shadow-gray-500/20' 
              : 'text-[var(--admin-sub)] hover:bg-[var(--admin-hover)] hover:text-[var(--admin-fg)]'
            }`}
        >
            <CalendarIcon size={20} />
            <span className="truncate ">Lịch Studio</span>
        </button>
        <button 
          onClick={(e) => { e.stopPropagation(); setIsExpanded(!isExpanded); }}
          className="w-8 flex items-center justify-center cursor-pointer rounded-r-lg transition-all duration-200 text-[var(--admin-sub)] hover:bg-[var(--admin-hover)]"
        >
           <ChevronDown size={14} className={`transition-transform duration-200 ${isExpanded ? 'rotate-180' : ''}`} />
        </button>
      </div>

      {/* Expandable Content */}
      <div className={`grid transition-all duration-300 ease-in-out overflow-hidden ${isExpanded ? 'grid-rows-[1fr] opacity-100 mt-3' : 'grid-rows-[0fr] opacity-0'}`}>
        <div className="min-h-0 space-y-4">
            
            {/* Nút Tạo Nhanh */}
            <button 
                onClick={handleQuickCreate}
                className="w-full flex items-center justify-center gap-2 bg-[var(--admin-card)] 
                border border-[var(--admin-primary)] text-[var(--admin-primary)] text-xs font-bold py-2 
                rounded-lg hover:bg-[var(--admin-primary)] hover:text-white transition-all cursor-pointer shadow-sm"
            >
                <Plus size={14} /> TẠO BOOKING
            </button>

            {/* Mini Calendar */}
            <div className="bg-[var(--admin-card)] p-3 rounded-lg border border-[var(--admin-border)] shadow-sm">
                <div className="flex items-center justify-between mb-3">
                    <button onClick={() => setDate(subMonths(date, 1))} className="hover:bg-[var(--admin-hover)] p-1 rounded text-[var(--admin-sub)] text-xs">‹</button>
                    <div className="text-[11px] font-bold text-[var(--admin-fg)] uppercase tracking-wider">
                        Tháng {format(date, 'MM/yyyy')}
                    </div>
                    <button onClick={() => setDate(addMonths(date, 1))} className="hover:bg-[var(--admin-hover)] p-1 rounded text-[var(--admin-sub)] text-xs">›</button>
                </div>
                
                <div className="grid grid-cols-7 text-center text-[9px] gap-y-2 text-[var(--admin-sub)] font-medium mb-1">
                    <span>T2</span><span>T3</span><span>T4</span><span>T5</span><span>T6</span><span>T7</span><span className="text-red-400">CN</span>
                </div>
                
                <div className="grid grid-cols-7 text-center text-[10px] gap-1">
                    {paddingDays.map((_, i) => <span key={`pad-${i}`} />)}
                    {daysInMonth.map(d => {
                        const isSelected = isSameDay(d, date);
                        return (
                            <span 
                                key={d.toString()} 
                                onClick={(e) => { e.stopPropagation(); handleDateClick(d); }}
                                className={`
                                    cursor-pointer h-6 w-6 flex items-center justify-center rounded-full transition-all
                                    ${isSelected 
                                        ? 'bg-[var(--admin-primary)] text-[var(--admin-primary-fg)] font-bold shadow-md' 
                                        : 'text-[var(--admin-fg)] hover:bg-[var(--admin-hover)]'
                                    }
                                `}
                            >
                                {format(d, 'd')}
                            </span>
                        )
                    })}
                </div>
            </div>

            {/* Bộ lọc phòng */}
            <div className="space-y-2">
                <div className="flex items-center justify-between px-1">
                     <p className="text-[10px] font-bold text-[var(--admin-sub)] uppercase">Hiển thị phòng:</p>
                     <button 
                        onClick={() => setVisibleRoomIds(availableRooms.map(r => r.room_id))}
                        className="text-[9px] text-[var(--admin-primary)] hover:underline cursor-pointer hover:text-[var(--admin-fg)]"
                     >
                        Tất cả
                     </button>
                </div>
                
                <div className="max-h-[200px] overflow-y-auto no-scrollbar space-y-1">
                    {availableRooms.length > 0 ? (
                        availableRooms.map((room, index) => {
                            const isChecked = visibleRoomIds.includes(room.room_id);
                            // Lấy màu dựa trên index của mảng đã lọc
                            const color = ROOM_COLORS[index % ROOM_COLORS.length]; 

                            return (
                                <div 
                                    key={room.room_id} 
                                    onClick={() => toggleRoomVisibility(room.room_id)}
                                    className="flex items-center gap-3 cursor-pointer group py-1.5 px-2 hover:bg-[var(--admin-hover)] rounded-md transition-colors"
                                >
                                    <div 
                                        className={`w-4 h-4 rounded border flex items-center justify-center transition-all ${isChecked ? 'border-transparent' : 'border-[var(--admin-sub)] bg-transparent'}`}
                                        style={{ backgroundColor: isChecked ? color : undefined }}
                                    >
                                        {isChecked && <Check size={10} className="text-white" />}
                                    </div>

                                    <span className={`text-xs truncate transition-opacity ${isChecked ? 'text-[var(--admin-fg)] font-medium' : 'text-[var(--admin-sub)] opacity-70'}`}>
                                        {room.name || `Phòng ${room.room_id}`}
                                    </span>
                                </div>
                            )
                        })
                    ) : (
                        <p className="text-xs text-[var(--admin-sub)] text-center py-2 italic">
                            Không có phòng trống
                        </p>
                    )}
                </div>
            </div>
        </div>
      </div>
    </div>
  )
}
</file>

<file path="src/components/admin/CreateStaffModal.tsx">
// src/components/admin/CreateStaffModal.tsx
'use client';

import React, { useState } from 'react';
import { Loader2, Mail, User, Lock, Shield } from 'lucide-react';
import { toast } from 'sonner';
import { createStaffAccount } from '@/lib/actions';
// Import ModalPortal mới
import ModalPortal from '@/components/ui/ModalPortal';

interface CreateStaffModalProps {
  isOpen: boolean;
  onClose: () => void;
}

export default function CreateStaffModal({ isOpen, onClose }: CreateStaffModalProps) {
  const [isLoading, setIsLoading] = useState(false);
  const [formData, setFormData] = useState({
    fullName: '',
    email: '',
    password: '123@123',
    role: 'Staff'
  });

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setIsLoading(true);
    
    try {
      const res = await createStaffAccount(formData);
      if (res.success) {
        toast.success('Tạo tài khoản nhân viên thành công!');
        setFormData({ fullName: '', email: '', password: '', role: 'Staff' }); 
        onClose(); 
      } else {
        toast.error(`Lỗi: ${res.error}`);
      }
    } catch (error) {
        const message = error instanceof Error ? error.message : 'Có lỗi xảy ra.';
        toast.error(message);
    } finally {
      setIsLoading(false);
    }
  };

  // Dùng ModalPortal bao bọc Form
  return (
    <ModalPortal 
      isOpen={isOpen} 
      onClose={isLoading ? () => {} : onClose} 
      title="Thêm Nhân viên Mới"
      className="max-w-md" // Chỉnh độ rộng ở đây
    >
      <form onSubmit={handleSubmit} className="p-6 space-y-5">
          
          {/* Input Họ tên */}
          <div>
            <label className="block text-xs font-bold text-[var(--admin-sub)] uppercase mb-1.5">Họ và Tên</label>
            <div className="relative group">
                <User className="absolute left-3 top-2.5 text-[var(--admin-sub)] group-focus-within:text-[var(--admin-primary)] transition-colors" size={18} />
                <input required className="w-full pl-10 p-2.5 rounded-lg bg-[var(--admin-bg)] border border-[var(--admin-border)] text-[var(--admin-fg)] focus:ring-2 focus:ring-[var(--admin-primary)]/20 focus:border-[var(--admin-primary)] outline-none transition-all" 
                    value={formData.fullName} onChange={e => setFormData({...formData, fullName: e.target.value})} placeholder="VD: Nguyễn Văn A"
                />
            </div>
          </div>

          {/* Input Email */}
          <div>
            <label className="block text-xs font-bold text-[var(--admin-sub)] uppercase mb-1.5">Email Đăng nhập</label>
            <div className="relative group">
                <Mail className="absolute left-3 top-2.5 text-[var(--admin-sub)] group-focus-within:text-[var(--admin-primary)] transition-colors" size={18} />
                <input required type="email" className="w-full pl-10 p-2.5 rounded-lg bg-[var(--admin-bg)] border border-[var(--admin-border)] text-[var(--admin-fg)] focus:ring-2 focus:ring-[var(--admin-primary)]/20 focus:border-[var(--admin-primary)] outline-none transition-all" 
                    value={formData.email} onChange={e => setFormData({...formData, email: e.target.value})} placeholder="nhanvien@onistudio.com"
                />
            </div>
          </div>

          {/* Input Password */}
          <div>
            <label className="block text-xs font-bold text-[var(--admin-sub)] uppercase mb-1.5">Mật khẩu mặc định</label>
            <div className="relative group">
                <Lock className="absolute left-3 top-2.5 text-[var(--admin-sub)] group-focus-within:text-[var(--admin-primary)] transition-colors" size={18} />
                <input required type="text" className="w-full pl-10 p-2.5 rounded-lg bg-[var(--admin-bg)] border border-[var(--admin-border)] text-[var(--admin-fg)] focus:ring-2 focus:ring-[var(--admin-primary)]/20 focus:border-[var(--admin-primary)] outline-none font-mono transition-all" 
                    value={formData.password} onChange={e => setFormData({...formData, password: e.target.value})} placeholder="Tối thiểu 6 ký tự" minLength={6}
                />
            </div>
            <p className="text-[10px] text-[var(--admin-sub)] mt-1.5 ml-1">* Nhân viên có thể đổi mật khẩu sau.</p>
          </div>

          {/* Input Role */}
          <div>
            <label className="block text-xs font-bold text-[var(--admin-sub)] uppercase mb-1.5">Vai trò</label>
            <div className="relative group">
                <Shield className="absolute left-3 top-2.5 text-[var(--admin-sub)] group-focus-within:text-[var(--admin-primary)] transition-colors" size={18} />
                <select className="w-full pl-10 p-2.5 rounded-lg bg-[var(--admin-bg)] border border-[var(--admin-border)] text-[var(--admin-fg)] focus:ring-2 focus:ring-[var(--admin-primary)]/20 focus:border-[var(--admin-primary)] outline-none appearance-none cursor-pointer transition-all"
                    value={formData.role} onChange={e => setFormData({...formData, role: e.target.value})}
                >
                    <option value="Staff">Staff (Nhân viên)</option>
                    <option value="Admin">Admin (Quản trị viên)</option>
                </select>
            </div>
          </div>

          {/* Button Submit */}
          <div className="pt-4">
            <button type="submit" disabled={isLoading} className="w-full py-3 bg-[var(--admin-primary)] text-white rounded-lg font-bold hover:opacity-90 transition-all shadow-lg shadow-indigo-500/30 flex justify-center items-center gap-2 disabled:opacity-70 disabled:cursor-not-allowed">
                {isLoading ? <Loader2 className="animate-spin" size={20} /> : 'Tạo Tài Khoản'}
            </button>
          </div>

      </form>
    </ModalPortal>
  );
}
</file>

<file path="src/components/admin/DashboardCalendar.tsx">
// src/components/admin/DashboardCalendar.tsx
'use client'

import { useEffect, useState, useCallback, useMemo } from 'react';
import { toast } from 'sonner';
import { RoomWithBranch, ServiceItem } from '@/lib/actions/studio';
import { CustomerRow } from '@/lib/actions/customers';
import { EventInteractionArgs } from 'react-big-calendar/lib/addons/dragAndDrop';
import { useCalendar } from '@/context/CalendarContext'; 
import moment from 'moment';
import BookingDetailModal from './calendar/BookingDetailModal';
import BookingCalendar, { BookingItem, CalendarEvent } from './calendar/BookingCalendar'; 
import BookingCreateModal from './calendar/BookingCreateModal';
import { updateBookingTime } from '@/lib/actions/bookings';
// KHÔNG import getCleanupMinutes ở đây vì là Client Component

interface DashboardCalendarProps {
  rooms: RoomWithBranch[];
  bookings: BookingItem[]; 
  services: ServiceItem[];
  customers: CustomerRow[];
  currentUserId: number;
  cleanupMinutes: number; 
}

export default function DashboardCalendar({
  rooms,
  bookings: initialBookings,
  services,
  customers,
  currentUserId,
  cleanupMinutes // 2. NHẬN PROP
}: DashboardCalendarProps) {
  

   const { 
      date, setDate, 
      visibleRoomIds, setVisibleRoomIds, 
      isCreateModalOpen, setCreateModalOpen
  } = useCalendar();

  const availableRooms = useMemo(() => {
    return rooms.filter(r => r.status === 'available' && !r.is_equipment_room);
  }, [rooms]);

  // --- SYNC VISIBLE ROOMS LẦN ĐẦU (Nếu Nav chưa chạy kịp) ---
  useEffect(() => {
      // Dùng logic set 1 lần (Bulk Set) thay vì forEach loop
      if (availableRooms.length > 0 && visibleRoomIds.length === 0) {
          const allIds = availableRooms.map(r => r.room_id);
          setVisibleRoomIds(allIds);
      }
  }, [availableRooms, visibleRoomIds.length, setVisibleRoomIds]);

  // 3. STATE LOCAL DATA
  const [localBookings, setLocalBookings] = useState<BookingItem[]>(initialBookings);
  useEffect(() => {
    setLocalBookings(initialBookings);
  }, [initialBookings]);

  // 4. LỌC DỮ LIỆU HIỂN THỊ
  // Lọc Booking: Chỉ hiện booking của các phòng được check
  const filteredBookings = localBookings.filter(b => visibleRoomIds.includes(b.room_id));
  
  // Lọc Cột Phòng: Chỉ hiện các cột được check (cho giao diện Day view đỡ rối)
  const filteredRooms = rooms.filter(r => visibleRoomIds.includes(r.room_id));

  // State local cho slot được chọn (để truyền vào Modal)
  const [selectedSlot, setSelectedSlot] = useState<{
    start: Date;
    end: Date;
    roomId: number;
  } | null>(null);

  // --- LOGIC EVENT HANDLERS (Drag, Drop, Resize) ---
  const handleEventChange = useCallback(async ({ event, start, end, resourceId }: EventInteractionArgs<CalendarEvent>) => {
      const bookingItemId = Number(event.id);
      if (isNaN(bookingItemId)) return;

      const newStartDate = new Date(start);
      const newEndDate = new Date(end);
      const newRoomId = resourceId ? Number(resourceId) : event.resourceId;

      // Optimistic Update
      setLocalBookings((prev) => prev.map((b) => {
        if (b.booking_item_id === bookingItemId) {
          return { ...b, start_dt: newStartDate.toISOString(), end_dt: newEndDate.toISOString(), room_id: newRoomId };
        }
        return b;
      }));

      try {
        const res = await updateBookingTime(bookingItemId, newStartDate.toISOString(), newEndDate.toISOString(), newRoomId);
        if (res.success) toast.success("Đã cập nhật lịch!");
        else {
            toast.error(res.error);
            setLocalBookings(initialBookings);
        }
      } catch (error) { 
          toast.error("Lỗi kết nối" + (error instanceof Error ? error.message : ""));
          setLocalBookings(initialBookings);
      }
  }, [initialBookings]); 

  // --- CLICK EMPTY SLOT ---
  const handleSlotSelect = ({ start, end, resourceId }: { start: Date; end: Date; resourceId: number }) => {
    setSelectedSlot({ start, end, roomId: resourceId });
    setCreateModalOpen(true); // Mở Modal thông qua Context
  };

  // --- MAPPING DATA CHO CALENDAR ---
  const calendarRooms = filteredRooms.map(r => ({
    room_id: r.room_id,
    name: r.name,
    code: r.code,
    status: r.status
  }));

  const defaultStartTime = useMemo(() => {
    const now = new Date();
    if (now.getMinutes() > 0) {
        now.setMinutes(now.getMinutes() + (15 - now.getMinutes() % 15)); // Làm tròn lên 15p
    }
    now.setSeconds(0);
    now.setMilliseconds(0);
    return now;
  }, []);
  // Initial Data cho Modal (Xử lý trường hợp mở từ nút "Tạo mới" ở Widget -> chưa có slot)
  const modalInitialData = useMemo(() => {
    if (selectedSlot) {
      return {
        start: selectedSlot.start,
        end: selectedSlot.end,
        roomId: selectedSlot.roomId
      };
    }
    // Nếu tạo mới thủ công: Dùng mốc thời gian cố định
    return {
      start: defaultStartTime, 
      end: moment(defaultStartTime).add(1, 'hours').toDate(),
      roomId: rooms[0]?.room_id || 0
    };
  }, [selectedSlot, rooms, defaultStartTime]);

  const [selectedBookingId, setSelectedBookingId] = useState<number | null>(null);
  const [isDetailOpen, setIsDetailOpen] = useState(false);

  // Handler khi click vào event
  const handleSelectEvent = (event: CalendarEvent) => {
      if (event.type === 'cleanup') return;
      
      // Lấy booking_id từ field resource ta đã thêm ở BookingCalendar
      const bId = event.resource?.bookingId;
      if (bId) {
          setSelectedBookingId(bId);
          setIsDetailOpen(true);
      }
  };

  return (
    <div className="h-full border border-[var(--admin-border)] rounded-2xl overflow-hidden shadow-sm bg-[var(--admin-card)] flex flex-col">
      <div className="px-6 py-4 border-b border-[var(--admin-border)] flex items-center justify-between">
         <h3 className="font-bold text-[var(--admin-fg)]">Lịch Đặt Phòng</h3>
      </div>

      <div className="flex-1 min-h-0">
        <BookingCalendar 
            bookings={filteredBookings} 
            rooms={calendarRooms} 
            date={date} 
            cleanupMinutes={cleanupMinutes} // 3. TRUYỀN XUỐNG
            onNavigate={setDate} 
            onSelectSlot={handleSlotSelect} 
            onEventDrop={(args) => handleEventChange(args)}   
            onEventResize={(args) => handleEventChange(args)}
            onSelectEvent={handleSelectEvent}
        />
      </div>
      <BookingDetailModal 
            isOpen={isDetailOpen}
            onClose={() => setIsDetailOpen(false)}
            bookingId={selectedBookingId}
            servicesList={services} // Truyền list dịch vụ để chọn OT/Phí
        />
      <BookingCreateModal
        isOpen={isCreateModalOpen}
        onClose={() => setCreateModalOpen(false)}
        initialData={modalInitialData}
        rooms={rooms}
        services={services}
        customers={customers}
        currentUserId={currentUserId}
      />
    </div>
  );
}
</file>

<file path="src/components/admin/GrowthChart.tsx">
// src/components/admin/GrowthChart.tsx
'use client';

import { 
  AreaChart, 
  Area, 
  XAxis, 
  YAxis, 
  CartesianGrid, 
  Tooltip, 
  ResponsiveContainer 
} from 'recharts';
import { MonthlyStat } from '@/lib/actions';

export default function GrowthChart({ data }: { data: MonthlyStat[] }) {
  return (
    <div className="w-full h-[350px] mt-4">
      <ResponsiveContainer width="100%" height="100%">
        <AreaChart data={data} margin={{ top: 10, right: 30, left: 0, bottom: 0 }}>
          <defs>
            {/* Gradient màu tím đẹp mắt */}
            <linearGradient id="colorTotal" x1="0" y1="0" x2="0" y2="1">
              <stop offset="5%" stopColor="var(--admin-primary)" stopOpacity={0.3}/>
              <stop offset="95%" stopColor="var(--admin-primary)" stopOpacity={0}/>
            </linearGradient>
          </defs>
          
          <XAxis 
            dataKey="name" 
            stroke="var(--admin-sub)" 
            fontSize={12} 
            tickLine={false} 
            axisLine={false}
          />
          <YAxis 
            stroke="var(--admin-sub)" 
            fontSize={12} 
            tickLine={false} 
            axisLine={false} 
            allowDecimals={false} // Chỉ hiện số nguyên
          />
          
          <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="var(--admin-border)" />
          
          <Tooltip 
            contentStyle={{ 
              backgroundColor: 'var(--admin-card)', 
              borderColor: 'var(--admin-border)', 
              borderRadius: '8px',
              color: 'var(--admin-fg)'
            }}
            itemStyle={{ color: 'var(--admin-primary)' }}
          />
          
          <Area 
            type="monotone" 
            dataKey="total" 
            stroke="var(--admin-primary)" 
            fillOpacity={1} 
            fill="url(#colorTotal)" 
            strokeWidth={3}
          />
        </AreaChart>
      </ResponsiveContainer>
    </div>
  );
}
</file>

<file path="src/components/admin/SortableProjectItem.tsx">
// src/components/admin/SortableProjectItem.tsx
'use client';

import { useSortable } from '@dnd-kit/sortable';
import { CSS } from '@dnd-kit/utilities';

interface SortableItemProps {
  id: number;
  children: React.ReactNode;
  colSpan: number; // Cần nhận vào để set style grid
  rowSpan: number;
}

export function SortableProjectItem({ id, children, colSpan, rowSpan }: SortableItemProps) {
  const {
    attributes,
    listeners,
    setNodeRef,
    transform,
    transition,
    isDragging
  } = useSortable({ id: id });

  const style = {
    transform: CSS.Transform.toString(transform),
    transition,
    gridColumn: `span ${colSpan}`,
    gridRow: `span ${rowSpan}`,
    zIndex: isDragging ? 50 : 'auto', // Khi kéo thì nổi lên trên
    opacity: isDragging ? 0.5 : 1,    // Khi kéo thì mờ đi chút
  };

  return (
    <div ref={setNodeRef} style={style} {...attributes} {...listeners} className="h-full relative group">
      {children}
    </div>
  );
}
</file>

<file path="src/components/admin/TodaySchedule.tsx">
'use client';

import { format } from 'date-fns';
import { Calendar, MapPin, User, ArrowRight } from 'lucide-react';
import Link from 'next/link';

interface ScheduleItem {
  booking_item_id: number;
  start_dt: string;
  end_dt: string;
  rooms: { 
    name: string | null; 
    code: string | null; // <-- QUAN TRỌNG: Cho phép null
  } | null;
  bookings: {
    status: string | null;
    customers: { full_name: string | null; phone: string | null } | null;
  } | null;
}

export default function TodaySchedule({ bookings }: { bookings: ScheduleItem[] }) {
  if (bookings.length === 0) {
    return (
      <div className="h-full flex flex-col items-center justify-center text-[var(--admin-sub)] opacity-70 min-h-[300px]">
        <Calendar size={48} strokeWidth={1} className="mb-2" />
        <p>Hôm nay không có lịch chụp nào.</p>
        <Link 
            href="/admin/calendar" 
            className="mt-4 text-sm text-[var(--admin-primary)] hover:underline flex items-center gap-1"
        >
            Tạo booking ngay <ArrowRight size={14} />
        </Link>
      </div>
    );
  }

  return (
    <div className="space-y-4">
      {bookings.map((item) => {
        const startDate = new Date(item.start_dt);
        const endDate = new Date(item.end_dt);
        const status = item.bookings?.status || 'pending';
        
        // Màu sắc trạng thái
        let statusColor = 'bg-gray-100 text-gray-600';
        if (status === 'confirmed') statusColor = 'bg-blue-100 text-blue-600';
        if (status === 'completed') statusColor = 'bg-green-100 text-green-600';
        if (status === 'cancelled') statusColor = 'bg-red-100 text-red-600';

        return (
          <div key={item.booking_item_id} className="flex gap-4 p-3 rounded-xl border border-[var(--admin-border)] bg-[var(--admin-bg)] hover:border-[var(--admin-primary)] transition-colors group">
            
            {/* Cột giờ */}
            <div className="flex flex-col items-center justify-center w-16 p-2 bg-[var(--admin-card)] rounded-lg border border-[var(--admin-border)] shrink-0">
              <span className="text-lg font-bold text-[var(--admin-fg)] leading-none">
                {format(startDate, 'HH:mm')}
              </span>
              <span className="text-[10px] text-[var(--admin-sub)] mt-1">
                đến {format(endDate, 'HH:mm')}
              </span>
            </div>

            {/* Thông tin chính */}
            <div className="flex-1 min-w-0">
              <div className="flex justify-between items-start">
                <h4 className="font-bold text-[var(--admin-fg)] truncate">
                  {item.bookings?.customers?.full_name || 'Khách vãng lai'}
                </h4>
                <span className={`text-[10px] px-2 py-0.5 rounded-full font-bold uppercase tracking-wider ${statusColor}`}>
                  {status}
                </span>
              </div>
              
              <div className="mt-1 space-y-1">
                <div className="flex items-center gap-2 text-xs text-[var(--admin-sub)]">
                  <MapPin size={12} /> 
                  <span className="font-medium text-[var(--admin-fg)]">
                    {item.rooms?.name || item.rooms?.code || 'Chưa xếp phòng'}
                  </span>
                </div>
                {item.bookings?.customers?.phone && (
                    <div className="flex items-center gap-2 text-xs text-[var(--admin-sub)]">
                    <User size={12} /> {item.bookings.customers.phone}
                    </div>
                )}
              </div>
            </div>
          </div>
        );
      })}
      
      <div className="pt-2 text-center">
        <Link href="/admin/calendar" className="text-xs text-[var(--admin-sub)] hover:text-[var(--admin-primary)] hover:underline">
            Xem toàn bộ lịch trình &rarr;
        </Link>
      </div>
    </div>
  );
}
</file>

<file path="src/components/progressive-carousel.tsx">
'use client';

import React, {
  createContext,
  useContext,
  useState,
  useEffect,
  useRef,
  ReactNode,
  FC,
  useCallback, // 1. SỬA LỖI: Import thêm useCallback
} from 'react';
import { motion, AnimatePresence } from 'framer-motion'; // 2. SỬA LỖI: Import đúng từ 'framer-motion'
import { cn } from '@/lib/utils'; // Giữ nguyên code cũ của bạn

// Define the type for the context value
interface ProgressSliderContextType {
  active: string;
  progress: number;
  handleButtonClick: (value: string) => void;
  vertical: boolean;
}

// ... (Các interface ProgressSliderProps, SliderContentProps... giữ nguyên) ...
interface ProgressSliderProps {
  children: ReactNode;
  duration?: number;
  fastDuration?: number;
  vertical?: boolean;
  activeSlider: string;
  className?: string;
}

interface SliderContentProps {
  children: ReactNode;
  className?: string;
}

interface SliderWrapperProps {
  children: ReactNode;
  value: string;
  className?: string;
}

interface ProgressBarProps {
  children: ReactNode;
  className?: string;
}

interface SliderBtnProps {
  children: ReactNode;
  value: string;
  className?: string;
  progressBarClass?: string;
}

// Create the context with an undefined initial value
const ProgressSliderContext = createContext<
  ProgressSliderContextType | undefined
>(undefined);

export const useProgressSliderContext = (): ProgressSliderContextType => {
  const context = useContext(ProgressSliderContext);
  if (!context) {
    throw new Error(
      'useProgressSliderContext must be used within a ProgressSlider'
    );
  }
  return context;
};

export const ProgressSlider: FC<ProgressSliderProps> = ({
  children,
  duration = 5000,
  fastDuration = 400,
  vertical = false,
  activeSlider,
  className,
}) => {
  const [active, setActive] = useState<string>(activeSlider);
  const [progress, setProgress] = useState<number>(0);
  const [isFastForward, setIsFastForward] = useState<boolean>(false);
  const frame = useRef<number>(0);
  const firstFrameTime = useRef<number>(performance.now());
  const targetValue = useRef<string | null>(null);
  const [sliderValues, setSliderValues] = useState<string[]>([]);

  useEffect(() => {
    // 3. SỬA LỖI 'unknown': Thêm type cụ thể
    const getChildren = React.Children.toArray(children).find(
      (child) => (child as React.ReactElement).type === SliderContent
    ) as React.ReactElement<SliderContentProps> | undefined; // Thêm type cho props

    if (getChildren) {
      const values = React.Children.toArray(getChildren.props.children).map(
        (child) =>
          (child as React.ReactElement<SliderWrapperProps>).props.value // Thêm type cho props
      );
      setSliderValues(values);
    }
  }, [children]);

  // 4. SỬA LỖI 'missing dependency' VÀ LỖI "ĐỨNG":
  // Bọc 'animate' trong 'useCallback'
  const animate = useCallback(
    (now: number) => {
      const currentDuration = isFastForward ? fastDuration : duration;
      const elapsedTime = now - firstFrameTime.current;
      const timeFraction = elapsedTime / currentDuration;

      if (timeFraction <= 1) {
        // Dùng functional update để tránh 'progress' bị stale
        setProgress((prevProgress) =>
          isFastForward
            ? prevProgress + (100 - prevProgress) * timeFraction
            : timeFraction * 100
        );
        frame.current = requestAnimationFrame(animate);
      } else {
        if (isFastForward) {
          setIsFastForward(false); // Dùng setter
          if (targetValue.current !== null) {
            setActive(targetValue.current); // Dùng setter
            targetValue.current = null;
          }
        } else {
          // Move to the next slide
          const currentIndex = sliderValues.indexOf(active);
          const nextIndex = (currentIndex + 1) % sliderValues.length;
          setActive(sliderValues[nextIndex]); // Dùng setter
        }
        setProgress(0); // Dùng setter
        firstFrameTime.current = performance.now();
      }
    },
    [
      isFastForward,
      fastDuration,
      duration,
      sliderValues,
      active,
      // Các hàm setter (setActive, setProgress...) là ổn định, không cần đưa vào
    ]
  );

  useEffect(() => {
    if (sliderValues.length > 0) {
      firstFrameTime.current = performance.now();
      frame.current = requestAnimationFrame(animate);
    }
    return () => {
      cancelAnimationFrame(frame.current);
    };
  }, [sliderValues, active, isFastForward, animate]); // Thêm 'animate' vào đây

  const handleButtonClick = (value: string) => {
    if (value !== active) {
      const elapsedTime = performance.now() - firstFrameTime.current;
      const currentProgress = (elapsedTime / duration) * 100;
      setProgress(currentProgress);
      targetValue.current = value;
      setIsFastForward(true);
      firstFrameTime.current = performance.now();
    }
  };

  return (
    <ProgressSliderContext.Provider
      value={{ active, progress, handleButtonClick, vertical }}
    >
      <div className={cn('relative', className)}>{children}</div>
    </ProgressSliderContext.Provider>
  );
};

export const SliderContent: FC<SliderContentProps> = ({
  children,
  className,
}) => {
  return <div className={cn('', className)}>{children}</div>;
};

export const SliderWrapper: FC<SliderWrapperProps> = ({
  children,
  value,
  className,
}) => {
  const { active } = useProgressSliderContext();

  return (
    <AnimatePresence mode="popLayout">
      {active === value && (
        <motion.div
          key={value}
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          exit={{ opacity: 0 }}
          className={cn('', className)}
        >
          {children}
        </motion.div>
      )}
    </AnimatePresence>
  );
};

export const SliderBtnGroup: FC<ProgressBarProps> = ({
  children,
  className,
}) => {
  return <div className={cn('', className)}>{children}</div>;
};

export const SliderBtn: FC<SliderBtnProps> = ({
  children,
  value,
  className,
  progressBarClass,
}) => {
  const { active, progress, handleButtonClick, vertical } =
    useProgressSliderContext();

  return (
    <button
      className={cn(
        `relative ${active === value ? 'opacity-100' : 'opacity-50'}`,
        className
      )}
      onClick={() => handleButtonClick(value)}
    >
      {children}
      <div
        className="absolute inset-0 overflow-hidden -z-10 max-h-full max-w-full "
        role="progressbar"
        aria-valuenow={active === value ? progress : 0}
      >
        <span
          className={cn('absolute left-0 ', progressBarClass)}
          style={{
            [vertical ? 'height' : 'width']:
              active === value ? `${progress}%` : '0%',
          }}
        />
      </div>
    </button>
  );
};
</file>

<file path="src/components/ProjectMasonryGrid.tsx">
// src/components/ProjectMasonryGrid.tsx
'use client';

import Image from 'next/image';
import Link from 'next/link';
import { ArrowUpRight } from 'lucide-react';
import { ProjectData } from '@/data/projects-master-data';

// Định nghĩa 3 kiểu Layout
type LayoutVariant = 'flat' | 'staggered' | 'cascade';

interface GridProps {
  projects: ProjectData[];
  variant?: LayoutVariant; // Prop mới để chọn kiểu
}

const distributeProjects = (items: ProjectData[], cols: number) => {
  const columns: ProjectData[][] = Array.from({ length: cols }, () => []);
  items.forEach((item, i) => {
    columns[i % cols].push(item);
  });
  return columns;
};

export default function ProjectMasonryGrid({ projects, variant = 'staggered' }: GridProps) {
  const mobileProjects = projects;
  const tabletCols = distributeProjects(projects, 2);
  const desktopCols = distributeProjects(projects, 3);

  // --- LOGIC TÍNH TOÁN KHOẢNG CÁCH (PADDING TOP) ---
  
  // 1. Kiểu 'flat' (Thương mại): Thẳng tắp, không lệch
  const getFlatPadding = () => 'pt-0';

  // 2. Kiểu 'staggered' (Thời trang): Lệch cột giữa (So le)
  const getStaggeredPadding = (colIndex: number, totalCols: number) => {
    // Nếu 3 cột -> Cột giữa (index 1) lệch xuống 36px
    if (totalCols === 3 && colIndex === 1) return 'pt-[36px]';
    // Nếu 2 cột -> Cột phải (index 1) lệch xuống 36px
    if (totalCols === 2 && colIndex === 1) return 'pt-[36px]';
    return 'pt-0';
  };

  // 3. Kiểu 'cascade' (Cá nhân): Bậc thang (0 -> 40 -> 80px)
  const getCascadePadding = (colIndex: number) => {
    // Cột 1: 0px, Cột 2: 40px, Cột 3: 80px
    if (colIndex === 0) return 'pt-0';
    if (colIndex === 1) return 'pt-[40px]';
    if (colIndex === 2) return 'pt-[80px]';
    return 'pt-0';
  };

  // Hàm chọn style dựa trên variant
  const getPaddingClass = (colIndex: number, totalCols: number) => {
    if (variant === 'flat') return getFlatPadding();
    if (variant === 'cascade') return getCascadePadding(colIndex);
    return getStaggeredPadding(colIndex, totalCols);
  };

  // --- END LOGIC ---

  const ProjectCard = ({ project, priority = false }: { project: ProjectData, priority?: boolean }) => (
    <Link 
      href={`/du-an/${project.slug}`}
      className="relative block overflow-hidden bg-gray-100 dark:bg-neutral-900 group mb-6 transition-all duration-300 hover:shadow-xl"
    >
      {project.isFeatured && (
        <div className="absolute top-3 right-3 z-20 bg-[var(--foreground)] text-[var(--background)] text-[10px] font-bold uppercase px-2 py-1 rounded shadow-sm">
          Nổi bật
        </div>
      )}
      <Image
        src={typeof project.image === 'string' ? project.image : project.image.src}
        alt={project.title}
        width={0} height={0} sizes="(max-width: 768px) 100vw, 33vw"
        className="w-full h-auto block transition-transform duration-700 group-hover:scale-105"
        unoptimized
        priority={priority}
      />
      <div className="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex flex-col justify-end p-6">
        <div className="transform translate-y-4 group-hover:translate-y-0 transition-transform duration-300">
          <span className="text-xs font-medium text-white/80 uppercase tracking-wider mb-2 block">{project.year}</span>
          <div className="flex justify-between items-center">
            <h3 className="text-xl font-bold text-white line-clamp-2">{project.title}</h3>
            <div className="bg-white/20 p-2 rounded-full backdrop-blur-sm shrink-0 ml-2"><ArrowUpRight className="text-white w-5 h-5" /></div>
          </div>
        </div>
      </div>
    </Link>
  );

  return (
    <div>
        {/* MOBILE (1 Cột - Luôn thẳng) */}
        <div className="block md:hidden space-y-6">
          {mobileProjects.map((p, index) => <ProjectCard key={p.id} project={p} priority={index < 2}/>)}
        </div>

        {/* TABLET (2 Cột) */}
        <div className="hidden md:grid lg:hidden grid-cols-2 gap-6 items-start">
          {tabletCols.map((colProjects, colIndex) => (
            <div key={colIndex} className={`flex flex-col ${getPaddingClass(colIndex, 2)}`}>
              {colProjects.map((p, index) => <ProjectCard key={p.id} project={p} priority={index === 0} />)}
            </div>
          ))}
        </div>

        {/* DESKTOP (3 Cột) */}
        <div className="hidden lg:grid grid-cols-3 gap-6 items-start">
          {desktopCols.map((colProjects, colIndex) => (
            <div key={colIndex} className={`flex flex-col ${getPaddingClass(colIndex, 3)}`}>
              {colProjects.map((p, index) => <ProjectCard key={p.id} project={p} priority={index === 0} />)}
            </div>
          ))}
        </div>
    </div>
  );
}
</file>

<file path="src/components/scroll-text-marque.tsx">
// src/components/ui/scroll-text-marque.tsx
'use client';

import React from 'react';
import {
  motion,
  useAnimationFrame,
  useMotionValue,
  useTransform,
  wrap,
} from 'framer-motion';
import { cn } from '@/lib/utils'; // Giả định bạn đã có file này

interface ScrollBaseAnimationProps {
  children: React.ReactNode;
  baseVelocity: number;
  className?: string;
  delay?: number; // Prop 'delay' từ ví dụ của bạn
}

export default function ScrollBaseAnimation({
  children,
  baseVelocity = 100, // Tốc độ mặc định
  className,
}: ScrollBaseAnimationProps) {
  // useMotionValue để lưu giá trị 'x'
  const baseX = useMotionValue(0);

  // useAnimationFrame là một vòng lặp (loop) được tối ưu hóa
  // Nó chạy liên tục, cập nhật giá trị 'x'
  useAnimationFrame((time, delta) => {
    // Tính toán quãng đường di chuyển dựa trên velocity
    // (delta là thời gian kể từ frame cuối, ~16ms)
    
    // SỬA LỖI: Đổi 'let' thành 'const' vì nó không bao giờ được gán lại
    const moveBy = baseVelocity * (delta / 1000);
    
    // 'wrap' là một hàm của Framer Motion giúp lặp lại giá trị
    // Khi 'x' đạt -50%, nó sẽ reset về 0, tạo vòng lặp vô tận
    baseX.set(wrap(0, -50, baseX.get() + moveBy));
  });

  // Chuyển giá trị số (ví dụ: -10) thành đơn vị CSS (ví dụ: "-10%")
  const x = useTransform(baseX, (v) => `${v}%`);

  return (
    // 'overflow-hidden' là bắt buộc để "cắt" phần text bị ẩn
    <div
      className="relative w-full overflow-hidden whitespace-nowrap"
    >
      {/* 'motion.div' sẽ di chuyển theo giá trị 'x' */}
      <motion.div
        className={cn('flex', className)} // Áp dụng className (font-bold, etc.) ở đây
        style={{ x }}
      >
        {/* Chúng ta lặp lại nội dung 4 lần để đảm bảo
          luôn lấp đầy màn hình, tạo hiệu ứng liền mạch
        */}
        <span className="inline-block mr-8">{children}</span>
        <span className="inline-block mr-8">{children}</span>
        <span className="inline-block mr-8">{children}</span>
        <span className="inline-block mr-8">{children}</span>
      </motion.div>
    </div>
  );
}
</file>

<file path="src/components/Spinner.tsx">
// src/components/Spinner.tsx

/**
 * Một component spinner đơn giản dùng Tailwind.
 */
export default function Spinner() {
  return (
    <div className="loader">
      <span className="sr-only">Đang tải...</span>
    </div>
  );
}
</file>

<file path="src/components/ui/ModalPortal.tsx">
// src/components/ui/ModalPortal.tsx
'use client';

import { useEffect, useState } from 'react';
import { createPortal } from 'react-dom';
import { X } from 'lucide-react';

interface ModalPortalProps {
  isOpen: boolean;
  onClose: () => void;
  children: React.ReactNode;
  title?: string;
  className?: string; // Để custom width tùy ý (sm, md, lg, xl)
}

export default function ModalPortal({ 
  isOpen, 
  onClose, 
  children, 
  title,
  className = "max-w-md" // Mặc định độ rộng
}: ModalPortalProps) {
  const [mounted, setMounted] = useState(false);

  useEffect(() => {
    setMounted(true);
    // Khóa cuộn trang khi mở Modal
    if (isOpen) {
      document.body.style.overflow = 'hidden';
    } else {
      document.body.style.overflow = 'unset';
    }
    return () => {
      document.body.style.overflow = 'unset';
    };
  }, [isOpen]);

  // Chỉ render khi đã mount client-side và isOpen = true
  if (!mounted || !isOpen) return null;

  // Dùng createPortal để đẩy Modal ra tận body
  return createPortal(
    <div className="fixed inset-0 z-[9999] flex items-center justify-center p-4 sm:p-6">
      
      {/* 1. Backdrop (Nền tối mờ toàn màn hình) */}
      <div 
        className="fixed inset-0 bg-black/70 backdrop-blur-sm transition-opacity animate-fade-in" 
        onClick={onClose}
      />

      {/* 2. Modal Container (Nổi lên trên cùng) */}
      <div className={`relative w-full ${className} bg-[var(--admin-card)] border border-[var(--admin-border)] rounded-2xl shadow-2xl flex flex-col overflow-hidden animate-zoom-in z-50`}>
        
        {/* Header (Nếu có title thì hiện, không thì thôi) */}
        {title && (
          <div className="flex items-center justify-between p-6 border-b border-[var(--admin-border)] bg-[var(--admin-bg)]/50">
            <h3 className="text-lg font-bold text-[var(--admin-fg)]">{title}</h3>
            <button 
              onClick={onClose}
              className="text-[var(--admin-sub)] hover:text-[var(--admin-fg)] p-2 hover:bg-[var(--admin-hover)] rounded-full transition-colors"
            >
              <X size={20} />
            </button>
          </div>
        )}

        {/* Nút đóng nhanh nếu không có header */}
        {!title && (
           <button 
            onClick={onClose}
            className="absolute top-4 right-4 p-2 text-[var(--admin-sub)] hover:text-[var(--admin-fg)] hover:bg-[var(--admin-hover)] rounded-full transition-colors z-10"
          >
            <X size={20} />
          </button>
        )}

        {/* Content */}
        <div>
          {children}
        </div>
      </div>
    </div>,
    document.body // Gắn vào body
  );
}
</file>

<file path="src/components/ui/SelectBox.tsx">
// src/components/ui/SelectBox.tsx
'use client';

import { useState, useRef, useEffect } from 'react';
import { ChevronDown, Check } from 'lucide-react';

interface Option {
  label: string;
  value: string | number;
}

interface SelectBoxProps {
  label?: string; // Label hiển thị bên trên (optional)
  value: string | number;
  onChange: (value: string) => void;
  options: Option[];
  placeholder?: string;
  required?: boolean;
  icon?: React.ReactNode; // Icon trang trí bên trái
  className?: string;
}

export default function SelectBox({
  label,
  value,
  onChange,
  options,
  placeholder = "Chọn một tùy chọn",
  required = false,
  icon,
  className = ""
}: SelectBoxProps) {
  const [isOpen, setIsOpen] = useState(false);
  const containerRef = useRef<HTMLDivElement>(null);

  // Tìm label của giá trị hiện tại
  const selectedLabel = options.find(opt => String(opt.value) === String(value))?.label;

  // Đóng khi click ra ngoài
  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      if (containerRef.current && !containerRef.current.contains(event.target as Node)) {
        setIsOpen(false);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, []);

  return (
    <div className={`space-y-2 ${className}`} ref={containerRef}>
      {label && (
        <label className="text-sm font-medium text-[var(--admin-fg)]">
          {label} {required && <span className="text-red-500">*</span>}
        </label>
      )}

      <div className="relative">
        {/* TRIGGER BUTTON */}
        <button
          type="button" // Quan trọng: type button để không submit form
          onClick={() => setIsOpen(!isOpen)}
          className={`
            w-full flex items-center justify-between px-4 py-3 rounded-lg border transition-all
            bg-[var(--admin-bg)] text-left
            ${isOpen 
              ? 'border-[var(--admin-primary)] ring-2 ring-[var(--admin-primary)]/20' 
              : 'border-[var(--admin-border)] hover:border-[var(--admin-sub)]'
            }
          `}
        >
          <div className="flex items-center gap-2 truncate text-[var(--admin-fg)]">
            {icon}
            <span className={selectedLabel ? "" : "text-[var(--admin-sub)]"}>
              {selectedLabel || placeholder}
            </span>
          </div>
          <ChevronDown 
            size={18} 
            className={`text-[var(--admin-sub)] transition-transform duration-200 ${isOpen ? 'rotate-180' : ''}`} 
          />
        </button>

        {/* DROPDOWN MENU */}
        {isOpen && (
          <div className="absolute top-full left-0 right-0 mt-2 bg-[var(--admin-card)] border border-[var(--admin-border)] rounded-xl shadow-xl z-50 animate-in fade-in zoom-in-95 duration-100 overflow-hidden max-h-60 overflow-y-auto">
            <div className="p-1.5">
              {options.length === 0 ? (
                <div className="p-3 text-center text-sm text-[var(--admin-sub)] italic">
                  Không có dữ liệu
                </div>
              ) : (
                options.map((opt) => {
                  const isActive = String(opt.value) === String(value);
                  return (
                    <button
                      key={opt.value}
                      type="button"
                      onClick={() => {
                        onChange(String(opt.value));
                        setIsOpen(false);
                      }}
                      className={`
                        w-full flex items-center justify-between px-3 py-2.5 rounded-lg text-sm transition-colors mb-0.5
                        ${isActive 
                          ? 'bg-[var(--admin-primary)]/10 text-[var(--admin-primary)] font-medium' 
                          : 'text-[var(--admin-fg)] hover:bg-[var(--admin-hover)]'
                        }
                      `}
                    >
                      <span>{opt.label}</span>
                      {isActive && <Check size={16} />}
                    </button>
                  );
                })
              )}
            </div>
          </div>
        )}
      </div>
    </div>
  );
}
</file>

<file path="src/context/CalendarContext.tsx">
'use client';

import React, { createContext, useContext, useState, ReactNode } from 'react';

interface CalendarContextType {
  date: Date;
  setDate: (date: Date) => void;
  visibleRoomIds: number[];
  setVisibleRoomIds: (ids: number[]) => void;
  toggleRoomVisibility: (roomId: number) => void;
  isCreateModalOpen: boolean;
  setCreateModalOpen: (isOpen: boolean) => void;
}

const CalendarContext = createContext<CalendarContextType | undefined>(undefined);

export function CalendarProvider({ children }: { children: ReactNode }) {
  const [date, setDate] = useState(new Date());
  // Mặc định là mảng rỗng (sẽ được component con check và fill all nếu rỗng lần đầu)
  const [visibleRoomIds, setVisibleRoomIds] = useState<number[]>([]); 
  const [isCreateModalOpen, setCreateModalOpen] = useState(false);

  const toggleRoomVisibility = (roomId: number) => {
    setVisibleRoomIds(prev => {
      if (prev.includes(roomId)) {
        return prev.filter(id => id !== roomId);
      } else {
        return [...prev, roomId];
      }
    });
  };

  return (
    <CalendarContext.Provider value={{
      date,
      setDate,
      visibleRoomIds,
      setVisibleRoomIds,
      toggleRoomVisibility,
      isCreateModalOpen,
      setCreateModalOpen,
    }}>
      {children}
    </CalendarContext.Provider>
  );
}

export function useCalendar() {
  const context = useContext(CalendarContext);
  if (context === undefined) {
    throw new Error('useCalendar must be used within a CalendarProvider');
  }
  return context;
}
</file>

<file path="src/data/bts.ts">
import type { StaticImageData } from 'next/image'; // Import kiểu này
import btsImage1 from '../assets/section_04/bts_01.jpg'; 
import btsImage2 from '../assets/section_04/bts_02.jpg'; 
import btsImage3 from '../assets/section_04/bts_03.jpg'; 
import btsImage4 from '../assets/section_04/bts_04.jpg'; 
import btsImage5 from '../assets/section_04/bts_05.jpg'; 
import btsImage6 from '../assets/section_04/bts_06.jpg'; 

export interface BTS {
  title: string;
  imageUrl: StaticImageData | string;
  description: string;
  client?: string; // client có thể không bắt buộc
  year?: string;
  location?: string;
}
const projects: BTS[] = 
[
{
    title: 'Sự Thức Tỉnh Của Vệ Nữ',
    imageUrl: btsImage1, 
    description: 'Đây là một concept "Vệ Nữ tái sinh" đầy tham vọng, thực hiện 100% trong studio. Thử thách lớn nhất là phải "thổi hồn" vào một bối cảnh hoàn toàn nhân tạo, kết hợp phông nền in khổ lớn với mô hình vỏ sò điêu khắc. Cái khó nhất là làm chủ chuyển động: một chiếc quạt công suất lớn (thấy ở tiền cảnh) được dùng liên tục để tạo hiệu ứng tóc và tà váy bay lượn. Ekip đã phải "đóng băng" khoảnh khắc đó, trong khi chuyên gia (như trong ảnh) liên tục tinh chỉnh từng chi tiết nhỏ để đạt độ hoàn hảo nhất.',
    client: 'Tạp chí Harper\'s Bazaar',
    year: '2024',
    location: 'Oni Studio, TP.HCM',
  },
  {
    title: 'Chuyển Động Tối Giản',
    imageUrl: btsImage2, 
    description: 'Concept là một bộ lookbook thời trang tối giản. Thử thách lớn nhất với phông nền xám trơn là làm sao để chủ thể và trang phục không bị "phẳng" hay nhàm chán. Ánh sáng chính là chìa khóa. Chúng tôi dùng một set-up 3 đèn: một key-light lớn (bên trái) để tạo khối, một fill-light nhẹ (bên phải, như trợ lý đang giữ) để làm mềm bóng đổ. Mấu chốt là một đèn rim-light (đèn viền) từ phía sau để tách người mẫu khỏi nền, làm nổi bật chi tiết lông vũ trên tay áo. Cả ekip đã làm việc liên tục để tìm ra những dáng pose sắc sảo nhất.',
    client: 'Zara Studio Lookbook',
    year: '2024',
    location: 'Oni Studio, TP.HCM',
  },
  {
    title: 'Chiến Binh Cơ Khí',
    imageUrl: btsImage3,
    description: 'Thử thách lớn nhất khi chụp sản phẩm cơ khí, đặc biệt là một chiếc Harley, là kiểm soát sự phản chiếu. Bề mặt chrome và sơn bóng loáng như một tấm gương. Chúng tôi phải di chuyển xe vào studio một cách cẩn thận và set up nhiều nguồn sáng khuếch tán lớn (như softbox trong ảnh) để "vẽ" nên những đường highlight mềm mại, làm nổi bật đường cong của xe mà không tạo ra các điểm cháy sáng gắt. Cả ekip đã phải tỉ mỉ xoay đèn từng chút một để đảm bảo mọi chi tiết từ động cơ đến ống xả đều hiện lên sắc nét.',
    client: 'Harley-Davidson Vietnam',
    year: '2023',
    location: 'Oni Studio, TP.HCM',
  },
  {
    title: 'Phỏng Vấn "High-Key"',
    imageUrl: btsImage4,
    description: 'Đây là một buổi quay phỏng vấn/ talkshow với set-up "high-key" (nền trắng sáng). Cái khó của kỹ thuật này là phải chiếu sáng phông nền trắng phía sau thật đều và cháy sáng hơn chủ thể, trong khi vẫn phải giữ chi tiết và ánh sáng đẹp trên nhân vật. Như trong ảnh, ekip đang tinh chỉnh nhiều nguồn sáng: một softbox (key-light) cho chủ thể và các đèn khác cho nền. Chúng tôi cũng sử dụng một máy tạo khói nhẹ (bên phải) để tạo không khí, giúp ánh sáng có chiều sâu hơn và không gian trắng không bị "bằng phẳng".',
    client: 'Chương trình "Insight" - VTV',
    year: '2023',
    location: 'Oni Studio, TP.HCM',
  },
  {
    title: 'Kỹ Thuật "Ghost Mannequin"',
    imageUrl: btsImage5,
    description: 'Đây là một buổi chụp sản phẩm e-commerce đòi hỏi kỹ thuật cao. Mục tiêu là làm chiếc áo "vô hình" người mặc để giữ nguyên phom dáng. Thử thách là phải treo sản phẩm bằng sợi cước siêu mỏng (như trong ảnh) và đảm bảo áo không bị xoay. Ánh sáng phải thật đều để thể hiện đúng chất liệu vải. Chúng tôi dùng một softbox parabol lớn (bên phải) làm đèn chính và một đèn phụ từ trên cao (gắn trên boom) để làm nổi bật chi tiết vai áo, giúp khâu hậu kỳ ghép ảnh (chụp trong, chụp ngoài) dễ dàng hơn.',
    client: 'Uniqlo Vietnam',
    year: '2023',
    location: 'Oni Studio, TP.HCM',
  },
  {
    title: 'Vẻ Đẹp Tinh Khiết',
    imageUrl: btsImage6,
    description: 'Chụp sản phẩm mỹ phẩm luôn là một thử thách về kiểm soát ánh sáng. Cái khó nhất là xử lý bề mặt chai lọ bóng, dễ bị phản chiếu lộn xộn. Chúng tôi đã phải tạo một "lều" ánh sáng mini (hộp trắng ở giữa) để bao bọc sản phẩm. Ánh sáng được set-up tỉ mỉ: một softbox lớn (bên trái) cho ánh sáng chính, một tấm hắt sáng vàng (bên phải) để tạo viền ấm áp cho sản phẩm, và một đèn top-light (trên cao) để làm nổi bật nắp chai. Cả ekip (như bạn thấy) đang theo dõi trực tiếp qua máy tính (tethering) để tinh chỉnh từng milimet.',
    client: 'Cỏ Mềm HomeLab',
    year: '2023',
    location: 'Oni Studio, TP.HCM',
  }
];

export default projects;
</file>

<file path="src/lib/actions/bookings.ts">
// src/lib/actions/bookings.ts
'use server'

import { createClient } from '@/lib/supabase/server'
import { revalidatePath } from 'next/cache'
import { getCleanupMinutes } from './settings' 

// --- 1. ĐỊNH NGHĨA CÁC INTERFACE CẦN THIẾT ---

// Interface cho việc check trùng (đã có)
interface BookingCollisionCheck {
  booking_item_id: number;
  booking_id: number;
  start_dt: string;
  end_dt: string;
  cleanup_minutes: number | null;
}

interface ActiveBookingResult {
  booking_id: number;
  bookings: {
    status: string | null;
  } | null;
}

// Interface CHUẨN cho dữ liệu trả về Calendar (FIX LỖI SelectQueryError)
export interface CalendarBookingItem {
  booking_item_id: number;
  start_dt: string;
  end_dt: string;
  room_id: number;
  cleanup_minutes?: number | null; // Cột mới thêm
  rooms: { 
    name: string | null; 
    code: string | null; 
  } | null;
  bookings: {
    booking_id: number;
    status: string | null;
    customer_id: number | null;
    customers: { 
      full_name: string | null; 
      phone: string | null; 
    } | null;
  } | null;
}

export interface BookingItemInput {
  roomId: number;
  startDt: string; 
  endDt: string;   
  price: number;   
}

export interface ServiceInput {
  serviceId: number;
  quantity: number;
  price: number;   
  type: 'service' | 'surcharge' | 'compensation';
}

export interface CreateBookingDTO {
  customerId: number; 
  staffId: number;    
  deposit: number;    
  discount: number;   
  discountReason?: string;
  notes?: string;
  items: BookingItemInput[]; 
  services?: ServiceInput[]; 
}

// ==============================================================================
// 1. KIỂM TRA PHÒNG TRỐNG (CHECK AVAILABILITY)
// ==============================================================================
export async function checkRoomAvailability(roomId: number, startStr: string, endStr: string) {
  const supabase = await createClient()
  const currentGap = await getCleanupMinutes();

  const { data: rawData, error } = await supabase
    .from('booking_items')
    .select('booking_item_id, booking_id, start_dt, end_dt, cleanup_minutes') 
    .eq('room_id', roomId)
    .filter('start_dt', 'lt', new Date(new Date(endStr).getTime() + 120 * 60000).toISOString()) 
    .filter('end_dt', 'gt', new Date(new Date(startStr).getTime() - 120 * 60000).toISOString())

  if (error) return { valid: false, error: error.message }

  const data = rawData as unknown as BookingCollisionCheck[];

  if (data && data.length > 0) {
    const itemIds = data.map(i => i.booking_item_id)
    
    const { data: rawActiveBookings } = await supabase
      .from('booking_items')
      .select('booking_id, bookings!inner(status)')
      .in('booking_item_id', itemIds)
      .in('bookings.status', ['pending', 'confirmed', 'checked_in'])
    
    const activeBookings = rawActiveBookings as unknown as ActiveBookingResult[];
    
    if (activeBookings && activeBookings.length > 0) {
      const isOverlap = data.some(existingItem => {
        const isActive = activeBookings.find(ab => ab.booking_id === existingItem.booking_id);
        if (!isActive) return false;

        const oldStart = new Date(existingItem.start_dt).getTime();
        const oldEnd = new Date(existingItem.end_dt).getTime();
        const oldGap = (existingItem.cleanup_minutes || 60) * 60000; 

        const newStart = new Date(startStr).getTime();
        const newEnd = new Date(endStr).getTime();
        const newGap = currentGap * 60000;

        const clash1 = (newStart < oldEnd + oldGap) && (newEnd > oldStart);
        const clash2 = (oldStart < newEnd + newGap) && (oldEnd > newStart);

        return clash1 || clash2;
      });

      if (isOverlap) {
        return { valid: false, error: `Phòng bị trùng lịch hoặc vi phạm thời gian dọn dẹp.` }
      }
    }
  }

  return { valid: true }
}

// ==============================================================================
// 2. TẠO BOOKING (TRANSACTION)
// ==============================================================================

export async function createBooking(payload: CreateBookingDTO) {
  const supabase = await createClient()
  const currentCleanupMinutes = await getCleanupMinutes();

  // --- BƯỚC 1: TẠO HEADER ---
  const { data: booking, error: bookingError } = await supabase
    .from('bookings')
    .insert({
      customer_id: payload.customerId,
      created_by: payload.staffId,
      status: 'confirmed', 
      deposit_amount: payload.deposit,
      deposit_paid: 0, 
      discount_amount: payload.discount,
      discount_reason: payload.discountReason,
      notes: payload.notes,
      vat_percent_snapshot: 8, 
      total_estimate: 0, 
      total_actual: 0
    })
    .select()
    .single()

  if (bookingError) return { success: false, error: 'Lỗi tạo đơn: ' + bookingError.message }
  
  // FIX: Thay thế 'any' bằng định nghĩa kiểu inline để tránh lỗi Linter
  const bookingId = (booking as { booking_id: number }).booking_id;

  // --- BƯỚC 2: TẠO ITEMS ---
  try {
    const itemsToInsert = payload.items.map(item => ({
      booking_id: bookingId,
      room_id: item.roomId,
      start_dt: item.startDt,
      end_dt: item.endDt,
      price_snapshot: item.price,
      cleanup_minutes: currentCleanupMinutes 
    }))

    const { error: itemsError } = await supabase
      .from('booking_items')
      .insert(itemsToInsert)

    if (itemsError) throw itemsError 

    // --- BƯỚC 3: TẠO SERVICES ---
    if (payload.services && payload.services.length > 0) {
      const servicesToInsert = payload.services.map(s => ({
        booking_id: bookingId,
        service_id: s.serviceId,
        quantity: s.quantity,
        type: s.type,
        unit_price_snapshot: s.price,
        computed_amount: s.quantity * s.price
      }))

      const { error: serviceError } = await supabase
        .from('booking_services')
        .insert(servicesToInsert)
      
      if (serviceError) throw serviceError
    }
    
    revalidatePath('/admin/bookings')
    revalidatePath('/admin/calendar')
    return { success: true, bookingId }

  } catch (error: unknown) {
    console.error("Booking Transaction Failed. Rolling back...", error)
    await supabase.from('bookings').delete().eq('booking_id', bookingId)
    
    const errMsg = error instanceof Error ? error.message : JSON.stringify(error);
    return { success: false, error: 'Đặt phòng thất bại: ' + errMsg }
  }
}

// ==============================================================================
// 3. LẤY DANH SÁCH BOOKING (CHO CALENDAR)
// ==============================================================================

export async function getBookingsForCalendar(startStr: string, endStr: string) {
  const supabase = await createClient()

  const { data, error } = await supabase
    .from('booking_items')
    .select(`
      *,
      cleanup_minutes, 
      rooms ( name, code ),
      bookings ( 
        status, 
        customer_id, 
        customers ( full_name, phone )
      )
    `)
    .lt('start_dt', endStr)
    .gt('end_dt', startStr)
    .not('bookings.status', 'eq', 'cancelled')

  if (error) {
    console.error("Error fetching calendar bookings:", error);
    return [];
  }

  // FIX LỖI TypeScript: Ép kiểu 'data' (đang bị Supabase hiểu là lỗi) về Interface chuẩn
  // Kỹ thuật "Double Casting": (data as unknown) -> as CalendarBookingItem[]
  return (data as unknown) as CalendarBookingItem[];
}


// Hàm update thời gian & phòng khi kéo thả
export async function updateBookingTime(
  bookingItemId: number, 
  newStart: string, 
  newEnd: string, 
  newRoomId: number
) {
  const supabase = await createClient();

  const { error } = await supabase
    .from('booking_items')
    .update({
      start_dt: newStart,
      end_dt: newEnd,
      room_id: newRoomId
    })
    .eq('booking_item_id', bookingItemId);

  if (error) return { success: false, error: error.message };
  
  revalidatePath('/admin'); 
  return { success: true };
}
</file>

<file path="src/lib/actions/customers.ts">
'use server'

import { createClient } from '@/lib/supabase/server'
import { revalidatePath } from 'next/cache'
import { Database } from '@/types/supabase'

export type CustomerRow = Database['public']['Tables']['customers']['Row']

// ==============================================================================
// 1. LẤY DANH SÁCH & TÌM KIẾM
// ==============================================================================

export async function getCustomers(query: string = '', limit: number = 20) {
  const supabase = await createClient()

  let dbQuery = supabase
    .from('customers')
    .select('*')
    .eq('is_active', true)
    .order('created_at', { ascending: false })
    .limit(limit)

  // Tìm kiếm theo Tên hoặc SĐT
  if (query) {
    dbQuery = dbQuery.or(`full_name.ilike.%${query}%,phone.ilike.%${query}%`)
  }

  const { data, error } = await dbQuery

  if (error) {
    console.error('Error fetching customers:', error)
    return []
  }
  return data
}

export async function getCustomerById(id: number) {
  const supabase = await createClient()
  
  const { data, error } = await supabase
    .from('customers')
    .select('*')
    .eq('customer_id', id)
    .single()

  if (error) return null
  return data
}

// ==============================================================================
// 2. TẠO & CẬP NHẬT
// ==============================================================================

export async function createCustomer(formData: FormData) {
  const supabase = await createClient()

  const rawData = {
    full_name: formData.get('full_name') as string,
    phone: formData.get('phone') as string,
    email: formData.get('email') as string || null,
    cccd: formData.get('cccd') as string || null,
    company_name: formData.get('company_name') as string || null,
    tax_code: formData.get('tax_code') as string || null,
    address: formData.get('address') as string || null,
    customer_type: formData.get('customer_type') as 'regular' | 'vip' | 'corporate' || 'regular',
    discount_rate: Number(formData.get('discount_rate') || 0),
    note: formData.get('note') as string || null
  }

  const { data, error } = await supabase
    .from('customers')
    .insert(rawData)
    .select()
    .single()

  if (error) {
    // Xử lý lỗi trùng SĐT thân thiện hơn
    if (error.code === '23505') { // Mã lỗi Unique Violation của Postgres
      return { success: false, error: 'Số điện thoại này đã tồn tại trong hệ thống.' }
    }
    return { success: false, error: error.message }
  }

  revalidatePath('/admin/customers')
  return { success: true, data }
}

export async function updateCustomer(customerId: number, formData: FormData) {
  const supabase = await createClient()

  const rawData = {
    full_name: formData.get('full_name') as string,
    phone: formData.get('phone') as string,
    email: formData.get('email') as string,
    cccd: formData.get('cccd') as string,
    company_name: formData.get('company_name') as string,
    tax_code: formData.get('tax_code') as string,
    address: formData.get('address') as string,
    customer_type: formData.get('customer_type') as 'regular' | 'vip' | 'corporate',
    discount_rate: Number(formData.get('discount_rate') || 0),
    note: formData.get('note') as string
  }

  const { error } = await supabase
    .from('customers')
    .update(rawData)
    .eq('customer_id', customerId)

  if (error) return { success: false, error: error.message }

  revalidatePath('/admin/customers')
  return { success: true }
}

// ==============================================================================
// 3. LỊCH SỬ GIAO DỊCH (CRM)
// ==============================================================================

export async function getCustomerHistory(customerId: number) {
  const supabase = await createClient()
  
  // Lấy danh sách booking của khách này
  const { data, error } = await supabase
    .from('bookings')
    .select(`
      *,
      users (full_name) 
    `)
    .eq('customer_id', customerId)
    .order('created_at', { ascending: false })

  if (error) return []
  return data
}
</file>

<file path="src/lib/actions/project.ts">

</file>

<file path="src/lib/actions/settings.ts">
// src/lib/actions/settings.ts
'use server'

import { createClient } from '@/lib/supabase/server'
import { revalidatePath } from 'next/cache'

export interface SettingItem {
  key: string;
  value: string;
  description?: string;
}

// 1. Lấy danh sách Settings
export async function getSettings() {
  const supabase = await createClient();
  try {
    const { data, error } = await supabase
      .from('settings')
      .select('*')
      .order('key');

    if (error) throw error;
    return data as SettingItem[];
  } catch (error: unknown) {
    console.error("Error fetching settings:", error);
    return [];
  }
}

// 2. Lấy giá trị Setting Cleanup
export async function getCleanupMinutes() {
  const supabase = await createClient()
  
  const { data, error } = await supabase
    .from('settings')
    .select('value')
    .eq('key', 'CLEANUP_GAP_MINUTES')
    .single()

  if (error || !data) return 60; 
  return Number(data.value) || 60;
}

// 3. Cập nhật Setting Cleanup
export async function updateCleanupMinutes(minutes: number) {
  const supabase = await createClient()

  const { error } = await supabase
    .from('settings')
    .upsert({
      key: 'CLEANUP_GAP_MINUTES',
      value: minutes.toString(),
      description: 'Thời gian dọn dẹp (phút)',
      updated_at: new Date().toISOString()
    })

  if (error) return { success: false, error: error.message }

  revalidatePath('/admin/settings')
  return { success: true }
}

// 4. Cập nhật Nhiều Settings (Được chuyển từ actions.ts sang & tối ưu hóa)
export async function updateSettings(updates: { key: string; value: string }[]) {
  const supabase = await createClient();

  // 1. Check quyền Admin (Giữ nguyên logic cũ)
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) return { success: false, error: 'Unauthorized' };

  const { data: profile } = await supabase
    .from('users')
    .select('role')
    .eq('auth_id', user.id)
    .single();

  if (profile?.role !== 'Admin') {
    return { success: false, error: 'Forbidden' };
  }

  // 2. THAY ĐỔI: Dùng upsert thay vì update
  try {
    const promises = updates.map(item => 
      supabase
        .from('settings')
        .upsert({ 
          key: item.key, // upsert cần key để biết dòng nào cần sửa
          value: item.value,
          description: item.key === 'CLEANUP_GAP_MINUTES' ? 'Thời gian dọn dẹp (phút)' : undefined, // Optional: giữ description không bị null nếu tạo mới
          updated_at: new Date().toISOString()
        }, { onConflict: 'key' }) // Quan trọng: xác định trùng lặp dựa trên cột 'key'
    );

    const results = await Promise.all(promises);

    // Kiểm tra xem có lệnh nào bị lỗi không
    const errors = results.filter(r => r.error).map(r => r.error?.message);
    if (errors.length > 0) {
        throw new Error(errors.join(', '));
    }

    revalidatePath('/', 'layout'); 
    return { success: true };
  } catch (error: unknown) {
    let message = 'Lỗi không xác định';
    if (error instanceof Error) message = error.message;
    else if (typeof error === 'string') message = error;
    
    return { success: false, error: message };
  }
}
</file>

<file path="src/lib/actions/stats.ts">
// src/lib/actions/stats.ts
'use server'

import { createClient } from '@/lib/supabase/server'

// Định nghĩa Type chung cho Chart
export interface MonthlyStat {
  name: string;
  total: number;
}
interface ChartSourceItem {
  start_dt?: string;    // Có khi query bảng bookings
  created_at?: string;  // Có khi query bảng projects
}
// Helper tính ngày bắt đầu
function getStartDate(range: string) {
  const now = new Date();
  // Reset giờ để tính chính xác mốc 00:00
  now.setHours(0, 0, 0, 0); 
  
  if (range === 'today') {
    return now;
  }
  if (range === '7d') {
    const d = new Date(now);
    d.setDate(d.getDate() - 7);
    return d;
  }
  if (range === '30d') {
    const d = new Date(now);
    d.setDate(d.getDate() - 30);
    return d;
  }
  if (range === '90d') {
    const d = new Date(now);
    d.setDate(d.getDate() - 90);
    return d;
  }
  if (range === '12m') {
    const d = new Date(now);
    d.setFullYear(d.getFullYear() - 1);
    return d;
  }
  return new Date(0); // All time
}

export async function getDashboardStats(range: string = '30d') {
  const supabase = await createClient();
  try {
    const startDate = getStartDate(range).toISOString();
    
    // Range cho "Hôm nay"
    const todayStart = new Date();
    todayStart.setHours(0, 0, 0, 0);
    const todayEnd = new Date();
    todayEnd.setHours(23, 59, 59, 999);

    const { count: totalProjects } = await supabase.from('projects').select('*', { count: 'exact', head: true });
    
    const { count: newProjects } = await supabase
      .from('projects')
      .select('*', { count: 'exact', head: true })
      .gte('created_at', startDate);

    const { count: totalStaff } = await supabase.from('users').select('*', { count: 'exact', head: true });

    const { count: todayBookings } = await supabase
      .from('booking_items')
      .select('*', { count: 'exact', head: true })
      .gte('start_dt', todayStart.toISOString())
      .lte('start_dt', todayEnd.toISOString());

    return {
      totalProjects: totalProjects || 0,
      newProjects: newProjects || 0,
      totalStaff: totalStaff || 0,
      todayBookings: todayBookings || 0
    };
  } catch (error) {
    console.error("Lỗi dashboard stats:", error);
    return { totalProjects: 0, newProjects: 0, totalStaff: 0, todayBookings: 0 };
  }
}

export async function getTodaySchedule() {
  const supabase = await createClient();
  try {
    const todayStart = new Date();
    todayStart.setHours(0, 0, 0, 0);
    const todayEnd = new Date();
    todayEnd.setHours(23, 59, 59, 999);

    const { data, error } = await supabase
      .from('booking_items')
      .select(`
        booking_item_id,
        start_dt,
        end_dt,
        rooms ( name, code ),
        bookings ( 
          status,
          customers ( full_name, phone )
        )
      `)
      .gte('start_dt', todayStart.toISOString())
      .lte('start_dt', todayEnd.toISOString())
      .order('start_dt', { ascending: true });

    if (error) throw error;
    return data || [];
  } catch (error) {
    console.error("Lỗi lấy lịch hôm nay:", error);
    return [];
  }
}

// --- HÀM NÀY ĐÃ ĐƯỢC CẬP NHẬT ---
export async function getGrowthChartData(range: string = '30d', type: 'bookings' | 'projects' = 'bookings') {
    const supabase = await createClient();
    try {
        const startDate = getStartDate(range);
        let query;

        if (type === 'bookings') {
            query = supabase
                .from('booking_items')
                .select('start_dt')
                .gte('start_dt', startDate.toISOString())
                .order('start_dt', { ascending: true });
        } else {
            query = supabase
                .from('projects')
                .select('created_at')
                .gte('created_at', startDate.toISOString())
                .order('created_at', { ascending: true });
        }

        const { data, error } = await query;

        if (error || !data) {
            return [];
        }

        // 2. ÉP KIỂU TƯỜNG MINH (FIX LỖI ANY)
        // Chúng ta cho TS biết 'data' này chắc chắn là mảng các object có start_dt hoặc created_at
        const typedData = data as unknown as ChartSourceItem[];

        const isDaily = range === '7d' || range === '30d' || range === 'today';
        const statsMap = new Map<string, number>();

        // Giờ 'item' sẽ có kiểu ChartSourceItem, không còn là any
        typedData.forEach((item) => {
            const dateVal = type === 'bookings' ? item.start_dt : item.created_at;
            
            if (!dateVal) return;
            
            const date = new Date(dateVal);
            let key = '';

            if (isDaily) {
                key = `${date.getDate()}/${date.getMonth() + 1}`;
            } else {
                key = `T${date.getMonth() + 1}`;
            }
            
            statsMap.set(key, (statsMap.get(key) || 0) + 1);
        });

        return Array.from(statsMap, ([name, total]) => ({ name, total }));
    } catch (error) {
        console.error("Lỗi lấy thống kê biểu đồ:", error);
        return [];
    }
}
</file>

<file path="src/lib/actions/studio.ts">
'use server'

import { createClient } from '@/lib/supabase/server'
import { revalidatePath } from 'next/cache'
import { Database } from '@/types/supabase'

// Định nghĩa lại các Type trả về cho UI dễ dùng
// Kỹ thuật: Lấy Type dòng (Row) từ Database và mở rộng thêm quan hệ
export type RoomWithBranch = Database['public']['Tables']['rooms']['Row'] & {
  branches: { name: string; branch_code: string } | null
}

export interface ServiceItem {
  service_id: number;
  name: string;
  price: number;
  unit: string | null;
  is_active: boolean | null;
  type: 'service' | 'surcharge' | 'compensation';
  // --- THÊM DÒNG NÀY ---
  // Định nghĩa category khớp với các Tab bạn đang dùng
  category?: 'equipment' | 'fnb' | 'surcharge' | string; 
}

// ==============================================================================
// 1. CHI NHÁNH (BRANCHES)
// ==============================================================================

export async function getBranches() {
  const supabase = await createClient()
  const { data, error } = await supabase
    .from('branches')
    .select('*')
    .eq('is_active', true)
    .order('created_at')

  if (error) {
    console.error('Error fetching branches:', error)
    return []
  }
  return data
}

// ==============================================================================
// 2. PHÒNG (ROOMS)
// ==============================================================================

export async function getRooms(): Promise<RoomWithBranch[]> {
  const supabase = await createClient()
  
  // Lấy phòng kèm thông tin chi nhánh (Join bảng)
  const { data, error } = await supabase
    .from('rooms')
    .select(`
      *,
      branches (
        name,
        branch_code
      )
    `)
    .order('branch_id')
    .order('code')

  if (error) {
    console.error('Error fetching rooms:', error)
    return []
  }
  
  // Ép kiểu về RoomWithBranch để TypeScript hiểu cấu trúc Join
  return data as unknown as RoomWithBranch[]
}

export async function createRoom(formData: FormData) {
  const supabase = await createClient()

  // Lấy dữ liệu từ Form
  // Lưu ý: DB v2 đã bỏ cột cleanup_minutes, dùng Global Setting nên không cần gửi lên
  const rawData = {
    branch_id: Number(formData.get('branch_id')),
    code: formData.get('code') as string,
    name: formData.get('name') as string,
    capacity: Number(formData.get('capacity') || 0),
    is_rentable: formData.get('is_rentable') === 'on',
    is_equipment_room: formData.get('is_equipment_room') === 'on',
    status: 'available' as const // ENUM: available | maintenance | inactive
  }

  const { error } = await supabase.from('rooms').insert(rawData)

  if (error) {
    return { success: false, error: error.message }
  }

  revalidatePath('/admin/rooms')
  return { success: true }
}

export async function toggleRoomStatus(roomId: number, currentStatus: string) {
  const supabase = await createClient()
  
  // Logic đơn giản: switch giữa available <-> maintenance
  const newStatus = currentStatus === 'available' ? 'maintenance' : 'available'

  const { error } = await supabase
    .from('rooms')
    .update({ status: newStatus as 'available' | 'maintenance' | 'inactive' })
    .eq('room_id', roomId)

  if (error) return { success: false, error: error.message }
  
  revalidatePath('/admin/rooms')
  return { success: true }
}

// ==============================================================================
// 3. DỊCH VỤ & PHỤ THU (SERVICES)
// ==============================================================================

export async function getServices() {
  const supabase = await createClient()
  
  const { data, error } = await supabase
    .from('services')
    .select('*')
    .eq('is_active', true)
    .order('type') // Gom nhóm theo: service, surcharge, compensation
    .order('name')

  if (error) return []
  return data
}

export async function createService(formData: FormData) {
  const supabase = await createClient()

  const rawData = {
    name: formData.get('name') as string,
    price: Number(formData.get('price')),
    // Ép kiểu ENUM service_type
    type: formData.get('type') as 'service' | 'surcharge' | 'compensation',
    unit: formData.get('unit') as string || 'item'
  }

  const { error } = await supabase.from('services').insert(rawData)

  if (error) return { success: false, error: error.message }

  revalidatePath('/admin/services')
  return { success: true }
}

export async function deleteService(serviceId: number) {
    const supabase = await createClient()
    
    // Soft delete: Chỉ tắt active chứ không xóa vĩnh viễn để giữ lịch sử booking
    const { error } = await supabase
      .from('services')
      .update({ is_active: false })
      .eq('service_id', serviceId)
  
    if (error) return { success: false, error: error.message }
  
    revalidatePath('/admin/services')
    return { success: true }
}
</file>

<file path="src/lib/actions/users.ts">
'use server'

import { createClient } from '@/lib/supabase/server'
import { revalidatePath } from 'next/cache'
import { createClient as createSupabaseClient } from '@supabase/supabase-js' // Chỉ dùng cho Service Role

export interface UserProfile {
  user_id: number;
  email: string;
  full_name: string;
  role: 'Admin' | 'Staff';
}

export interface StaffUser extends UserProfile {
  is_active: boolean;
  created_at: string;
  auth_id: string;
}

async function requireAdmin() {
  const supabase = await createClient(); // Sử dụng client từ @supabase/ssr

  // 1. Lấy User từ Session (Tự động đọc Cookie)
  const { data: { user }, error } = await supabase.auth.getUser();
  
  if (error || !user) {
    throw new Error("Unauthorized: Bạn chưa đăng nhập.");
  }

  // 2. Check Role trong DB
  const { data: profile } = await supabase
    .from('users')
    .select('role')
    .eq('auth_id', user.id)
    .single();

  if (profile?.role !== 'Admin') {
    throw new Error("Forbidden: Chỉ Admin mới có quyền này.");
  }

  // (Optional) Trả về user hiện tại để hàm gọi dùng tiếp đỡ phải query lại
  return user;
}


// 1. Lấy thông tin user hiện tại
export async function getCurrentUserProfile(): Promise<UserProfile | null> {
  const supabase = await createClient();

  try {
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) return null;

    const { data: profile } = await supabase
      .from('users')
      .select('user_id, email, full_name, role')
      .eq('auth_id', user.id)
      .single();

    return profile as UserProfile;
  } catch (error) {
    console.error("Lỗi thông tin người dùng hiện tại:", error);
    return null;
  }
}

// 2. Lấy danh sách nhân viên
export async function getStaffList() {
  const supabase = await createClient();
  try {
    const { data, error } = await supabase
      .from('users')
      .select('*')
      .order('created_at', { ascending: false });

    if (error) throw error;
    return data as StaffUser[];
  } catch (error) {
    console.error("Error fetching staff:", error);
    return [];
  }
}

// 3. Khóa/Mở khóa tài khoản
export async function toggleStaffStatus(userId: number, currentStatus: boolean) {
  try {
    // 1. Check quyền (Không cần truyền token nữa)
    const currentUser = await requireAdmin(); 

    // 2. Tạo client để thực hiện update
    const supabase = await createClient(); //

    // 3. Logic nghiệp vụ (Giữ nguyên logic cũ của bạn)
    // Lấy thông tin người bị khóa (Target) để check không tự khóa mình
    const { data: targetUser } = await supabase
      .from('users')
      .select('auth_id')
      .eq('user_id', userId)
      .single();

    if (targetUser && currentUser.id === targetUser.auth_id) {
      throw new Error("Bạn không thể tự khóa tài khoản của chính mình.");
    }

    const { error } = await supabase
      .from('users')
      .update({ is_active: !currentStatus })
      .eq('user_id', userId);

    if (error) throw error;
    
    // Revalidate nếu cần (nhớ import revalidatePath)
    // revalidatePath('/admin/staff');

    return { success: true };
  } catch (error: unknown) {
    console.error("Toggle staff error:", error);
    return { success: false, error: error instanceof Error ? error.message : 'Lỗi hệ thống' };
  }
}

// 4. Tạo tài khoản nhân viên (Dùng Service Role)
export async function createStaffAccount(data: { email: string; password: string; fullName: string; role: string }) {
  // Service Role Key cần thiết để tạo user trong Auth mà không cần confirm email thủ công
  const serviceKey = process.env.SUPABASE_SERVICE_ROLE_KEY;
  const projectUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;

  if (!serviceKey || !projectUrl) {
    return { success: false, error: "Server chưa cấu hình Service Role Key" };
  }

  try {
    // Tạo Client quyền Admin
    const supabaseAdmin = createSupabaseClient(projectUrl, serviceKey, {
      auth: { autoRefreshToken: false, persistSession: false }
    });

    // Tạo User bên Auth
    const { data: authData, error: authError } = await supabaseAdmin.auth.admin.createUser({
      email: data.email,
      password: data.password,
      email_confirm: true,
      user_metadata: { full_name: data.fullName }
    });

    if (authError) throw authError;
    if (!authData.user) throw new Error("Không tạo được Auth User");

    // Lưu vào bảng public.users
    const { error: dbError } = await supabaseAdmin
      .from('users')
      .insert({
        email: data.email,
        username: data.email, 
        full_name: data.fullName,
        role: data.role,
        auth_id: authData.user.id,
        is_active: true
      });

    if (dbError) {
      await supabaseAdmin.auth.admin.deleteUser(authData.user.id); // Rollback
      throw dbError;
    }

    revalidatePath('/admin/staff');
    return { success: true };

  } catch (error: unknown) {
    
    // Xử lý type safe
    let message = 'Lỗi không xác định';
    
    if (error instanceof Error) {
      message = error.message; // Lấy message từ Error object
    } else if (typeof error === 'string') {
      message = error; // Nếu throw "chuỗi"
    }

    // Trả về string cho Client hiển thị
    return { success: false, error: message };
  }
}
</file>

<file path="src/lib/image-utils.ts">
// src/lib/image-utils.ts

/**
 * Nén và Resize ảnh trước khi upload
 * @param file File ảnh gốc
 * @param maxWidth Chiều rộng tối đa (mặc định 1920px)
 * @param quality Chất lượng nén (0 - 1, mặc định 0.8)
 */
export const compressImage = async (
  file: File, 
  maxWidth = 1920, 
  quality = 0.8
): Promise<Blob> => {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.readAsDataURL(file);
    
    reader.onload = (event) => {
      const img = new Image();
      img.src = event.target?.result as string;
      
      img.onload = () => {
        // Tính toán kích thước mới giữ nguyên tỷ lệ
        let width = img.width;
        let height = img.height;
        
        if (width > maxWidth) {
          height = Math.round((height * maxWidth) / width);
          width = maxWidth;
        }

        // Vẽ lên Canvas để resize
        const canvas = document.createElement('canvas');
        canvas.width = width;
        canvas.height = height;
        
        const ctx = canvas.getContext('2d');
        if (!ctx) {
          reject(new Error('Không thể tạo context canvas'));
          return;
        }
        
        ctx.drawImage(img, 0, 0, width, height);
        
        // Xuất ra Blob dạng WebP
        canvas.toBlob(
          (blob) => {
            if (blob) {
              resolve(blob);
            } else {
              reject(new Error('Lỗi nén ảnh'));
            }
          },
          'image/webp',
          quality
        );
      };
      
      img.onerror = (err) => reject(err);
    };
    
    reader.onerror = (err) => reject(err);
  });
};
</file>

<file path="src/lib/supabase/client.ts">
import { createBrowserClient } from '@supabase/ssr'
import { Database } from '@/types/supabase'

export function createClient() {
  return createBrowserClient<Database>(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
  )
}
</file>

<file path="src/lib/supabase/server.ts">
import { createServerClient } from '@supabase/ssr'
import { cookies } from 'next/headers'
import { Database } from '@/types/supabase'

export async function createClient() {
  const cookieStore = await cookies()

  return createServerClient<Database>(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        getAll() {
          return cookieStore.getAll()
        },
        setAll(cookiesToSet) {
          try {
            cookiesToSet.forEach(({ name, value, options }) =>
              cookieStore.set(name, value, options)
            )
          } catch {
            // The `setAll` method was called from a Server Component.
            // This can be ignored if you have middleware refreshing
            // user sessions.
          }
        },
      },
    }
  )
}
</file>

<file path="src/lib/utils.ts">
// src/lib/utils.ts
import { type ClassValue, clsx } from "clsx"
import { twMerge } from "tailwind-merge"
import { differenceInMinutes } from 'date-fns';

export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs))
}

// Hàm format tiền tệ cho gọn
export const fmtMoney = (amount: number) => {
  return new Intl.NumberFormat('vi-VN').format(amount) + ' VNĐ';
};

export const formatDuration = (minutes: number) => {
    const h = Math.floor(minutes / 60);
    const m = minutes % 60;
    
    if (h > 0) {
        return `${h}h${m > 0 ? `${m}p` : ''}`; // Ví dụ: 2h39p hoặc 2h
    }
    return `${m}p`; // Ví dụ: 45p
};
export const calculateBilling = (
    bookedStart: Date,
    bookedEnd: Date,
    actualIn: Date | null,
    actualOut: Date | null,
    pricePerHour: number,
    settings: { earlyGrace: number; otFree: number }
) => {
    let totalSurcharge = 0;

    const earlyFee = {
        isBillable: false,
        minutes: 0,
        billableHours: 0,
        amount: 0,
        message: ''
    };

    const otFee = {
        isBillable: false,
        minutes: 0,
        billableHours: 0,
        amount: 0,
        message: ''
    };

    // 1. Logic Check-in Sớm
    if (actualIn) {
        const earlyMinutes = differenceInMinutes(bookedStart, actualIn);
        earlyFee.minutes = earlyMinutes;

        if (earlyMinutes > settings.earlyGrace) {
            // Logic: Làm tròn lên mỗi 15p
            const billableMinutes = Math.ceil(earlyMinutes / 15) * 15;
            const billableHours = billableMinutes / 60;
            
            earlyFee.isBillable = true;
            earlyFee.billableHours = billableHours;
            earlyFee.amount = billableHours * pricePerHour;
            
            // SỬ DỤNG formatDuration để hiển thị
            earlyFee.message = `Sớm ${formatDuration(earlyMinutes)} (Tính ${billableHours}h)`;
            
            totalSurcharge += earlyFee.amount;
        }
    }

    // 2. Logic OT (Check-out Trễ)
    const checkOutTime = actualOut || new Date(); 
    if (checkOutTime > bookedEnd) {
        const otMinutes = differenceInMinutes(checkOutTime, bookedEnd);
        otFee.minutes = otMinutes;

        if (otMinutes > settings.otFree) {
            // Logic: Tính tròn giờ (làm tròn xuống)
            const otHours = Math.floor(otMinutes / 60);
            
            if (otHours > 0) {
                otFee.isBillable = true;
                otFee.billableHours = otHours;
                otFee.amount = otHours * pricePerHour;

                // SỬ DỤNG formatDuration để hiển thị
                otFee.message = `Trễ ${formatDuration(otMinutes)} (Tính ${otHours}h)`;
                
                totalSurcharge += otFee.amount;
            }
        }
    }

    return { 
        totalSurcharge, 
        earlyFee, 
        otFee 
    };
};
</file>

<file path="src/middleware.ts">
// src/middleware.ts
import { createServerClient } from '@supabase/ssr';
import { NextResponse, type NextRequest } from 'next/server';

export async function middleware(request: NextRequest) {
  // 1. Khởi tạo Response
  let response = NextResponse.next({
    request: {
      headers: request.headers,
    },
  });

  // 2. Khởi tạo Supabase Client cho Middleware
  // Logic này giúp đọc/ghi cookie phiên đăng nhập một cách an toàn trên Server
  const supabase = createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        getAll() {
          return request.cookies.getAll();
        },
        setAll(cookiesToSet) {
          cookiesToSet.forEach(({ name, value }) =>
            request.cookies.set(name, value)
          );
          response = NextResponse.next({
            request,
          });
          cookiesToSet.forEach(({ name, value, options }) =>
            response.cookies.set(name, value, options)
          );
        },
      },
    }
  );

  // 3. Kiểm tra User (Quan trọng: dùng getUser thay vì getSession để bảo mật hơn)
  // getUser sẽ xác thực lại với Auth Server xem token còn sống không
  const {
    data: { user },
  } = await supabase.auth.getUser();

  const url = request.nextUrl.clone();

  // --- QUY TẮC BẢO MẬT ---

  // TRƯỜNG HỢP 1: Đang cố vào trang Admin (/admin/*)
  if (url.pathname.startsWith('/admin')) {
    // Nếu chưa đăng nhập -> Đá về trang Login
    if (!user) {
      url.pathname = '/login';
      // Lưu lại trang họ định vào để sau khi login xong thì redirect lại đó (Optional)
      url.searchParams.set('next', request.nextUrl.pathname);
      return NextResponse.redirect(url);
    }
    
    // (Tùy chọn) Nếu bạn có phân quyền (VD: user thường vs admin)
    // Thì check thêm role ở đây. Nếu chỉ có 1 admin là bạn thì không cần.
  }

  // TRƯỜNG HỢP 2: Đang cố vào trang Login (/login)
  if (url.pathname === '/login') {
    // Nếu ĐÃ đăng nhập rồi -> Không cho vào login nữa, đá thẳng vào Admin
    if (user) {
      url.pathname = '/admin'; 
      return NextResponse.redirect(url);
    }
  }

  // Nếu hợp lệ, cho đi tiếp
  return response;
}

// Cấu hình để Middleware chỉ chạy trên các route cần thiết
// Giúp tối ưu hiệu năng, không chạy trên file ảnh, static file...
export const config = {
  matcher: [
    /*
     * Match tất cả request paths ngoại trừ:
     * - _next/static (static files)
     * - _next/image (image optimization files)
     * - favicon.ico (favicon file)
     * - images (public images)
     * - public folder
     */
    '/((?!_next/static|_next/image|favicon.ico|.*\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)',
  ],
};
</file>

<file path="src/types/grid-project.ts">
// src/types/grid-project.ts
import { StaticImageData } from 'next/image';

/**
 * Đây là cấu trúc dữ liệu mà PortfolioGrid sẽ nhận.
 * Nó bao gồm cả dữ liệu hiển thị (title, src)
 * và dữ liệu layout (colSpan, rowSpan)
 * và dữ liệu hành vi (slug).
 */
export interface GridProject {
  id: number | string;
  src: StaticImageData | string;
  title: string;
  category: string;
  
  // Dành cho layout
  colSpan: string;
  rowSpan: string;
  
  // Dành cho link chi tiết
  slug: string; 
}
</file>

<file path="src/types/supabase.ts">
export type Json =
  | string
  | number
  | boolean
  | null
  | { [key: string]: Json | undefined }
  | Json[]

export type Database = {
  // Allows to automatically instantiate createClient with right options
  // instead of createClient<Database, { PostgrestVersion: 'XX' }>(URL, KEY)
  __InternalSupabase: {
    PostgrestVersion: "14.1"
  }
  public: {
    Tables: {
      booking_items: {
        Row: {
          booking_id: number
          booking_item_id: number
          cleanup_minutes: number | null
          created_at: string | null
          end_dt: string
          is_all_day: boolean | null
          price_snapshot: number | null
          room_id: number
          start_dt: string
        }
        Insert: {
          booking_id: number
          booking_item_id?: number
          cleanup_minutes?: number | null
          created_at?: string | null
          end_dt: string
          is_all_day?: boolean | null
          price_snapshot?: number | null
          room_id: number
          start_dt: string
        }
        Update: {
          booking_id?: number
          booking_item_id?: number
          cleanup_minutes?: number | null
          created_at?: string | null
          end_dt?: string
          is_all_day?: boolean | null
          price_snapshot?: number | null
          room_id?: number
          start_dt?: string
        }
        Relationships: [
          {
            foreignKeyName: "booking_items_booking_id_fkey"
            columns: ["booking_id"]
            isOneToOne: false
            referencedRelation: "bookings"
            referencedColumns: ["booking_id"]
          },
          {
            foreignKeyName: "booking_items_room_id_fkey"
            columns: ["room_id"]
            isOneToOne: false
            referencedRelation: "rooms"
            referencedColumns: ["room_id"]
          },
        ]
      }
      booking_services: {
        Row: {
          booking_id: number
          booking_service_id: number
          computed_amount: number | null
          created_at: string | null
          quantity: number
          service_id: number
          type: Database["public"]["Enums"]["service_type"]
          unit_price_snapshot: number
        }
        Insert: {
          booking_id: number
          booking_service_id?: number
          computed_amount?: number | null
          created_at?: string | null
          quantity?: number
          service_id: number
          type?: Database["public"]["Enums"]["service_type"]
          unit_price_snapshot?: number
        }
        Update: {
          booking_id?: number
          booking_service_id?: number
          computed_amount?: number | null
          created_at?: string | null
          quantity?: number
          service_id?: number
          type?: Database["public"]["Enums"]["service_type"]
          unit_price_snapshot?: number
        }
        Relationships: [
          {
            foreignKeyName: "booking_services_booking_id_fkey"
            columns: ["booking_id"]
            isOneToOne: false
            referencedRelation: "bookings"
            referencedColumns: ["booking_id"]
          },
          {
            foreignKeyName: "booking_services_service_id_fkey"
            columns: ["service_id"]
            isOneToOne: false
            referencedRelation: "services"
            referencedColumns: ["service_id"]
          },
        ]
      }
      bookings: {
        Row: {
          booking_id: number
          booking_type: string | null
          check_in_at: string | null
          check_out_at: string | null
          created_at: string | null
          created_by: number | null
          customer_id: number | null
          deposit_amount: number | null
          deposit_paid: number | null
          discount_amount: number | null
          discount_reason: string | null
          notes: string | null
          status: Database["public"]["Enums"]["booking_status"] | null
          title: string | null
          total_actual: number | null
          total_estimate: number | null
          updated_at: string | null
          vat_percent_snapshot: number | null
          voucher_code: string | null
        }
        Insert: {
          booking_id?: number
          booking_type?: string | null
          check_in_at?: string | null
          check_out_at?: string | null
          created_at?: string | null
          created_by?: number | null
          customer_id?: number | null
          deposit_amount?: number | null
          deposit_paid?: number | null
          discount_amount?: number | null
          discount_reason?: string | null
          notes?: string | null
          status?: Database["public"]["Enums"]["booking_status"] | null
          title?: string | null
          total_actual?: number | null
          total_estimate?: number | null
          updated_at?: string | null
          vat_percent_snapshot?: number | null
          voucher_code?: string | null
        }
        Update: {
          booking_id?: number
          booking_type?: string | null
          check_in_at?: string | null
          check_out_at?: string | null
          created_at?: string | null
          created_by?: number | null
          customer_id?: number | null
          deposit_amount?: number | null
          deposit_paid?: number | null
          discount_amount?: number | null
          discount_reason?: string | null
          notes?: string | null
          status?: Database["public"]["Enums"]["booking_status"] | null
          title?: string | null
          total_actual?: number | null
          total_estimate?: number | null
          updated_at?: string | null
          vat_percent_snapshot?: number | null
          voucher_code?: string | null
        }
        Relationships: [
          {
            foreignKeyName: "bookings_created_by_fkey"
            columns: ["created_by"]
            isOneToOne: false
            referencedRelation: "users"
            referencedColumns: ["user_id"]
          },
          {
            foreignKeyName: "bookings_customer_id_fkey"
            columns: ["customer_id"]
            isOneToOne: false
            referencedRelation: "customers"
            referencedColumns: ["customer_id"]
          },
        ]
      }
      branches: {
        Row: {
          address: string | null
          branch_code: string
          branch_id: number
          created_at: string | null
          is_active: boolean | null
          name: string
          phone: string | null
          timezone: string | null
        }
        Insert: {
          address?: string | null
          branch_code: string
          branch_id?: number
          created_at?: string | null
          is_active?: boolean | null
          name: string
          phone?: string | null
          timezone?: string | null
        }
        Update: {
          address?: string | null
          branch_code?: string
          branch_id?: number
          created_at?: string | null
          is_active?: boolean | null
          name?: string
          phone?: string | null
          timezone?: string | null
        }
        Relationships: []
      }
      customers: {
        Row: {
          address: string | null
          cccd: string | null
          company_name: string | null
          created_at: string
          customer_id: number
          customer_type: Database["public"]["Enums"]["customer_type"]
          discount_rate: number | null
          email: string | null
          full_name: string
          is_active: boolean
          note: string | null
          phone: string | null
          tax_code: string | null
        }
        Insert: {
          address?: string | null
          cccd?: string | null
          company_name?: string | null
          created_at?: string
          customer_id?: number
          customer_type?: Database["public"]["Enums"]["customer_type"]
          discount_rate?: number | null
          email?: string | null
          full_name: string
          is_active?: boolean
          note?: string | null
          phone?: string | null
          tax_code?: string | null
        }
        Update: {
          address?: string | null
          cccd?: string | null
          company_name?: string | null
          created_at?: string
          customer_id?: number
          customer_type?: Database["public"]["Enums"]["customer_type"]
          discount_rate?: number | null
          email?: string | null
          full_name?: string
          is_active?: boolean
          note?: string | null
          phone?: string | null
          tax_code?: string | null
        }
        Relationships: []
      }
      employee_profiles: {
        Row: {
          base_salary: number | null
          contract_type: string | null
          created_at: string
          dob: string | null
          employee_id: number
          employment_status:
            | Database["public"]["Enums"]["employment_status"]
            | null
          hire_date: string | null
          salary_type: string | null
          user_id: number
        }
        Insert: {
          base_salary?: number | null
          contract_type?: string | null
          created_at?: string
          dob?: string | null
          employee_id?: number
          employment_status?:
            | Database["public"]["Enums"]["employment_status"]
            | null
          hire_date?: string | null
          salary_type?: string | null
          user_id: number
        }
        Update: {
          base_salary?: number | null
          contract_type?: string | null
          created_at?: string
          dob?: string | null
          employee_id?: number
          employment_status?:
            | Database["public"]["Enums"]["employment_status"]
            | null
          hire_date?: string | null
          salary_type?: string | null
          user_id?: number
        }
        Relationships: [
          {
            foreignKeyName: "employee_profiles_user_id_fkey"
            columns: ["user_id"]
            isOneToOne: true
            referencedRelation: "users"
            referencedColumns: ["user_id"]
          },
        ]
      }
      equipment_items: {
        Row: {
          condition: Database["public"]["Enums"]["item_condition"] | null
          created_at: string | null
          current_room_id: number | null
          item_id: number
          model_id: number
          qr_code: string
          serial_number: string | null
          status: Database["public"]["Enums"]["item_status"]
        }
        Insert: {
          condition?: Database["public"]["Enums"]["item_condition"] | null
          created_at?: string | null
          current_room_id?: number | null
          item_id?: number
          model_id: number
          qr_code: string
          serial_number?: string | null
          status?: Database["public"]["Enums"]["item_status"]
        }
        Update: {
          condition?: Database["public"]["Enums"]["item_condition"] | null
          created_at?: string | null
          current_room_id?: number | null
          item_id?: number
          model_id?: number
          qr_code?: string
          serial_number?: string | null
          status?: Database["public"]["Enums"]["item_status"]
        }
        Relationships: [
          {
            foreignKeyName: "equipment_items_current_room_id_fkey"
            columns: ["current_room_id"]
            isOneToOne: false
            referencedRelation: "rooms"
            referencedColumns: ["room_id"]
          },
          {
            foreignKeyName: "equipment_items_model_id_fkey"
            columns: ["model_id"]
            isOneToOne: false
            referencedRelation: "equipment_models"
            referencedColumns: ["model_id"]
          },
        ]
      }
      equipment_models: {
        Row: {
          available_quantity: number | null
          created_at: string | null
          default_hourly_price: number | null
          description: string | null
          is_active: boolean | null
          model_id: number
          name: string
          sku: string | null
          total_quantity: number | null
        }
        Insert: {
          available_quantity?: number | null
          created_at?: string | null
          default_hourly_price?: number | null
          description?: string | null
          is_active?: boolean | null
          model_id?: number
          name: string
          sku?: string | null
          total_quantity?: number | null
        }
        Update: {
          available_quantity?: number | null
          created_at?: string | null
          default_hourly_price?: number | null
          description?: string | null
          is_active?: boolean | null
          model_id?: number
          name?: string
          sku?: string | null
          total_quantity?: number | null
        }
        Relationships: []
      }
      files: {
        Row: {
          file_id: number
          file_name: string
          file_type: string | null
          file_url: string
          is_archive: boolean | null
          uploaded_at: string | null
          uploaded_by: number | null
        }
        Insert: {
          file_id?: number
          file_name: string
          file_type?: string | null
          file_url: string
          is_archive?: boolean | null
          uploaded_at?: string | null
          uploaded_by?: number | null
        }
        Update: {
          file_id?: number
          file_name?: string
          file_type?: string | null
          file_url?: string
          is_archive?: boolean | null
          uploaded_at?: string | null
          uploaded_by?: number | null
        }
        Relationships: [
          {
            foreignKeyName: "files_uploaded_by_fkey"
            columns: ["uploaded_by"]
            isOneToOne: false
            referencedRelation: "users"
            referencedColumns: ["user_id"]
          },
        ]
      }
      invoices: {
        Row: {
          booking_id: number
          created_at: string | null
          customer_id: number
          invoice_id: number
          issue_date: string | null
          paid_status: Database["public"]["Enums"]["invoice_status"] | null
          pdf_url: string | null
          qr_code_url: string | null
          subtotal: number
          total_amount: number
          vat_amount: number | null
        }
        Insert: {
          booking_id: number
          created_at?: string | null
          customer_id: number
          invoice_id?: number
          issue_date?: string | null
          paid_status?: Database["public"]["Enums"]["invoice_status"] | null
          pdf_url?: string | null
          qr_code_url?: string | null
          subtotal: number
          total_amount: number
          vat_amount?: number | null
        }
        Update: {
          booking_id?: number
          created_at?: string | null
          customer_id?: number
          invoice_id?: number
          issue_date?: string | null
          paid_status?: Database["public"]["Enums"]["invoice_status"] | null
          pdf_url?: string | null
          qr_code_url?: string | null
          subtotal?: number
          total_amount?: number
          vat_amount?: number | null
        }
        Relationships: [
          {
            foreignKeyName: "invoices_booking_id_fkey"
            columns: ["booking_id"]
            isOneToOne: false
            referencedRelation: "bookings"
            referencedColumns: ["booking_id"]
          },
          {
            foreignKeyName: "invoices_customer_id_fkey"
            columns: ["customer_id"]
            isOneToOne: false
            referencedRelation: "customers"
            referencedColumns: ["customer_id"]
          },
        ]
      }
      notifications: {
        Row: {
          body: string | null
          created_at: string | null
          is_read: boolean | null
          notification_id: number
          title: string
          type: string | null
          user_id: number | null
        }
        Insert: {
          body?: string | null
          created_at?: string | null
          is_read?: boolean | null
          notification_id?: number
          title: string
          type?: string | null
          user_id?: number | null
        }
        Update: {
          body?: string | null
          created_at?: string | null
          is_read?: boolean | null
          notification_id?: number
          title?: string
          type?: string | null
          user_id?: number | null
        }
        Relationships: [
          {
            foreignKeyName: "notifications_user_id_fkey"
            columns: ["user_id"]
            isOneToOne: false
            referencedRelation: "users"
            referencedColumns: ["user_id"]
          },
        ]
      }
      payments: {
        Row: {
          amount: number
          booking_id: number | null
          created_at: string | null
          customer_id: number | null
          method: Database["public"]["Enums"]["payment_method"] | null
          note: string | null
          parent_payment_id: number | null
          payment_id: number
          status: Database["public"]["Enums"]["payment_status"] | null
        }
        Insert: {
          amount: number
          booking_id?: number | null
          created_at?: string | null
          customer_id?: number | null
          method?: Database["public"]["Enums"]["payment_method"] | null
          note?: string | null
          parent_payment_id?: number | null
          payment_id?: number
          status?: Database["public"]["Enums"]["payment_status"] | null
        }
        Update: {
          amount?: number
          booking_id?: number | null
          created_at?: string | null
          customer_id?: number | null
          method?: Database["public"]["Enums"]["payment_method"] | null
          note?: string | null
          parent_payment_id?: number | null
          payment_id?: number
          status?: Database["public"]["Enums"]["payment_status"] | null
        }
        Relationships: [
          {
            foreignKeyName: "payments_booking_id_fkey"
            columns: ["booking_id"]
            isOneToOne: false
            referencedRelation: "bookings"
            referencedColumns: ["booking_id"]
          },
          {
            foreignKeyName: "payments_customer_id_fkey"
            columns: ["customer_id"]
            isOneToOne: false
            referencedRelation: "customers"
            referencedColumns: ["customer_id"]
          },
          {
            foreignKeyName: "payments_parent_payment_id_fkey"
            columns: ["parent_payment_id"]
            isOneToOne: false
            referencedRelation: "payments"
            referencedColumns: ["payment_id"]
          },
        ]
      }
      portfolio_categories: {
        Row: {
          category_id: number
          display_order: number | null
          is_active: boolean | null
          name: string
          slug: string
        }
        Insert: {
          category_id?: number
          display_order?: number | null
          is_active?: boolean | null
          name: string
          slug: string
        }
        Update: {
          category_id?: number
          display_order?: number | null
          is_active?: boolean | null
          name?: string
          slug?: string
        }
        Relationships: []
      }
      project_images: {
        Row: {
          alt_text: string | null
          created_by: number | null
          display_order: number | null
          height: number | null
          image_id: number
          image_url: string
          project_id: number
          width: number | null
        }
        Insert: {
          alt_text?: string | null
          created_by?: number | null
          display_order?: number | null
          height?: number | null
          image_id?: number
          image_url: string
          project_id: number
          width?: number | null
        }
        Update: {
          alt_text?: string | null
          created_by?: number | null
          display_order?: number | null
          height?: number | null
          image_id?: number
          image_url?: string
          project_id?: number
          width?: number | null
        }
        Relationships: [
          {
            foreignKeyName: "project_images_created_by_fkey"
            columns: ["created_by"]
            isOneToOne: false
            referencedRelation: "users"
            referencedColumns: ["user_id"]
          },
          {
            foreignKeyName: "project_images_project_id_fkey"
            columns: ["project_id"]
            isOneToOne: false
            referencedRelation: "projects"
            referencedColumns: ["project_id"]
          },
        ]
      }
      projects: {
        Row: {
          category_id: number
          client_name: string | null
          col_span: number | null
          content: Json | null
          cover_url: string | null
          created_at: string | null
          created_by: number | null
          credits: Json | null
          description: string | null
          display_order: number | null
          is_demo: boolean | null
          is_featured: boolean | null
          project_id: number
          published_at: string | null
          row_span: number | null
          slug: string
          thumbnail_url: string | null
          title: string
          updated_at: string | null
        }
        Insert: {
          category_id: number
          client_name?: string | null
          col_span?: number | null
          content?: Json | null
          cover_url?: string | null
          created_at?: string | null
          created_by?: number | null
          credits?: Json | null
          description?: string | null
          display_order?: number | null
          is_demo?: boolean | null
          is_featured?: boolean | null
          project_id?: number
          published_at?: string | null
          row_span?: number | null
          slug: string
          thumbnail_url?: string | null
          title: string
          updated_at?: string | null
        }
        Update: {
          category_id?: number
          client_name?: string | null
          col_span?: number | null
          content?: Json | null
          cover_url?: string | null
          created_at?: string | null
          created_by?: number | null
          credits?: Json | null
          description?: string | null
          display_order?: number | null
          is_demo?: boolean | null
          is_featured?: boolean | null
          project_id?: number
          published_at?: string | null
          row_span?: number | null
          slug?: string
          thumbnail_url?: string | null
          title?: string
          updated_at?: string | null
        }
        Relationships: [
          {
            foreignKeyName: "projects_category_id_fkey"
            columns: ["category_id"]
            isOneToOne: false
            referencedRelation: "portfolio_categories"
            referencedColumns: ["category_id"]
          },
          {
            foreignKeyName: "projects_created_by_fkey"
            columns: ["created_by"]
            isOneToOne: false
            referencedRelation: "users"
            referencedColumns: ["user_id"]
          },
        ]
      }
      rooms: {
        Row: {
          branch_id: number
          capacity: number | null
          code: string
          created_at: string | null
          is_equipment_room: boolean | null
          is_rentable: boolean | null
          name: string | null
          price_per_hour: number | null
          room_id: number
          status: Database["public"]["Enums"]["room_status"]
        }
        Insert: {
          branch_id: number
          capacity?: number | null
          code: string
          created_at?: string | null
          is_equipment_room?: boolean | null
          is_rentable?: boolean | null
          name?: string | null
          price_per_hour?: number | null
          room_id?: number
          status?: Database["public"]["Enums"]["room_status"]
        }
        Update: {
          branch_id?: number
          capacity?: number | null
          code?: string
          created_at?: string | null
          is_equipment_room?: boolean | null
          is_rentable?: boolean | null
          name?: string | null
          price_per_hour?: number | null
          room_id?: number
          status?: Database["public"]["Enums"]["room_status"]
        }
        Relationships: [
          {
            foreignKeyName: "rooms_branch_id_fkey"
            columns: ["branch_id"]
            isOneToOne: false
            referencedRelation: "branches"
            referencedColumns: ["branch_id"]
          },
        ]
      }
      services: {
        Row: {
          category: string | null
          is_active: boolean | null
          name: string
          price: number
          service_id: number
          type: Database["public"]["Enums"]["service_type"]
          unit: string | null
        }
        Insert: {
          category?: string | null
          is_active?: boolean | null
          name: string
          price?: number
          service_id?: number
          type?: Database["public"]["Enums"]["service_type"]
          unit?: string | null
        }
        Update: {
          category?: string | null
          is_active?: boolean | null
          name?: string
          price?: number
          service_id?: number
          type?: Database["public"]["Enums"]["service_type"]
          unit?: string | null
        }
        Relationships: []
      }
      settings: {
        Row: {
          description: string | null
          key: string
          updated_at: string | null
          value: string | null
        }
        Insert: {
          description?: string | null
          key: string
          updated_at?: string | null
          value?: string | null
        }
        Update: {
          description?: string | null
          key?: string
          updated_at?: string | null
          value?: string | null
        }
        Relationships: []
      }
      users: {
        Row: {
          auth_id: string | null
          created_at: string
          email: string | null
          full_name: string | null
          is_active: boolean | null
          phone: string | null
          role: Database["public"]["Enums"]["user_role"]
          status: Database["public"]["Enums"]["user_status"]
          updated_at: string | null
          user_id: number
          username: string
        }
        Insert: {
          auth_id?: string | null
          created_at?: string
          email?: string | null
          full_name?: string | null
          is_active?: boolean | null
          phone?: string | null
          role?: Database["public"]["Enums"]["user_role"]
          status?: Database["public"]["Enums"]["user_status"]
          updated_at?: string | null
          user_id?: number
          username: string
        }
        Update: {
          auth_id?: string | null
          created_at?: string
          email?: string | null
          full_name?: string | null
          is_active?: boolean | null
          phone?: string | null
          role?: Database["public"]["Enums"]["user_role"]
          status?: Database["public"]["Enums"]["user_status"]
          updated_at?: string | null
          user_id?: number
          username?: string
        }
        Relationships: []
      }
    }
    Views: {
      [_ in never]: never
    }
    Functions: {
      [_ in never]: never
    }
    Enums: {
      booking_status:
        | "pending"
        | "confirmed"
        | "checked_in"
        | "checked_out"
        | "completed"
        | "cancelled"
        | "paid"
      customer_type: "regular" | "vip" | "corporate"
      employment_status: "active" | "inactive" | "terminated"
      invoice_status: "unpaid" | "partial" | "paid"
      item_condition: "new" | "good" | "fair" | "damaged"
      item_status:
        | "available"
        | "in_studio_assigned"
        | "rented_out"
        | "under_maintenance"
        | "retired"
        | "lost"
      payment_method: "cash" | "transfer" | "qr" | "card"
      payment_status: "pending" | "completed" | "failed" | "refunded"
      room_status: "available" | "maintenance" | "inactive"
      service_type: "service" | "surcharge" | "compensation"
      user_role: "Admin" | "Staff"
      user_status: "active" | "inactive" | "banned"
    }
    CompositeTypes: {
      [_ in never]: never
    }
  }
}

type DatabaseWithoutInternals = Omit<Database, "__InternalSupabase">

type DefaultSchema = DatabaseWithoutInternals[Extract<keyof Database, "public">]

export type Tables<
  DefaultSchemaTableNameOrOptions extends
    | keyof (DefaultSchema["Tables"] & DefaultSchema["Views"])
    | { schema: keyof DatabaseWithoutInternals },
  TableName extends DefaultSchemaTableNameOrOptions extends {
    schema: keyof DatabaseWithoutInternals
  }
    ? keyof (DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Tables"] &
        DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Views"])
    : never = never,
> = DefaultSchemaTableNameOrOptions extends {
  schema: keyof DatabaseWithoutInternals
}
  ? (DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Tables"] &
      DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Views"])[TableName] extends {
      Row: infer R
    }
    ? R
    : never
  : DefaultSchemaTableNameOrOptions extends keyof (DefaultSchema["Tables"] &
        DefaultSchema["Views"])
    ? (DefaultSchema["Tables"] &
        DefaultSchema["Views"])[DefaultSchemaTableNameOrOptions] extends {
        Row: infer R
      }
      ? R
      : never
    : never

export type TablesInsert<
  DefaultSchemaTableNameOrOptions extends
    | keyof DefaultSchema["Tables"]
    | { schema: keyof DatabaseWithoutInternals },
  TableName extends DefaultSchemaTableNameOrOptions extends {
    schema: keyof DatabaseWithoutInternals
  }
    ? keyof DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Tables"]
    : never = never,
> = DefaultSchemaTableNameOrOptions extends {
  schema: keyof DatabaseWithoutInternals
}
  ? DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Tables"][TableName] extends {
      Insert: infer I
    }
    ? I
    : never
  : DefaultSchemaTableNameOrOptions extends keyof DefaultSchema["Tables"]
    ? DefaultSchema["Tables"][DefaultSchemaTableNameOrOptions] extends {
        Insert: infer I
      }
      ? I
      : never
    : never

export type TablesUpdate<
  DefaultSchemaTableNameOrOptions extends
    | keyof DefaultSchema["Tables"]
    | { schema: keyof DatabaseWithoutInternals },
  TableName extends DefaultSchemaTableNameOrOptions extends {
    schema: keyof DatabaseWithoutInternals
  }
    ? keyof DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Tables"]
    : never = never,
> = DefaultSchemaTableNameOrOptions extends {
  schema: keyof DatabaseWithoutInternals
}
  ? DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Tables"][TableName] extends {
      Update: infer U
    }
    ? U
    : never
  : DefaultSchemaTableNameOrOptions extends keyof DefaultSchema["Tables"]
    ? DefaultSchema["Tables"][DefaultSchemaTableNameOrOptions] extends {
        Update: infer U
      }
      ? U
      : never
    : never

export type Enums<
  DefaultSchemaEnumNameOrOptions extends
    | keyof DefaultSchema["Enums"]
    | { schema: keyof DatabaseWithoutInternals },
  EnumName extends DefaultSchemaEnumNameOrOptions extends {
    schema: keyof DatabaseWithoutInternals
  }
    ? keyof DatabaseWithoutInternals[DefaultSchemaEnumNameOrOptions["schema"]]["Enums"]
    : never = never,
> = DefaultSchemaEnumNameOrOptions extends {
  schema: keyof DatabaseWithoutInternals
}
  ? DatabaseWithoutInternals[DefaultSchemaEnumNameOrOptions["schema"]]["Enums"][EnumName]
  : DefaultSchemaEnumNameOrOptions extends keyof DefaultSchema["Enums"]
    ? DefaultSchema["Enums"][DefaultSchemaEnumNameOrOptions]
    : never

export type CompositeTypes<
  PublicCompositeTypeNameOrOptions extends
    | keyof DefaultSchema["CompositeTypes"]
    | { schema: keyof DatabaseWithoutInternals },
  CompositeTypeName extends PublicCompositeTypeNameOrOptions extends {
    schema: keyof DatabaseWithoutInternals
  }
    ? keyof DatabaseWithoutInternals[PublicCompositeTypeNameOrOptions["schema"]]["CompositeTypes"]
    : never = never,
> = PublicCompositeTypeNameOrOptions extends {
  schema: keyof DatabaseWithoutInternals
}
  ? DatabaseWithoutInternals[PublicCompositeTypeNameOrOptions["schema"]]["CompositeTypes"][CompositeTypeName]
  : PublicCompositeTypeNameOrOptions extends keyof DefaultSchema["CompositeTypes"]
    ? DefaultSchema["CompositeTypes"][PublicCompositeTypeNameOrOptions]
    : never

export const Constants = {
  public: {
    Enums: {
      booking_status: [
        "pending",
        "confirmed",
        "checked_in",
        "checked_out",
        "completed",
        "cancelled",
        "paid",
      ],
      customer_type: ["regular", "vip", "corporate"],
      employment_status: ["active", "inactive", "terminated"],
      invoice_status: ["unpaid", "partial", "paid"],
      item_condition: ["new", "good", "fair", "damaged"],
      item_status: [
        "available",
        "in_studio_assigned",
        "rented_out",
        "under_maintenance",
        "retired",
        "lost",
      ],
      payment_method: ["cash", "transfer", "qr", "card"],
      payment_status: ["pending", "completed", "failed", "refunded"],
      room_status: ["available", "maintenance", "inactive"],
      service_type: ["service", "surcharge", "compensation"],
      user_role: ["Admin", "Staff"],
      user_status: ["active", "inactive", "banned"],
    },
  },
} as const
</file>

<file path="tailwind.config.ts">
// tailwind.config.ts
import type { Config } from 'tailwindcss';

const config: Config = {
  content: [
    './src/pages/**/*.{js,ts,jsx,tsx,mdx}',
    './src/components/**/*.{js,ts,jsx,tsx,mdx}',
    './src/app/**/*.{js,ts,jsx,tsx,mdx}',
  ],
  // THÊM DÒNG NÀY
  darkMode: 'class', 
  theme: {
    extend: {
      //...
    },
  },
  plugins: [],
};
export default config;
</file>

<file path="tsconfig.json">
{
  "compilerOptions": {
    "target": "ES2017",
    "lib": ["dom", "dom.iterable", "esnext"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "preserve",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/*": ["./src/*"]
    }
  },
  "include": ["next-env.d.ts", "**/*.ts", "**/*.tsx", ".next/types/**/*.ts"],
  "exclude": ["node_modules"]
}
</file>

<file path="src/app/admin/grid/page.tsx">
// src/app/admin/grid/page.tsx
import { getProjects } from '@/lib/actions';
import PortfolioGridEditor from '@/components/admin/PortfolioGridEditor';
import { LayoutTemplate, AlertTriangle } from 'lucide-react';
import Link from 'next/link';

export const dynamic = 'force-dynamic';

export default async function PortfolioGridPage() {
  // 1. Lấy dữ liệu
  const allProjects = await getProjects('all');
  
  // 2. Lọc lấy các dự án Nổi bật (Featured)
  // Chỉ những dự án này mới xuất hiện ngoài Grid trang chủ
  const featuredProjects = allProjects.filter(p => p.isFeatured);

  return (
    <div className="max-w-7xl mx-auto pb-20 space-y-8">
      {/* Header */}
      <div>
        <h1 className="text-3xl font-bold text-[var(--admin-fg)] flex items-center gap-3">
          <LayoutTemplate className="text-[var(--admin-primary)]" size={32} />
          Bố cục dự án Nổi bật
        </h1>
        <p className="text-[var(--admin-sub)] mt-2 max-w-2xl">
          Tinh chỉnh kích thước hiển thị cho các dự án <strong>Nổi bật</strong> trên trang chủ.
        </p>
      </div>

      {/* Main Content */}
      {featuredProjects.length > 0 ? (
        <PortfolioGridEditor initialProjects={featuredProjects} />
      ) : (
        // Empty State (Khi chưa chọn dự án nổi bật nào)
        <div className="flex flex-col items-center justify-center p-12 text-center border-2 border-dashed border-[var(--admin-border)] rounded-2xl bg-[var(--admin-card)]/50">
          <div className="w-16 h-16 bg-yellow-100 text-yellow-600 rounded-full flex items-center justify-center mb-4">
            <AlertTriangle size={32} />
          </div>
          <h3 className="text-xl font-semibold text-[var(--admin-fg)]">Chưa có dự án Nổi bật</h3>
          <p className="text-[var(--admin-sub)] mt-2 mb-6 max-w-md">
            Bạn cần đánh dấu <strong>Nổi bật</strong> cho ít nhất một dự án để có thể sắp xếp bố cục.
          </p>
          <Link 
            href="/admin/projects" 
            className="px-6 py-2.5 bg-[var(--admin-primary)] text-white font-medium rounded-lg hover:opacity-90 transition-all shadow-lg shadow-indigo-500/30"
          >
            Đến danh sách dự án
          </Link>
        </div>
      )}
    </div>
  );
}
</file>

<file path="src/app/admin/projects/[id]/page.tsx">
// src/app/admin/projects/[id]/page.tsx
import { getProjectById } from '@/lib/actions';
import ProjectForm, { ProjectInitialData, BlockDB } from '@/components/admin/ProjectForm';
import { notFound } from 'next/navigation';

interface PageProps {
  params: Promise<{ id: string }>;
}

export default async function EditProjectPage({ params }: PageProps) {
  const { id } = await params;
  
  // 1. Lấy dữ liệu từ DB
  const projectRaw = await getProjectById(parseInt(id));

  if (!projectRaw) {
    notFound(); // Trả về trang 404 nếu không tìm thấy
  }

  // 2. Chuyển đổi format DB -> Format Form
  // Cần ép kiểu cẩn thận vì Supabase trả về JSON object thô
  const formattedData: ProjectInitialData = {
    id: projectRaw.project_id,
    title: projectRaw.title,
    client_name: projectRaw.client_name || '',
    description: projectRaw.description || '',
    category_id: projectRaw.category_id?.toString() || '',
    is_featured: projectRaw.is_featured || false,
    thumbnail_url: projectRaw.thumbnail_url || '',
    credits: Array.isArray(projectRaw.credits) ? projectRaw.credits : [],
    content: Array.isArray(projectRaw.content) ? (projectRaw.content as BlockDB[]) : []
  };

  // 3. Render Form
  return <ProjectForm mode="edit" initialData={formattedData} />;
}
</file>

<file path="src/app/styles/ProjectArticle.module.css">
/* src/app/styles/ProjectArticle.module.css (CSS mới) */

/* 1. Container chính (Giống Gucci, max-width 3xl) */
.articleContainer {
    max-width: 860px; /* max-w-3xl */
    margin: 0 auto;
    padding: 0 1rem; /* px-4 */
    padding-top: 4rem; /* py-16 */
    padding-bottom: 6rem; /* py-24 */
}

/* 2. Tiêu đề chính */
.articleTitle {
    font-size: 2.25rem; /* text-4xl */
    line-height: 2.5rem;
    font-weight: 300; /* font-light */
    letter-spacing: -0.025em; /* tracking-tighter */
    text-align: center;
    margin-bottom: 1.5rem; /* mb-6 */
    color: var(--foreground);
}

@media (min-width: 768px) {
    .articleTitle {
        font-size: 3rem; /* md:text-5xl */
        line-height: 1;
    }
}

/* 3. Thanh Credits */
.creditsBar {
    border-top: 1px solid rgba(128, 128, 128, 0.2);
    border-bottom: 1px solid rgba(128, 128, 128, 0.2);
    margin-top: 2rem; /* my-8 */
    margin-bottom: 2rem;
    padding-top: 1rem; /* py-4 */
    padding-bottom: 1rem;
}
.creditsList {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 1rem 2rem; /* a/cách 2rem */
    font-size: 0.875rem; /* text-sm */
    color: var(--foreground);
    opacity: 0.8;
}
.creditsList li strong {
    font-weight: 600;
    opacity: 1;
}

/* 4. Khối văn bản (Giống text-wrap) */
.textWrap {
    font-size: 1.125rem; /* text-lg */
    line-height: 1.75rem; /* leading-relaxed */
    color: var(--foreground);
    opacity: 0.9;
    margin-top: 3rem; /* space-y-12 */
    margin-bottom: 3rem;
}
.textWrap p {
    margin-bottom: 1.5rem; /* space-y-6 bên trong */
}

/* 5. Khối Sub-heading (Giống highlight) */
.highlightWrap {
    text-align: center;
    margin-top: 4rem; /* pt-8 + my-12 */
    margin-bottom: 3rem;
}
.highlightWrap h2 {
    font-size: 1.875rem; /* text-3xl */
    line-height: 2.25rem;
    font-weight: 300; /* font-light */
    letter-spacing: -0.025em; /* tracking-tight */
    color: var(--foreground);
}
@media (min-width: 768px) {
    .highlightWrap h2 {
        font-size: 2.25rem; /* md:text-4xl */
    }
}

/* 6. Khối ảnh (Giống image-row) */
.imageRow {
    display: flex;
    flex-direction: column; /* Xếp chồng trên mobile */
    gap: 1rem; /* gap-4 */
    justify-content: center;
    margin-top: 3rem; /* my-8 md:my-12 */
    margin-bottom: 3rem;
}
@media (min-width: 768px) {
    .imageRow {
        flex-direction: row; /* Cạnh nhau trên desktop */
    }
}

/* 7. Giữ lại CSS cho Navigation và Fade-in */
.projectNavigation {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-top: 1px solid rgba(128, 128, 128, 0.2);
    padding-top: 30px;
}
.navLink {
    text-decoration: none;
    color: var(--foreground);
    font-weight: 500;
    padding: 10px 15px;
    transition: all 0.3s ease;
    border-radius: 4px;
}
.navLink:hover:not(.disabled) {
    color: var(--glow-color);
    background-color: rgba(128, 128, 128, 0.1);
}
.navLink.disabled {
    color: var(--foreground);
    opacity: 0.3;
    pointer-events: none;
}
.fade_in_hidden {
    opacity: 0;
    transform: translateY(20px);
    transition: opacity 0.8s ease-out, transform 0.8s ease-out;
}
.fade_in_visible {
    opacity: 1;
    transform: translateY(0);
}
</file>

<file path="src/components/admin/DashboardActions.tsx">
// src/components/admin/DashboardActions.tsx
'use client';

import { toast } from 'sonner';
import Link from 'next/link';
import { Printer, Plus } from 'lucide-react';

export default function DashboardActions() {
  return (
    <div className="flex gap-3">
      <button onClick={() => toast.info('Tính năng Xuất báo cáo đang phát triển')}
      className="
        flex-1 md:flex-none
        inline-flex items-center justify-center gap-2 
        bg-[var(--admin-card)] border border-[var(--admin-border)] 
        text-[var(--admin-fg)] hover:bg-[var(--admin-hover)] 
        px-4 py-2 rounded-md text-sm font-medium transition-colors
      ">
        <Printer size={16} />          {/* 2. Icon Máy in */}
        <span>Xuất báo cáo</span>
      </button>
      <Link 
        href="/admin/projects/new"
        className="flex-1 md:flex-none
        inline-flex items-center justify-center gap-2 
        bg-[var(--admin-primary)] text-[var(--admin-primary-fg)] 
        hover:opacity-90 
        px-4 py-2 rounded-md text-sm font-medium transition-colors shadow-sm"
      >
        <Plus size={16} />
        <span>Tạo dự án mới</span>
      </Link>
    </div>
  );
}
</file>

<file path="src/components/admin/DashboardFilter.tsx">
// src/components/admin/DashboardFilter.tsx
'use client';

import { useState, useRef, useEffect, useTransition } from 'react';
import { useRouter, useSearchParams } from 'next/navigation';
import { CalendarDays, ChevronDown, Check, Loader2 } from 'lucide-react';

const OPTIONS = [
  { value: '7d', label: '7 ngày qua (Tuần)' },
  { value: '30d', label: '30 ngày qua (Tháng)' },
  { value: '90d', label: '3 tháng qua (Quý)' },
  { value: '12m', label: '1 năm qua' },
  { value: 'all', label: 'Tất cả thời gian' },
];

export default function DashboardFilter() {
  const router = useRouter();
  const searchParams = useSearchParams();
  const [isOpen, setIsOpen] = useState(false);
  const [isPending, startTransition] = useTransition();
  const containerRef = useRef<HTMLDivElement>(null);
  
  const currentRange = searchParams.get('range') || '30d';
  const activeLabel = OPTIONS.find(opt => opt.value === currentRange)?.label || 'Chọn thời gian';

  const handleSelect = (value: string) => {
    setIsOpen(false);
    startTransition(() => {
      const params = new URLSearchParams(searchParams);
      params.set('range', value);
      router.push(`?${params.toString()}`, { scroll: false });
      router.refresh(); 
    });
  };

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      if (containerRef.current && !containerRef.current.contains(event.target as Node)) {
        setIsOpen(false);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, []);

  return (
    // [1] Container: w-full trên mobile, w-auto trên desktop
    <div className="relative w-full md:w-auto" ref={containerRef}>
      
      {/* TRIGGER BUTTON */}
      <button
        onClick={() => setIsOpen(!isOpen)}
        disabled={isPending}
        className={`
          flex items-center justify-between gap-2 px-4 py-2 rounded-lg border transition-all duration-200 whitespace-nowrap
          text-sm font-medium bg-[var(--admin-card)] hover:bg-[var(--admin-hover)]
          
          /* [2] Button Width: Full mobile, Auto desktop */
          w-full md:w-auto

          ${isOpen 
            ? 'border-[var(--admin-primary)] ring-2 ring-[var(--admin-primary)]/10 text-[var(--admin-fg)]' 
            : 'border-[var(--admin-border)] text-[var(--admin-sub)] hover:text-[var(--admin-fg)]'
          }
          ${isPending ? 'opacity-70 cursor-wait' : ''}
        `}
      >
        {/* Nhóm Icon + Text nằm bên trái */}
        <div className="flex items-center gap-2">
            {isPending ? (
            <Loader2 size={16} className="animate-spin text-[var(--admin-primary)]" />
            ) : (
            <CalendarDays size={16} className={isOpen ? 'text-[var(--admin-primary)]' : 'text-[var(--admin-sub)]'} />
            )}
            
            <span className="text-left">
            {isPending ? 'Đang tải...' : activeLabel}
            </span>
        </div>
        
        {/* Mũi tên luôn nằm bên phải cùng */}
        <ChevronDown 
          size={16} 
          className={`transition-transform duration-200 ml-2 ${isOpen ? 'rotate-180' : ''}`} 
        />
      </button>

      {/* DROPDOWN MENU */}
      {isOpen && (
        <div className="
            absolute right-0 mt-2 
            bg-[var(--admin-card)] border border-[var(--admin-border)] 
            rounded-xl shadow-xl z-50 
            animate-in fade-in zoom-in-95 duration-100 origin-top-right overflow-hidden
            
            /* [3] Dropdown Width: Full mobile (để khớp với nút), w-56 trên desktop */
            w-full md:w-56
        ">
          <div className="p-1.5">
            <div className="px-3 py-2 text-[10px] font-bold text-[var(--admin-sub)] uppercase tracking-wider">
              Khoảng thời gian
            </div>
            {OPTIONS.map((opt) => {
              const isActive = opt.value === currentRange;
              return (
                <button
                  key={opt.value}
                  onClick={() => handleSelect(opt.value)}
                  className={`
                    w-full flex items-center justify-between px-3 py-2 rounded-lg text-sm transition-colors
                    ${isActive 
                      ? 'bg-[var(--admin-primary)]/10 text-[var(--admin-primary)] font-medium' 
                      : 'text-[var(--admin-fg)] hover:bg-[var(--admin-hover)]'
                    }
                  `}
                >
                  <span>{opt.label}</span>
                  {isActive && <Check size={16} />}
                </button>
              );
            })}
          </div>
        </div>
      )}
    </div>
  );
}
</file>

<file path="src/components/admin/DeleteProjectButton.tsx">
// src/components/admin/DeleteProjectButton.tsx
'use client';

import { useState } from 'react';
import { Trash2 } from 'lucide-react';
import { toast } from 'sonner';
import { deleteProject } from '@/lib/actions';
import { createBrowserClient } from '@supabase/ssr';
import ConfirmModal from '@/components/ui/ConfirmModal';

export default function DeleteProjectButton({ projectId, projectTitle }: { projectId: number, projectTitle: string }) {
  const [isDeleting, setIsDeleting] = useState(false);
  const [showModal, setShowModal] = useState(false); 
  const supabase = createBrowserClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
  );

  const handleDelete = async () => {
    const confirmMsg = `CẢNH BÁO: Bạn có chắc chắn muốn xóa dự án "${projectTitle}"?\nHành động này không thể hoàn tác!`;
    if (!window.confirm(confirmMsg)) return;

    setIsDeleting(true);
    const toastId = toast.loading('Đang xóa...');

    try {
      const { data: { session } } = await supabase.auth.getSession();
      
      if (!session) {
        toast.error('Không tìm thấy phiên đăng nhập. Vui lòng F5.', { id: toastId });
        setIsDeleting(false);
        setShowModal(false);
        return;
      }

      // 4. GỌI SERVER ACTION
      const res = await deleteProject(session.access_token, projectId);

      if (res.success) {
        toast.success('Đã xóa dự án', { id: toastId });
        setShowModal(false)
        // Refresh cứng để đảm bảo danh sách cập nhật sạch sẽ
        setTimeout(() => {
            window.location.reload(); 
        }, 500);
      } else {
        toast.error(`Lỗi: ${res.error}`, { id: toastId });
        setIsDeleting(false);
      }
    } catch (error) {
        const msg = error instanceof Error ? error.message : 'Có lỗi xảy ra';
        toast.error(msg, { id: toastId });
    } finally {
      setIsDeleting(false);
    }
  };

  return (
  <main>
      {/* Nút thùng rác (Chỉ mở Modal) */}
      <button 
        onClick={() => setShowModal(true)}
        className="p-2 text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition-colors"
        title="Xóa dự án"
      >
        <Trash2 size={18} />
      </button>

      {/* Modal xác nhận */}
      <ConfirmModal 
        isOpen={showModal}
        onClose={() => !isDeleting && setShowModal(false)} // Không cho đóng khi đang xóa dở
        onConfirm={handleDelete}
        title="Xóa dự án này?"
        description={`Bạn có chắc chắn muốn xóa dự án "${projectTitle}"? Hành động này sẽ xóa vĩnh viễn toàn bộ thông tin và hình ảnh liên quan. Không thể hoàn tác.`}
        confirmText={isDeleting ? "Đang xóa..." : "Xóa vĩnh viễn"}
        cancelText="Hủy bỏ"
        variant="danger"
        isLoading={isDeleting}
      />
    </main>
  );
}
</file>

<file path="src/components/admin/StaffPageHeader.tsx">
'use client';

import { useState } from 'react';
import { Plus } from 'lucide-react';
import CreateStaffModal from './CreateStaffModal';

export default function StaffPageHeader({ total }: { total: number }) {
  const [isModalOpen, setIsModalOpen] = useState(false);

  return (
    <>
      <div className="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
        <div>
          <h1 className="text-3xl font-bold text-[var(--admin-fg)]">Nhân sự Studio</h1>
          <p className="text-[var(--admin-sub)] mt-1">Tổng số: {total} thành viên</p>
        </div>
        <button 
          onClick={() => setIsModalOpen(true)}
          className="flex items-center justify-center gap-2 px-5 py-2.5 bg-[var(--admin-primary)] text-white 
          rounded-lg hover:opacity-90 transition-all shadow-lg shadow-indigo-500/30 font-medium cursor-pointer"
        >
          <Plus size={20} /> Thêm Nhân viên
        </button>
      </div>

      <CreateStaffModal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} />
    </>
  );
}
</file>

<file path="src/components/Container.tsx">
import { ReactNode } from "react";

interface ContainerProps {
  children: ReactNode;
  className?: string;
}

export default function Container({ children, className = "" }: ContainerProps) {
  return (
    <div className={`mx-auto lg:max-w-9/10 md:max-w-7xl px-4 sm:px-6 lg:px-8 ${className}`}>
      {children}
    </div>
  );
}
</file>

<file path="src/components/HomePageContent.tsx">
// src/components/HomePageContent.tsx

'use client';

import dynamic from 'next/dynamic';

// 1. Tải ngay lập tức
import HeroSection from '@/components/HeroSection';

// 2. Tạo một component Loading (Trạng thái chờ)
const LoadingSpinner = () => (
  <div className="h-96 flex items-center justify-center">
    <p>Đang tải...</p>
  </div>
);

// 3. Tải lười (Dynamic Imports) cho các section bên dưới
const DynamicPortfolioSection = dynamic(
  () => import('@/components/PortfolioSection'), // Giả định component này tồn tại
  { ssr: false, loading: () => <LoadingSpinner /> }
);

const DynamicProjectShowcase = dynamic(
  () => import('@/components/ProjectShowcase'), // Giả định component này tồn tại
  { ssr: false, loading: () => <LoadingSpinner /> }
);


const DynamicContactSection = dynamic(
  () => import('@/components/ContactSection'),
  { ssr: false, loading: () => <LoadingSpinner /> }
);

// 4. Đổi tên function (từ HomePage thành HomePageContent)
export default function HomePageContent() {
  return (
    <main>
      {/* Section 01 (Tải ngay) */}
      <HeroSection />

      {/* Section 02 (Tải lười) */}
      <section id="portfolio" className="md:pt-24">
        <DynamicPortfolioSection />
      </section>

      {/* Section 03 (Tải lười) */}
      <section id="showcase" className="md:pt-24">
        <DynamicProjectShowcase />
      </section>

      {/* Section 04 (Tải lười) */}
      <section id="contact">
        <DynamicContactSection />
      </section>
    </main>
  );
}
</file>

<file path="src/components/PhilosophyBackground.tsx">
// src/components/PhilosophyBackground.tsx
'use client';

import ScrollBaseAnimation from '@/components/scroll-text-marque';

export default function PhilosophyBackground() {
  return (
    <div className="absolute inset-0 z-10 flex flex-col justify-center 
                    opacity-10 dark:opacity-5 
                    pointer-events-none gap-4 md:gap-8">

      <ScrollBaseAnimation
        baseVelocity={-3}
        className="text-6xl font-bold uppercase whitespace-nowrap"
      >
        THƯƠNG MẠI • THỜI TRANG • CÁ NHÂN •
      </ScrollBaseAnimation>

      <ScrollBaseAnimation
        baseVelocity={3}
        className="text-9xl font-bold uppercase whitespace-nowrap text-center"
      >
        KHOẢNH KHẮC • SÁNG TẠO • ONI STUDIO •
      </ScrollBaseAnimation>

      <ScrollBaseAnimation
        baseVelocity={-2}
        className="text-6xl font-bold uppercase whitespace-nowrap"
      >
        LOOKBOOK • PORTRAIT • PHOTOGRAPHY •
      </ScrollBaseAnimation>
    </div>
  );
}
</file>

<file path="src/components/ScrollingText.tsx">
// // src/components/ui/ScrollingText.tsx
// 'use client';

// import { useRef, useState } from 'react';
// import {
//   motion,
//   useScroll,
//   useMotionValueEvent,
// } from 'framer-motion';

// // Định nghĩa props cho component
// interface ScrollingTextProps {
//   text: string;
//   className?: string;
//   direction?: 'left' | 'right'; 
//   speed?: number; // Tốc độ chạy (s), càng nhỏ càng nhanh
// }


// /**
//  * Component chính
//  */
// export const ScrollingText = ({
//   text,
//   className = '',
//   direction = 'left',
//   speed = 15, // Mặc định 15s cho 1 vòng
// }: ScrollingTextProps) => {
//   const containerRef = useRef<HTMLDivElement>(null);
  
//   // 1. THEO DÕI HƯỚNG CUỘN
//   const { scrollY } = useScroll();
//   const [scrollDirection, setScrollDirection] = useState<'up' | 'down'>('down');

//   useMotionValueEvent(scrollY, 'change', (latest) => {
//     const previous = scrollY.getPrevious() ?? 0;
//     if (latest > previous) {
//       setScrollDirection('down');
//     } else {
//       setScrollDirection('up');
//     }
//   });

//   // 2. TẠO ANIMATION
//   // Dựa trên hướng cuộn, chúng ta đổi hướng chạy của chữ
//   const effectiveDirection =
//     scrollDirection === 'down' ? direction : direction === 'left' ? 'right' : 'left';


//   // Tạo giá trị 'from' và 'to' cho animation
//   const fromX = effectiveDirection === 'left' ? 0 : -2000;
//   const toX = effectiveDirection === 'left' ? -2000 : 0;

//   return (
//     <div
//       ref={containerRef}
//       className={`relative w-full overflow-hidden ${className}`}
//     >
//       <motion.div
//         className="relative"
//         // Sử dụng 'animate' và 'transition' của Framer Motion
//         animate={{ x: [fromX, toX] }}
//         transition={{
//           repeat: Infinity,
//           repeatType: 'loop',
//           duration: speed, // Dùng speed (giây) làm duration
//           ease: 'linear',
//         }}
//         style={{
//           width: '400%', // Gấp 4 lần vì có 4 bản sao
//           display: 'flex',
//         }}
//       >
//         {/* Render 4 bản sao. Đã xóa style 'speed' bị lỗi */}
//         <span className="block w-1/4 mr-8">{text}</span>
//         <span className="block w-1/4 mr-8">{text}</span>
//         <span className="block w-1/4 mr-8">{text}</span>
//         <span className="block w-1/4 mr-8">{text}</span>
//       </motion.div>
//     </div>
//   );
// };
</file>

<file path="src/lib/constants.ts">
// src/lib/constants.ts

/**
 * Cài đặt chung cho các layout dạng grid
 */

// Số lượng item giả cần cho mỗi trang
export const DESIRED_PROJECT_COUNT = 48;

// Số lượng item tải ban đầu khi vào trang
export const INITIAL_LOAD_COUNT = 8;

// Số lượng item tải thêm mỗi lần cuộn
export const LOAD_MORE_COUNT = 8;

export const SLUG_CATE_PERSONAL = 'ca-nhan';
export const SLUG_CATE_COMMERCIAL = 'thuong-mai';
export const SLUG_CATE_FASHION = 'thoi-trang';


export const ROOM_COLORS = [
  '#4285F4', // Xanh dương (Google)
  '#34A853', // Xanh lá
  '#EA4335', // Đỏ
  '#FBBC05', // Vàng
  '#8E24AA', // Tím
  '#F6BF26', // Cam
  '#06b6d4', // Cyan
  '#ec4899', // Pink
];
</file>

<file path=".gitignore">
# See https://help.github.com/articles/ignoring-files/ for more about ignoring files.

# dependencies
/node_modules
/.pnp
.pnp.*
.yarn/*
!.yarn/patches
!.yarn/plugins
!.yarn/releases
!.yarn/versions

# testing
/coverage

# next.js
/.next/
/out/

# production
/build

# misc
.DS_Store
*.pem

# debug
npm-debug.log*
yarn-debug.log*
yarn-error.log*
.pnpm-debug.log*

# env files (can opt-in for committing if needed)
.env*

# vercel
.vercel

# typescript
*.tsbuildinfo
next-env.d.ts

# Local documentation with secrets
docs/create_db.txt
</file>

<file path="README.md">
# Photographer Portfolio Website

Website Portfolio cá nhân dành cho nhiếp ảnh gia chuyên nghiệp, tập trung vào trải nghiệm thị giác, kể chuyện (storytelling) và tối ưu hóa hiệu năng.

**Live Demo:** [https://dangk3.github.io/Photographer-Portfolio/](https://dangk3.github.io/Photographer-Portfolio/)

![Project Screenshot](https://dangk3.github.io/Photographer-Portfolio/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Fhero-background.webp&w=3840&q=90) 
*(Bạn có thể thay link ảnh trên bằng ảnh chụp màn hình thực tế sau này)*

## 🚀 Tính năng nổi bật (Version 1.0)

* **Trải nghiệm điện ảnh:** Hero Section với hiệu ứng Ken Burns và Typography động.
* **Editorial Layout:** Trang chi tiết dự án được trình bày như một bài tạp chí (Magazine style) thay vì chỉ là gallery ảnh đơn thuần.
* **Smart Navigation:**
    * Menu điều hướng dính (Sticky Nav) thông minh.
    * Chuyển đổi giao diện Sáng/Tối (Dark/Light Mode).
    * Infinite Scroll (Cuộn vô tận) cho các trang danh mục.
* **Layout linh hoạt:**
    * Masonry Grid (xếp gạch) cho mục Cá nhân.
    * Editorial Grid cho mục Thời trang & Thương mại.
* **Hiệu năng cao:** Tối ưu hóa SEO động, Static Site Generation (SSG) tải trang cực nhanh.

## 🛠 Công nghệ sử dụng

* **Core:** [Next.js 15](https://nextjs.org/) (App Router), [React 19](https://react.dev/), [TypeScript](https://www.typescriptlang.org/).
* **Styling:** [Tailwind CSS v4](https://tailwindcss.com/).
* **Animation:** [Framer Motion](https://www.framer.com/motion/).
* **Components:** * `yet-another-react-lightbox` (Gallery).
    * `react-type-animation` (Hiệu ứng chữ).
* **Deployment:** GitHub Pages (Static Export).
</file>

<file path="src/app/admin/page.tsx">
'use client';

import { useEffect, useState } from 'react';
import { 
  getDashboardStats, 
  getTodaySchedule, 
  getGrowthChartData 
} from '@/lib/actions/stats';
import { 
  FolderOpen, 
  Image as ImageIcon, 
  Users, 
  CalendarCheck,
  TrendingUp,
  ArrowUpRight
} from 'lucide-react';
import Spinner from '@/components/Spinner';
import TodaySchedule from '@/components/admin/TodaySchedule';
import DashboardActions from '@/components/admin/DashboardActions';
import DashboardFilter from '@/components/admin/DashboardFilter';
import GrowthChart from '@/components/admin/GrowthChart';
import { useSearchParams } from 'next/navigation';

// --- 1. ĐỊNH NGHĨA TYPE CHUẨN ---

// Type cho biểu đồ (khớp với getGrowthChartData)
interface ChartItem {
  name: string;
  total: number;
}

// Type cho lịch trình (khớp với getTodaySchedule)
// Dựa trên query select trong stats.ts
export interface ScheduleItem {
  booking_item_id: number;
  start_dt: string;
  end_dt: string;
  rooms: { 
    name: string | null; 
    code: string | null; 
  } | null;
  bookings: {
    status: 'pending' | 'confirmed' | 'checked_in' | 'completed' | 'cancelled' | null;
    customers: { 
      full_name: string | null; 
      phone: string | null; 
    } | null;
  } | null;
}

interface DashboardStats {
  totalProjects: number;
  newProjects: number;
  totalStaff: number;
  todayBookings: number;
}

interface StatCardProps {
  title: string;
  value: string;
  trend: string;
  trendLabel: string;
  icon: React.ReactNode;
  colorClass: string;
}

// --- 2. COMPONENT CHÍNH ---

export default function AdminDashboard() {
  const searchParams = useSearchParams();
  const currentRange = searchParams.get('range') || '30d';

  const [stats, setStats] = useState<DashboardStats>({
    totalProjects: 0,
    newProjects: 0,
    totalStaff: 0,
    todayBookings: 0
  });

  // --- ÁP DỤNG TYPE Ở ĐÂY ---
  const [todaySchedule, setTodaySchedule] = useState<ScheduleItem[]>([]); 
  const [chartData, setChartData] = useState<ChartItem[]>([]);
  // ---------------------------

  const [loading, setLoading] = useState(true);

  useEffect(() => {
    const fetchData = async () => {
      setLoading(true);
      try {
        // Gọi song song để tối ưu tốc độ
        const [dashboardStats, schedule, chart] = await Promise.all([
          getDashboardStats(currentRange),
          getTodaySchedule(),
          getGrowthChartData(currentRange)
        ]);

        setStats(dashboardStats);
        
        // Ép kiểu an toàn (nếu DB trả về field null không mong muốn)
        setTodaySchedule(schedule as unknown as ScheduleItem[]);
        setChartData(chart);
        
      } catch (error) {
        console.error("Lỗi tải dashboard:", error);
      } finally {
        setLoading(false);
      }
    };

    fetchData();
  }, [currentRange]); // Re-fetch khi đổi filter

  // Helper hiển thị text
  const getTrendLabel = () => {
    if (currentRange === 'today') return 'hôm nay';
    if (currentRange === '7d') return 'trong tuần qua';
    if (currentRange === '30d') return 'trong tháng này';
    if (currentRange === '90d') return 'trong quý này';
    if (currentRange === '12m') return 'trong năm nay';
    return 'từ trước đến nay';
  };

  if (loading) return <div className="h-96 flex items-center justify-center"><Spinner /></div>;

  return (
    <div className="space-y-8 pb-10">
      {/* Header */}
      <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
        <div>
          <h1 className="text-3xl font-bold text-[var(--admin-fg)]">Dashboard</h1>
          <p className="text-[var(--admin-sub)]">Chào mừng trở lại, quản trị viên.</p>
        </div>
        <div className="flex flex-col sm:flex-row gap-3 w-full md:w-auto">
            <DashboardFilter />
            <DashboardActions />
        </div>
      </div>

      {/* Stats Cards Grid */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <StatCard 
          title="Booking Hôm Nay"
          value={stats.todayBookings.toString()}
          trend="Today"
          trendLabel="ca chụp trong ngày"
          icon={<CalendarCheck size={24} className="text-orange-600 dark:text-orange-400" />}
          colorClass="bg-orange-50 dark:bg-orange-900/20"
        />
        <StatCard 
          title="Tổng Dự Án"
          value={stats.totalProjects.toString()}
          trend={`+${stats.newProjects}`}
          trendLabel={getTrendLabel()}
          icon={<FolderOpen size={24} className="text-blue-600 dark:text-blue-400" />}
          colorClass="bg-blue-50 dark:bg-blue-900/20"
        />
        <StatCard 
          title="Dự Án Mới"
          value={stats.newProjects.toString()}
          trend="New"
          trendLabel={getTrendLabel()}
          icon={<ImageIcon size={24} className="text-green-600 dark:text-green-400" />}
          colorClass="bg-green-50 dark:bg-green-900/20"
        />
        <StatCard 
          title="Nhân Sự"
          value={stats.totalStaff.toString()}
          trend="Active"
          trendLabel="đang hoạt động"
          icon={<Users size={24} className="text-purple-600 dark:text-purple-400" />}
          colorClass="bg-purple-50 dark:bg-purple-900/20"
        />
      </div>

      {/* Main Content Grid */}
      <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        {/* CỘT TRÁI (2/3): Biểu đồ */}
        <div className="lg:col-span-2 bg-[var(--admin-card)] p-6 rounded-2xl border border-[var(--admin-border)] shadow-sm min-h-[400px]">
           <div className="flex items-center gap-3 mb-4">
              <div className="p-2 bg-[var(--admin-primary)]/10 rounded-lg text-[var(--admin-primary)]">
                  <TrendingUp size={20} />
              </div>
              <div>
                  <h3 className="text-lg font-bold text-[var(--admin-fg)]">Tăng trưởng Booking</h3>
                  <p className="text-xs text-[var(--admin-sub)]">Số liệu {getTrendLabel()}.</p>
              </div>
           </div>
           
           {chartData.length > 0 ? (
              <GrowthChart data={chartData} />
           ) : (
              <div className="h-[300px] flex items-center justify-center text-[var(--admin-sub)] italic">
                Chưa có dữ liệu trong khoảng thời gian này.
              </div>
           )}
        </div>

        {/* CỘT PHẢI (1/3): Lịch trình hôm nay */}
        <div className="bg-[var(--admin-card)] p-6 rounded-2xl border border-[var(--admin-border)] shadow-sm flex flex-col h-full max-h-[500px]">
           <div className="flex items-center justify-between mb-6">
              <h3 className="font-bold text-[var(--admin-fg)] text-lg">Lịch trình hôm nay</h3>
              <span className="text-xs bg-[var(--admin-primary)]/10 text-[var(--admin-primary)] px-2 py-1 rounded font-bold">
                {new Date().toLocaleDateString('vi-VN', { weekday: 'short', day: 'numeric', month: 'numeric' })}
              </span>
           </div>
           
           <div className="flex-1 overflow-y-auto pr-1 table-scrollbar">
              <TodaySchedule bookings={todaySchedule} />
           </div>
        </div>
      </div>
    </div>
  );
}

// Sub-component StatCard (Giữ nguyên UI)
function StatCard({ title, value, trend, trendLabel, icon, colorClass }: StatCardProps) {
  return (
    <div className="bg-[var(--admin-card)] p-6 rounded-2xl border border-[var(--admin-border)] shadow-sm hover:shadow-md transition-all duration-300 group">
      <div className="flex items-start justify-between mb-4">
        <div className={`p-3 rounded-xl ${colorClass} group-hover:scale-110 transition-transform duration-300`}>
          {icon}
        </div>
        <span className="flex items-center text-xs font-medium text-green-600 bg-green-50 dark:bg-green-900/20 px-2 py-1 rounded-full border border-green-100 dark:border-green-900">
          <ArrowUpRight size={12} className="mr-1" />
          {trend}
        </span>
      </div>
      <div>
        <h3 className="text-sm font-medium text-[var(--admin-sub)]">{title}</h3>
        <div className="mt-1 text-3xl font-bold text-[var(--admin-fg)] tracking-tight">{value}</div>
        <p className="text-xs text-[var(--admin-sub)]/80 mt-2 capitalize">{trendLabel}</p>
      </div>
    </div>
  );
}
</file>

<file path="src/app/admin/projects/new/page.tsx">
// src/app/admin/projects/new/page.tsx
'use client';

import ProjectForm from '@/components/admin/ProjectForm';

export default function NewProjectPage() {
  return <ProjectForm mode="create" />;
}
</file>

<file path="src/app/error.tsx">
// src/app/error.tsx
'use client';

import Container from '@/components/Container';
import Link from 'next/link';
export default function Error({
  reset,
}: {
  error: Error & { digest?: string };
  reset: () => void;
}) {

  return (
    <Container>
      <div className="flex flex-col items-center justify-center text-center py-24 md:py-32 min-h-[calc(100vh_-_250px)]">
        
        {/* Mã lỗi */}
        <span className="text-7xl md:text-9xl font-light tracking-tighter text-[var(--foreground)]">
          Lỗi
        </span>
        
        {/* Tiêu đề */}
        <h1 className="mt-4 text-3xl md:text-4xl font-light tracking-tight">
          Đã có lỗi xảy ra
        </h1>
        
        {/* Mô tả */}
        <p className="mt-2 text-lg text-[var(--sub-text)]">
          Rất tiếc, đã có sự cố ngoài ý muốn. Bạn có thể thử lại.
        </p>

        {/* Nút "Thử Lại"
          Hàm reset() sẽ cố gắng render lại trang một lần nữa.
        */}
        <div className="mt-10 flex flex-col md:flex-row justify-center gap-4">
          
          {/* Nút 1: Thử Lại */}
          <button
            onClick={() => reset()}
            className="py-3 px-8 bg-transparent 
                       border border-[var(--foreground)] 
                       text-[var(--foreground)] 
                       hover:bg-[var(--foreground)] hover:text-[var(--background)] 
                       transition-colors duration-300 cursor-pointer"
          >
            Thử Lại
          </button>
          
          {/* Nút 2: Trang chủ*/}
          <Link
            href="/"
            className="py-3 px-8 bg-transparent 
                       border border-[var(--foreground)] 
                       text-[var(--foreground)] 
                       hover:bg-[var(--foreground)] hover:text-[var(--background)] 
                       transition-colors duration-300 cursor-pointer"
          >
            Quay về Trang chủ
          </Link>
        </div>
      </div>
    </Container>
  );
}
</file>

<file path="src/app/gioi-thieu/page.tsx">
// src/app/gioi-thieu/page.tsx
import type { Metadata } from 'next';
import AboutMilestonesSection from '@/components/AboutMilestonesSection';
import AboutPhilosophySection from '@/components/AboutPhilosophySection';

// 1. Thêm Metadata (SEO) cho trang Giới Thiệu
export const metadata: Metadata = {
  title: 'Giới Thiệu | Oni Studio',
  description: 'Tìm hiểu về hành trình, đội ngũ và triết lý sáng tạo đằng sau Oni Studio, từ những phác thảo đầu tiên đến một xưởng ảnh chuyên nghiệp.',
  openGraph: {
    title: 'Giới Thiệu | Oni Studio',
    description: 'Tìm hiểu về hành trình và triết lý sáng tạo của Oni Studio.',
    // Bạn nên thay thế bằng một ảnh đại diện cho trang Giới Thiệu
    images: ['/assets/about/carousel_04_2025.jpg'], 
  },
};

// 2. Nội dung trang
export default function GioiThieuPage() {
  return (
    <main>
      {/* Section 1: Hành trình (Carousel) */}
      <AboutMilestonesSection />

      <AboutPhilosophySection />

    </main>
  );
}
</file>

<file path="src/app/login/page.tsx">
// src/app/login/page.tsx
'use client';

import React, { useState, useEffect, Suspense } from 'react';
import { useRouter, useSearchParams } from 'next/navigation';
// 1. XÓA dòng import supabase cũ này đi
// import { supabase } from '@/lib/supabase'; 

// 2. THÊM import này để tạo client hỗ trợ Cookie
import { createBrowserClient } from '@supabase/ssr';

import { toast } from 'sonner';
import { Mail, Lock, Loader2, ArrowRight } from 'lucide-react';
import localFont from 'next/font/local'; 

const logoFont = localFont({
  src: '../../fonts/cameliya-regular.ttf',
  display: 'swap',
  variable: '--font-logo',
});
function LoginFormContent() {
  const router = useRouter();
  const searchParams = useSearchParams();
  
  // 3. Khởi tạo Supabase Client có khả năng ghi Cookie
  const supabase = createBrowserClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
  );

  const [formData, setFormData] = useState({
    email: '',
    password: ''
  });
  const [isLoading, setIsLoading] = useState(false);

  // Check login
  useEffect(() => {
    const checkUser = async () => {
      const { data: { session } } = await supabase.auth.getSession();
      if (session) {
        // Refresh router để đảm bảo Server Component nhận được cookie mới
        router.refresh();
        router.replace('/admin');
      }
    };
    checkUser();
  }, [router, supabase]);

const handleLogin = async (e: React.FormEvent) => {
    e.preventDefault();
    setIsLoading(true);

    try {
      // 1. Đăng nhập với Supabase Auth
      const { data, error } = await supabase.auth.signInWithPassword({
        email: formData.email,
        password: formData.password,
      });

      if (error) throw error;
      if (!data.user) throw new Error("Không tìm thấy thông tin người dùng.");

      // 2. KIỂM TRA TRẠNG THÁI 'IS_ACTIVE'
      const { data: userProfile, error: profileError } = await supabase
        .from('users')
        .select('is_active, role')
        .eq('auth_id', data.user.id)
        .single();

      // Nếu không tìm thấy profile hoặc bị khóa
      if (profileError || (userProfile && !userProfile.is_active)) {
        await supabase.auth.signOut();
        throw new Error("Tài khoản của bạn đã bị KHÓA. Vui lòng liên hệ Admin.");
      }

      // 3. Nếu mọi thứ OK -> Cho vào
      toast.success(`Chào mừng trở lại, ${userProfile?.role === 'Admin' ? 'Sếp' : 'bạn'}!`);
      
      const nextUrl = searchParams.get('next');
      router.refresh(); 
      router.replace(nextUrl || '/admin');
      
    } catch (error: unknown) { // Dùng 'any' để dễ truy cập .message
      console.error("Login error:", error);
      
      // --- XỬ LÝ DỊCH LỖI TẠI ĐÂY ---
      let msg = (error as Error).message || 'Đăng nhập thất bại';

      // 1. Lỗi sai mật khẩu hoặc email không tồn tại
      if (msg === 'Invalid login credentials') {
        msg = 'Email hoặc mật khẩu không chính xác.';
      } 
      // 2. Lỗi chưa xác thực email (nếu có bật confirm)
      else if (msg.includes('Email not confirmed')) {
        msg = 'Email chưa được xác thực. Vui lòng kiểm tra hộp thư.';
      }
      // 3. Lỗi quá nhiều lần thử (Rate limit)
      else if (msg.includes('Too many requests') || msg.includes('rate limit')) {
        msg = 'Bạn đã thử quá nhiều lần. Vui lòng đợi giây lát.';
      }
      
      // Nếu là lỗi do mình tự throw ở trên ("Tài khoản bị khóa...") thì nó sẽ giữ nguyên tiếng Việt
      toast.error(msg);
    } finally {
      setIsLoading(false);
    }
  };

  // ... (PHẦN GIAO DIỆN RETURN GIỮ NGUYÊN KHÔNG ĐỔI) ...
  return (
    <div className="min-h-screen flex items-center justify-center bg-[var(--admin-bg)] p-4 transition-colors duration-300">
      <div className="w-full max-w-md bg-[var(--admin-card)] border border-[var(--admin-border)] rounded-2xl shadow-xl p-8 animate-fade-in-up">
        
        {/* Logo / Header */}
        <div className="text-center mb-8">
          <div className={`w-12 h-12 bg-[var(--admin-primary)] rounded-xl flex items-center justify-center text-white font-bold text-2xl mx-auto mb-4 shadow-lg shadow-indigo-500/30 ${logoFont.className}`}>
            O
          </div>
          <h1 className="text-2xl font-bold text-[var(--admin-fg)]">Oni Studio Admin</h1>
          <p className="text-[var(--admin-sub)] mt-2">Đăng nhập để quản lý hệ thống</p>
        </div>

        {/* Form */}
        <form onSubmit={handleLogin} className="space-y-5">
          <div>
            <label className="block text-sm font-medium text-[var(--admin-fg)] mb-1.5">Email</label>
            <div className="relative">
              <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <Mail size={18} className="text-[var(--admin-sub)]" />
              </div>
              <input
                type="email"
                required
                className="w-full pl-10 pr-4 py-2.5 bg-[var(--admin-bg)] border border-[var(--admin-border)] text-[var(--admin-fg)] rounded-lg focus:ring-2 focus:ring-[var(--admin-primary)] focus:border-transparent outline-none transition-all"
                placeholder="admin@onistudio.com"
                value={formData.email}
                onChange={(e) => setFormData({ ...formData, email: e.target.value })}
              />
            </div>
          </div>

          <div>
            <label className="block text-sm font-medium text-[var(--admin-fg)] mb-1.5">Mật khẩu</label>
            <div className="relative">
              <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <Lock size={18} className="text-[var(--admin-sub)]" />
              </div>
              <input
                type="password"
                required
                className="w-full pl-10 pr-4 py-2.5 bg-[var(--admin-bg)] border border-[var(--admin-border)] text-[var(--admin-fg)] rounded-lg focus:ring-2 focus:ring-[var(--admin-primary)] focus:border-transparent outline-none transition-all"
                placeholder="••••••••"
                value={formData.password}
                onChange={(e) => setFormData({ ...formData, password: e.target.value })}
              />
            </div>
          </div>

          <button
            type="submit"
            disabled={isLoading}
            className="w-full py-2.5 cursor-pointer bg-[var(--admin-primary)] text-[var(--admin-primary-fg)] rounded-lg font-medium hover:opacity-90 transition-all shadow-md shadow-indigo-500/25 flex items-center justify-center gap-2 disabled:opacity-70 disabled:cursor-not-allowed"
          >
            {isLoading ? (
              <>
                <Loader2 size={20} className="animate-spin" />
                Đang xác thực...
              </>
            ) : (
              <>
                Đăng nhập
                <ArrowRight size={18} />
              </>
            )}
          </button>
        </form>

        {/* Footer Text */}
        <div className="mt-6 text-center text-xs text-[var(--admin-sub)]">
          <p>Chỉ dành cho nhân viên được cấp quyền.</p>
        </div>
      </div>
    </div>
  );
}

// === COMPONENT CHÍNH (WRAPPER ĐỂ FIX LỖI BUILD) ===
export default function LoginPage() {
  return (
    <Suspense fallback={
      <div className="min-h-screen flex items-center justify-center bg-gray-100 dark:bg-neutral-950">
        <Loader2 className="animate-spin text-indigo-600" size={32} />
      </div>
    }>
      <LoginFormContent />
    </Suspense>
  );
}
</file>

<file path="src/app/providers.tsx">
// src/app/providers.tsx
'use client';

import { ThemeProvider } from 'next-themes';
import { ReactNode } from 'react';

export function Providers({ children }: { children: ReactNode }) {
  return (
    <ThemeProvider attribute="class" storageKey="client-theme" defaultTheme="system" enableSystem>
      {children}
    </ThemeProvider>
  );
}
</file>

<file path="src/components/AboutMilestonesSection.tsx">
// src/components/AboutMilestonesSection.tsx
'use client';

import Image from 'next/image';
import {
  SliderBtnGroup,
  ProgressSlider,
  SliderBtn,
  SliderContent,
  SliderWrapper,
} from '@/components/progressive-carousel'; // Đảm bảo đường dẫn này chính xác
import carousel_01_2020 from '../assets/about/carousel_01_2020.webp';
import carousel_02_2022 from '../assets/about/carousel_02_2022.webp';
import carousel_03_2024 from '../assets/about/carousel_03_2024.webp';
import carousel_04_2025 from '../assets/about/carousel_04_2025.webp';    
import Container from '@/components/Container';


// 1. DỮ LIỆU CÁC CỘT MỐC
// Chúng ta sẽ thay thế dữ liệu mẫu bằng nội dung câu chuyện của Oni Studio
const items = [
  {
    // Sử dụng đường dẫn ảnh từ thư mục /public
    img: carousel_01_2020,
    year: '2020',
    title: 'Phác Thảo Giấc Mơ',
    desc: 'Năm 2020, ý tưởng về Oni Studio được phác thảo, mang theo giấc mơ về một không gian sáng tạo kết hợp giữa studio và café.',
    sliderName: 'milestone-2020', // Tên định danh duy nhất
  },
  {
    img: carousel_02_2022,
    year: '2022',
    title: 'Không Gian Đầu Tiên',
    desc: 'Studio vật lý đầu tiên ra đời. Một không gian tối giản, tinh khôi, tập trung vào việc khai thác vẻ đẹp của ánh sáng tự nhiên.',
    sliderName: 'milestone-2022',
  },
  {
    img: carousel_03_2024,
    year: '2024',
    title: 'Nâng Cấp Toàn Diện',
    desc: 'Studio được mở rộng và trang bị chuyên nghiệp. Từ ánh sáng, phông nền đến thiết bị, tất cả sẵn sàng cho các dự án lớn và dịch vụ cho thuê.',
    sliderName: 'milestone-2024',
  },
  {
    img: carousel_04_2025,
    year: '2025',
    title: 'Định Hình Dịch Vụ',
    desc: 'Oni Studio khẳng định vị thế với dịch vụ cho thuê studio và thiết bị chuyên nghiệp, trở thành một địa chỉ tin cậy cho cộng đồng sáng tạo.',
    sliderName: 'milestone-2025',
  },
];

export default function AboutMilestonesSection() {
  return (
    // Bọc trong 1 <section> để dễ quản lý
    <section id="milestones" className="py-16 md:py-24">
    <Container>
        <div className="container mx-auto px-4 text-center mb-10">
            <h2 className="text-4xl md:text-5xl font-light tracking-tighter">
            Hành Trình Của Oni
            </h2>
            <p className="text-lg text-[var(--foreground)] mt-2">
            Từ ý tưởng đến một studio chuyên nghiệp.
            </p>
        </div>

        {/* 2. ÁP DỤNG COMPONENT CAROUSEL */}
        {/* Đặt activeSlider mặc định là cột mốc đầu tiên */}
        <ProgressSlider vertical={false} activeSlider="milestone-2020">
            
            {/* PHẦN HIỂN THỊ HÌNH ẢNH */}
            <SliderContent>
            {items.map((item, index) => (
                <SliderWrapper key={index} value={item.sliderName}>
                <Image
                    // Đặt chiều cao cố định và object-cover để ảnh đồng đều
                    className="rounded-xl h-[400px] md:h-[700px] w-full object-cover"
                    src={item.img}
                    width={1920} // Giữ chiều rộng lớn
                    height={1080} // Giữ chiều cao lớn
                    alt={item.title} // Dùng title cho alt text
                    priority={index === 0} // Ưu tiên tải ảnh đầu tiên
                    sizes="(max-width: 768px) 100vw, 100vw"
                />
                </SliderWrapper>
            ))}
            </SliderContent>

            {/* PHẦN HIỂN THỊ NỘI DUNG (NÚT BẤM) */}
            {/* Tùy chỉnh styling từ code mẫu cho phù hợp */}
            <SliderBtnGroup className="relative md:absolute bottom-0 h-fit dark:text-white text-black dark:bg-black/40 bg-white/40 backdrop-blur-md overflow-hidden grid grid-cols-2 md:grid-cols-4 rounded-md mt-4 md:mt-0">
            {items.map((item, index) => (
                <SliderBtn
                key={index}
                value={item.sliderName}
                className="text-left p-4 md:p-6 border-r border-white/20"
                progressBarClass="dark:bg-gray-900 bg-black h-full" // Đổi màu thanh progress
                >
                {/* Sử dụng 'year' cho thẻ badge */}
                <h3 className="relative px-4 py-1 rounded-full w-fit dark:bg-white dark:text-black text-white bg-gray-900 mb-3 text-sm font-semibold">
                    {item.year}
                </h3>
                {/* Sử dụng 'title' cho tiêu đề chính */}
                <h2 className="text-lg md:text-xl font-semibold mb-1">
                    {item.title}
                </h2>
                {/* Sử dụng 'desc' cho mô tả */}
                <p className="text-sm font-medium line-clamp-3 md:line-clamp-2">
                    {item.desc}
                </p>
                </SliderBtn>
            ))}
            </SliderBtnGroup>
        </ProgressSlider>
    </Container>
  </section>
);
}
</file>

<file path="src/components/admin/PortfolioGridEditor.tsx">
// src/components/admin/PortfolioGridEditor.tsx
'use client';

import { useState } from 'react';
import Image, { StaticImageData } from 'next/image';
import { toast } from 'sonner';
// Thêm GripVertical vào import
import { Save, RotateCcw, Edit3, Check, MousePointerClick, GripVertical } from 'lucide-react';
import { ProjectData } from '@/data/projects-master-data';
import { updatePortfolioLayout, ProjectGridUpdate } from '@/lib/actions';
//import { supabase } from '../../../lib/supabase';
import { createBrowserClient } from '@supabase/ssr';

// --- IMPORT DND KIT ---
import {
  DndContext,
  closestCenter,
  KeyboardSensor,
  PointerSensor,
  useSensor,
  useSensors,
  DragEndEvent
} from '@dnd-kit/core';
import {
  arrayMove,
  SortableContext,
  rectSortingStrategy
} from '@dnd-kit/sortable';
import { SortableProjectItem } from './SortableProjectItem'; // Component vừa tạo ở B1



interface EditorProps {
  initialProjects: ProjectData[];
}

export default function PortfolioGridEditor({ initialProjects }: EditorProps) {
  const [projects, setProjects] = useState<ProjectData[]>(initialProjects);
  const [supabase] = useState(() => createBrowserClient(
      process.env.NEXT_PUBLIC_SUPABASE_URL!,
      process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
    ));
  const [isEditing, setIsEditing] = useState(false);
  const [isSaving, setIsSaving] = useState(false);
  // Cấu hình cảm biến kéo thả
  // activationConstraint: distance 5px -> Phải kéo 5px mới tính là drag (tránh click nhầm nút resize)
  const sensors = useSensors(
    useSensor(PointerSensor, {
      activationConstraint: {
        distance: 5,
      },
    }),
    useSensor(KeyboardSensor)
  );

  const getImageSrc = (img: string | StaticImageData) => {
    return typeof img === 'string' ? img : img.src;
  };

  // --- LOGIC XỬ LÝ KHI THẢ CHUỘT (DRAG END) ---
  const handleDragEnd = (event: DragEndEvent) => {
    const { active, over } = event;

    if (active.id !== over?.id) {
      setProjects((items) => {
        const oldIndex = items.findIndex((i) => i.id === active.id);
        const newIndex = items.findIndex((i) => i.id === over?.id);
        
        // Hàm này của dnd-kit sẽ đổi chỗ phần tử trong mảng
        return arrayMove(items, oldIndex, newIndex);
      });
    }
  };

  // Logic Resize (Giữ nguyên)
  const handleResize = (id: number, type: 'col' | 'row', delta: number) => {
    setProjects(prev => prev.map(p => {
      if (p.id !== id) return p;
      let newVal = 0;
      if (type === 'col') {
        newVal = Math.max(1, Math.min(3, (p.colSpan || 1) + delta));
        return { ...p, colSpan: newVal };
      } else {
        newVal = Math.max(1, Math.min(4, (p.rowSpan || 1) + delta));
        return { ...p, rowSpan: newVal };
      }
    }));
  };

  // Logic Lưu
  const handleSave = async () => {
    setIsSaving(true);
    try {
      const { data: { session } } = await supabase.auth.getSession();
      
      if (!session) {
        toast.error('Không tìm thấy phiên đăng nhập. Vui lòng F5.');
        return;
      }      
      // Chuẩn bị dữ liệu (Bao gồm cả displayOrder mới dựa trên vị trí index)
      const updates: ProjectGridUpdate[] = projects.map((p, index) => ({
        id: p.id,
        colSpan: p.colSpan || 1,
        rowSpan: p.rowSpan || 1,
        displayOrder: index + 1 // Quan trọng: Index trong mảng state chính là thứ tự hiển thị
      }));

      const res = await updatePortfolioLayout(session.access_token, updates);

      if (res.success) {
        toast.success('Đã lưu bố cục & thứ tự thành công!');
        setIsEditing(false);
      } else {
        toast.error(`Lỗi: ${res.error}`);
      }
    } catch (err) {
      const error = err as Error;
      toast.error(`Lỗi kết nối: ${error.message}`);
    } finally {
      setIsSaving(false);
    }
  };

  const handleReset = () => {
    if (confirm('Khôi phục lại ban đầu?')) setProjects(initialProjects);
  };

  return (
    <div className="space-y-6">
      {/* TOOLBAR */}
      <div className="sticky top-4 z-50 bg-[var(--admin-card)] border border-[var(--admin-border)] p-4 rounded-xl shadow-lg flex flex-col sm:flex-row justify-between items-center gap-4">
        <div className="flex items-center gap-3">
            <div className={`p-2 rounded-lg ${isEditing ? 'bg-indigo-100 text-indigo-600' : 'bg-green-100 text-green-600'}`}>
                {isEditing ? <Edit3 size={20} /> : <Check size={20} />}
            </div>
            <div>
                <h3 className="font-bold text-[var(--admin-fg)]">
                    {isEditing ? 'Chế độ Chỉnh sửa' : 'Chế độ Xem trước'}
                </h3>
                <p className="text-xs text-[var(--admin-sub)]">
                    {isEditing ? 'Kéo thả để sắp xếp. Bấm +/- để chỉnh size.' : 'Giao diện hiển thị giống hệt trang chủ.'}
                </p>
            </div>
        </div>

        <div className="flex gap-2">
          {!isEditing ? (
            <button
              onClick={() => setIsEditing(true)}
              className="px-6 py-2 bg-[var(--admin-primary)] text-white 
              rounded-lg text-sm font-medium hover:opacity-90 flex items-center gap-2 shadow-md cursor-pointer"
            >
              <MousePointerClick size={18} /> Bắt đầu sửa
            </button>
          ) : (
            <>
              <button onClick={handleReset} className="px-3 py-2 text-[var(--admin-sub)] hover:bg-[var(--admin-hover)] rounded-lg border border-transparent hover:border-[var(--admin-border)] cursor-pointer"><RotateCcw size={18} /></button>
              <button onClick={() => setIsEditing(false)} className="px-4 py-2 border border-[var(--admin-border)] text-[var(--admin-fg)] rounded-lg text-sm cursor-pointer">Hủy</button>
              <button onClick={handleSave} disabled={isSaving} className="px-6 py-2 bg-green-600 text-white rounded-lg text-sm font-medium hover:bg-green-700 shadow-md flex items-center gap-2 cursor-pointer">
                {isSaving ? '...' : <><Save size={18} /> Lưu thay đổi</>}
              </button>
            </>
          )}
        </div>
      </div>

      {/* GRID AREA */}
      <div className="border-2 border-dashed border-[var(--admin-border)] p-4 md:p-8 rounded-2xl bg-[var(--background)] min-h-[500px]">
        
        {/* --- DND CONTEXT WRAPPER --- */}
        <DndContext sensors={sensors} collisionDetection={closestCenter} onDragEnd={handleDragEnd}>
          <SortableContext items={projects.map(p => p.id)} strategy={rectSortingStrategy}>
            
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 auto-rows-[300px] md:auto-rows-[400px]">
              {projects.map((project) => (
                
                // Sử dụng Component Sortable Item
                <SortableProjectItem 
                    key={project.id} 
                    id={project.id} 
                    colSpan={project.colSpan || 1} 
                    rowSpan={project.rowSpan || 1}
                >
                  <div className={`relative w-full h-full rounded-lg overflow-hidden transition-all duration-300 ${isEditing ? 'ring-2 ring-offset-2 ring-indigo-500 z-10' : 'border border-transparent'}`}>
                    
                    {/* Hình ảnh */}
                    <div className="relative w-full h-full bg-gray-200 dark:bg-gray-800">
                      {project.image ? (
                          <Image
                          src={getImageSrc(project.image)}
                          alt={project.title}
                          fill
                          className={`object-cover transition-opacity ${isEditing ? 'opacity-40 grayscale' : 'opacity-100'}`}
                          />
                      ) : (
                          <div className="flex items-center justify-center h-full text-xs text-gray-500">No Image</div>
                      )}
                    </div>

                    {/* View Mode Overlay */}
                    {!isEditing && (
                      <div className="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex flex-col justify-end p-6 pointer-events-none">
                          <h3 className="text-xl font-bold text-white line-clamp-2">{project.title}</h3>
                      </div>
                    )}

                    {/* EDIT MODE CONTROLS */}
                    {isEditing && (
                      <div className="absolute inset-0 flex flex-col">
                         {/* --- NÚT KÉO THẢ (DRAG HANDLE) --- */}
                         {/* Class cursor-grab là quan trọng để báo hiệu có thể kéo */}
                         <div className="absolute top-2 right-2 p-2 bg-white text-black rounded cursor-grab active:cursor-grabbing shadow-lg hover:bg-gray-100 z-50">
                            <GripVertical size={20} />
                         </div>

                         {/* Info Badge */}
                         <div className="absolute top-2 left-2 bg-white/90 text-black px-2 py-1 rounded text-[10px] font-mono font-bold shadow-sm border border-gray-200">
                            W:{project.colSpan || 1} | H:{project.rowSpan || 1}
                         </div>

                         {/* Resize Controls (Không bị ảnh hưởng bởi drag) */}
                         <div className="flex-1 flex items-center justify-center gap-4" onPointerDown={(e) => e.stopPropagation()}> 
                            {/* e.stopPropagation() để ngăn việc bấm nút +/- bị hiểu nhầm là bắt đầu kéo */}
                            
                            {/* Width Control */}
                            <div className="flex flex-col items-center gap-1 bg-white/10 backdrop-blur-md p-2 rounded-lg border border-white/20">
                               <span className="text-[10px] font-bold text-white uppercase">Rộng</span>
                               <div className="flex gap-1">
                                  <button onClick={() => handleResize(project.id, 'col', -1)} disabled={(project.colSpan || 1) <= 1} className="w-8 h-8 bg-white text-black rounded font-bold hover:bg-indigo-50">-</button>
                                  <button onClick={() => handleResize(project.id, 'col', 1)} disabled={(project.colSpan || 1) >= 3} className="w-8 h-8 bg-white text-black rounded font-bold hover:bg-indigo-50">+</button>
                               </div>
                            </div>
                            {/* Height Control */}
                            <div className="flex flex-col items-center gap-1 bg-white/10 backdrop-blur-md p-2 rounded-lg border border-white/20">
                               <span className="text-[10px] font-bold text-white uppercase">Cao</span>
                               <div className="flex gap-1">
                                  <button onClick={() => handleResize(project.id, 'row', -1)} disabled={(project.rowSpan || 1) <= 1} className="w-8 h-8 bg-white text-black rounded font-bold hover:bg-indigo-50">-</button>
                                  <button onClick={() => handleResize(project.id, 'row', 1)} disabled={(project.rowSpan || 1) >= 4} className="w-8 h-8 bg-white text-black rounded font-bold hover:bg-indigo-50">+</button>
                               </div>
                            </div>
                         </div>
                         
                         <div className="absolute bottom-2 inset-x-0 text-center text-[10px] text-white/70 font-mono pointer-events-none">
                            {project.title}
                         </div>
                      </div>
                    )}
                  </div>
                </SortableProjectItem>
              ))}
            </div>

          </SortableContext>
        </DndContext>
      </div>
    </div>
  );
}
</file>

<file path="src/components/admin/ProjectForm.tsx">
// src/components/admin/ProjectForm.tsx
'use client';

import React, { useEffect, useState } from 'react';
import { useRouter } from 'next/navigation';
import Image from 'next/image';
// 1. THAY ĐỔI QUAN TRỌNG: Dùng createBrowserClient thay vì client cũ
import { createBrowserClient } from '@supabase/ssr'; 
import { compressImage } from '@/lib/image-utils';
import { toast } from 'sonner';
import { 
  ArrowLeft, Upload, X, Save, Loader2, ImagePlus, Plus, Type, AlignLeft, Trash2 
} from 'lucide-react';
import SelectBox from '@/components/ui/SelectBox';
import { Layers } from 'lucide-react'; // Icon cho đẹp
// --- 1. ĐỊNH NGHĨA TYPES ---

export type FormMode = 'create' | 'edit';

interface Category {
  category_id: number;
  name: string;
}

interface CreditItem {
  label: string;
  value: string;
}

export interface BlockDB {
  type: 'heading' | 'paragraph' | 'imageRow';
  content?: string;
  images?: string[]; 
}

interface ContentBlockState {
  id: string;
  type: 'heading' | 'paragraph' | 'imageRow';
  content: string;
  existingImages: string[]; 
  newFiles: File[];         
  previews: string[];       
}

export interface ProjectInitialData {
  id?: number;
  title: string;
  client_name: string;
  description: string;
  category_id: string; 
  is_featured: boolean;
  thumbnail_url: string;
  credits: CreditItem[];
  content: BlockDB[];
}

interface ProjectFormProps {
  mode: FormMode;
  initialData?: ProjectInitialData;
}

// --- 2. COMPONENT CHÍNH ---

export default function ProjectForm({ mode, initialData }: ProjectFormProps) {
  // 2. KHỞI TẠO CLIENT SUPABASE CÓ COOKIE (Để Upload được)
  const [supabase] = useState(() => createBrowserClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
  ));

  const router = useRouter();
  const [isLoading, setIsLoading] = useState(false);
  const [categories, setCategories] = useState<Category[]>([]);

  // State Form
  const [formData, setFormData] = useState({
    title: '',
    client_name: '',
    description: '',
    category_id: '',
    is_featured: false,
  });

  const [thumbnailFile, setThumbnailFile] = useState<File | null>(null);
  const [thumbnailPreview, setThumbnailPreview] = useState<string | null>(null);
  const fillSampleCredits = () => {
    setCredits([
      { label: 'Producer', value: 'Thanh Hang - Choo Production' },
      { label: 'Art Director', value: 'Thien Nguyen' },
      { label: 'Photographer', value: 'Evis Tran' },
      { label: 'Model', value: 'Mai Phuoc Tri, Nguyễn Văn Long, Huế Hương, Fuka' },
      { label: 'Stylist', value: 'Bao Ngan' },
      { label: 'Stylist Assistant', value: 'Js Chucin' },
      { label: 'Lighting', value: 'An Pham, Huy Tran, Dat Ho Thanh' },
      { label: 'MUA', value: 'Hai Ngoc Nguyen, Tu Anh, Tu Linh' },
      { label: 'Set Designer', value: 'Harry Le, Long Tran' },
      { label: 'Accessories', value: 'Dat Duong' },
      { label: 'Support', value: 'Ngoc Ha' },
      { label: 'Location', value: 'Oni Studio' },
      ]);
  };
  const [credits, setCredits] = useState<CreditItem[]>([{ label: 'Photographer', value: '' }]);
  const [blocks, setBlocks] = useState<ContentBlockState[]>([]);

  // --- 3. KHỞI TẠO DỮ LIỆU ---
  useEffect(() => {
    const fetchCategories = async () => {
      const { data } = await supabase
        .from('portfolio_categories')
        .select('category_id, name')
        .eq('is_active', true)
        .order('display_order');
      if (data) setCategories(data as unknown as Category[]);
    };
    fetchCategories();

    if (mode === 'edit' && initialData) {
      setFormData({
        title: initialData.title || '',
        client_name: initialData.client_name || '',
        description: initialData.description || '',
        category_id: initialData.category_id || '',
        is_featured: initialData.is_featured || false,
      });

      if (initialData.thumbnail_url) {
        setThumbnailPreview(initialData.thumbnail_url);
      }

      if (initialData.credits?.length > 0) {
        setCredits(initialData.credits);
      }

      if (initialData.content?.length > 0) {
        const mappedBlocks: ContentBlockState[] = initialData.content.map((b) => ({
          id: Math.random().toString(36).substr(2, 9),
          type: b.type,
          content: b.content || '',
          existingImages: b.images || [],
          newFiles: [],
          previews: []
        }));
        setBlocks(mappedBlocks);
      }
    }
  }, [mode, initialData, supabase]);

  // --- 4. HELPER FUNCTIONS ---

  const addCredit = () => setCredits([...credits, { label: '', value: '' }]);
  const removeCredit = (index: number) => setCredits(credits.filter((_, i) => i !== index));
  const updateCredit = (index: number, field: keyof CreditItem, value: string) => {
    const newCredits = [...credits];
    newCredits[index][field] = value;
    setCredits(newCredits);
  };

  const addBlock = (type: ContentBlockState['type']) => {
    setBlocks([
      ...blocks, 
      { id: Math.random().toString(36).substr(2, 9), type, content: '', existingImages: [], newFiles: [], previews: [] }
    ]);
  };
  
  const removeBlock = (id: string) => setBlocks(blocks.filter(b => b.id !== id));
  
  const updateBlockContent = (id: string, content: string) => {
    setBlocks(blocks.map(b => b.id === id ? { ...b, content } : b));
  };

  const handleBlockImagesChange = (id: string, files: FileList | null) => {
    if (!files) return;
    const newFilesList = Array.from(files);
    const newPreviewsList = newFilesList.map(f => URL.createObjectURL(f));

    setBlocks(blocks.map(b => {
      if (b.id === id) {
        return {
          ...b,
          newFiles: [...b.newFiles, ...newFilesList],
          previews: [...b.previews, ...newPreviewsList]
        };
      }
      return b;
    }));
  };

  const removeImageFromBlock = (blockId: string, imgIndex: number, isExisting: boolean) => {
    setBlocks(blocks.map(b => {
      if (b.id !== blockId) return b;

      if (isExisting) {
        return { ...b, existingImages: b.existingImages.filter((_, i) => i !== imgIndex) };
      } else {
        const updatedFiles = b.newFiles.filter((_, i) => i !== imgIndex);
        const updatedPreviews = b.previews.filter((_, i) => i !== imgIndex);
        return { ...b, newFiles: updatedFiles, previews: updatedPreviews };
      }
    }));
  };

  // HÀM UPLOAD (Giờ sẽ hoạt động vì client 'supabase' đã có Auth Token)
  const uploadImage = async (file: File, folder: string): Promise<string | null> => {
    try {
      const compressedBlob = await compressImage(file);
      const compressedFile = new File([compressedBlob], file.name, { type: 'image/webp' });
      // Thêm timestamp để tránh trùng tên
      const fileName = `${folder}/${Date.now()}-${Math.random().toString(36).substring(7)}.webp`;
      
      const { error } = await supabase.storage.from('portfolio-images').upload(fileName, compressedFile);
      if (error) throw error;
      
      const { data } = supabase.storage.from('portfolio-images').getPublicUrl(fileName);
      return data.publicUrl;
    } catch (error) {
      console.error('Upload err:', error);
      return null;
    }
  };

  const generateSlug = (str: string) => {
    return str.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[đĐ]/g, 'd').replace(/[^a-z0-9\s-]/g, '').trim().replace(/\s+/g, '-') + '-' + Date.now();
  };

  // --- 5. SUBMIT FORM ---
  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!formData.title || !formData.category_id || (!thumbnailFile && !thumbnailPreview)) {
      toast.warning('Vui lòng điền tên, danh mục và ảnh đại diện.');
      return;
    }

    setIsLoading(true);
    const toastId = toast.loading('Đang xử lý dữ liệu...');

    try {
      // A. Upload Thumbnail
      let finalThumbnailUrl = thumbnailPreview; 
      if (thumbnailFile) {
        const url = await uploadImage(thumbnailFile, 'thumbnails');
        if (!url) throw new Error('Lỗi upload thumbnail');
        finalThumbnailUrl = url;
      }

      // B. Xử lý Content Blocks
      const finalContent = await Promise.all(blocks.map(async (block) => {
        let imageUrls: string[] = [...block.existingImages];

        if (block.type === 'imageRow' && block.newFiles.length > 0) {
          const uploadPromises = block.newFiles.map(file => uploadImage(file, 'gallery'));
          const newUrls = (await Promise.all(uploadPromises)).filter((url): url is string => url !== null);
          imageUrls = [...imageUrls, ...newUrls];
        }

        return {
          type: block.type,
          content: block.content,
          images: imageUrls.length > 0 ? imageUrls : undefined
        };
      }));

      // C. Chuẩn bị Payload
      const payload = {
        title: formData.title,
        client_name: formData.client_name,
        description: formData.description,
        category_id: parseInt(formData.category_id),
        is_featured: formData.is_featured,
        thumbnail_url: finalThumbnailUrl,
        credits: credits.filter(c => c.label && c.value), 
        content: finalContent,
        updated_at: new Date().toISOString(),
        ...(mode === 'create' ? { slug: generateSlug(formData.title) } : {}),
      };

      // D. Insert/Update
      if (mode === 'create') {
        const { data: { user } } = await supabase.auth.getUser();
        const { data: profile } = await supabase.from('users').select('user_id').eq('auth_id', user?.id).single();
        
        const { data, error } = await supabase
          .from('projects')
          .insert({ ...payload, created_by: profile?.user_id })
          .select('project_id')
          .single();
          
        if (error) throw error;
        toast.success('Tạo dự án mới thành công!', { id: toastId });
        
        if (data) router.push(`/admin/projects/${data.project_id}`);

      } else {
        const { error } = await supabase
          .from('projects')
          .update(payload)
          .eq('project_id', initialData?.id);
          
        if (error) throw error;
        toast.success('Cập nhật dự án thành công!', { id: toastId });
        router.refresh();
      }

    } catch (error: unknown) {
      let msg = 'Lỗi không xác định';
      if (error instanceof Error) msg = error.message;
      console.error(error);
      toast.error(`Lỗi: ${msg}`, { id: toastId });
    } finally {
      setIsLoading(false);
    }
  };

  // --- UI RENDER ---
  return (
    <div className="max-w-5xl mx-auto space-y-6 pb-20">
      <div className="flex items-center gap-4 mb-4">
        <button onClick={() => router.push('/admin/projects')} className="p-2 rounded-lg hover:bg-[var(--admin-hover)] text-[var(--admin-sub)] transition-colors">
          <ArrowLeft size={24} />
        </button>
        <div>
            <h1 className="text-2xl font-bold text-[var(--admin-fg)]">
            {mode === 'create' ? 'Thêm Dự án Mới' : 'Chỉnh sửa Dự án'}
            </h1>
            {mode === 'edit' && <p className="text-xs text-[var(--admin-sub)]">ID: {initialData?.id}</p>}
        </div>
      </div>

      <form onSubmit={handleSubmit} className="space-y-8">
        
        {/* INFO CARD */}
        <div className="p-6 bg-[var(--admin-card)] rounded-xl border border-[var(--admin-border)] shadow-sm space-y-6">
          <h2 className="text-lg font-semibold text-[var(--admin-fg)] border-b border-[var(--admin-border)] pb-4">Thông tin cơ bản</h2>
          
          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div className="space-y-2">
              <label className="text-sm font-medium text-[var(--admin-fg)]">Tên Dự án <span className="text-red-500">*</span></label>
              <input required type="text" className="admin-input" value={formData.title} onChange={e => setFormData({...formData, title: e.target.value})} placeholder="VD: Lookbook Summer 2024"/>
            </div>
            <div className="space-y-2">
              <label className="text-sm font-medium text-[var(--admin-fg)]">Khách hàng</label>
              <input type="text" className="admin-input" value={formData.client_name} onChange={e => setFormData({...formData, client_name: e.target.value})} placeholder="VD: Vogue Vietnam"/>
            </div>
            {/* THAY THẾ ĐOẠN SELECT CŨ BẰNG ĐOẠN NÀY */}
            <SelectBox
              label="Danh mục"
              required
              placeholder="-- Chọn danh mục dự án --"
              value={formData.category_id}
              onChange={(val) => setFormData({ ...formData, category_id: val })}
              icon={<Layers size={18} className="text-[var(--admin-sub)]" />}
              // Chuyển đổi mảng categories thành format chuẩn {label, value}
              options={categories.map(cat => ({
                label: cat.name,
                value: cat.category_id
              }))}
            />
            <div className="flex items-center space-x-3 mt-8">
              <input type="checkbox" id="is_featured" className="w-5 h-5 accent-[var(--admin-primary)]" checked={formData.is_featured} onChange={e => setFormData({...formData, is_featured: e.target.checked})} />
              <label htmlFor="is_featured" className="text-sm font-medium text-[var(--admin-fg)] cursor-pointer">Đánh dấu là <strong>Nổi bật</strong></label>
            </div>
          </div>

          <div className="space-y-2">
            <label className="text-sm font-medium text-[var(--admin-fg)]">Mô tả ngắn</label>
            <textarea rows={3} className="admin-input" value={formData.description} onChange={e => setFormData({...formData, description: e.target.value})} placeholder="Giới thiệu sơ lược về dự án..."/>
          </div>
          <div className="space-y-2">
            <label className="text-sm font-medium text-[var(--admin-fg)]">Ảnh đại diện (Thumbnail) 
              <span className="text-red-500">*</span>
              </label>
            
            {/* CONTAINER CHÍNH */}
            {/* Logic: Nếu có thumbnailPreview thì dùng 'h-auto' (cao tự do), ngược lại dùng 'aspect-video' (cố định) */}
            <div className={`
              relative w-full md:w-1/2 bg-[var(--admin-bg)] border-2 border-dashed border-[var(--admin-border)] rounded-lg overflow-hidden group hover:border-[var(--admin-primary)] transition-all duration-300
              ${thumbnailPreview ? 'h-auto' : 'aspect-video'}
            `}>
              
              {/* INPUT FILE (Luôn phủ lên trên cùng z-20 để click được ở mọi chỗ) */}
              <input 
                type="file" 
                accept="image/*" 
                className="absolute inset-0 w-full h-full opacity-0 z-20 cursor-pointer" 
                onChange={(e) => {
                  if(e.target.files?.[0]) {
                    setThumbnailFile(e.target.files[0]);
                    setThumbnailPreview(URL.createObjectURL(e.target.files[0]));
                  }
                }} 
              />

              {thumbnailPreview ? (
                <div className="relative w-full">
                  {/* Dùng thẻ <img> thường với w-full h-auto để container tự giãn theo ảnh */}
                  <Image 
                    src={thumbnailPreview} 
                    alt="Thumb" 
                    width={0} 
                    height={0} 
                    sizes="100vw"
                    className="w-full h-auto block" // Giữ nguyên class này để nó co giãn
                    unoptimized // QUAN TRỌNG: Bắt buộc có dòng này
                  />
                  
                  {/* Overlay hiển thị khi hover */}
                  <div className="absolute inset-0 bg-black/40 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity z-10">
                    <p className="text-white text-sm font-medium flex items-center gap-2">
                      <Upload size={16}/> Thay ảnh khác
                    </p>
                  </div>
                </div>
              ) : (
                /* Giao diện khi chưa có ảnh (Căn giữa trong khung aspect-video) */
                <div className="flex flex-col items-center justify-center h-full text-[var(--admin-sub)] group-hover:text-[var(--admin-primary)] transition-colors">
                  <ImagePlus size={32} className="mb-2" />
                  <span className="text-sm">Bấm để chọn ảnh</span>
                </div>
              )}
            </div>
          </div>
        </div>

        {/* CREDITS CARD */}
        <div className="p-6 bg-[var(--admin-card)] rounded-xl border border-[var(--admin-border)] shadow-sm space-y-4">
          <div className="flex justify-between items-center border-b border-[var(--admin-border)] pb-4">
          <h2 className="text-lg font-semibold text-[var(--admin-fg)]">Credits</h2>
          <div className="flex gap-2">
              {/* Nút điền mẫu */}
              <button type="button" onClick={fillSampleCredits} className="cursor-pointer text-sm text-[var(--admin-sub)] hover:text-white px-3 py-1.5 rounded-lg border border-[var(--admin-border)] hover:bg-[var(--admin-hover)] transition-colors">
                Điền mẫu
              </button>

              {/* Nút thêm dòng cũ */}
              <button type="button" onClick={addCredit} className="cursor-pointer text-sm text-[var(--admin-primary)] hover:bg-[var(--admin-hover)] px-3 py-1.5 rounded-lg flex items-center gap-1 transition-colors">
                  <Plus size={16}/> Thêm dòng
              </button>
          </div>
        </div>
          <div className="space-y-3">
            {credits.map((item, idx) => (
              <div key={idx} className="flex gap-4 items-center">
                <input placeholder="Vai trò (VD: Photo)" className="admin-input w-1/3" value={item.label} onChange={e => updateCredit(idx, 'label', e.target.value)} />
                <input placeholder="Tên (VD: Dang Tran)" className="admin-input w-1/2" value={item.value} onChange={e => updateCredit(idx, 'value', e.target.value)} />
                <button type="button" onClick={() => removeCredit(idx)} className="text-red-400 cursor-pointer hover:text-red-600 p-2 hover:bg-red-50 rounded-lg transition-colors"><Trash2 size={18} /></button>
              </div>
            ))}
          </div>
        </div>

        {/* CONTENT BUILDER */}
        <div className="p-6 bg-[var(--admin-card)] rounded-xl border border-[var(--admin-border)] shadow-sm space-y-6">
          <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center border-b border-[var(--admin-border)] pb-4 gap-4">
            <h2 className="text-lg font-semibold text-[var(--admin-fg)]">Nội dung bài viết</h2>
            <div className="flex gap-2">
              <button type="button" onClick={() => addBlock('heading')} className="btn-tool"><Type size={16}/> Tiêu đề</button>
              <button type="button" onClick={() => addBlock('paragraph')} className="btn-tool"><AlignLeft size={16}/> Đoạn văn</button>
              <button type="button" onClick={() => addBlock('imageRow')} className="btn-tool"><ImagePlus size={16}/> Hàng ảnh</button>
            </div>
          </div>

          <div className="space-y-6 min-h-[200px] bg-[var(--admin-bg)] p-4 rounded-lg border border-[var(--admin-border)]">
             {blocks.length === 0 && (
                <div className="flex flex-col items-center justify-center py-10 text-[var(--admin-sub)] opacity-60">
                    <AlignLeft size={48} className="mb-2" />
                    <p>Chưa có nội dung.</p>
                </div>
             )}
             
             {blocks.map((block, index) => (
               <div key={block.id} className="relative group bg-[var(--admin-card)] border border-[var(--admin-border)] rounded-lg p-6 shadow-sm transition-all hover:shadow-md">
                 <div className="absolute -left-3 -top-3 bg-[var(--admin-fg)] text-[var(--admin-bg)] text-[10px] font-bold px-2 py-1 rounded shadow uppercase tracking-wider">
                   {index + 1}. {block.type}
                 </div>
                 
                 <button type="button" onClick={() => removeBlock(block.id)} className="absolute top-2 right-2 text-[var(--admin-sub)] hover:text-red-500 hover:bg-[var(--admin-bg)] p-1.5 rounded-lg transition-all opacity-0 group-hover:opacity-100">
                    <X size={18}/>
                 </button>

                 <div className="mt-2">
                    {block.type === 'heading' && (
                        <input type="text" placeholder="Nhập tiêu đề section..." className="w-full text-xl font-bold bg-transparent border-b border-[var(--admin-border)] focus:border-[var(--admin-primary)] outline-none pb-2 text-[var(--admin-fg)]" value={block.content} onChange={e => updateBlockContent(block.id, e.target.value)} />
                    )}
                    
                    {block.type === 'paragraph' && (
                        <textarea rows={4} placeholder="Nhập nội dung đoạn văn..." className="w-full bg-[var(--admin-bg)] rounded p-3 resize-y outline-none text-[var(--admin-fg)] border border-transparent focus:border-[var(--admin-border)] transition-colors" value={block.content} onChange={e => updateBlockContent(block.id, e.target.value)} />
                    )}
                    
                    {block.type === 'imageRow' && (
                    <div>
                        <div className="grid grid-cols-2 sm:grid-cols-4 md:grid-cols-5 gap-4">
                            {/* ẢNH CŨ */}
                            {block.existingImages.map((src, i) => (
                                <div key={`exist-${i}`} className="relative aspect-square rounded-lg overflow-hidden border-2 border-green-500/50 group/img">
                                    <Image src={src} alt="exist" fill className="object-cover" />
                                    <div className="absolute inset-0 bg-black/0 group-hover/img:bg-black/20 transition-colors" />
                                    <button type="button" onClick={() => removeImageFromBlock(block.id, i, true)} className="absolute top-1 right-1 bg-red-500 text-white rounded-full p-1 opacity-0 group-hover/img:opacity-100 transition-opacity shadow-sm">
                                        <X size={12}/>
                                    </button>
                                </div>
                            ))}
                            {/* ẢNH MỚI */}
                            {block.previews.map((src, i) => (
                                <div key={`new-${i}`} className="relative aspect-square rounded-lg overflow-hidden border-2 border-blue-500/50 group/img">
                                    <Image src={src} alt="new" fill className="object-cover" />
                                    <div className="absolute inset-0 bg-black/0 group-hover/img:bg-black/20 transition-colors" />
                                    <button type="button" onClick={() => removeImageFromBlock(block.id, i, false)} className="absolute top-1 right-1 bg-red-500 text-white rounded-full p-1 opacity-0 group-hover/img:opacity-100 transition-opacity shadow-sm">
                                        <X size={12}/>
                                    </button>
                                </div>
                            ))}
                            <label className="flex flex-col items-center justify-center aspect-square border-2 border-dashed border-[var(--admin-border)] rounded-lg hover:bg-[var(--admin-hover)] hover:border-[var(--admin-primary)] cursor-pointer transition-all text-[var(--admin-sub)] hover:text-[var(--admin-primary)]">
                                <Upload size={24} className="mb-1"/>
                                <span className="text-xs font-medium">Thêm ảnh</span>
                                <input type="file" multiple accept="image/*" className="hidden" onChange={e => handleBlockImagesChange(block.id, e.target.files)} />
                            </label>
                        </div>
                    </div>
                    )}
                 </div>
               </div>
             ))}
          </div>
        </div>

        <div className="flex justify-end pt-6 border-t border-[var(--admin-border)] sticky bottom-0 bg-[var(--admin-bg)] py-4 z-20">
          <button type="submit" disabled={isLoading} className="flex items-center gap-2 px-8 py-3 bg-[var(--admin-primary)] text-white rounded-lg hover:opacity-90 shadow-lg shadow-indigo-500/30 font-medium disabled:opacity-70 transition-all transform hover:-translate-y-0.5">
            {isLoading ? <Loader2 className="animate-spin" /> : <Save size={20}/>} 
            {mode === 'create' ? 'Lưu & Tạo mới' : 'Cập nhật thay đổi'}
          </button>
        </div>
      </form>

      <style jsx global>{`
        .admin-input { width: 100%; padding: 0.75rem; background-color: var(--admin-bg); border: 1px solid var(--admin-border); border-radius: 0.5rem; outline: none; color: var(--admin-fg); transition: all 0.2s; }
        .admin-input:focus { border-color: var(--admin-primary); ring: 2px solid var(--admin-primary); }
        .btn-tool { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background-color: var(--admin-bg); border: 1px solid var(--admin-border); border-radius: 0.5rem; font-size: 0.875rem; color: var(--admin-fg); transition: all 0.2s; font-weight: 500; }
        .btn-tool:hover { background-color: var(--admin-hover); border-color: var(--admin-primary); color: var(--admin-primary); transform: translateY(-1px); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
      `}</style>
    </div>
  );
}
</file>

<file path="src/components/admin/ProjectTable.tsx">
// src/components/admin/ProjectTable.tsx
'use client';

import React, { useState, useEffect, useMemo } from 'react';
import Image from 'next/image';
import Link from 'next/link';
import { Edit, Eye, Trash2, Search, Loader2, ArrowUpDown, ArrowDown, ArrowUp } from 'lucide-react';
import { useInView } from 'react-intersection-observer'; // Cần cài: npm install react-intersection-observer
import { toast } from 'sonner';
import { deleteProject, UserProfile } from '@/lib/actions';
import { createBrowserClient } from '@supabase/ssr';
import ConfirmModal from '@/components/ui/ConfirmModal';
import { ProjectData } from '@/data/projects-master-data';

interface ProjectTableProps {
  initialProjects: ProjectData[];
  itemsPerPage: number;
  userProfile: UserProfile | null;
}
// Định nghĩa các kiểu sort
type SortKey = 'id' | 'title' | 'categoryName' | 'isFeatured';
type SortDirection = 'asc' | 'desc';

interface SortConfig {
  key: SortKey;
  direction: SortDirection;
}

export default function ProjectTable({ initialProjects, itemsPerPage, userProfile }: ProjectTableProps) {
  // State Data
  const [projects, setProjects] = useState<ProjectData[]>(initialProjects);
  const [searchQuery, setSearchQuery] = useState('');
  // State Sort
  const [sortConfig, setSortConfig] = useState<SortConfig>({ key: 'id', direction: 'desc' });
  // State Pagination
  const [visibleCount, setVisibleCount] = useState(itemsPerPage);
  const { ref, inView } = useInView(); // Ref để gắn vào element đáy trang

  // State Delete Modal
  const [deleteModalOpen, setDeleteModalOpen] = useState(false);
  const [projectToDelete, setProjectToDelete] = useState<{ id: number, title: string } | null>(null);
  const [isDeleting, setIsDeleting] = useState(false);

  const supabase = createBrowserClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
  );

  // Hàm xử lý sắp xếp
  const handleSort = (key: SortKey) => {
    setSortConfig((current) => {
      if (current.key === key) {
        // Nếu đang click cột hiện tại -> Đảo chiều
        return { key, direction: current.direction === 'asc' ? 'desc' : 'asc' };
      }
      // Nếu click cột mới -> Mặc định tăng dần (A-Z)
      return { key, direction: 'asc' };
    });
  };
  // 3. LOGIC LỌC & SẮP XẾP (Dùng useMemo để tối ưu)
  const processedProjects = useMemo(() => {
    // A. Lọc theo Search
    const result = projects.filter(p => 
      p.title.toLowerCase().includes(searchQuery.toLowerCase()) ||
      p.client_name?.toLowerCase().includes(searchQuery.toLowerCase()) ||
      p.categoryName?.toLowerCase().includes(searchQuery.toLowerCase())
    );

    // B. Sắp xếp
    result.sort((a, b) => {
      const aValue = a[sortConfig.key];
      const bValue = b[sortConfig.key];

      // Xử lý trường hợp null/undefined
      if (aValue === undefined || aValue === null) return 1;
      if (bValue === undefined || bValue === null) return -1;

      // So sánh
      if (aValue < bValue) return sortConfig.direction === 'asc' ? -1 : 1;
      if (aValue > bValue) return sortConfig.direction === 'asc' ? 1 : -1;
      return 0;
    });

    return result;
  }, [projects, searchQuery, sortConfig]);

  // 2. Cắt danh sách để hiển thị (Infinite Scroll)
  const visibleProjects = processedProjects.slice(0, visibleCount);

  // 3. Tự động load thêm khi cuộn xuống đáy
  useEffect(() => {
    if (inView && visibleCount < processedProjects.length) {
      // Delay nhẹ để tạo cảm giác đang load (optional)
      const timer = setTimeout(() => {
        setVisibleCount(prev => prev + itemsPerPage);
      }, 300);
      return () => clearTimeout(timer);
    }
  }, [inView, visibleCount, processedProjects.length, itemsPerPage]);

  // Reset pagination khi search thay đổi
  useEffect(() => {
    setVisibleCount(itemsPerPage);
  }, [searchQuery, itemsPerPage]);

  // 4. Logic Xóa Dự án
  const openDeleteModal = (id: number, title: string) => {
    setProjectToDelete({ id, title });
    setDeleteModalOpen(true);
  };

  const handleDeleteConfirm = async () => {
    if (!projectToDelete) return;
    setIsDeleting(true);
    try {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) {
        toast.error("Hết phiên đăng nhập");
        return;
      }

      const res = await deleteProject(session.access_token, projectToDelete.id);
      if (res.success) {
        toast.success("Đã xóa dự án");
        // Cập nhật UI ngay lập tức (Không cần reload trang)
        setProjects(prev => prev.filter(p => p.id !== projectToDelete.id));
        setDeleteModalOpen(false);
      } else {
        toast.error(res.error);
      }
    } catch (error) {
        const msg = error instanceof Error ? error.message : "Lỗi hệ thống";
        toast.error(msg);
    } finally {
      setIsDeleting(false);
    }
  };
  // Component Header nhỏ để tái sử dụng
  const SortableHeader = ({ label, colKey, className = "" }: { label: string, colKey: SortKey, className?: string }) => {
    const isActive = sortConfig.key === colKey;
    return (
      <th 
        className={`p-4 cursor-pointer hover:bg-[var(--admin-hover)] transition-colors group select-none ${className}`}
        onClick={() => handleSort(colKey)}
      >
        <div className={`flex items-center gap-2 ${className.includes('text-center') ? 'justify-center' : ''}`}>
          {label}
          <span className={`text-[var(--admin-sub)] transition-opacity ${isActive ? 'opacity-100 text-[var(--admin-primary)]' : 'opacity-0 group-hover:opacity-50'}`}>
            {isActive ? (
              sortConfig.direction === 'asc' ? <ArrowUp size={14} /> : <ArrowDown size={14} />
            ) : (
              <ArrowUpDown size={14} />
            )}
          </span>
        </div>
      </th>
    );
  };
  return (
    <div className="space-y-6">
      
      {/* Toolbar */}
      <div className="flex gap-3 p-1 bg-[var(--admin-card)] rounded-xl border border-[var(--admin-border)] p-4 shadow-sm">
        <div className="relative flex-1">
            <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-[var(--admin-sub)]" size={18} />
            <input 
              type="text" 
              placeholder="Tìm kiếm dự án, khách hàng..." 
              className="w-full pl-10 pr-4 py-2.5 bg-[var(--admin-bg)] border border-[var(--admin-border)] rounded-lg text-sm outline-none focus:border-[var(--admin-primary)] text-[var(--admin-fg)] transition-all" 
              value={searchQuery}
              onChange={(e) => setSearchQuery(e.target.value)}
            />
        </div>
        <div className="text-sm text-[var(--admin-sub)] flex items-center px-3 bg-[var(--admin-bg)] rounded-lg border border-[var(--admin-border)]">
            {processedProjects.length} kết quả
        </div>
      </div>

      {/* Table */}
      <div className="bg-[var(--admin-card)] border border-[var(--admin-border)] rounded-xl overflow-hidden shadow-sm">
        <div className="overflow-x-auto">
          <table className="w-full text-left border-collapse">
            <thead>
              <tr className="bg-[var(--admin-bg)] border-b border-[var(--admin-border)] text-[var(--admin-sub)] text-xs uppercase tracking-wider">
                {/* 4. ÁP DỤNG SORTABLE HEADER */}
                <SortableHeader label="#ID" colKey="id" className="w-20 font-mono" />
                <th className="p-4 w-24">Ảnh</th>
                <SortableHeader label="Tên Dự Án" colKey="title" />
                <SortableHeader label="Danh Mục" colKey="categoryName" />
                <SortableHeader label="Trạng Thái" colKey="isFeatured" className="text-center" />
                <th className="p-4 text-right">Hành động</th>
              </tr>
            </thead>
            <tbody className="divide-y divide-[var(--admin-border)]">
              {visibleProjects.length === 0 ? (
                <tr>
                    <td colSpan={6} className="p-12 text-center text-[var(--admin-sub)] italic">
                        Không tìm thấy dự án nào.
                    </td>
                </tr>
              ) : (
                visibleProjects.map((project, index) => (
                  <tr key={project.id} className="hover:bg-[var(--admin-hover)] transition-colors group animate-fade-in-row"
                    // 3. TÍNH TOÁN ĐỘ TRỄ (STAGGER DELAY)
                    // index % itemsPerPage giúp reset delay khi qua trang mới (nếu có pagination) 
                    // hoặc chỉ đơn giản là index * 50ms
                    style={{ 
                      animationDelay: `${(index % itemsPerPage) * 0.05}s` 
                    }}>
                    <td className="p-4 text-xs text-[var(--admin-sub)] font-mono">#{project.id}</td>
                    <td className="p-4">
                      <div className="relative w-16 h-10 bg-gray-200 rounded overflow-hidden border border-[var(--admin-border)]">
                        {project.image ? (
                           <Image 
                             src={typeof project.image === 'string' ? project.image : project.image.src} 
                             alt={project.title} 
                             fill 
                             className="object-cover" 
                           />
                        ) : <div className="w-full h-full flex items-center justify-center text-[8px]">NO IMG</div>}
                      </div>
                    </td>
                    <td className="p-4">
                      <Link href={`/admin/projects/${project.id}`} className="font-medium text-[var(--admin-fg)] hover:text-[var(--admin-primary)] transition-colors block mb-0.5">
                        {project.title}
                      </Link>
                      <span className="text-xs text-[var(--admin-sub)]">{project.client_name}</span>
                    </td>
                    <td className="p-4">
                      <span className="inline-flex px-2.5 py-1 rounded-full text-xs font-medium bg-[var(--admin-bg)] border border-[var(--admin-border)] text-[var(--admin-fg)]">
                        {project.categoryName}
                      </span>
                    </td>
                    <td className="p-4 text-center">
                      {project.isFeatured && (
                        <span className="inline-flex items-center px-2 py-0.5 rounded text-[10px] font-bold bg-yellow-100 text-yellow-800 border border-yellow-200 shadow-sm">
                          NỔI BẬT
                        </span>
                      )}
                    </td>
                    <td className="p-4 text-right">
                      <div className="flex items-center justify-end gap-2 opacity-100 sm:opacity-0 sm:group-hover:opacity-100 transition-opacity">
                        <Link 
                          href={`/du-an/${project.slug}`} 
                          target="_blank"
                          className="p-2 text-[var(--admin-sub)] hover:text-[var(--admin-fg)] hover:bg-[var(--admin-card)] rounded-lg"
                          title="Xem trang web"
                        >
                          <Eye size={18} />
                        </Link>
                        
                        <Link 
                          href={`/admin/projects/${project.id}`} 
                          className="p-2 text-blue-500 hover:bg-[var(--admin-edit)] rounded-lg"
                          title="Chỉnh sửa"
                        >
                          <Edit size={18} />
                        </Link>
                        {/* CHỈ ADMIN MỚI THẤY */}
                        {userProfile?.role === 'Admin' && (
                          <>
                            <button 
                              onClick={() => openDeleteModal(Number(project.id), project.title)}
                              className="p-2 text-red-500 hover:bg-[var(--admin-delete)] rounded-lg cursor-pointer"
                              title="Xóa"
                            >
                              <Trash2 size={18} />
                            </button>
                           </>
                        )}
                        
                      </div>
                    </td>
                  </tr>
                ))
              )}
            </tbody>
          </table>
          
          {/* LOADER DƯỚI CÙNG ĐỂ KÍCH HOẠT LOAD MORE */}
          {visibleProjects.length < processedProjects.length && (
             <div ref={ref} className="p-4 flex justify-center">
                <Loader2 className="animate-spin text-[var(--admin-sub)]" />
             </div>
          )}
        </div>
      </div>

      {/* DELETE CONFIRM MODAL */}
      <ConfirmModal 
        isOpen={deleteModalOpen}
        onClose={() => !isDeleting && setDeleteModalOpen(false)}
        onConfirm={handleDeleteConfirm}
        title="Xóa dự án này?"
        description={`Bạn có chắc chắn muốn xóa dự án "${projectToDelete?.title}"? Hành động này sẽ xóa vĩnh viễn toàn bộ thông tin và hình ảnh liên quan.`}
        confirmText={isDeleting ? "Đang xóa..." : "Xóa vĩnh viễn"}
        cancelText="Đóng"
        variant="danger"
        isLoading={isDeleting}
      />
    </div>
  );
}
</file>

<file path="src/components/AnimatedProfileImage.tsx">
// src/components/AnimatedProfileImage.tsx
'use client'; 

import { motion } from 'framer-motion';
import React from 'react';

export default function AnimatedProfileImage({ children }: { children: React.ReactNode }) {
  return (
    <motion.div
      className="w-full max-w-sm md:max-w-none bg-[var(--background)] shadow-2x"
      initial={{ opacity: 0, y: 20 }}
      whileInView={{ opacity: 1, y: 0 }}
      transition={{ duration: 0.5 }}
      viewport={{ once: true, amount: 0.3 }}
    >
      {children}
    </motion.div>
  );
}
</file>

<file path="src/components/BrandScroller.tsx">
// src/components/BrandScroller.tsx
import React from 'react';
import Container from './Container';

// 1. CẬP NHẬT MÀU SẮC ICON
const brands = [
  {
    href: 'https://x.com',
    svg: (
      <svg width="120" height="109" viewBox="0 0 120 109" fill="none" xmlns="http://www.w3.org/2000/svg" 
           className="fill-[#ebebeb] dark:fill-gray-950 w-8 h-8"> {/* <-- THAY ĐỔI MÀU FILL */}
        <path d="M94.5068 0H112.907L72.7076 46.172L120 109H82.9692L53.9674 70.8942L20.7818 109H2.3693L45.3666 59.6147L0 0H37.9685L64.1848 34.8292L94.5068 0ZM88.0484 97.9318H98.2448L32.4288 10.4872H21.4882L88.0484 97.9318Z" />
      </svg>
    ),
  },
  {
    href: 'https://www.youtube.com',
    svg: (
      <svg width="206" height="143" viewBox="0 0 206 143" fill="none" xmlns="http://www.w3.org/2000/svg" 
           className="fill-[#ebebeb] dark:fill-gray-950 w-9 h-9"> {/* <-- THAY ĐỔI MÀU FILL */}
        <path fillRule="evenodd" clipRule="evenodd" d="M82.4536 97.9153V40.5946C102.803 50.1698 118.563 59.4196 137.202 69.3921C121.829 77.9181 102.803 87.4845 82.4536 97.9153ZM195.858 12.0864C192.348 7.46178 186.366 3.86191 179.996 2.6701C161.275 -0.884977 44.4825 -0.895089 25.7716 2.6701C20.664 3.62759 16.1159 5.94198 12.2089 9.53781C-4.25342 24.8174 0.905084 106.757 4.87314 120.03C6.54174 125.775 8.69882 129.918 11.4154 132.638C14.9154 136.234 19.7075 138.709 25.2119 139.82C40.6263 143.008 120.038 144.791 179.671 140.299C185.165 139.341 190.028 136.785 193.864 133.037C209.085 117.818 208.047 31.2775 195.858 12.0864Z" />
      </svg>
    ),
  },
  {
    href: 'https://github.com',
    svg: (
      <svg width="202" height="202" viewBox="0 0 202 202" fill="none" xmlns="http://www.w3.org/2000/svg" 
           className="fill-[#ebebeb] dark:fill-gray-950 w-9 h-9"> {/* <-- THAY ĐỔI MÀU FILL */}
        <path fillRule="evenodd" clipRule="evenodd" d="M101 0C156.782 0 202 46.3583 202 103.555C202 149.297 173.094 188.102 132.987 201.808C127.866 202.828 126.048 199.594 126.048 196.837C126.048 193.423 126.169 182.273 126.169 168.416C126.169 158.76 122.937 152.458 119.311 149.246C141.804 146.681 165.438 137.923 165.438 98.1495C165.438 86.8375 161.519 77.6066 155.035 70.3548C156.085 67.7389 159.55 57.2059 154.045 42.9447C154.045 42.9447 145.581 40.1699 126.3 53.5625C118.231 51.2698 109.585 50.1163 101 50.0759C92.415 50.1163 83.7795 51.2698 75.7197 53.5625C56.4186 40.1699 47.9346 42.9447 47.9346 42.9447C42.4503 57.2059 45.9146 67.7389 46.9549 70.3548C40.501 77.6066 36.5519 86.8375 36.5519 98.1495C36.5519 137.822 60.1354 146.714 82.5675 149.33C79.6789 151.916 77.063 156.477 76.154 163.173C70.397 165.819 55.7722 170.399 46.763 154.572C46.763 154.572 41.4201 144.623 31.2797 143.895C31.2797 143.895 21.4322 143.765 30.5929 150.188C30.5929 150.188 37.2084 153.37 41.8039 165.338C41.8039 165.338 47.7326 183.821 75.8308 177.559C75.8813 186.214 75.9722 194.372 75.9722 196.837C75.9722 199.574 74.1138 202.777 69.0739 201.818C28.9365 188.132 0 149.308 0 103.555C0 46.3583 45.2278 0 101 0Z" />
      </svg>
    ),
  },
  {
    href: 'https://instagram.com', // <-- Thay link
    svg: (
      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"
           className="fill-[#ebebeb] dark:fill-gray-950 w-8 h-8">
        <path fillRule="evenodd" clipRule="evenodd" d="M12 7.00004C9.23858 7.00004 7 9.23862 7 12.0001C7 14.7615 9.23858 17.0001 12 17.0001C14.7614 17.0001 17 14.7615 17 12.0001C17 9.23862 14.7614 7.00004 12 7.00004ZM9 12.0001C9 10.3432 10.3431 9.00004 12 9.00004C13.6569 9.00004 15 10.3432 15 12.0001C15 13.6569 13.6569 15.0001 12 15.0001C10.3431 15.0001 9 13.6569 9 12.0001Z" />
        <path d="M18 5.00002C17.4477 5.00002 17 5.44774 17 6.00002C17 6.5523 17.4477 7.00002 18 7.00002C18.5523 7.00002 19 6.5523 19 6.00002C19 5.44774 18.5523 5.00002 18 5.00002Z" />
        <path fillRule="evenodd" clipRule="evenodd" d="M5 1.00002C2.79086 1.00002 1 2.79088 1 5.00002V19.0001C1 21.2092 2.79086 23.0001 5 23.0001H19C21.2091 23.0001 23 21.2092 23 19.0001V5.00002C23 2.79088 21.2091 1.00002 19 1.00002H5ZM5 3.00002C3.89543 3.00002 3 3.89545 3 5.00002V19.0001C3 20.1046 3.89543 21.0001 5 21.0001H19C20.1046 21.0001 21 20.1046 21 19.0001V5.00002C21 3.89545 20.1046 3.00002 19 3.00002H5Z" />
      </svg>
    ),
  },
 {
    href: 'https://facebook.com', // <-- Thay link
    svg: (
      <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"
           className="fill-[#ebebeb] dark:fill-gray-950 w-8 h-8">
        <path d="M14,6h3a1,1,0,0,0,1-1V3a1,1,0,0,0-1-1H14A5,5,0,0,0,9,7v3H7a1,1,0,0,0-1,1v2a1,1,0,0,0,1,1H9v7a1,1,0,0,0,1,1h2a1,1,0,0,0,1-1V14h2.22a1,1,0,0,0,1-.76l.5-2a1,1,0,0,0-1-1.24H13V7A1,1,0,0,1,14,6Z"></path>
      </svg>
    )
  },
    {
    href: 'https://tiktok.com', // <-- Thay link
    svg: (
      <svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg"
           className="fill-[#ebebeb] dark:fill-gray-950 w-8 h-8">
        <path d="M16.656 1.029c1.637-0.025 3.262-0.012 4.886-0.025 0.054 2.031 0.878 3.859 2.189 5.213l-0.002-0.002c1.411 1.271 3.247 2.095 5.271 2.235l0.028 0.002v5.036c-1.912-0.048-3.71-0.489-5.331-1.247l0.082 0.034c-0.784-0.377-1.447-0.764-2.077-1.196l0.052 0.034c-0.012 3.649 0.012 7.298-0.025 10.934-0.103 1.853-0.719 3.543-1.707 4.954l0.020-0.031c-1.652 2.366-4.328 3.919-7.371 4.011l-0.014 0c-0.123 0.006-0.268 0.009-0.414 0.009-1.73 0-3.347-0.482-4.725-1.319l0.040 0.023c-2.508-1.509-4.238-4.091-4.558-7.094l-0.004-0.041c-0.025-0.625-0.037-1.25-0.012-1.862 0.49-4.779 4.494-8.476 9.361-8.476 0.547 0 1.083 0.047 1.604 0.136l-0.056-0.008c0.025 1.849-0.050 3.699-0.050 5.548-0.423-0.153-0.911-0.242-1.42-0.242-1.868 0-3.457 1.194-4.045 2.861l-0.009 0.030c-0.133 0.427-0.21 0.918-0.21 1.426 0 0.206 0.013 0.41 0.037 0.61l-0.002-0.024c0.332 2.046 2.086 3.59 4.201 3.59 0.061 0 0.121-0.001 0.181-0.004l-0.009 0c1.463-0.044 2.733-0.831 3.451-1.994l0.010-0.018c0.267-0.372 0.45-0.822 0.511-1.311l0.001-0.014c0.125-2.237 0.075-4.461 0.087-6.698 0.012-5.036-0.012-10.060 0.025-15.083z"></path>
      </svg>
    )
  },
  {
    href: 'https://behance.net', // <-- Thay link
    svg: (
      <svg viewBox="0 0 95.802 95.802" xmlns="http://www.w3.org/2000/svg"
           className="fill-[#ebebeb] dark:fill-gray-950 w-9 h-9"> {/* <-- Cỡ w-9 h-9 cho cân đối */}
        <g>
          <path d="M38.664,44.689c0,0,9.065-0.673,9.065-11.306c0-10.632-7.417-15.819-16.813-15.819H13.622h-0.508H0v59.414h13.114h0.508 h17.294c0,0,18.873,0.597,18.873-17.536C49.79,59.442,50.613,44.689,38.664,44.689z M13.622,28.125h15.069h2.226 c0,0,4.203,0,4.203,6.181c0,6.181-2.473,7.077-5.275,7.077H13.622V28.125z M30.119,66.42H13.622V50.541h17.294 c0,0,6.264-0.08,6.264,8.16C37.18,65.572,32.599,66.351,30.119,66.42z"></path>
          <rect x="62.18" y="21.064" width="24.514" height="7.317"></rect>
          <path d="M74.961,32.682c-22.848,0-22.828,22.826-22.828,22.826s-1.566,22.713,22.829,22.713c0,0,20.331,1.162,20.331-15.801 H84.837c0,0,0.349,6.391-9.526,6.391c0,0-10.455,0.699-10.455-10.34h30.785C95.641,58.471,99.009,32.682,74.961,32.682z M84.255,50.541H64.738c0,0,1.277-9.158,10.455-9.158C84.372,41.382,84.255,50.541,84.255,50.541z"></path>
        </g>
      </svg>
    )
  }
];

const repeatedBrands = [...brands, ...brands];

// 2. CẬP NHẬT NỀN CỦA ICON
const BrandList = ({ 'aria-hidden': ariaHidden = false }) => (
  <ul
    className="flex items-center justify-center md:justify-start [&_li]:mx-4 sm:[&_li]:mx-8 animate-infinite-scroll"
    aria-hidden={ariaHidden}
  >
    {repeatedBrands.map((brand, index) => (
      <li key={index}>
        <a
          target="_blank"
          rel="noopener noreferrer"
          href={brand.href}
          className="border border-[var(--foreground)]
                     bg-white 
                     grid place-content-center p-3 rounded-md
                     transition-opacity hover:opacity-70" /* <-- THAY ĐỔI NỀN ICON */
        >
          {brand.svg}
        </a>
      </li>
    ))}
  </ul>
);

export default function BrandScroller() {
  return (
    <Container>
      <div
        className="w-full py-8 inline-flex flex-nowrap overflow-hidden 
                  mask-[linear-gradient(to_right,transparent_0,black_128px,black_calc(100%-200px),transparent_100%)]"
      >
        <BrandList />
        <BrandList aria-hidden={true} />
      </div>
    </Container>
  );
}
</file>

<file path="src/components/BtsSection.tsx">
// src/components/BtsSection.tsx
'use client';

import React, { useState, useEffect, useRef } from 'react';
import Image from 'next/image';
import Container from './Container'; // Tận dụng Container bạn đã có
import projects from '../data/bts'; // Import dữ liệu Section 04
import styles from '../app/styles/BtsSection.module.css'; // File CSS module mới

// Component con cho từng "cảnh" text
interface SceneProps {
  project: (typeof projects)[0];
  onVisible: () => void; // Hàm callback khi scene này active
  isActive: boolean;
}

const Scene: React.FC<SceneProps> = ({ project, onVisible, isActive }) => {
  const ref = useRef<HTMLDivElement>(null);

  useEffect(() => {
    const node = ref.current;
    if (!node) return;

    // Kích hoạt khi scene đi vào giữa màn hình
    const observer = new IntersectionObserver(
      (entries) => {
        const [entry] = entries;
        if (entry.isIntersecting) {
          onVisible(); // Gọi hàm callback để cập nhật activeIndex
        }
      },
      {
        threshold: 0.5, // Kích hoạt khi 50% nội dung lọt vào
        rootMargin: '0px 0px -40% 0px', // Thu hẹp vùng trigger vào giữa
      }
    );

    observer.observe(node);
    return () => observer.disconnect();
  }, [onVisible]);

  return (
      // Scene bây giờ là một "màn hình" full-height
      <div ref={ref} className={styles.scene}>
        {/* Bọc nội dung text trong Container để giữ chiều rộng */}
        <Container>
          <div className={`${styles.sceneContent} ${isActive ? styles.sceneActive : ''}`}>
            <span className={styles.sceneCategory}>
              {project.client} / {project.year}
            </span>
            <h3 className={styles.sceneTitle}>{project.title}</h3>
            <p className={styles.sceneDescription}>{project.description}</p>
          </div>
        </Container>
      </div>
    );
};

export default function BtsSection() {
  const [activeIndex, setActiveIndex] = useState(0);
  const btsProjects = projects.slice(0, 6);

  return (
    <section id="case-studies" className={styles.btsSection}>
      {/* 1. PHẦN HÌNH ẢNH (STICKY Ở NỀN) */}
      <div className={styles.stickyImageWrapper}>
        {btsProjects.map((project, index) => (
          <div
            key={project.title}
            className={`${styles.imageContainer} ${
              activeIndex === index ? styles.imageActive : ''
            }`}
          >
            <Image
              src={project.imageUrl} // Ảnh ngang của bạn
              alt={project.title}
              fill
              objectFit="cover" // object-fit: cover bây giờ sẽ hoạt động TỐT
              quality={90}
              priority={index === 0}
              className={styles.image}
            />
            <div className={styles.imageOverlay} /> {/* Thêm lớp phủ mờ */}
          </div>
        ))}
      </div>

      {/* 2. PHẦN NỘI DUNG (CUỘN LÊN TRÊN) */}
      {/* Tiêu đề cho Section (cuộn bình thường) */}
      <div className={styles.sectionHeader}>
        <Container>
          <h2 className={styles.sectionTitle}>Hậu trường</h2>
          <p className={styles.sectionSubtitle}>
            Câu chuyện và bối cảnh đằng sau những tác phẩm chọn lọc.
          </p>
        </Container>
      </div>

      {/* Cột text cuộn (đè lên trên ảnh) */}
      <div className={styles.textColumn}>
        {btsProjects.map((project, index) => (
          <Scene
           key={project.title}
            project={project}
            onVisible={() => setActiveIndex(index)}
            isActive={activeIndex === index}
          />
        ))}
      </div>
    </section>
  );
}
</file>

<file path="src/components/project-grid.tsx">
// app/thoi-trang/project-grid.tsx
'use client';

import { useState, useEffect, useRef, useCallback } from 'react';
import Link from 'next/link';
import Image from 'next/image';
import type { Project } from '@/lib/seed-helpers';
import Spinner from '@/components/Spinner';
import {
  INITIAL_LOAD_COUNT,
  LOAD_MORE_COUNT,
  SLUG_CATE_PERSONAL,
  SLUG_CATE_COMMERCIAL,
  SLUG_CATE_FASHION,
} from '@/lib/constants';

interface ProjectGridProps {
  allProjects: Project[];
}

export default function ProjectGrid({ allProjects }: ProjectGridProps) {
  const [displayedProjects, setDisplayedProjects] = useState<Project[]>(
    allProjects.slice(0, INITIAL_LOAD_COUNT)
  );
  const [currentIndex, setCurrentIndex] = useState(INITIAL_LOAD_COUNT);
  const [hasMore, setHasMore] = useState(
    allProjects.length > INITIAL_LOAD_COUNT
  );
  const [isLoading, setIsLoading] = useState(false);
  const loaderRef = useRef<HTMLDivElement>(null);

  const loadMoreProjects = useCallback(() => {
    if (isLoading || !hasMore) return;
    setIsLoading(true);
    setTimeout(() => {
      const nextIndex = currentIndex + LOAD_MORE_COUNT;
      const newProjects = allProjects.slice(currentIndex, nextIndex);
      setDisplayedProjects((prev) => [...prev, ...newProjects]);
      setCurrentIndex(nextIndex);
      setHasMore(nextIndex < allProjects.length);
      setIsLoading(false);
    }, 500);
  }, [isLoading, hasMore, currentIndex, allProjects]);

  // ... (useEffect cho IntersectionObserver giữ nguyên) ...
  useEffect(() => {
    const observer = new IntersectionObserver(
      (entries) => {
        const firstEntry = entries[0];
        if (firstEntry.isIntersecting && hasMore && !isLoading) {
          loadMoreProjects();
        }
      },
      { threshold: 1.0 }
    );
    const currentLoader = loaderRef.current;
    if (currentLoader) {
      observer.observe(currentLoader);
    }
    return () => {
      if (currentLoader) {
        observer.unobserve(currentLoader);
      }
    };
  }, [hasMore, isLoading, loadMoreProjects]);

  // 3. (MỚI) Lấy category của grid này
  // (Giả định tất cả project trong `allProjects` đều cùng 1 category)
  const gridCategory = allProjects[0]?.cateSlug;

  // 4. (MỚI) Helper function để lấy class cho item <Link>
  const getLinkClassName = (project: Project, index: number): string => {
    const baseClasses = 'relative group rounded-sm';

    switch (gridCategory) {
      case SLUG_CATE_FASHION:
        // Logic cho 'thoi-trang': thêm top-[24px] cho ảnh chẵn
        const fashionClass = index % 2 !== 0 ? 'top-[24px]' : '';
        return `${baseClasses} ${fashionClass}`;

      case SLUG_CATE_PERSONAL:
        const colSpan = project.colSpan || 'col-span-1'; // Fallback
        const rowSpan = project.rowSpan || 'row-span-1'; // Fallback
        return `${baseClasses} ${colSpan} ${rowSpan}`;

      case SLUG_CATE_COMMERCIAL:
      default:
        // 'thuong-mai' và mặc định: không có class đặc biệt
        return baseClasses;
    }
  };

  // 5. (MỚI) Helper function để lấy class cho grid wrapper <div>
  const getGridWrapperClassName = (category: string | undefined): string => {
    const baseGap = 'gap-3 md:gap-4';

    switch (category) {
      case SLUG_CATE_PERSONAL:
      case SLUG_CATE_FASHION:
      case SLUG_CATE_COMMERCIAL:
      default:
        // Layout 4 cột, auto-rows như cũ
        return `grid grid-cols-2 md:grid-cols-4 auto-rows-[200px] md:auto-rows-[300px] ${baseGap}`;
    }
  };

  // 6. Render
  return (
    <>
      {/* (CẬP NHẬT) Dùng class wrapper động */}
      <div className={getGridWrapperClassName(gridCategory)}>
        {displayedProjects.map((project, index) => {
          let imageSizes: string;
          const colSpan = project.colSpan || '';

          if (gridCategory === SLUG_CATE_PERSONAL) {
            // Logic cho grid 'ca-nhan' (12 cột)
            if (colSpan.includes('md:col-span-6')) { // 6/12 cột
              imageSizes = '(max-width: 768px) 50vw, 50vw';
            } else if (colSpan.includes('md:col-span-4')) { // 4/12 cột
              imageSizes = '(max-width: 768px) 50vw, 33vw';
            } else {
              imageSizes = '(max-width: 768px) 50vw, 25vw'; // Fallback
            }
          } else {
            // Logic cho 'thoi-trang' và 'thuong-mai' (4 cột)
            // (Hiện tại layout 2 trang này đơn giản, nên dùng chung 1 sizes)
            imageSizes = '(max-width: 768px) 50vw, 25vw';
          }

          return (
          <Link
            key={project.id}
            href={`/du-an/${project.slug}`}
            // (CẬP NHẬT) Dùng class item động
            className={getLinkClassName(project, index)}
          >
            <Image
              src={project.src}
              alt={project.title}
              fill
              sizes={imageSizes}
              className="object-cover transition-transform duration-700 ease-in-out group-hover:scale-105"
            />
            <div className="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent opacity-0 transition-opacity duration-500 group-hover:opacity-100" />
            <div className="absolute inset-0 p-4 flex flex-col justify-end translate-y-4 opacity-0 transition-all duration-500 group-hover:translate-y-0 group-hover:opacity-100">
              <span className="text-[10px] md:text-xs text-white/80 uppercase tracking-widest mb-2">
                {project.category || 'Project'}
              </span>
              <h3 className="text-white text-lg md:text-xl font-medium flex items-center gap-2">
                {project.title}
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  fill="none"
                  viewBox="0 0 24 24"
                  strokeWidth={2}
                  stroke="currentColor"
                  className="w-4 h-4 opacity-0 -translate-x-2 transition-all duration-500 group-hover:opacity-100 group-hover:translate-x-0"
                >
                  <path
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    d="M13.5 4.5L21 12m0 0l-7.5 7.5M21 12H3"
                  />
                </svg>
              </h3>
            </div>
            {/* --- Hết nội dung bên trong Link --- */}
          </Link>
        );
      })}
      </div>

      {/* --- PHẦN LOADER (Giữ nguyên) --- */}
      <div
        ref={loaderRef}
        className="col-span-2 md:col-span-4 h-24 flex justify-center items-center"
      >
        {hasMore && <Spinner />}
        {!hasMore && (
          <p className="text-[var(--sub-text)]">Đã tải hết dự án.</p>
        )}
      </div>
    </>
  );
}
</file>

<file path="src/components/ScrollToTopButton.tsx">
//ScrollToTopButton.tsx
'use client'; // Bắt buộc vì dùng hooks

import { useEffect, useState } from 'react';

export default function ScrollToTopButton() {
  const [isVisible, setIsVisible] = useState(false);

  // 1. Hook để theo dõi vị trí cuộn
  useEffect(() => {
    const toggleVisibility = () => {
      // Hiển thị nút khi cuộn qua 400px
      if (window.scrollY > 400) {
        setIsVisible(true);
      } else {
        setIsVisible(false);
      }
    };

    window.addEventListener('scroll', toggleVisibility);

    // Dọn dẹp listener khi component bị hủy
    return () => {
      window.removeEventListener('scroll', toggleVisibility);
    };
  }, []); // Chỉ chạy 1 lần khi mount

  // 2. Hàm xử lý khi click
  const scrollToTop = () => {
    window.scrollTo({
      top: 0,
      behavior: 'smooth', // Cuộn mượt
    });
  };

  return (
    <button
      onClick={scrollToTop}
      className={`fixed bottom-6 right-6 z-30 p-3
                 bg-[var(--foreground)] text-[var(--background)] hover:text-[var(--foreground)] rounded-full
                 shadow-lg cursor-pointer
                 transition-all duration-300 ease-in-out
                 hover:bg-[var(--background)] border-3 border-[var(--background)] hover:border-[var(--foreground)]
                 ${
                   isVisible
                     ? 'opacity-100 translate-y-0'
                     : 'opacity-0 translate-y-4 pointer-events-none'
                 }
                `}
      aria-label="Cuộn lên đầu trang"
    >
      {/* Đây là SVG mũi tên lên */}
      <svg
        xmlns="http://www.w3.org/2000/svg"
        fill="none"
        viewBox="0 0 24 24"
        strokeWidth={2}
        stroke="currentColor"
        className="w-5 h-5"
      >
        <path
          strokeLinecap="round"
          strokeLinejoin="round"
          d="m4.5 15.75 7.5-7.5 7.5 7.5"
        />
      </svg>
    </button>
  );
}
</file>

<file path="src/components/ui/ConfirmModal.tsx">
// src/components/ui/ConfirmModal.tsx
'use client';

import React from 'react';
import { AlertTriangle, Loader2 } from 'lucide-react';
import ModalPortal from './ModalPortal';

interface ConfirmModalProps {
  isOpen: boolean;
  onClose: () => void;
  onConfirm: () => void;
  title: string;
  description: string;
  confirmText?: string;
  cancelText?: string;
  isLoading?: boolean;
  variant?: 'danger' | 'warning' | 'info';
}

export default function ConfirmModal({
  isOpen,
  onClose,
  onConfirm,
  title,
  description,
  confirmText = 'Xác nhận',
  cancelText = 'Hủy bỏ',
  isLoading = false,
  variant = 'danger'
}: ConfirmModalProps) {

  return (
    <ModalPortal isOpen={isOpen} onClose={isLoading ? () => {} : onClose} className="max-w-md">
        
        {/* Header Area */}
        <div className="p-6 pb-2 flex gap-5">
          <div className={`w-12 h-12 rounded-full flex items-center justify-center flex-shrink-0 ${
            variant === 'danger' ? 'bg-red-100 text-red-600 dark:bg-red-900/30' : 
            variant === 'warning' ? 'bg-yellow-100 text-yellow-600' : 'bg-blue-100 text-blue-600'
          }`}>
            <AlertTriangle size={24} />
          </div>
          
          <div className="flex-1 pt-1 pr-6">
            <h3 className="text-lg font-bold text-[var(--admin-fg)] leading-tight mb-2">
              {title}
            </h3>
            <p className="text-sm text-[var(--admin-sub)] leading-relaxed">
              {description}
            </p>
          </div>
        </div>

        {/* Footer Buttons */}
        <div className="p-6 pt-6 flex justify-end gap-3 bg-[var(--admin-bg)]/50 border-t border-[var(--admin-border)]">
          <button
            onClick={onClose}
            disabled={isLoading}
            className="px-5 py-2.5 rounded-xl text-sm font-medium text-[var(--admin-fg)] border border-[var(--admin-border)] hover:bg-[var(--admin-hover)] transition-colors disabled:opacity-50 cursor-pointer"
          >
            {cancelText}
          </button>
          
          <button
            onClick={onConfirm}
            disabled={isLoading}
            className={`
              px-5 py-2.5 rounded-xl text-sm font-medium text-white shadow-lg flex items-center gap-2 transition-all hover:translate-y-[-1px] cursor-pointer
              ${variant === 'danger' ? 'bg-red-600 hover:bg-red-700 shadow-red-500/20' : 'bg-indigo-600 hover:bg-indigo-700'}
              disabled:opacity-70 disabled:cursor-not-allowed disabled:transform-none
            `}
          >
            {isLoading && <Loader2 size={16} className="animate-spin" />}
            {confirmText}
          </button>
        </div>
    </ModalPortal>
  );
}
</file>

<file path="src/lib/seed-helpers.ts">
// src/lib/seed-helpers.ts
import { StaticImageData } from 'next/image';

// Định nghĩa lại Project để bao gồm 'originalSlug' (cho mục đích demo)
export interface Project {
  id: number;
  slug: string;
  title: string;
  description?: string;
  src: StaticImageData;
  category: string;
  cateSlug: string;
  credits?: { label: string; value: string }[];
  articleBody?: ArticleBlock[];
  colSpan: string;
  rowSpan: string;
  // Thêm các trường tùy chọn cho demo
  isMock?: boolean;
  originalSlug?: string; // Sẽ lưu slug gốc ở đây
}

export type ArticleBlock =
  | { type: 'heading'; content: string }
  | { type: 'paragraph'; content: string }
  | { type: 'imageRow'; images: StaticImageData[] };

export function seedProjectsByCategory(
  allActualProjects: Project[],
  category: string,
  targetCount: number
): Project[] {
  
  const sourceProjects = allActualProjects.filter(
    (p) => p.category === category
  );

  if (sourceProjects.length === 0) {
    console.warn(`[seedProjects] Không tìm thấy dự án nào cho danh mục: ${category}`);
    return [];
  }

  const seededList: Project[] = [];
  const numSourceProjects = sourceProjects.length;

  for (let i = 0; i < targetCount; i++) {
    const projectToCopy = sourceProjects[i % numSourceProjects];
    const mockId = 10000 + i;

    const newProject: Project = { // Sử dụng kiểu Project đã định nghĩa
      ...projectToCopy,
      
      // 1. Tạo ID và Slug GIẢ (chỉ để dùng làm 'key' trong React)
      id: mockId,
      slug: `${projectToCopy.slug}-${i}`, // Slug giả duy nhất (ví dụ: ca-nhan-01-0, ca-nhan-01-1)
      
      // 2. Lưu lại Slug GỐC (để dùng cho href)
      originalSlug: projectToCopy.slug, // Đây là slug thật (ví dụ: ca-nhan-01)
      cateSlug : projectToCopy.cateSlug,
      isMock: true,
      colSpan: projectToCopy.colSpan,
      rowSpan: projectToCopy.rowSpan,
    };

    seededList.push(newProject);
  }

  return seededList;
}
</file>

<file path="src/app/not-found.tsx">
// src/app/not-found.tsx

import Link from 'next/link';
import Container from '@/components/Container'; // Tái sử dụng Container
import type { Metadata } from 'next';

export const metadata: Metadata = {
  title: '404 - Không tìm thấy | Oni Studio',
  description: 'Trang bạn đang tìm kiếm không tồn tại.',
};

export default function NotFound() {
  return (
    <Container>
      <div className="flex flex-col items-center justify-center text-center py-24 md:py-32 min-h-[calc(100vh_-_250px)]">
        
        {/* Mã lỗi 404 */}
        <span className="text-7xl md:text-9xl font-light tracking-tighter text-[var(--foreground)]">
          404
        </span>
        
        {/* Tiêu đề */}
        <h1 className="mt-4 text-3xl md:text-4xl font-light tracking-tight">
          Không tìm thấy trang
        </h1>
        
        {/* Mô tả */}
        <p className="mt-2 text-lg text-[var(--sub-text)]">
          Rất tiếc, chúng tôi không thể tìm thấy trang bạn yêu cầu.
        </p>

        <Link
          href="/"
          className="mt-10 py-3 px-8 bg-transparent 
                     border border-[var(--foreground)] 
                     text-[var(--foreground)] hover:text-[var(--background)]
                     hover:bg-[var(--foreground)]
                     transition-colors duration-300 cursor-pointer"
        >
          Quay về Trang chủ
        </Link>
      </div>
    </Container>
  );
}
</file>

<file path="src/components/admin/SettingsForm.tsx">
// src/components/admin/SettingsForm.tsx
'use client';

import { useState } from 'react'; // Bỏ useTransition vì không dùng nút riêng nữa
import { toast } from 'sonner';
import { Save, RotateCcw, Monitor, List, Database, Minus, Plus, Loader2, Clock } from 'lucide-react';
import { SettingItem, updateSettings } from '@/lib/actions/settings';

interface SettingsFormProps {
  initialSettings: SettingItem[];
  initialCleanupMinutes: number;
}

export default function SettingsForm({ initialSettings, initialCleanupMinutes }: SettingsFormProps) {
  // State chung
  const [settings, setSettings] = useState<SettingItem[]>(initialSettings);
  // State riêng cho cleanup (để bind vào input number)
  const [cleanupTime, setCleanupTime] = useState(initialCleanupMinutes);
  
  const [isSaving, setIsSaving] = useState(false);

  // Helper lấy value từ state chung
  const getValue = (key: string) => settings.find(s => s.key === key)?.value || '';

  // Helper update state chung
  const updateLocalSetting = (key: string, newValue: string) => {
    setSettings(prev => prev.map(s => s.key === key ? { ...s, value: newValue } : s));
  };

  // Logic tăng giảm số lượng (giữ nguyên)
  const handleNumberChange = (key: string, type: 'increase' | 'decrease') => {
    const currentVal = parseInt(getValue(key) || '10');
    let newVal = currentVal;
    if (type === 'increase') {
        newVal = currentVal < 5 ? 5 : currentVal + 5;
    } else {
        newVal = currentVal <= 5 ? 1 : currentVal - 5;
    }
    newVal = Math.max(1, Math.min(100, newVal));
    updateLocalSetting(key, newVal.toString());
  };

  // --- HÀM LƯU TỔNG HỢP (QUAN TRỌNG NHẤT) ---
  const handleSave = async () => {
    setIsSaving(true);
    const toastId = toast.loading('Đang lưu cấu hình...');

    try {
      // 1. Tạo payload từ danh sách settings hiện tại
      // Lọc bỏ key 'CLEANUP_GAP_MINUTES' cũ nếu lỡ nó có nằm trong mảng settings (để tránh trùng lặp)
      const baseUpdates = settings
        .filter(s => s.key !== 'CLEANUP_GAP_MINUTES')
        .map(s => ({ key: s.key, value: s.value }));

      // 2. Gộp giá trị Cleanup Time hiện tại vào payload
      const finalUpdates = [
        ...baseUpdates,
        { key: 'CLEANUP_GAP_MINUTES', value: cleanupTime.toString() }
      ];

      // 3. Gửi 1 request duy nhất update tất cả
      const res = await updateSettings(finalUpdates);

      if (res.success) {
        toast.success('Đã lưu tất cả cấu hình!', { id: toastId });
        // Dispatch event nếu cần
        if (typeof window !== 'undefined') {
            window.dispatchEvent(new Event('settings:updated'));
        }
      } else {
        toast.error(`Lỗi: ${res.error}`, { id: toastId });
      }
    } catch (error) {
        const msg = error instanceof Error ? error.message : 'Có lỗi xảy ra';
        toast.error(msg, { id: toastId });
    } finally {
      setIsSaving(false);
    }
  };

  return (
    <div className="max-w-4xl mx-auto space-y-8">
      
      {/* CARD 0: VẬN HÀNH STUDIO */}
      <div className="bg-[var(--admin-card)] border border-[var(--admin-border)] rounded-xl p-6 shadow-sm">
        <div className="flex items-center gap-3 mb-6 border-b border-[var(--admin-border)] pb-4">
          <div className="p-2 bg-purple-100 text-purple-600 rounded-lg">
            <Clock size={20} />
          </div>
          <div>
            <h3 className="font-bold text-[var(--admin-fg)]">Vận hành Studio</h3>
            <p className="text-xs text-[var(--admin-sub)]">Quản lý thời gian và quy trình.</p>
          </div>
        </div>
        <div className="flex flex-col md:flex-row gap-4 items-end">
            <div className="flex-1">
                <label className="block text-sm font-medium text-[var(--admin-sub)] mb-2">
                    Thời gian dọn dẹp (Phút)
                </label>
                <input
                    type="number" step="15" min="0"
                    value={cleanupTime}
                    onChange={(e) => setCleanupTime(Number(e.target.value))}
                    disabled
                    className="w-full max-w-[200px] p-2 rounded-lg bg-[var(--admin-bg)] border border-[var(--admin-border)] text-[var(--admin-fg)] focus:ring-2 focus:ring-[var(--admin-primary)] outline-none"
                />
                <p className="text-[10px] text-[var(--admin-sub)] mt-2">
                    * Giá trị này sẽ được lưu cùng nút Lưu cấu hình bên dưới.
                </p>
            </div>
        </div>
      </div>

      {/* CARD 1: HIỂN THỊ */}
      <div className="bg-[var(--admin-card)] border border-[var(--admin-border)] rounded-xl p-6 shadow-sm">
        <div className="flex items-center gap-3 mb-6 border-b border-[var(--admin-border)] pb-4">
          <div className="p-2 bg-indigo-100 text-indigo-600 rounded-lg">
            <List size={20} />
          </div>
          <div>
            <h3 className="font-bold text-[var(--admin-fg)]">Hiển thị & Danh sách</h3>
            <p className="text-xs text-[var(--admin-sub)]">Điều chỉnh số lượng dữ liệu trên bảng và trang chủ.</p>
          </div>
        </div>

        <div className="grid gap-6 md:grid-cols-2">
          {/* ITEMS PER PAGE CONTROL */}
          <div className="space-y-2">
            <label className="text-sm font-medium text-[var(--admin-fg)]">Số dự án mỗi lần tải (Admin Table)</label>
            <div className="flex items-center gap-4">
              <div className="flex items-center border border-[var(--admin-border)] rounded-lg bg-[var(--admin-bg)]">
                <button 
                  onClick={() => handleNumberChange('items_per_page', 'decrease')}
                  className="p-3 hover:bg-[var(--admin-hover)] text-[var(--admin-sub)]
                   hover:text-[var(--admin-fg)] border-r border-[var(--admin-border)] cursor-pointer"
                >
                  <Minus size={16} />
                </button>
                <input 
                  type="number" 
                  className="w-16 text-center bg-transparent outline-none font-bold text-[var(--admin-fg)]"
                  value={getValue('items_per_page')}
                  readOnly 
                />
                <button 
                  onClick={() => handleNumberChange('items_per_page', 'increase')}
                  className="p-3 hover:bg-[var(--admin-hover)] text-[var(--admin-sub)] 
                  hover:text-[var(--admin-fg)] border-l border-[var(--admin-border)] cursor-pointer"
                >
                  <Plus size={16} />
                </button>
              </div>
              <span className="text-xs text-[var(--admin-sub)]">dự án / trang</span>
            </div>
            <p className="text-[10px] text-[var(--admin-sub)] mt-1">
                * Mặc định là 10.
            </p>
          </div>
        </div>
      </div>

      {/* CARD 2: THÔNG TIN WEBSITE */}
      <div className="bg-[var(--admin-card)] border border-[var(--admin-border)] rounded-xl p-6 shadow-sm">
        <div className="flex items-center gap-3 mb-6 border-b border-[var(--admin-border)] pb-4">
          <div className="p-2 bg-blue-100 text-blue-600 rounded-lg">
            <Monitor size={20} />
          </div>
          <div>
            <h3 className="font-bold text-[var(--admin-fg)]">Thông tin Website</h3>
            <p className="text-xs text-[var(--admin-sub)]">Các thông tin hiển thị trên thanh tiêu đề trình duyệt.</p>
          </div>
        </div>

        <div className="space-y-4">
          <div className="space-y-2">
            <label className="text-sm font-medium text-[var(--admin-fg)]">Tiêu đề trang (Site Title)</label>
            <input 
              type="text" 
              className="w-full p-2.5 bg-[var(--admin-bg)] border border-[var(--admin-border)] rounded-lg outline-none focus:border-[var(--admin-primary)] text-[var(--admin-fg)] transition-all"
              value={getValue('site_title')}
              onChange={(e) => updateLocalSetting('site_title', e.target.value)}
            />
          </div>
        </div>
      </div>

      {/* CARD 3: HỆ THỐNG */}
      <div className="bg-[var(--admin-card)] border border-[var(--admin-border)] rounded-xl p-6 shadow-sm opacity-90 space-y-4">
        <div className="flex items-center gap-3 mb-6 border-b border-[var(--admin-border)] pb-4">
          <div className="p-2 bg-orange-100 text-orange-600 rounded-lg">
            <Database size={20} />
          </div>
          <div>
            <h3 className="font-bold text-[var(--admin-fg)]">Cấu hình Hệ thống</h3>
            <p className="text-xs text-[var(--admin-sub)]">Các thiết lập nâng cao.</p>
          </div>
        </div>

        <div className="flex items-center justify-between p-4 bg-[var(--admin-bg)] rounded-lg border border-[var(--admin-border)]">
          <div>
            <span className="font-medium text-[var(--admin-fg)] block">Chế độ Demo</span>
            <span className="text-xs text-[var(--admin-sub)]">Nếu bật, website sẽ hiển thị dữ liệu giả thay vì từ Database.</span>
          </div>
          <label className="relative inline-flex items-center cursor-pointer">
            <input 
              type="checkbox" 
              className="sr-only peer" 
              checked={getValue('is_demo_mode') === 'true'}
              onChange={(e) => updateLocalSetting('is_demo_mode', e.target.checked ? 'true' : 'false')}
            />
            <div className="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-indigo-300 dark:peer-focus:ring-indigo-800 rounded-full peer dark:bg-gray-700 peer-checked:bg-[var(--admin-primary)] after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:after:translate-x-full peer-checked:after:border-white"></div>
          </label>
        </div>
        <div className="flex items-center justify-between p-4 bg-[var(--admin-bg)] rounded-lg border border-[var(--admin-border)]">
            <div>
              <span className="font-medium text-[var(--admin-fg)] block">Tự động Đăng xuất</span>
              <span className="text-xs text-[var(--admin-sub)]">Hệ thống sẽ khóa phiên làm việc nếu không có hoạt động chuột/phím.</span>
            </div>
            
            <div className="flex items-center border border-[var(--admin-border)] rounded-lg bg-[var(--admin-card)]">
              <button 
                onClick={() => handleNumberChange('idle_timeout_minutes', 'decrease')}
                className="p-2 hover:bg-[var(--admin-hover)] text-[var(--admin-sub)] 
                border-r border-[var(--admin-border)] disabled:opacity-50 cursor-pointer"
                disabled={parseInt(getValue('idle_timeout_minutes')) <= 5}
              >
                <Minus size={16} />
              </button>
              
              <div className="w-20 text-center font-mono font-bold text-[var(--admin-fg)] flex items-center justify-center gap-1">
                 {getValue('idle_timeout_minutes') || '60'} <span className="text-[10px] font-normal text-[var(--admin-sub)]">phút</span>
              </div>
              
              <button 
                onClick={() => handleNumberChange('idle_timeout_minutes', 'increase')}
                className="p-2 hover:bg-[var(--admin-hover)] text-[var(--admin-sub)] 
                border-l border-[var(--admin-border)] cursor-pointer"
              >
                <Plus size={16} />
              </button>
            </div>
          </div>
      </div>

      {/* ACTION BAR - NÚT LƯU DUY NHẤT */}
      <div className="flex justify-end gap-4 sticky bottom-4 pt-4 bg-gradient-to-t from-[var(--admin-bg)] to-transparent pb-4 z-10">
        <button 
          onClick={() => {
              setSettings(initialSettings);
              setCleanupTime(initialCleanupMinutes);
          }}
          className="px-4 py-2 rounded-lg bg-[var(--admin-card)] border border-[var(--admin-border)] 
          text-[var(--admin-sub)] hover:bg-[var(--admin-hover)] flex items-center gap-2 shadow-sm cursor-pointer"
        >
          <RotateCcw size={18} /> Khôi phục
        </button>
        <button 
          onClick={handleSave}
          disabled={isSaving}
          className="px-6 py-2 rounded-lg bg-[var(--admin-primary)] text-[var(--admin-fg)] font-medium 
          hover:opacity-90 flex items-center gap-2 shadow-lg shadow-indigo-500/30 disabled:opacity-70 cursor-pointer"
        >
          {isSaving ? <Loader2 className="animate-spin" size={18} /> : <Save size={18} />}
          Lưu tất cả cấu hình
        </button>
      </div>
    </div>
  );
}
</file>

<file path="src/components/Footer.tsx">
'use client'; // Bắt buộc vì dùng hook client-side

import { useEffect, useRef, useState } from 'react';

export default function Footer() {
  const footerRef = useRef<HTMLDivElement>(null);
  const [visible, setVisible] = useState(false);

  useEffect(() => {
    const footer = footerRef.current;
    if (!footer) return;

    const observer = new IntersectionObserver(
      (entries) => {
        const [entry] = entries;
        setVisible(entry.isIntersecting);
      },
      {
        root: null,
        threshold: 0.2, // hiển thị khi 20% footer vào khung nhìn
      }
    );

    observer.observe(footer);
    return () => observer.disconnect();
  }, []);

  return (
  <footer
      ref={footerRef}
      className={`w-full text-center py-8 transition-all duration-700 ease-out
        ${visible ? 'opacity-100 translate-y-0' : 'opacity-0 translate-y-10'}
        
        // Mặc định (Light): nền sáng, chữ tối
        bg-gray-100 text-gray-700 
        
        // Khi Dark: nền đen, chữ trắng
        dark:bg-black dark:text-white 
      `}
    >
  Đ. Lý Thường Kiệt, Phường Phú Thọ, Quận 11, Thành phố Hồ Chí Minh, Việt Nam </footer>
  );
}
</file>

<file path="src/components/HeroSection.tsx">
// src/components/HeroSection.tsx

'use client'; // 1. Bắt buộc để sử dụng thư viện animation

import Image from 'next/image';
import Container from './Container';
import Background from '../assets/section_01/hero-background.webp';
import { TypeAnimation } from 'react-type-animation'; // 2. Import thư viện

export default function HeroSection() {
  return (
    <section
      id="welcome"
      className="relative h-screen flex items-center justify-center overflow-hidden text-white"
    >
      {/* Lớp chứa hình ảnh nền */}
      <div className="absolute inset-0 z-0">
        <Image
          src={Background}
          fill={true}
          quality={80}
          alt="Background"
          style={{ objectFit: 'cover' }}
          sizes="100vw"   // Báo cho browser biết nó chiếm full màn hình
        />
        <div className="absolute inset-0 bg-black/40"></div>
      </div>
      
      {/* Lớp chứa nội dung văn bản */}
      <Container className="relative z-10 text-center">
        {/* 3. Thay thế <h1> cũ bằng TypeAnimation */}
        <TypeAnimation
          // 'sequence' là mảng chứa các hành động
          // [Slogan 1, Dừng 2 giây, Slogan 2, Dừng 2 giây, Slogan 3, Dừng...]
          sequence={[
            'Chạm vào vẻ đẹp qua lăng kính ánh sáng.', // Slogan 1
            2000, // Dừng 2 giây
            'Uy tín trọn từng khoảnh khắc.', // Slogan 2 (thay thế Slogan 1)
            2000, // Dừng 2 giây
            'Bảo chứng khoảnh khắc bằng uy tín.', // Slogan 3
            2000, // Dừng 2 giây
          ]}
          wrapper="h1" // 4. Bắt buộc: Giữ thẻ <h1> để đảm bảo SEO
          cursor={true} // Có hiển thị con trỏ gõ chữ
          repeat={Infinity} // Lặp lại vô hạn
          // 5. Sao chép toàn bộ class của <h1> cũ,
          //    NHƯNG XÓA 'animate-fade-in-up'
          className="text-4xl md:text-6xl font-light tracking-tighter text-shadow-md text-gray-200"
        />

        {/* --- (PHƯƠNG ÁN THAY THẾ) ---
            Nếu bạn chỉ muốn 1 slogan lặp lại (gõ ra rồi xóa đi)
            Hãy dùng đoạn code bên dưới và xóa đoạn TypeAnimation ở trên */}

        {/* <TypeAnimation
          sequence={[
            'Uy tín trọn từng khoảnh khắc.',
            4000, // Dừng 4 giây
            '',     // Xóa đi
            1000, // Dừng 1 giây (trước khi gõ lại)
          ]}
          wrapper="h1"
          cursor={true}
          repeat={Infinity}
          className="text-4xl md:text-6xl font-light tracking-tighter text-shadow-md text-gray-200"
        /> */}
       
      </Container>

      {/* Chỉ báo cuộn xuống (Giữ nguyên) */}
      <div className="absolute bottom-8 left-1/2 -translate-x-1/2 z-10 animate-bounce">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
          strokeWidth={1.5}
          stroke="currentColor"
          className="w-6 h-6 text-white/80"
        >
          <path
            strokeLinecap="round"
            strokeLinejoin="round"
            d="m19.5 8.25-7.5 7.5-7.5-7.5"
          />
        </svg>
      </div>
    </section>
  );
}
</file>

<file path="src/components/LayoutWrapper.tsx">
// src/components/LayoutWrapper.tsx
'use client'; 
import { useState, useEffect, useRef, ReactNode } from 'react';
import Header from '@/components/Header'; 
import Footer from '@/components/Footer';
import { usePathname } from 'next/navigation';

interface LayoutWrapperProps {
  children: ReactNode;
}

export default function LayoutWrapper({ children }: LayoutWrapperProps) {
  // State để quyết định có hiển thị header fixed hay không
  const [showFixedHeader, setShowFixedHeader] = useState(false);
  // State để lưu chiều cao của header gốc
  const [headerHeight, setHeaderHeight] = useState(0);
  // Ref để tham chiếu đến header gốc và đo chiều cao
  const originalHeaderRef = useRef<HTMLDivElement>(null);

  const pathname = usePathname();
  // Kiểm tra xem trang hiện tại có phải là Admin không
  const isAdminPage = pathname?.startsWith('/admin');
  const isAdminLoginPage = pathname === '/login';

  // 1. Đo chiều cao của header gốc sau khi component mount
  useEffect(() => {
    if (originalHeaderRef.current) {
      setHeaderHeight(originalHeaderRef.current.offsetHeight);
    }
  }, []); // Chỉ chạy 1 lần

  // 2. Thêm listener để theo dõi sự kiện cuộn
  useEffect(() => {
    // Chỉ chạy logic nếu đã đo được chiều cao (headerHeight > 0)
    if (headerHeight === 0) return;

    const handleScroll = () => {
      // Nếu vị trí cuộn (window.scrollY) lớn hơn chiều cao của header
      // -> hiển thị header fixed
      if (window.scrollY > headerHeight) {
        setShowFixedHeader(true);
      } else {
        setShowFixedHeader(false);
      }
    };

    // Đăng ký sự kiện
    window.addEventListener('scroll', handleScroll);

    // Hủy đăng ký sự kiện khi component unmount
    return () => {
      window.removeEventListener('scroll', handleScroll);
    };
  }, [headerHeight]); // Chạy lại mỗi khi headerHeight thay đổi
  if (isAdminPage || isAdminLoginPage) {
    return <>{children}</>;
  }
  return (
    <>
      {/* 1. HEADER GỐC (Static) */}
      {/* z-20: Nằm dưới header fixed (z-30) */}
      <div ref={originalHeaderRef} className="relative z-20">
        <Header />
      </div>

      {/* 2. HEADER MỚI (Fixed) */}
      {/* Header này luôn ở đó, nhưng được ẩn/hiện bằng 'translate' */}
      <div
        className={`fixed top-0 left-0 right-0 z-50 bg-[var(--background)] 
                      text-[var(--foreground)] border-b border-[var(--foreground)]
                   transition-transform duration-300 ease-in-out 
                   ${
                     showFixedHeader ? 'translate-y-0' : '-translate-y-full'
                   }`}
      >
        <Header />
      </div>

      <main className="flex-1">{children}</main>

      <Footer />
    </>
  );
}
</file>

<file path="src/components/ProjectNavigation.tsx">
// src/components/ProjectNavigation.tsx
import React from 'react';
import Link from 'next/link';
import styles from '../app/styles/ProjectArticle.module.css';

interface ProjectNavigationProps {
  prevProjectLink: string | null; // <-- ĐỔI TÊN
  nextProjectLink: string | null; // <-- ĐỔI TÊN
}

const ProjectNavigation: React.FC<ProjectNavigationProps> = ({
  prevProjectLink,
  nextProjectLink,
}) => {
  return (
    <div className={styles.projectNavigation}>
      {/* Nút Previous */}
      {prevProjectLink ? (
        // Trường hợp 1: Có dự án trước -> Dùng link đã build
        <Link href={prevProjectLink} className={styles.navLink}>
          &larr; Dự án trước
        </Link>
      ) : (
        // Trường hợp 2: Đã ở đầu -> Link về Trang chủ
        <Link href="/" className={styles.navLink} title="Về trang chủ">
          &larr; Trang chủ
        </Link>
      )}

      {/* Nút Next */}
      {nextProjectLink ? (
        // Trường hợp 1: Có dự án tiếp theo -> Dùng link đã build
        <Link href={nextProjectLink} className={styles.navLink}>
          Dự án tiếp theo &rarr;
        </Link>
      ) : (
        // Trường hợp 2: Đã ở cuối -> Link về Trang chủ
        <Link href="/" className={styles.navLink} title="Về trang chủ">
          Trang chủ &rarr;
        </Link>
      )}
    </div>
  );
};

export default ProjectNavigation;
</file>

<file path="src/components/ThemeToggle.tsx">
// src/components/ThemeToggle.tsx
'use client';

import { useState, useEffect } from 'react';
import { useTheme } from 'next-themes';

// Thêm prop isAdmin
interface ThemeToggleProps {
  isAdmin?: boolean;
}

export default function ThemeToggle({ isAdmin = false }: ThemeToggleProps) {
  const [mounted, setMounted] = useState(false);
  const { theme, setTheme } = useTheme();

  useEffect(() => {
    setMounted(true);
  }, []);

  if (!mounted) {
    return <div className="w-9 h-9" />;
  }

  const toggleTheme = () => {
    setTheme(theme === 'light' ? 'dark' : 'light');
  };

  // Cấu hình màu sắc dựa trên isAdmin
  const buttonClass = isAdmin
    ? "p-1 cursor-pointer rounded-lg transition-all duration-200 bg-[var(--admin-primary)] hover:bg-[var(--admin-hover)] text-[var(--admin-primary-fg)] hover:text-[var(--admin-fg)] border border-transparent border-[var(--admin-border)]"
    : "rounded-md transition-colors cursor-pointer";

  const iconClass = isAdmin
    ? "w-5 h-5" // Icon Admin nhỏ gọn hơn chút
    : "w-6 h-6 p-1";

  // Icon Admin (Dùng Lucide cho đồng bộ với Admin Layout)
  // Hoặc dùng SVG cũ nhưng đổi màu theo biến admin
  return (
    <button
      onClick={toggleTheme}
      className={buttonClass}
      aria-label="Chuyển chế độ Sáng/Tối"
    >
      {theme === 'light' ? (
        // DARK MODE ICON
        isAdmin ? (
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={iconClass}><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>
        ) : (
          // Icon Client cũ (Mặt trăng)
          <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" className="w-6 h-6 text-white bg-black/80 rounded-md p-1" fill="currentColor">
             <path d="M12 22C17.5228 22 22 17.5228 22 12C22 11.5373 21.3065 11.4608 21.0672 11.8568C19.9289 13.7406 17.8615 15 15.5 15C11.9101 15 9 12.0899 9 8.5C9 6.13845 10.2594 4.07105 12.1432 2.93276C12.5392 2.69347 12.4627 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z"></path>
          </svg>
        )
      ) : (
        // LIGHT MODE ICON
        isAdmin ? (
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={iconClass}><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>
        ) : (
           // Icon Client cũ (Mặt trời)
           <svg viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg" className="w-6 h-6 text-black bg-white/80 rounded-md p-1">
              <path d="M12 17.75C10.8628 17.75 9.75106 17.4128 8.80547 16.781C7.85989 16.1491 7.1229 15.2511 6.6877 14.2004C6.25249 13.1498 6.13862 11.9936 6.36049 10.8782C6.58235 9.76284 7.12999 8.73829 7.93414 7.93414C8.73829 7.12999 9.76284 6.58235 10.8782 6.36049C11.9936 6.13862 13.1498 6.25249 14.2004 6.6877C15.2511 7.1229 16.1491 7.85989 16.781 8.80547C17.4128 9.75106 17.75 10.8628 17.75 12C17.7474 13.5242 17.1407 14.9852 16.0629 16.0629C14.9852 17.1407 13.5242 17.7474 12 17.75ZM12 7.75C11.1594 7.75 10.3377 7.99926 9.63883 8.46626C8.93992 8.93325 8.39519 9.59701 8.07351 10.3736C7.75184 11.1502 7.66768 12.0047 7.83167 12.8291C7.99565 13.6536 8.40043 14.4108 8.9948 15.0052C9.58917 15.5996 10.3464 16.0044 11.1709 16.1683C11.9953 16.3323 12.8498 16.2482 13.6264 15.9265C14.403 15.6048 15.0668 15.0601 15.5337 14.3612C16.0007 13.6623 16.25 12.8406 16.25 12C16.2474 10.8736 15.7987 9.79417 15.0023 8.99772C14.2058 8.20126 13.1264 7.75264 12 7.75Z"></path>
              <path d="M12 5C11.8019 4.99741 11.6126 4.91756 11.4725 4.77747C11.3324 4.63737 11.2526 4.44811 11.25 4.25V2.75C11.25 2.55109 11.329 2.36032 11.4697 2.21967C11.6103 2.07902 11.8011 2 12 2C12.1989 2 12.3897 2.07902 12.5303 2.21967C12.671 2.36032 12.75 2.55109 12.75 2.75V4.25C12.7474 4.44811 12.6676 4.63737 12.5275 4.77747C12.3874 4.91756 12.1981 4.99741 12 5Z"></path>
              <path d="M12 22C11.8019 21.9974 11.6126 21.9176 11.4725 21.7775C11.3324 21.6374 11.2526 21.4481 11.25 21.25V19.75C11.25 19.5511 11.329 19.3603 11.4697 19.2197C11.6103 19.079 11.8011 19 12 19C12.1989 19 12.3897 19.079 12.5303 19.2197C12.671 19.3603 12.75 19.5511 12.75 19.75V21.25C12.7474 21.4481 12.6676 21.6374 12.5275 21.7775C12.3874 21.9176 12.1981 21.9974 12 22Z"></path>
              <path d="M21.25 12.75H19.75C19.5511 12.75 19.3603 12.671 19.2197 12.5303C19.079 12.3897 19 12.1989 19 12C19 11.8011 19.079 11.6103 19.2197 11.4697C19.3603 11.329 19.5511 11.25 19.75 11.25H21.25C21.4489 11.25 21.6397 11.329 21.7803 11.4697C21.921 11.6103 22 11.8011 22 12C22 12.1989 21.921 12.3897 21.7803 12.5303C21.6397 12.671 21.4489 12.75 21.25 12.75Z"></path>
              <path d="M4.25 12.75H2.75C2.55109 12.75 2.36032 12.671 2.21967 12.5303C2.07902 12.3897 2 12.1989 2 12C2 11.8011 2.07902 11.6103 2.21967 11.4697C2.36032 11.329 2.55109 11.25 2.75 11.25H4.25C4.44891 11.25 4.63968 11.329 4.78033 11.4697C4.92098 11.6103 5 11.8011 5 12C5 12.1989 4.92098 12.3897 4.78033 12.5303C4.63968 12.671 4.44891 12.75 4.25 12.75Z"></path>
              <path d="M6.50001 7.24995C6.30707 7.2352 6.12758 7.14545 6.00001 6.99995L4.91001 5.99995C4.83844 5.92838 4.78167 5.84341 4.74293 5.7499C4.7042 5.65639 4.68427 5.55617 4.68427 5.45495C4.68427 5.35373 4.7042 5.25351 4.74293 5.16C4.78167 5.06649 4.83844 4.98152 4.91001 4.90995C4.98158 4.83838 5.06655 4.78161 5.16006 4.74287C5.25357 4.70414 5.3538 4.6842 5.45501 4.6842C5.55623 4.6842 5.65645 4.70414 5.74996 4.74287C5.84347 4.78161 5.92844 4.83838 6.00001 4.90995L7.00001 5.99995C7.123 6.13746 7.19099 6.31547 7.19099 6.49995C7.19099 6.68443 7.123 6.86244 7.00001 6.99995C6.87244 7.14545 6.69295 7.2352 6.50001 7.24995Z"></path>
              <path d="M18.56 19.31C18.4615 19.3104 18.3638 19.2912 18.2728 19.2534C18.1818 19.2157 18.0993 19.1601 18.03 19.09L17 18C16.9332 17.86 16.9114 17.7028 16.9376 17.5499C16.9638 17.3971 17.0368 17.2561 17.1465 17.1464C17.2561 17.0368 17.3971 16.9638 17.55 16.9376C17.7028 16.9113 17.8601 16.9331 18 17L19.09 18C19.2305 18.1406 19.3094 18.3312 19.3094 18.53C19.3094 18.7287 19.2305 18.9194 19.09 19.06C19.0233 19.1355 18.9419 19.1967 18.8508 19.2397C18.7597 19.2827 18.6607 19.3066 18.56 19.31Z"></path>
              <path d="M17.5 7.24995C17.3071 7.2352 17.1276 7.14545 17 6.99995C16.877 6.86244 16.809 6.68443 16.809 6.49995C16.809 6.31547 16.877 6.13746 17 5.99995L18 4.90995C18.1445 4.76541 18.3406 4.6842 18.545 4.6842C18.7494 4.6842 18.9455 4.76541 19.09 4.90995C19.2345 5.05449 19.3158 5.25054 19.3158 5.45495C19.3158 5.65936 19.2345 5.85541 19.09 5.99995L18 6.99995C17.8724 7.14545 17.6929 7.2352 17.5 7.24995Z"></path>
              <path d="M5.44001 19.31C5.34147 19.3104 5.24383 19.2912 5.15282 19.2534C5.06181 19.2157 4.97926 19.1601 4.91001 19.09C4.76956 18.9494 4.69067 18.7587 4.69067 18.56C4.69067 18.3612 4.76956 18.1706 4.91001 18.03L6.00001 17C6.13997 16.9331 6.2972 16.9113 6.45006 16.9376C6.60293 16.9638 6.7439 17.0368 6.85357 17.1464C6.96324 17.2561 7.03621 17.3971 7.06244 17.5499C7.08866 17.7028 7.06685 17.86 7.00001 18L6.00001 19.09C5.92728 19.1638 5.83985 19.2216 5.74338 19.2595C5.64691 19.2974 5.54356 19.3146 5.44001 19.31Z"></path>
           </svg>
        )
      )}
    </button>
  );
}
</file>

<file path="src/app/admin/projects/page.tsx">
// src/app/admin/projects/page.tsx
import Link from 'next/link';
import { getProjects, getCurrentUserProfile } from '@/lib/actions';
import { Plus } from 'lucide-react';
import ProjectTable from '@/components/admin/ProjectTable';
import { createClient } from '@supabase/supabase-js'; 


export default async function ProjectsListPage() {
  const [projects, userProfile] = await Promise.all([
    getProjects('all'),
    getCurrentUserProfile(), // 2. Lấy thông tin user
  ]);
  const supabase = createClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
  );
  const { data: setting } = await supabase
    .from('settings')
    .select('value')
    .eq('key', 'items_per_page')
    .single();
  const itemsLimit = setting?.value ? parseInt(setting.value) : 10;
  return (
    <div className="max-w-7xl mx-auto space-y-6 pb-20">
      
      {/* Header */}
      <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
        <div>
          <h1 className="text-3xl font-bold text-[var(--admin-fg)]">Quản lý Dự án</h1>
          <p className="text-[var(--admin-sub)] mt-1">
            Quản lý danh mục dự án và chi tiết nội dung.
          </p>
        </div>
        {userProfile?.role === 'Admin' && (
          <Link 
            href="/admin/projects/new" 
            className="flex items-center gap-2 px-5 py-2.5 bg-[var(--admin-primary)] text-white rounded-lg font-medium hover:opacity-90 transition-all shadow-lg shadow-indigo-500/30"
          >
            <Plus size={20} /> Thêm dự án mới
          </Link>
        )}
      </div>

      {/* Client Table Component (Xử lý Search & Infinite Scroll) */}
      <ProjectTable initialProjects={projects} itemsPerPage={itemsLimit} userProfile={userProfile} />
      
    </div>
  );
}
</file>

<file path="src/app/admin/staff/page.tsx">
import { getStaffList } from '@/lib/actions';
import StaffTable from '@/components/admin/StaffTable';
import StaffPageHeader from '@/components/admin/StaffPageHeader';
import { createServerClient } from '@supabase/ssr'; // Dùng cái này cho Server Component
import { cookies } from 'next/headers';
import { redirect } from 'next/navigation';

export default async function StaffPage() {
  // 1. Check quyền ngay tại Server Page
  const cookieStore = await cookies(); // Await cookies() (Next.js 15)
  
  const supabase = createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        getAll() { return cookieStore.getAll() },
        setAll() {} // Server Component không set cookie
      },
    }
  );

  const { data: { user } } = await supabase.auth.getUser();
  
  if (!user) redirect('/login');

  // Lấy Role
  const { data: profile } = await supabase
    .from('users')
    .select('role, user_id')
    .eq('auth_id', user.id)
    .single();

  const currentRole = profile?.role || 'Staff';
  const currentUserId = profile?.user_id || 0; 

  // Nếu là Staff -> Đá về Dashboard (Chặn truy cập trang này luôn)
  if (currentRole !== 'Admin') {
    redirect('/admin');
  }

  // 2. Lấy danh sách (Chỉ chạy nếu là Admin)
  const staffList = await getStaffList();

  return (
    <div className="max-w-7xl mx-auto pb-20 space-y-6">
      {/* Truyền role xuống nếu muốn ẩn hiện nút (tuy nhiên ta đã chặn cả trang rồi) */}
      <StaffPageHeader total={staffList.length} />
      <StaffTable initialStaff={staffList} 
      currentUserRole={currentRole} currentUserId={currentUserId} />
    </div>
  );
}
</file>

<file path="src/app/du-an/[slug]/page.tsx">
// src/app/du-an/[slug]/page.tsx
import React from 'react';
import { notFound } from 'next/navigation';
import { getProjects } from '@/lib/actions';
import { Metadata } from 'next';
import ProjectClientPage from './ProjectClientPage';

// 1. Định nghĩa Props
interface PageProps {
  params: Promise<{ slug: string }>;
}

// 2. Sinh đường dẫn tĩnh (Quan trọng để không bị 404 khi deploy)
export async function generateStaticParams() {
  const projects = await getProjects();
  
  if (!Array.isArray(projects) || projects.length === 0) return [];

  return projects.map((project) => ({
    slug: project.slug, // Chỉ cần slug là đủ
  }));
}

// 3. SEO Metadata
export async function generateMetadata({ params }: PageProps): Promise<Metadata> {
  const { slug } = await params;
  const projects = await getProjects();
  const project = projects.find((p) => p.slug === slug);

  if (!project) return { title: 'Dự án không tồn tại' };

  const ogImage = typeof project.image === 'string' ? project.image : (project.image.src || '');

  return {
    title: `${project.title} | Oni Studio`,
    description: project.description || `Chi tiết dự án ${project.title}`,
    openGraph: {
      images: [ogImage],
    },
  };
}
export const revalidate = 3600; // 1 hour
// 4. Component Chính (Server Component)
export default async function ProjectDetailPage({ params }: PageProps) {
  const { slug } = await params;
  const projects = await getProjects();
  
  // Tìm dự án hiện tại
  const project = projects.find((p) => p.slug === slug);

  if (!project) {
    notFound(); // Chuyển hướng sang trang 404 chuẩn
  }

  // Logic tìm bài Liên quan (Cùng danh mục) để điều hướng Next/Prev
  // Lọc danh sách chỉ gồm các bài cùng category
  const sameCategoryProjects = projects.filter(p => p.category === project.category);
  // Tìm vị trí của bài hiện tại trong danh sách đó
  const currentIndex = sameCategoryProjects.findIndex(p => p.id === project.id);
  
  // Lấy bài trước và sau
  const nextProject = sameCategoryProjects[currentIndex + 1] || null;
  const prevProject = sameCategoryProjects[currentIndex - 1] || null;

  // Tạo Link điều hướng
  const nextLink = nextProject ? `/du-an/${nextProject.slug}` : null;
  const prevLink = prevProject ? `/du-an/${prevProject.slug}` : null;

  return (
    <ProjectClientPage 
      project={project}
      prevProjectLink={prevLink}
      nextProjectLink={nextLink}
    />
  );
}
</file>

<file path="src/components/AboutPhilosophySection.tsx">
import Image from 'next/image';
import Container from '@/components/Container';
import ProfileImage from '../assets/about/avatar.webp'; 
import PhilosophyBackground from './PhilosophyBackground';
import AnimatedProfileImage from './AnimatedProfileImage';
export default function AboutPhilosophySection() {

  return (
    <section
      id="philosophy"
      className="relative py-24 md:py-32 overflow-hidden bg-[var(--to-linear)]"
    >
      {/* LỚP 1: NỀN (HIỆU ỨNG SCROLL TEXT) */}
      <PhilosophyBackground />
      {/* LỚP 2: NỘI DUNG (ẢNH & TRIẾT LÝ) */}
      <Container className="relative z-20">
        <div className="grid grid-cols-1 md:grid-cols-5 gap-12 md:gap-16 items-center">
          
          {/* CỘT TRÁI (Ảnh) */}
          <div className="md:col-span-2 flex justify-center items-center py-8 md:py-0"> {/* Thêm padding y để cân đối nếu cần */}
            {/* CONTAINER BAO GỒM ẢNH VÀ KHUNG LỆCH */}
            <div className="relative w-full max-w-sm md:max-w-md lg:max-w-lg xl:max-w-xl mx-auto">
              {/* KHUNG LỆCH (Nằm phía sau ảnh) */}
              <div
                className="absolute bg-transparent border-2 border-[var(--foreground)]"
                style={{
                  width: '100%',     // Kích thước của khung lệch so với container
                  height: '100%',    // Chiều cao tương đương ảnh
                  top: '-25px',      // Dịch lên trên một chút
                  left: '35px',      // Dịch sang phải một chút
                  zIndex: 0,         // Đảm bảo nó nằm phía sau ảnh chính
                }}
              ></div>

              {/* ẢNH CHÍNH (Nằm phía trước khung lệch) */}
              <div className="relative z-10"> {/* Đảm bảo ảnh nằm trên khung lệch */}
              <AnimatedProfileImage>
                        {/* Component <Image> này vẫn được render trên SERVER
                          và được "truyền" vào <AnimatedProfileImage> như một prop 'children'
                        */}
                        <Image
                          src={ProfileImage}
                          alt="Chân dung Oni, nhiếp ảnh gia Oni Studio"
                          width={600}
                          height={800}
                          className="object-cover aspect-[3/4] w-full " 
                          placeholder="blur"
                        />
                </AnimatedProfileImage>
              </div>
            </div>
          </div>
        
          {/* CỘT PHẢI (Text) */}
          <div className="md:col-span-3">
            <h2 className="text-4xl md:text-5xl font-light tracking-tighter mb-6 text-[var(--foreground)]">
              Triết Lý Của Tôi
            </h2>
            <div className="text-lg md:text-xl space-y-6">
            <p className="leading-relaxed text-[var(--foreground)]">
              <strong>Ánh sáng</strong> là nền tảng của công việc. Niềm say mê bất tận nằm ở việc khai thác 
              cách ánh sáng <strong>điêu khắc</strong>, làm nổi bật, và <strong>tôn vinh</strong> một chủ thể. 
              Đó vừa là công cụ, là <strong>ngôn ngữ</strong>, vừa là <strong>nguồn cảm hứng chính</strong>.
            </p>

            <p className="leading-relaxed text-[var(--foreground)]">
              Tôi tin rằng một bức ảnh thành công là sự <strong>giao thoa hài hòa</strong> giữa <strong>tầm nhìn nghệ thuật</strong> và <strong>kỹ thuật chính xác</strong>. 
              Từ dự án thương mại phức tạp đến một bức chân dung tối giản, mục tiêu luôn là 
              sự <strong>chỉn chu trong từng chi tiết</strong>, mang lại giá trị vượt trên cả mong đợi.
            </p>
            </div>
          </div>

        </div>
      </Container>
    </section>
  );
}
</file>

<file path="src/components/admin/StaffTable.tsx">
// src/components/admin/StaffTable.tsx
'use client';

import React, { useState, useMemo } from 'react';
import { Search, Mail, ArrowUpDown, UserX, UserCheck } from 'lucide-react';
import { toast } from 'sonner';
import { StaffUser, toggleStaffStatus } from '@/lib/actions'; 
import { createBrowserClient } from '@supabase/ssr';
import { useRouter } from 'next/navigation';
// 1. IMPORT MODAL
import ConfirmModal from '@/components/ui/ConfirmModal';

interface StaffTableProps {
  initialStaff: StaffUser[];
  currentUserRole: string;
  currentUserId: number;
}

type SortKey = 'full_name' | 'role' | 'email' | 'is_active';

export default function StaffTable({ initialStaff, currentUserRole, currentUserId }: StaffTableProps) {
  const [staffList, setStaffList] = useState(initialStaff);
  const [searchQuery, setSearchQuery] = useState('');
  const [sortConfig, setSortConfig] = useState<{ key: SortKey; direction: 'asc' | 'desc' }>({ key: 'full_name', direction: 'asc' });
  
  // State cho Loading & Modal
  const [isLoading, setIsLoading] = useState(false); // Loading chung cho modal
  
  // 2. STATE QUẢN LÝ MODAL
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [selectedStaff, setSelectedStaff] = useState<StaffUser | null>(null);

  const router = useRouter();
  const supabase = createBrowserClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
  );

  // --- LOGIC SORT & FILTER (Giữ nguyên) ---
  const handleSort = (key: SortKey) => {
    setSortConfig((current) => ({
      key,
      direction: current.key === key && current.direction === 'asc' ? 'desc' : 'asc',
    }));
  };

  const processedStaff = useMemo(() => {
    let data = [...staffList];
    if (searchQuery) {
      const lowerQuery = searchQuery.toLowerCase();
      data = data.filter(
        (s) =>
          s.full_name?.toLowerCase().includes(lowerQuery) ||
          s.email?.toLowerCase().includes(lowerQuery) ||
          s.role?.toLowerCase().includes(lowerQuery)
      );
    }
    data.sort((a, b) => {
      const aValue = a[sortConfig.key];
      const bValue = b[sortConfig.key];
      if (aValue < bValue) return sortConfig.direction === 'asc' ? -1 : 1;
      if (aValue > bValue) return sortConfig.direction === 'asc' ? 1 : -1;
      return 0;
    });
    return data;
  }, [staffList, searchQuery, sortConfig]);

  // --- 3. HÀM MỞ MODAL ---
  const openConfirmModal = (staff: StaffUser) => {
    setSelectedStaff(staff);
    setIsModalOpen(true);
  };

  // --- 4. HÀM XỬ LÝ CHÍNH (CHẠY KHI BẤM CONFIRM TRONG MODAL) ---
  const handleConfirmToggle = async () => {
    if (!selectedStaff) return;

    setIsLoading(true);

    try {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) {
        toast.error('Hết phiên đăng nhập');
        return;
      }

      const res = await toggleStaffStatus(session.access_token, selectedStaff.user_id, selectedStaff.is_active);

      if (res.success) {
        toast.success(`Đã ${selectedStaff.is_active ? 'khóa' : 'mở khóa'} tài khoản thành công!`);
        
        // Optimistic Update
        setStaffList((prev) =>
          prev.map((s) => (s.user_id === selectedStaff.user_id ? { ...s, is_active: !s.is_active } : s))
        );
        
        setIsModalOpen(false); // Đóng modal
        setSelectedStaff(null);
        router.refresh();
      } else {
        toast.error(`Lỗi: ${res.error}`);
      }
    } catch (error) {
        const msg = error instanceof Error ? error.message : 'Lỗi hệ thống';
        toast.error(msg);
    } finally {
      setIsLoading(false);
    }
  };

  const SortableHeader = ({ label, colKey, className = "" }: { label: string; colKey: SortKey; className?: string }) => (
    <th 
      className={`px-6 py-4 whitespace-nowrap cursor-pointer hover:bg-[var(--admin-hover)] transition-colors select-none group ${className}`}
      onClick={() => handleSort(colKey)}
    >
      <div className="flex items-center gap-2">
        {label}
        <ArrowUpDown size={14} className={`text-[var(--admin-sub)] transition-opacity ${sortConfig.key === colKey ? 'opacity-100 text-[var(--admin-primary)]' : 'opacity-0 group-hover:opacity-50'}`} />
      </div>
    </th>
  );

  return (
    <div className="space-y-6">
      {/* Search Bar (Giữ nguyên) */}
      <div className="flex items-center gap-4 bg-[var(--admin-card)] p-4 rounded-xl border border-[var(--admin-border)] shadow-sm">
        <div className="relative flex-1 max-w-md w-full">
          <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-[var(--admin-sub)]" size={18} />
          <input 
            type="text" 
            placeholder="Tìm kiếm theo tên, email, vai trò..." 
            className="w-full pl-10 pr-4 py-2 bg-[var(--admin-bg)] border border-[var(--admin-border)] rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--admin-primary)] text-[var(--admin-fg)] transition-all"
            value={searchQuery}
            onChange={(e) => setSearchQuery(e.target.value)}
          />
        </div>
        <div className="text-sm text-[var(--admin-sub)]">
            Tổng: <strong>{processedStaff.length}</strong> nhân sự
        </div>
      </div>

      {/* Table */}
      <div className="bg-[var(--admin-card)] rounded-xl border border-[var(--admin-border)] shadow-sm overflow-hidden">
        <div className="overflow-x-auto table-scrollbar">
          <table className="w-full text-sm text-left min-w-[800px]">
            <thead className="bg-[var(--admin-bg)] text-[var(--admin-sub)] uppercase text-xs font-semibold border-b border-[var(--admin-border)]">
              <tr>
                <SortableHeader label="Họ và Tên" colKey="full_name" />
                <SortableHeader label="Vai trò" colKey="role" />
                <th className="px-6 py-4 whitespace-nowrap">Liên hệ</th>
                <SortableHeader label="Trạng thái" colKey="is_active" />
                <th className="px-6 py-4 text-right whitespace-nowrap">Hành động</th>
              </tr>
            </thead>
            <tbody className="divide-y divide-[var(--admin-border)]">
              {processedStaff.length === 0 ? (
                 <tr><td colSpan={5} className="p-8 text-center text-[var(--admin-sub)] italic">Không tìm thấy nhân viên nào.</td></tr>
              ) : (
                processedStaff.map((staff) => (
                  <tr key={staff.user_id} className={`transition-colors ${staff.is_active ? 'hover:bg-[var(--admin-hover)]' : 'bg-gray-50 dark:bg-neutral-900/50 opacity-70'}`}>
                    {/* ... (Các cột hiển thị thông tin giữ nguyên) ... */}
                    <td className="px-6 py-4 font-medium text-[var(--admin-fg)]">
                      <div className="flex items-center gap-3">
                        <div className={`w-8 h-8 rounded-full flex items-center justify-center text-white font-bold shrink-0 shadow-sm ${staff.role === 'Admin' ? 'bg-indigo-500' : 'bg-pink-500'}`}>
                          {staff.full_name?.charAt(0).toUpperCase() || '?'}
                        </div>
                        <div>
                            <div className="whitespace-nowrap font-semibold">{staff.full_name}</div>
                            {staff.role === 'Admin' && <span className="text-[10px] text-[var(--admin-primary)] font-bold border border-[var(--admin-primary)] px-1 rounded">SUPER ADMIN</span>}
                        </div>
                      </div>
                    </td>
                    <td className="px-6 py-4 text-[var(--admin-sub)] whitespace-nowrap font-medium">{staff.role}</td>
                    <td className="px-6 py-4 text-[var(--admin-sub)] space-y-1 whitespace-nowrap">
                      <div className="flex items-center gap-2"><Mail size={14}/> {staff.email}</div>
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap">
                      <span className={`px-2.5 py-1 rounded-full text-xs font-bold border ${
                        staff.is_active 
                          ? 'bg-green-100 text-green-700 border-green-200' 
                          : 'bg-red-100 text-red-600 border-red-200'
                      }`}>
                        {staff.is_active ? 'Đang hoạt động' : 'Đã khóa'}
                      </span>
                    </td>
                    <td className="px-6 py-4 text-right whitespace-nowrap">
                      {/* CỘT HÀNH ĐỘNG */}
                     {currentUserRole === 'Admin' && staff.user_id !== currentUserId && (
                        <button 
                          onClick={() => openConfirmModal(staff)} 
                          className={`p-2 rounded-lg transition-colors group cursor-pointer ${
                              staff.is_active 
                              ? 'text-red-500 hover:bg-red-50' 
                              : 'text-green-500 hover:bg-green-50'
                          }`}
                          title={staff.is_active ? "Khóa tài khoản" : "Mở khóa tài khoản"}
                        >
                          {staff.is_active ? <UserX size={18} /> : <UserCheck size={18} />}
                        </button>
                      )}
                      {staff.user_id === currentUserId && (
                        <span className="text-xs text-[var(--admin-sub)] italic px-2">Bạn</span>
                      )}
                    </td>
                  </tr>
                ))
              )}
            </tbody>
          </table>
        </div>
      </div>

      {/* 5. RENDER MODAL */}
      <ConfirmModal 
        isOpen={isModalOpen}
        onClose={() => !isLoading && setIsModalOpen(false)}
        onConfirm={handleConfirmToggle}
        isLoading={isLoading}
        
        // Logic hiển thị động dựa trên trạng thái nhân viên
        title={selectedStaff?.is_active ? "Khóa tài khoản này?" : "Mở khóa tài khoản?"}
        
        description={selectedStaff?.is_active 
            ? `Bạn có chắc muốn khóa quyền truy cập của "${selectedStaff.full_name}"? Họ sẽ không thể đăng nhập vào hệ thống nữa.` 
            : `Bạn có chắc muốn kích hoạt lại tài khoản cho "${selectedStaff?.full_name}"? Họ sẽ có thể đăng nhập và làm việc bình thường.`
        }
        
        confirmText={selectedStaff?.is_active ? "Khóa tài khoản" : "Kích hoạt lại"}
        cancelText="Hủy bỏ"
        
        // Đổi màu sắc: Khóa = Đỏ, Mở = Xanh/Info
        variant={selectedStaff?.is_active ? 'danger' : 'info'} 
      />
    </div>
  );
}
</file>

<file path="src/components/ContactSection.tsx">
// src/components/ContactSection.tsx
'use client'; // Bắt buộc vì dùng hook (useState)

import React, { useState } from 'react';
import Container from '@/components/Container';
import BrandScroller from "@/components/BrandScroller";

export default function ContactSection() {
  const email = 'hello@onistudio.com';
  const [copyText, setCopyText] = useState(email);
  const noiseOpacity = 0.05; // Điều chỉnh độ đậm/nhạt của noise

  // Hàm xử lý copy email (giữ nguyên)
  const handleCopy = () => {
    navigator.clipboard.writeText(email).then(
      () => {
        setCopyText('Đã sao chép!');
        setTimeout(() => {
          setCopyText(email);
        }, 2000);
      },
      (err) => {
        console.error('Không thể sao chép: ', err);
        setCopyText('Lỗi khi sao chép');
      }
    );
  };

  return (
<section
      id="contact"
      className="relative py-14 overflow-hidden 
                 bg-linear-to-b to-[var(--to-linear)] from-[var(--from-linear)] 
                 dark:text-white text-black" 
      style={{ minHeight: 0, fontSize: 'initial' }}
    >
      {/* 2. LỚP NỀN (GRID + MASK) */}
      <div
        className="absolute bottom-0 left-0 right-0 top-0 z-0
                   bg-[linear-gradient(to_right,#4f4f4f2e_1px,transparent_1px),linear-gradient(to_bottom,#4f4f4f2e_1px,transparent_1px)] 
                   bg-size-[35px_34px] 
                   mask-[radial-gradient(ellipse_60%_50%_at_50%_0%,#000_70%,transparent_100%)]"
      ></div>

      {/* 3. LỚP NỀN (NOISE) */}
      <div
        className="absolute top-0 left-0 w-full h-full content-[''] z-10 
                   pointer-events-none 
                   bg-[url('https://www.ui-layouts.com/noise.gif')]"
        style={{ opacity: noiseOpacity }}
      ></div>

      {/* 4. NỘI DUNG (đặt z-index cao hơn) */}
      <Container className="relative z-20 mt-16 mb-12 lg:mt-24 lg:mb-14">
        <div className="relative md:border-l-1 border-[var(--foreground)]">
       {/* 1. THAY ĐỔI: TIÊU ĐỀ DỌC (Chỉ hiện từ 'md' trở lên) */}
          <div className="hidden md:flex absolute top-0 -left-16 md:-left-24 w-16 md:w-24 h-full items-center justify-center pointer-events-none">
            <h2
              className="transform -rotate-90 whitespace-nowrap text-4xl md:text-5xl 
                         font-light tracking-widest uppercase text-[var(--foreground)]"
            >
              Liên Hệ
            </h2>
          </div>

          {/* 2. THÊM MỚI: TIÊU ĐỀ NGANG (Chỉ hiện trên di động) */}
          <div className="md:hidden mb-12">
            <h2 className="text-4xl font-light tracking-tighter text-[var(--foreground)]">
              Liên Hệ
            </h2>
          </div>

          {/* 3. THAY ĐỔI: NỘI DUNG CHÍNH (Bỏ padding trái trên di động) */}
          <div className="pl-0 md:pl-16 grid grid-cols-1 md:grid-cols-2 gap-12 md:gap-20 max-w-4xl mx-auto">
            
            {/* CỘT 1: FORM */}
            <div>
              <p className="text-lg text-[var(--foreground)] mb-6">
                Để lại lời nhắn cho chúng tôi bằng cách điền vào biểu mẫu bên dưới:
              </p>
              {/* ... (phần form giữ nguyên) ... */}
              <form
                onSubmit={(e) => {
                  e.preventDefault();
                  alert('Chức năng gửi form đang được phát triển!');
                }}
                className="space-y-6"
              >
                <div>
                  <label
                    htmlFor="email"
                    className="block border-[var(--foreground)]/60 focus:border-[var(--foreground)] text-sm font-medium mb-1 text-[var(--foreground)]"
                  >
                    Email của bạn
                  </label>
                  <input
                    type="email"
                    id="email"
                    name="email"
                    required
                    className="block w-full p-3 bg-transparent 
                               border border-[var(--foreground)]/60
                               focus:ring-0 focus:border-[var(--foreground)] 
                               transition-colors text-[var(--foreground)]"
                  />
                </div>
                <div>
                  <label
                    htmlFor="message"
                    className="block text-sm font-medium mb-1 text-[var(--foreground)]"
                  >
                    Lời nhắn
                  </label>
                  <textarea
                    id="message"
                    name="message"
                    rows={5}
                    required
                    className="block w-full p-3 bg-transparent text-[var(--foreground)]
                               border border-[var(--foreground)]/60
                               focus:ring-0 focus:border-[var(--foreground)] 
                               transition-colors"
                  ></textarea>
                </div>
                <div>
                  <button
                    type="submit"
                    className="py-3 px-8 bg-transparent 
                               border border-[var(--foreground)]/60
                               text-[var(--foreground)] 
                               hover:bg-black 
                               dark:hover:bg-white dark:hover:text-gray-950
                               transition-colors duration-300 cursor-pointer font-bold"
                  >
                    Gửi Lời Nhắn
                  </button>
                </div>
              </form>
            </div>

            {/* CỘT 2: EMAIL COPY */}
            <div>
              <p className="text-lg mb-6 text-[var(--foreground)]">
                Hoặc nhấn để sao chép email:
              </p>
              {/* ... (phần nút copy giữ nguyên) ... */}
              <button
                onClick={handleCopy}
                className="w-full text-left p-4 bg-transparent 
                           border border-[var(--foreground)]/60
                           text-lg md:text-xl font-mono 
                           hover:border-[var(--foreground)]
                           transition-all duration-300 cursor-pointer text-[var(--foreground)]"
              >
                {copyText}
              </button>
            </div>
          </div>
        </div>
      </Container>
  {/* 4. Đặt BrandScroller VÀO ĐÂY (Sau Container, trong Section) */}
      {/* Phải có relative z-20 để nổi lên trên nền */}
      <div className="relative z-20 mt-10 md:mt-4">
        <BrandScroller />
      </div>
    </section>
   


  );
}
</file>

<file path="src/components/Header.tsx">
// src/components/Header.tsx
'use client'; 

import { useState, useEffect } from 'react'; 
import Container from "./Container";
import localFont from 'next/font/local'; 
import Link from 'next/link';
import ThemeToggle from './ThemeToggle';

const logoFont = localFont({
  src: '../fonts/cameliya-regular.ttf',
  display: 'swap',
  variable: '--font-logo',
});

export default function Header() {
  const [isMenuOpen, setIsMenuOpen] = useState(false);

  useEffect(() => {
    if (isMenuOpen) {
      document.body.style.overflow = 'hidden';
    } else {
      document.body.style.overflow = 'auto';
    }
    return () => {
      document.body.style.overflow = 'auto';
    };
  }, [isMenuOpen]); 

  const handleLinkClick = () => {
    setIsMenuOpen(false);
  };
  
  return (
   <header
      className={`border-b py-4 relative z-50 
                 animate-fade-in-up backdrop-blur-2xl bg-[var(--background)] 
                 border-[var(--foreground)]`} 
    >
      <Container>
        <div className="flex items-center justify-between">
          <h1
            className={`text-xl font-semibold tracking-widest cursor-pointer ${logoFont.className}`}
          >
            <Link href="/" className="menu-link-glow">
              Oni Studio
            </Link>
          </h1>

          <nav className="hidden md:flex items-center space-x-6 text-md">
            <Link href="/thuong-mai" className="menu-link-glow">
              Thương mại
            </Link>
            <Link href="/thoi-trang" className="menu-link-glow">
              Thời trang
            </Link>
            <Link href="/ca-nhan" className="menu-link-glow">
              Cá nhân
            </Link>
            <Link href="/dich-vu" className="menu-link-glow">
              Dịch Vụ
            </Link>
            <Link href="/gioi-thieu" className="menu-link-glow">
              Giới thiệu
            </Link>
            <ThemeToggle />
          </nav>

          {/* SỬA 2: Gộp ThemeToggle và Nút Hamburger vào chung 1 div */}
          <div className="md:hidden flex items-center space-x-4">
            <ThemeToggle />
            
            <button
              className="" // Đã xóa md:hidden vì div cha đã xử lý
              onClick={() => setIsMenuOpen(!isMenuOpen)}
              aria-label="Toggle navigation"
            >
              {isMenuOpen ? (
                // Icon 'X'
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  fill="none"
                  viewBox="0 0 24 24"
                  strokeWidth={1.5}
                  stroke="currentColor"
                  className="w-6 h-6 cursor-pointer"
                >
                  <path
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    d="M6 18 18 6M6 6l12 12"
                  />
                </svg>
              ) : (
                // Icon 'Hamburger'
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  fill="none"
                  viewBox="0 0 24 24"
                  strokeWidth={1.5}
                  stroke="currentColor"
                  className="w-6 h-6 cursor-pointer"
                >
                  <path
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5"
                  />
                </svg>
              )}
            </button>
          </div>
        </div>
      </Container>

      {/* Menu di động (Giữ nguyên) */}
      <div
        className={`fixed left-0 right-0 top-full h-screen bg-gray-900/75 backdrop-blur-lg border-b shadow-lg md:hidden transition-all duration-300 ease-in-out ${
          isMenuOpen ? 'block opacity-100' : 'hidden opacity-0'
        }`}
      >
       <nav className="flex flex-col ps-10 space-y-8 p-5 text-4xl font-bold text-white mt-5">
          <Link href="/thuong-mai" className="menu-link-glow" onClick={handleLinkClick}>
            Thương mại
          </Link>
          <Link href="/thoi-trang" className="menu-link-glow" onClick={handleLinkClick}>
            Thời trang
          </Link>
          <Link href="/ca-nhan" className="menu-link-glow" onClick={handleLinkClick}>
            Cá nhân
          </Link>
          <Link href="/dich-vu" className="menu-link-glow" onClick={handleLinkClick}>
            Dịch Vụ
          </Link>
          <Link href="/gioi-thieu" className="menu-link-glow" onClick={handleLinkClick}>
            Giới thiệu
          </Link>
        </nav>
      </div>
    </header>
  );
}
</file>

<file path="src/data/projects-master-data.ts">
// src/data/projects-master-data.ts
import { StaticImageData } from 'next/image';

// --- IMPORT ẢNH (Giữ nguyên) ---
import Fashion_01_thumnails from '../assets/project/thoi-trang/Fashion_01_thumnails.webp';
import Fashion_02_thumnails from '../assets/project/thoi-trang/Fashion_02_thumnails.webp';
import Fashion_03_thumnails from '../assets/project/thoi-trang/Fashion_03_thumnails.webp';

import Commercial_01_thumnails from '../assets/project/thuong-mai/Commercial_01_thumnails.webp';
import Commercial_02_thumnails from '../assets/project/thuong-mai/Commercial_02_thumnails.webp';
import Commercial_02_01 from '../assets/project/thuong-mai/Commercial_02_01.webp';
import Commercial_02_02 from '../assets/project/thuong-mai/Commercial_02_02.webp';
import Commercial_02_03 from '../assets/project/thuong-mai/Commercial_02_03.webp';

import Personal_01_thumnails from '../assets/project/ca-nhan/Personal_01_thumnails.webp';

import Personal_02_thumnails from '../assets/project/ca-nhan/Personal_02_thumnails.webp';
import Personal_02_02 from '../assets/project/ca-nhan/Personal_02_02.webp';
import Personal_02_03 from '../assets/project/ca-nhan/Personal_02_03.webp';
import Personal_02_04 from '../assets/project/ca-nhan/Personal_02_04.webp';
import Personal_02_05 from '../assets/project/ca-nhan/Personal_02_05.webp';
import Personal_02_06 from '../assets/project/ca-nhan/Personal_02_06.webp';
import Personal_02_07 from '../assets/project/ca-nhan/Personal_02_07.webp';
import Personal_02_08 from '../assets/project/ca-nhan/Personal_02_08.webp';
import Personal_02_09 from '../assets/project/ca-nhan/Personal_02_09.webp';

// --- 1. ĐỊNH NGHĨA TYPE CHUẨN (Khớp với Supabase Logic) ---

export type ArticleBlock = 
  | { type: 'heading'; content: string }
  | { type: 'paragraph'; content: string }
  | { type: 'imageRow'; images: (StaticImageData | string)[] }; // Cho phép cả URL string và StaticImport

export interface ProjectData {
  id: number;
  slug: string;
  title: string;
  client_name?: string; // Tên hiển thị phụ (VD: Zara, Dior...)
  
  // Image: Cho phép cả StaticImageData (Demo) và string URL (Supabase)
  image: StaticImageData | string; 
  
  category: string;      // Slug danh mục (vd: thoi-trang)
  categoryName: string;  // Tên hiển thị (vd: Thời trang)
  
  year: string;
  
  // Grid Layout (Dùng số nguyên để tính toán logic kéo thả)
  colSpan: number; 
  rowSpan: number; 
  
  isFeatured: boolean;   // Thay cho featured?
  
  // Chi tiết bài viết
  description?: string;
  credits?: { label: string; value: string }[];
  articleBody?: ArticleBlock[];
  align?: 'left' | 'right';
}

// --- 2. DỮ LIỆU MASTER (Dùng cho Demo Mode) ---

export const PROJECTS_MASTER_DATA: ProjectData[] = [
  // ----------------------------------------------------
  // DỰ ÁN 1: THANH XUÂN
  // ----------------------------------------------------
  {
    id: 1,
    slug: 'thanh-xuan-vuon-truong',
    title: 'Thanh xuân vườn trường',
    client_name: 'Personal Project',
    image: Fashion_01_thumnails,
    category: 'thoi-trang',
    categoryName: 'Thời trang',
    year: '2023',
    colSpan: 2, // 2 cột
    rowSpan: 2, // 2 hàng
    isFeatured: false,
    description: "Vượt ra ngoài giới hạn của một bộ đồng phục, dự án này là một cuộc đối thoại với ký ức. Nó tái định nghĩa không gian quen thuộc của sân trường, biến nó thành một sàn diễn của hoài niệm.",
    credits: [
      { label: 'Producer', value: 'Thanh Hang - Choo Production' },
      { label: 'Art Director', value: 'Thien Nguyen' },
      { label: 'Photographer', value: 'Evis Tran' },
      { label: 'Location', value: 'Oni Studio' },
    ],
    articleBody: [
      { type: 'heading', content: 'Di sản của hoài niệm' },
      { type: 'imageRow', images: [Fashion_01_thumnails, Fashion_01_thumnails] },
      { type: 'paragraph', content: "Bối cảnh sân trường không chỉ là phông nền; nó là một nhân vật. Ánh sáng tự nhiên được lọc qua tán lá, tạo ra sự tương phản mềm mại." },
      { type: 'heading', content: 'Chi tiết và tĩnh lặng' },
      { type: 'imageRow', images: [Fashion_01_thumnails] },
      { type: 'paragraph', content: "Sự tập trung vào chi tiết biến bộ đồng phục từ một quy định trở thành một biểu tượng của cá tính." }
    ]
  },

  // ----------------------------------------------------
  // DỰ ÁN 2: CHỦ MÔ HÌNH (ZARA)
  // ----------------------------------------------------
  {
    id: 2,
    slug: 'chu-mo-hinh-zara',
    title: 'Chủ mô hình',
    client_name: 'ZARA',
    image: Commercial_01_thumnails,
    category: 'thuong-mai',
    categoryName: 'Thương mại',
    year: '2024',
    colSpan: 1,
    rowSpan: 1,
    isFeatured: false,
    description: "Trong lãnh địa của e-commerce, sự tối giản là tuyên ngôn tối thượng. Dự án này loại bỏ mọi chi tiết thừa để tập trung vào bản chất thuần túy.",
    credits: [
      { label: 'Client', value: 'ZARA' },
      { label: 'Photographer', value: 'Evis Tran' },
      { label: 'Location', value: 'Oni Studio' },
    ],
    articleBody: [
      { type: 'heading', content: 'Kiến trúc của ánh sáng' },
      { type: 'imageRow', images: [Commercial_01_thumnails] },
      { type: 'paragraph', content: "Ánh sáng được sử dụng như một 'con dao điêu khắc', tách chủ thể khỏi nền xám trơn." },
      { type: 'heading', content: 'Sự tĩnh lặng của chuyển động' },
      { type: 'imageRow', images: [Commercial_01_thumnails, Commercial_01_thumnails] },
      { type: 'paragraph', content: "Mỗi dáng pose là kết quả của kỷ luật, tạo ra những hình ảnh mạnh mẽ và trực diện." }
    ]
  },

  // ----------------------------------------------------
  // DỰ ÁN 3: CÁ NHÂN 01
  // ----------------------------------------------------
  {
    id: 3,
    slug: 'ca-nhan-01',
    title: 'Portrait Series 01',
    client_name: 'Cá nhân',
    image: Personal_01_thumnails,
    category: 'ca-nhan',
    categoryName: 'Cá nhân',
    year: '2023',
    colSpan: 1,
    rowSpan: 2,
    isFeatured: false,
    description: "Nhiếp ảnh chân dung không phải là ghi lại một khuôn mặt, mà là bắt giữ một thế giới nội tâm.",
    credits: [
      { label: 'Photographer', value: 'Evis Tran' },
      { label: 'Model', value: 'Mai Phuoc Tri' },
    ],
    articleBody: [
      { type: 'heading', content: 'Vẻ đẹp của Chiaroscuro' },
      { type: 'imageRow', images: [Personal_01_thumnails, Personal_01_thumnails, Personal_01_thumnails] },
      { type: 'paragraph', content: "Chúng tôi chọn ánh sáng cửa sổ duy nhất để tôn vinh nghệ thuật tương phản Chiaroscuro." }
    ]
  },

  // ----------------------------------------------------
  // DỰ ÁN 4: HOKKAIDO 
  // ----------------------------------------------------
  {
    id: 4,
    slug: 'ngon-lua-giua-tuyet',
    title: 'Ngọn lửa giữa Tuyết',
    client_name: 'Editorial',
    image: Fashion_02_thumnails,
    category: 'thoi-trang',
    categoryName: 'Thời trang',
    year: '2024',
    colSpan: 1,
    rowSpan: 2,
    isFeatured: false,
    description: "Dự án cá nhân này khám phá sự tương phản giữa cái lạnh buốt của ngoại cảnh và hơi ấm nội tâm.",
    credits: [
      { label: 'Location', value: 'Hokkaido, Japan' },
      { label: 'Photographer', value: 'Evis Tran' },
    ],
    articleBody: [
      { type: 'heading', content: 'Sức sống mỏng manh' },
      { type: 'imageRow', images: [Fashion_02_thumnails, Fashion_02_thumnails] },
      { type: 'paragraph', content: "Giữa khung cảnh bao la của tuyết trắng, ánh lửa đỏ cam trở thành tuyên ngôn duy nhất về sự tồn tại." }
    ]
  },

  // ----------------------------------------------------
  // DỰ ÁN 5: L'OFFICIEL 
  // ----------------------------------------------------
  {
    id: 5,
    slug: 'hoi-tho-golden-hour',
    title: "Hơi thở 'Golden Hour'",
    client_name: "L'Officiel Vietnam",
    image: Fashion_03_thumnails,
    category: 'thoi-trang',
    categoryName: 'Thời trang',
    year: '2023',
    colSpan: 2,
    rowSpan: 1,
    isFeatured: true,
    description: "Một bộ ảnh editorial khám phá sự kết nối giữa con người và thiên nhiên trong khoảnh khắc vàng.",
    credits: [
      { label: 'Client', value: "L'Officiel" },
      { label: 'Photographer', value: 'Evis Tran' },
    ],
    articleBody: [
      { type: 'heading', content: 'Đối thoại với hoàng hôn' },
      { type: 'imageRow', images: [Fashion_03_thumnails, Fashion_03_thumnails] },
      { type: 'paragraph', content: "Golden hour là khoảnh khắc ánh sáng không chỉ chiếu rọi, mà còn 'chạm' vào vạn vật." }
    ]
  },

  // ----------------------------------------------------
  // DỰ ÁN 6: DIOR 
  // ----------------------------------------------------
  {
    id: 6,
    slug: 'khoanh-khac-playful-dior',
    title: "Khoảnh khắc 'Playful' Dior",
    client_name: 'Dior Beauty',
    image: Commercial_02_thumnails,
    category: 'thuong-mai',
    categoryName: 'Thương mại',
    year: '2024',
    colSpan: 1,
    rowSpan: 1,
    isFeatured: true,
    description: "Nắm bắt tinh thần trẻ trung, phá cách tại sự kiện độc quyền của Dior.",
    credits: [
      { label: 'Client', value: 'Dior' },
      { label: 'Photographer', value: 'Evis Tran' },
    ],
    articleBody: [
      { type: 'heading', content: 'Tuyên ngôn của sự nổi loạn' },
      { type: 'imageRow', images: [Commercial_02_thumnails] },
      { type: 'imageRow', images: [Commercial_02_01, Commercial_02_02] },
      { type: 'imageRow', images: [Commercial_02_thumnails, Commercial_02_03] },
      { type: 'paragraph', content: "Khoảnh khắc 'playful' phá vỡ sự trang trọng của di sản Dior." }
    ]
  },

  // ----------------------------------------------------
  // DỰ ÁN 7: SG 1990 
  // ----------------------------------------------------
  {
    id: 7,
    slug: 'net-lang-du-sai-gon-thap-nien-90',
    title: "Nét Lãng Du Sài Gòn",
    client_name: 'Personal Project',
    image: Personal_02_thumnails,
    category: 'ca-nhan',
    categoryName: 'Cá nhân',
    year: '2022',
    colSpan: 1,
    rowSpan: 1,
    isFeatured: true,
    description: "Không khí hoài cổ, lãng mạn và có chút bụi bặm của Sài Gòn những năm 90.",
    credits: [
      { label: 'Concept', value: 'Saigon 1990' },
      { label: 'Photographer', value: 'Evis Tran' },
    ],
    articleBody: [
      { type: 'heading', content: 'Ý Tưởng & Chủ Đề' },
      { type: 'imageRow', images: [Personal_02_thumnails] },
      { type: 'imageRow', images: [Personal_02_02, Personal_02_03, Personal_02_04] },
      { type: 'imageRow', images: [Personal_02_05, Personal_02_06, Personal_02_07] },
      { type: 'imageRow', images: [Personal_02_thumnails, Personal_02_08, Personal_02_09] },
      { type: 'paragraph', content: "Tái hiện lại không khí hoài cổ, lãng mạn của Sài Gòn xưa." }
    ]
  },
];
</file>

<file path="next.config.ts">
// next.config.ts
import type { NextConfig } from "next";

const nextConfig: NextConfig = {


  images: {
    remotePatterns: [
      {
        protocol: 'https',

        hostname: '**.supabase.co',

      },
      {
        protocol: 'https',
        hostname: 'images.unsplash.com',
      }
    ],
  },

  // Tắt strict mode nếu muốn (optional), nhưng nên để true
  reactStrictMode: true, 
  
  // Tắt cảnh báo ESLint lúc build để tránh fail build vì lỗi nhỏ (Optional)
  eslint: {
    ignoreDuringBuilds: true,
  },
  typescript: {
    ignoreBuildErrors: true,
  }
};

export default nextConfig;
</file>

<file path="src/app/admin/settings/page.tsx">
// src/app/admin/settings/page.tsx
import SettingsForm from '@/components/admin/SettingsForm';
import { Settings } from 'lucide-react';
import { createServerClient } from '@supabase/ssr'; 
import { cookies } from 'next/headers'; 
import { redirect } from 'next/navigation'; 
import { getSettings, getCleanupMinutes } from '@/lib/actions/settings';

export default async function AdminSettingsPage() {
  const cookieStore = await cookies(); 
  
  // 1. Fetch dữ liệu song song (Server Side)
  const [settings, cleanupMinutes] = await Promise.all([
    getSettings(),
    getCleanupMinutes()
  ]);

  const supabase = createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        getAll() { return cookieStore.getAll() },
        setAll() {} 
      },
    }
  );

  const { data: { user } } = await supabase.auth.getUser();
  if (!user) redirect('/login');

  const { data: profile } = await supabase
    .from('users')
    .select('role')
    .eq('auth_id', user.id)
    .single();

  if (profile?.role !== 'Admin') {
    redirect('/admin');
  }

  // --- XÓA DÒNG NÀY (Vì biến settings đã có ở trên dòng 14) ---
  // const settings = await getSettings(); 

  return (
    <div className="max-w-7xl mx-auto pb-20">
      <div className="mb-8">
        <h1 className="text-3xl font-bold text-[var(--admin-fg)] flex items-center gap-3">
          <Settings className="text-[var(--admin-primary)]" size={32} />
          Cài đặt chung
        </h1>
        <p className="text-[var(--admin-sub)] mt-2">
          Quản lý các thông số cấu hình toàn cục của hệ thống.
        </p>
      </div>

      <SettingsForm 
        initialSettings={settings} 
        initialCleanupMinutes={cleanupMinutes} // Giờ Props này sẽ hợp lệ sau khi sửa bước 2
      />
    </div>
  );
}
</file>

<file path="src/app/du-an/[slug]/ProjectClientPage.tsx">
// src/app/du-an/[slug]/ProjectClientPage.tsx
'use client';

import React, { useState, useMemo, useCallback } from 'react';
import Image, { StaticImageData } from 'next/image';
import { useInView } from 'react-intersection-observer';
import { ProjectData } from '@/data/projects-master-data'; 
import ProjectNavigation from '@/components/ProjectNavigation';
// Lưu ý: Đảm bảo đường dẫn CSS đúng với dự án của bạn
import styles from '../../styles/ProjectArticle.module.css';

// --- LIGHTBOX ---
import Lightbox from 'yet-another-react-lightbox';
import Zoom from 'yet-another-react-lightbox/plugins/zoom';
import Captions from 'yet-another-react-lightbox/plugins/captions';
import Thumbnails from 'yet-another-react-lightbox/plugins/thumbnails';
import 'yet-another-react-lightbox/styles.css';
import 'yet-another-react-lightbox/plugins/captions.css';
import 'yet-another-react-lightbox/plugins/thumbnails.css';

// --- 1. Component Ảnh Chi Tiết ---
interface ArticleImageProps {
  image: StaticImageData | string;
  onClick: () => void;
  imageCount: number;
}

const ArticleImage = React.memo(({ image, onClick, imageCount }: ArticleImageProps) => {
  // Logic chia cột thông minh
  const getWidthClass = (count: number): string => {
    switch (count) {
      case 1: return 'w-full'; // 1 ảnh -> Full
      case 2: return 'w-full md:w-[49%]'; // 2 ảnh -> 50%
      case 3: return 'w-full md:w-[32%]'; // 3 ảnh -> 33%
      default: return 'w-full md:w-[49%]'; // 4+ ảnh -> 50%
    }
  };

  const widthClass = getWidthClass(imageCount);

  return (
    <div
      className={`${widthClass} relative aspect-[3/4] flex-shrink-0 cursor-pointer overflow-hidden rounded-sm shadow-sm transition-all duration-500 hover:shadow-xl hover:scale-[1.01]`}
      onClick={onClick}
    >
      <Image
        src={image} 
        alt="Project detail"
        fill
        className="object-cover transition-opacity duration-300 hover:opacity-90"
        quality={90}
        sizes="(max-width: 768px) 100vw, 50vw"
      />
    </div>
  );
});
ArticleImage.displayName = 'ArticleImage';

// --- 2. Component Chính ---
interface ProjectClientPageProps {
  project: ProjectData;
  prevProjectLink: string | null;
  nextProjectLink: string | null;
}

export default function ProjectClientPage({
  project,
  prevProjectLink,
  nextProjectLink,
}: ProjectClientPageProps) {
  
  const [navRef, navInView] = useInView({ threshold: 0.1, triggerOnce: true });
  const [lightboxOpen, setLightboxOpen] = useState(false);
  const [lightboxIndex, setLightboxIndex] = useState(0);

  // Lấy thông tin Location & Client để hiển thị nổi bật
  const locationCredit = useMemo(() => project.credits?.find((c) => c.label.toLowerCase().includes('location')), [project.credits]);
  const clientCredit = useMemo(() => project.credits?.find((c) => c.label.toLowerCase().includes('client')), [project.credits]);

  // Gom toàn bộ ảnh để dùng cho Lightbox
  const allProjectImages = useMemo(() => {
    return (
      project.articleBody
        ?.filter((block) => block.type === 'imageRow')
        .flatMap((block) => (block as { images: (StaticImageData | string)[] }).images) || []
    );
  }, [project.articleBody]);

  const lightboxSlides = useMemo(
    () => allProjectImages.map((img) => ({ 
      src: typeof img === 'string' ? img : img.src 
    })),
    [allProjectImages]
  );

  const handleImageClick = useCallback(
    (clickedImage: StaticImageData | string) => {
      const clickedSrc = typeof clickedImage === 'string' ? clickedImage : clickedImage.src;
      const index = allProjectImages.findIndex((img) => {
        const imgSrc = typeof img === 'string' ? img : img.src;
        return imgSrc === clickedSrc;
      });

      if (index !== -1) {
        setLightboxIndex(index);
        setLightboxOpen(true);
      }
    },
    [allProjectImages]
  );

  return (
    <>
      <article className={styles.articleContainer}>
        
        {/* --- HEADER BÀI VIẾT --- */}
        <header className="mb-12 md:mb-20 text-center">
          {/* Category & Year */}
          <div className="flex items-center justify-center gap-3 text-xs font-bold tracking-[0.2em] text-[var(--sub-text)] uppercase mb-4">
            <span>{project.categoryName}</span>
            <span className="w-1 h-1 rounded-full bg-[var(--sub-text)]"></span>
            <span>{project.year}</span>
          </div>

          {/* Title */}
          <h1 className={styles.articleTitle}>{project.title}</h1>

          {/* Meta Info (Client / Location) */}
          <div className="flex flex-wrap justify-center gap-6 mt-6 text-sm font-medium text-[var(--foreground)]">
            {clientCredit && (
              <div className="flex items-center gap-2">
                <span className="text-[var(--sub-text)]">Client:</span>
                <span>{clientCredit.value}</span>
              </div>
            )}
            {locationCredit && (
              <div className="flex items-center gap-2">
                <span className="text-[var(--sub-text)]">Location:</span>
                <span>{locationCredit.value}</span>
              </div>
            )}
          </div>
        </header>

        {/* --- HERO THUMBNAIL (Nếu muốn hiển thị lại ảnh bìa) --- */}
        {/* <div className="w-full aspect-[16/9] relative mb-16 rounded-lg overflow-hidden shadow-lg">
           <Image src={project.image} alt={project.title} fill className="object-cover" priority />
        </div> */}

        {/* --- INTRO DESCRIPTION --- */}
        {project.description && (
          <div className={styles.textWrap}>
            <p className="text-lg md:text-xl leading-relaxed font-light italic text-[var(--sub-text)] border-l-2 border-[var(--foreground)] pl-6">
              {project.description}
            </p>
          </div>
        )}

        {/* --- MAIN CONTENT BODY --- */}
        <div className="space-y-12 md:space-y-20 mt-16">
          {project.articleBody?.map((block, index) => {
            switch (block.type) {
              case 'heading':
                return (
                  <div key={index} className={styles.highlightWrap}>
                    <h2 className="text-2xl md:text-3xl font-bold text-[var(--foreground)] mt-8 mb-4">
                      {block.content}
                    </h2>
                  </div>
                );
              case 'paragraph':
                return (
                  <div key={index} className={styles.textWrap}>
                    <p className="text-base md:text-lg leading-loose text-[var(--sub-text)]">
                      {block.content}
                    </p>
                  </div>
                );
              case 'imageRow':
                const imageCount = block.images.length;
                return (
                  <div key={index} className={`${styles.imageRow} flex flex-wrap gap-2 md:gap-4 justify-center`}>
                    {block.images.map((img, imgIndex) => (
                      <ArticleImage
                        key={`${index}-${imgIndex}`}
                        image={img}
                        onClick={() => handleImageClick(img)}
                        imageCount={imageCount}
                      />
                    ))}
                  </div>
                );
              default:
                return null;
            }
          })}
        </div>

        {/* --- FOOTER CREDITS --- */}
        {project.credits && project.credits.length > 0 && (
          <div className="mt-24 pt-12 border-t border-[var(--foreground)]/10">
            <h3 className="text-md text-center uppercase font-bold tracking-widest mb-8 text-[var(--foreground)]">
              Credit
            </h3>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-x-12 gap-y-4 max-w-2xl mx-auto">
              {project.credits.map((credit, index) => (
                <div key={index} className="flex justify-between items-baseline text-sm border-b border-dashed border-[var(--sub-text)]/20 pb-2">
                  <span className="font-semibold text-[var(--sub-text)] opacity-80">
                    {credit.label}
                  </span>
                  <span className="text-right text-[var(--foreground)] font-medium">
                    {credit.value}
                  </span>
                </div>
              ))}
            </div>
          </div>
        )}

        {/* --- NAVIGATION --- */}
        <div
          ref={navRef}
          className={`mt-24 transition-opacity duration-1000 ${
            navInView ? 'opacity-100 translate-y-0' : 'opacity-0 translate-y-10'
          }`}
        >
          <ProjectNavigation
            prevProjectLink={prevProjectLink}
            nextProjectLink={nextProjectLink}
          />
        </div>
      </article>

      {/* --- LIGHTBOX COMPONENT --- */}
      <Lightbox
        open={lightboxOpen}
        close={() => setLightboxOpen(false)}
        index={lightboxIndex}
        slides={lightboxSlides}
        plugins={[Zoom, Thumbnails, Captions]}
        animation={{ fade: 300, swipe: 250 }}
        carousel={{ finite: false }}
        controller={{ closeOnBackdropClick: true }}
        zoom={{ maxZoomPixelRatio: 3 }}
        styles={{ container: { backgroundColor: "rgba(0, 0, 0, .95)" } }}
      />
    </>
  );
}
</file>

<file path="src/app/dich-vu/page.tsx">
// app/dich-vu/page.tsx
'use client'; // Bắt buộc vì dùng state và hooks

import React, { useState, useEffect, useRef } from 'react';
import Container from '@/components/Container';
import styles from '../styles/DichVu.module.css';
import Image from 'next/image';
import BtsSection from '@/components/BtsSection';
// ROOM IMAGES
import room_A_img from '../../assets/service/section_01/room_A.webp';
import room_B_img from '../../assets/service/section_01/room_B.webp';
import room_C_img from '../../assets/service/section_01/room_C.webp';
import room_D_img from '../../assets/service/section_01/room_D.webp';

// DEVICE IMAGES
import img_godox_dp600 from '../../assets/service/section_02/GODOX-DP600III-V.webp';
import img_godox_dp400 from '../../assets/service/section_02/GODOX-GD-DP400II-V.webp';
import img_godox_qt400 from '../../assets/service/section_02/GODOX-QT400IIIM.webp';
import img_godox_qt600 from '../../assets/service/section_02/GODOX-QT600II.webp';
import img_godox_qs400 from '../../assets/service/section_02/GODOX-QS-400.webp';
import img_godox_qs800 from '../../assets/service/section_02/GODOX-QS-800.webp';
import img_godox_qs1200 from '../../assets/service/section_02/GODOX-QS-1200.webp';
import img_amaran_300c from '../../assets/service/section_02/aputure-amaran-300c.webp';
import img_devices from '../../assets/service/section_02/devices.webp';

// MODIFIER IMAGES
import img_QR_p60t from '../../assets/service/section_02/GODOX-QR-P60T.webp';
import img_QR_p90 from '../../assets/service/section_02/GODOX-QR-P90.webp';
import img_QR_P120 from '../../assets/service/section_02/GODOX-QR-P120.webp';
import img_QR_P150t from '../../assets/service/section_02/GODOX-QR-P150T.webp';

// 1. ĐỊNH NGHĨA CÁC MỤC (Sections) - (Giữ nguyên, đã đúng)
const sections = [
  { id: 'bao-gia', title: 'Báo Giá Phòng', contentId: 'section-01' },
  { id: 'thiet-bi-mien-phi', title: 'Thiết Bị Đi Kèm', contentId: 'section-02' },
  { id: 'thiet-bi-thue-them', title: 'Thiết Bị Thuê Thêm', contentId: 'section-03' },
  { id: 'quy-dinh', title: 'Lưu Ý & Quy Định', contentId: 'section-04' },
];

// 2. COMPONENT "SCENE" (Giữ nguyên)
interface SceneProps {
  children: React.ReactNode;
  id: string;
  onVisible: (id: string) => void;
}

const Scene: React.FC<SceneProps> = ({ children, id, onVisible }) => {
  const ref = useRef<HTMLDivElement>(null);

useEffect(() => {
    const node = ref.current;
    if (!node) return;

    const observer = new IntersectionObserver(
      (entries) => {
        const [entry] = entries;
        if (entry.isIntersecting) {
          onVisible(id); // Báo cho component cha biết mục này đang active
        }
      },
      {
        rootMargin: '-50% 0px 0% 0px',
        threshold: 0,
      }
    );

    observer.observe(node);
    return () => observer.disconnect();
  }, [id, onVisible]);

  return (
    <div ref={ref} id={id} className={styles.sceneContent}>
      {children}
    </div>
  );
};
// 3. COMPONENT TRANG CHÍNH
export default function DichVuPage() {
  const [activeId, setActiveId] = useState(sections[0].id);
  
  // Dữ liệu cho Section 02 (Miễn Phí)
  const strobes = [
    { name: 'Godox DP400', img: img_godox_dp400 },
    { name: 'Godox DP600', img: img_godox_dp600 },
    { name: 'Godox QT400', img: img_godox_qt400 },
    { name: 'Godox QT600', img: img_godox_qt600 },
    { name: 'Godox QS400', img: img_godox_qs400 },
    { name: 'Godox QS800', img: img_godox_qs800 },
    { name: 'Godox QS1200', img: img_godox_qs1200 },
    { name: 'Aputure Amaran 300C', img: img_amaran_300c },

  ];

  const modifiers = [
    { name: 'Godox QR P60T', img: img_QR_p60t },
    { name: 'Godox QR P90', img: img_QR_p90 },
    { name: 'Godox QR P120', img: img_QR_P120 },
    { name: 'Godox QR P150T', img: img_QR_P150t },
  ];

  const rentalItems = [
    { name: 'Nanlite FS300B', price: '300k/đèn', note: '(có sẵn 2 đèn)' },
    { name: 'Nanlite FS200B', price: '200k/đèn', note: '(có sẵn 3 đèn)' },
    { name: 'Tolifo 1800W-Bi', price: '400k/đèn', note: '(có sẵn 1 đèn)' },
    { name: 'Nanlite FS150', price: '150k/đèn', note: '(có sẵn 1 đèn)' },
    { name: 'Nanlite Forza 60', price: '50k/đèn', note: '(có sẵn 2 đèn)' },
    { name: 'Tether (dây)', price: '75k/dây' },
    { name: 'iMac 27" 5k', price: '250k/buổi' },
    { name: 'Màn Dell 25"', price: '150k/buổi' },
    { name: 'Phông vải/xanh key (6x6.4m)', price: '200k' },
  ];

  const paperColors = [
    { name: '44 Jet', hex: '#1f1f1f' },
    { name: '04 Neutral Grey', hex: '#7c7f7e' },
    { name: '42 Morning Mist', hex: '#d9dadb' },
    { name: '01 Deep Blue', hex: '#35475e' },
    { name: '41 Marine Blue', hex: '#69819d' },
    { name: '61 Blue Lake', hex: '#4c7da6' },
    { name: '06 Nassau', hex: '#008bc0' },
    { name: '59 Lite Blue', hex: '#70c5d5' },
    { name: '55 Alpine', hex: '#b3d8d6' },
    { name: '67 Nutmeg', hex: '#8e6f5c' },
    { name: '33 Ivorine', hex: '#e5d9bb' },
    { name: '13 Deep Green', hex: '#1e4a42' },
    { name: '10 Leaf', hex: '#485f39' },
    { name: '54 Stinger', hex: '#78a34b' },
    { name: '63 Apple', hex: '#b7d296' },
    { name: '14 Forsythia Yellow', hex: '#f3c421' },
    { name: '83 Yellow-Orange', hex: '#f5822e' },
    { name: '27 Flame', hex: '#d44a3b' },
    { name: '56 Scarlet', hex: '#ba2429' },
    { name: '10 Bright Orange', hex: '#f3642c' },
    { name: '29 Thistle', hex: '#d6a9b9' },
    { name: '17 Carnation Pink', hex: '#f093a5' },
  ];

  // Mảng 2: Phông Vải Trơn
  const fabricColorsPlain = [
    { name: 'Đen', hex: '#000000' },
    { name: 'Đỏ', hex: '#cc3333' },
    { name: 'Xanh', hex: '#006633' },
  ];
  
  // Mảng 3: Phông Vải Loang
  const fabricColorsPatterned = [
    { name: 'Nâu Loang', hex: '#8c7a65' },
    { name: 'Xám Sáng Loang', hex: '#c1c1c1' },
    { name: 'Xám Tối Loang', hex: '#6e6e6e' },
  ];
  
  // Mảng 4: Thảm Nỉ
  const carpetColors = [
    { name: 'Đỏ Đô', hex: '#800000' },
    { name: 'Xanh Navy', hex: '#000080' },
  ];
  return (
    <main>
      <Container className="py-16 md:py-24">
        {/* Tiêu đề chung của trang */}
        <div className="text-center mb-16">
          <h1 className="text-4xl md:text-5xl font-light tracking-tighter">
            Dịch Vụ & Báo Giá
          </h1>
          <p className="text-lg mt-4 text-[var(--sub-text)]">
            Tất cả thông tin về các gói thuê và thiết bị tại studio.
          </p>
        </div>

        {/* BỐ CỤC 2 CỘT */}
        <div className={styles.stickyLayout}>
          {/* CỘT 1: MENU (DÍNH LẠI) */}
          <nav className={styles.stickyNav}>
            <ul>
              {sections.map((section) => (
                <li key={section.id}>
                  <a
                    href={`#${section.id}`}
                    className={activeId === section.id ? styles.active : ''}
                  >
                    {section.title}
                  </a>
                </li>
              ))}
            </ul>
          </nav>

          {/* CỘT 2: NỘI DUNG (CUỘN) */}
          <main className={styles.contentColumn}>
            {/* === MỤC 01: BÁO GIÁ PHÒNG === */}
            <Scene id="bao-gia" onVisible={setActiveId}>
              <h2 className={styles.contentTitle}>Báo Giá Thuê Phòng</h2>
              
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6 lg:gap-8">
                
                {/* --- THẺ 1: ROOM A --- */}
                <div className="border border-[var(--foreground)]/30 rounded-lg overflow-hidden bg-[var(--background)] flex flex-col">
                  <div className="relative w-full h-72">
                    <Image
                      src={room_A_img}
                      alt="Không gian phòng studio A"
                      fill
                      sizes="(max-width: 768px) 100vw, 50vw"
                      className="object-cover"
                      priority
                      placeholder="blur"
                    />
                  </div>
                  <div className="p-6 flex flex-col flex-grow">
                    <h3 className="text-2xl font-semibold mb-4">Room A</h3>
                    <div className="mb-4">
                      <span className="text-4xl font-bold">300k</span>
                      <span className="text-lg text-[var(--foreground)]/70">/giờ</span>
                      <p className="text-sm text-[var(--foreground)]/70 -mt-1">
                        (Áp dụng cho lịch book từ 2 tiếng)
                      </p>
                    </div>
                    <div className="mb-5 p-3 bg-[var(--foreground)]/5 border border-[var(--foreground)]/10 rounded-lg">
                      <span className="text-2xl font-bold">350k</span>
                      <span className="text-base text-[var(--foreground)]/70">/giờ</span>
                      <p className="text-sm text-[var(--foreground)]/70">
                        (Cho lịch book dưới 2 tiếng)
                      </p>
                    </div>
                    <ul className="space-y-1 text-sm list-disc list-inside mt-auto">
                      <li>60m²</li>
                      <li>(D8,5 x R5,8 x C4,3)</li>
                    </ul>
                  </div>
                </div>

                {/* --- THẺ 2: ROOM B --- */}
                <div className="border border-[var(--foreground)]/30 rounded-lg overflow-hidden bg-[var(--background)] flex flex-col">
                  <div className="relative w-full h-72">
                    <Image
                      src={room_B_img}
                      alt="Không gian phòng studio B"
                      fill
                      sizes="(max-width: 768px) 100vw, 50vw"
                      className="object-cover"
                      priority={true}
                      placeholder="blur" 
                    />
                  </div>
                  <div className="p-6 flex flex-col flex-grow">
                    <h3 className="text-2xl font-semibold mb-4">Room B</h3>
                    <div className="mb-4">
                      <span className="text-4xl font-bold">300k</span>
                      <span className="text-lg text-[var(--foreground)]/70">/giờ</span>
                      <p className="text-sm text-[var(--foreground)]/70 -mt-1">
                        (Áp dụng cho lịch book từ 2 tiếng)
                      </p>
                    </div>
                    <div className="mb-5 p-3 bg-[var(--foreground)]/5 border border-[var(--foreground)]/10 rounded-lg">
                      <span className="text-2xl font-bold">350k</span>
                      <span className="text-base text-[var(--foreground)]/70">/giờ</span>
                      <p className="text-sm text-[var(--foreground)]/70">
                        (Cho lịch book dưới 2 tiếng)
                      </p>
                    </div>
                    <ul className="space-y-1 text-sm list-disc list-inside mt-auto">
                      <li>65m²</li>
                      <li>(D9 x R3,7 x C3,8)</li>
                    </ul>
                  </div>
                </div>

                {/* --- THẺ 3: ROOM C --- */}
                <div className="border border-[var(--foreground)]/30 rounded-lg overflow-hidden bg-[var(--background)] flex flex-col">
                  <div className="relative w-full h-72">
                    <Image
                      src={room_C_img}
                      alt="Không gian phòng studio C"
                      fill
                      sizes="(max-width: 768px) 100vw, 50vw"
                      className="object-cover"
                      priority
                      placeholder="blur" 
                    />
                  </div>
                  <div className="p-6 flex flex-col flex-grow">
                    <h3 className="text-2xl font-semibold mb-4">Room C</h3>
                    <div className="mb-4">
                      <span className="text-4xl font-bold">300k</span>
                      <span className="text-lg text-[var(--foreground)]/70">/giờ</span>
                      <p className="text-sm text-[var(--foreground)]/70 -mt-1">
                        (Áp dụng cho lịch book từ 2 tiếng)
                      </p>
                    </div>
                    <div className="mb-5 p-3 bg-[var(--foreground)]/5 border border-[var(--foreground)]/10 rounded-lg">
                      <span className="text-2xl font-bold">350k</span>
                      <span className="text-base text-[var(--foreground)]/70">/giờ</span>
                      <p className="text-sm text-[var(--foreground)]/70">
                        (Cho lịch book dưới 2 tiếng)
                      </p>
                    </div>
                    <ul className="space-y-1 text-sm list-disc list-inside mt-auto">
                      <li>60m²</li>
                      <li>(D8,6 x R6 x C3,9)</li>
                    </ul>
                  </div>
                </div>

                {/* --- THẺ 4: ROOM D --- */}
                <div className="border border-[var(--foreground)]/30 rounded-lg overflow-hidden bg-[var(--background)] flex flex-col">
                  <div className="relative w-full h-72">
                    <Image
                      src={room_D_img}
                      alt="Không gian phòng studio D"
                      fill
                      sizes="(max-width: 768px) 100vw, 50vw"
                      className="object-cover"
                      priority
                      placeholder="blur"
                    />
                  </div>
                  <div className="p-6 flex flex-col flex-grow">
                    <h3 className="text-2xl font-semibold mb-4">Room D</h3>
                    <div className="mb-4">
                      <span className="text-4xl font-bold">280k</span>
                      <span className="text-lg text-[var(--foreground)]/70">/giờ</span>
                      <p className="text-sm text-[var(--foreground)]/70 -mt-1">
                        (Áp dụng cho lịch book từ 2 tiếng)
                      </p>
                    </div>
                    <div className="mb-5 p-3 bg-[var(--foreground)]/5 border border-[var(--foreground)]/10 rounded-lg">
                      <span className="text-2xl font-bold">320k</span>
                      <span className="text-base text-[var(--foreground)]/70">/giờ</span>
                      <p className="text-sm text-[var(--foreground)]/70">
                        (Cho lịch book dưới 2 tiếng)
                      </p>
                    </div>
                    <ul className="space-y-1 text-sm list-disc list-inside mt-auto">
                      <li>45m²</li>
                      <li>(D8,2 x R4,6 x C3,3)</li>
                    </ul>
                  </div>
                </div>
              </div> 
              
              <div className="mt-8">
                <div className="p-4 bg-[var(--foreground)]/5 border border-[var(--foreground)]/10 rounded-lg">
                  <p className="font-semibold text-center text-sm">
                    * Phụ thu 50k/h nếu có sử dụng đèn LED (đèn quay phim).
                  </p>
                </div>
              </div>
            </Scene>


            <Scene id="thiet-bi-mien-phi" onVisible={setActiveId}>
              <h2 className={styles.contentTitle}>Thiết Bị Đi Kèm (Miễn Phí)</h2>

              {/* 1. ẢNH HERO "WOW FACTOR" */}
              <div className="relative w-full h-72 md:h-96 rounded-lg overflow-hidden mb-12 border border-[var(--foreground)]/30">
                <Image
                  src={img_devices}
                  alt="Toàn bộ thiết bị tại Oni Studio"
                  fill
                  className="object-cover hover:scale-110"
                  sizes="(max-width: 768px) 100vw, 70vw"
                  placeholder="blur"
                />
                <div className="absolute inset-0" />
              </div>

              {/* 2. GRID ĐÈN STUDIO */}
              <h3 className="text-2xl font-semibold mb-6">Đèn Godox</h3>
              <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                {strobes.map((item) => (
                  <div key={item.name} className="border border-[var(--foreground)]/30 rounded-lg overflow-hidden bg-[var(--background)] flex flex-col">
                    <div className="relative w-full h-40 bg-white">
                      <Image
                        src={item.img}
                        alt={item.name}
                        fill
                        sizes="(max-width: 768px) 50vw, 25vw"
                        className="object-contain p-2"
                        placeholder="blur"
                      />
                    </div>
                    <div className="p-4 text-center">
                      <h4 className="font-semibold text-sm">{item.name}</h4>
                    </div>
                  </div>
                ))}
              </div>
              <p className="text-center text-sm text-[var(--foreground)]/70 mb-12">
                (Hỗ trợ setup tối đa 4 đèn flash)
              </p>

              {/* 3. GRID TẢN SÁNG */}
              <h3 className="text-2xl font-semibold mb-6">Tản Sáng</h3>
              <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-12">
                {modifiers.map((item) => (
                  <div key={item.name} className="border border-[var(--foreground)]/30 rounded-lg overflow-hidden bg-[var(--background)] flex flex-col">
                    <div className="relative w-full h-40 bg-white">
                      <Image
                        src={item.img}
                        alt={item.name}
                        fill
                        sizes="(max-width: 768px) 50vw, 25vw"
                        className="object-contain p-2"
                        placeholder="blur"
                      />
                    </div>
                    <div className="p-4 text-center">
                      <h4 className="font-semibold text-sm">{item.name}</h4>
                    </div>
                  </div>
                ))}
              </div>

              {/* 4. PHÔNG NỀN & PHỤ KIỆN */}
              <h3 className="text-2xl font-semibold mb-6">Phông Nền & Phụ Kiện</h3>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-8 p-6 bg-[var(--foreground)]/5 border border-[var(--foreground)]/10 rounded-lg">
                
                {/* --- CỘT 1: PHÔNG GIẤY & TƯỜNG (Nội dung dài) --- */}
                <div>
                  <h4 className="text-lg font-semibold mb-4">Phông Giấy & Tường</h4>
                  
                  {/* Tường Vô Cực */}
                  <div className="mb-4">
                    <h5 className="text-base font-semibold mb-2">Tường Trắng Vô Cực</h5>
                    <div className="flex items-center gap-2">
                      <div
                        className={styles.colorSwatch}
                        style={{ backgroundColor: '#ffffff' }}
                      />
                      <span className="text-sm">Sử dụng miễn phí</span>
                    </div>
                  </div>

                  {/* Phông Giấy */}
                  <div>
                    <h5 className="text-base font-semibold mb-2">Phông Giấy (11x2.7m)</h5>
                    <div className="flex flex-wrap gap-x-5 gap-y-3 mt-3">
                      {paperColors.map((color) => (
                        <div
                          key={color.name}
                          className={styles.colorSwatch}
                          style={{ backgroundColor: color.hex }}
                          title={color.name} // Hiện tên khi hover
                        />
                      ))}
                    </div>
                  </div>

                  {/* Phụ Kiện Chung */}
                  <div>
                    <h4 className="text-lg font-semibold my-4">Phụ Kiện Chung</h4>
                    <ul className="space-y-1.5 list-disc list-inside text-sm">
                      <li>Chóa đèn, Bandoor, Dù (đen/trắng/bạc)</li>
                      <li>Tản sáng, Hắt sáng 5-in-1, Poly (đen/trắng)</li>
                      <li>Gel màu, Snoot (gom sáng), Ngàm</li>
                      <li>C-stand, Boom, Chân đèn các loại</li>
                      <li>Bàn chụp sản phẩm, Ghế đôn</li>
                      <li>Bàn ủi hơi nước, Sào treo quần áo</li>
                      <li>Và nhiều phụ kiện khác...</li>
                    </ul>
                  </div>

                </div>

                {/* --- CỘT 2: VẢI, THẢM & PHỤ KIỆN (Nội dung ngắn hơn) --- */}
                <div>
                  {/* Phông Vải & Thảm */}
                  <div className="mb-6">
                    <h4 className="text-lg font-semibold mb-4">Phông Vải & Thảm</h4>
                    {/* Phông Vải */}
                    <div className="mb-4">
                      <h5 className="text-base font-semibold mb-2">Phông Vải</h5>
                      <div className="flex gap-12">
                        {/* Vải Trơn */}
                        <div>
                          <h6 className="text-sm font-semibold mb-2 opacity-70">Trơn</h6>
                          <div className="flex flex-wrap gap-x-4 gap-y-3">
                            {fabricColorsPlain.map((color) => (
                              <div
                                key={color.name}
                                className={styles.colorSwatch}
                                style={{ backgroundColor: color.hex }}
                                title={color.name}
                              />
                            ))}
                          </div>
                        </div>
                        {/* Vải Loang */}
                        <div>
                          <h6 className="text-sm font-semibold mb-2 opacity-70">Loang</h6>
                          <div className="flex flex-wrap gap-x-4 gap-y-3">
                            {fabricColorsPatterned.map((color) => (
                              <div
                                key={color.name}
                                className={styles.colorSwatch}
                                style={{ 
                                  background: `radial-gradient(ellipse at center, ${color.hex} 50%, #5c5c5c 100%)`
                                }}
                                title={color.name}
                              />
                            ))}
                          </div>
                        </div>
                      </div>
                    </div>
                    {/* Thảm Nỉ */}
                    <div>
                      <h5 className="text-base font-semibold mb-2">Thảm Nỉ (5x3.66m)</h5>
                      <div className="flex flex-wrap gap-x-4 gap-y-3 mb-1">
                        {carpetColors.map((color) => (
                          <div
                            key={color.name}
                            className={styles.colorSwatch}
                            style={{ backgroundColor: color.hex }}
                            title={color.name}
                          />
                        ))}
                      </div>
                      <p className="text-xs text-[var(--foreground)]/70">
                        (Phụ phí setup thảm 100k)
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            </Scene>

            <Scene id="thiet-bi-thue-them" onVisible={setActiveId}>
              <h2 className={styles.contentTitle}>Thiết Bị Thuê (Tính Phí)</h2>
              <p className="text-[var(--foreground)]/70 mb-6">
                Các thiết bị chuyên dụng cho nhu cầu cao hơn, vui lòng liên hệ trước để kiểm tra.
              </p>
              
              {/* Bảng giá trên desktop, layout thẻ trên mobile */}
              <div className="overflow-x-auto border border-[var(--foreground)]/30 rounded-lg">
                <table className="w-full min-w-full text-sm text-left">
                  <thead className="border-b border-[var(--foreground)]/30 bg-[var(--foreground)]/5">
                    <tr>
                      <th className="py-3 px-4 font-semibold">Thiết Bị</th>
                      <th className="py-3 px-4 font-semibold">Giá Thuê</th>
                      <th className="py-3 px-4 font-semibold">Ghi Chú</th>
                    </tr>
                  </thead>
                  <tbody>
                    {rentalItems.map((item) => (
                      <tr key={item.name} className="border-b border-[var(--foreground)]/10">
                        <td className="py-3 px-4 font-medium">{item.name}</td>
                        <td className="py-3 px-4">{item.price}</td>
                        <td className="py-3 px-4 text-[var(--foreground)]/70">
                          {item.note}
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </Scene>
            <Scene id="quy-dinh" onVisible={setActiveId}>
              <h2 className={styles.contentTitle}>Tiện ích & Quy Định Chung</h2>
              
              {/* THAY ĐỔI: Chuyển sang grid-cols-5 để chia 40% (col-span-2) / 60% (col-span-3) */}
              <div className="grid grid-cols-1 md:grid-cols-5 gap-8 p-6 bg-[var(--foreground)]/5 border border-[var(--foreground)]/10 rounded-lg">
                
                {/* Cột 1: Tiện Ích (40%) */}
                <div className="md:col-span-2"> {/* Sửa từ md:col-5 */}
                  <h4 className="text-lg font-semibold mb-4">Tiện ích Studio</h4>
                  <ul className="space-y-2 list-disc list-inside text-sm">
                    <li>Miễn phí hỗ trợ setup ánh sáng ban đầu.</li>
                    <li>Mini Canteen phục vụ (có tính phí).</li>
                    <li>Khu vực makeup riêng biệt, miễn phí.</li>
                    <li>Hỗ trợ bàn ủi hơi nước.</li>
                  </ul>
                </div>
                
                {/* Cột 2: Lưu Ý (60%) */}
                <div className="md:col-span-3"> {/* Sửa từ md:col-7 */}
                  <h4 className="text-lg font-semibold mb-4">Lưu Ý Chung</h4>
                  <ul className="space-y-2 list-disc list-inside text-sm">
                    <li>Hỗ trợ tối đa 7 người/ekip, phụ thu 50k/người nếu phát sinh.</li>
                    <li>Hỗ trợ thời gian makeup/chuẩn bị 01 tiếng trước giờ đặt.</li>
                    <li>Makeup/quay phim sử dụng khu vực makeup chung, không hỗ trợ đèn riêng (nếu quá 4 người).</li>
                    <li>Quý khách vui lòng xác nhận lịch và setup. Phí thuê tính từ giờ đã nhận phòng.</li>
                  </ul>
                </div>
              </div>
            </Scene>
          </main>
        </div>
      </Container>
      <BtsSection />
    </main>
  );
}
</file>

<file path="src/app/layout.tsx">
import type { Metadata } from "next";
import "./globals.css";
import ScrollToTopButton from '@/components/ScrollToTopButton';
import LayoutWrapper from '@/components/LayoutWrapper';
import { Providers } from './providers';
import { Toaster } from 'sonner';

export const metadata: Metadata = {
  metadataBase: new URL(process.env.NEXT_PUBLIC_SITE_URL || 'http://localhost:3000'),
  title: "Oni Studio",
  description: "Showcase of professional photography projects.",
  openGraph: {
    title: 'Oni Studio',
    description: 'Mô tả mặc định...',
    images: ['/default-og-image.jpg'], // Một ảnh đại diện mặc định
  },
};


export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
   <html lang="vi" suppressHydrationWarning>
     <body className="bg-[var(--background)] 
                      text-[var(--foreground)]
                       antialiased flex flex-col min-h-screen
                       transition-colors duration-300">
        <Providers>
          <LayoutWrapper>{children}
            <Toaster position="bottom-right" richColors />
          </LayoutWrapper>
          <ScrollToTopButton />
        </Providers>
      </body>
    </html>
  );
}
</file>

<file path="src/components/PortfolioSection.tsx">
// src/components/PortfolioSection.tsx
'use client';

import { useState, useEffect } from 'react';
import { motion, AnimatePresence } from 'motion/react';
// 1. Thêm StaticImageData vào import
import Image, { StaticImageData } from 'next/image'; 
import Link from 'next/link';
import { ArrowUpRight, Loader2 } from 'lucide-react';
import { getProjects } from '@/lib/actions'; 
import { ProjectData } from '@/data/projects-master-data'; 
import Container from './Container';

const CATEGORIES = [
  { id: 'all', label: 'Tất cả' },
  { id: 'thoi-trang', label: 'Thời trang' },
  { id: 'thuong-mai', label: 'Thương mại' },
  { id: 'ca-nhan', label: 'Cá nhân' },
];

export default function PortfolioSection() {
  const [activeCategory, setActiveCategory] = useState('all');
  const [projects, setProjects] = useState<ProjectData[]>([]);
  const [isLoading, setIsLoading] = useState(true);

  useEffect(() => {
    const fetchData = async () => {
      setIsLoading(true);
      try {
        const allData = await getProjects();
        // Chỉ lấy dự án Featured
        const featuredOnly = allData.filter(p => p.isFeatured === true);
        setProjects(featuredOnly);
      } catch (error) {
        console.error("Lỗi tải dự án:", error);
      } finally {
        setIsLoading(false);
      }
    };

    fetchData();
  }, []);

  const filteredProjects = projects.filter((project) => {
    if (activeCategory === 'all') return true;
    return project.category === activeCategory;
  });

  // 2. Sửa Helper Function: Dùng Union Type chuẩn xác
  const getImageSrc = (img: string | StaticImageData) => {
    return typeof img === 'string' ? img : img.src;
  };

  return (
    <Container className="py-20 px-4 md:px-8 bg-[var(--background)]">
      <div className="max-w-8xl mx-auto">
        
        {/* Header & Filter */}
        <div className="flex flex-col md:flex-row justify-between items-end mb-12 gap-6">
          <div>
            <h2 className="text-4xl md:text-6xl font-bold text-[var(--foreground)] tracking-tighter mb-4">
              Dự án Nổi bật
            </h2>
            <p className="text-[var(--sub-text)] max-w-md">
              Tuyển tập các dự án tiêu biểu, nơi ánh sáng và cảm xúc giao thoa.
            </p>
          </div>

          {/* Filter Buttons */}
          <div className="flex flex-wrap gap-2">
            {CATEGORIES.map((cat) => (
              <button
                key={cat.id}
                onClick={() => setActiveCategory(cat.id)}
                className={`px-4 py-2 rounded-full text-sm transition-all duration-300 border cursor-pointer ${
                  activeCategory === cat.id
                    ? 'bg-[var(--foreground)] text-[var(--background)] border-[var(--foreground)]'
                    : 'bg-transparent text-[var(--sub-text)] border-[var(--sub-text)] hover:border-[var(--foreground)] hover:text-[var(--foreground)]'
                }`}
              >
                {cat.label}
              </button>
            ))}
          </div>
        </div>

        {/* Loading State */}
        {isLoading && (
          <div className="flex justify-center items-center h-64">
            <Loader2 className="animate-spin text-[var(--sub-text)]" size={32} />
          </div>
        )}

        {/* Empty State */}
        {!isLoading && filteredProjects.length === 0 && (
          <div className="text-center py-20 text-[var(--sub-text)] border border-dashed border-[var(--sub-text)]/30 rounded-xl">
            <p>Chưa có dự án nổi bật nào trong danh mục này.</p>
            <Link href="/admin/projects" className="text-sm text-blue-500 hover:underline mt-2 inline-block">
              Vào Admin để thêm dự án hoặc điều chỉnh dự án <strong>Nổi bật</strong>
            </Link>
          </div>
        )}

        {/* Grid Display */}
        <motion.div 
          layout
          className="grid grid-cols-1 md:grid-cols-3 gap-4 auto-rows-[300px] md:auto-rows-[400px]"
        >
          <AnimatePresence>
            {filteredProjects.map((project) => (
              <motion.div
                layout
                initial={{ opacity: 0, scale: 0.9 }}
                animate={{ opacity: 1, scale: 1 }}
                exit={{ opacity: 0, scale: 0.9 }}
                transition={{ duration: 0.4 }}
                key={project.id}
                className="relative group overflow-hidden bg-gray-100 dark:bg-neutral-900 cursor-pointer"
                style={{
                  gridColumn: `span ${project.colSpan}`,
                  gridRow: `span ${project.rowSpan}`
                }}
              >
                <Link href={`/du-an/${project.slug}`} className="block h-full w-full">
                  {/* Image */}
                  <Image
                    src={getImageSrc(project.image)}
                    alt={project.title}
                    fill
                    className="object-cover transition-transform duration-700 group-hover:scale-105"
                    sizes="(max-width: 768px) 100vw, (max-width: 1200px) 50vw, 33vw"
                  />

                  {/* Overlay Info */}
                  <div className="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex flex-col justify-end p-6">
                    <div className="transform translate-y-4 group-hover:translate-y-0 transition-transform duration-300">
                      <span className="text-xs font-medium text-white/80 uppercase tracking-wider mb-2 block">
                        {project.categoryName} — {project.year}
                      </span>
                      <div className="flex justify-between items-center">
                        <h3 className="text-2xl font-bold text-white">
                          {project.title}
                        </h3>
                        <div className="bg-white/20 p-2 rounded-full backdrop-blur-sm">
                          <ArrowUpRight className="text-white w-5 h-5" />
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  {/* Badge Nổi Bật */}
                  <div className="absolute top-4 right-4 bg-[var(--foreground)] text-[var(--background)] text-[10px] font-bold uppercase px-2 py-1 rounded shadow-sm z-10">
                    Nổi bật
                  </div>
                </Link>
              </motion.div>
            ))}
          </AnimatePresence>
        </motion.div>

      </div>
    </Container>
  );
}
</file>

<file path="src/lib/actions.ts">
// src/lib/actions.ts
'use server';
import { createClient } from '@supabase/supabase-js';
import { supabase } from '../../lib/supabase';
import { PROJECTS_MASTER_DATA, ProjectData, ArticleBlock } from '@/data/projects-master-data';
import { revalidatePath } from 'next/cache';
import { cookies } from 'next/headers';
import { createServerClient } from '@supabase/ssr';


// 1. Định nghĩa Interface CHÍNH XÁC khớp với Database
interface ProjectRow {
  project_id: number;
  title: string;
  client_name: string | null;
  description: string | null;
  thumbnail_url: string | null;
  created_at: string;
  slug: string;
  col_span: number | null;
  row_span: number | null;
  is_featured: boolean;
  
  // QUAN TRỌNG: Cột chứa nội dung bài viết
  content: ArticleBlock[] | null; 
  credits: { label: string; value: string }[] | null;

  // Join bảng categories
  portfolio_categories: {
    name: string;
    slug: string;
  } | null;
  
  // Join bảng ảnh cũ (Fallback)
  project_images: {
    image_url: string;
    display_order: number;
  }[];
}
async function requireAdmin(token: string) {
  const supabase = createClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    { global: { headers: { Authorization: `Bearer ${token}` } } }
  );

  const { data: { user } } = await supabase.auth.getUser();
  if (!user) throw new Error("Unauthorized");

  const { data: profile } = await supabase
    .from('users')
    .select('role')
    .eq('auth_id', user.id)
    .single();

  if (profile?.role !== 'Admin') {
    throw new Error("Forbidden: Chỉ Admin mới có quyền này.");
  }
}
// 2. Hàm lấy danh sách dự án, có thể lọc theo categorySlug
export async function getProjects(categorySlug?: string): Promise<ProjectData[]> {
  try {
    // --- CHECK DEMO MODE ---
    const { data: setting } = await supabase
      .from('settings')
      .select('value')
      .eq('key', 'is_demo_mode')
      .single();

    const isDemo = setting?.value === 'true';

    if (isDemo) {
      let data = PROJECTS_MASTER_DATA;
      if (categorySlug && categorySlug !== 'all') {
        data = data.filter(p => p.category === categorySlug);
      }
      return data;
    }

    // --- FETCH DATA TỪ SUPABASE ---
    let query = supabase
      .from('projects')
      .select(`
        *,
        portfolio_categories!inner ( name, slug ),
        project_images ( image_url, display_order )
      `)
      .order('display_order', { ascending: true }) 
      .order('created_at', { ascending: false });

    if (categorySlug && categorySlug !== 'all') {
      query = query.eq('portfolio_categories.slug', categorySlug);
    }

    const { data, error } = await query;

    if (error) {
      console.error('Lỗi Supabase:', error);
      return [];
    }

    const projectsRaw = data as unknown as ProjectRow[];

    // 3. Map dữ liệu
    return projectsRaw.map((p) => {
      
      // A. Xử lý nội dung bài viết (Article Body)
      let articleBody: ArticleBlock[] = [];

      // Ưu tiên 1: Lấy từ cột 'content' (Dự án mới tạo bằng Admin Builder)
      if (p.content && Array.isArray(p.content) && p.content.length > 0) {
        articleBody = p.content;
      } 
      // Ưu tiên 2: Fallback cho dự án cũ (Tự tạo từ bảng project_images)
      else {
        const galleryImages = p.project_images
          ?.sort((a, b) => a.display_order - b.display_order)
          .map(img => img.image_url) || [];

        if (galleryImages.length > 0) {
          // Gom ảnh thành các row (mỗi row 2-3 ảnh tùy logic, ở đây để đơn giản là 1 row chứa hết)
          articleBody.push({
            type: 'imageRow',
            images: galleryImages
          });
        } else if (p.description) {
           // Nếu không có ảnh, ít nhất hiện mô tả
           articleBody.push({
             type: 'paragraph',
             content: p.description
           });
        }
      }

      // B. Trả về ProjectData chuẩn
      return {
        id: p.project_id,
        title: p.title,
        client_name: p.client_name || '',
        description: p.description || '',
        category: p.portfolio_categories?.slug || 'uncategorized',
        categoryName: p.portfolio_categories?.name || 'Chưa phân loại',
        image: p.thumbnail_url || '', 
        year: new Date(p.created_at).getFullYear().toString(),
        slug: p.slug,
        colSpan: p.col_span || 1,
        rowSpan: p.row_span || 1,
        isFeatured: p.is_featured || false,
        
        credits: p.credits || [],
        articleBody: articleBody, 
      };
    });

  } catch (error) {
    console.error("Get projects error:", error);
    return [];
  }
}

// Định nghĩa kiểu cho cập nhật layout lưới dự án
export interface ProjectGridUpdate {
  id: number;
  colSpan: number;
  rowSpan: number;
  displayOrder: number;
}

// Cập nhật layout lưới dự án
export async function updatePortfolioLayout(token: string, updates: ProjectGridUpdate[]) {
  try {
    // 1. Tạo Supabase Client với Token của người dùng đang đăng nhập
    // Điều này giúp vượt qua RLS (Row Level Security) một cách hợp lệ
    const supabase = createClient(
      process.env.NEXT_PUBLIC_SUPABASE_URL!,
      process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
      {
        global: {
          headers: {
            Authorization: `Bearer ${token}`,
          },
        },
      }
    );

    console.log(`--> Đang cập nhật layout cho ${updates.length} dự án...`);

    // 2. Thực hiện Update từng dự án (Dùng Promise.all cho nhanh)
    const promises = updates.map(async (project) => {
      const { error } = await supabase
        .from('projects')
        .update({
          col_span: project.colSpan,
          row_span: project.rowSpan,
          display_order: project.displayOrder,
        })
        .eq('project_id', project.id);

      if (error) throw error;
    });

    await Promise.all(promises);

    // 3. Xóa Cache để Frontend cập nhật ngay lập tức
    revalidatePath('/'); 
    revalidatePath('/admin/portfolio-grid');

    return { success: true };
 } catch (error: unknown) {
    // Đảm bảo có dòng này hoặc tương tự
    const msg = error instanceof Error ? error.message : 'Lỗi update layout';
    console.error("Layout update error:", error);
    return { success: false, error: msg };
  }
}

// Lấy chi tiết dự án theo ID
export async function getProjectById(id: number) {
  try {
    const { data, error } = await supabase
      .from('projects')
      .select('*')
      .eq('project_id', id)
      .single();
      
    if (error) throw error;
    return data;
  } catch (error) {
    console.error("Error fetching project:", error);
    return null;
  }
}

// Xóa dự án theo ID
export async function deleteProject(token: string, projectId: number) {
  try {
    const supabase = createClient(
      process.env.NEXT_PUBLIC_SUPABASE_URL!,
      process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
      {
        global: {
          headers: {
            Authorization: `Bearer ${token}`,
          },
        },
      }
    );

    const { error } = await supabase
      .from('projects')
      .delete()
      .eq('project_id', projectId);

    if (error) throw error;

    // Xóa cache để danh sách cập nhật ngay
    revalidatePath('/');
    revalidatePath('/admin/projects');
    revalidatePath('/admin/portfolio-grid');

    return { success: true };
  } catch (error: unknown) {
    console.error("Delete error:", error); 
    return { success: false, error: 'Không thể xóa dự án này.' };
  }
}


export interface StaffUser {
  user_id: number;
  email: string;
  full_name: string;
  role: 'Admin' | 'Staff';
  is_active: boolean;
  created_at: string;
  auth_id: string;
}

// 1. Lấy danh sách nhân viên
export async function getStaffList() {
  try {
    // Dùng client thường (anon) cũng được nếu đã set Policy Public Read
    // Hoặc dùng Service Role để chắc chắn lấy được hết
    const { data, error } = await supabase
      .from('users')
      .select('*')
      .order('created_at', { ascending: false });

    if (error) throw error;
    return data as StaffUser[];
  } catch (error) {
    console.error("Error fetching staff:", error);
    return [];
  }
}

// 2. Đổi trạng thái (Khóa/Mở khóa)
export async function toggleStaffStatus(token: string, userId: number, currentStatus: boolean) {
  try {
    await requireAdmin(token);
    // Cần token của Admin đang đăng nhập để xác thực quyền
    const supabaseClient = createClient(
      process.env.NEXT_PUBLIC_SUPABASE_URL!,
      process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
      { global: { headers: { Authorization: `Bearer ${token}` } } }
    );
    // 1. Lấy thông tin người đang đăng nhập
    const { data: { user: currentUser } } = await supabaseClient.auth.getUser();
    
    // 2. Lấy thông tin người bị khóa (Target)
    const { data: targetUser } = await supabaseClient
      .from('users')
      .select('auth_id')
      .eq('user_id', userId)
      .single();

    // 3. So sánh: Nếu trùng nhau -> Chặn ngay
    if (currentUser && targetUser && currentUser.id === targetUser.auth_id) {
      throw new Error("Bạn không thể tự khóa tài khoản của chính mình.");
    }
    const { error } = await supabaseClient
      .from('users')
      .update({ is_active: !currentStatus })
      .eq('user_id', userId);

    if (error) throw error;
    
    revalidatePath('/admin/staff');
    return { success: true };
  } catch (error: unknown) {
    console.error("Toggle staff error:", error);
    return { success: false, error: 'Không thể thay đổi trạng thái tài khoản này. Chỉ Admin mới có quyền này.' };
  }
}

// 3. Tạo nhân viên mới (Dùng quyền tối cao Service Role)
export async function createStaffAccount(data: { email: string; password: string; fullName: string; role: string }) {
  try {
    // A. Kiểm tra Key
    const serviceKey = process.env.SUPABASE_SERVICE_ROLE_KEY;
    if (!serviceKey) {
      return { success: false, error: "Server chưa cấu hình Service Role Key (Kiểm tra .env.local)" };
    }

    // B. Tạo Client Admin (Bypass mọi RLS)
    const supabaseAdmin = createClient(
      process.env.NEXT_PUBLIC_SUPABASE_URL!,
      serviceKey,
      {
        auth: {
          autoRefreshToken: false,
          persistSession: false
        }
      }
    );

    // C. Tạo User bên hệ thống Auth (Tự động Confirm email)
    const { data: authData, error: authError } = await supabaseAdmin.auth.admin.createUser({
      email: data.email,
      password: data.password,
      email_confirm: true, // Quan trọng: User đăng nhập được ngay không cần check mail
      user_metadata: { full_name: data.fullName }
    });

    if (authError) throw authError;
    if (!authData.user) throw new Error("Không tạo được Auth User");

    // D. Lưu thông tin vào bảng public.users
    const { error: dbError } = await supabaseAdmin
      .from('users')
      .insert({
        email: data.email,
        username: data.email, // Tạm dùng email làm username (unique)
        full_name: data.fullName,
        role: data.role,
        auth_id: authData.user.id, // Link với Auth ID vừa tạo
        is_active: true
      });

    if (dbError) {
      // Nếu lưu DB thất bại -> Xóa luôn user bên Auth để tránh rác data
      console.error("Lỗi lưu DB, đang rollback xóa Auth User...");
      await supabaseAdmin.auth.admin.deleteUser(authData.user.id);
      throw dbError;
    }

    // Refresh lại trang danh sách
    revalidatePath('/admin/staff');
    return { success: true };

  } catch (error: unknown) {
    
    // Xử lý type safe
    let message = 'Lỗi không xác định';
    
    if (error instanceof Error) {
      message = error.message; // Lấy message từ Error object
    } else if (typeof error === 'string') {
      message = error; // Nếu throw "chuỗi"
    }

    // Trả về string cho Client hiển thị
    return { success: false, error: message };
  }
}

// Định nghĩa kiểu dữ liệu UserProfile
export interface UserProfile {
  user_id: number;
  email: string;
  full_name: string;
  role: 'Admin' | 'Staff';
}

// Hàm lấy thông tin người dùng hiện tại (Server-side)
export async function getCurrentUserProfile(): Promise<UserProfile | null> {
  const cookieStore = await cookies();
  
  const supabase = createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        getAll() { return cookieStore.getAll() },
        setAll() {} 
      },
    }
  );

  try {
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) return null;

    const { data: profile } = await supabase
      .from('users')
      .select('user_id, email, full_name, role')
      .eq('auth_id', user.id)
      .single();

    return profile as UserProfile;
  } catch (error) {
    console.error("Lỗi thông tin người dùng hiện tại:", error);
    return null;
  }
}

// --- DASHBOARD STATS ---
// Hàm lấy thống kê Dashboard
// Trả về tổng số dự án, dự án mới trong tháng này, và tổng số nhân sự
// Dùng để hiển thị trên trang Admin Dashboard
export async function getDashboardStats(range: string = '30d') {
  try {
    const startDate = getStartDate(range).toISOString();

    // 1. Tổng dự án (Toàn thời gian - Không đổi theo filter)
    const { count: totalProjects } = await supabase
      .from('projects')
      .select('*', { count: 'exact', head: true });

    // 2. Dự án MỚI (Thay đổi theo filter)
    const { count: newProjects } = await supabase
      .from('projects')
      .select('*', { count: 'exact', head: true })
      .gte('created_at', startDate);

    // 3. Tổng nhân sự
    const { count: totalStaff } = await supabase
      .from('users')
      .select('*', { count: 'exact', head: true });

    return {
      totalProjects: totalProjects || 0,
      newProjects: newProjects || 0, // Số lượng tăng thêm trong khoảng thời gian này
      totalStaff: totalStaff || 0
    };
  } catch (error) {
    console.error("Lỗi lấy thống kê Dashboard:", error);
    return { totalProjects: 0, newProjects: 0, totalStaff: 0 };
  }
}

export interface MonthlyStat {
  name: string; // VD: "Tháng 10"
  total: number;
}

export async function getMonthlyProjectStats() {
  try {
    // 1. Lấy tất cả dự án (Chỉ cần cột created_at)
    // Lưu ý: Nếu data quá lớn (>10k), nên dùng SQL function (RPC). 
    // Với Portfolio < 1000 bài, xử lý JS vẫn siêu nhanh.
    const { data, error } = await supabase
      .from('projects')
      .select('created_at')
      .order('created_at', { ascending: true });

    if (error) throw error;

    // 2. Xử lý dữ liệu: Nhóm theo tháng
    // Tạo mảng 6 tháng gần nhất mặc định là 0
    const statsMap = new Map<string, number>();
    const today = new Date();
    
    for (let i = 5; i >= 0; i--) {
      const d = new Date(today.getFullYear(), today.getMonth() - i, 1);
      // Format tên tháng tiếng Việt (VD: T1, T2...)
      const monthName = `T${d.getMonth() + 1}`;
      statsMap.set(monthName, 0);
    }

    // Đếm số lượng
    data?.forEach((p) => {
      const date = new Date(p.created_at);
      const monthName = `T${date.getMonth() + 1}`;
      // Chỉ đếm nếu tháng đó nằm trong danh sách 6 tháng gần nhất
      if (statsMap.has(monthName)) {
        statsMap.set(monthName, (statsMap.get(monthName) || 0) + 1);
      }
    });

    // Chuyển Map thành Array cho Recharts
    const result: MonthlyStat[] = Array.from(statsMap, ([name, total]) => ({ name, total }));
    
    return result;

  } catch (error) {
    console.error("Lỗi lấy thống kê tháng:", error);
    return [];
  }
}

// Hàm tính ngày bắt đầu dựa trên range (VD: '7d', '30d')
function getStartDate(range: string) {
  const now = new Date();
  if (range === '7d') return new Date(now.setDate(now.getDate() - 7));
  if (range === '30d') return new Date(now.setDate(now.getDate() - 30));
  if (range === '90d') return new Date(now.setDate(now.getDate() - 90));
  if (range === '12m') return new Date(now.setFullYear(now.getFullYear() - 1));
  return new Date(0); // 'all' -> Từ năm 1970
}
// Logic Biểu đồ linh hoạt (Ngày/Tháng)
export async function getGrowthChartData(range: string = '30d') {
  try {
    const startDate = getStartDate(range);
    
    // Lấy dữ liệu trong khoảng thời gian
    const { data } = await supabase
      .from('projects')
      .select('created_at')
      .gte('created_at', startDate.toISOString())
      .order('created_at', { ascending: true });

    if (!data) return [];

    // Xử lý nhóm dữ liệu
    // Nếu range ngắn (7d, 30d) -> Nhóm theo NGÀY
    // Nếu range dài (90d, 12m) -> Nhóm theo THÁNG
    const isDaily = range === '7d' || range === '30d';
    const statsMap = new Map<string, number>();

    // Khởi tạo trục X cho đẹp (tránh bị đứt đoạn)
    // (Logic này hơi dài dòng để viết ở đây, nên ta làm đơn giản: Nhóm theo data thực có)
    
    data.forEach((p) => {
      const date = new Date(p.created_at);
      let key = '';
      
      if (isDaily) {
        // Format: "DD/MM" (VD: 05/10)
        key = `${date.getDate()}/${date.getMonth() + 1}`;
      } else {
        // Format: "Tháng MM" (VD: T10)
        key = `T${date.getMonth() + 1}`;
      }

      statsMap.set(key, (statsMap.get(key) || 0) + 1);
    });

    return Array.from(statsMap, ([name, total]) => ({ name, total }));

  } catch (error) {
    console.error("Lỗi lấy dữ liệu biểu đồ tăng trưởng:", error);
    return [];
  }
}
</file>

<file path="src/app/admin/layout.tsx">
// src/app/admin/layout.tsx
'use client';

import React, { useState, useEffect, useRef, useCallback } from 'react';
import Link from 'next/link';
import { usePathname, useRouter } from 'next/navigation';
import { createBrowserClient } from '@supabase/ssr';
import { toast } from 'sonner';
import { 
  LayoutDashboard, 
  Image as ImageIcon, 
  Settings, 
  LogOut, 
  Users,
  Menu,
  X,
  Home,
  Clock,
  LayoutTemplate 
} from 'lucide-react';
import ThemeToggle from '@/components/ThemeToggle';
import localFont from 'next/font/local'; 
import ConfirmModal from '@/components/ui/ConfirmModal';
import { getCurrentUserProfile } from '@/lib/actions';
import { getRooms, type RoomWithBranch } from '@/lib/actions/studio'; 
import NavCalendarWidget from '@/components/admin/calendar/NavCalendarWidget';
import { CalendarProvider } from '@/context/CalendarContext';

const logoFont = localFont({
  src: '../../fonts/cameliya-regular.ttf',
  display: 'swap',
  variable: '--font-logo',
});

interface NavLinkProps {
  href: string;
  icon: React.ReactNode;
  label: string;
  isActive?: boolean;
  onClick?: () => void;
}
// Type cho thông tin user hiển thị
interface UserProfile {
  full_name: string;
  role: string;
  email: string;
}
// Giá trị mặc định nếu chưa cấu hình trong DB
const DEFAULT_TIMEOUT = 60; 

export default function AdminLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  const router = useRouter();
  const pathname = usePathname();
  const [showModal, setShowModal] = useState(false); 
  // Supabase Client
  const [supabase] = useState(() => createBrowserClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
  ));
  // State quản lý menu mobile
  const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);
  const [isCheckingAuth, setIsCheckingAuth] = useState(true);
  const [timeLeft, setTimeLeft] = useState<string>('--:--:--');

  // State lưu thời gian timeout thực tế (Lấy từ DB)
  const [idleTimeoutMinutes, setIdleTimeoutMinutes] = useState(DEFAULT_TIMEOUT);

  // Ref lưu thời điểm hoạt động cuối cùng
  const lastActivityRef = useRef<number>(Date.now());
  
  // Ref lưu giá trị timeout để dùng trong setInterval mà không cần restart interval
  const timeoutRef = useRef(idleTimeoutMinutes);

  // --- THÊM LOGIC LẤY DANH SÁCH PHÒNG ---
  const [rooms, setRooms] = useState<RoomWithBranch[]>([]);

  useEffect(() => {
    // Fetch phòng để hiển thị trong Sidebar Calendar Widget
    const fetchRooms = async () => {
      try {
        const data = await getRooms();
        setRooms(data);
      } catch (error) {
        console.error("Lỗi lấy danh sách phòng:", error);
      }
    };
    fetchRooms();
  }, []); // Chỉ chạy 1 lần khi mount

  // State lưu thông tin user
  const [userProfile, setUserProfile] = useState<UserProfile | null>(null);
  // --- 1. ĐỒNG BỘ REF VỚI STATE ---
  useEffect(() => {
    timeoutRef.current = idleTimeoutMinutes;
  }, [idleTimeoutMinutes]);

// --- 2. LẤY CẤU HÌNH TỪ DATABASE (CÓ LẮNG NGHE SỰ KIỆN) ---
  useEffect(() => {
    // Hàm lấy dữ liệu (Tách ra để tái sử dụng)
    const fetchSettings = async () => {
      try {
        const { data } = await supabase
          .from('settings')
          .select('value')
          .eq('key', 'idle_timeout_minutes')
          .single();
        
        if (data?.value) {
          const dbValue = parseInt(data.value);
          if (!isNaN(dbValue) && dbValue > 0) {
            setIdleTimeoutMinutes(dbValue);
            // Cập nhật luôn vào ref để timer nhận ngay lập tức mà không đợi vòng lặp sau
            timeoutRef.current = dbValue; 
          }
        }
      } catch (error) {
        console.error("Lỗi fetch setting:", error);
      }
    };

    // Gọi lần đầu khi load trang
    fetchSettings();

    // Lắng nghe sự kiện 'settings:updated' từ trang SettingsForm
    const handleSettingsUpdate = () => {
      console.log("Phát hiện thay đổi cài đặt -> Cập nhật lại Layout...");
      fetchSettings();
    };

    window.addEventListener('settings:updated', handleSettingsUpdate);

    // Dọn dẹp khi component unmount
    return () => {
      window.removeEventListener('settings:updated', handleSettingsUpdate);
    };
  }, [supabase]);
  // --- 3. HÀM GHI NHẬN HOẠT ĐỘNG ---
  const resetTimer = useCallback(() => {
    lastActivityRef.current = Date.now();
  }, []);

  // --- 4. LOGIC CHÍNH (CHECK AUTH & TIMER) ---
  useEffect(() => {
    let intervalId: NodeJS.Timeout;

    const setupActivityListeners = () => {
      window.addEventListener('mousemove', resetTimer);
      window.addEventListener('keydown', resetTimer);
      window.addEventListener('click', resetTimer);
      window.addEventListener('scroll', resetTimer);
      window.addEventListener('touchstart', resetTimer);
    };

    const cleanupActivityListeners = () => {
      window.removeEventListener('mousemove', resetTimer);
      window.removeEventListener('keydown', resetTimer);
      window.removeEventListener('click', resetTimer);
      window.removeEventListener('scroll', resetTimer);
      window.removeEventListener('touchstart', resetTimer);
    };

    const checkAuthAndStartTimer = async () => {
      try {
        // 1. Lấy Session Auth
        const { data: { session } } = await supabase.auth.getSession();
        
        if (!session) {
          router.replace('/login');
          return;
        }

        // 2. (MỚI) Lấy thông tin chi tiết từ bảng public.users
        // Dùng auth_id (uid) để đối chiếu
        const profile = await getCurrentUserProfile();

        if (profile) {
          setUserProfile(profile);
        } else {
          // Fallback chỉ khi không tìm thấy profile trong DB
          setUserProfile({
            full_name: session.user.email?.split('@')[0] || 'Admin',
            role: 'Staff', // Mặc định an toàn là Staff nếu lỗi
            email: session.user.email || ''
          });
        }
        // 3. Khởi động Timer
        setupActivityListeners();
        setIsCheckingAuth(false);

        intervalId = setInterval(() => {
          const now = Date.now();
          const timeSinceLastActivity = now - lastActivityRef.current;
          const currentTimeoutMs = timeoutRef.current * 60 * 1000; 
          const timeRemaining = currentTimeoutMs - timeSinceLastActivity;

          if (timeRemaining <= 0) {
            clearInterval(intervalId);
            cleanupActivityListeners();
            supabase.auth.signOut().then(() => {
              toast.warning(`Đã đăng xuất do không hoạt động quá ${timeoutRef.current} phút.`);
              router.replace('/login');
            });
            return;
          }

          const h = Math.floor(timeRemaining / (1000 * 60 * 60));
          const m = Math.floor((timeRemaining % (1000 * 60 * 60)) / (1000 * 60));
          const s = Math.floor((timeRemaining % (1000 * 60)) / 1000);
          
          setTimeLeft(`${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`);
          
        }, 1000);

      } catch (error) {
        console.error("Auth error:", error);
        router.replace('/login');
      }
    };

    checkAuthAndStartTimer();

    return () => {
      if (intervalId) clearInterval(intervalId);
      cleanupActivityListeners();
    };
  }, [router, supabase, resetTimer]);

  const handleLogout = async () => {
    try {
      await supabase.auth.signOut();
      toast.success("Đăng xuất thành công!!");
      router.replace('/login');
      router.refresh();
    } catch (error) {
      const msg = (error as Error)?.message || "Lỗi không xác định";
      toast.error(msg);
    }
  };

  const handleLinkClick = () => setIsMobileMenuOpen(false);
  // Helper lấy chữ cái đầu
  const getInitials = (name?: string) => {
    return name ? name.charAt(0).toUpperCase() : 'A';
  };
  if (isCheckingAuth) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-[var(--admin-bg)]">
        <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-[var(--admin-primary)]"></div>
      </div>
    );
  }

  return (
    <CalendarProvider>
      <div className="flex min-h-screen bg-[var(--admin-bg)] text-[var(--admin-fg)] transition-colors duration-300 font-sans">
        {isMobileMenuOpen && (
          <div className="fixed inset-0 bg-black/60 z-40 md:hidden backdrop-blur-sm" onClick={() => setIsMobileMenuOpen(false)} />
        )}

        <aside className={`fixed top-0 left-0 z-50 h-full w-64 bg-[var(--admin-card)] border-r border-[var(--admin-border)] transform transition-transform duration-300 ease-in-out shadow-xl md:shadow-none ${isMobileMenuOpen ? 'translate-x-0' : '-translate-x-full'} md:translate-x-0 md:static md:flex md:flex-col`}>
          <div className="h-16 flex items-center justify-between px-6 border-b border-[var(--admin-border)]">
            <div className="flex items-center gap-2">
              <div className={`w-8 h-8 bg-[var(--admin-primary)] rounded-lg flex items-center justify-center text-[var(--admin-primary-fg)] font-bold ${logoFont.className}`}>O</div>
              <span className={`${logoFont.variable} text-xl font-bold tracking-widest text-[var(--admin-fg)] ${logoFont.className}`}>Oni Admin</span>
            </div>
            <button onClick={() => setIsMobileMenuOpen(false)} className="md:hidden text-[var(--admin-sub)]"><X size={24} /></button>
          </div>

          <nav className="flex-1 p-4 space-y-1 overflow-y-auto no-scrollbar">
            <div className="text-xs font-bold text-[var(--admin-sub)] uppercase tracking-wider mb-3 px-4 mt-2">Studio</div>
            <NavLink href="/admin" title="Đi tới trang Tổng quan" icon={<LayoutDashboard size={20} />} label="Tổng quan" isActive={pathname === '/admin'} onClick={handleLinkClick} />
            <NavCalendarWidget rooms={rooms} />
            <NavLink href="/admin/projects" title="Quản lý dự án" icon={<ImageIcon size={20} />} label="Dự án" isActive={pathname === '/admin/projects' || pathname === '/admin/projects/new' || pathname.startsWith('/admin/projects/')} onClick={handleLinkClick} />
            <NavLink href="/admin/grid" title="Bố cục Portfolio" icon={<LayoutTemplate size={20} />} label="Bố cục Portfolio" isActive={pathname.startsWith('/admin/grid')} onClick={handleLinkClick} />
            {userProfile?.role === 'Admin' && (
              <>
                <NavLink href="/admin/staff" title="Quản lý nhân sự" icon={<Users size={20} />} label="Nhân sự" isActive={pathname.startsWith('/admin/staff')} onClick={handleLinkClick} />
              </>
            )}
          </nav>

          <div className="p-4 border-t border-[var(--admin-border)] space-y-2">
            {userProfile?.role === 'Admin' && (
              <>
                <div className="text-xs font-bold text-[var(--admin-sub)] uppercase tracking-wider mt-8 mb-3 px-4">Hệ thống</div>
                <NavLink href="/admin/settings" title="Cài đặt chung" icon={<Settings size={20} />} label="Cài đặt chung" isActive={pathname.startsWith('/admin/settings')} onClick={handleLinkClick} />
              </>
            )}
            <Link href="/" className="flex items-center gap-3 px-4 py-3 w-full text-sm font-medium text-[var(--admin-sub)] hover:bg-[var(--admin-bg)] hover:text-[var(--admin-fg)] rounded-lg transition-colors"><Home size={20} /> Xem Website</Link>
            <button onClick={() => setShowModal(true)} className="flex cursor-pointer items-center gap-3 px-4 py-3 w-full text-left text-sm font-medium text-red-500 hover:bg-red-500/10 rounded-lg transition-colors"><LogOut size={20} /> Đăng xuất</button>
          </div>
        </aside>

        <div className="flex-1 flex flex-col min-w-0 overflow-hidden">
          <header className="h-16 bg-[var(--admin-card)]/80 backdrop-blur-md border-b border-[var(--admin-border)] flex items-center justify-between px-4 md:px-8 sticky top-0 z-30">
            <div className="flex items-center gap-4">
              <button onClick={() => setIsMobileMenuOpen(true)} className="md:hidden p-2 -ml-2 text-[var(--admin-sub)] rounded-lg"><Menu size={24} /></button>
              <h1 className="font-semibold text-lg text-[var(--admin-fg)] hidden sm:block">{getPageTitle(pathname)}</h1>
            </div>

            <div className="flex items-center gap-3 md:gap-4">
              <div className="hidden sm:flex items-center gap-2 px-3 py-1.5 bg-[var(--admin-bg)] border border-[var(--admin-border)] rounded-full text-xs font-mono font-medium text-[var(--admin-sub)]" title="Tự động đăng xuất nếu không hoạt động">
                <Clock size={14} className="text-[var(--admin-primary)] animate-pulse" />
                <span>{timeLeft}</span>
              </div>
              <div className="h-6 w-px bg-[var(--admin-border)] hidden sm:block"></div>
              <ThemeToggle isAdmin={true}/>
              <div className="flex items-center gap-3 pl-2">
                  <div className="hidden md:block text-sm text-right">
                    <p className="font-medium text-[var(--admin-fg)] leading-tight">
                      {userProfile?.full_name || 'Đang tải...'}
                    </p>
                    <p className="text-[10px] text-[var(--admin-sub)] uppercase tracking-wider">
                      {userProfile?.role || '...'}
                    </p>
                  </div>
                  <div className="h-9 w-9 rounded-full bg-gradient-to-br from-[var(--admin-primary)] to-purple-600 border-2 border-[var(--admin-card)] shadow-sm flex items-center justify-center text-white font-bold text-xs">
                    {getInitials(userProfile?.full_name)}
                  </div>
                </div>
            </div>
          </header>

          <main className="flex-1 p-4 md:p-8 overflow-auto table-scrollbar">
            <ConfirmModal isOpen={showModal} onClose={() => setShowModal(false)} onConfirm={handleLogout} title="Đăng xuất?" description="Bạn có chắc chắn muốn đăng xuất?" confirmText="Đăng xuất" cancelText="Hủy bỏ" variant="danger" />
            <div className="mx-auto max-w-7xl animate-fade-in-up">{children}</div>
          </main>
        </div>
      </div>
    </CalendarProvider>
  );
}

function NavLink({ href, icon, label, isActive, onClick, title }: NavLinkProps & { title?: string }) {
  return (
    <Link href={href} onClick={onClick} title={title} className={`flex items-center gap-3 px-4 py-2.5 text-sm font-medium rounded-lg transition-all duration-200 mb-1 ${isActive ? 'bg-[var(--admin-bg)] text-[var(--admin-primary)] shadow-md shadow-gray-500/20' : 'text-[var(--admin-sub)] hover:bg-[var(--admin-hover)] hover:text-[var(--admin-fg)]'}`}>{icon}{label}</Link>
  );
}

function getPageTitle(pathname: string) {
  if (pathname === '/admin') return 'Bảng tổng quan';
  if (pathname.startsWith('/admin/grid')) return 'Bố cục Portfolio';
  if (pathname.startsWith('/admin/projects')) return 'Quản lý Dự án';
  if (pathname.startsWith('/admin/staff')) return 'Nhân sự';
  if (pathname.startsWith('/admin/settings')) return 'Cài đặt hệ thống';
  return 'Bảng điều khiển';
}
</file>

<file path="src/app/ca-nhan/page.tsx">
import React from 'react';
import { getProjects } from '@/lib/actions';
import { Metadata } from 'next';
import Container from '@/components/Container';
import ProjectMasonryGrid from '@/components/ProjectMasonryGrid';

// Metadata cho SEO
export const metadata: Metadata = {
  title: 'Dự án Cá nhân | Oni Studio',
  description: 'Những dự án thể hiện cái tôi cá nhân và thử nghiệm sáng tạo.',
};
export const revalidate = 3600; // 1 hour
export default async function PersonalPage() {
  // 1. Gọi dữ liệu thật từ Supabase (hoặc Demo)
  const projects = await getProjects('ca-nhan'); // <-- Slug của danh mục

  return (
    <Container className="min-h-screen bg-[var(--background)] pt-32 pb-20 px-4 md:px-8">
      <div className="max-w-8xl mx-auto">
        
        {/* Header */}
        <div className="mb-16">
          <h1 className="text-4xl md:text-6xl font-bold text-[var(--foreground)] tracking-tighter mb-4">
            Cá nhân
          </h1>
          <p className="text-[var(--sub-text)] text-lg max-w-xl">
            Những thử nghiệm, cảm hứng và góc nhìn riêng.
          </p>
        </div>

        {/* Empty State */}
        {projects.length === 0 && (
          <div className="py-20 text-center text-[var(--sub-text)] border-y border-[var(--foreground)]/10">
            Chưa có dự án nào trong danh mục này.
          </div>
        )}

        {/* Project Grid */}
        <ProjectMasonryGrid projects={projects} variant="cascade" />
      </div>
    </Container>
  );
}
</file>

<file path="src/components/ProjectShowcase.tsx">
// src/components/ProjectShowcase.tsx
'use client';

import React, { useEffect, useState } from 'react';
import Image from 'next/image';
import Link from 'next/link';
import { motion } from 'framer-motion';
import { ArrowRight } from 'lucide-react';
import { getProjects } from '@/lib/actions';
import { ProjectData } from '@/data/projects-master-data';

// --- Component Con: ProjectItem ---
function ProjectItem({ project, index }: { project: ProjectData; index: number }) {
  const isImageRight = index % 2 !== 0;

  return (
    <motion.div 
      initial={{ opacity: 0, y: 50 }}
      whileInView={{ opacity: 1, y: 0 }}
      transition={{ duration: 0.8, ease: "easeOut" }}
      viewport={{ once: true, margin: "-100px" }}
      className={`flex flex-col md:flex-row items-center gap-8 md:gap-16 mb-24 md:mb-32 ${
        isImageRight ? 'md:flex-row-reverse' : ''
      }`}
    >
      {/* Image Side */}
      <div className="w-full md:w-3/5 relative group cursor-pointer overflow-hidden rounded-lg shadow-2xl">
        <Link href={`/du-an/${project.slug}`}>
          <div className="relative aspect-[16/9] w-full overflow-hidden">
            <Image
              src={typeof project.image === 'string' ? project.image : project.image.src}
              alt={project.title}
              fill
              className="object-cover transition-transform duration-700 group-hover:scale-105"
              sizes="(max-width: 768px) 100vw, 60vw"
            />
            <div className="absolute inset-0 bg-black/20 group-hover:bg-transparent transition-colors duration-500" />
            
            {/* Badge Danh mục nổi bật */}
            <div className="absolute top-4 left-4 bg-white/90 dark:bg-black/80 backdrop-blur px-3 py-1 text-xs font-bold uppercase tracking-wider text-[var(--foreground)] rounded">
              {project.categoryName}
            </div>
          </div>
        </Link>
      </div>

      {/* Text Side */}
      <div className="w-full md:w-2/5 text-center md:text-left space-y-6">
        <span className="inline-block text-xs font-bold tracking-[0.2em] text-[var(--sub-text)] uppercase border-b border-[var(--glow-color)] pb-1">
          Dự án {project.categoryName} mới
        </span>
        
        <h3 className="text-3xl md:text-5xl font-bold text-[var(--foreground)] leading-tight">
          <Link href={`/du-an/${project.slug}`} className="hover:text-[var(--sub-text)] transition-colors">
            {project.title}
          </Link>
        </h3>

        {project.description && (
          <p className="text-[var(--sub-text)] text-lg font-light leading-relaxed line-clamp-3">
            {project.description}
          </p>
        )}
        {project.credits && project.credits.length > 0 && (
          <ul className="mt-5 space-y-2 text-sm text-[var(--sub-text)] border-l border-[var(--foreground)]/20 pl-4 text-left">
            {project.credits.slice(0, 3).map((credit, idx) => (
              <li key={idx}>
                <strong className="font-semibold text-[var(--foreground)]">
                  {credit.label}:
                </strong> {credit.value}
              </li>
            ))}
          </ul>
        )}
        <div className="pt-4">
          <Link 
            href={`/du-an/${project.slug}`}
            className="inline-flex items-center gap-2 text-sm font-medium uppercase tracking-wider text-[var(--foreground)] hover:gap-4 transition-all duration-300 group/link"
          >
            Xem dự án <ArrowRight size={16} className="transition-transform group-hover/link:translate-x-1" />
          </Link>
        </div>
      </div>
    </motion.div>
  );
}

// --- Component Chính ---
export default function ProjectShowcase() {
  const [showcaseProjects, setShowcaseProjects] = useState<ProjectData[]>([]);
  const [isLoading, setIsLoading] = useState(true);

  useEffect(() => {
    const fetchAndFilter = async () => {
      try {
        const all = await getProjects();
        
        // 1. Lấy tất cả dự án Featured
        const allFeatured = all.filter(p => p.isFeatured);

        // 2. Lọc: Mỗi danh mục chỉ lấy 1 đại diện MỚI NHẤT
        // Danh sách các category slug cần lấy
        const targetCategories = ['thoi-trang', 'thuong-mai', 'ca-nhan'];
        
        const uniqueFeatured: ProjectData[] = [];

        targetCategories.forEach(catSlug => {
          // Tìm dự án Featured mới nhất của danh mục này
          const bestProject = allFeatured.find(p => p.category === catSlug);
          if (bestProject) {
            uniqueFeatured.push(bestProject);
          }
        });

        // Nếu thiếu (ví dụ chưa có dự án Cá nhân nào Featured), có thể lấy bù từ danh sách chung
        // (Ở đây mình giữ logic chặt: Không có thì không hiện)
        
        setShowcaseProjects(uniqueFeatured);
      } catch (error) {
        console.error("Lỗi tải showcase:", error);
      } finally {
        setIsLoading(false);
      }
    };

    fetchAndFilter();
  }, []);

  if (isLoading || showcaseProjects.length === 0) return null;

  return (
    <div className="max-w-8xl mx-auto px-4 md:px-8 py-20 border-t border-[var(--foreground)]/10">
      {showcaseProjects.map((project, index) => (
        <ProjectItem key={project.id} project={project} index={index} />
      ))}
    </div>
  );
}
</file>

<file path="src/app/thoi-trang/page.tsx">
import React from 'react';
import { getProjects } from '@/lib/actions';
import { Metadata } from 'next';
import Container from '@/components/Container';
import ProjectMasonryGrid from '@/components/ProjectMasonryGrid';

export const metadata: Metadata = {
  title: 'Dự án Thời Trang | Oni Studio',
  description: 'Các dự án editorial, lookbook và nhiếp ảnh thời trang.',
};

export const revalidate = 3600; // 1 hour
export default async function FashionPage() {
  const projects = await getProjects('thoi-trang'); // <-- Slug của danh mục

  return (
    <Container className="min-h-screen bg-[var(--background)] pt-32 pb-20 px-4 md:px-8">
      <div className="max-w-8xl mx-auto">
        
        <div className="mb-16">
          <h1 className="text-4xl md:text-6xl font-bold text-[var(--foreground)] tracking-tighter mb-4">
            Thời Trang
          </h1>
          <p className="text-[var(--sub-text)] text-lg max-w-xl">
            Khám phá các dự án thời trang, lookbook và editorial.
          </p>
        </div>

        {projects.length === 0 && (
          <div className="py-20 text-center text-[var(--sub-text)] border-y border-[var(--foreground)]/10">
            Chưa có dự án nào trong danh mục này.
          </div>
        )}

      <ProjectMasonryGrid projects={projects} variant="staggered" />

      </div>
    </Container>
  );
}
</file>

<file path="src/app/thuong-mai/page.tsx">
import React from 'react';
import { getProjects } from '@/lib/actions';
import { Metadata } from 'next';
import Container from '@/components/Container';
import ProjectMasonryGrid from '@/components/ProjectMasonryGrid';

export const metadata: Metadata = {
  title: 'Dự án Thương mại | Oni Studio',
  description: 'Các dự án Commercial, Editorial và Lookbook thực hiện bởi Oni Studio.',
};
export const revalidate = 3600; // 1 hour
export default async function CommercialPage() {
  const projects = await getProjects('thuong-mai'); // <-- Slug của danh mục

  return (
    <Container className="min-h-screen bg-[var(--background)] pt-32 pb-20 px-4 md:px-8">
      <div className="max-w-8xl mx-auto">
        
        <div className="mb-16">
          <h1 className="text-4xl md:text-6xl font-bold text-[var(--foreground)] tracking-tighter mb-4">
            Thương mại
          </h1>
          <p className="text-[var(--sub-text)] text-lg max-w-xl">
            Những chiến dịch quảng cáo và bộ ảnh thương mại được thực hiện với sự chỉn chu và sáng tạo.
          </p>
        </div>

        {projects.length === 0 && (
          <div className="py-20 text-center text-[var(--sub-text)] border-y border-[var(--foreground)]/10">
            Chưa có dự án nào trong danh mục này.
          </div>
        )}

        {/* Project Grid */}
        <ProjectMasonryGrid projects={projects} variant="flat" />
      </div>
    </Container>
  );
}
</file>

<file path="src/app/page.tsx">
// src/app/page.tsx

import type { Metadata } from 'next';
import HomePageContent from '@/components/HomePageContent';
export const revalidate = 3600; // 1 hour
export const metadata: Metadata = {
  title: 'Oni Studio',
  description: 'Oni Studio - Chuyên cung cấp dịch vụ nhiếp ảnh thương mại, thời trang, và cá nhân chuyên nghiệp. Khám phá portfolio và liên hệ để hợp tác.',
  keywords: ['nhiếp ảnh gia', 'photographer', 'commercial photography', 'fashion photography', 'Oni Studio'],

  openGraph: {
    title: 'Oni Studio',
    description: 'Khám phá portfolio ảnh thương mại, thời trang, và cá nhân từ Oni Studio.',
    url: 'https://www.your-domain.com', 
    siteName: 'Oni Studio',
    images: [
      {
        url: 'https://www.your-domain.com/og-image.png', 
        width: 1200,
        height: 630,
      },
    ],
    locale: 'vi_VN',
    type: 'website',
  },

  twitter: {
    card: 'summary_large_image',
    title: 'Oni Studio | Nhiếp ảnh Thương mại & Thời trang Chuyên nghiệp',
    description: 'Khám phá portfolio ảnh thương mại, thời trang, và cá nhân từ Oni Studio.',
    images: ['https://www.your-domain.com/twitter-image.png'], 
  },
};

export default function HomePage() {
  return (
    <HomePageContent />
  );
}
</file>

<file path="package.json">
{
  "name": "photographer-portfolio",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "eslint",
    "deploy": "cross-env NEXT_PUBLIC_IS_GH_PAGES=true next build"
  },
  "dependencies": {
    "@dnd-kit/core": "^6.3.1",
    "@dnd-kit/sortable": "^10.0.0",
    "@dnd-kit/utilities": "^3.2.2",
    "@supabase/ssr": "^0.7.0",
    "@supabase/supabase-js": "^2.81.1",
    "clsx": "^2.1.1",
    "date-fns": "^4.1.0",
    "lucide-react": "^0.554.0",
    "moment": "^2.30.1",
    "motion": "^12.23.24",
    "next": "15.5.4",
    "next-themes": "^0.4.6",
    "react": "19.1.0",
    "react-big-calendar": "^1.19.4",
    "react-dom": "19.1.0",
    "react-intersection-observer": "^9.16.0",
    "react-type-animation": "^3.2.0",
    "recharts": "^3.5.0",
    "sonner": "^2.0.7",
    "tailwind-merge": "^3.3.1",
    "yet-another-react-lightbox": "^3.25.0"
  },
  "devDependencies": {
    "@eslint/eslintrc": "^3",
    "@tailwindcss/postcss": "^4",
    "@types/node": "^20",
    "@types/react": "^19",
    "@types/react-big-calendar": "^1.16.3",
    "@types/react-dom": "^19",
    "cross-env": "^10.1.0",
    "eslint": "^9",
    "eslint-config-next": "15.5.4",
    "gh-pages": "^6.3.0",
    "tailwindcss": "^4",
    "typescript": "^5"
  }
}
</file>

<file path="src/app/globals.css">
@import "tailwindcss";
@import "yet-another-react-lightbox/styles.css";
@import "yet-another-react-lightbox/plugins/captions.css";
@import "yet-another-react-lightbox/plugins/thumbnails.css";
/* src/app/globals.css */

:root {
  /* Chuyển từ hex sang các giá trị RGB (không có 'rgb()' ) */
  --background: #f4f4f4;
  --foreground: #171717;
  --sub-text: #555555;
  --glow-color: #aa9f9f;
  --gradient-color-1: #f9fafb; /* gray-50 */
  --gradient-color-2: #f3f4f6; /* gray-100 */
  --gradient-color-3: #f9fafb; /* gray-50 */
  --to-linear: #dadada;
  --from-linear: #ebebeb;

  /* === ADMIN THEME (LIGHT MODE - Modern Slate) === */
  --admin-bg: #f8fafc;          /* Slate-50: Nền tổng thể sáng, hơi xanh nhẹ */
  --admin-card: #ffffff;        /* White: Nền thẻ */
  --admin-fg: #0f172a;          /* Slate-900: Chữ chính đậm */
  --admin-sub: #64748b;         /* Slate-500: Chữ phụ */
  --admin-border: #e2e8f0;      /* Slate-200: Viền nhạt */
  --admin-primary: #4f46e5;     /* Indigo-600: Màu chủ đạo (Button/Active) */
  --admin-primary-fg: #ffffff;  /* Chữ trên nền chủ đạo */
  --admin-hover: #f1f5f9;       /* Slate-100: Màu khi hover */
  --admin-edit: #EBF6FF;        /* bg-blue-50: Màu nền ô edit */
  --admin-delete: #FFE5E5;      /* bg-red-50: Màu nền ô xóa */
  --admin-ot: #f97316;       /* Orange-500 */
  --admin-ot-bg: #fff7ed;    /* Orange-50 */
  --admin-ot-border: #fdba74;/* Orange-300 */
  --status-checked-in: #22c55e; /* Green-500 */
  --status-completed: #64748b
}

html.dark { 
    /* --- MÀU CƠ BẢN --- */
    --background: #1E201E; /* Màu nền chính (Màu 1) */
    --foreground: #ECDFCC; /* Màu chữ chính (Màu 4) - Tương phản tốt trên nền tối */
    --sub-text: #9CA3AF;   /* Màu chữ phụ: Pha giữa Sage và Beige để dễ đọc hơn màu #697565 gốc */
    
    /* Hiệu ứng Glow/Shadow: Dùng màu Sage Green nhưng tối hơn */
    --glow-color: #697565; 

    /* Gradient: Chuyển từ nền chính sang nền thẻ */
    --gradient-color-1: #1E201E; 
    --gradient-color-2: #2D2E2B; /* Màu trung gian pha giữa Màu 1 và 2 */
    --gradient-color-3: #3C3D37; 
    
    --to-linear: #1E201E;
    --from-linear: #3C3D37;

    /* --- ADMIN DASHBOARD --- */

    /* Nền tổng thể của trang Admin */
    --admin-bg: #1E201E; 

    /* Nền của các khối/thẻ (Card) */
    --admin-card: #3C3D37; /* (Màu 2) */

    /* Màu chữ chính trong Admin */
    --admin-fg: #ECDFCC; /* (Màu 4) */

    /* Màu chữ phụ/Label/Icon ít quan trọng */
    --admin-sub: #AAB3A6; /* Phiên bản sáng hơn của #697565 để đảm bảo đọc được trên nền #3C3D37 */

    /* Viền ngăn cách: Dùng màu Sage Green gốc */
    --admin-border: #697565; /* (Màu 3) */

    /* Hiệu ứng Hover: Sáng hơn nền thẻ một chút */
    --admin-hover: #4B4C46; 

    /* --- NÚT BẤM CHÍNH (PRIMARY) --- */
    /* Dùng màu Beige sáng nhất để làm nút nổi bật trên nền tối */
    --admin-primary: #ECDFCC; 
    --admin-primary-fg: #1E201E; /* Chữ trên nút phải là màu tối nhất để dễ đọc */

    /* --- CÁC TRẠNG THÁI (STATUS / ACTIONS) --- */
    /* Điều chỉnh các màu này trầm xuống (desaturated) để hợp với theme Earth Tone */

    /* Nút Edit: Màu xanh đá (Slate/Teal) trầm */
    --admin-edit: #3A4A45;  

    /* Nút Delete: Màu đỏ gạch/đỏ đất (Brick Red) thay vì đỏ tươi */
    --admin-delete: #5C2B2B;  

    /* OT / Warning: Màu cam đất (Ochre/Burnt Orange) */
    --admin-ot: #D98E53;       /* Màu chữ/icon OT */
    --admin-ot-bg: #2C2520;    /* Nền thẻ OT (pha cam vào nền đen) */
    --admin-ot-border: #8C5E35; /* Viền thẻ OT */

    /* Status Checked-in: Dùng chính màu Sage Green của palette nhưng tươi hơn xíu */
    --status-checked-in: #84A98C; 

    /* Status Completed: Màu xám ấm */
    --status-completed: #8E8E86; 
}

html, body {
  height: 100%;
  margin: 0;
  padding: 0;
  background: var(--background);
  font-family: Arial, Helvetica, sans-serif;
  scroll-behavior: smooth;
}

/* MAIN WRAPPER */
main {
  width: 100%;
  /* overflow-x: hidden; */
}

/* FOOTER */
footer {
  will-change: opacity, transform;
}

/* KEYFRAMES CHO HIỆU ỨNG */
@keyframes ken-burns {
  0% {
    transform: scale(1) translate(0, 0);
    filter: brightness(1);
  }
  100% {
    transform: scale(1.1) translate(-1%, 1%);
    filter: brightness(0.95);
  }
}

@keyframes fade-in-up {
  0% {
    opacity: 0;
    transform: translateY(20px);
  }
  100% {
    opacity: 1;
    transform: translateY(0);
  }
}

/* CLASS TIỆN ÍCH */
.ken-burns-effect {
  /* Hiệu ứng chạy trong 25 giây, lặp lại vô hạn và luân phiên */
  animation: ken-burns 25s ease-in-out infinite alternate;
}

.animate-fade-in-up {
  /* Hiệu ứng xuất hiện trong 1.2 giây, có độ trễ 0.3 giây */
  animation: fade-in-up 1.2s ease-out 0.3s forwards;
  opacity: 0; /* Trạng thái ban đầu trước khi animation bắt đầu */
}

.text-shadow-md {
  text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
}


.menu-link-glow {
  transition: text-shadow 0.3s ease-out;
  will-change: text-shadow;
  text-shadow: 0 0 0 var(--glow-color);
}

.menu-link-glow:hover {
  text-shadow: 0 0 10px var(--glow-color), 0 0 20px var(--glow-color), 0 0 30px var(--glow-color);
}

/* === CSS CHO NỀN CHUYỂN ĐỘNG (SECTION 3) === */

/* 2. Keyframes (Giữ nguyên) */
@keyframes moveGradient {
  0% {
    background-position: 0% 50%;
  }
  50% {
    background-position: 100% 50%;
  }
  100% {
    background-position: 0% 50%;
  }
}

/* 3. Class animation (Chỉ cần 1 class duy nhất) */
.animated-gradient {
  /* Dùng 2 biến màu đã định nghĩa ở trên */
  background-image: linear-gradient(
    -45deg,
    var(--gradient-color-1),
    var(--gradient-color-2),
    var(--gradient-color-3)
  );
  background-size: 200% 200%;
  animation: moveGradient 5s ease-in-out infinite;
}


/* === CSS CHO BRAND SCROLLER (MỚI) === */
@keyframes infinite-scroll {
  from {
    transform: translateX(0);
  }
  to {
    transform: translateX(-100%);
  }
}

.animate-infinite-scroll {
  /* Tốc độ 40s. Bạn có thể điều chỉnh 40s thành số khác để nhanh/chậm hơn */
  animation: infinite-scroll 40s linear infinite;
}

/* === THANH CUỘN TINH TẾ === */

/* Áp dụng cho Firefox */
html {
  /* 1. Màu của Thumb (vị trí) - Dùng màu glow-color của bạn */
  scrollbar-color: var(--glow-color) var(--background);
  /* 2. Chiều rộng thanh cuộn */
  scrollbar-width: thin;
}

/* Áp dụng cho Chrome, Safari, Edge */

/* 1. Chiều rộng thanh cuộn */
body::-webkit-scrollbar {
  width: 8px;
}

/* 2. Màu của Track (đường chạy) - Đồng màu với nền */
body::-webkit-scrollbar-track {
  background: transparent;
}

/* 3. Màu của Thumb (vị trí) - Dùng màu của bạn */
body::-webkit-scrollbar-thumb {
  background-color: var(--foreground);
  border-radius: 4px;
}

/* 4. Tăng độ đậm khi hover lên thanh cuộn */
body::-webkit-scrollbar-thumb:hover {
  background-color: #ededed; /* Tùy chỉnh màu đậm hơn nếu muốn */
}

/* HTML: <div class="loader"></div> */
.loader {
  width: 50px;
  aspect-ratio: 1;
  display: grid;
  border: 4px solid #0000;
  border-radius: 50%;
  border-right-color: #25b09b;
  animation: l15 1s infinite linear;
}
.loader::before,
.loader::after {    
  content: "";
  grid-area: 1/1;
  margin: 2px;
  border: inherit;
  border-radius: 50%;
  animation: l15 2s infinite;
}
.loader::after {
  margin: 8px;
  animation-duration: 3s;
}
@keyframes l15{ 
  100%{transform: rotate(1turn)}
}

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.animate-fade-in-row {
  /* opacity ban đầu là 0 để tránh bị nháy */
  opacity: 0; 
  /* forwards giúp giữ trạng thái cuối cùng (opacity: 1) sau khi chạy xong */
  animation: fadeInUp 1s cubic-bezier(0.4, 0, 0.2, 1) forwards;
}

@layer utilities {
  /* Ẩn thanh cuộn cho Chrome, Safari and Opera */
  .no-scrollbar::-webkit-scrollbar {
    display: none;
  }
  /* Ẩn thanh cuộn cho IE, Edge and Firefox */
  .no-scrollbar {
    -ms-overflow-style: none;  /* IE and Edge */
    scrollbar-width: none;  /* Firefox */
  }

  /* Class dành riêng cho bảng */
  .table-scrollbar {
    /* Hỗ trợ Firefox (bắt buộc phải có dòng này Firefox mới hiện custom) */
    scrollbar-width: thin;
    scrollbar-color: var(--admin-sub) transparent;
  }

  /* Chrome, Edge, Safari */
  .table-scrollbar::-webkit-scrollbar {
    height: 8px; /* Chiều cao cho thanh ngang */
    width: 8px;  /* Chiều rộng cho thanh dọc */
  }

  .table-scrollbar::-webkit-scrollbar-track {
    background: transparent;
  }

  .table-scrollbar::-webkit-scrollbar-thumb {
    /* Dùng background-clip để tạo cảm giác thumb có padding */
    background-color: var(--admin-sub); 
    border-radius: 20px;
    border: 2px solid transparent; /* Tạo khoảng hở xung quanh thumb */
    background-clip: content-box; 
  }

  .table-scrollbar::-webkit-scrollbar-thumb:hover {
    background-color: var(--admin-fg);
  }
}

/* === GOOGLE CALENDAR RESOURCE VIEW OVERRIDES === */

/* 1. Header Cột Phòng (Day View) */
.rbc-time-header-content {
  border-left: 1px solid var(--admin-border) !important;
  background-color: var(--admin-card);
}

.rbc-resource-header-cell {
  /* Style cho tên phòng trên đầu cột */
  padding: 12px 0 !important;
  color: var(--admin-fg) !important;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

/* Màu riêng cho từng cột phòng (Optional: Tạo hiệu ứng xen kẽ) */
.rbc-day-slot {
  background-color: var(--admin-card);
  transition: background-color 0.2s;
}
.rbc-day-slot:hover {
  background-color: var(--admin-bg); /* Highlight nhẹ khi rê chuột vào cột phòng */
}
.rbc-events-container:hover {
  background-color: var(--admin-bg)/20; /* Đồng bộ với phần khung giờ */
}

/* 2. Grid & Lines */
.rbc-timeslot-group {
  border-bottom: none !important; /* Bỏ viền thừa giữa các khung giờ */
  min-height: 50px !important; /* Chiều cao mỗi giờ, đủ rộng để hiển thị thông tin */
}

.rbc-time-content {
  border-top: none !important; /* Bỏ viền thừa */
}

.rbc-time-gutter .rbc-timeslot-group {
  border-bottom: none !important; /* Cột giờ bên trái sạch sẽ */
}

/* 3. Sự kiện (Event Box) */
.rbc-event {
  border: none !important;
  padding: 0 !important;
  margin: 1px 2px !important; /* Cách lề một chút cho đẹp */
  border-radius: 4px !important;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  transition: transform 0.1s, z-index 0.1s;
  z-index: 50 !important;
}

.rbc-event:hover {
  transform: scale(1.02); /* Phóng to nhẹ khi hover sự kiện */
  z-index: 50 !important;
  box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

/* 4. Current Time Indicator (Vạch đỏ chỉ giờ) */
.rbc-current-time-indicator {
  background-color: #ea4335 !important;
  height: 2px !important;
}

/* 5. Ẩn các phần thừa */
.rbc-header {
  /* Ẩn header ngày tháng mặc định vì trong Resource View ta quan tâm tên phòng hơn */
  /* Hoặc giữ lại nếu muốn hiện cả Thứ ngày + Tên phòng */
  border-bottom: none !important; 
}
.rbc-allday-cell {
  /* Tùy chọn: Ẩn dòng All Day nếu ít dùng để tiết kiệm diện tích */
  display: none; 
}
.rbc-time-view-resources .rbc-time-gutter, .rbc-time-view-resources .rbc-time-header-gutter {
  background-color: var(--admin-card) !important;
}

.rbc-today {
  background-color: var(--admin-card) !important;
}



.rbc-time-view{
  border: none !important;
}

.rbc-day-slot .rbc-time-slot{
  border: none !important;
}

.rbc-timeslot-group{
  border-top: 1px solid var(--admin-border);
}



/* 1. Ẩn label của ô đầu tiên (00:00) */
.rbc-time-gutter .rbc-timeslot-group:first-child .rbc-label {
    display: none; /* Hoặc visibility: hidden; */
}

.rbc-time-slot .rbc-label {
  position: relative;
}

.rbc-label .rbc-time-header-gutter{
  min-width: 37.55px;
}
.rbc-label {
  width: 100%;
  position: absolute;
  top: -14px;
  background-color: var(--admin-card);
  font-size: 0.65em; 
  font-weight: 700;
  z-index: 10;
}

.rbc-time-view-resources .rbc-time-gutter, .rbc-time-view-resources .rbc-time-header-gutter{
  border-right: 1px solid var(--admin-border) !important;
}
.rbc-time-header-content > .rbc-row.rbc-row-resources {
  border-bottom: 1px solid var(--admin-border) !important;
}
.rbc-time-content > * + * > * {
  border-left: 1px solid var(--admin-border) !important;
}
.rbc-time-header-content > .rbc-row.rbc-row-resource {
  border-bottom: 1px solid var(--admin-border) !important;
}
.rbc-time-header.rbc-overflowing {
  border-right: none !important;
}


/* 1. Target vào container chứa nội dung lịch */
.rbc-time-content::-webkit-scrollbar {
    width: 3px; /* Độ rộng thanh cuộn (nhỏ gọn) */
    height: 3px; /* Độ cao thanh cuộn ngang (nếu có) */
}

/* 2. Phần rãnh (Track) - Nền của thanh cuộn */
.rbc-time-content::-webkit-scrollbar-track {
    background: transparent; /* Để trong suốt cho đẹp */
    /* Hoặc dùng màu: background: var(--admin-bg); */
}

/* 3. Phần tay cầm (Thumb) - Cái cục để kéo */
.rbc-time-content::-webkit-scrollbar-thumb {
    background-color: var(--admin-border); /* Màu xám nhẹ */
    border-radius: 10px; /* Bo tròn 2 đầu */
}

/* 4. Hiệu ứng khi di chuột vào tay cầm */
.rbc-time-content::-webkit-scrollbar-thumb:hover {
    background-color: var(--admin-sub); /* Đậm hơn chút khi hover */
}
</file>

</files>
```

## File: src/components/admin/calendar/BookingDetailModal.tsx
```typescript
// src/components/admin/calendar/BookingDetailModal.tsx
'use client';

import React, { useState, useEffect, useCallback } from 'react';
import { Check, Trash2, Plus, DollarSign, User, FileText, RotateCcw, Loader2, Camera, Coffee, AlertCircle, LogIn, LogOut } from 'lucide-react';
import { toast } from 'sonner';
import ModalPortal from '@/components/ui/ModalPortal';
import { getBookingDetails, addBookingService, removeBookingService, checkInCustomer, checkOutCustomer, confirmPayment, finalizeBooking } from '@/lib/actions/booking-details';
import { ServiceItem } from '@/lib/actions/studio';
import { format } from 'date-fns';
import { calculateBilling, fmtMoney, formatDuration } from '@/lib/utils';

interface BookingDetailModalProps {
  isOpen: boolean;
  onClose: () => void;
  bookingId: number | null;
  servicesList: ServiceItem[];
}

interface BookingItemDetail {
    booking_item_id: number;
    room_id: number;
    start_dt: string;
    end_dt: string;
    price_snapshot: number;
    rooms: {
        name: string | null;
        code: string | null;
    } | null;
}

interface BookingServiceDetail {
    booking_service_id: number;
    quantity: number;
    unit_price_snapshot: number;
    computed_amount: number;
    type: string;
    services: {
        name: string;
        unit: string;
        price: number;
        category: string;
    } | null;
}

interface BookingDetail {
    booking_id: number;
    status: string;
    deposit_amount: number;
    check_in_at?: string;
    check_out_at?: string;
    customers: {
        full_name: string | null;
        phone: string | null;
    } | null;
    booking_items: BookingItemDetail[];       
    booking_services: BookingServiceDetail[]; 
}

// Định nghĩa kiểu dữ liệu cho BillingInfo
interface FeeDetail {
    isBillable: boolean;
    minutes: number;
    billableHours: number;
    amount: number;
    message: string;
}

interface BillingInfo {
    totalSurcharge: number;
    earlyFee: FeeDetail;
    otFee: FeeDetail;
    surchargeMessages?: string[];
}

// Giá trị mặc định để tránh lỗi undefined
const DEFAULT_FEE: FeeDetail = {
    isBillable: false,
    minutes: 0,
    billableHours: 0,
    amount: 0,
    message: ''
};

const DEFAULT_BILLING: BillingInfo = {
    totalSurcharge: 0,
    earlyFee: DEFAULT_FEE,
    otFee: DEFAULT_FEE
};

export default function BookingDetailModal({ isOpen, onClose, bookingId, servicesList }: BookingDetailModalProps) {
  const [booking, setBooking] = useState<BookingDetail | null>(null);
  const [loading, setLoading] = useState(false);
  
  // State Tabs
  const [activeTab, setActiveTab] = useState<'equipment' | 'fnb' | 'surcharge'>('equipment');
  const [isAddingService, setIsAddingService] = useState(false);
  const [selectedServiceId, setSelectedServiceId] = useState<string>('');
  const [qty, setQty] = useState(1);
  const [otPrice] = useState(300000); // Giá OT mặc định

  const fetchDetails = useCallback(async () => {
    if (!bookingId) return;
    setLoading(true);
    const res = await getBookingDetails(bookingId);
    if (res.success) {
        setBooking(res.data as unknown as BookingDetail);
    } else {
        toast.error(res.error);
    }
    setLoading(false);
  }, [bookingId]);

  useEffect(() => {
    if (isOpen && bookingId) {
      fetchDetails();
    } else {
        setBooking(null);
    }
  }, [isOpen, bookingId, fetchDetails]);

  // --- ACTIONS ---
  const handleCheckIn = async () => {
      if (!booking || !booking.booking_items || booking.booking_items.length === 0) return;
      const roomId = booking.booking_items[0].room_id; 
      const bookedStart = booking.booking_items[0].start_dt;
      
      const res = await checkInCustomer(booking.booking_id, roomId, bookedStart);
      if(res.success) { toast.success("Checked-in thành công!"); fetchDetails(); }
      else toast.error(res.error);
  }

  const handleCheckOut = async () => {
      if (!booking) return;
      const res = await checkOutCustomer(booking.booking_id);
      if(res.success) { toast.success("Đã dừng giờ (Check-out)!"); fetchDetails(); }
      else toast.error(res.error);
  }

  const handlePayment = async (totalToPay: number) => {
      if (!booking) return;
      if(!confirm(`Xác nhận khách đã thanh toán ${fmtMoney(totalToPay)}?`)) return;

      const res = await confirmPayment(booking.booking_id, totalToPay);
      if(res.success) { toast.success("Thanh toán thành công!"); fetchDetails(); }
      else toast.error(res.error);
  }

  const handleFinalize = async () => {
      if (!booking) return;
      const res = await finalizeBooking(booking.booking_id);
      if(res.success) { toast.success("Đơn hàng đã đóng!"); fetchDetails(); onClose(); }
      else toast.error(res.error);
  }

  const handleAddService = async () => {
     if (!selectedServiceId || !booking) return;
     const service = servicesList.find(s => s.service_id === Number(selectedServiceId));
     if (!service) return;

     const res = await addBookingService(booking.booking_id, service.service_id, qty, service.price);
     if (res.success) {
         toast.success("Đã thêm dịch vụ");
         setIsAddingService(false);
         fetchDetails();
     } else {
         toast.error(res.error);
     }
  };

  const handleRemoveService = async (id: number) => {
      const res = await removeBookingService(id);
      if (res.success) {
          toast.success("Đã xóa");
          fetchDetails();
      }
  };

  // --- LOGIC TÍNH TOÁN ---
  // 1. Lấy thông tin OT/Checkin sớm từ utils
  const billingInfo: BillingInfo = booking && booking.booking_items.length > 0 ? calculateBilling(
    new Date(booking.booking_items[0].start_dt),
    new Date(booking.booking_items[0].end_dt),
    booking.check_in_at ? new Date(booking.check_in_at) : null,
    booking.check_out_at ? new Date(booking.check_out_at) : null,
    otPrice, 
    { earlyGrace: 40, otFree: 60 }
  ) : DEFAULT_BILLING;

  // 2. Tổng hợp tiền
  const calculateTotal = () => {
     if (!booking) return 0;
     const roomTotal = booking.booking_items?.reduce((sum, item) => sum + (item.price_snapshot || 0), 0) || 0;
     const serviceTotal = booking.booking_services?.reduce((sum, s) => sum + (s.computed_amount || 0), 0) || 0;
     const surchargeTotal = billingInfo.totalSurcharge || 0;

     return roomTotal + serviceTotal + surchargeTotal;
  };

  const dropdownServices = servicesList.filter(s => s.category === activeTab);
  
  const totalAmount = calculateTotal();
  const deposit = booking?.deposit_amount || 0;
  const remaining = totalAmount - deposit;

  // Tạo mảng thông báo surcharge để hiển thị
  const surchargeMessages = [];
  if (billingInfo.earlyFee.message) surchargeMessages.push(billingInfo.earlyFee.message);
  if (billingInfo.otFee.message) surchargeMessages.push(billingInfo.otFee.message);

  if (!isOpen) return null;

  return (
    <ModalPortal isOpen={isOpen} onClose={onClose} title={`Chi tiết đơn #${bookingId}`} className="max-w-4xl">
       {loading || !booking ? (
           <div className="p-10 flex justify-center items-center">
               <Loader2 className="animate-spin" />
           </div>
       ) : (
           <div className="flex flex-col md:flex-row h-[80vh] md:h-auto">
               
               {/* CỘT TRÁI */}
               <div className="flex-1 p-6 overflow-y-auto bg-[var(--admin-bg)]/50 space-y-6">
                   
                   {/* 1. HEADER INFO & STATUS TAG */}
                   <div className="flex justify-between items-start">
                       <div>
                           <div className="flex items-center gap-2">
                                <h2 className="text-lg font-bold text-[var(--admin-fg)]">{booking.customers?.full_name}</h2>
                                <button 
                                   onClick={fetchDetails}
                                   className="p-1.5 hover:bg-gray-200 rounded-full text-gray-500 transition-colors cursor-pointer"
                                   title="Làm mới dữ liệu"
                                >
                                   <RotateCcw size={14} />
                                </button>
                           </div>
                           <div className="text-sm text-[var(--admin-sub)] flex items-center gap-1"><User size={14}/> {booking.customers?.phone}</div>
                       </div>
                       <div className="text-right">
                            <span className={`px-2 py-1 rounded text-xs font-bold uppercase ${
                                booking.status === 'checked_in' ? 'bg-green-100 text-green-700' : 
                                booking.status === 'checked_out' ? 'bg-red-100 text-red-700' :
                                booking.status === 'pending' ? 'bg-yellow-100 text-yellow-700' :
                                booking.status === 'confirmed' ? 'bg-blue-100 text-blue-700' :
                                booking.status === 'paid' ? 'bg-purple-100 text-purple-700' :
                                booking.status === 'completed' ? 'bg-gray-200 text-gray-600' : 'bg-blue-100 text-blue-700'
                            }`}>
                                {booking.status === 'checked_in' ? 'Khách đang ở Stu' :
                                 booking.status === 'checked_out' ? 'Khách đã rời Stu' :
                                 booking.status === 'paid' ? 'Đã thanh toán' :
                                 booking.status === 'confirmed' ? 'Đã xác nhận' :
                                 booking.status}
                            </span>
                       </div>
                   </div>

                   {/* 2. TIMELINE */}
                   <div className="bg-[var(--admin-card)] p-4 rounded-xl border border-[var(--admin-border)] shadow-sm">
                        <div className="grid grid-cols-2 gap-6 mb-2">
                            <div className="space-y-4 border-r border-[var(--admin-border)] pr-4">
                                {booking.booking_items.map(item => (
                                    <div key={item.booking_item_id}>
                                        <div className="font-bold text-sm text-[var(--admin-fg)] mb-1">{item.rooms?.name}</div>
                                        <div className="flex justify-between text-xs">
                                            <div>
                                                <div className="text-[10px] text-[var(--admin-sub)] uppercase">Giờ đặt lịch</div>
                                                <div className="font-bold">{format(new Date(item.start_dt), 'HH:mm')}</div>
                                            </div>
                                            <div>
                                                <div className="text-[10px] text-[var(--admin-sub)] uppercase">Giờ kết lịch</div>
                                                <div className="font-bold">{format(new Date(item.end_dt), 'HH:mm')}</div>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                            <div className="space-y-4">
                                <div className="flex justify-between text-xs">
                                    <div>
                                        <div className="text-[10px] text-[var(--admin-sub)] uppercase flex items-center gap-1"><LogIn size={10}/> Check-in</div>
                                        <div className={`font-bold ${booking.check_in_at ? 'text-green-600' : 'text-gray-400'}`}>
                                            {booking.check_in_at ? format(new Date(booking.check_in_at), 'HH:mm') : '--:--'}
                                        </div>
                                    </div>
                                    <div>
                                        <div className="text-[10px] text-[var(--admin-sub)] uppercase flex items-center gap-1"><LogOut size={10}/> Check-out</div>
                                        <div className={`font-bold ${booking.check_out_at ? 'text-blue-600' : 'text-gray-400'}`}>
                                            {booking.check_out_at ? format(new Date(booking.check_out_at), 'HH:mm') : '--:--'}
                                        </div>
                                    </div>
                                </div>
                                {surchargeMessages.length > 0 && (
                                    <div className="bg-[var(--admin-card)] mt-3 text-xs text-[var(--admin-primary)]">
                                        {surchargeMessages.map((msg, idx) => (
                                            <div key={idx}>• {msg}</div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        </div>
                   </div>

                   {/* 3. DỊCH VỤ (TABS) */}
                   <div className="bg-[var(--admin-card)] rounded-xl border border-[var(--admin-border)] shadow-sm overflow-hidden">
                       <div className="flex border-b border-[var(--admin-border)]">
                           <button onClick={() => setActiveTab('equipment')} className={`flex-1 py-3 text-xs font-bold uppercase flex justify-center gap-2 cursor-pointer ${activeTab === 'equipment' ? 'bg-[var(--admin-bg)] text-[var(--admin-primary)] border-b-2 border-[var(--admin-primary)]' : 'text-[var(--admin-sub)]'}`}>
                               <Camera size={14}/> Thiết bị
                           </button>
                           <button onClick={() => setActiveTab('fnb')} className={`flex-1 py-3 text-xs font-bold uppercase flex justify-center gap-2 cursor-pointer ${activeTab === 'fnb' ? 'bg-[var(--admin-bg)] text-[var(--admin-primary)] border-b-2 border-[var(--admin-primary)]' : 'text-[var(--admin-sub)]'}`}>
                               <Coffee size={14}/> F&B
                           </button>
                           <button onClick={() => setActiveTab('surcharge')} className={`flex-1 py-3 text-xs font-bold uppercase flex justify-center gap-2 cursor-pointer ${activeTab === 'surcharge' ? 'bg-[var(--admin-bg)] text-[var(--admin-primary)] border-b-2 border-[var(--admin-primary)]' : 'text-[var(--admin-sub)]'}`}>
                               <AlertCircle size={14}/> Phụ phí
                           </button>
                       </div>

                       <div className="p-4">
                           <div className="flex justify-between items-center mb-3">
                               <div className="text-xs font-bold text-[var(--admin-sub)] uppercase">Danh sách {activeTab}</div>
                               {booking.status !== 'completed' && booking.status !== 'paid' && (
                                   <button onClick={() => setIsAddingService(!isAddingService)} className="text-[10px] bg-[var(--admin-primary)]/10 text-[var(--admin-primary)] px-2 py-1 rounded font-bold flex items-center gap-1 cursor-pointer hover:bg-[var(--admin-primary)]/20 transition-colors">
                                       <Plus size={12}/> {isAddingService ? 'Đóng' : 'Thêm'}
                                   </button>
                               )}
                           </div>

                           {isAddingService && (
                               <div className="bg-[var(--admin-bg)] p-3 rounded border border-[var(--admin-border)] mb-3 animate-fade-in-up">
                                   <div className="flex gap-2 mb-2">
                                       <select className="flex-1 p-1 text-sm border rounded bg-[var(--admin-card)]" 
                                               value={selectedServiceId} onChange={e => setSelectedServiceId(e.target.value)}>
                                           <option value="">-- Chọn dịch vụ --</option>
                                           {dropdownServices.map((s) => (
                                               <option key={s.service_id} value={s.service_id}>{s.name} - {fmtMoney(s.price)}</option>
                                           ))}
                                       </select>
                                       <input type="number" value={qty} onChange={e => setQty(Number(e.target.value))} className="w-12 text-center border rounded bg-[var(--admin-card)] text-sm"/>
                                   </div>
                                   <div className="flex justify-end gap-2">
                                       <button onClick={handleAddService} className="text-xs bg-[var(--admin-fg)] text-[var(--admin-bg)] px-3 py-1 rounded font-bold">Lưu</button>
                                   </div>
                               </div>
                           )}

                           <div className="space-y-2 max-h-40 overflow-y-auto table-scrollbar">
                               {booking.booking_services
                                   ?.filter(s => s.services?.category === activeTab)
                                   .map((s) => (
                                   <div key={s.booking_service_id} className="flex justify-between items-center p-2 border-b border-[var(--admin-border)] last:border-0">
                                       <div>
                                           <div className="text-sm font-medium">{s.services?.name}</div>
                                           <div className="text-xs text-[var(--admin-sub)]">{s.quantity} x {fmtMoney(s.unit_price_snapshot || 0)}</div>
                                       </div>
                                       <div className="flex items-center gap-3">
                                           <span className="text-sm font-mono">{fmtMoney(s.computed_amount || 0)}</span>
                                           {booking.status !== 'completed' && booking.status !== 'paid' && (
                                                <button onClick={() => handleRemoveService(s.booking_service_id)} className="text-[var(--admin-sub)] hover:text-red-500">
                                                    <Trash2 size={14}/>
                                                </button>
                                           )}
                                       </div>
                                   </div>
                               ))}
                           </div>
                       </div>
                   </div>
               </div>

               {/* CỘT PHẢI: BILL & ACTIONS */}
               <div className="w-full md:w-96 bg-[var(--admin-card)] border-l border-[var(--admin-border)] p-6 flex flex-col justify-between shadow-xl z-10">
                   <div>
                       <div className="flex items-center gap-2 mb-6 pb-4 border-b border-[var(--admin-border)]">
                           <FileText size={20} className="text-[var(--admin-primary)]"/>
                           <h3 className="font-bold text-[var(--admin-fg)] uppercase tracking-widest">Hóa Đơn</h3>
                       </div>

                       <div className="bg-[var(--admin-bg)]/30 p-4 rounded-xl border border-[var(--admin-border)] space-y-3 font-mono text-sm">
                            
                            {/* 1. TIỀN PHÒNG & DỊCH VỤ (CỐ ĐỊNH) */}
                            <div className="space-y-2">
                                <div className="flex justify-between items-center">
                                    <span className="text-[var(--admin-sub)] font-medium">Tiền phòng</span>
                                    <span className="font-bold text-[var(--admin-fg)]">
                                        {fmtMoney(booking.booking_items?.reduce((a, b) => a + (b.price_snapshot || 0), 0) || 0)}
                                    </span>
                                </div>
                                <div className="flex justify-between items-center">
                                    <span className="text-[var(--admin-sub)] font-medium">Dịch vụ</span>
                                    <span className="font-bold text-[var(--admin-fg)]">
                                        {fmtMoney(booking.booking_services?.reduce((a, b) => a + (b.computed_amount || 0), 0) || 0)}
                                    </span>
                                </div>
                            </div>

                            {/* 2. PHỤ PHÍ THỜI GIAN (CHECK-IN/OUT) */}
                            {(booking.check_in_at || booking.check_out_at) && (
                                <div className="border-t border-dashed border-[var(--admin-border)] pt-2 space-y-2">
                                    
                                    {/* Check-in Sớm */}
                                    {booking.check_in_at && (
                                        <div className={`rounded-lg p-2 text-xs bg ${billingInfo.earlyFee.isBillable ? 'border border-orange-100' : 'bg-transparent'}`}>
                                            <div className="flex justify-between items-center mb-1">
                                                <div className="flex items-center gap-1.5 text-[var(--admin-sub)]">
                                                    <LogIn size={12} className="text-[var(--admin-fg)]"/>
                                                    <span className="text-[var(--admin-fg)]">Vào: <strong className="text-[var(--admin-fg)]">{format(new Date(booking.check_in_at), 'HH:mm')}</strong></span>
                                                </div>
                                                {/* Tag trạng thái */}
                                                {billingInfo.earlyFee.minutes > 0 && (
                                                    <span className={`px-1.5 py-0.5 rounded text-[10px] font-bold uppercase ${billingInfo.earlyFee.isBillable ? 'bg-orange-100 text-orange-700' : 'bg-green-100 text-green-700'}`}>
                                                        {billingInfo.earlyFee.isBillable ? 'Phụ thu' : 'Miễn phí'}
                                                    </span>
                                                )}
                                            </div>

                                            {/* Dòng tính tiền Check-in sớm */}
                                            {billingInfo.earlyFee.isBillable && (
                                                <div className="flex justify-between items-start pl-4">
                                                    <div className="flex flex-col">
                                                        <span className="text-orange-700 font-medium">+ Check-in sớm {formatDuration(billingInfo.earlyFee.minutes)}</span>
                                                        <span className="text-[10px] text-orange-600/70">
                                                            ({formatDuration(billingInfo.earlyFee.billableHours * 60)} x {fmtMoney(otPrice)})
                                                        </span>
                                                    </div>
                                                    <span className="font-bold text-orange-700">{fmtMoney(billingInfo.earlyFee.amount)}</span>
                                                </div>
                                            )}
                                        </div>
                                    )}

                                    {/* OT (Check-out Trễ) */}
                                    {booking.check_out_at && (
                                        <div className={`rounded-lg p-2 text-xs ${billingInfo.otFee.isBillable ? 'border border-red-100' : 'bg-transparent'}`}>
                                            <div className="flex justify-between items-center mb-1">
                                                <div className="flex items-center gap-1.5 text-[var(--admin-sub)]">
                                                    <LogOut size={12} className="text-[var(--admin-fg)]"/>
                                                    <span className="text-[var(--admin-fg)]">Ra: <strong className="text-[var(--admin-fg)]">{format(new Date(booking.check_out_at), 'HH:mm')}</strong></span>
                                                </div>
                                                {/* Tag trạng thái */}
                                                {billingInfo.otFee.minutes > 0 && (
                                                    <span className={`px-1.5 py-0.5 rounded text-[10px] font-bold uppercase ${billingInfo.otFee.isBillable ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`}>
                                                        {billingInfo.otFee.isBillable ? 'Phụ thu' : 'Miễn phí'}
                                                    </span>
                                                )}
                                            </div>

                                            {/* Dòng tính tiền OT */}
                                            {billingInfo.otFee.isBillable && (
                                                <div className="flex justify-between items-start pl-4">
                                                    <div className="flex flex-col">
                                                        <span className="text-red-700 font-medium">+ OT {formatDuration(billingInfo.otFee.minutes)}</span>
                                                        <span className="text-[10px] text-red-600/70">
                                                            ({formatDuration(billingInfo.otFee.billableHours * 60)} x {fmtMoney(otPrice)})
                                                        </span>
                                                    </div>
                                                    <span className="font-bold text-red-700">{fmtMoney(billingInfo.otFee.amount)}</span>
                                                </div>
                                            )}
                                        </div>
                                    )}
                                </div>
                            )}

                            {/* 3. ĐÃ CỌC & TỔNG KẾT */}
                            <div className="border-t border-[var(--admin-border)] pt-3 space-y-3">
                                <div className="flex justify-between items-center text-green-600 text-xs font-medium">
                                    {fmtMoney(deposit) !== '0 VNĐ' && (
                                        <>
                                            <span>Đã cọc trước</span>
                                            <span>- {fmtMoney(deposit)}</span>
                                        </>
                                    )} else (
                                         <>
                                            <span>Chưa cọc</span>
                                        </>
                                    )
                                </div>

                                <div className="flex justify-between items-center bg-[var(--admin-primary)]/5 p-3 rounded-lg border border-[var(--admin-primary)]/20">
                                    <span className="text-base font-bold text-[var(--admin-primary)] uppercase tracking-tight">Cần thanh toán</span>
                                    <span className="text-xl font-extrabold text-[var(--admin-primary)]">
                                        {fmtMoney(remaining)}
                                    </span>
                                </div>
                            </div>
                        </div>
                   </div>

                   {/* ACTIONS BUTTONS */}
                   <div className="space-y-3 mt-8">
                       {/* 1. CHECK-IN */}
                       {booking.status === 'confirmed' && (
                           <button onClick={handleCheckIn} className="w-full py-4 bg-green-600 text-white rounded-xl 
                           font-bold shadow-lg shadow-green-200 hover:bg-green-700 transition-all flex justify-center items-center gap-2 cursor-pointer">
                               <LogIn size={20}/> CHECK-IN KHÁCH
                           </button>
                       )}

                       {/* 2. CHECK-OUT */}
                       {booking.status === 'checked_in' && (
                           <button onClick={handleCheckOut} className="w-full py-4 text-white rounded-xl 
                           font-bold shadow-lg transition-all flex justify-center items-center gap-2 cursor-pointer">
                               <LogOut size={20}/> KHÁCH RỜI (DỪNG GIỜ)
                           </button>
                       )}

                       {/* 3. THANH TOÁN */}
                       {booking.status === 'checked_out' && (
                           <div className="space-y-2">
                               <button onClick={() => handlePayment(remaining)} className="w-full py-4 bg-[var(--admin-primary)] text-white rounded-xl font-bold 
                               shadow-lg hover:opacity-90 flex justify-center items-center gap-2 cursor-pointer">
                                   <DollarSign size={20}/> XÁC NHẬN ĐÃ THU TIỀN
                               </button>
                           </div>
                       )}

                       {/* 4. HOÀN TẤT */}
                       {booking.status === 'paid' && (
                           <div className="space-y-2">
                               <div className="text-center text-xs text-blue-600 font-medium bg-blue-50 p-2 rounded">
                                   Đã thanh toán. Kiểm tra phòng và đóng đơn.
                               </div>
                               <button onClick={handleFinalize} className="w-full py-3 border border-gray-300 bg-white text-gray-700 rounded-xl 
                               font-bold hover:bg-gray-50 flex justify-center items-center gap-2 cursor-pointer">
                                   <Check size={20}/> HOÀN TẤT ĐƠN
                               </button>
                           </div>
                       )}

                       {booking.status === 'completed' && (
                           <div className="bg-gray-100 text-gray-500 text-center py-3 rounded-xl font-bold text-sm border border-gray-200">
                               ĐƠN ĐÃ HOÀN TẤT
                           </div>
                       )}

                        {booking.status !== 'completed' && (
                            <button onClick={onClose} className="w-full py-3 text-[var(--admin-sub)] hover:bg-[var(--admin-hover)] 
                            rounded-xl font-medium transition-colors cursor-pointer">
                                Đóng
                            </button>
                        )}
                   </div>
               </div>
           </div>
       )}
    </ModalPortal>
  );
}
```

## File: src/lib/actions/booking-details.ts
```typescript
// src/lib/actions/booking-details.ts
'use server'

import { createClient } from '@/lib/supabase/server'
import { revalidatePath } from 'next/cache'

// 1. Lấy chi tiết Booking
export async function getBookingDetails(bookingId: number) {
  const supabase = await createClient();
  
  const { data, error } = await supabase
    .from('bookings')
    .select(`
      *,
      customers (*),
      booking_items (
        *, 
        rooms (name, code)
      ),
      booking_services (
        *, 
        services (name, price, unit, category)
      )
    `)
    .eq('booking_id', bookingId)
    .single();

  if (error) return { success: false, error: error.message };
  return { success: true, data };
}

// 2. Thêm dịch vụ
export async function addBookingService(bookingId: number, serviceId: number, quantity: number, price: number) {
  const supabase = await createClient();

  const { error } = await supabase.from('booking_services').insert({
    booking_id: bookingId,
    service_id: serviceId,
    quantity: quantity,
    unit_price_snapshot: price,
    computed_amount: quantity * price,
    type: 'surcharge' 
  });
  
  if (error) return { success: false, error: error.message };
  revalidatePath('/admin');
  return { success: true };
}

// 3. Xóa dịch vụ
export async function removeBookingService(bookingServiceId: number) {
  const supabase = await createClient();
  const { error } = await supabase.from('booking_services').delete().eq('booking_service_id', bookingServiceId);
  
  if (error) return { success: false, error: error.message };
  revalidatePath('/admin');
  return { success: true };
}

// Định nghĩa Type Status khớp với DB (Logic của App)
export type BookingStatus = 
  | "pending"       
  | "confirmed"     
  | "checked_in"    
  | "checked_out"   
  | "paid"          
  | "completed"     
  | "cancelled";    

// 4. CHECK-IN
export async function checkInCustomer(bookingId: number, roomId: number, bookedStart: string) {
  const supabase = await createClient();
  const now = new Date(); 

  const { data: settingData } = await supabase
    .from('settings')
    .select('value')
    .eq('key', 'EARLY_CHECKIN_GRACE_MINUTES')
    .single();
  const graceMinutes = Number(settingData?.value || 40);

  const bookedStartDate = new Date(bookedStart);
  const diffMinutes = (bookedStartDate.getTime() - now.getTime()) / 60000;

  if (diffMinutes > graceMinutes) {
      const { data: conflicts } = await supabase
        .from('booking_items')
        .select('booking_item_id')
        .eq('room_id', roomId)
        .neq('booking_id', bookingId) 
        .lt('start_dt', bookedStartDate.toISOString()) 
        .gt('end_dt', now.toISOString());

      if (conflicts && conflicts.length > 0) {
          return { success: false, error: "Không thể check-in sớm: Đang có khách khác sử dụng phòng." };
      }
  }

  const { error } = await supabase
    .from('bookings')
    .update({ 
        status: 'checked_in',
        check_in_at: now.toISOString()
    })
    .eq('booking_id', bookingId);

  if (error) return { success: false, error: error.message };
  revalidatePath('/admin');
  return { success: true };
}

// 5. CHECK-OUT (FIX LỖI TYPE Ở ĐÂY)
export async function checkOutCustomer(bookingId: number) {
    const supabase = await createClient();
    const now = new Date();

    const { error } = await supabase
        .from('bookings')
        .update({ 
            status: 'checked_out', 
            check_out_at: now.toISOString() 
        })
        .eq('booking_id', bookingId);

    if (error) return { success: false, error: error.message };
    revalidatePath('/admin');
    return { success: true };
}

// 6. CONFIRM PAYMENT (FIX LỖI TYPE Ở ĐÂY)
export async function confirmPayment(bookingId: number, totalActual: number) {
    const supabase = await createClient();

    const { error } = await supabase
        .from('bookings')
        .update({ 
            // FIX: Ép kiểu 'as any'
            status: 'paid', 
            total_actual: totalActual
        })
        .eq('booking_id', bookingId);

    if (error) return { success: false, error: error.message };
    revalidatePath('/admin');
    return { success: true };
}

// 7. FINALIZE
export async function finalizeBooking(bookingId: number) {
    const supabase = await createClient();

    const { error } = await supabase
        .from('bookings')
        .update({ 
            status: 'completed' 
        })
        .eq('booking_id', bookingId);

    if (error) return { success: false, error: error.message };
    revalidatePath('/admin');
    return { success: true };
}

// 8. UPDATE STATUS CHUNG (FIX LỖI TYPE Ở ĐÂY)
export async function updateBookingStatus(bookingId: number, status: string, totalActual?: number) {
  const supabase = await createClient();
  
  const payload: { status: BookingStatus; total_actual?: number } = { 
    status: status as BookingStatus 
  };
  if (totalActual !== undefined) payload.total_actual = totalActual;
  
  // FIX: Ép kiểu payload 'as any' để Supabase client chấp nhận status mới
  const { error } = await supabase.from('bookings').update(payload).eq('booking_id', bookingId);
  
  if (error) return { success: false, error: error.message };
  revalidatePath('/admin');
  return { success: true };
}
```

## File: CHANGELOG.md
```markdown
# Changelog

Mọi thay đổi quan trọng của dự án sẽ được ghi lại tại đây.

## [1.0.0] - 2025-11-17

### 🎉 Initial Release
Phiên bản chính thức đầu tiên của Website Portfolio.

### ✨ Tính năng mới
- **Trang chủ:** Hoàn thiện Hero Section, Showcase, Portfolio Grid.
- **Trang Dịch vụ:** Bảng giá, Thiết bị, Quy định, và phần Hậu trường (BTS).
- **Trang Giới thiệu:** Câu chuyện thương hiệu và Cột mốc phát triển.
- **Trang Dự án:** - 3 chuyên mục: Thời trang, Thương mại, Cá nhân.
  - Trang chi tiết dự án với nội dung động (Article Body).
- **Hệ thống:**
  - Dark/Light Mode.
  - Responsive hoàn chỉnh (Mobile/Tablet/Desktop).
  - SEO Metadata động cho từng dự án.

### 🔧 Kỹ thuật
- Cấu hình `next.config.ts` cho GitHub Pages (basePath, output export).
- Thiết lập quy trình deploy tự động qua `npm run deploy`.
- Tối ưu hóa `sizes` cho hình ảnh Next.js.

### 🚧 Backlog (Dự kiến phát triển sau)
- Trang Magazine (Tạp chí).
```

## File: eslint.config.mjs
```javascript
import { dirname } from "path";
import { fileURLToPath } from "url";
import { FlatCompat } from "@eslint/eslintrc";

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

const compat = new FlatCompat({
  baseDirectory: __dirname,
});

const eslintConfig = [
  ...compat.extends("next/core-web-vitals", "next/typescript"),
  {
    ignores: [
      "node_modules/**",
      ".next/**",
      "out/**",
      "build/**",
      "next-env.d.ts",
    ],
  },
];

export default eslintConfig;
```

## File: lib/supabase.ts
```typescript
// src/lib/supabase.ts
import { createClient } from '@supabase/supabase-js';

// Lấy biến môi trường và kiểm tra xem có tồn tại không
const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;

if (!supabaseUrl || !supabaseKey) {
  throw new Error('Missing Supabase environment variables');
}

export const supabase = createClient(supabaseUrl, supabaseKey);
```

## File: LICENSE
```
MIT License

Copyright (c) 2025 Trần Hải Đăng

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.
```

## File: postcss.config.mjs
```javascript
const config = {
  plugins: ["@tailwindcss/postcss"],
};

export default config;
```

## File: public/.nojekyll
```

```

## File: public/file.svg
```xml
<svg fill="none" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path d="M14.5 13.5V5.41a1 1 0 0 0-.3-.7L9.8.29A1 1 0 0 0 9.08 0H1.5v13.5A2.5 2.5 0 0 0 4 16h8a2.5 2.5 0 0 0 2.5-2.5m-1.5 0v-7H8v-5H3v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1M9.5 5V2.12L12.38 5zM5.13 5h-.62v1.25h2.12V5zm-.62 3h7.12v1.25H4.5zm.62 3h-.62v1.25h7.12V11z" clip-rule="evenodd" fill="#666" fill-rule="evenodd"/></svg>
```

## File: public/globe.svg
```xml
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><g clip-path="url(#a)"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.27 14.1a6.5 6.5 0 0 0 3.67-3.45q-1.24.21-2.7.34-.31 1.83-.97 3.1M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16m.48-1.52a7 7 0 0 1-.96 0H7.5a4 4 0 0 1-.84-1.32q-.38-.89-.63-2.08a40 40 0 0 0 3.92 0q-.25 1.2-.63 2.08a4 4 0 0 1-.84 1.31zm2.94-4.76q1.66-.15 2.95-.43a7 7 0 0 0 0-2.58q-1.3-.27-2.95-.43a18 18 0 0 1 0 3.44m-1.27-3.54a17 17 0 0 1 0 3.64 39 39 0 0 1-4.3 0 17 17 0 0 1 0-3.64 39 39 0 0 1 4.3 0m1.1-1.17q1.45.13 2.69.34a6.5 6.5 0 0 0-3.67-3.44q.65 1.26.98 3.1M8.48 1.5l.01.02q.41.37.84 1.31.38.89.63 2.08a40 40 0 0 0-3.92 0q.25-1.2.63-2.08a4 4 0 0 1 .85-1.32 7 7 0 0 1 .96 0m-2.75.4a6.5 6.5 0 0 0-3.67 3.44 29 29 0 0 1 2.7-.34q.31-1.83.97-3.1M4.58 6.28q-1.66.16-2.95.43a7 7 0 0 0 0 2.58q1.3.27 2.95.43a18 18 0 0 1 0-3.44m.17 4.71q-1.45-.12-2.69-.34a6.5 6.5 0 0 0 3.67 3.44q-.65-1.27-.98-3.1" fill="#666"/></g><defs><clipPath id="a"><path fill="#fff" d="M0 0h16v16H0z"/></clipPath></defs></svg>
```

## File: public/next.svg
```xml
<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 394 80"><path fill="#000" d="M262 0h68.5v12.7h-27.2v66.6h-13.6V12.7H262V0ZM149 0v12.7H94v20.4h44.3v12.6H94v21h55v12.6H80.5V0h68.7zm34.3 0h-17.8l63.8 79.4h17.9l-32-39.7 32-39.6h-17.9l-23 28.6-23-28.6zm18.3 56.7-9-11-27.1 33.7h17.8l18.3-22.7z"/><path fill="#000" d="M81 79.3 17 0H0v79.3h13.6V17l50.2 62.3H81Zm252.6-.4c-1 0-1.8-.4-2.5-1s-1.1-1.6-1.1-2.6.3-1.8 1-2.5 1.6-1 2.6-1 1.8.3 2.5 1a3.4 3.4 0 0 1 .6 4.3 3.7 3.7 0 0 1-3 1.8zm23.2-33.5h6v23.3c0 2.1-.4 4-1.3 5.5a9.1 9.1 0 0 1-3.8 3.5c-1.6.8-3.5 1.3-5.7 1.3-2 0-3.7-.4-5.3-1s-2.8-1.8-3.7-3.2c-.9-1.3-1.4-3-1.4-5h6c.1.8.3 1.6.7 2.2s1 1.2 1.6 1.5c.7.4 1.5.5 2.4.5 1 0 1.8-.2 2.4-.6a4 4 0 0 0 1.6-1.8c.3-.8.5-1.8.5-3V45.5zm30.9 9.1a4.4 4.4 0 0 0-2-3.3 7.5 7.5 0 0 0-4.3-1.1c-1.3 0-2.4.2-3.3.5-.9.4-1.6 1-2 1.6a3.5 3.5 0 0 0-.3 4c.3.5.7.9 1.3 1.2l1.8 1 2 .5 3.2.8c1.3.3 2.5.7 3.7 1.2a13 13 0 0 1 3.2 1.8 8.1 8.1 0 0 1 3 6.5c0 2-.5 3.7-1.5 5.1a10 10 0 0 1-4.4 3.5c-1.8.8-4.1 1.2-6.8 1.2-2.6 0-4.9-.4-6.8-1.2-2-.8-3.4-2-4.5-3.5a10 10 0 0 1-1.7-5.6h6a5 5 0 0 0 3.5 4.6c1 .4 2.2.6 3.4.6 1.3 0 2.5-.2 3.5-.6 1-.4 1.8-1 2.4-1.7a4 4 0 0 0 .8-2.4c0-.9-.2-1.6-.7-2.2a11 11 0 0 0-2.1-1.4l-3.2-1-3.8-1c-2.8-.7-5-1.7-6.6-3.2a7.2 7.2 0 0 1-2.4-5.7 8 8 0 0 1 1.7-5 10 10 0 0 1 4.3-3.5c2-.8 4-1.2 6.4-1.2 2.3 0 4.4.4 6.2 1.2 1.8.8 3.2 2 4.3 3.4 1 1.4 1.5 3 1.5 5h-5.8z"/></svg>
```

## File: public/vercel.svg
```xml
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1155 1000"><path d="m577.3 0 577.4 1000H0z" fill="#fff"/></svg>
```

## File: public/window.svg
```xml
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path fill-rule="evenodd" clip-rule="evenodd" d="M1.5 2.5h13v10a1 1 0 0 1-1 1h-11a1 1 0 0 1-1-1zM0 1h16v11.5a2.5 2.5 0 0 1-2.5 2.5h-11A2.5 2.5 0 0 1 0 12.5zm3.75 4.5a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5M7 4.75a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0m1.75.75a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5" fill="#666"/></svg>
```

## File: src/app/admin/calendar/_components/CalendarSidebarWrapper.tsx
```typescript
'use client'
import CalendarSidebar from '@/components/admin/calendar/CalendarSidebar'

// Định nghĩa Type tối thiểu mà Sidebar cần
interface RoomBasic {
  room_id: number;
  name: string | null;
  code: string | null;
  // Cho phép nhận thêm các trường thừa khác (như branch_id...) mà không báo lỗi
  [key: string]: unknown; 
}

// Thay any[] bằng RoomBasic[]
export default function CalendarSidebarWrapper({ rooms }: { rooms: RoomBasic[] }) {
  return (
    <CalendarSidebar 
      // Ép kiểu rooms về dạng Sidebar cần (nếu CalendarSidebarProps bên trong chặt chẽ hơn)
      // Nhưng thường thì RoomBasic[] là đủ an toàn rồi.
      rooms={rooms.map(r => ({
          room_id: r.room_id,
          name: r.name || 'Không tên', // Xử lý null tại đây
          code: r.code || 'NO-CODE'
      }))} 
      onCreateClick={() => {
        const title = prompt("Tạo booking nhanh:");
        if(title) alert("Đã tạo: " + title);
      }} 
    />
  )
}
```

## File: src/app/admin/calendar/layout.tsx
```typescript
export default async function CalendarLayout({
  children,
}: {
  children: React.ReactNode
}) {
  // Lấy dữ liệu phòng từ Server để render Sidebar

  return (
    <div className="flex h-[calc(100vh-136px)] overflow-hidden bg-[var(--admin-bg)] ">
      <main className="flex-1 flex flex-col min-w-0 overflow-hidden m-4 
       shadow-sm">
        {children}
      </main>
    </div>
  )
}
```

## File: src/app/admin/calendar/page.tsx
```typescript
// src/app/admin/calendar/page.tsx
import { getBookingsForCalendar } from '@/lib/actions/bookings'
import { getRooms, getServices } from '@/lib/actions/studio'
import DashboardCalendar from '@/components/admin/DashboardCalendar'; 
import { getCurrentUserProfile } from '../../../lib/actions/users';
import { getCustomers } from '@/lib/actions/customers';
import { getCleanupMinutes } from '@/lib/actions/settings';

export default async function CalendarPage() {
  const today = new Date()
  const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1).toISOString()
  const endOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).toISOString()

  const bookings = await getBookingsForCalendar(startOfMonth, endOfMonth)
  const rooms = await getRooms()
  const services = await getServices()
  const customers = await getCustomers()
  const userProfile = await getCurrentUserProfile()
  const cleanupMinutes = await getCleanupMinutes();
  return (
    // h-full để tràn viền container cha
    <div className="h-full w-full bg-[var(--admin-card)] rounded-xl 
     shadow-sm overflow-hidden">
        {/* Truyền full data vào, không cần sidebar wrapper nữa */}
        <DashboardCalendar 
          rooms={rooms} 
          bookings={bookings} 
          services={services}
          customers={customers}
          currentUserId={Number(userProfile?.user_id || 0)} 
          cleanupMinutes={cleanupMinutes}
        />
    </div>
  )
}
```

## File: src/app/loading.tsx
```typescript
// src/app/loading.tsx
import { Loader2 } from "lucide-react";

export default function Loading() {
  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-[var(--background)]">
      <div className="flex flex-col items-center gap-4">
        <Loader2 className="h-10 w-10 animate-spin text-[var(--foreground)]" />
        <p className="text-sm text-[var(--sub-text)] font-medium tracking-widest uppercase animate-pulse">
          Loading Oni Studio...
        </p>
      </div>
    </div>
  );
}
```

## File: src/app/styles/BtsSection.module.css
```css
/* src/styles/BtsSection.module.css */

.btsSection {
  position: relative; /* Quan trọng để .stickyImageWrapper hoạt động */
  background-color: var(--background);
  color: var(--foreground);
}

/* --- 1. PHẦN ẢNH NỀN STICKY --- */

.stickyImageWrapper {
  position: sticky;
  top: 0;
  height: 100vh; /* Ảnh nền chiếm 100% chiều cao viewport */
  width: 100%;
  /* z-index: 0; (mặc định) */
}

.imageContainer {
  position: absolute;
  inset: 0;
  opacity: 0;
  transition: opacity 1s cubic-bezier(0.4, 0, 0.2, 1);
}

.imageActive {
  opacity: 1;
}

/* Lớp phủ mờ tối (gradient) để chữ dễ đọc hơn */
.imageOverlay {
  position: absolute;
  inset: 0;
  background: linear-gradient(
    to top,
    rgba(0, 0, 0, 1) 0%,
    rgba(0, 0, 0, 0.5) 40%,
    transparent 100%
  );
}


/* --- 2. PHẦN NỘI DUNG CUỘN (OVERLAY) --- */

/* Tiêu đề section (nằm ở trên cùng) */
.sectionHeader {
  /* Đặt tương đối để đè lên trên ảnh */
  position: relative; 
  z-index: 2;
  text-align: center;
  /* Đẩy tiêu đề xuống 1 chút */
  padding-top: 20vh;
  padding-bottom: 20vh;
  /* Chữ trắng cho dễ đọc */
  color: #ffffff;
  text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
}

.sectionTitle {
  font-size: 2.25rem; /* text-3xl */
  font-weight: 300; /* font-light */
}

.sectionSubtitle {
  font-size: 1.125rem; /* text-lg */
  opacity: 0.9;
  margin-top: 0.5rem;
}

@media (min-width: 768px) {
  .sectionTitle {
    font-size: 3rem; /* md:text-5xl */
  }
  .sectionSubtitle {
    font-size: 1.25rem; /* md:text-xl */
  }
}

/* Cột chứa các "cảnh" text */
.textColumn {
  position: relative;
  z-index: 2; /* Đảm bảo text cuộn TRÊN ảnh */
  width: 100%;
}

/* --- Nội dung từng "Cảnh" (Scene) --- */
.scene {
  /* Mỗi scene cao 100vh để khớp với 1 ảnh */
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  justify-content: center; /* Căn giữa nội dung theo chiều dọc */
  color: #ffffff; /* Chữ trắng */
  text-shadow: 0 2px 10px rgba(0, 0, 0, 0.7);
}

.sceneContent {
  /* Căn lề trái (hoặc giữa) cho nội dung text */
  text-align: left;
  max-width: 800px; /* Giới hạn chiều rộng khối text */
  padding: 1rem 1.5rem;

  opacity: 0.3; /* Mờ đi khi không active */
  transform: translateY(20px);
  transition: opacity 0.5s ease-out, transform 0.5s ease-out;
}

@media (min-width: 768px) {
  .sceneContent {
    /* Trên desktop, đẩy khối text sang bên trái */
    margin-left: 10%; 
  }
}

.sceneActive {
  opacity: 1;
  transform: translateY(0);
}

.sceneCategory {
  font-size: 0.875rem; /* text-sm */
  text-transform: uppercase;
  letter-spacing: 0.1em;
  opacity: 0.8;
}

.sceneTitle {
  font-size: 2.25rem; /* text-2xl */
  font-weight: 300; /* font-light */
  margin: 0.5rem 0 1rem 0;
}

@media (min-width: 768px) {
  .sceneTitle {
    font-size: 3rem; /* md:text-3xl */
  }
}

.sceneDescription {
  font-size: 1rem;
  line-height: 1.7;
  opacity: 0.9;
  margin-bottom: 1.5rem;
}

.sceneLink {
  color: #ffffff;
  font-weight: 500;
  display: inline-block;
  transition: transform 0.3s ease;
  border-bottom: 1px solid rgba(255, 255, 255, 0.5);
  padding-bottom: 2px;
}
.sceneLink:hover {
  transform: translateX(4px);
  border-bottom-color: #ffffff;
}
```

## File: src/app/styles/DichVu.module.css
```css
/* Bố cục 2 cột trên Desktop */
.stickyLayout {
  display: flex;
  flex-direction: row;
  gap: 4rem; /* Khoảng cách giữa 2 cột */
}

/* Cột 1: Menu */
.stickyNav {
  /* Cột menu chiếm 1/3 (khoảng 30%) */
  flex-basis: 33.33%; 
  max-width: 300px; /* Giới hạn chiều rộng tối đa */
  
  /* Phần quan trọng: Dính lại */
  position: sticky;
  
  /* Dính cách top (chừa chỗ cho Header của bạn) */
  top: 120px; 
  
  /* Tự căn chỉnh chiều cao */
  align-self: flex-start; 
}

.stickyNav ul {
  list-style: none;
  padding: 0;
  margin: 0;
  display: flex;
  flex-direction: column;
  gap: 1.25rem; /* Khoảng cách giữa các mục menu */
}

.stickyNav a {
  text-decoration: none;
  font-size: 1.1rem; /* 17.6px */
  font-weight: 500;
  color: var(--foreground);
  opacity: 0.6; /* Màu chữ mờ mặc định */
  transition: all 0.2s ease-in-out;
}

.stickyNav a:hover {
  opacity: 0.8; /* Sáng hơn khi hover */
}

/* Đây là class Active khi cuộn tới */
.stickyNav a.active {
  color: var(--foreground);
  opacity: 1; /* Rõ nét */
  font-weight: 700;
  border-left: 3px solid var(--foreground);
  padding-left: 10px;
}

/* Cột 2: Nội dung */
.contentColumn {
  /* Cột nội dung chiếm phần còn lại */
  flex: 1;
  min-width: 0; /* Sửa lỗi flexbox overflow */
}

/* Mỗi Section nội dung */
.sceneContent {
  /* Thêm khoảng cách lớn giữa các section */
  margin-bottom: 4rem; /* 64px */
  padding-bottom: 4rem; /* 64px */
  border-bottom: 1px solid var(--foreground);
}
.sceneContent:last-child {
  border-bottom: none;
  margin-bottom: 0;
  padding-bottom: 0;
}

/* Tiêu đề của mỗi Section */
.contentTitle {
  font-size: 2.25rem; /* 36px (to hơn, rõ ràng hơn) */
  font-weight: 600;
  margin-bottom: 2rem; /* 32px */
}

/* CSS cho ô màu phông nền */
.colorSwatch {
  width: 24px;
  height: 24px;
  border-radius: 50%;
  border: 1px solid var(--foreground);
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

/* --- Responsive cho Di Động (md: 768px) --- */
@media (max-width: 768px) {
  /* Xếp chồng 2 cột */
  .stickyLayout {
    flex-direction: column;
    gap: 2rem;
  }

  .stickyNav {
    position: relative;
    top: 0;
    flex-basis: auto;
    width: 100%;
    max-width: 100%;
    
    /* Chuyển thành hàng ngang cho gọn */
    border-bottom: 1px solid var(--foreground);
    padding-bottom: 1rem;
  }
  
  .stickyNav ul {
    flex-direction: row; /* Hàng ngang */
    gap: 1.5rem;
    overflow-x: auto; /* Cho phép cuộn ngang nếu không đủ chỗ */
  }

  /* Link trên di động */
  .stickyNav a {
    white-space: nowrap; /* Không cho chữ xuống hàng */
  }

  .stickyNav a.active {
    transform: none; /* Bỏ hiệu ứng translate */
    border-left: none;
    padding-left: 0;
  }

  .contentColumn {
    flex-basis: auto;
    width: 100%;
  }

  .contentTitle {
    font-size: 1.875rem; /* 30px trên mobile */
  }
}
```

## File: src/components/admin/calendar/BookingCalendar.tsx
```typescript
'use client'

import { 
  Calendar, 
  momentLocalizer, 
  Views, 
  View, 
  EventProps, 
  SlotInfo,
  EventPropGetter,
} from 'react-big-calendar'
import moment from 'moment'
import 'moment/locale/vi'
import 'react-big-calendar/lib/css/react-big-calendar.css'
import React, { useState, useMemo, useCallback } from 'react'
import CustomToolbar from './CustomToolbar'
import withDragAndDrop, { EventInteractionArgs } from 'react-big-calendar/lib/addons/dragAndDrop'
import 'react-big-calendar/lib/addons/dragAndDrop/styles.css'
import { ROOM_COLORS } from '@/lib/constants';

// Cấu hình Moment tiếng Việt
moment.locale('vi')
const localizer = momentLocalizer(moment)

// --- TYPE DEFINITIONS ---
interface BookingInfo {
  booking_id: number; // Đảm bảo field này tồn tại nếu bạn dùng nested
  status: string | null;
  customers: {
    full_name: string | null;
  } | null;
}

export interface BookingItem {
  booking_item_id: number;
  // QUAN TRỌNG: Thêm booking_id vào đây (FK từ bảng booking_items)
  booking_id: number; 
  start_dt: string;
  end_dt: string;
  room_id: number;
  bookings: BookingInfo | null;
}

export interface CalendarResource {
  id: number;
  title: string;
}

interface Room {
  room_id: number;
  name: string | null;
  code: string | null;
  status: 'available' | 'maintenance' | 'inactive';
  is_equipment_room?: boolean;
}

export interface CalendarEvent {
  id: string | number;
  title: string;       
  start: Date;
  end: Date;
  resourceId: number;  
  type: 'booking' | 'cleanup';
  status?: string;
  allDay?: boolean;
  resource?: { 
    bookingId?: number; 
  };
}

interface BookingCalendarProps {
  bookings: BookingItem[]; 
  rooms: Room[];
  date: Date;
  cleanupMinutes?: number;
  onNavigate: (newDate: Date) => void;
  onSelectSlot?: (info: { start: Date; end: Date; resourceId: number }) => void;
  // Prop quan trọng để nhận sự kiện click
  onSelectEvent?: (event: CalendarEvent) => void; 
  onEventDrop?: (args: EventInteractionArgs<CalendarEvent>) => void;
  onEventResize?: (args: EventInteractionArgs<CalendarEvent>) => void;
}

const DnDCalendar = withDragAndDrop<CalendarEvent, CalendarResource>(Calendar)

// --- CUSTOM EVENT COMPONENT ---
const CustomEvent = ({ event }: EventProps<CalendarEvent>) => {
  return (
    <div className="h-full w-full flex flex-col px-1.5 py-0.5 leading-snug overflow-hidden relative group">
      <div className="absolute left-0 top-0 bottom-0 w-[3px] bg-black/20"></div>
      
      {event.type === 'cleanup' ? (
        <div className="flex items-center gap-1 text-[10px] italic opacity-75">
          <span>🧹</span> <span>Dọn dẹp</span>
        </div>
      ) : (
        <>
          <div className="font-bold text-[11px] truncate mt-0.5">
            {event.title}
          </div>
          <div className="text-[10px] opacity-90 truncate flex items-center gap-1">
             <span className={`w-1.5 h-1.5 rounded-full ${event.status === 'confirmed' ? 'bg-white' : 'bg-white/50'}`}></span>
             <span className="capitalize">{event.status === 'confirmed' ? 'Đã cọc' : event.status}</span>
          </div>
        </>
      )}
    </div>
  )
}

export default function BookingCalendar({ 
  bookings,
  rooms,
  date, 
  cleanupMinutes = 60,
  onNavigate,
  onSelectSlot,
  onSelectEvent, // 1. Nhận prop này từ cha
  onEventDrop, 
  onEventResize 
}: BookingCalendarProps) {
  
  const [view, setView] = useState<View>(Views.DAY)

  // Mapping Events
  const events: CalendarEvent[] = useMemo(() => {
    const list: CalendarEvent[] = []
    bookings.forEach((b) => {
      // 2. SỬA LOGIC LẤY BOOKING ID
      // Lấy trực tiếp b.booking_id (FK) thay vì b.bookings?.booking_id (Nested) để chắc chắn có dữ liệu
      const bookingId = b.booking_id || b.bookings?.booking_id;

      list.push({
        id: b.booking_item_id,
        title: b.bookings?.customers?.full_name || 'Khách vãng lai', 
        start: new Date(b.start_dt),
        end: new Date(b.end_dt),
        resourceId: b.room_id, 
        type: 'booking',
        status: b.bookings?.status || 'unknown',
        allDay: false,
        // Lưu bookingId vào đây
        resource: { bookingId: bookingId } 
      })

      // Logic Cleanup
      const cleanupStart = new Date(b.end_dt);
      const cleanupEnd = moment(b.end_dt).add(cleanupMinutes, 'minutes').toDate();

      list.push({
        id: `cleanup-${b.booking_item_id}`,
        title: `Dọn dẹp (${cleanupMinutes}p)`,
        start: cleanupStart,
        end: cleanupEnd,
        resourceId: b.room_id,
        type: 'cleanup',
        allDay: false
      })
    })
    return list
  }, [bookings, cleanupMinutes])

  const resources: CalendarResource[] = useMemo(() => {
    return rooms
    .filter(r => r.status === 'available' && !r.is_equipment_room)
    .map(r => ({ id: r.room_id, title: r.name || `Room ${r.code}` }))
  }, [rooms])

  // Styling logic
  const eventStyleGetter: EventPropGetter<CalendarEvent> = useCallback((event) => {
    const resourceIndex = resources.findIndex(r => r.id === event.resourceId);
    let color = resourceIndex >= 0 ? ROOM_COLORS[resourceIndex % ROOM_COLORS.length] : '#6b7280';

    // Logic màu OT
    const now = new Date();
    if (event.status === 'checked_in' && now > event.end) {
        color = 'var(--admin-ot)'; 
    } else if (event.status === 'completed') {
        color = 'var(--status-completed)';
    }

    if (event.type === 'cleanup') {
      return {
        style: {
          backgroundColor: 'var(--admin-bg)',
          backgroundImage: 'repeating-linear-gradient(45deg, transparent, transparent 5px, rgba(0,0,0,0.05) 5px, rgba(0,0,0,0.05) 10px)',
          color: 'var(--admin-sub)',
          border: '1px dashed var(--admin-border)',
          fontSize: '10px',
          pointerEvents: 'none',
          cursor: 'default',
          borderRadius: '4px',
          zIndex: 1
        }
      }
    }

    return {
      style: {
        backgroundColor: color,
        border: 'none',
        color: '#fff',
        borderRadius: '4px',
        opacity: event.status === 'cancelled' ? 0.5 : 1, 
        boxShadow: '0 2px 4px rgba(0,0,0,0.1)',
        zIndex: 10,
        cursor: 'pointer' // Thêm cursor pointer để biết click được
      }
    }
  }, [resources])

  const handleSelectSlotInternal = useCallback((slotInfo: SlotInfo) => {
    if (!slotInfo.resourceId) return
    if (onSelectSlot) {
      onSelectSlot({
        start: slotInfo.start as Date,
        end: slotInfo.end as Date,
        resourceId: Number(slotInfo.resourceId)
      })
    }
  }, [onSelectSlot])

  return (
    <div className="h-full w-full bg-[var(--admin-card)] text-[var(--admin-fg)] font-sans">
      <DnDCalendar
        localizer={localizer}
        events={events}
        resources={view === Views.DAY ? resources : undefined} 
        resourceIdAccessor={(r: CalendarResource) => r.id}
        resourceTitleAccessor={(r: CalendarResource) => r.title}
        view={view}
        onView={setView}
        date={date}
        onNavigate={onNavigate}
        components={{
          toolbar: CustomToolbar,
          event: CustomEvent,
          resourceHeader: ({ label }) => (
             <div className="text-sm font-bold text-[var(--admin-fg)] py-1">{label}</div>
          )
        }}
        eventPropGetter={eventStyleGetter}
        selectable
        onSelectSlot={handleSelectSlotInternal}
        onSelectEvent={onSelectEvent} 
        draggableAccessor={() => true} 
        resizable 
        onEventDrop={onEventDrop}     
        onEventResize={onEventResize} 
        step={30} 
        timeslots={2} 
        min={new Date(0, 0, 0, 0, 0, 0)} 
        max={new Date(0, 0, 0, 23, 59, 59)} 
        views={[Views.DAY, Views.WEEK, Views.MONTH, Views.AGENDA]} 
        defaultView={Views.DAY} 
      />
    </div>
  )
}
```

## File: src/components/admin/calendar/BookingCreateModal.tsx
```typescript
'use client';

import React, { useState, useEffect, useMemo, useRef } from 'react';
import { X, User, Check, Plus, Trash2, Loader2, Calendar as CalendarIcon, ChevronDown, Search } from 'lucide-react';
import { toast } from 'sonner';
import { 
  format, addMinutes, startOfDay, startOfMonth, endOfMonth, 
  eachDayOfInterval, getDay, isSameDay, addMonths, subMonths 
} from 'date-fns';
import { vi } from 'date-fns/locale';
import { createBooking } from '@/lib/actions/bookings';
import { createCustomer } from '@/lib/actions/customers';
import { RoomWithBranch, ServiceItem } from '@/lib/actions/studio';
import { CustomerRow } from '@/lib/actions/customers';
import ModalPortal from '@/components/ui/ModalPortal';

// --- HELPER: Tạo danh sách khung giờ 15 phút ---
const generateTimeOptions = () => {
  const times = [];
  const start = startOfDay(new Date());
  for (let i = 0; i < 24 * 4; i++) {
    const t = addMinutes(start, i * 15);
    times.push(format(t, 'HH:mm'));
  }
  return times;
};
const formatCurrency = (val: number) => new Intl.NumberFormat('vi-VN').format(val);

const TIME_OPTIONS = generateTimeOptions();

// --- SUB-COMPONENT: DATE SELECTOR (MINI CALENDAR) ---
interface DateSelectorProps {
  value: Date;
  onChange: (date: Date) => void;
  align?: 'left' | 'right';
}

const DateSelector = ({ value, onChange, align = 'left' }: DateSelectorProps) => {
  const [isOpen, setIsOpen] = useState(false);
  // State viewDate để user lướt xem tháng khác mà không đổi ngày đã chọn
  const [viewDate, setViewDate] = useState(value);
  const containerRef = useRef<HTMLDivElement>(null);

  // Sync viewDate khi mở lại hoặc value đổi
  useEffect(() => {
    if (isOpen) setViewDate(value);
  }, [isOpen, value]);

  useEffect(() => {
    const handleClickOutside = (e: MouseEvent) => {
      if (containerRef.current && !containerRef.current.contains(e.target as Node)) {
        setIsOpen(false);
      }
    };
    if (isOpen) document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [isOpen]);

  // Logic tạo lịch
  const daysInMonth = useMemo(() => {
    return eachDayOfInterval({
      start: startOfMonth(viewDate),
      end: endOfMonth(viewDate),
    });
  }, [viewDate]);

  const startDay = getDay(startOfMonth(viewDate));
  // Điều chỉnh để Thứ 2 là đầu tuần (0: CN, 1: T2,... 6: T7) -> Muốn T2 index 0
  // getDay: 0(CN), 1(T2)... 
  // Map: T2(1)->0, T3(2)->1, ... CN(0)->6
  const paddingDaysCount = startDay === 0 ? 6 : startDay - 1;
  const paddingDays = Array(paddingDaysCount).fill(null);

  return (
    <div ref={containerRef} className="relative inline-block ml-2">
      <span 
        onClick={(e) => { e.stopPropagation(); setIsOpen(!isOpen); }}
        className={`text-xs font-medium cursor-pointer transition-all border-b border-transparent
          ${isOpen 
            ? 'text-[var(--admin-primary)] border-[var(--admin-primary)]' 
            : 'text-[var(--admin-sub)] hover:text-[var(--admin-fg)] hover:border-[var(--admin-sub)]'
          }
        `}
      >
        {format(value, 'dd/MM', { locale: vi })}
      </span>

      {isOpen && (
        <div onClick={(e) => e.stopPropagation()}
            className={`
                absolute top-full mt-2 p-3 bg-[var(--admin-card)] border border-[var(--admin-border)] 
                rounded-xl shadow-xl z-[60] w-64 animate-in fade-in zoom-in-95 duration-100
                ${align === 'right' ? 'right-0' : 'left-0'} /* Căn phải nếu align=right */
            `}>
           {/* Header: Tháng & Nav */}
           <div className="flex items-center justify-between mb-3">
              <button onClick={() => setViewDate(subMonths(viewDate, 1))} className="hover:bg-[var(--admin-hover)] p-1 rounded text-[var(--admin-sub)] text-xs">‹</button>
              <div className="text-[11px] font-bold text-[var(--admin-fg)] uppercase tracking-wider">
                  Tháng {format(viewDate, 'MM/yyyy')}
              </div>
              <button onClick={() => setViewDate(addMonths(viewDate, 1))} className="hover:bg-[var(--admin-hover)] p-1 rounded text-[var(--admin-sub)] text-xs">›</button>
          </div>
          
          {/* Thứ trong tuần */}
          <div className="grid grid-cols-7 text-center text-[9px] gap-y-2 text-[var(--admin-sub)] font-medium mb-1">
              <span>T2</span><span>T3</span><span>T4</span><span>T5</span><span>T6</span><span>T7</span><span className="text-red-400">CN</span>
          </div>

          {/* Lưới ngày */}
          <div className="grid grid-cols-7 text-center text-[10px] gap-1">
              {paddingDays.map((_, i) => <span key={`pad-${i}`} />)}
              {daysInMonth.map(d => {
                  const isSelected = isSameDay(d, value);
                  const isToday = isSameDay(d, new Date());
                  return (
                      <span 
                          key={d.toString()} 
                          onClick={() => { onChange(d); setIsOpen(false); }}
                          className={`
                              cursor-pointer h-7 w-7 flex items-center justify-center rounded-full transition-all
                              ${isSelected 
                                  ? 'bg-[var(--admin-primary)] text-white font-bold shadow-md' 
                                  : isToday 
                                      ? 'text-[var(--admin-primary)] font-bold border border-[var(--admin-primary)]'
                                      : 'text-[var(--admin-fg)] hover:bg-[var(--admin-hover)]'
                              }
                          `}
                      >
                          {format(d, 'd')}
                      </span>
                  )
              })}
          </div>
        </div>
      )}
    </div>
  );
};

// --- SUB-COMPONENT: TIME SELECTOR (Modified to include DateSelector) ---
interface TimeSelectorProps {
  label: string;
  timeValue: string;
  dateValue: Date;
  onTimeChange: (val: string) => void;
  onDateChange: (val: Date) => void;
  className?: string;
  align?: 'left' | 'right';
}

const TimeSelector = ({ 
    label, timeValue, dateValue, onTimeChange, onDateChange, className, 
    align = 'left' // Mặc định left
}: TimeSelectorProps) => {
  const [isOpen, setIsOpen] = useState(false);
  const containerRef = useRef<HTMLDivElement>(null);

  useEffect(() => {
    const handleClickOutside = (e: MouseEvent) => {
      if (containerRef.current && !containerRef.current.contains(e.target as Node)) {
        setIsOpen(false);
      }
    };
    if (isOpen) document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [isOpen]);

  return (
    <div className={`relative ${className}`}>
      <span className="text-[10px] font-bold text-[var(--admin-sub)] uppercase mb-1 block tracking-wider">
        {label}
      </span>
      <div 
        className="flex items-baseline gap-1 select-none"
      >
        {/* TIME TRIGGER */}
        <div 
            ref={containerRef}
            onClick={() => setIsOpen(!isOpen)}
            className="flex items-center gap-1 cursor-pointer group"
        >
            <span className={`text-2xl font-bold text-[var(--admin-fg)] border-b-2 border-transparent transition-all
            ${isOpen ? 'border-[var(--admin-primary)] text-[var(--admin-primary)]' : 'group-hover:border-[var(--admin-sub)]'}
            `}>
            {timeValue}
            </span>
            <ChevronDown size={14} className={`text-[var(--admin-sub)] transition-transform ${isOpen ? 'rotate-180' : ''}`} />
        </div>

        {/* DATE TRIGGER (Tách riêng để không bị lẫn sự kiện click) */}
        <DateSelector value={dateValue} onChange={onDateChange} align={align} />
      </div>

      {/* DROPDOWN CHỌN GIỜ */}
      {isOpen && (
        <div ref={containerRef} className={`absolute top-full mt-2 w-32 max-h-60 overflow-y-auto bg-[var(--admin-card)] border border-[var(--admin-border)] rounded-xl shadow-xl z-50 table-scrollbar animate-in fade-in zoom-in-95 duration-100
          ${align === 'right' ? 'right-0' : 'left-0'}
        `}>
          {TIME_OPTIONS.map((t) => (
            <div
              key={t}
              onClick={() => { onTimeChange(t); setIsOpen(false); }}
              className={`px-4 py-2 text-sm cursor-pointer transition-colors flex items-center justify-between
                ${t === timeValue ? 'bg-[var(--admin-primary)] text-white font-bold' : 'text-[var(--admin-fg)] hover:bg-[var(--admin-hover)]'}
              `}
            >
              {t}
              {t === timeValue && <Check size={14} />}
            </div>
          ))}
        </div>
      )}
    </div>
  );
};

// --- MAIN COMPONENT ---

interface BookingCreateModalProps {
  isOpen: boolean;
  onClose: () => void;
  initialData: {
    start: Date;
    end: Date;
    roomId: number;
  };
  rooms: RoomWithBranch[];
  services: ServiceItem[];
  customers: CustomerRow[];
  currentUserId: number;
}

export default function BookingCreateModal({
  isOpen,
  onClose,
  initialData,
  rooms,
  services,
  customers: initialCustomers,
  currentUserId
}: BookingCreateModalProps) {
  
  // --- STATES ---
  const [customers, setCustomers] = useState<CustomerRow[]>(initialCustomers);
  const [isSubmitting, setIsSubmitting] = useState(false);
  
  // Thời gian (Giờ:Phút)
  const [startTimeStr, setStartTimeStr] = useState('');
  const [endTimeStr, setEndTimeStr] = useState('');
  
  // Ngày đặt (Tách riêng để quản lý chọn ngày)
  const [bookingDate, setBookingDate] = useState<Date>(new Date());
  
  const [selectedRoomId, setSelectedRoomId] = useState(initialData.roomId);
  const [selectedCustomerId, setSelectedCustomerId] = useState<number | ''>('');
  const [note, setNote] = useState('');
  const [deposit, setDeposit] = useState<number>(0);
  const [selectedServices, setSelectedServices] = useState<{ id: number; quantity: number }[]>([]);

  // CUSTOMER SEARCH STATES
  const [isCreatingCustomer, setIsCreatingCustomer] = useState(false);
  const [customerSearch, setCustomerSearch] = useState(''); 
  const [isCustomerDropdownOpen, setIsCustomerDropdownOpen] = useState(false); 
  const customerInputRef = useRef<HTMLDivElement>(null);

  // New Customer Form States
  const [newCustomerName, setNewCustomerName] = useState('');
  const [newCustomerPhone, setNewCustomerPhone] = useState('');
  const [isCreatingCustLoading, setIsCreatingCustLoading] = useState(false);

  // --- 1. Tách các giá trị nguyên thủy (Primitives) để so sánh ổn định ---
  // .getTime() trả về số (number), React so sánh số theo giá trị chứ không theo địa chỉ bộ nhớ
  const initStartMillis = initialData.start.getTime();
  const initEndMillis = initialData.end.getTime();
  const initRoomId = initialData.roomId;

  // Sync Data khi mở Modal
  useEffect(() => {
    if (isOpen) {
      // --- 2. Dùng các biến nguyên thủy để set state ---
      // Tạo lại Date từ timestamp để đảm bảo an toàn
      const startDate = new Date(initStartMillis);
      const endDate = new Date(initEndMillis);

      setStartTimeStr(format(startDate, 'HH:mm'));
      setEndTimeStr(format(endDate, 'HH:mm'));
      setBookingDate(startDate); 
      
      setSelectedRoomId(initRoomId);
      
      // Reset form
      setSelectedCustomerId('');
      setNote('');
      setDeposit(0);
      setSelectedServices([]);
      
      // Reset Customer Search
      setIsCreatingCustomer(false);
      setCustomerSearch('');
      setIsCustomerDropdownOpen(false);
      setNewCustomerName('');
      setNewCustomerPhone('');
    }
  }, [
      // --- 3. Dependency Array chỉ chứa Primitive Values ---
      // ESLint sẽ hài lòng vì ta dùng chính xác các biến này bên trong
      isOpen, 
      initStartMillis, 
      initEndMillis, 
      initRoomId
  ]);

  useEffect(() => {
    setCustomers(initialCustomers);
  }, [initialCustomers]);

  useEffect(() => {
    const handleClickOutside = (e: MouseEvent) => {
      if (customerInputRef.current && !customerInputRef.current.contains(e.target as Node)) {
        setIsCustomerDropdownOpen(false);
      }
    };
    if (isCustomerDropdownOpen) {
      document.addEventListener('mousedown', handleClickOutside);
    }
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [isCustomerDropdownOpen]);

  // --- LOGIC SEARCH KHÁCH HÀNG ---
  const filteredCustomers = useMemo(() => {
    if (!customerSearch.trim()) return customers;
    const lowerTerm = customerSearch.toLowerCase();
    return customers.filter(c => 
      c.full_name.toLowerCase().includes(lowerTerm) || 
      (c.phone && c.phone.includes(lowerTerm))
    );
  }, [customers, customerSearch]);

  const handleSelectCustomer = (customer: CustomerRow) => {
    setSelectedCustomerId(customer.customer_id);
    setCustomerSearch(customer.full_name); 
    setIsCustomerDropdownOpen(false);
  };

  // --- LOGIC TÍNH TOÁN ---
  const durationHours = useMemo(() => {
    const [startH, startM] = startTimeStr.split(':').map(Number);
    const [endH, endM] = endTimeStr.split(':').map(Number);
    if (isNaN(startH) || isNaN(endH)) return 0;
    
    let duration = (endH + endM / 60) - (startH + startM / 60);
    if (duration < 0) duration += 24;
    return Math.max(0, duration);
  }, [startTimeStr, endTimeStr]);

  const roomPricePerHour = 500000;
  const roomTotal = durationHours * roomPricePerHour;

  const servicesTotal = selectedServices.reduce((acc, item) => {
    const service = services.find(s => s.service_id === item.id);
    return acc + (service ? service.price * item.quantity : 0);
  }, 0);

  const grandTotal = roomTotal + servicesTotal;

  // --- HANDLERS ---

  const handleCreateCustomer = async () => {
    if (!newCustomerName.trim() || !newCustomerPhone.trim()) {
      toast.error('Vui lòng nhập tên và số điện thoại');
      return;
    }
    setIsCreatingCustLoading(true);
    
    const formData = new FormData();
    formData.append('full_name', newCustomerName);
    formData.append('phone', newCustomerPhone);
    formData.append('customer_type', 'regular');

    const res = await createCustomer(formData);
    
    setIsCreatingCustLoading(false);

    if (res.success && res.data) {
      toast.success('Đã thêm khách hàng mới!');
      const newCust = res.data as CustomerRow;
      setCustomers([newCust, ...customers]);
      
      setSelectedCustomerId(newCust.customer_id);
      setCustomerSearch(newCust.full_name);
      
      setIsCreatingCustomer(false); 
    } else {
      toast.error(res.error || 'Lỗi tạo khách hàng');
    }
  };

  const handleAddService = (serviceId: string) => {
    const id = Number(serviceId);
    if (!id) return;
    
    const existing = selectedServices.find(s => s.id === id);
    if (existing) {
      setSelectedServices(prev => prev.map(s => s.id === id ? { ...s, quantity: s.quantity + 1 } : s));
    } else {
      setSelectedServices(prev => [...prev, { id, quantity: 1 }]);
    }
  };

  const handleSubmit = async () => {
    if (!selectedCustomerId) {
      toast.error('Chưa chọn khách hàng');
      return;
    }

    // TỔNG HỢP NGÀY VÀ GIỜ
    const baseDate = format(bookingDate, 'yyyy-MM-dd'); // Sử dụng ngày đã chọn
    const startISO = `${baseDate}T${startTimeStr}:00`;
    const endISO = `${baseDate}T${endTimeStr}:00`;

    if (new Date(startISO) >= new Date(endISO)) {
        toast.error('Giờ kết thúc phải sau giờ bắt đầu');
        return;
    }

    setIsSubmitting(true);

    try {
      const payload = {
        customerId: Number(selectedCustomerId),
        staffId: currentUserId,
        deposit: deposit,
        discount: 0,
        notes: note,
        items: [{
          roomId: selectedRoomId,
          startDt: new Date(startISO).toISOString(),
          endDt: new Date(endISO).toISOString(),
          price: roomTotal
        }],
        services: selectedServices.map(s => {
          const sv = services.find(x => x.service_id === s.id)!;
          return {
            serviceId: s.id,
            quantity: s.quantity,
            price: sv.price,
            type: sv.type
          };
        })
      };

      const result = await createBooking(payload);

      if (result.success) {
        toast.success('Đặt lịch thành công!');
        onClose();
        window.location.reload(); 
      } else {
        toast.error(result.error);
      }
    } catch (error) {
      const msg = (error as Error).message || 'Lỗi kết nối hệ thống';
      toast.error(msg);
    } finally {
      setIsSubmitting(false);
    }
  };

  return (
    <ModalPortal isOpen={isOpen} onClose={onClose} title="Tạo Lịch Mới" className="max-w-3xl">
      <div className="flex flex-col md:flex-row h-[80vh] md:h-auto">
        
        {/* --- LEFT COLUMN: INPUT FORM --- */}
        <div className="flex-1 p-6 space-y-6 overflow-y-auto table-scrollbar">
          
          {/* 1. KHU VỰC CHỌN GIỜ & NGÀY */}
          <div className="bg-[var(--admin-bg)] p-5 rounded-2xl border border-[var(--admin-border)] flex items-center justify-between gap-4">
             {/* Chọn Bắt đầu (Bao gồm cả Giờ và Ngày) */}
             <TimeSelector 
                label="Bắt đầu" 
                timeValue={startTimeStr} 
                dateValue={bookingDate} 
                onTimeChange={setStartTimeStr}
                onDateChange={setBookingDate} // Cập nhật ngày chung
             />
             
             <div className="h-8 w-[1px] bg-[var(--admin-border)]"></div>
             
             {/* Chọn Kết thúc (Dùng chung ngày với bắt đầu cho đơn giản hóa UI) */}
             <TimeSelector 
                label="Kết thúc" 
                timeValue={endTimeStr} 
                dateValue={bookingDate} 
                onTimeChange={setEndTimeStr}
                onDateChange={setBookingDate}
                className="text-right flex flex-col items-end"
                align="right"
             />
          </div>

          {/* ... PHẦN CÒN LẠI GIỮ NGUYÊN ... */}
          
          {/* 2. CHỌN PHÒNG */}
          <div>
             <label className="text-xs font-bold text-[var(--admin-sub)] uppercase mb-2 block">Phòng Studio</label>
             <div className="relative">
                <select
                    className="w-full p-3 pl-10 bg-[var(--admin-card)] border border-[var(--admin-border)] rounded-xl appearance-none outline-none focus:border-[var(--admin-primary)] focus:ring-1 focus:ring-[var(--admin-primary)] transition-all cursor-pointer text-[var(--admin-fg)] font-medium"
                    value={selectedRoomId}
                    onChange={(e) => setSelectedRoomId(Number(e.target.value))}
                >
                    {rooms.filter(r => r.status === 'available'
                      && !(r.is_equipment_room === true)
                    ).map(r => (
                        <option key={r.room_id} value={r.room_id}>{r.name || r.code}</option>
                    ))}
                </select>
                <div className="absolute left-3 top-3.5 text-[var(--admin-sub)]">
                    <CalendarIcon size={18} />
                </div>
                <div className="absolute right-3 top-3.5 pointer-events-none text-[var(--admin-sub)]">
                    <ChevronDown size={16} />
                </div>
             </div>
          </div>

          {/* 3. KHÁCH HÀNG */}
          <div className="space-y-2" ref={customerInputRef}>
             <div className="flex justify-between items-center mb-1">
                <label className="text-xs font-bold text-[var(--admin-sub)] uppercase">Khách Hàng</label>
                {!isCreatingCustomer && (
                    <button 
                        onClick={() => setIsCreatingCustomer(true)}
                        className="text-[10px] bg-[var(--admin-primary)]/10 text-[var(--admin-primary)] px-2 py-1 rounded-md font-bold hover:bg-[var(--admin-primary)] hover:text-white transition-colors flex items-center gap-1"
                    >
                        <Plus size={12} /> TẠO MỚI
                    </button>
                )}
             </div>

             {isCreatingCustomer ? (
                // FORM TẠO KHÁCH INLINE
                <div className="bg-[var(--admin-bg)] p-4 rounded-xl border border-[var(--admin-border)] space-y-3 animate-fade-in-up">
                    <div className="flex items-center justify-between mb-2">
                        <span className="text-sm font-bold text-[var(--admin-fg)]">Thông tin khách mới</span>
                        <button onClick={() => setIsCreatingCustomer(false)} className="text-[var(--admin-sub)] hover:text-[var(--admin-fg)]"><X size={16}/></button>
                    </div>
                    <input 
                        className="w-full p-2.5 rounded-lg border border-[var(--admin-border)] bg-[var(--admin-card)] text-sm focus:border-[var(--admin-primary)] outline-none"
                        placeholder="Họ và tên *"
                        value={newCustomerName}
                        onChange={e => setNewCustomerName(e.target.value)}
                    />
                    <input 
                        className="w-full p-2.5 rounded-lg border border-[var(--admin-border)] bg-[var(--admin-card)] text-sm focus:border-[var(--admin-primary)] outline-none"
                        placeholder="Số điện thoại *"
                        value={newCustomerPhone}
                        onChange={e => setNewCustomerPhone(e.target.value)}
                    />
                    <button 
                        onClick={handleCreateCustomer}
                        disabled={isCreatingCustLoading}
                        className="w-full py-2 bg-[var(--admin-fg)] text-[var(--admin-bg)] rounded-lg text-sm font-bold hover:opacity-90 flex justify-center items-center gap-2"
                    >
                        {isCreatingCustLoading ? <Loader2 className="animate-spin" size={14}/> : <Check size={14}/>} Lưu khách hàng
                    </button>
                </div>
             ) : (
                // SEARCHABLE INPUT
                <div className="relative">
                    <div className="relative">
                        <User size={18} className="absolute left-3 top-3.5 text-[var(--admin-sub)]" />
                        <input
                            type="text"
                            placeholder="Tìm tên hoặc SĐT khách..."
                            className="w-full p-3 pl-10 pr-10 bg-[var(--admin-card)] border border-[var(--admin-border)] rounded-xl outline-none focus:border-[var(--admin-primary)] focus:ring-1 focus:ring-[var(--admin-primary)] transition-all text-[var(--admin-fg)]"
                            value={customerSearch}
                            onChange={(e) => {
                                setCustomerSearch(e.target.value);
                                setIsCustomerDropdownOpen(true);
                                if (e.target.value === '') setSelectedCustomerId('');
                            }}
                            onFocus={() => setIsCustomerDropdownOpen(true)}
                        />
                        {customerSearch && (
                            <button 
                                onClick={() => { setCustomerSearch(''); setSelectedCustomerId(''); }}
                                className="absolute right-3 top-3.5 text-[var(--admin-sub)] hover:text-[var(--admin-fg)]"
                            >
                                <X size={16} />
                            </button>
                        )}
                        {!customerSearch && <Search size={16} className="absolute right-3 top-3.5 text-[var(--admin-sub)]" />}
                    </div>

                    {/* DROPDOWN RESULTS */}
                    {isCustomerDropdownOpen && (
                        <div className="absolute top-full left-0 right-0 mt-1 max-h-48 overflow-y-auto bg-[var(--admin-card)] border border-[var(--admin-border)] rounded-xl shadow-lg z-50 table-scrollbar animate-in fade-in zoom-in-95 duration-100">
                            {filteredCustomers.length === 0 ? (
                                <div className="p-3 text-center text-sm text-[var(--admin-sub)] italic">
                                    Không tìm thấy khách hàng.
                                </div>
                            ) : (
                                filteredCustomers.map(c => (
                                    <div
                                        key={c.customer_id}
                                        onClick={() => handleSelectCustomer(c)}
                                        className="px-4 py-3 hover:bg-[var(--admin-hover)] cursor-pointer border-b border-[var(--admin-border)] last:border-0"
                                    >
                                        <div className="text-sm font-bold text-[var(--admin-fg)]">{c.full_name}</div>
                                        <div className="text-xs text-[var(--admin-sub)]">{c.phone || 'Không có SĐT'}</div>
                                    </div>
                                ))
                            )}
                        </div>
                    )}
                </div>
             )}
          </div>

          {/* 4. DỊCH VỤ THÊM */}
          <div>
             <label className="text-xs font-bold text-[var(--admin-sub)] uppercase mb-2 block">Dịch vụ đi kèm</label>
             <div className="relative">
                <select
                    className="w-full p-3 pl-10 bg-[var(--admin-card)] border border-[var(--admin-border)] rounded-xl appearance-none outline-none focus:border-[var(--admin-primary)] transition-all cursor-pointer text-[var(--admin-fg)] text-sm"
                    onChange={(e) => {
                        handleAddService(e.target.value);
                        e.target.value = ''; 
                    }}
                >
                    <option value="">+ Thêm dịch vụ...</option>
                    {services.map(s => (
                        <option key={s.service_id} value={s.service_id}>
                            {s.name} (+{new Intl.NumberFormat('vi-VN').format(s.price)}đ)
                        </option>
                    ))}
                </select>
                <Plus size={18} className="absolute left-3 top-3.5 text-[var(--admin-sub)]" />
             </div>

             {/* List dịch vụ đã chọn */}
             {selectedServices.length > 0 && (
                 <div className="mt-3 space-y-2">
                    {selectedServices.map(item => {
                        const sInfo = services.find(s => s.service_id === item.id);
                        return (
                            <div key={item.id} className="flex justify-between items-center bg-[var(--admin-bg)] p-2 rounded-lg border border-[var(--admin-border)] animate-fade-in-row">
                                <span className="text-sm font-medium text-[var(--admin-fg)]">{sInfo?.name}</span>
                                <div className="flex items-center gap-3">
                                    <span className="text-xs text-[var(--admin-sub)]">x{item.quantity}</span>
                                    <button 
                                        onClick={() => setSelectedServices(prev => prev.filter(x => x.id !== item.id))}
                                        className="text-[var(--admin-sub)] hover:text-red-500 transition-colors"
                                    >
                                        <Trash2 size={14}/>
                                    </button>
                                </div>
                            </div>
                        )
                    })}
                 </div>
             )}
          </div>

          <div className="grid grid-cols-2 gap-4">
             {/* Tiền cọc */}
             <div>
                <label className="text-xs font-bold text-[var(--admin-sub)] uppercase mb-2 block">
                  Tiền cọc (VNĐ)
                </label>
                <div className="relative">
                  <input 
                    type="text" // Dùng text để format
                    className="w-full p-3 rounded-xl bg-[var(--admin-card)] border border-[var(--admin-border)] focus:border-[var(--admin-primary)] outline-none font-mono text-sm font-bold"
                    placeholder="0"
                    // Hiển thị dạng 300.000
                    value={deposit > 0 ? formatCurrency(deposit) : ''} 
                    onChange={e => {
                        // Chỉ giữ lại số
                        const rawValue = e.target.value.replace(/[^0-9]/g, '');
                        setDeposit(Number(rawValue));
                    }}
                  />
                </div>
                {deposit > 0 && (
                  <div className="text-right mt-1">
                     <span className="text-[10px] text-[var(--admin-sub)] italic">
                        {deposit.toLocaleString('vi-VN')} đ
                     </span>
                  </div>
                )}
             </div>
             {/* Ghi chú */}
             <div>
                <label className="text-xs font-bold text-[var(--admin-sub)] uppercase mb-2 block">Ghi chú</label>
                <input 
                    className="w-full p-3 rounded-xl bg-[var(--admin-card)] border border-[var(--admin-border)] focus:border-[var(--admin-primary)] outline-none text-sm"
                    placeholder="..."
                    value={note}
                    onChange={e => setNote(e.target.value)}
                />
             </div>
          </div>

        </div>

        {/* --- RIGHT COLUMN: SUMMARY & ACTIONS --- */}
        <div className="w-full md:w-80 bg-[var(--admin-bg)] border-t md:border-t-0 md:border-l border-[var(--admin-border)] p-6 flex flex-col justify-between">
            <div className="space-y-6">
                <h3 className="text-sm font-bold text-[var(--admin-sub)] uppercase tracking-wider">Chi tiết thanh toán</h3>
                
                <div className="space-y-3">
                    <div className="flex justify-between text-sm">
                        <span className="text-[var(--admin-sub)]">Tiền phòng ({durationHours.toFixed(1)}h)</span>
                        <span className="font-medium text-[var(--admin-fg)]">{new Intl.NumberFormat('vi-VN').format(roomTotal)} VNĐ</span>
                    </div>
                    <div className="flex justify-between text-sm">
                        <span className="text-[var(--admin-sub)]">Dịch vụ</span>
                        <span className="font-medium text-[var(--admin-fg)]">{new Intl.NumberFormat('vi-VN').format(servicesTotal)} VNĐ</span>
                    </div>
                    <div className="border-t border-[var(--admin-border)] my-2"></div>
                    <div className="flex justify-between text-base font-bold">
                        <span className="text-[var(--admin-fg)]">TỔNG CỘNG</span>
                        <span className="text-[var(--admin-primary)] text-lg">{new Intl.NumberFormat('vi-VN').format(grandTotal)} VNĐ</span>
                    </div>
                    {deposit > 0 && (
                        <div className="flex justify-between text-sm text-green-600">
                            <span>Đã cọc</span>
                            <span>-{new Intl.NumberFormat('vi-VN').format(deposit)} VNĐ</span>
                        </div>
                    )}
                </div>
            </div>

            <div className="mt-8 space-y-3">
                <button 
                    onClick={handleSubmit}
                    disabled={isSubmitting}
                    className="w-full py-3.5 bg-[var(--admin-primary)] text-white rounded-xl font-bold hover:opacity-90 shadow-lg shadow-indigo-500/20 transition-all flex items-center justify-center gap-2 disabled:opacity-70"
                >
                    {isSubmitting ? <Loader2 className="animate-spin"/> : <Check size={18}/>}
                    Xác nhận Đặt Lịch
                </button>
                <button 
                    onClick={onClose}
                    className="w-full py-3 border border-[var(--admin-border)] text-[var(--admin-sub)] hover:text-[var(--admin-fg)] hover:bg-[var(--admin-hover)] rounded-xl font-medium transition-colors"
                >
                    Hủy bỏ
                </button>
            </div>
        </div>

      </div>
    </ModalPortal>
  );
}
```

## File: src/components/admin/calendar/CalendarSidebar.tsx
```typescript
'use client'


interface Room {
  room_id: number;
  name: string;
  code: string;
}

interface CalendarSidebarProps {
  rooms: Room[];
  onCreateClick: () => void;
}

export default function CalendarSidebar({ rooms, onCreateClick }: CalendarSidebarProps) {
  // Mockup Mini Calendar (Chỉ giao diện)
  const days = Array.from({ length: 35 }, (_, i) => i + 1)

  return (
    <aside className="w-[256px] flex-shrink-0 flex flex-col gap-6 pr-4 border-r border-[var(--admin-border)] bg-[var(--admin-bg)] h-full overflow-y-auto pt-4 pl-2">
      
      {/* 1. Nút TẠO (FAB Style) */}
      <div>
        <button 
          onClick={onCreateClick}
          className="flex items-center gap-3 bg-[var(--admin-card)] text-[var(--admin-fg)] px-5 py-3 rounded-full shadow-md hover:shadow-lg transition-all border border-[var(--admin-border)]"
        >
          <svg width="24" height="24" viewBox="0 0 24 24" className="fill-current text-[var(--admin-primary)]">
            <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
          </svg>
          <span className="font-medium">Tạo lịch hẹn</span>
        </button>
      </div>

      {/* 2. Mini Calendar (Mockup) */}
      <div className="px-2">
        <div className="flex justify-between mb-4 text-sm font-semibold text-[var(--admin-fg)]">
          <span>Tháng 12 2025</span>
          <div className="flex gap-2">
            <button className="hover:bg-[var(--admin-hover)] rounded-full p-1">‹</button>
            <button className="hover:bg-[var(--admin-hover)] rounded-full p-1">›</button>
          </div>
        </div>
        <div className="grid grid-cols-7 text-center text-xs gap-y-3 text-[var(--admin-sub)]">
          <span>T2</span><span>T3</span><span>T4</span><span>T5</span><span>T6</span><span>T7</span><span>CN</span>
          {days.map(d => (
            <span key={d} className={`
              cursor-pointer h-7 w-7 flex items-center justify-center rounded-full hover:bg-[var(--admin-hover)]
              ${d === 1 ? 'bg-[var(--admin-primary)] text-white' : ''}
            `}>
              {d > 31 ? d - 31 : d}
            </span>
          ))}
        </div>
      </div>

      {/* 3. Lịch của tôi (Filters) */}
      <div className="px-2">
        <h3 className="text-xs font-medium text-[var(--admin-sub)] uppercase mb-3 flex justify-between">
          Phòng Studio
          <button className="hover:bg-[var(--admin-hover)] p-1 rounded">
             ^
          </button>
        </h3>
        <ul className="space-y-2">
          {rooms.map(room => (
            <li key={room.room_id} className="flex items-center gap-2">
              <input 
                type="checkbox" 
                defaultChecked 
                className="w-4 h-4 rounded text-[var(--admin-primary)] focus:ring-0 cursor-pointer"
                style={{ accentColor: 'var(--admin-primary)' }}
              />
              <span className="text-sm text-[var(--admin-fg)] truncate">{room.name}</span>
            </li>
          ))}
          {/* Hardcode thêm mục Dọn dẹp */}
          <li className="flex items-center gap-2">
              <input 
                type="checkbox" 
                defaultChecked 
                className="w-4 h-4 rounded cursor-pointer"
                style={{ accentColor: '#7f8c8d' }}
              />
              <span className="text-sm text-[var(--admin-fg)]">🧹 Lịch Dọn dẹp</span>
            </li>
        </ul>
      </div>
    </aside>
  )
}
```

## File: src/components/admin/calendar/CustomToolbar.tsx
```typescript
'use client'

import { ToolbarProps, View, Views } from 'react-big-calendar'
import { ChevronLeft, ChevronRight, ChevronDown } from 'lucide-react'
import { CalendarEvent } from './BookingCalendar'
import { useState, useRef, useEffect } from 'react'
import moment from 'moment'

export default function CustomToolbar({ 
  label, 
  date,
  onNavigate, 
  onView, 
  view, 
}: ToolbarProps<CalendarEvent, object>) {

  const [isViewMenuOpen, setIsViewMenuOpen] = useState(false)
  const menuRef = useRef<HTMLDivElement>(null)

  // Đóng menu khi click ra ngoài
  useEffect(() => {
    function handleClickOutside(event: MouseEvent) {
      if (menuRef.current && !menuRef.current.contains(event.target as Node)) {
        setIsViewMenuOpen(false)
      }
    }
    document.addEventListener("mousedown", handleClickOutside)
    return () => document.removeEventListener("mousedown", handleClickOutside)
  }, [])

  const navigate = (action: 'PREV' | 'NEXT' | 'TODAY') => {
    onNavigate(action)
  }

  const handleViewChange = (v: View) => {
    onView(v)
    setIsViewMenuOpen(false)
  }

  // Label Mapping
  const viewLabels: Record<string, string> = {
    month: 'Tháng',
    week: 'Tuần',
    day: 'Ngày',
    agenda: 'Lịch biểu'
  }

  const getCustomLabel = () => {
    switch (view) {
      case 'day':
        // Format: 04 Tháng 12 2025
        return moment(date).format('DD [Tháng] MM, YYYY'); 
      case 'month':
        // Format: Tháng 12 2025
        return moment(date).format('[Tháng] MM, YYYY');
      case 'week':
        // View tuần thì dùng label mặc định của thư viện (xử lý khoảng ngày 01-07) sẽ tốt hơn
        return label; 
      default:
        return label;
    }
  }
  return (
    <div className="flex items-center justify-between px-4 py-3 
    border-b border-[var(--admin-border)] bg-[var(--admin-card)]">
      
      {/* LEFT: Logo/Title & Navigation */}
      <div className="flex items-center gap-6">
        {/* Nút Hôm nay */}
        <button
          onClick={() => navigate('TODAY')}
          className="px-4 py-2 text-sm font-medium 
          border border-[var(--admin-border)] rounded hover:bg-[var(--admin-hover)] 
          transition-colors text-[var(--admin-fg)] cursor-pointer"
        >
          Hôm nay
        </button>

        {/* Navigation Arrows */}
        <div className="flex items-center gap-1 text-[var(--admin-fg)]">
          <button 
            onClick={() => navigate('PREV')}
            className="p-2 rounded-full hover:bg-[var(--admin-hover)] transition-colors"
            title="Trước"
          >
            <ChevronLeft size={20} />
          </button>
          <button 
            onClick={() => navigate('NEXT')}
            className="p-2 rounded-full hover:bg-[var(--admin-hover)] transition-colors"
            title="Sau"
          >
            <ChevronRight size={20} />
          </button>
        </div>

        {/* Label (Tháng 12, 2025) */}
        <h2 className="text-xl font-normal text-[var(--admin-fg)] min-w-[150px]">
          {getCustomLabel()}
        </h2>
      </div>

      {/* RIGHT: View Switcher & Settings */}
      <div className="flex items-center gap-3">
        {/* Search & Settings Icons (Mockup UI) */}
        {/* <div className="flex items-center gap-2 text-[var(--admin-sub)] mr-2">
            <button className="p-2 hover:bg-[var(--admin-hover)] rounded-full"><span className="sr-only">Search</span>🔍</button>
            <button className="p-2 hover:bg-[var(--admin-hover)] rounded-full"><span className="sr-only">Settings</span>⚙️</button>
        </div> */}

        {/* View Dropdown */}
        <div className="relative" ref={menuRef}>
          <button 
            onClick={() => setIsViewMenuOpen(!isViewMenuOpen)}
            className="flex items-center gap-2 px-3 py-2 text-sm font-medium border border-[var(--admin-border)] rounded hover:bg-[var(--admin-hover)] transition-colors text-[var(--admin-fg)] bg-[var(--admin-card)] min-w-[100px] justify-between"
          >
            <span>{viewLabels[view] || view}</span>
            <ChevronDown size={14} className="opacity-70" />
          </button>

          {isViewMenuOpen && (
            <div className="absolute right-0 top-full mt-1 w-40 bg-[var(--admin-card)] border border-[var(--admin-border)] rounded shadow-lg z-50 py-1">
              {[Views.DAY, Views.WEEK, Views.MONTH, Views.AGENDA].map((v) => (
                <button
                  key={v}
                  onClick={() => handleViewChange(v)}
                  className={`w-full text-left px-4 py-2 text-sm hover:bg-[var(--admin-hover)] flex items-center justify-between
                    ${view === v ? 'bg-[var(--admin-primary)]/10 text-[var(--admin-primary)]' : 'text-[var(--admin-fg)]'}
                  `}
                >
                   {viewLabels[v]}
                   {view === v && <span>✓</span>}
                </button>
              ))}
            </div>
          )}
        </div>
      </div>
    </div>
  )
}
```

## File: src/components/admin/calendar/NavCalendarWidget.tsx
```typescript
'use client'

import { useState, useEffect, useMemo } from 'react'
import { useRouter, usePathname } from 'next/navigation';
import { CalendarIcon, ChevronDown, Check, Plus } from 'lucide-react';
import { format, startOfMonth, endOfMonth, eachDayOfInterval, getDay, isSameDay, addMonths, subMonths } from 'date-fns';
import { useCalendar } from '@/context/CalendarContext';
import { ROOM_COLORS } from '@/lib/constants'; //

interface Room {
  room_id: number;
  name: string | null;
  status?: 'available' | 'maintenance' | 'inactive';
  is_equipment_room?: boolean | null;
}

export default function NavCalendarWidget({ rooms }: { rooms: Room[] }) {
  const router = useRouter();
  const pathname = usePathname();
  const [isExpanded, setIsExpanded] = useState(true); 
  
  const { 
    date, 
    setDate, 
    setCreateModalOpen, 
    visibleRoomIds, 
    toggleRoomVisibility,
    setVisibleRoomIds
  } = useCalendar();


  const availableRooms = useMemo(() => {
    return rooms.filter(r => 
        r.status === 'available' && 
        !(r.is_equipment_room === true)
    );
  }, [rooms]);

  // Khởi tạo: Mặc định chọn tất cả phòng khi mới load
  useEffect(() => {
    if (availableRooms.length > 0 && visibleRoomIds.length === 0) {
        const allIds = availableRooms.map(r => r.room_id);
        setVisibleRoomIds(allIds);
    }
  }, [availableRooms, visibleRoomIds.length, setVisibleRoomIds]);

  // Logic chuyển trang
  const navigateToCalendar = () => {
    if (pathname !== '/admin/calendar') {
        router.push('/admin/calendar');
    }
  };

  // Logic Mini Calendar
  const currentMonthStart = startOfMonth(date);
  const currentMonthEnd = endOfMonth(date);
  const daysInMonth = eachDayOfInterval({ start: currentMonthStart, end: currentMonthEnd });
  const startDayOfWeek = getDay(currentMonthStart); 
  const paddingCount = startDayOfWeek === 0 ? 6 : startDayOfWeek - 1;
  const paddingDays = Array.from({ length: paddingCount });

  const handleDateClick = (d: Date) => {
    setDate(d);
    navigateToCalendar();
    if (!isExpanded) setIsExpanded(true);
  };

  const handleQuickCreate = (e: React.MouseEvent) => {
    e.stopPropagation();
    setCreateModalOpen(true);
    navigateToCalendar(); 
  };

  return (
    <div className="my-1">
      {/* Header Button */}
      <div className="flex items-stretch gap-[1px]"> 
        <button 
          onClick={() => { navigateToCalendar() }}
          className={`flex-1 flex items-center gap-3 px-4 py-2.5 text-sm font-medium rounded-l-lg cursor-pointer transition-all duration-200 
            ${pathname === '/admin/calendar' 
              ? 'bg-[var(--admin-bg)] text-[var(--admin-primary)] shadow-md shadow-gray-500/20' 
              : 'text-[var(--admin-sub)] hover:bg-[var(--admin-hover)] hover:text-[var(--admin-fg)]'
            }`}
        >
            <CalendarIcon size={20} />
            <span className="truncate ">Lịch Studio</span>
        </button>
        <button 
          onClick={(e) => { e.stopPropagation(); setIsExpanded(!isExpanded); }}
          className="w-8 flex items-center justify-center cursor-pointer rounded-r-lg transition-all duration-200 text-[var(--admin-sub)] hover:bg-[var(--admin-hover)]"
        >
           <ChevronDown size={14} className={`transition-transform duration-200 ${isExpanded ? 'rotate-180' : ''}`} />
        </button>
      </div>

      {/* Expandable Content */}
      <div className={`grid transition-all duration-300 ease-in-out overflow-hidden ${isExpanded ? 'grid-rows-[1fr] opacity-100 mt-3' : 'grid-rows-[0fr] opacity-0'}`}>
        <div className="min-h-0 space-y-4">
            
            {/* Nút Tạo Nhanh */}
            <button 
                onClick={handleQuickCreate}
                className="w-full flex items-center justify-center gap-2 bg-[var(--admin-card)] 
                border border-[var(--admin-primary)] text-[var(--admin-primary)] text-xs font-bold py-2 
                rounded-lg hover:bg-[var(--admin-primary)] hover:text-white transition-all cursor-pointer shadow-sm"
            >
                <Plus size={14} /> TẠO BOOKING
            </button>

            {/* Mini Calendar */}
            <div className="bg-[var(--admin-card)] p-3 rounded-lg border border-[var(--admin-border)] shadow-sm">
                <div className="flex items-center justify-between mb-3">
                    <button onClick={() => setDate(subMonths(date, 1))} className="hover:bg-[var(--admin-hover)] p-1 rounded text-[var(--admin-sub)] text-xs">‹</button>
                    <div className="text-[11px] font-bold text-[var(--admin-fg)] uppercase tracking-wider">
                        Tháng {format(date, 'MM/yyyy')}
                    </div>
                    <button onClick={() => setDate(addMonths(date, 1))} className="hover:bg-[var(--admin-hover)] p-1 rounded text-[var(--admin-sub)] text-xs">›</button>
                </div>
                
                <div className="grid grid-cols-7 text-center text-[9px] gap-y-2 text-[var(--admin-sub)] font-medium mb-1">
                    <span>T2</span><span>T3</span><span>T4</span><span>T5</span><span>T6</span><span>T7</span><span className="text-red-400">CN</span>
                </div>
                
                <div className="grid grid-cols-7 text-center text-[10px] gap-1">
                    {paddingDays.map((_, i) => <span key={`pad-${i}`} />)}
                    {daysInMonth.map(d => {
                        const isSelected = isSameDay(d, date);
                        return (
                            <span 
                                key={d.toString()} 
                                onClick={(e) => { e.stopPropagation(); handleDateClick(d); }}
                                className={`
                                    cursor-pointer h-6 w-6 flex items-center justify-center rounded-full transition-all
                                    ${isSelected 
                                        ? 'bg-[var(--admin-primary)] text-[var(--admin-primary-fg)] font-bold shadow-md' 
                                        : 'text-[var(--admin-fg)] hover:bg-[var(--admin-hover)]'
                                    }
                                `}
                            >
                                {format(d, 'd')}
                            </span>
                        )
                    })}
                </div>
            </div>

            {/* Bộ lọc phòng */}
            <div className="space-y-2">
                <div className="flex items-center justify-between px-1">
                     <p className="text-[10px] font-bold text-[var(--admin-sub)] uppercase">Hiển thị phòng:</p>
                     <button 
                        onClick={() => setVisibleRoomIds(availableRooms.map(r => r.room_id))}
                        className="text-[9px] text-[var(--admin-primary)] hover:underline cursor-pointer hover:text-[var(--admin-fg)]"
                     >
                        Tất cả
                     </button>
                </div>
                
                <div className="max-h-[200px] overflow-y-auto no-scrollbar space-y-1">
                    {availableRooms.length > 0 ? (
                        availableRooms.map((room, index) => {
                            const isChecked = visibleRoomIds.includes(room.room_id);
                            // Lấy màu dựa trên index của mảng đã lọc
                            const color = ROOM_COLORS[index % ROOM_COLORS.length]; 

                            return (
                                <div 
                                    key={room.room_id} 
                                    onClick={() => toggleRoomVisibility(room.room_id)}
                                    className="flex items-center gap-3 cursor-pointer group py-1.5 px-2 hover:bg-[var(--admin-hover)] rounded-md transition-colors"
                                >
                                    <div 
                                        className={`w-4 h-4 rounded border flex items-center justify-center transition-all ${isChecked ? 'border-transparent' : 'border-[var(--admin-sub)] bg-transparent'}`}
                                        style={{ backgroundColor: isChecked ? color : undefined }}
                                    >
                                        {isChecked && <Check size={10} className="text-white" />}
                                    </div>

                                    <span className={`text-xs truncate transition-opacity ${isChecked ? 'text-[var(--admin-fg)] font-medium' : 'text-[var(--admin-sub)] opacity-70'}`}>
                                        {room.name || `Phòng ${room.room_id}`}
                                    </span>
                                </div>
                            )
                        })
                    ) : (
                        <p className="text-xs text-[var(--admin-sub)] text-center py-2 italic">
                            Không có phòng trống
                        </p>
                    )}
                </div>
            </div>
        </div>
      </div>
    </div>
  )
}
```

## File: src/components/admin/CreateStaffModal.tsx
```typescript
// src/components/admin/CreateStaffModal.tsx
'use client';

import React, { useState } from 'react';
import { Loader2, Mail, User, Lock, Shield } from 'lucide-react';
import { toast } from 'sonner';
import { createStaffAccount } from '@/lib/actions';
// Import ModalPortal mới
import ModalPortal from '@/components/ui/ModalPortal';

interface CreateStaffModalProps {
  isOpen: boolean;
  onClose: () => void;
}

export default function CreateStaffModal({ isOpen, onClose }: CreateStaffModalProps) {
  const [isLoading, setIsLoading] = useState(false);
  const [formData, setFormData] = useState({
    fullName: '',
    email: '',
    password: '123@123',
    role: 'Staff'
  });

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setIsLoading(true);
    
    try {
      const res = await createStaffAccount(formData);
      if (res.success) {
        toast.success('Tạo tài khoản nhân viên thành công!');
        setFormData({ fullName: '', email: '', password: '', role: 'Staff' }); 
        onClose(); 
      } else {
        toast.error(`Lỗi: ${res.error}`);
      }
    } catch (error) {
        const message = error instanceof Error ? error.message : 'Có lỗi xảy ra.';
        toast.error(message);
    } finally {
      setIsLoading(false);
    }
  };

  // Dùng ModalPortal bao bọc Form
  return (
    <ModalPortal 
      isOpen={isOpen} 
      onClose={isLoading ? () => {} : onClose} 
      title="Thêm Nhân viên Mới"
      className="max-w-md" // Chỉnh độ rộng ở đây
    >
      <form onSubmit={handleSubmit} className="p-6 space-y-5">
          
          {/* Input Họ tên */}
          <div>
            <label className="block text-xs font-bold text-[var(--admin-sub)] uppercase mb-1.5">Họ và Tên</label>
            <div className="relative group">
                <User className="absolute left-3 top-2.5 text-[var(--admin-sub)] group-focus-within:text-[var(--admin-primary)] transition-colors" size={18} />
                <input required className="w-full pl-10 p-2.5 rounded-lg bg-[var(--admin-bg)] border border-[var(--admin-border)] text-[var(--admin-fg)] focus:ring-2 focus:ring-[var(--admin-primary)]/20 focus:border-[var(--admin-primary)] outline-none transition-all" 
                    value={formData.fullName} onChange={e => setFormData({...formData, fullName: e.target.value})} placeholder="VD: Nguyễn Văn A"
                />
            </div>
          </div>

          {/* Input Email */}
          <div>
            <label className="block text-xs font-bold text-[var(--admin-sub)] uppercase mb-1.5">Email Đăng nhập</label>
            <div className="relative group">
                <Mail className="absolute left-3 top-2.5 text-[var(--admin-sub)] group-focus-within:text-[var(--admin-primary)] transition-colors" size={18} />
                <input required type="email" className="w-full pl-10 p-2.5 rounded-lg bg-[var(--admin-bg)] border border-[var(--admin-border)] text-[var(--admin-fg)] focus:ring-2 focus:ring-[var(--admin-primary)]/20 focus:border-[var(--admin-primary)] outline-none transition-all" 
                    value={formData.email} onChange={e => setFormData({...formData, email: e.target.value})} placeholder="nhanvien@onistudio.com"
                />
            </div>
          </div>

          {/* Input Password */}
          <div>
            <label className="block text-xs font-bold text-[var(--admin-sub)] uppercase mb-1.5">Mật khẩu mặc định</label>
            <div className="relative group">
                <Lock className="absolute left-3 top-2.5 text-[var(--admin-sub)] group-focus-within:text-[var(--admin-primary)] transition-colors" size={18} />
                <input required type="text" className="w-full pl-10 p-2.5 rounded-lg bg-[var(--admin-bg)] border border-[var(--admin-border)] text-[var(--admin-fg)] focus:ring-2 focus:ring-[var(--admin-primary)]/20 focus:border-[var(--admin-primary)] outline-none font-mono transition-all" 
                    value={formData.password} onChange={e => setFormData({...formData, password: e.target.value})} placeholder="Tối thiểu 6 ký tự" minLength={6}
                />
            </div>
            <p className="text-[10px] text-[var(--admin-sub)] mt-1.5 ml-1">* Nhân viên có thể đổi mật khẩu sau.</p>
          </div>

          {/* Input Role */}
          <div>
            <label className="block text-xs font-bold text-[var(--admin-sub)] uppercase mb-1.5">Vai trò</label>
            <div className="relative group">
                <Shield className="absolute left-3 top-2.5 text-[var(--admin-sub)] group-focus-within:text-[var(--admin-primary)] transition-colors" size={18} />
                <select className="w-full pl-10 p-2.5 rounded-lg bg-[var(--admin-bg)] border border-[var(--admin-border)] text-[var(--admin-fg)] focus:ring-2 focus:ring-[var(--admin-primary)]/20 focus:border-[var(--admin-primary)] outline-none appearance-none cursor-pointer transition-all"
                    value={formData.role} onChange={e => setFormData({...formData, role: e.target.value})}
                >
                    <option value="Staff">Staff (Nhân viên)</option>
                    <option value="Admin">Admin (Quản trị viên)</option>
                </select>
            </div>
          </div>

          {/* Button Submit */}
          <div className="pt-4">
            <button type="submit" disabled={isLoading} className="w-full py-3 bg-[var(--admin-primary)] text-white rounded-lg font-bold hover:opacity-90 transition-all shadow-lg shadow-indigo-500/30 flex justify-center items-center gap-2 disabled:opacity-70 disabled:cursor-not-allowed">
                {isLoading ? <Loader2 className="animate-spin" size={20} /> : 'Tạo Tài Khoản'}
            </button>
          </div>

      </form>
    </ModalPortal>
  );
}
```

## File: src/components/admin/DashboardCalendar.tsx
```typescript
// src/components/admin/DashboardCalendar.tsx
'use client'

import { useEffect, useState, useCallback, useMemo } from 'react';
import { toast } from 'sonner';
import { RoomWithBranch, ServiceItem } from '@/lib/actions/studio';
import { CustomerRow } from '@/lib/actions/customers';
import { EventInteractionArgs } from 'react-big-calendar/lib/addons/dragAndDrop';
import { useCalendar } from '@/context/CalendarContext'; 
import moment from 'moment';
import BookingDetailModal from './calendar/BookingDetailModal';
import BookingCalendar, { BookingItem, CalendarEvent } from './calendar/BookingCalendar'; 
import BookingCreateModal from './calendar/BookingCreateModal';
import { updateBookingTime } from '@/lib/actions/bookings';
// KHÔNG import getCleanupMinutes ở đây vì là Client Component

interface DashboardCalendarProps {
  rooms: RoomWithBranch[];
  bookings: BookingItem[]; 
  services: ServiceItem[];
  customers: CustomerRow[];
  currentUserId: number;
  cleanupMinutes: number; 
}

export default function DashboardCalendar({
  rooms,
  bookings: initialBookings,
  services,
  customers,
  currentUserId,
  cleanupMinutes // 2. NHẬN PROP
}: DashboardCalendarProps) {
  

   const { 
      date, setDate, 
      visibleRoomIds, setVisibleRoomIds, 
      isCreateModalOpen, setCreateModalOpen
  } = useCalendar();

  const availableRooms = useMemo(() => {
    return rooms.filter(r => r.status === 'available' && !r.is_equipment_room);
  }, [rooms]);

  // --- SYNC VISIBLE ROOMS LẦN ĐẦU (Nếu Nav chưa chạy kịp) ---
  useEffect(() => {
      // Dùng logic set 1 lần (Bulk Set) thay vì forEach loop
      if (availableRooms.length > 0 && visibleRoomIds.length === 0) {
          const allIds = availableRooms.map(r => r.room_id);
          setVisibleRoomIds(allIds);
      }
  }, [availableRooms, visibleRoomIds.length, setVisibleRoomIds]);

  // 3. STATE LOCAL DATA
  const [localBookings, setLocalBookings] = useState<BookingItem[]>(initialBookings);
  useEffect(() => {
    setLocalBookings(initialBookings);
  }, [initialBookings]);

  // 4. LỌC DỮ LIỆU HIỂN THỊ
  // Lọc Booking: Chỉ hiện booking của các phòng được check
  const filteredBookings = localBookings.filter(b => visibleRoomIds.includes(b.room_id));
  
  // Lọc Cột Phòng: Chỉ hiện các cột được check (cho giao diện Day view đỡ rối)
  const filteredRooms = rooms.filter(r => visibleRoomIds.includes(r.room_id));

  // State local cho slot được chọn (để truyền vào Modal)
  const [selectedSlot, setSelectedSlot] = useState<{
    start: Date;
    end: Date;
    roomId: number;
  } | null>(null);

  // --- LOGIC EVENT HANDLERS (Drag, Drop, Resize) ---
  const handleEventChange = useCallback(async ({ event, start, end, resourceId }: EventInteractionArgs<CalendarEvent>) => {
      const bookingItemId = Number(event.id);
      if (isNaN(bookingItemId)) return;

      const newStartDate = new Date(start);
      const newEndDate = new Date(end);
      const newRoomId = resourceId ? Number(resourceId) : event.resourceId;

      // Optimistic Update
      setLocalBookings((prev) => prev.map((b) => {
        if (b.booking_item_id === bookingItemId) {
          return { ...b, start_dt: newStartDate.toISOString(), end_dt: newEndDate.toISOString(), room_id: newRoomId };
        }
        return b;
      }));

      try {
        const res = await updateBookingTime(bookingItemId, newStartDate.toISOString(), newEndDate.toISOString(), newRoomId);
        if (res.success) toast.success("Đã cập nhật lịch!");
        else {
            toast.error(res.error);
            setLocalBookings(initialBookings);
        }
      } catch (error) { 
          toast.error("Lỗi kết nối" + (error instanceof Error ? error.message : ""));
          setLocalBookings(initialBookings);
      }
  }, [initialBookings]); 

  // --- CLICK EMPTY SLOT ---
  const handleSlotSelect = ({ start, end, resourceId }: { start: Date; end: Date; resourceId: number }) => {
    setSelectedSlot({ start, end, roomId: resourceId });
    setCreateModalOpen(true); // Mở Modal thông qua Context
  };

  // --- MAPPING DATA CHO CALENDAR ---
  const calendarRooms = filteredRooms.map(r => ({
    room_id: r.room_id,
    name: r.name,
    code: r.code,
    status: r.status
  }));

  const defaultStartTime = useMemo(() => {
    const now = new Date();
    if (now.getMinutes() > 0) {
        now.setMinutes(now.getMinutes() + (15 - now.getMinutes() % 15)); // Làm tròn lên 15p
    }
    now.setSeconds(0);
    now.setMilliseconds(0);
    return now;
  }, []);
  // Initial Data cho Modal (Xử lý trường hợp mở từ nút "Tạo mới" ở Widget -> chưa có slot)
  const modalInitialData = useMemo(() => {
    if (selectedSlot) {
      return {
        start: selectedSlot.start,
        end: selectedSlot.end,
        roomId: selectedSlot.roomId
      };
    }
    // Nếu tạo mới thủ công: Dùng mốc thời gian cố định
    return {
      start: defaultStartTime, 
      end: moment(defaultStartTime).add(1, 'hours').toDate(),
      roomId: rooms[0]?.room_id || 0
    };
  }, [selectedSlot, rooms, defaultStartTime]);

  const [selectedBookingId, setSelectedBookingId] = useState<number | null>(null);
  const [isDetailOpen, setIsDetailOpen] = useState(false);

  // Handler khi click vào event
  const handleSelectEvent = (event: CalendarEvent) => {
      if (event.type === 'cleanup') return;
      
      // Lấy booking_id từ field resource ta đã thêm ở BookingCalendar
      const bId = event.resource?.bookingId;
      if (bId) {
          setSelectedBookingId(bId);
          setIsDetailOpen(true);
      }
  };

  return (
    <div className="h-full border border-[var(--admin-border)] rounded-2xl overflow-hidden shadow-sm bg-[var(--admin-card)] flex flex-col">
      <div className="px-6 py-4 border-b border-[var(--admin-border)] flex items-center justify-between">
         <h3 className="font-bold text-[var(--admin-fg)]">Lịch Đặt Phòng</h3>
      </div>

      <div className="flex-1 min-h-0">
        <BookingCalendar 
            bookings={filteredBookings} 
            rooms={calendarRooms} 
            date={date} 
            cleanupMinutes={cleanupMinutes} // 3. TRUYỀN XUỐNG
            onNavigate={setDate} 
            onSelectSlot={handleSlotSelect} 
            onEventDrop={(args) => handleEventChange(args)}   
            onEventResize={(args) => handleEventChange(args)}
            onSelectEvent={handleSelectEvent}
        />
      </div>
      <BookingDetailModal 
            isOpen={isDetailOpen}
            onClose={() => setIsDetailOpen(false)}
            bookingId={selectedBookingId}
            servicesList={services} // Truyền list dịch vụ để chọn OT/Phí
        />
      <BookingCreateModal
        isOpen={isCreateModalOpen}
        onClose={() => setCreateModalOpen(false)}
        initialData={modalInitialData}
        rooms={rooms}
        services={services}
        customers={customers}
        currentUserId={currentUserId}
      />
    </div>
  );
}
```

## File: src/components/admin/GrowthChart.tsx
```typescript
// src/components/admin/GrowthChart.tsx
'use client';

import { 
  AreaChart, 
  Area, 
  XAxis, 
  YAxis, 
  CartesianGrid, 
  Tooltip, 
  ResponsiveContainer 
} from 'recharts';
import { MonthlyStat } from '@/lib/actions';

export default function GrowthChart({ data }: { data: MonthlyStat[] }) {
  return (
    <div className="w-full h-[350px] mt-4">
      <ResponsiveContainer width="100%" height="100%">
        <AreaChart data={data} margin={{ top: 10, right: 30, left: 0, bottom: 0 }}>
          <defs>
            {/* Gradient màu tím đẹp mắt */}
            <linearGradient id="colorTotal" x1="0" y1="0" x2="0" y2="1">
              <stop offset="5%" stopColor="var(--admin-primary)" stopOpacity={0.3}/>
              <stop offset="95%" stopColor="var(--admin-primary)" stopOpacity={0}/>
            </linearGradient>
          </defs>
          
          <XAxis 
            dataKey="name" 
            stroke="var(--admin-sub)" 
            fontSize={12} 
            tickLine={false} 
            axisLine={false}
          />
          <YAxis 
            stroke="var(--admin-sub)" 
            fontSize={12} 
            tickLine={false} 
            axisLine={false} 
            allowDecimals={false} // Chỉ hiện số nguyên
          />
          
          <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="var(--admin-border)" />
          
          <Tooltip 
            contentStyle={{ 
              backgroundColor: 'var(--admin-card)', 
              borderColor: 'var(--admin-border)', 
              borderRadius: '8px',
              color: 'var(--admin-fg)'
            }}
            itemStyle={{ color: 'var(--admin-primary)' }}
          />
          
          <Area 
            type="monotone" 
            dataKey="total" 
            stroke="var(--admin-primary)" 
            fillOpacity={1} 
            fill="url(#colorTotal)" 
            strokeWidth={3}
          />
        </AreaChart>
      </ResponsiveContainer>
    </div>
  );
}
```

## File: src/components/admin/SortableProjectItem.tsx
```typescript
// src/components/admin/SortableProjectItem.tsx
'use client';

import { useSortable } from '@dnd-kit/sortable';
import { CSS } from '@dnd-kit/utilities';

interface SortableItemProps {
  id: number;
  children: React.ReactNode;
  colSpan: number; // Cần nhận vào để set style grid
  rowSpan: number;
}

export function SortableProjectItem({ id, children, colSpan, rowSpan }: SortableItemProps) {
  const {
    attributes,
    listeners,
    setNodeRef,
    transform,
    transition,
    isDragging
  } = useSortable({ id: id });

  const style = {
    transform: CSS.Transform.toString(transform),
    transition,
    gridColumn: `span ${colSpan}`,
    gridRow: `span ${rowSpan}`,
    zIndex: isDragging ? 50 : 'auto', // Khi kéo thì nổi lên trên
    opacity: isDragging ? 0.5 : 1,    // Khi kéo thì mờ đi chút
  };

  return (
    <div ref={setNodeRef} style={style} {...attributes} {...listeners} className="h-full relative group">
      {children}
    </div>
  );
}
```

## File: src/components/admin/TodaySchedule.tsx
```typescript
'use client';

import { format } from 'date-fns';
import { Calendar, MapPin, User, ArrowRight } from 'lucide-react';
import Link from 'next/link';

interface ScheduleItem {
  booking_item_id: number;
  start_dt: string;
  end_dt: string;
  rooms: { 
    name: string | null; 
    code: string | null; // <-- QUAN TRỌNG: Cho phép null
  } | null;
  bookings: {
    status: string | null;
    customers: { full_name: string | null; phone: string | null } | null;
  } | null;
}

export default function TodaySchedule({ bookings }: { bookings: ScheduleItem[] }) {
  if (bookings.length === 0) {
    return (
      <div className="h-full flex flex-col items-center justify-center text-[var(--admin-sub)] opacity-70 min-h-[300px]">
        <Calendar size={48} strokeWidth={1} className="mb-2" />
        <p>Hôm nay không có lịch chụp nào.</p>
        <Link 
            href="/admin/calendar" 
            className="mt-4 text-sm text-[var(--admin-primary)] hover:underline flex items-center gap-1"
        >
            Tạo booking ngay <ArrowRight size={14} />
        </Link>
      </div>
    );
  }

  return (
    <div className="space-y-4">
      {bookings.map((item) => {
        const startDate = new Date(item.start_dt);
        const endDate = new Date(item.end_dt);
        const status = item.bookings?.status || 'pending';
        
        // Màu sắc trạng thái
        let statusColor = 'bg-gray-100 text-gray-600';
        if (status === 'confirmed') statusColor = 'bg-blue-100 text-blue-600';
        if (status === 'completed') statusColor = 'bg-green-100 text-green-600';
        if (status === 'cancelled') statusColor = 'bg-red-100 text-red-600';

        return (
          <div key={item.booking_item_id} className="flex gap-4 p-3 rounded-xl border border-[var(--admin-border)] bg-[var(--admin-bg)] hover:border-[var(--admin-primary)] transition-colors group">
            
            {/* Cột giờ */}
            <div className="flex flex-col items-center justify-center w-16 p-2 bg-[var(--admin-card)] rounded-lg border border-[var(--admin-border)] shrink-0">
              <span className="text-lg font-bold text-[var(--admin-fg)] leading-none">
                {format(startDate, 'HH:mm')}
              </span>
              <span className="text-[10px] text-[var(--admin-sub)] mt-1">
                đến {format(endDate, 'HH:mm')}
              </span>
            </div>

            {/* Thông tin chính */}
            <div className="flex-1 min-w-0">
              <div className="flex justify-between items-start">
                <h4 className="font-bold text-[var(--admin-fg)] truncate">
                  {item.bookings?.customers?.full_name || 'Khách vãng lai'}
                </h4>
                <span className={`text-[10px] px-2 py-0.5 rounded-full font-bold uppercase tracking-wider ${statusColor}`}>
                  {status}
                </span>
              </div>
              
              <div className="mt-1 space-y-1">
                <div className="flex items-center gap-2 text-xs text-[var(--admin-sub)]">
                  <MapPin size={12} /> 
                  <span className="font-medium text-[var(--admin-fg)]">
                    {item.rooms?.name || item.rooms?.code || 'Chưa xếp phòng'}
                  </span>
                </div>
                {item.bookings?.customers?.phone && (
                    <div className="flex items-center gap-2 text-xs text-[var(--admin-sub)]">
                    <User size={12} /> {item.bookings.customers.phone}
                    </div>
                )}
              </div>
            </div>
          </div>
        );
      })}
      
      <div className="pt-2 text-center">
        <Link href="/admin/calendar" className="text-xs text-[var(--admin-sub)] hover:text-[var(--admin-primary)] hover:underline">
            Xem toàn bộ lịch trình &rarr;
        </Link>
      </div>
    </div>
  );
}
```

## File: src/components/progressive-carousel.tsx
```typescript
'use client';

import React, {
  createContext,
  useContext,
  useState,
  useEffect,
  useRef,
  ReactNode,
  FC,
  useCallback, // 1. SỬA LỖI: Import thêm useCallback
} from 'react';
import { motion, AnimatePresence } from 'framer-motion'; // 2. SỬA LỖI: Import đúng từ 'framer-motion'
import { cn } from '@/lib/utils'; // Giữ nguyên code cũ của bạn

// Define the type for the context value
interface ProgressSliderContextType {
  active: string;
  progress: number;
  handleButtonClick: (value: string) => void;
  vertical: boolean;
}

// ... (Các interface ProgressSliderProps, SliderContentProps... giữ nguyên) ...
interface ProgressSliderProps {
  children: ReactNode;
  duration?: number;
  fastDuration?: number;
  vertical?: boolean;
  activeSlider: string;
  className?: string;
}

interface SliderContentProps {
  children: ReactNode;
  className?: string;
}

interface SliderWrapperProps {
  children: ReactNode;
  value: string;
  className?: string;
}

interface ProgressBarProps {
  children: ReactNode;
  className?: string;
}

interface SliderBtnProps {
  children: ReactNode;
  value: string;
  className?: string;
  progressBarClass?: string;
}

// Create the context with an undefined initial value
const ProgressSliderContext = createContext<
  ProgressSliderContextType | undefined
>(undefined);

export const useProgressSliderContext = (): ProgressSliderContextType => {
  const context = useContext(ProgressSliderContext);
  if (!context) {
    throw new Error(
      'useProgressSliderContext must be used within a ProgressSlider'
    );
  }
  return context;
};

export const ProgressSlider: FC<ProgressSliderProps> = ({
  children,
  duration = 5000,
  fastDuration = 400,
  vertical = false,
  activeSlider,
  className,
}) => {
  const [active, setActive] = useState<string>(activeSlider);
  const [progress, setProgress] = useState<number>(0);
  const [isFastForward, setIsFastForward] = useState<boolean>(false);
  const frame = useRef<number>(0);
  const firstFrameTime = useRef<number>(performance.now());
  const targetValue = useRef<string | null>(null);
  const [sliderValues, setSliderValues] = useState<string[]>([]);

  useEffect(() => {
    // 3. SỬA LỖI 'unknown': Thêm type cụ thể
    const getChildren = React.Children.toArray(children).find(
      (child) => (child as React.ReactElement).type === SliderContent
    ) as React.ReactElement<SliderContentProps> | undefined; // Thêm type cho props

    if (getChildren) {
      const values = React.Children.toArray(getChildren.props.children).map(
        (child) =>
          (child as React.ReactElement<SliderWrapperProps>).props.value // Thêm type cho props
      );
      setSliderValues(values);
    }
  }, [children]);

  // 4. SỬA LỖI 'missing dependency' VÀ LỖI "ĐỨNG":
  // Bọc 'animate' trong 'useCallback'
  const animate = useCallback(
    (now: number) => {
      const currentDuration = isFastForward ? fastDuration : duration;
      const elapsedTime = now - firstFrameTime.current;
      const timeFraction = elapsedTime / currentDuration;

      if (timeFraction <= 1) {
        // Dùng functional update để tránh 'progress' bị stale
        setProgress((prevProgress) =>
          isFastForward
            ? prevProgress + (100 - prevProgress) * timeFraction
            : timeFraction * 100
        );
        frame.current = requestAnimationFrame(animate);
      } else {
        if (isFastForward) {
          setIsFastForward(false); // Dùng setter
          if (targetValue.current !== null) {
            setActive(targetValue.current); // Dùng setter
            targetValue.current = null;
          }
        } else {
          // Move to the next slide
          const currentIndex = sliderValues.indexOf(active);
          const nextIndex = (currentIndex + 1) % sliderValues.length;
          setActive(sliderValues[nextIndex]); // Dùng setter
        }
        setProgress(0); // Dùng setter
        firstFrameTime.current = performance.now();
      }
    },
    [
      isFastForward,
      fastDuration,
      duration,
      sliderValues,
      active,
      // Các hàm setter (setActive, setProgress...) là ổn định, không cần đưa vào
    ]
  );

  useEffect(() => {
    if (sliderValues.length > 0) {
      firstFrameTime.current = performance.now();
      frame.current = requestAnimationFrame(animate);
    }
    return () => {
      cancelAnimationFrame(frame.current);
    };
  }, [sliderValues, active, isFastForward, animate]); // Thêm 'animate' vào đây

  const handleButtonClick = (value: string) => {
    if (value !== active) {
      const elapsedTime = performance.now() - firstFrameTime.current;
      const currentProgress = (elapsedTime / duration) * 100;
      setProgress(currentProgress);
      targetValue.current = value;
      setIsFastForward(true);
      firstFrameTime.current = performance.now();
    }
  };

  return (
    <ProgressSliderContext.Provider
      value={{ active, progress, handleButtonClick, vertical }}
    >
      <div className={cn('relative', className)}>{children}</div>
    </ProgressSliderContext.Provider>
  );
};

export const SliderContent: FC<SliderContentProps> = ({
  children,
  className,
}) => {
  return <div className={cn('', className)}>{children}</div>;
};

export const SliderWrapper: FC<SliderWrapperProps> = ({
  children,
  value,
  className,
}) => {
  const { active } = useProgressSliderContext();

  return (
    <AnimatePresence mode="popLayout">
      {active === value && (
        <motion.div
          key={value}
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          exit={{ opacity: 0 }}
          className={cn('', className)}
        >
          {children}
        </motion.div>
      )}
    </AnimatePresence>
  );
};

export const SliderBtnGroup: FC<ProgressBarProps> = ({
  children,
  className,
}) => {
  return <div className={cn('', className)}>{children}</div>;
};

export const SliderBtn: FC<SliderBtnProps> = ({
  children,
  value,
  className,
  progressBarClass,
}) => {
  const { active, progress, handleButtonClick, vertical } =
    useProgressSliderContext();

  return (
    <button
      className={cn(
        `relative ${active === value ? 'opacity-100' : 'opacity-50'}`,
        className
      )}
      onClick={() => handleButtonClick(value)}
    >
      {children}
      <div
        className="absolute inset-0 overflow-hidden -z-10 max-h-full max-w-full "
        role="progressbar"
        aria-valuenow={active === value ? progress : 0}
      >
        <span
          className={cn('absolute left-0 ', progressBarClass)}
          style={{
            [vertical ? 'height' : 'width']:
              active === value ? `${progress}%` : '0%',
          }}
        />
      </div>
    </button>
  );
};
```

## File: src/components/ProjectMasonryGrid.tsx
```typescript
// src/components/ProjectMasonryGrid.tsx
'use client';

import Image from 'next/image';
import Link from 'next/link';
import { ArrowUpRight } from 'lucide-react';
import { ProjectData } from '@/data/projects-master-data';

// Định nghĩa 3 kiểu Layout
type LayoutVariant = 'flat' | 'staggered' | 'cascade';

interface GridProps {
  projects: ProjectData[];
  variant?: LayoutVariant; // Prop mới để chọn kiểu
}

const distributeProjects = (items: ProjectData[], cols: number) => {
  const columns: ProjectData[][] = Array.from({ length: cols }, () => []);
  items.forEach((item, i) => {
    columns[i % cols].push(item);
  });
  return columns;
};

export default function ProjectMasonryGrid({ projects, variant = 'staggered' }: GridProps) {
  const mobileProjects = projects;
  const tabletCols = distributeProjects(projects, 2);
  const desktopCols = distributeProjects(projects, 3);

  // --- LOGIC TÍNH TOÁN KHOẢNG CÁCH (PADDING TOP) ---
  
  // 1. Kiểu 'flat' (Thương mại): Thẳng tắp, không lệch
  const getFlatPadding = () => 'pt-0';

  // 2. Kiểu 'staggered' (Thời trang): Lệch cột giữa (So le)
  const getStaggeredPadding = (colIndex: number, totalCols: number) => {
    // Nếu 3 cột -> Cột giữa (index 1) lệch xuống 36px
    if (totalCols === 3 && colIndex === 1) return 'pt-[36px]';
    // Nếu 2 cột -> Cột phải (index 1) lệch xuống 36px
    if (totalCols === 2 && colIndex === 1) return 'pt-[36px]';
    return 'pt-0';
  };

  // 3. Kiểu 'cascade' (Cá nhân): Bậc thang (0 -> 40 -> 80px)
  const getCascadePadding = (colIndex: number) => {
    // Cột 1: 0px, Cột 2: 40px, Cột 3: 80px
    if (colIndex === 0) return 'pt-0';
    if (colIndex === 1) return 'pt-[40px]';
    if (colIndex === 2) return 'pt-[80px]';
    return 'pt-0';
  };

  // Hàm chọn style dựa trên variant
  const getPaddingClass = (colIndex: number, totalCols: number) => {
    if (variant === 'flat') return getFlatPadding();
    if (variant === 'cascade') return getCascadePadding(colIndex);
    return getStaggeredPadding(colIndex, totalCols);
  };

  // --- END LOGIC ---

  const ProjectCard = ({ project, priority = false }: { project: ProjectData, priority?: boolean }) => (
    <Link 
      href={`/du-an/${project.slug}`}
      className="relative block overflow-hidden bg-gray-100 dark:bg-neutral-900 group mb-6 transition-all duration-300 hover:shadow-xl"
    >
      {project.isFeatured && (
        <div className="absolute top-3 right-3 z-20 bg-[var(--foreground)] text-[var(--background)] text-[10px] font-bold uppercase px-2 py-1 rounded shadow-sm">
          Nổi bật
        </div>
      )}
      <Image
        src={typeof project.image === 'string' ? project.image : project.image.src}
        alt={project.title}
        width={0} height={0} sizes="(max-width: 768px) 100vw, 33vw"
        className="w-full h-auto block transition-transform duration-700 group-hover:scale-105"
        unoptimized
        priority={priority}
      />
      <div className="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex flex-col justify-end p-6">
        <div className="transform translate-y-4 group-hover:translate-y-0 transition-transform duration-300">
          <span className="text-xs font-medium text-white/80 uppercase tracking-wider mb-2 block">{project.year}</span>
          <div className="flex justify-between items-center">
            <h3 className="text-xl font-bold text-white line-clamp-2">{project.title}</h3>
            <div className="bg-white/20 p-2 rounded-full backdrop-blur-sm shrink-0 ml-2"><ArrowUpRight className="text-white w-5 h-5" /></div>
          </div>
        </div>
      </div>
    </Link>
  );

  return (
    <div>
        {/* MOBILE (1 Cột - Luôn thẳng) */}
        <div className="block md:hidden space-y-6">
          {mobileProjects.map((p, index) => <ProjectCard key={p.id} project={p} priority={index < 2}/>)}
        </div>

        {/* TABLET (2 Cột) */}
        <div className="hidden md:grid lg:hidden grid-cols-2 gap-6 items-start">
          {tabletCols.map((colProjects, colIndex) => (
            <div key={colIndex} className={`flex flex-col ${getPaddingClass(colIndex, 2)}`}>
              {colProjects.map((p, index) => <ProjectCard key={p.id} project={p} priority={index === 0} />)}
            </div>
          ))}
        </div>

        {/* DESKTOP (3 Cột) */}
        <div className="hidden lg:grid grid-cols-3 gap-6 items-start">
          {desktopCols.map((colProjects, colIndex) => (
            <div key={colIndex} className={`flex flex-col ${getPaddingClass(colIndex, 3)}`}>
              {colProjects.map((p, index) => <ProjectCard key={p.id} project={p} priority={index === 0} />)}
            </div>
          ))}
        </div>
    </div>
  );
}
```

## File: src/components/scroll-text-marque.tsx
```typescript
// src/components/ui/scroll-text-marque.tsx
'use client';

import React from 'react';
import {
  motion,
  useAnimationFrame,
  useMotionValue,
  useTransform,
  wrap,
} from 'framer-motion';
import { cn } from '@/lib/utils'; // Giả định bạn đã có file này

interface ScrollBaseAnimationProps {
  children: React.ReactNode;
  baseVelocity: number;
  className?: string;
  delay?: number; // Prop 'delay' từ ví dụ của bạn
}

export default function ScrollBaseAnimation({
  children,
  baseVelocity = 100, // Tốc độ mặc định
  className,
}: ScrollBaseAnimationProps) {
  // useMotionValue để lưu giá trị 'x'
  const baseX = useMotionValue(0);

  // useAnimationFrame là một vòng lặp (loop) được tối ưu hóa
  // Nó chạy liên tục, cập nhật giá trị 'x'
  useAnimationFrame((time, delta) => {
    // Tính toán quãng đường di chuyển dựa trên velocity
    // (delta là thời gian kể từ frame cuối, ~16ms)
    
    // SỬA LỖI: Đổi 'let' thành 'const' vì nó không bao giờ được gán lại
    const moveBy = baseVelocity * (delta / 1000);
    
    // 'wrap' là một hàm của Framer Motion giúp lặp lại giá trị
    // Khi 'x' đạt -50%, nó sẽ reset về 0, tạo vòng lặp vô tận
    baseX.set(wrap(0, -50, baseX.get() + moveBy));
  });

  // Chuyển giá trị số (ví dụ: -10) thành đơn vị CSS (ví dụ: "-10%")
  const x = useTransform(baseX, (v) => `${v}%`);

  return (
    // 'overflow-hidden' là bắt buộc để "cắt" phần text bị ẩn
    <div
      className="relative w-full overflow-hidden whitespace-nowrap"
    >
      {/* 'motion.div' sẽ di chuyển theo giá trị 'x' */}
      <motion.div
        className={cn('flex', className)} // Áp dụng className (font-bold, etc.) ở đây
        style={{ x }}
      >
        {/* Chúng ta lặp lại nội dung 4 lần để đảm bảo
          luôn lấp đầy màn hình, tạo hiệu ứng liền mạch
        */}
        <span className="inline-block mr-8">{children}</span>
        <span className="inline-block mr-8">{children}</span>
        <span className="inline-block mr-8">{children}</span>
        <span className="inline-block mr-8">{children}</span>
      </motion.div>
    </div>
  );
}
```

## File: src/components/Spinner.tsx
```typescript
// src/components/Spinner.tsx

/**
 * Một component spinner đơn giản dùng Tailwind.
 */
export default function Spinner() {
  return (
    <div className="loader">
      <span className="sr-only">Đang tải...</span>
    </div>
  );
}
```

## File: src/components/ui/ModalPortal.tsx
```typescript
// src/components/ui/ModalPortal.tsx
'use client';

import { useEffect, useState } from 'react';
import { createPortal } from 'react-dom';
import { X } from 'lucide-react';

interface ModalPortalProps {
  isOpen: boolean;
  onClose: () => void;
  children: React.ReactNode;
  title?: string;
  className?: string; // Để custom width tùy ý (sm, md, lg, xl)
}

export default function ModalPortal({ 
  isOpen, 
  onClose, 
  children, 
  title,
  className = "max-w-md" // Mặc định độ rộng
}: ModalPortalProps) {
  const [mounted, setMounted] = useState(false);

  useEffect(() => {
    setMounted(true);
    // Khóa cuộn trang khi mở Modal
    if (isOpen) {
      document.body.style.overflow = 'hidden';
    } else {
      document.body.style.overflow = 'unset';
    }
    return () => {
      document.body.style.overflow = 'unset';
    };
  }, [isOpen]);

  // Chỉ render khi đã mount client-side và isOpen = true
  if (!mounted || !isOpen) return null;

  // Dùng createPortal để đẩy Modal ra tận body
  return createPortal(
    <div className="fixed inset-0 z-[9999] flex items-center justify-center p-4 sm:p-6">
      
      {/* 1. Backdrop (Nền tối mờ toàn màn hình) */}
      <div 
        className="fixed inset-0 bg-black/70 backdrop-blur-sm transition-opacity animate-fade-in" 
        onClick={onClose}
      />

      {/* 2. Modal Container (Nổi lên trên cùng) */}
      <div className={`relative w-full ${className} bg-[var(--admin-card)] border border-[var(--admin-border)] rounded-2xl shadow-2xl flex flex-col overflow-hidden animate-zoom-in z-50`}>
        
        {/* Header (Nếu có title thì hiện, không thì thôi) */}
        {title && (
          <div className="flex items-center justify-between p-6 border-b border-[var(--admin-border)] bg-[var(--admin-bg)]/50">
            <h3 className="text-lg font-bold text-[var(--admin-fg)]">{title}</h3>
            <button 
              onClick={onClose}
              className="text-[var(--admin-sub)] hover:text-[var(--admin-fg)] p-2 hover:bg-[var(--admin-hover)] rounded-full transition-colors"
            >
              <X size={20} />
            </button>
          </div>
        )}

        {/* Nút đóng nhanh nếu không có header */}
        {!title && (
           <button 
            onClick={onClose}
            className="absolute top-4 right-4 p-2 text-[var(--admin-sub)] hover:text-[var(--admin-fg)] hover:bg-[var(--admin-hover)] rounded-full transition-colors z-10"
          >
            <X size={20} />
          </button>
        )}

        {/* Content */}
        <div>
          {children}
        </div>
      </div>
    </div>,
    document.body // Gắn vào body
  );
}
```

## File: src/components/ui/SelectBox.tsx
```typescript
// src/components/ui/SelectBox.tsx
'use client';

import { useState, useRef, useEffect } from 'react';
import { ChevronDown, Check } from 'lucide-react';

interface Option {
  label: string;
  value: string | number;
}

interface SelectBoxProps {
  label?: string; // Label hiển thị bên trên (optional)
  value: string | number;
  onChange: (value: string) => void;
  options: Option[];
  placeholder?: string;
  required?: boolean;
  icon?: React.ReactNode; // Icon trang trí bên trái
  className?: string;
}

export default function SelectBox({
  label,
  value,
  onChange,
  options,
  placeholder = "Chọn một tùy chọn",
  required = false,
  icon,
  className = ""
}: SelectBoxProps) {
  const [isOpen, setIsOpen] = useState(false);
  const containerRef = useRef<HTMLDivElement>(null);

  // Tìm label của giá trị hiện tại
  const selectedLabel = options.find(opt => String(opt.value) === String(value))?.label;

  // Đóng khi click ra ngoài
  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      if (containerRef.current && !containerRef.current.contains(event.target as Node)) {
        setIsOpen(false);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, []);

  return (
    <div className={`space-y-2 ${className}`} ref={containerRef}>
      {label && (
        <label className="text-sm font-medium text-[var(--admin-fg)]">
          {label} {required && <span className="text-red-500">*</span>}
        </label>
      )}

      <div className="relative">
        {/* TRIGGER BUTTON */}
        <button
          type="button" // Quan trọng: type button để không submit form
          onClick={() => setIsOpen(!isOpen)}
          className={`
            w-full flex items-center justify-between px-4 py-3 rounded-lg border transition-all
            bg-[var(--admin-bg)] text-left
            ${isOpen 
              ? 'border-[var(--admin-primary)] ring-2 ring-[var(--admin-primary)]/20' 
              : 'border-[var(--admin-border)] hover:border-[var(--admin-sub)]'
            }
          `}
        >
          <div className="flex items-center gap-2 truncate text-[var(--admin-fg)]">
            {icon}
            <span className={selectedLabel ? "" : "text-[var(--admin-sub)]"}>
              {selectedLabel || placeholder}
            </span>
          </div>
          <ChevronDown 
            size={18} 
            className={`text-[var(--admin-sub)] transition-transform duration-200 ${isOpen ? 'rotate-180' : ''}`} 
          />
        </button>

        {/* DROPDOWN MENU */}
        {isOpen && (
          <div className="absolute top-full left-0 right-0 mt-2 bg-[var(--admin-card)] border border-[var(--admin-border)] rounded-xl shadow-xl z-50 animate-in fade-in zoom-in-95 duration-100 overflow-hidden max-h-60 overflow-y-auto">
            <div className="p-1.5">
              {options.length === 0 ? (
                <div className="p-3 text-center text-sm text-[var(--admin-sub)] italic">
                  Không có dữ liệu
                </div>
              ) : (
                options.map((opt) => {
                  const isActive = String(opt.value) === String(value);
                  return (
                    <button
                      key={opt.value}
                      type="button"
                      onClick={() => {
                        onChange(String(opt.value));
                        setIsOpen(false);
                      }}
                      className={`
                        w-full flex items-center justify-between px-3 py-2.5 rounded-lg text-sm transition-colors mb-0.5
                        ${isActive 
                          ? 'bg-[var(--admin-primary)]/10 text-[var(--admin-primary)] font-medium' 
                          : 'text-[var(--admin-fg)] hover:bg-[var(--admin-hover)]'
                        }
                      `}
                    >
                      <span>{opt.label}</span>
                      {isActive && <Check size={16} />}
                    </button>
                  );
                })
              )}
            </div>
          </div>
        )}
      </div>
    </div>
  );
}
```

## File: src/context/CalendarContext.tsx
```typescript
'use client';

import React, { createContext, useContext, useState, ReactNode } from 'react';

interface CalendarContextType {
  date: Date;
  setDate: (date: Date) => void;
  visibleRoomIds: number[];
  setVisibleRoomIds: (ids: number[]) => void;
  toggleRoomVisibility: (roomId: number) => void;
  isCreateModalOpen: boolean;
  setCreateModalOpen: (isOpen: boolean) => void;
}

const CalendarContext = createContext<CalendarContextType | undefined>(undefined);

export function CalendarProvider({ children }: { children: ReactNode }) {
  const [date, setDate] = useState(new Date());
  // Mặc định là mảng rỗng (sẽ được component con check và fill all nếu rỗng lần đầu)
  const [visibleRoomIds, setVisibleRoomIds] = useState<number[]>([]); 
  const [isCreateModalOpen, setCreateModalOpen] = useState(false);

  const toggleRoomVisibility = (roomId: number) => {
    setVisibleRoomIds(prev => {
      if (prev.includes(roomId)) {
        return prev.filter(id => id !== roomId);
      } else {
        return [...prev, roomId];
      }
    });
  };

  return (
    <CalendarContext.Provider value={{
      date,
      setDate,
      visibleRoomIds,
      setVisibleRoomIds,
      toggleRoomVisibility,
      isCreateModalOpen,
      setCreateModalOpen,
    }}>
      {children}
    </CalendarContext.Provider>
  );
}

export function useCalendar() {
  const context = useContext(CalendarContext);
  if (context === undefined) {
    throw new Error('useCalendar must be used within a CalendarProvider');
  }
  return context;
}
```

## File: src/data/bts.ts
```typescript
import type { StaticImageData } from 'next/image'; // Import kiểu này
import btsImage1 from '../assets/section_04/bts_01.jpg'; 
import btsImage2 from '../assets/section_04/bts_02.jpg'; 
import btsImage3 from '../assets/section_04/bts_03.jpg'; 
import btsImage4 from '../assets/section_04/bts_04.jpg'; 
import btsImage5 from '../assets/section_04/bts_05.jpg'; 
import btsImage6 from '../assets/section_04/bts_06.jpg'; 

export interface BTS {
  title: string;
  imageUrl: StaticImageData | string;
  description: string;
  client?: string; // client có thể không bắt buộc
  year?: string;
  location?: string;
}
const projects: BTS[] = 
[
{
    title: 'Sự Thức Tỉnh Của Vệ Nữ',
    imageUrl: btsImage1, 
    description: 'Đây là một concept "Vệ Nữ tái sinh" đầy tham vọng, thực hiện 100% trong studio. Thử thách lớn nhất là phải "thổi hồn" vào một bối cảnh hoàn toàn nhân tạo, kết hợp phông nền in khổ lớn với mô hình vỏ sò điêu khắc. Cái khó nhất là làm chủ chuyển động: một chiếc quạt công suất lớn (thấy ở tiền cảnh) được dùng liên tục để tạo hiệu ứng tóc và tà váy bay lượn. Ekip đã phải "đóng băng" khoảnh khắc đó, trong khi chuyên gia (như trong ảnh) liên tục tinh chỉnh từng chi tiết nhỏ để đạt độ hoàn hảo nhất.',
    client: 'Tạp chí Harper\'s Bazaar',
    year: '2024',
    location: 'Oni Studio, TP.HCM',
  },
  {
    title: 'Chuyển Động Tối Giản',
    imageUrl: btsImage2, 
    description: 'Concept là một bộ lookbook thời trang tối giản. Thử thách lớn nhất với phông nền xám trơn là làm sao để chủ thể và trang phục không bị "phẳng" hay nhàm chán. Ánh sáng chính là chìa khóa. Chúng tôi dùng một set-up 3 đèn: một key-light lớn (bên trái) để tạo khối, một fill-light nhẹ (bên phải, như trợ lý đang giữ) để làm mềm bóng đổ. Mấu chốt là một đèn rim-light (đèn viền) từ phía sau để tách người mẫu khỏi nền, làm nổi bật chi tiết lông vũ trên tay áo. Cả ekip đã làm việc liên tục để tìm ra những dáng pose sắc sảo nhất.',
    client: 'Zara Studio Lookbook',
    year: '2024',
    location: 'Oni Studio, TP.HCM',
  },
  {
    title: 'Chiến Binh Cơ Khí',
    imageUrl: btsImage3,
    description: 'Thử thách lớn nhất khi chụp sản phẩm cơ khí, đặc biệt là một chiếc Harley, là kiểm soát sự phản chiếu. Bề mặt chrome và sơn bóng loáng như một tấm gương. Chúng tôi phải di chuyển xe vào studio một cách cẩn thận và set up nhiều nguồn sáng khuếch tán lớn (như softbox trong ảnh) để "vẽ" nên những đường highlight mềm mại, làm nổi bật đường cong của xe mà không tạo ra các điểm cháy sáng gắt. Cả ekip đã phải tỉ mỉ xoay đèn từng chút một để đảm bảo mọi chi tiết từ động cơ đến ống xả đều hiện lên sắc nét.',
    client: 'Harley-Davidson Vietnam',
    year: '2023',
    location: 'Oni Studio, TP.HCM',
  },
  {
    title: 'Phỏng Vấn "High-Key"',
    imageUrl: btsImage4,
    description: 'Đây là một buổi quay phỏng vấn/ talkshow với set-up "high-key" (nền trắng sáng). Cái khó của kỹ thuật này là phải chiếu sáng phông nền trắng phía sau thật đều và cháy sáng hơn chủ thể, trong khi vẫn phải giữ chi tiết và ánh sáng đẹp trên nhân vật. Như trong ảnh, ekip đang tinh chỉnh nhiều nguồn sáng: một softbox (key-light) cho chủ thể và các đèn khác cho nền. Chúng tôi cũng sử dụng một máy tạo khói nhẹ (bên phải) để tạo không khí, giúp ánh sáng có chiều sâu hơn và không gian trắng không bị "bằng phẳng".',
    client: 'Chương trình "Insight" - VTV',
    year: '2023',
    location: 'Oni Studio, TP.HCM',
  },
  {
    title: 'Kỹ Thuật "Ghost Mannequin"',
    imageUrl: btsImage5,
    description: 'Đây là một buổi chụp sản phẩm e-commerce đòi hỏi kỹ thuật cao. Mục tiêu là làm chiếc áo "vô hình" người mặc để giữ nguyên phom dáng. Thử thách là phải treo sản phẩm bằng sợi cước siêu mỏng (như trong ảnh) và đảm bảo áo không bị xoay. Ánh sáng phải thật đều để thể hiện đúng chất liệu vải. Chúng tôi dùng một softbox parabol lớn (bên phải) làm đèn chính và một đèn phụ từ trên cao (gắn trên boom) để làm nổi bật chi tiết vai áo, giúp khâu hậu kỳ ghép ảnh (chụp trong, chụp ngoài) dễ dàng hơn.',
    client: 'Uniqlo Vietnam',
    year: '2023',
    location: 'Oni Studio, TP.HCM',
  },
  {
    title: 'Vẻ Đẹp Tinh Khiết',
    imageUrl: btsImage6,
    description: 'Chụp sản phẩm mỹ phẩm luôn là một thử thách về kiểm soát ánh sáng. Cái khó nhất là xử lý bề mặt chai lọ bóng, dễ bị phản chiếu lộn xộn. Chúng tôi đã phải tạo một "lều" ánh sáng mini (hộp trắng ở giữa) để bao bọc sản phẩm. Ánh sáng được set-up tỉ mỉ: một softbox lớn (bên trái) cho ánh sáng chính, một tấm hắt sáng vàng (bên phải) để tạo viền ấm áp cho sản phẩm, và một đèn top-light (trên cao) để làm nổi bật nắp chai. Cả ekip (như bạn thấy) đang theo dõi trực tiếp qua máy tính (tethering) để tinh chỉnh từng milimet.',
    client: 'Cỏ Mềm HomeLab',
    year: '2023',
    location: 'Oni Studio, TP.HCM',
  }
];

export default projects;
```

## File: src/lib/actions/bookings.ts
```typescript
// src/lib/actions/bookings.ts
'use server'

import { createClient } from '@/lib/supabase/server'
import { revalidatePath } from 'next/cache'
import { getCleanupMinutes } from './settings' 

// --- 1. ĐỊNH NGHĨA CÁC INTERFACE CẦN THIẾT ---

// Interface cho việc check trùng (đã có)
interface BookingCollisionCheck {
  booking_item_id: number;
  booking_id: number;
  start_dt: string;
  end_dt: string;
  cleanup_minutes: number | null;
}

interface ActiveBookingResult {
  booking_id: number;
  bookings: {
    status: string | null;
  } | null;
}

// Interface CHUẨN cho dữ liệu trả về Calendar (FIX LỖI SelectQueryError)
export interface CalendarBookingItem {
  booking_item_id: number;
  start_dt: string;
  end_dt: string;
  room_id: number;
  cleanup_minutes?: number | null; // Cột mới thêm
  rooms: { 
    name: string | null; 
    code: string | null; 
  } | null;
  bookings: {
    booking_id: number;
    status: string | null;
    customer_id: number | null;
    customers: { 
      full_name: string | null; 
      phone: string | null; 
    } | null;
  } | null;
}

export interface BookingItemInput {
  roomId: number;
  startDt: string; 
  endDt: string;   
  price: number;   
}

export interface ServiceInput {
  serviceId: number;
  quantity: number;
  price: number;   
  type: 'service' | 'surcharge' | 'compensation';
}

export interface CreateBookingDTO {
  customerId: number; 
  staffId: number;    
  deposit: number;    
  discount: number;   
  discountReason?: string;
  notes?: string;
  items: BookingItemInput[]; 
  services?: ServiceInput[]; 
}

// ==============================================================================
// 1. KIỂM TRA PHÒNG TRỐNG (CHECK AVAILABILITY)
// ==============================================================================
export async function checkRoomAvailability(roomId: number, startStr: string, endStr: string) {
  const supabase = await createClient()
  const currentGap = await getCleanupMinutes();

  const { data: rawData, error } = await supabase
    .from('booking_items')
    .select('booking_item_id, booking_id, start_dt, end_dt, cleanup_minutes') 
    .eq('room_id', roomId)
    .filter('start_dt', 'lt', new Date(new Date(endStr).getTime() + 120 * 60000).toISOString()) 
    .filter('end_dt', 'gt', new Date(new Date(startStr).getTime() - 120 * 60000).toISOString())

  if (error) return { valid: false, error: error.message }

  const data = rawData as unknown as BookingCollisionCheck[];

  if (data && data.length > 0) {
    const itemIds = data.map(i => i.booking_item_id)
    
    const { data: rawActiveBookings } = await supabase
      .from('booking_items')
      .select('booking_id, bookings!inner(status)')
      .in('booking_item_id', itemIds)
      .in('bookings.status', ['pending', 'confirmed', 'checked_in'])
    
    const activeBookings = rawActiveBookings as unknown as ActiveBookingResult[];
    
    if (activeBookings && activeBookings.length > 0) {
      const isOverlap = data.some(existingItem => {
        const isActive = activeBookings.find(ab => ab.booking_id === existingItem.booking_id);
        if (!isActive) return false;

        const oldStart = new Date(existingItem.start_dt).getTime();
        const oldEnd = new Date(existingItem.end_dt).getTime();
        const oldGap = (existingItem.cleanup_minutes || 60) * 60000; 

        const newStart = new Date(startStr).getTime();
        const newEnd = new Date(endStr).getTime();
        const newGap = currentGap * 60000;

        const clash1 = (newStart < oldEnd + oldGap) && (newEnd > oldStart);
        const clash2 = (oldStart < newEnd + newGap) && (oldEnd > newStart);

        return clash1 || clash2;
      });

      if (isOverlap) {
        return { valid: false, error: `Phòng bị trùng lịch hoặc vi phạm thời gian dọn dẹp.` }
      }
    }
  }

  return { valid: true }
}

// ==============================================================================
// 2. TẠO BOOKING (TRANSACTION)
// ==============================================================================

export async function createBooking(payload: CreateBookingDTO) {
  const supabase = await createClient()
  const currentCleanupMinutes = await getCleanupMinutes();

  // --- BƯỚC 1: TẠO HEADER ---
  const { data: booking, error: bookingError } = await supabase
    .from('bookings')
    .insert({
      customer_id: payload.customerId,
      created_by: payload.staffId,
      status: 'confirmed', 
      deposit_amount: payload.deposit,
      deposit_paid: 0, 
      discount_amount: payload.discount,
      discount_reason: payload.discountReason,
      notes: payload.notes,
      vat_percent_snapshot: 8, 
      total_estimate: 0, 
      total_actual: 0
    })
    .select()
    .single()

  if (bookingError) return { success: false, error: 'Lỗi tạo đơn: ' + bookingError.message }
  
  // FIX: Thay thế 'any' bằng định nghĩa kiểu inline để tránh lỗi Linter
  const bookingId = (booking as { booking_id: number }).booking_id;

  // --- BƯỚC 2: TẠO ITEMS ---
  try {
    const itemsToInsert = payload.items.map(item => ({
      booking_id: bookingId,
      room_id: item.roomId,
      start_dt: item.startDt,
      end_dt: item.endDt,
      price_snapshot: item.price,
      cleanup_minutes: currentCleanupMinutes 
    }))

    const { error: itemsError } = await supabase
      .from('booking_items')
      .insert(itemsToInsert)

    if (itemsError) throw itemsError 

    // --- BƯỚC 3: TẠO SERVICES ---
    if (payload.services && payload.services.length > 0) {
      const servicesToInsert = payload.services.map(s => ({
        booking_id: bookingId,
        service_id: s.serviceId,
        quantity: s.quantity,
        type: s.type,
        unit_price_snapshot: s.price,
        computed_amount: s.quantity * s.price
      }))

      const { error: serviceError } = await supabase
        .from('booking_services')
        .insert(servicesToInsert)
      
      if (serviceError) throw serviceError
    }
    
    revalidatePath('/admin/bookings')
    revalidatePath('/admin/calendar')
    return { success: true, bookingId }

  } catch (error: unknown) {
    console.error("Booking Transaction Failed. Rolling back...", error)
    await supabase.from('bookings').delete().eq('booking_id', bookingId)
    
    const errMsg = error instanceof Error ? error.message : JSON.stringify(error);
    return { success: false, error: 'Đặt phòng thất bại: ' + errMsg }
  }
}

// ==============================================================================
// 3. LẤY DANH SÁCH BOOKING (CHO CALENDAR)
// ==============================================================================

export async function getBookingsForCalendar(startStr: string, endStr: string) {
  const supabase = await createClient()

  const { data, error } = await supabase
    .from('booking_items')
    .select(`
      *,
      cleanup_minutes, 
      rooms ( name, code ),
      bookings ( 
        status, 
        customer_id, 
        customers ( full_name, phone )
      )
    `)
    .lt('start_dt', endStr)
    .gt('end_dt', startStr)
    .not('bookings.status', 'eq', 'cancelled')

  if (error) {
    console.error("Error fetching calendar bookings:", error);
    return [];
  }

  // FIX LỖI TypeScript: Ép kiểu 'data' (đang bị Supabase hiểu là lỗi) về Interface chuẩn
  // Kỹ thuật "Double Casting": (data as unknown) -> as CalendarBookingItem[]
  return (data as unknown) as CalendarBookingItem[];
}


// Hàm update thời gian & phòng khi kéo thả
export async function updateBookingTime(
  bookingItemId: number, 
  newStart: string, 
  newEnd: string, 
  newRoomId: number
) {
  const supabase = await createClient();

  const { error } = await supabase
    .from('booking_items')
    .update({
      start_dt: newStart,
      end_dt: newEnd,
      room_id: newRoomId
    })
    .eq('booking_item_id', bookingItemId);

  if (error) return { success: false, error: error.message };
  
  revalidatePath('/admin'); 
  return { success: true };
}
```

## File: src/lib/actions/customers.ts
```typescript
'use server'

import { createClient } from '@/lib/supabase/server'
import { revalidatePath } from 'next/cache'
import { Database } from '@/types/supabase'

export type CustomerRow = Database['public']['Tables']['customers']['Row']

// ==============================================================================
// 1. LẤY DANH SÁCH & TÌM KIẾM
// ==============================================================================

export async function getCustomers(query: string = '', limit: number = 20) {
  const supabase = await createClient()

  let dbQuery = supabase
    .from('customers')
    .select('*')
    .eq('is_active', true)
    .order('created_at', { ascending: false })
    .limit(limit)

  // Tìm kiếm theo Tên hoặc SĐT
  if (query) {
    dbQuery = dbQuery.or(`full_name.ilike.%${query}%,phone.ilike.%${query}%`)
  }

  const { data, error } = await dbQuery

  if (error) {
    console.error('Error fetching customers:', error)
    return []
  }
  return data
}

export async function getCustomerById(id: number) {
  const supabase = await createClient()
  
  const { data, error } = await supabase
    .from('customers')
    .select('*')
    .eq('customer_id', id)
    .single()

  if (error) return null
  return data
}

// ==============================================================================
// 2. TẠO & CẬP NHẬT
// ==============================================================================

export async function createCustomer(formData: FormData) {
  const supabase = await createClient()

  const rawData = {
    full_name: formData.get('full_name') as string,
    phone: formData.get('phone') as string,
    email: formData.get('email') as string || null,
    cccd: formData.get('cccd') as string || null,
    company_name: formData.get('company_name') as string || null,
    tax_code: formData.get('tax_code') as string || null,
    address: formData.get('address') as string || null,
    customer_type: formData.get('customer_type') as 'regular' | 'vip' | 'corporate' || 'regular',
    discount_rate: Number(formData.get('discount_rate') || 0),
    note: formData.get('note') as string || null
  }

  const { data, error } = await supabase
    .from('customers')
    .insert(rawData)
    .select()
    .single()

  if (error) {
    // Xử lý lỗi trùng SĐT thân thiện hơn
    if (error.code === '23505') { // Mã lỗi Unique Violation của Postgres
      return { success: false, error: 'Số điện thoại này đã tồn tại trong hệ thống.' }
    }
    return { success: false, error: error.message }
  }

  revalidatePath('/admin/customers')
  return { success: true, data }
}

export async function updateCustomer(customerId: number, formData: FormData) {
  const supabase = await createClient()

  const rawData = {
    full_name: formData.get('full_name') as string,
    phone: formData.get('phone') as string,
    email: formData.get('email') as string,
    cccd: formData.get('cccd') as string,
    company_name: formData.get('company_name') as string,
    tax_code: formData.get('tax_code') as string,
    address: formData.get('address') as string,
    customer_type: formData.get('customer_type') as 'regular' | 'vip' | 'corporate',
    discount_rate: Number(formData.get('discount_rate') || 0),
    note: formData.get('note') as string
  }

  const { error } = await supabase
    .from('customers')
    .update(rawData)
    .eq('customer_id', customerId)

  if (error) return { success: false, error: error.message }

  revalidatePath('/admin/customers')
  return { success: true }
}

// ==============================================================================
// 3. LỊCH SỬ GIAO DỊCH (CRM)
// ==============================================================================

export async function getCustomerHistory(customerId: number) {
  const supabase = await createClient()
  
  // Lấy danh sách booking của khách này
  const { data, error } = await supabase
    .from('bookings')
    .select(`
      *,
      users (full_name) 
    `)
    .eq('customer_id', customerId)
    .order('created_at', { ascending: false })

  if (error) return []
  return data
}
```

## File: src/lib/actions/project.ts
```typescript

```

## File: src/lib/actions/settings.ts
```typescript
// src/lib/actions/settings.ts
'use server'

import { createClient } from '@/lib/supabase/server'
import { revalidatePath } from 'next/cache'

export interface SettingItem {
  key: string;
  value: string;
  description?: string;
}

// 1. Lấy danh sách Settings
export async function getSettings() {
  const supabase = await createClient();
  try {
    const { data, error } = await supabase
      .from('settings')
      .select('*')
      .order('key');

    if (error) throw error;
    return data as SettingItem[];
  } catch (error: unknown) {
    console.error("Error fetching settings:", error);
    return [];
  }
}

// 2. Lấy giá trị Setting Cleanup
export async function getCleanupMinutes() {
  const supabase = await createClient()
  
  const { data, error } = await supabase
    .from('settings')
    .select('value')
    .eq('key', 'CLEANUP_GAP_MINUTES')
    .single()

  if (error || !data) return 60; 
  return Number(data.value) || 60;
}

// 3. Cập nhật Setting Cleanup
export async function updateCleanupMinutes(minutes: number) {
  const supabase = await createClient()

  const { error } = await supabase
    .from('settings')
    .upsert({
      key: 'CLEANUP_GAP_MINUTES',
      value: minutes.toString(),
      description: 'Thời gian dọn dẹp (phút)',
      updated_at: new Date().toISOString()
    })

  if (error) return { success: false, error: error.message }

  revalidatePath('/admin/settings')
  return { success: true }
}

// 4. Cập nhật Nhiều Settings (Được chuyển từ actions.ts sang & tối ưu hóa)
export async function updateSettings(updates: { key: string; value: string }[]) {
  const supabase = await createClient();

  // 1. Check quyền Admin (Giữ nguyên logic cũ)
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) return { success: false, error: 'Unauthorized' };

  const { data: profile } = await supabase
    .from('users')
    .select('role')
    .eq('auth_id', user.id)
    .single();

  if (profile?.role !== 'Admin') {
    return { success: false, error: 'Forbidden' };
  }

  // 2. THAY ĐỔI: Dùng upsert thay vì update
  try {
    const promises = updates.map(item => 
      supabase
        .from('settings')
        .upsert({ 
          key: item.key, // upsert cần key để biết dòng nào cần sửa
          value: item.value,
          description: item.key === 'CLEANUP_GAP_MINUTES' ? 'Thời gian dọn dẹp (phút)' : undefined, // Optional: giữ description không bị null nếu tạo mới
          updated_at: new Date().toISOString()
        }, { onConflict: 'key' }) // Quan trọng: xác định trùng lặp dựa trên cột 'key'
    );

    const results = await Promise.all(promises);

    // Kiểm tra xem có lệnh nào bị lỗi không
    const errors = results.filter(r => r.error).map(r => r.error?.message);
    if (errors.length > 0) {
        throw new Error(errors.join(', '));
    }

    revalidatePath('/', 'layout'); 
    return { success: true };
  } catch (error: unknown) {
    let message = 'Lỗi không xác định';
    if (error instanceof Error) message = error.message;
    else if (typeof error === 'string') message = error;
    
    return { success: false, error: message };
  }
}
```

## File: src/lib/actions/stats.ts
```typescript
// src/lib/actions/stats.ts
'use server'

import { createClient } from '@/lib/supabase/server'

// Định nghĩa Type chung cho Chart
export interface MonthlyStat {
  name: string;
  total: number;
}
interface ChartSourceItem {
  start_dt?: string;    // Có khi query bảng bookings
  created_at?: string;  // Có khi query bảng projects
}
// Helper tính ngày bắt đầu
function getStartDate(range: string) {
  const now = new Date();
  // Reset giờ để tính chính xác mốc 00:00
  now.setHours(0, 0, 0, 0); 
  
  if (range === 'today') {
    return now;
  }
  if (range === '7d') {
    const d = new Date(now);
    d.setDate(d.getDate() - 7);
    return d;
  }
  if (range === '30d') {
    const d = new Date(now);
    d.setDate(d.getDate() - 30);
    return d;
  }
  if (range === '90d') {
    const d = new Date(now);
    d.setDate(d.getDate() - 90);
    return d;
  }
  if (range === '12m') {
    const d = new Date(now);
    d.setFullYear(d.getFullYear() - 1);
    return d;
  }
  return new Date(0); // All time
}

export async function getDashboardStats(range: string = '30d') {
  const supabase = await createClient();
  try {
    const startDate = getStartDate(range).toISOString();
    
    // Range cho "Hôm nay"
    const todayStart = new Date();
    todayStart.setHours(0, 0, 0, 0);
    const todayEnd = new Date();
    todayEnd.setHours(23, 59, 59, 999);

    const { count: totalProjects } = await supabase.from('projects').select('*', { count: 'exact', head: true });
    
    const { count: newProjects } = await supabase
      .from('projects')
      .select('*', { count: 'exact', head: true })
      .gte('created_at', startDate);

    const { count: totalStaff } = await supabase.from('users').select('*', { count: 'exact', head: true });

    const { count: todayBookings } = await supabase
      .from('booking_items')
      .select('*', { count: 'exact', head: true })
      .gte('start_dt', todayStart.toISOString())
      .lte('start_dt', todayEnd.toISOString());

    return {
      totalProjects: totalProjects || 0,
      newProjects: newProjects || 0,
      totalStaff: totalStaff || 0,
      todayBookings: todayBookings || 0
    };
  } catch (error) {
    console.error("Lỗi dashboard stats:", error);
    return { totalProjects: 0, newProjects: 0, totalStaff: 0, todayBookings: 0 };
  }
}

export async function getTodaySchedule() {
  const supabase = await createClient();
  try {
    const todayStart = new Date();
    todayStart.setHours(0, 0, 0, 0);
    const todayEnd = new Date();
    todayEnd.setHours(23, 59, 59, 999);

    const { data, error } = await supabase
      .from('booking_items')
      .select(`
        booking_item_id,
        start_dt,
        end_dt,
        rooms ( name, code ),
        bookings ( 
          status,
          customers ( full_name, phone )
        )
      `)
      .gte('start_dt', todayStart.toISOString())
      .lte('start_dt', todayEnd.toISOString())
      .order('start_dt', { ascending: true });

    if (error) throw error;
    return data || [];
  } catch (error) {
    console.error("Lỗi lấy lịch hôm nay:", error);
    return [];
  }
}

// --- HÀM NÀY ĐÃ ĐƯỢC CẬP NHẬT ---
export async function getGrowthChartData(range: string = '30d', type: 'bookings' | 'projects' = 'bookings') {
    const supabase = await createClient();
    try {
        const startDate = getStartDate(range);
        let query;

        if (type === 'bookings') {
            query = supabase
                .from('booking_items')
                .select('start_dt')
                .gte('start_dt', startDate.toISOString())
                .order('start_dt', { ascending: true });
        } else {
            query = supabase
                .from('projects')
                .select('created_at')
                .gte('created_at', startDate.toISOString())
                .order('created_at', { ascending: true });
        }

        const { data, error } = await query;

        if (error || !data) {
            return [];
        }

        // 2. ÉP KIỂU TƯỜNG MINH (FIX LỖI ANY)
        // Chúng ta cho TS biết 'data' này chắc chắn là mảng các object có start_dt hoặc created_at
        const typedData = data as unknown as ChartSourceItem[];

        const isDaily = range === '7d' || range === '30d' || range === 'today';
        const statsMap = new Map<string, number>();

        // Giờ 'item' sẽ có kiểu ChartSourceItem, không còn là any
        typedData.forEach((item) => {
            const dateVal = type === 'bookings' ? item.start_dt : item.created_at;
            
            if (!dateVal) return;
            
            const date = new Date(dateVal);
            let key = '';

            if (isDaily) {
                key = `${date.getDate()}/${date.getMonth() + 1}`;
            } else {
                key = `T${date.getMonth() + 1}`;
            }
            
            statsMap.set(key, (statsMap.get(key) || 0) + 1);
        });

        return Array.from(statsMap, ([name, total]) => ({ name, total }));
    } catch (error) {
        console.error("Lỗi lấy thống kê biểu đồ:", error);
        return [];
    }
}
```

## File: src/lib/actions/studio.ts
```typescript
'use server'

import { createClient } from '@/lib/supabase/server'
import { revalidatePath } from 'next/cache'
import { Database } from '@/types/supabase'

// Định nghĩa lại các Type trả về cho UI dễ dùng
// Kỹ thuật: Lấy Type dòng (Row) từ Database và mở rộng thêm quan hệ
export type RoomWithBranch = Database['public']['Tables']['rooms']['Row'] & {
  branches: { name: string; branch_code: string } | null
}

export interface ServiceItem {
  service_id: number;
  name: string;
  price: number;
  unit: string | null;
  is_active: boolean | null;
  type: 'service' | 'surcharge' | 'compensation';
  // --- THÊM DÒNG NÀY ---
  // Định nghĩa category khớp với các Tab bạn đang dùng
  category?: 'equipment' | 'fnb' | 'surcharge' | string; 
}

// ==============================================================================
// 1. CHI NHÁNH (BRANCHES)
// ==============================================================================

export async function getBranches() {
  const supabase = await createClient()
  const { data, error } = await supabase
    .from('branches')
    .select('*')
    .eq('is_active', true)
    .order('created_at')

  if (error) {
    console.error('Error fetching branches:', error)
    return []
  }
  return data
}

// ==============================================================================
// 2. PHÒNG (ROOMS)
// ==============================================================================

export async function getRooms(): Promise<RoomWithBranch[]> {
  const supabase = await createClient()
  
  // Lấy phòng kèm thông tin chi nhánh (Join bảng)
  const { data, error } = await supabase
    .from('rooms')
    .select(`
      *,
      branches (
        name,
        branch_code
      )
    `)
    .order('branch_id')
    .order('code')

  if (error) {
    console.error('Error fetching rooms:', error)
    return []
  }
  
  // Ép kiểu về RoomWithBranch để TypeScript hiểu cấu trúc Join
  return data as unknown as RoomWithBranch[]
}

export async function createRoom(formData: FormData) {
  const supabase = await createClient()

  // Lấy dữ liệu từ Form
  // Lưu ý: DB v2 đã bỏ cột cleanup_minutes, dùng Global Setting nên không cần gửi lên
  const rawData = {
    branch_id: Number(formData.get('branch_id')),
    code: formData.get('code') as string,
    name: formData.get('name') as string,
    capacity: Number(formData.get('capacity') || 0),
    is_rentable: formData.get('is_rentable') === 'on',
    is_equipment_room: formData.get('is_equipment_room') === 'on',
    status: 'available' as const // ENUM: available | maintenance | inactive
  }

  const { error } = await supabase.from('rooms').insert(rawData)

  if (error) {
    return { success: false, error: error.message }
  }

  revalidatePath('/admin/rooms')
  return { success: true }
}

export async function toggleRoomStatus(roomId: number, currentStatus: string) {
  const supabase = await createClient()
  
  // Logic đơn giản: switch giữa available <-> maintenance
  const newStatus = currentStatus === 'available' ? 'maintenance' : 'available'

  const { error } = await supabase
    .from('rooms')
    .update({ status: newStatus as 'available' | 'maintenance' | 'inactive' })
    .eq('room_id', roomId)

  if (error) return { success: false, error: error.message }
  
  revalidatePath('/admin/rooms')
  return { success: true }
}

// ==============================================================================
// 3. DỊCH VỤ & PHỤ THU (SERVICES)
// ==============================================================================

export async function getServices() {
  const supabase = await createClient()
  
  const { data, error } = await supabase
    .from('services')
    .select('*')
    .eq('is_active', true)
    .order('type') // Gom nhóm theo: service, surcharge, compensation
    .order('name')

  if (error) return []
  return data
}

export async function createService(formData: FormData) {
  const supabase = await createClient()

  const rawData = {
    name: formData.get('name') as string,
    price: Number(formData.get('price')),
    // Ép kiểu ENUM service_type
    type: formData.get('type') as 'service' | 'surcharge' | 'compensation',
    unit: formData.get('unit') as string || 'item'
  }

  const { error } = await supabase.from('services').insert(rawData)

  if (error) return { success: false, error: error.message }

  revalidatePath('/admin/services')
  return { success: true }
}

export async function deleteService(serviceId: number) {
    const supabase = await createClient()
    
    // Soft delete: Chỉ tắt active chứ không xóa vĩnh viễn để giữ lịch sử booking
    const { error } = await supabase
      .from('services')
      .update({ is_active: false })
      .eq('service_id', serviceId)
  
    if (error) return { success: false, error: error.message }
  
    revalidatePath('/admin/services')
    return { success: true }
}
```

## File: src/lib/actions/users.ts
```typescript
'use server'

import { createClient } from '@/lib/supabase/server'
import { revalidatePath } from 'next/cache'
import { createClient as createSupabaseClient } from '@supabase/supabase-js' // Chỉ dùng cho Service Role

export interface UserProfile {
  user_id: number;
  email: string;
  full_name: string;
  role: 'Admin' | 'Staff';
}

export interface StaffUser extends UserProfile {
  is_active: boolean;
  created_at: string;
  auth_id: string;
}

async function requireAdmin() {
  const supabase = await createClient(); // Sử dụng client từ @supabase/ssr

  // 1. Lấy User từ Session (Tự động đọc Cookie)
  const { data: { user }, error } = await supabase.auth.getUser();
  
  if (error || !user) {
    throw new Error("Unauthorized: Bạn chưa đăng nhập.");
  }

  // 2. Check Role trong DB
  const { data: profile } = await supabase
    .from('users')
    .select('role')
    .eq('auth_id', user.id)
    .single();

  if (profile?.role !== 'Admin') {
    throw new Error("Forbidden: Chỉ Admin mới có quyền này.");
  }

  // (Optional) Trả về user hiện tại để hàm gọi dùng tiếp đỡ phải query lại
  return user;
}


// 1. Lấy thông tin user hiện tại
export async function getCurrentUserProfile(): Promise<UserProfile | null> {
  const supabase = await createClient();

  try {
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) return null;

    const { data: profile } = await supabase
      .from('users')
      .select('user_id, email, full_name, role')
      .eq('auth_id', user.id)
      .single();

    return profile as UserProfile;
  } catch (error) {
    console.error("Lỗi thông tin người dùng hiện tại:", error);
    return null;
  }
}

// 2. Lấy danh sách nhân viên
export async function getStaffList() {
  const supabase = await createClient();
  try {
    const { data, error } = await supabase
      .from('users')
      .select('*')
      .order('created_at', { ascending: false });

    if (error) throw error;
    return data as StaffUser[];
  } catch (error) {
    console.error("Error fetching staff:", error);
    return [];
  }
}

// 3. Khóa/Mở khóa tài khoản
export async function toggleStaffStatus(userId: number, currentStatus: boolean) {
  try {
    // 1. Check quyền (Không cần truyền token nữa)
    const currentUser = await requireAdmin(); 

    // 2. Tạo client để thực hiện update
    const supabase = await createClient(); //

    // 3. Logic nghiệp vụ (Giữ nguyên logic cũ của bạn)
    // Lấy thông tin người bị khóa (Target) để check không tự khóa mình
    const { data: targetUser } = await supabase
      .from('users')
      .select('auth_id')
      .eq('user_id', userId)
      .single();

    if (targetUser && currentUser.id === targetUser.auth_id) {
      throw new Error("Bạn không thể tự khóa tài khoản của chính mình.");
    }

    const { error } = await supabase
      .from('users')
      .update({ is_active: !currentStatus })
      .eq('user_id', userId);

    if (error) throw error;
    
    // Revalidate nếu cần (nhớ import revalidatePath)
    // revalidatePath('/admin/staff');

    return { success: true };
  } catch (error: unknown) {
    console.error("Toggle staff error:", error);
    return { success: false, error: error instanceof Error ? error.message : 'Lỗi hệ thống' };
  }
}

// 4. Tạo tài khoản nhân viên (Dùng Service Role)
export async function createStaffAccount(data: { email: string; password: string; fullName: string; role: string }) {
  // Service Role Key cần thiết để tạo user trong Auth mà không cần confirm email thủ công
  const serviceKey = process.env.SUPABASE_SERVICE_ROLE_KEY;
  const projectUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;

  if (!serviceKey || !projectUrl) {
    return { success: false, error: "Server chưa cấu hình Service Role Key" };
  }

  try {
    // Tạo Client quyền Admin
    const supabaseAdmin = createSupabaseClient(projectUrl, serviceKey, {
      auth: { autoRefreshToken: false, persistSession: false }
    });

    // Tạo User bên Auth
    const { data: authData, error: authError } = await supabaseAdmin.auth.admin.createUser({
      email: data.email,
      password: data.password,
      email_confirm: true,
      user_metadata: { full_name: data.fullName }
    });

    if (authError) throw authError;
    if (!authData.user) throw new Error("Không tạo được Auth User");

    // Lưu vào bảng public.users
    const { error: dbError } = await supabaseAdmin
      .from('users')
      .insert({
        email: data.email,
        username: data.email, 
        full_name: data.fullName,
        role: data.role,
        auth_id: authData.user.id,
        is_active: true
      });

    if (dbError) {
      await supabaseAdmin.auth.admin.deleteUser(authData.user.id); // Rollback
      throw dbError;
    }

    revalidatePath('/admin/staff');
    return { success: true };

  } catch (error: unknown) {
    
    // Xử lý type safe
    let message = 'Lỗi không xác định';
    
    if (error instanceof Error) {
      message = error.message; // Lấy message từ Error object
    } else if (typeof error === 'string') {
      message = error; // Nếu throw "chuỗi"
    }

    // Trả về string cho Client hiển thị
    return { success: false, error: message };
  }
}
```

## File: src/lib/image-utils.ts
```typescript
// src/lib/image-utils.ts

/**
 * Nén và Resize ảnh trước khi upload
 * @param file File ảnh gốc
 * @param maxWidth Chiều rộng tối đa (mặc định 1920px)
 * @param quality Chất lượng nén (0 - 1, mặc định 0.8)
 */
export const compressImage = async (
  file: File, 
  maxWidth = 1920, 
  quality = 0.8
): Promise<Blob> => {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.readAsDataURL(file);
    
    reader.onload = (event) => {
      const img = new Image();
      img.src = event.target?.result as string;
      
      img.onload = () => {
        // Tính toán kích thước mới giữ nguyên tỷ lệ
        let width = img.width;
        let height = img.height;
        
        if (width > maxWidth) {
          height = Math.round((height * maxWidth) / width);
          width = maxWidth;
        }

        // Vẽ lên Canvas để resize
        const canvas = document.createElement('canvas');
        canvas.width = width;
        canvas.height = height;
        
        const ctx = canvas.getContext('2d');
        if (!ctx) {
          reject(new Error('Không thể tạo context canvas'));
          return;
        }
        
        ctx.drawImage(img, 0, 0, width, height);
        
        // Xuất ra Blob dạng WebP
        canvas.toBlob(
          (blob) => {
            if (blob) {
              resolve(blob);
            } else {
              reject(new Error('Lỗi nén ảnh'));
            }
          },
          'image/webp',
          quality
        );
      };
      
      img.onerror = (err) => reject(err);
    };
    
    reader.onerror = (err) => reject(err);
  });
};
```

## File: src/lib/supabase/client.ts
```typescript
import { createBrowserClient } from '@supabase/ssr'
import { Database } from '@/types/supabase'

export function createClient() {
  return createBrowserClient<Database>(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
  )
}
```

## File: src/lib/supabase/server.ts
```typescript
import { createServerClient } from '@supabase/ssr'
import { cookies } from 'next/headers'
import { Database } from '@/types/supabase'

export async function createClient() {
  const cookieStore = await cookies()

  return createServerClient<Database>(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        getAll() {
          return cookieStore.getAll()
        },
        setAll(cookiesToSet) {
          try {
            cookiesToSet.forEach(({ name, value, options }) =>
              cookieStore.set(name, value, options)
            )
          } catch {
            // The `setAll` method was called from a Server Component.
            // This can be ignored if you have middleware refreshing
            // user sessions.
          }
        },
      },
    }
  )
}
```

## File: src/lib/utils.ts
```typescript
// src/lib/utils.ts
import { type ClassValue, clsx } from "clsx"
import { twMerge } from "tailwind-merge"
import { differenceInMinutes } from 'date-fns';

export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs))
}

// Hàm format tiền tệ cho gọn
export const fmtMoney = (amount: number) => {
  return new Intl.NumberFormat('vi-VN').format(amount) + ' VNĐ';
};

export const formatDuration = (minutes: number) => {
    const h = Math.floor(minutes / 60);
    const m = minutes % 60;
    
    if (h > 0) {
        return `${h}h${m > 0 ? `${m}p` : ''}`; // Ví dụ: 2h39p hoặc 2h
    }
    return `${m}p`; // Ví dụ: 45p
};
export const calculateBilling = (
    bookedStart: Date,
    bookedEnd: Date,
    actualIn: Date | null,
    actualOut: Date | null,
    pricePerHour: number,
    settings: { earlyGrace: number; otFree: number }
) => {
    let totalSurcharge = 0;

    const earlyFee = {
        isBillable: false,
        minutes: 0,
        billableHours: 0,
        amount: 0,
        message: ''
    };

    const otFee = {
        isBillable: false,
        minutes: 0,
        billableHours: 0,
        amount: 0,
        message: ''
    };

    // 1. Logic Check-in Sớm
    if (actualIn) {
        const earlyMinutes = differenceInMinutes(bookedStart, actualIn);
        earlyFee.minutes = earlyMinutes;

        if (earlyMinutes > settings.earlyGrace) {
            // Logic: Làm tròn lên mỗi 15p
            const billableMinutes = Math.ceil(earlyMinutes / 15) * 15;
            const billableHours = billableMinutes / 60;
            
            earlyFee.isBillable = true;
            earlyFee.billableHours = billableHours;
            earlyFee.amount = billableHours * pricePerHour;
            
            // SỬ DỤNG formatDuration để hiển thị
            earlyFee.message = `Sớm ${formatDuration(earlyMinutes)} (Tính ${billableHours}h)`;
            
            totalSurcharge += earlyFee.amount;
        }
    }

    // 2. Logic OT (Check-out Trễ)
    const checkOutTime = actualOut || new Date(); 
    if (checkOutTime > bookedEnd) {
        const otMinutes = differenceInMinutes(checkOutTime, bookedEnd);
        otFee.minutes = otMinutes;

        if (otMinutes > settings.otFree) {
            // Logic: Tính tròn giờ (làm tròn xuống)
            const otHours = Math.floor(otMinutes / 60);
            
            if (otHours > 0) {
                otFee.isBillable = true;
                otFee.billableHours = otHours;
                otFee.amount = otHours * pricePerHour;

                // SỬ DỤNG formatDuration để hiển thị
                otFee.message = `Trễ ${formatDuration(otMinutes)} (Tính ${otHours}h)`;
                
                totalSurcharge += otFee.amount;
            }
        }
    }

    return { 
        totalSurcharge, 
        earlyFee, 
        otFee 
    };
};
```

## File: src/middleware.ts
```typescript
// src/middleware.ts
import { createServerClient } from '@supabase/ssr';
import { NextResponse, type NextRequest } from 'next/server';

export async function middleware(request: NextRequest) {
  // 1. Khởi tạo Response
  let response = NextResponse.next({
    request: {
      headers: request.headers,
    },
  });

  // 2. Khởi tạo Supabase Client cho Middleware
  // Logic này giúp đọc/ghi cookie phiên đăng nhập một cách an toàn trên Server
  const supabase = createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        getAll() {
          return request.cookies.getAll();
        },
        setAll(cookiesToSet) {
          cookiesToSet.forEach(({ name, value }) =>
            request.cookies.set(name, value)
          );
          response = NextResponse.next({
            request,
          });
          cookiesToSet.forEach(({ name, value, options }) =>
            response.cookies.set(name, value, options)
          );
        },
      },
    }
  );

  // 3. Kiểm tra User (Quan trọng: dùng getUser thay vì getSession để bảo mật hơn)
  // getUser sẽ xác thực lại với Auth Server xem token còn sống không
  const {
    data: { user },
  } = await supabase.auth.getUser();

  const url = request.nextUrl.clone();

  // --- QUY TẮC BẢO MẬT ---

  // TRƯỜNG HỢP 1: Đang cố vào trang Admin (/admin/*)
  if (url.pathname.startsWith('/admin')) {
    // Nếu chưa đăng nhập -> Đá về trang Login
    if (!user) {
      url.pathname = '/login';
      // Lưu lại trang họ định vào để sau khi login xong thì redirect lại đó (Optional)
      url.searchParams.set('next', request.nextUrl.pathname);
      return NextResponse.redirect(url);
    }
    
    // (Tùy chọn) Nếu bạn có phân quyền (VD: user thường vs admin)
    // Thì check thêm role ở đây. Nếu chỉ có 1 admin là bạn thì không cần.
  }

  // TRƯỜNG HỢP 2: Đang cố vào trang Login (/login)
  if (url.pathname === '/login') {
    // Nếu ĐÃ đăng nhập rồi -> Không cho vào login nữa, đá thẳng vào Admin
    if (user) {
      url.pathname = '/admin'; 
      return NextResponse.redirect(url);
    }
  }

  // Nếu hợp lệ, cho đi tiếp
  return response;
}

// Cấu hình để Middleware chỉ chạy trên các route cần thiết
// Giúp tối ưu hiệu năng, không chạy trên file ảnh, static file...
export const config = {
  matcher: [
    /*
     * Match tất cả request paths ngoại trừ:
     * - _next/static (static files)
     * - _next/image (image optimization files)
     * - favicon.ico (favicon file)
     * - images (public images)
     * - public folder
     */
    '/((?!_next/static|_next/image|favicon.ico|.*\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)',
  ],
};
```

## File: src/types/grid-project.ts
```typescript
// src/types/grid-project.ts
import { StaticImageData } from 'next/image';

/**
 * Đây là cấu trúc dữ liệu mà PortfolioGrid sẽ nhận.
 * Nó bao gồm cả dữ liệu hiển thị (title, src)
 * và dữ liệu layout (colSpan, rowSpan)
 * và dữ liệu hành vi (slug).
 */
export interface GridProject {
  id: number | string;
  src: StaticImageData | string;
  title: string;
  category: string;
  
  // Dành cho layout
  colSpan: string;
  rowSpan: string;
  
  // Dành cho link chi tiết
  slug: string; 
}
```

## File: src/types/supabase.ts
```typescript
export type Json =
  | string
  | number
  | boolean
  | null
  | { [key: string]: Json | undefined }
  | Json[]

export type Database = {
  // Allows to automatically instantiate createClient with right options
  // instead of createClient<Database, { PostgrestVersion: 'XX' }>(URL, KEY)
  __InternalSupabase: {
    PostgrestVersion: "14.1"
  }
  public: {
    Tables: {
      booking_items: {
        Row: {
          booking_id: number
          booking_item_id: number
          cleanup_minutes: number | null
          created_at: string | null
          end_dt: string
          is_all_day: boolean | null
          price_snapshot: number | null
          room_id: number
          start_dt: string
        }
        Insert: {
          booking_id: number
          booking_item_id?: number
          cleanup_minutes?: number | null
          created_at?: string | null
          end_dt: string
          is_all_day?: boolean | null
          price_snapshot?: number | null
          room_id: number
          start_dt: string
        }
        Update: {
          booking_id?: number
          booking_item_id?: number
          cleanup_minutes?: number | null
          created_at?: string | null
          end_dt?: string
          is_all_day?: boolean | null
          price_snapshot?: number | null
          room_id?: number
          start_dt?: string
        }
        Relationships: [
          {
            foreignKeyName: "booking_items_booking_id_fkey"
            columns: ["booking_id"]
            isOneToOne: false
            referencedRelation: "bookings"
            referencedColumns: ["booking_id"]
          },
          {
            foreignKeyName: "booking_items_room_id_fkey"
            columns: ["room_id"]
            isOneToOne: false
            referencedRelation: "rooms"
            referencedColumns: ["room_id"]
          },
        ]
      }
      booking_services: {
        Row: {
          booking_id: number
          booking_service_id: number
          computed_amount: number | null
          created_at: string | null
          quantity: number
          service_id: number
          type: Database["public"]["Enums"]["service_type"]
          unit_price_snapshot: number
        }
        Insert: {
          booking_id: number
          booking_service_id?: number
          computed_amount?: number | null
          created_at?: string | null
          quantity?: number
          service_id: number
          type?: Database["public"]["Enums"]["service_type"]
          unit_price_snapshot?: number
        }
        Update: {
          booking_id?: number
          booking_service_id?: number
          computed_amount?: number | null
          created_at?: string | null
          quantity?: number
          service_id?: number
          type?: Database["public"]["Enums"]["service_type"]
          unit_price_snapshot?: number
        }
        Relationships: [
          {
            foreignKeyName: "booking_services_booking_id_fkey"
            columns: ["booking_id"]
            isOneToOne: false
            referencedRelation: "bookings"
            referencedColumns: ["booking_id"]
          },
          {
            foreignKeyName: "booking_services_service_id_fkey"
            columns: ["service_id"]
            isOneToOne: false
            referencedRelation: "services"
            referencedColumns: ["service_id"]
          },
        ]
      }
      bookings: {
        Row: {
          booking_id: number
          booking_type: string | null
          check_in_at: string | null
          check_out_at: string | null
          created_at: string | null
          created_by: number | null
          customer_id: number | null
          deposit_amount: number | null
          deposit_paid: number | null
          discount_amount: number | null
          discount_reason: string | null
          notes: string | null
          status: Database["public"]["Enums"]["booking_status"] | null
          title: string | null
          total_actual: number | null
          total_estimate: number | null
          updated_at: string | null
          vat_percent_snapshot: number | null
          voucher_code: string | null
        }
        Insert: {
          booking_id?: number
          booking_type?: string | null
          check_in_at?: string | null
          check_out_at?: string | null
          created_at?: string | null
          created_by?: number | null
          customer_id?: number | null
          deposit_amount?: number | null
          deposit_paid?: number | null
          discount_amount?: number | null
          discount_reason?: string | null
          notes?: string | null
          status?: Database["public"]["Enums"]["booking_status"] | null
          title?: string | null
          total_actual?: number | null
          total_estimate?: number | null
          updated_at?: string | null
          vat_percent_snapshot?: number | null
          voucher_code?: string | null
        }
        Update: {
          booking_id?: number
          booking_type?: string | null
          check_in_at?: string | null
          check_out_at?: string | null
          created_at?: string | null
          created_by?: number | null
          customer_id?: number | null
          deposit_amount?: number | null
          deposit_paid?: number | null
          discount_amount?: number | null
          discount_reason?: string | null
          notes?: string | null
          status?: Database["public"]["Enums"]["booking_status"] | null
          title?: string | null
          total_actual?: number | null
          total_estimate?: number | null
          updated_at?: string | null
          vat_percent_snapshot?: number | null
          voucher_code?: string | null
        }
        Relationships: [
          {
            foreignKeyName: "bookings_created_by_fkey"
            columns: ["created_by"]
            isOneToOne: false
            referencedRelation: "users"
            referencedColumns: ["user_id"]
          },
          {
            foreignKeyName: "bookings_customer_id_fkey"
            columns: ["customer_id"]
            isOneToOne: false
            referencedRelation: "customers"
            referencedColumns: ["customer_id"]
          },
        ]
      }
      branches: {
        Row: {
          address: string | null
          branch_code: string
          branch_id: number
          created_at: string | null
          is_active: boolean | null
          name: string
          phone: string | null
          timezone: string | null
        }
        Insert: {
          address?: string | null
          branch_code: string
          branch_id?: number
          created_at?: string | null
          is_active?: boolean | null
          name: string
          phone?: string | null
          timezone?: string | null
        }
        Update: {
          address?: string | null
          branch_code?: string
          branch_id?: number
          created_at?: string | null
          is_active?: boolean | null
          name?: string
          phone?: string | null
          timezone?: string | null
        }
        Relationships: []
      }
      customers: {
        Row: {
          address: string | null
          cccd: string | null
          company_name: string | null
          created_at: string
          customer_id: number
          customer_type: Database["public"]["Enums"]["customer_type"]
          discount_rate: number | null
          email: string | null
          full_name: string
          is_active: boolean
          note: string | null
          phone: string | null
          tax_code: string | null
        }
        Insert: {
          address?: string | null
          cccd?: string | null
          company_name?: string | null
          created_at?: string
          customer_id?: number
          customer_type?: Database["public"]["Enums"]["customer_type"]
          discount_rate?: number | null
          email?: string | null
          full_name: string
          is_active?: boolean
          note?: string | null
          phone?: string | null
          tax_code?: string | null
        }
        Update: {
          address?: string | null
          cccd?: string | null
          company_name?: string | null
          created_at?: string
          customer_id?: number
          customer_type?: Database["public"]["Enums"]["customer_type"]
          discount_rate?: number | null
          email?: string | null
          full_name?: string
          is_active?: boolean
          note?: string | null
          phone?: string | null
          tax_code?: string | null
        }
        Relationships: []
      }
      employee_profiles: {
        Row: {
          base_salary: number | null
          contract_type: string | null
          created_at: string
          dob: string | null
          employee_id: number
          employment_status:
            | Database["public"]["Enums"]["employment_status"]
            | null
          hire_date: string | null
          salary_type: string | null
          user_id: number
        }
        Insert: {
          base_salary?: number | null
          contract_type?: string | null
          created_at?: string
          dob?: string | null
          employee_id?: number
          employment_status?:
            | Database["public"]["Enums"]["employment_status"]
            | null
          hire_date?: string | null
          salary_type?: string | null
          user_id: number
        }
        Update: {
          base_salary?: number | null
          contract_type?: string | null
          created_at?: string
          dob?: string | null
          employee_id?: number
          employment_status?:
            | Database["public"]["Enums"]["employment_status"]
            | null
          hire_date?: string | null
          salary_type?: string | null
          user_id?: number
        }
        Relationships: [
          {
            foreignKeyName: "employee_profiles_user_id_fkey"
            columns: ["user_id"]
            isOneToOne: true
            referencedRelation: "users"
            referencedColumns: ["user_id"]
          },
        ]
      }
      equipment_items: {
        Row: {
          condition: Database["public"]["Enums"]["item_condition"] | null
          created_at: string | null
          current_room_id: number | null
          item_id: number
          model_id: number
          qr_code: string
          serial_number: string | null
          status: Database["public"]["Enums"]["item_status"]
        }
        Insert: {
          condition?: Database["public"]["Enums"]["item_condition"] | null
          created_at?: string | null
          current_room_id?: number | null
          item_id?: number
          model_id: number
          qr_code: string
          serial_number?: string | null
          status?: Database["public"]["Enums"]["item_status"]
        }
        Update: {
          condition?: Database["public"]["Enums"]["item_condition"] | null
          created_at?: string | null
          current_room_id?: number | null
          item_id?: number
          model_id?: number
          qr_code?: string
          serial_number?: string | null
          status?: Database["public"]["Enums"]["item_status"]
        }
        Relationships: [
          {
            foreignKeyName: "equipment_items_current_room_id_fkey"
            columns: ["current_room_id"]
            isOneToOne: false
            referencedRelation: "rooms"
            referencedColumns: ["room_id"]
          },
          {
            foreignKeyName: "equipment_items_model_id_fkey"
            columns: ["model_id"]
            isOneToOne: false
            referencedRelation: "equipment_models"
            referencedColumns: ["model_id"]
          },
        ]
      }
      equipment_models: {
        Row: {
          available_quantity: number | null
          created_at: string | null
          default_hourly_price: number | null
          description: string | null
          is_active: boolean | null
          model_id: number
          name: string
          sku: string | null
          total_quantity: number | null
        }
        Insert: {
          available_quantity?: number | null
          created_at?: string | null
          default_hourly_price?: number | null
          description?: string | null
          is_active?: boolean | null
          model_id?: number
          name: string
          sku?: string | null
          total_quantity?: number | null
        }
        Update: {
          available_quantity?: number | null
          created_at?: string | null
          default_hourly_price?: number | null
          description?: string | null
          is_active?: boolean | null
          model_id?: number
          name?: string
          sku?: string | null
          total_quantity?: number | null
        }
        Relationships: []
      }
      files: {
        Row: {
          file_id: number
          file_name: string
          file_type: string | null
          file_url: string
          is_archive: boolean | null
          uploaded_at: string | null
          uploaded_by: number | null
        }
        Insert: {
          file_id?: number
          file_name: string
          file_type?: string | null
          file_url: string
          is_archive?: boolean | null
          uploaded_at?: string | null
          uploaded_by?: number | null
        }
        Update: {
          file_id?: number
          file_name?: string
          file_type?: string | null
          file_url?: string
          is_archive?: boolean | null
          uploaded_at?: string | null
          uploaded_by?: number | null
        }
        Relationships: [
          {
            foreignKeyName: "files_uploaded_by_fkey"
            columns: ["uploaded_by"]
            isOneToOne: false
            referencedRelation: "users"
            referencedColumns: ["user_id"]
          },
        ]
      }
      invoices: {
        Row: {
          booking_id: number
          created_at: string | null
          customer_id: number
          invoice_id: number
          issue_date: string | null
          paid_status: Database["public"]["Enums"]["invoice_status"] | null
          pdf_url: string | null
          qr_code_url: string | null
          subtotal: number
          total_amount: number
          vat_amount: number | null
        }
        Insert: {
          booking_id: number
          created_at?: string | null
          customer_id: number
          invoice_id?: number
          issue_date?: string | null
          paid_status?: Database["public"]["Enums"]["invoice_status"] | null
          pdf_url?: string | null
          qr_code_url?: string | null
          subtotal: number
          total_amount: number
          vat_amount?: number | null
        }
        Update: {
          booking_id?: number
          created_at?: string | null
          customer_id?: number
          invoice_id?: number
          issue_date?: string | null
          paid_status?: Database["public"]["Enums"]["invoice_status"] | null
          pdf_url?: string | null
          qr_code_url?: string | null
          subtotal?: number
          total_amount?: number
          vat_amount?: number | null
        }
        Relationships: [
          {
            foreignKeyName: "invoices_booking_id_fkey"
            columns: ["booking_id"]
            isOneToOne: false
            referencedRelation: "bookings"
            referencedColumns: ["booking_id"]
          },
          {
            foreignKeyName: "invoices_customer_id_fkey"
            columns: ["customer_id"]
            isOneToOne: false
            referencedRelation: "customers"
            referencedColumns: ["customer_id"]
          },
        ]
      }
      notifications: {
        Row: {
          body: string | null
          created_at: string | null
          is_read: boolean | null
          notification_id: number
          title: string
          type: string | null
          user_id: number | null
        }
        Insert: {
          body?: string | null
          created_at?: string | null
          is_read?: boolean | null
          notification_id?: number
          title: string
          type?: string | null
          user_id?: number | null
        }
        Update: {
          body?: string | null
          created_at?: string | null
          is_read?: boolean | null
          notification_id?: number
          title?: string
          type?: string | null
          user_id?: number | null
        }
        Relationships: [
          {
            foreignKeyName: "notifications_user_id_fkey"
            columns: ["user_id"]
            isOneToOne: false
            referencedRelation: "users"
            referencedColumns: ["user_id"]
          },
        ]
      }
      payments: {
        Row: {
          amount: number
          booking_id: number | null
          created_at: string | null
          customer_id: number | null
          method: Database["public"]["Enums"]["payment_method"] | null
          note: string | null
          parent_payment_id: number | null
          payment_id: number
          status: Database["public"]["Enums"]["payment_status"] | null
        }
        Insert: {
          amount: number
          booking_id?: number | null
          created_at?: string | null
          customer_id?: number | null
          method?: Database["public"]["Enums"]["payment_method"] | null
          note?: string | null
          parent_payment_id?: number | null
          payment_id?: number
          status?: Database["public"]["Enums"]["payment_status"] | null
        }
        Update: {
          amount?: number
          booking_id?: number | null
          created_at?: string | null
          customer_id?: number | null
          method?: Database["public"]["Enums"]["payment_method"] | null
          note?: string | null
          parent_payment_id?: number | null
          payment_id?: number
          status?: Database["public"]["Enums"]["payment_status"] | null
        }
        Relationships: [
          {
            foreignKeyName: "payments_booking_id_fkey"
            columns: ["booking_id"]
            isOneToOne: false
            referencedRelation: "bookings"
            referencedColumns: ["booking_id"]
          },
          {
            foreignKeyName: "payments_customer_id_fkey"
            columns: ["customer_id"]
            isOneToOne: false
            referencedRelation: "customers"
            referencedColumns: ["customer_id"]
          },
          {
            foreignKeyName: "payments_parent_payment_id_fkey"
            columns: ["parent_payment_id"]
            isOneToOne: false
            referencedRelation: "payments"
            referencedColumns: ["payment_id"]
          },
        ]
      }
      portfolio_categories: {
        Row: {
          category_id: number
          display_order: number | null
          is_active: boolean | null
          name: string
          slug: string
        }
        Insert: {
          category_id?: number
          display_order?: number | null
          is_active?: boolean | null
          name: string
          slug: string
        }
        Update: {
          category_id?: number
          display_order?: number | null
          is_active?: boolean | null
          name?: string
          slug?: string
        }
        Relationships: []
      }
      project_images: {
        Row: {
          alt_text: string | null
          created_by: number | null
          display_order: number | null
          height: number | null
          image_id: number
          image_url: string
          project_id: number
          width: number | null
        }
        Insert: {
          alt_text?: string | null
          created_by?: number | null
          display_order?: number | null
          height?: number | null
          image_id?: number
          image_url: string
          project_id: number
          width?: number | null
        }
        Update: {
          alt_text?: string | null
          created_by?: number | null
          display_order?: number | null
          height?: number | null
          image_id?: number
          image_url?: string
          project_id?: number
          width?: number | null
        }
        Relationships: [
          {
            foreignKeyName: "project_images_created_by_fkey"
            columns: ["created_by"]
            isOneToOne: false
            referencedRelation: "users"
            referencedColumns: ["user_id"]
          },
          {
            foreignKeyName: "project_images_project_id_fkey"
            columns: ["project_id"]
            isOneToOne: false
            referencedRelation: "projects"
            referencedColumns: ["project_id"]
          },
        ]
      }
      projects: {
        Row: {
          category_id: number
          client_name: string | null
          col_span: number | null
          content: Json | null
          cover_url: string | null
          created_at: string | null
          created_by: number | null
          credits: Json | null
          description: string | null
          display_order: number | null
          is_demo: boolean | null
          is_featured: boolean | null
          project_id: number
          published_at: string | null
          row_span: number | null
          slug: string
          thumbnail_url: string | null
          title: string
          updated_at: string | null
        }
        Insert: {
          category_id: number
          client_name?: string | null
          col_span?: number | null
          content?: Json | null
          cover_url?: string | null
          created_at?: string | null
          created_by?: number | null
          credits?: Json | null
          description?: string | null
          display_order?: number | null
          is_demo?: boolean | null
          is_featured?: boolean | null
          project_id?: number
          published_at?: string | null
          row_span?: number | null
          slug: string
          thumbnail_url?: string | null
          title: string
          updated_at?: string | null
        }
        Update: {
          category_id?: number
          client_name?: string | null
          col_span?: number | null
          content?: Json | null
          cover_url?: string | null
          created_at?: string | null
          created_by?: number | null
          credits?: Json | null
          description?: string | null
          display_order?: number | null
          is_demo?: boolean | null
          is_featured?: boolean | null
          project_id?: number
          published_at?: string | null
          row_span?: number | null
          slug?: string
          thumbnail_url?: string | null
          title?: string
          updated_at?: string | null
        }
        Relationships: [
          {
            foreignKeyName: "projects_category_id_fkey"
            columns: ["category_id"]
            isOneToOne: false
            referencedRelation: "portfolio_categories"
            referencedColumns: ["category_id"]
          },
          {
            foreignKeyName: "projects_created_by_fkey"
            columns: ["created_by"]
            isOneToOne: false
            referencedRelation: "users"
            referencedColumns: ["user_id"]
          },
        ]
      }
      rooms: {
        Row: {
          branch_id: number
          capacity: number | null
          code: string
          created_at: string | null
          is_equipment_room: boolean | null
          is_rentable: boolean | null
          name: string | null
          price_per_hour: number | null
          room_id: number
          status: Database["public"]["Enums"]["room_status"]
        }
        Insert: {
          branch_id: number
          capacity?: number | null
          code: string
          created_at?: string | null
          is_equipment_room?: boolean | null
          is_rentable?: boolean | null
          name?: string | null
          price_per_hour?: number | null
          room_id?: number
          status?: Database["public"]["Enums"]["room_status"]
        }
        Update: {
          branch_id?: number
          capacity?: number | null
          code?: string
          created_at?: string | null
          is_equipment_room?: boolean | null
          is_rentable?: boolean | null
          name?: string | null
          price_per_hour?: number | null
          room_id?: number
          status?: Database["public"]["Enums"]["room_status"]
        }
        Relationships: [
          {
            foreignKeyName: "rooms_branch_id_fkey"
            columns: ["branch_id"]
            isOneToOne: false
            referencedRelation: "branches"
            referencedColumns: ["branch_id"]
          },
        ]
      }
      services: {
        Row: {
          category: string | null
          is_active: boolean | null
          name: string
          price: number
          service_id: number
          type: Database["public"]["Enums"]["service_type"]
          unit: string | null
        }
        Insert: {
          category?: string | null
          is_active?: boolean | null
          name: string
          price?: number
          service_id?: number
          type?: Database["public"]["Enums"]["service_type"]
          unit?: string | null
        }
        Update: {
          category?: string | null
          is_active?: boolean | null
          name?: string
          price?: number
          service_id?: number
          type?: Database["public"]["Enums"]["service_type"]
          unit?: string | null
        }
        Relationships: []
      }
      settings: {
        Row: {
          description: string | null
          key: string
          updated_at: string | null
          value: string | null
        }
        Insert: {
          description?: string | null
          key: string
          updated_at?: string | null
          value?: string | null
        }
        Update: {
          description?: string | null
          key?: string
          updated_at?: string | null
          value?: string | null
        }
        Relationships: []
      }
      users: {
        Row: {
          auth_id: string | null
          created_at: string
          email: string | null
          full_name: string | null
          is_active: boolean | null
          phone: string | null
          role: Database["public"]["Enums"]["user_role"]
          status: Database["public"]["Enums"]["user_status"]
          updated_at: string | null
          user_id: number
          username: string
        }
        Insert: {
          auth_id?: string | null
          created_at?: string
          email?: string | null
          full_name?: string | null
          is_active?: boolean | null
          phone?: string | null
          role?: Database["public"]["Enums"]["user_role"]
          status?: Database["public"]["Enums"]["user_status"]
          updated_at?: string | null
          user_id?: number
          username: string
        }
        Update: {
          auth_id?: string | null
          created_at?: string
          email?: string | null
          full_name?: string | null
          is_active?: boolean | null
          phone?: string | null
          role?: Database["public"]["Enums"]["user_role"]
          status?: Database["public"]["Enums"]["user_status"]
          updated_at?: string | null
          user_id?: number
          username?: string
        }
        Relationships: []
      }
    }
    Views: {
      [_ in never]: never
    }
    Functions: {
      [_ in never]: never
    }
    Enums: {
      booking_status:
        | "pending"
        | "confirmed"
        | "checked_in"
        | "checked_out"
        | "completed"
        | "cancelled"
        | "paid"
      customer_type: "regular" | "vip" | "corporate"
      employment_status: "active" | "inactive" | "terminated"
      invoice_status: "unpaid" | "partial" | "paid"
      item_condition: "new" | "good" | "fair" | "damaged"
      item_status:
        | "available"
        | "in_studio_assigned"
        | "rented_out"
        | "under_maintenance"
        | "retired"
        | "lost"
      payment_method: "cash" | "transfer" | "qr" | "card"
      payment_status: "pending" | "completed" | "failed" | "refunded"
      room_status: "available" | "maintenance" | "inactive"
      service_type: "service" | "surcharge" | "compensation"
      user_role: "Admin" | "Staff"
      user_status: "active" | "inactive" | "banned"
    }
    CompositeTypes: {
      [_ in never]: never
    }
  }
}

type DatabaseWithoutInternals = Omit<Database, "__InternalSupabase">

type DefaultSchema = DatabaseWithoutInternals[Extract<keyof Database, "public">]

export type Tables<
  DefaultSchemaTableNameOrOptions extends
    | keyof (DefaultSchema["Tables"] & DefaultSchema["Views"])
    | { schema: keyof DatabaseWithoutInternals },
  TableName extends DefaultSchemaTableNameOrOptions extends {
    schema: keyof DatabaseWithoutInternals
  }
    ? keyof (DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Tables"] &
        DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Views"])
    : never = never,
> = DefaultSchemaTableNameOrOptions extends {
  schema: keyof DatabaseWithoutInternals
}
  ? (DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Tables"] &
      DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Views"])[TableName] extends {
      Row: infer R
    }
    ? R
    : never
  : DefaultSchemaTableNameOrOptions extends keyof (DefaultSchema["Tables"] &
        DefaultSchema["Views"])
    ? (DefaultSchema["Tables"] &
        DefaultSchema["Views"])[DefaultSchemaTableNameOrOptions] extends {
        Row: infer R
      }
      ? R
      : never
    : never

export type TablesInsert<
  DefaultSchemaTableNameOrOptions extends
    | keyof DefaultSchema["Tables"]
    | { schema: keyof DatabaseWithoutInternals },
  TableName extends DefaultSchemaTableNameOrOptions extends {
    schema: keyof DatabaseWithoutInternals
  }
    ? keyof DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Tables"]
    : never = never,
> = DefaultSchemaTableNameOrOptions extends {
  schema: keyof DatabaseWithoutInternals
}
  ? DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Tables"][TableName] extends {
      Insert: infer I
    }
    ? I
    : never
  : DefaultSchemaTableNameOrOptions extends keyof DefaultSchema["Tables"]
    ? DefaultSchema["Tables"][DefaultSchemaTableNameOrOptions] extends {
        Insert: infer I
      }
      ? I
      : never
    : never

export type TablesUpdate<
  DefaultSchemaTableNameOrOptions extends
    | keyof DefaultSchema["Tables"]
    | { schema: keyof DatabaseWithoutInternals },
  TableName extends DefaultSchemaTableNameOrOptions extends {
    schema: keyof DatabaseWithoutInternals
  }
    ? keyof DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Tables"]
    : never = never,
> = DefaultSchemaTableNameOrOptions extends {
  schema: keyof DatabaseWithoutInternals
}
  ? DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Tables"][TableName] extends {
      Update: infer U
    }
    ? U
    : never
  : DefaultSchemaTableNameOrOptions extends keyof DefaultSchema["Tables"]
    ? DefaultSchema["Tables"][DefaultSchemaTableNameOrOptions] extends {
        Update: infer U
      }
      ? U
      : never
    : never

export type Enums<
  DefaultSchemaEnumNameOrOptions extends
    | keyof DefaultSchema["Enums"]
    | { schema: keyof DatabaseWithoutInternals },
  EnumName extends DefaultSchemaEnumNameOrOptions extends {
    schema: keyof DatabaseWithoutInternals
  }
    ? keyof DatabaseWithoutInternals[DefaultSchemaEnumNameOrOptions["schema"]]["Enums"]
    : never = never,
> = DefaultSchemaEnumNameOrOptions extends {
  schema: keyof DatabaseWithoutInternals
}
  ? DatabaseWithoutInternals[DefaultSchemaEnumNameOrOptions["schema"]]["Enums"][EnumName]
  : DefaultSchemaEnumNameOrOptions extends keyof DefaultSchema["Enums"]
    ? DefaultSchema["Enums"][DefaultSchemaEnumNameOrOptions]
    : never

export type CompositeTypes<
  PublicCompositeTypeNameOrOptions extends
    | keyof DefaultSchema["CompositeTypes"]
    | { schema: keyof DatabaseWithoutInternals },
  CompositeTypeName extends PublicCompositeTypeNameOrOptions extends {
    schema: keyof DatabaseWithoutInternals
  }
    ? keyof DatabaseWithoutInternals[PublicCompositeTypeNameOrOptions["schema"]]["CompositeTypes"]
    : never = never,
> = PublicCompositeTypeNameOrOptions extends {
  schema: keyof DatabaseWithoutInternals
}
  ? DatabaseWithoutInternals[PublicCompositeTypeNameOrOptions["schema"]]["CompositeTypes"][CompositeTypeName]
  : PublicCompositeTypeNameOrOptions extends keyof DefaultSchema["CompositeTypes"]
    ? DefaultSchema["CompositeTypes"][PublicCompositeTypeNameOrOptions]
    : never

export const Constants = {
  public: {
    Enums: {
      booking_status: [
        "pending",
        "confirmed",
        "checked_in",
        "checked_out",
        "completed",
        "cancelled",
        "paid",
      ],
      customer_type: ["regular", "vip", "corporate"],
      employment_status: ["active", "inactive", "terminated"],
      invoice_status: ["unpaid", "partial", "paid"],
      item_condition: ["new", "good", "fair", "damaged"],
      item_status: [
        "available",
        "in_studio_assigned",
        "rented_out",
        "under_maintenance",
        "retired",
        "lost",
      ],
      payment_method: ["cash", "transfer", "qr", "card"],
      payment_status: ["pending", "completed", "failed", "refunded"],
      room_status: ["available", "maintenance", "inactive"],
      service_type: ["service", "surcharge", "compensation"],
      user_role: ["Admin", "Staff"],
      user_status: ["active", "inactive", "banned"],
    },
  },
} as const
```

## File: tailwind.config.ts
```typescript
// tailwind.config.ts
import type { Config } from 'tailwindcss';

const config: Config = {
  content: [
    './src/pages/**/*.{js,ts,jsx,tsx,mdx}',
    './src/components/**/*.{js,ts,jsx,tsx,mdx}',
    './src/app/**/*.{js,ts,jsx,tsx,mdx}',
  ],
  // THÊM DÒNG NÀY
  darkMode: 'class', 
  theme: {
    extend: {
      //...
    },
  },
  plugins: [],
};
export default config;
```

## File: tsconfig.json
```json
{
  "compilerOptions": {
    "target": "ES2017",
    "lib": ["dom", "dom.iterable", "esnext"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "preserve",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/*": ["./src/*"]
    }
  },
  "include": ["next-env.d.ts", "**/*.ts", "**/*.tsx", ".next/types/**/*.ts"],
  "exclude": ["node_modules"]
}
```

## File: src/app/admin/grid/page.tsx
```typescript
// src/app/admin/grid/page.tsx
import { getProjects } from '@/lib/actions';
import PortfolioGridEditor from '@/components/admin/PortfolioGridEditor';
import { LayoutTemplate, AlertTriangle } from 'lucide-react';
import Link from 'next/link';

export const dynamic = 'force-dynamic';

export default async function PortfolioGridPage() {
  // 1. Lấy dữ liệu
  const allProjects = await getProjects('all');
  
  // 2. Lọc lấy các dự án Nổi bật (Featured)
  // Chỉ những dự án này mới xuất hiện ngoài Grid trang chủ
  const featuredProjects = allProjects.filter(p => p.isFeatured);

  return (
    <div className="max-w-7xl mx-auto pb-20 space-y-8">
      {/* Header */}
      <div>
        <h1 className="text-3xl font-bold text-[var(--admin-fg)] flex items-center gap-3">
          <LayoutTemplate className="text-[var(--admin-primary)]" size={32} />
          Bố cục dự án Nổi bật
        </h1>
        <p className="text-[var(--admin-sub)] mt-2 max-w-2xl">
          Tinh chỉnh kích thước hiển thị cho các dự án <strong>Nổi bật</strong> trên trang chủ.
        </p>
      </div>

      {/* Main Content */}
      {featuredProjects.length > 0 ? (
        <PortfolioGridEditor initialProjects={featuredProjects} />
      ) : (
        // Empty State (Khi chưa chọn dự án nổi bật nào)
        <div className="flex flex-col items-center justify-center p-12 text-center border-2 border-dashed border-[var(--admin-border)] rounded-2xl bg-[var(--admin-card)]/50">
          <div className="w-16 h-16 bg-yellow-100 text-yellow-600 rounded-full flex items-center justify-center mb-4">
            <AlertTriangle size={32} />
          </div>
          <h3 className="text-xl font-semibold text-[var(--admin-fg)]">Chưa có dự án Nổi bật</h3>
          <p className="text-[var(--admin-sub)] mt-2 mb-6 max-w-md">
            Bạn cần đánh dấu <strong>Nổi bật</strong> cho ít nhất một dự án để có thể sắp xếp bố cục.
          </p>
          <Link 
            href="/admin/projects" 
            className="px-6 py-2.5 bg-[var(--admin-primary)] text-white font-medium rounded-lg hover:opacity-90 transition-all shadow-lg shadow-indigo-500/30"
          >
            Đến danh sách dự án
          </Link>
        </div>
      )}
    </div>
  );
}
```

## File: src/app/admin/projects/[id]/page.tsx
```typescript
// src/app/admin/projects/[id]/page.tsx
import { getProjectById } from '@/lib/actions';
import ProjectForm, { ProjectInitialData, BlockDB } from '@/components/admin/ProjectForm';
import { notFound } from 'next/navigation';

interface PageProps {
  params: Promise<{ id: string }>;
}

export default async function EditProjectPage({ params }: PageProps) {
  const { id } = await params;
  
  // 1. Lấy dữ liệu từ DB
  const projectRaw = await getProjectById(parseInt(id));

  if (!projectRaw) {
    notFound(); // Trả về trang 404 nếu không tìm thấy
  }

  // 2. Chuyển đổi format DB -> Format Form
  // Cần ép kiểu cẩn thận vì Supabase trả về JSON object thô
  const formattedData: ProjectInitialData = {
    id: projectRaw.project_id,
    title: projectRaw.title,
    client_name: projectRaw.client_name || '',
    description: projectRaw.description || '',
    category_id: projectRaw.category_id?.toString() || '',
    is_featured: projectRaw.is_featured || false,
    thumbnail_url: projectRaw.thumbnail_url || '',
    credits: Array.isArray(projectRaw.credits) ? projectRaw.credits : [],
    content: Array.isArray(projectRaw.content) ? (projectRaw.content as BlockDB[]) : []
  };

  // 3. Render Form
  return <ProjectForm mode="edit" initialData={formattedData} />;
}
```

## File: src/app/styles/ProjectArticle.module.css
```css
/* src/app/styles/ProjectArticle.module.css (CSS mới) */

/* 1. Container chính (Giống Gucci, max-width 3xl) */
.articleContainer {
    max-width: 860px; /* max-w-3xl */
    margin: 0 auto;
    padding: 0 1rem; /* px-4 */
    padding-top: 4rem; /* py-16 */
    padding-bottom: 6rem; /* py-24 */
}

/* 2. Tiêu đề chính */
.articleTitle {
    font-size: 2.25rem; /* text-4xl */
    line-height: 2.5rem;
    font-weight: 300; /* font-light */
    letter-spacing: -0.025em; /* tracking-tighter */
    text-align: center;
    margin-bottom: 1.5rem; /* mb-6 */
    color: var(--foreground);
}

@media (min-width: 768px) {
    .articleTitle {
        font-size: 3rem; /* md:text-5xl */
        line-height: 1;
    }
}

/* 3. Thanh Credits */
.creditsBar {
    border-top: 1px solid rgba(128, 128, 128, 0.2);
    border-bottom: 1px solid rgba(128, 128, 128, 0.2);
    margin-top: 2rem; /* my-8 */
    margin-bottom: 2rem;
    padding-top: 1rem; /* py-4 */
    padding-bottom: 1rem;
}
.creditsList {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 1rem 2rem; /* a/cách 2rem */
    font-size: 0.875rem; /* text-sm */
    color: var(--foreground);
    opacity: 0.8;
}
.creditsList li strong {
    font-weight: 600;
    opacity: 1;
}

/* 4. Khối văn bản (Giống text-wrap) */
.textWrap {
    font-size: 1.125rem; /* text-lg */
    line-height: 1.75rem; /* leading-relaxed */
    color: var(--foreground);
    opacity: 0.9;
    margin-top: 3rem; /* space-y-12 */
    margin-bottom: 3rem;
}
.textWrap p {
    margin-bottom: 1.5rem; /* space-y-6 bên trong */
}

/* 5. Khối Sub-heading (Giống highlight) */
.highlightWrap {
    text-align: center;
    margin-top: 4rem; /* pt-8 + my-12 */
    margin-bottom: 3rem;
}
.highlightWrap h2 {
    font-size: 1.875rem; /* text-3xl */
    line-height: 2.25rem;
    font-weight: 300; /* font-light */
    letter-spacing: -0.025em; /* tracking-tight */
    color: var(--foreground);
}
@media (min-width: 768px) {
    .highlightWrap h2 {
        font-size: 2.25rem; /* md:text-4xl */
    }
}

/* 6. Khối ảnh (Giống image-row) */
.imageRow {
    display: flex;
    flex-direction: column; /* Xếp chồng trên mobile */
    gap: 1rem; /* gap-4 */
    justify-content: center;
    margin-top: 3rem; /* my-8 md:my-12 */
    margin-bottom: 3rem;
}
@media (min-width: 768px) {
    .imageRow {
        flex-direction: row; /* Cạnh nhau trên desktop */
    }
}

/* 7. Giữ lại CSS cho Navigation và Fade-in */
.projectNavigation {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-top: 1px solid rgba(128, 128, 128, 0.2);
    padding-top: 30px;
}
.navLink {
    text-decoration: none;
    color: var(--foreground);
    font-weight: 500;
    padding: 10px 15px;
    transition: all 0.3s ease;
    border-radius: 4px;
}
.navLink:hover:not(.disabled) {
    color: var(--glow-color);
    background-color: rgba(128, 128, 128, 0.1);
}
.navLink.disabled {
    color: var(--foreground);
    opacity: 0.3;
    pointer-events: none;
}
.fade_in_hidden {
    opacity: 0;
    transform: translateY(20px);
    transition: opacity 0.8s ease-out, transform 0.8s ease-out;
}
.fade_in_visible {
    opacity: 1;
    transform: translateY(0);
}
```

## File: src/components/admin/DashboardActions.tsx
```typescript
// src/components/admin/DashboardActions.tsx
'use client';

import { toast } from 'sonner';
import Link from 'next/link';
import { Printer, Plus } from 'lucide-react';

export default function DashboardActions() {
  return (
    <div className="flex gap-3">
      <button onClick={() => toast.info('Tính năng Xuất báo cáo đang phát triển')}
      className="
        flex-1 md:flex-none
        inline-flex items-center justify-center gap-2 
        bg-[var(--admin-card)] border border-[var(--admin-border)] 
        text-[var(--admin-fg)] hover:bg-[var(--admin-hover)] 
        px-4 py-2 rounded-md text-sm font-medium transition-colors
      ">
        <Printer size={16} />          {/* 2. Icon Máy in */}
        <span>Xuất báo cáo</span>
      </button>
      <Link 
        href="/admin/projects/new"
        className="flex-1 md:flex-none
        inline-flex items-center justify-center gap-2 
        bg-[var(--admin-primary)] text-[var(--admin-primary-fg)] 
        hover:opacity-90 
        px-4 py-2 rounded-md text-sm font-medium transition-colors shadow-sm"
      >
        <Plus size={16} />
        <span>Tạo dự án mới</span>
      </Link>
    </div>
  );
}
```

## File: src/components/admin/DashboardFilter.tsx
```typescript
// src/components/admin/DashboardFilter.tsx
'use client';

import { useState, useRef, useEffect, useTransition } from 'react';
import { useRouter, useSearchParams } from 'next/navigation';
import { CalendarDays, ChevronDown, Check, Loader2 } from 'lucide-react';

const OPTIONS = [
  { value: '7d', label: '7 ngày qua (Tuần)' },
  { value: '30d', label: '30 ngày qua (Tháng)' },
  { value: '90d', label: '3 tháng qua (Quý)' },
  { value: '12m', label: '1 năm qua' },
  { value: 'all', label: 'Tất cả thời gian' },
];

export default function DashboardFilter() {
  const router = useRouter();
  const searchParams = useSearchParams();
  const [isOpen, setIsOpen] = useState(false);
  const [isPending, startTransition] = useTransition();
  const containerRef = useRef<HTMLDivElement>(null);
  
  const currentRange = searchParams.get('range') || '30d';
  const activeLabel = OPTIONS.find(opt => opt.value === currentRange)?.label || 'Chọn thời gian';

  const handleSelect = (value: string) => {
    setIsOpen(false);
    startTransition(() => {
      const params = new URLSearchParams(searchParams);
      params.set('range', value);
      router.push(`?${params.toString()}`, { scroll: false });
      router.refresh(); 
    });
  };

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      if (containerRef.current && !containerRef.current.contains(event.target as Node)) {
        setIsOpen(false);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, []);

  return (
    // [1] Container: w-full trên mobile, w-auto trên desktop
    <div className="relative w-full md:w-auto" ref={containerRef}>
      
      {/* TRIGGER BUTTON */}
      <button
        onClick={() => setIsOpen(!isOpen)}
        disabled={isPending}
        className={`
          flex items-center justify-between gap-2 px-4 py-2 rounded-lg border transition-all duration-200 whitespace-nowrap
          text-sm font-medium bg-[var(--admin-card)] hover:bg-[var(--admin-hover)]
          
          /* [2] Button Width: Full mobile, Auto desktop */
          w-full md:w-auto

          ${isOpen 
            ? 'border-[var(--admin-primary)] ring-2 ring-[var(--admin-primary)]/10 text-[var(--admin-fg)]' 
            : 'border-[var(--admin-border)] text-[var(--admin-sub)] hover:text-[var(--admin-fg)]'
          }
          ${isPending ? 'opacity-70 cursor-wait' : ''}
        `}
      >
        {/* Nhóm Icon + Text nằm bên trái */}
        <div className="flex items-center gap-2">
            {isPending ? (
            <Loader2 size={16} className="animate-spin text-[var(--admin-primary)]" />
            ) : (
            <CalendarDays size={16} className={isOpen ? 'text-[var(--admin-primary)]' : 'text-[var(--admin-sub)]'} />
            )}
            
            <span className="text-left">
            {isPending ? 'Đang tải...' : activeLabel}
            </span>
        </div>
        
        {/* Mũi tên luôn nằm bên phải cùng */}
        <ChevronDown 
          size={16} 
          className={`transition-transform duration-200 ml-2 ${isOpen ? 'rotate-180' : ''}`} 
        />
      </button>

      {/* DROPDOWN MENU */}
      {isOpen && (
        <div className="
            absolute right-0 mt-2 
            bg-[var(--admin-card)] border border-[var(--admin-border)] 
            rounded-xl shadow-xl z-50 
            animate-in fade-in zoom-in-95 duration-100 origin-top-right overflow-hidden
            
            /* [3] Dropdown Width: Full mobile (để khớp với nút), w-56 trên desktop */
            w-full md:w-56
        ">
          <div className="p-1.5">
            <div className="px-3 py-2 text-[10px] font-bold text-[var(--admin-sub)] uppercase tracking-wider">
              Khoảng thời gian
            </div>
            {OPTIONS.map((opt) => {
              const isActive = opt.value === currentRange;
              return (
                <button
                  key={opt.value}
                  onClick={() => handleSelect(opt.value)}
                  className={`
                    w-full flex items-center justify-between px-3 py-2 rounded-lg text-sm transition-colors
                    ${isActive 
                      ? 'bg-[var(--admin-primary)]/10 text-[var(--admin-primary)] font-medium' 
                      : 'text-[var(--admin-fg)] hover:bg-[var(--admin-hover)]'
                    }
                  `}
                >
                  <span>{opt.label}</span>
                  {isActive && <Check size={16} />}
                </button>
              );
            })}
          </div>
        </div>
      )}
    </div>
  );
}
```

## File: src/components/admin/DeleteProjectButton.tsx
```typescript
// src/components/admin/DeleteProjectButton.tsx
'use client';

import { useState } from 'react';
import { Trash2 } from 'lucide-react';
import { toast } from 'sonner';
import { deleteProject } from '@/lib/actions';
import { createBrowserClient } from '@supabase/ssr';
import ConfirmModal from '@/components/ui/ConfirmModal';

export default function DeleteProjectButton({ projectId, projectTitle }: { projectId: number, projectTitle: string }) {
  const [isDeleting, setIsDeleting] = useState(false);
  const [showModal, setShowModal] = useState(false); 
  const supabase = createBrowserClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
  );

  const handleDelete = async () => {
    const confirmMsg = `CẢNH BÁO: Bạn có chắc chắn muốn xóa dự án "${projectTitle}"?\nHành động này không thể hoàn tác!`;
    if (!window.confirm(confirmMsg)) return;

    setIsDeleting(true);
    const toastId = toast.loading('Đang xóa...');

    try {
      const { data: { session } } = await supabase.auth.getSession();
      
      if (!session) {
        toast.error('Không tìm thấy phiên đăng nhập. Vui lòng F5.', { id: toastId });
        setIsDeleting(false);
        setShowModal(false);
        return;
      }

      // 4. GỌI SERVER ACTION
      const res = await deleteProject(session.access_token, projectId);

      if (res.success) {
        toast.success('Đã xóa dự án', { id: toastId });
        setShowModal(false)
        // Refresh cứng để đảm bảo danh sách cập nhật sạch sẽ
        setTimeout(() => {
            window.location.reload(); 
        }, 500);
      } else {
        toast.error(`Lỗi: ${res.error}`, { id: toastId });
        setIsDeleting(false);
      }
    } catch (error) {
        const msg = error instanceof Error ? error.message : 'Có lỗi xảy ra';
        toast.error(msg, { id: toastId });
    } finally {
      setIsDeleting(false);
    }
  };

  return (
  <main>
      {/* Nút thùng rác (Chỉ mở Modal) */}
      <button 
        onClick={() => setShowModal(true)}
        className="p-2 text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition-colors"
        title="Xóa dự án"
      >
        <Trash2 size={18} />
      </button>

      {/* Modal xác nhận */}
      <ConfirmModal 
        isOpen={showModal}
        onClose={() => !isDeleting && setShowModal(false)} // Không cho đóng khi đang xóa dở
        onConfirm={handleDelete}
        title="Xóa dự án này?"
        description={`Bạn có chắc chắn muốn xóa dự án "${projectTitle}"? Hành động này sẽ xóa vĩnh viễn toàn bộ thông tin và hình ảnh liên quan. Không thể hoàn tác.`}
        confirmText={isDeleting ? "Đang xóa..." : "Xóa vĩnh viễn"}
        cancelText="Hủy bỏ"
        variant="danger"
        isLoading={isDeleting}
      />
    </main>
  );
}
```

## File: src/components/admin/StaffPageHeader.tsx
```typescript
'use client';

import { useState } from 'react';
import { Plus } from 'lucide-react';
import CreateStaffModal from './CreateStaffModal';

export default function StaffPageHeader({ total }: { total: number }) {
  const [isModalOpen, setIsModalOpen] = useState(false);

  return (
    <>
      <div className="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
        <div>
          <h1 className="text-3xl font-bold text-[var(--admin-fg)]">Nhân sự Studio</h1>
          <p className="text-[var(--admin-sub)] mt-1">Tổng số: {total} thành viên</p>
        </div>
        <button 
          onClick={() => setIsModalOpen(true)}
          className="flex items-center justify-center gap-2 px-5 py-2.5 bg-[var(--admin-primary)] text-white 
          rounded-lg hover:opacity-90 transition-all shadow-lg shadow-indigo-500/30 font-medium cursor-pointer"
        >
          <Plus size={20} /> Thêm Nhân viên
        </button>
      </div>

      <CreateStaffModal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} />
    </>
  );
}
```

## File: src/components/Container.tsx
```typescript
import { ReactNode } from "react";

interface ContainerProps {
  children: ReactNode;
  className?: string;
}

export default function Container({ children, className = "" }: ContainerProps) {
  return (
    <div className={`mx-auto lg:max-w-9/10 md:max-w-7xl px-4 sm:px-6 lg:px-8 ${className}`}>
      {children}
    </div>
  );
}
```

## File: src/components/HomePageContent.tsx
```typescript
// src/components/HomePageContent.tsx

'use client';

import dynamic from 'next/dynamic';

// 1. Tải ngay lập tức
import HeroSection from '@/components/HeroSection';

// 2. Tạo một component Loading (Trạng thái chờ)
const LoadingSpinner = () => (
  <div className="h-96 flex items-center justify-center">
    <p>Đang tải...</p>
  </div>
);

// 3. Tải lười (Dynamic Imports) cho các section bên dưới
const DynamicPortfolioSection = dynamic(
  () => import('@/components/PortfolioSection'), // Giả định component này tồn tại
  { ssr: false, loading: () => <LoadingSpinner /> }
);

const DynamicProjectShowcase = dynamic(
  () => import('@/components/ProjectShowcase'), // Giả định component này tồn tại
  { ssr: false, loading: () => <LoadingSpinner /> }
);


const DynamicContactSection = dynamic(
  () => import('@/components/ContactSection'),
  { ssr: false, loading: () => <LoadingSpinner /> }
);

// 4. Đổi tên function (từ HomePage thành HomePageContent)
export default function HomePageContent() {
  return (
    <main>
      {/* Section 01 (Tải ngay) */}
      <HeroSection />

      {/* Section 02 (Tải lười) */}
      <section id="portfolio" className="md:pt-24">
        <DynamicPortfolioSection />
      </section>

      {/* Section 03 (Tải lười) */}
      <section id="showcase" className="md:pt-24">
        <DynamicProjectShowcase />
      </section>

      {/* Section 04 (Tải lười) */}
      <section id="contact">
        <DynamicContactSection />
      </section>
    </main>
  );
}
```

## File: src/components/PhilosophyBackground.tsx
```typescript
// src/components/PhilosophyBackground.tsx
'use client';

import ScrollBaseAnimation from '@/components/scroll-text-marque';

export default function PhilosophyBackground() {
  return (
    <div className="absolute inset-0 z-10 flex flex-col justify-center 
                    opacity-10 dark:opacity-5 
                    pointer-events-none gap-4 md:gap-8">

      <ScrollBaseAnimation
        baseVelocity={-3}
        className="text-6xl font-bold uppercase whitespace-nowrap"
      >
        THƯƠNG MẠI • THỜI TRANG • CÁ NHÂN •
      </ScrollBaseAnimation>

      <ScrollBaseAnimation
        baseVelocity={3}
        className="text-9xl font-bold uppercase whitespace-nowrap text-center"
      >
        KHOẢNH KHẮC • SÁNG TẠO • ONI STUDIO •
      </ScrollBaseAnimation>

      <ScrollBaseAnimation
        baseVelocity={-2}
        className="text-6xl font-bold uppercase whitespace-nowrap"
      >
        LOOKBOOK • PORTRAIT • PHOTOGRAPHY •
      </ScrollBaseAnimation>
    </div>
  );
}
```

## File: src/components/ScrollingText.tsx
```typescript
// // src/components/ui/ScrollingText.tsx
// 'use client';

// import { useRef, useState } from 'react';
// import {
//   motion,
//   useScroll,
//   useMotionValueEvent,
// } from 'framer-motion';

// // Định nghĩa props cho component
// interface ScrollingTextProps {
//   text: string;
//   className?: string;
//   direction?: 'left' | 'right'; 
//   speed?: number; // Tốc độ chạy (s), càng nhỏ càng nhanh
// }


// /**
//  * Component chính
//  */
// export const ScrollingText = ({
//   text,
//   className = '',
//   direction = 'left',
//   speed = 15, // Mặc định 15s cho 1 vòng
// }: ScrollingTextProps) => {
//   const containerRef = useRef<HTMLDivElement>(null);
  
//   // 1. THEO DÕI HƯỚNG CUỘN
//   const { scrollY } = useScroll();
//   const [scrollDirection, setScrollDirection] = useState<'up' | 'down'>('down');

//   useMotionValueEvent(scrollY, 'change', (latest) => {
//     const previous = scrollY.getPrevious() ?? 0;
//     if (latest > previous) {
//       setScrollDirection('down');
//     } else {
//       setScrollDirection('up');
//     }
//   });

//   // 2. TẠO ANIMATION
//   // Dựa trên hướng cuộn, chúng ta đổi hướng chạy của chữ
//   const effectiveDirection =
//     scrollDirection === 'down' ? direction : direction === 'left' ? 'right' : 'left';


//   // Tạo giá trị 'from' và 'to' cho animation
//   const fromX = effectiveDirection === 'left' ? 0 : -2000;
//   const toX = effectiveDirection === 'left' ? -2000 : 0;

//   return (
//     <div
//       ref={containerRef}
//       className={`relative w-full overflow-hidden ${className}`}
//     >
//       <motion.div
//         className="relative"
//         // Sử dụng 'animate' và 'transition' của Framer Motion
//         animate={{ x: [fromX, toX] }}
//         transition={{
//           repeat: Infinity,
//           repeatType: 'loop',
//           duration: speed, // Dùng speed (giây) làm duration
//           ease: 'linear',
//         }}
//         style={{
//           width: '400%', // Gấp 4 lần vì có 4 bản sao
//           display: 'flex',
//         }}
//       >
//         {/* Render 4 bản sao. Đã xóa style 'speed' bị lỗi */}
//         <span className="block w-1/4 mr-8">{text}</span>
//         <span className="block w-1/4 mr-8">{text}</span>
//         <span className="block w-1/4 mr-8">{text}</span>
//         <span className="block w-1/4 mr-8">{text}</span>
//       </motion.div>
//     </div>
//   );
// };
```

## File: src/lib/constants.ts
```typescript
// src/lib/constants.ts

/**
 * Cài đặt chung cho các layout dạng grid
 */

// Số lượng item giả cần cho mỗi trang
export const DESIRED_PROJECT_COUNT = 48;

// Số lượng item tải ban đầu khi vào trang
export const INITIAL_LOAD_COUNT = 8;

// Số lượng item tải thêm mỗi lần cuộn
export const LOAD_MORE_COUNT = 8;

export const SLUG_CATE_PERSONAL = 'ca-nhan';
export const SLUG_CATE_COMMERCIAL = 'thuong-mai';
export const SLUG_CATE_FASHION = 'thoi-trang';


export const ROOM_COLORS = [
  '#4285F4', // Xanh dương (Google)
  '#34A853', // Xanh lá
  '#EA4335', // Đỏ
  '#FBBC05', // Vàng
  '#8E24AA', // Tím
  '#F6BF26', // Cam
  '#06b6d4', // Cyan
  '#ec4899', // Pink
];
```

## File: .gitignore
```
# See https://help.github.com/articles/ignoring-files/ for more about ignoring files.

# dependencies
/node_modules
/.pnp
.pnp.*
.yarn/*
!.yarn/patches
!.yarn/plugins
!.yarn/releases
!.yarn/versions

# testing
/coverage

# next.js
/.next/
/out/

# production
/build

# misc
.DS_Store
*.pem

# debug
npm-debug.log*
yarn-debug.log*
yarn-error.log*
.pnpm-debug.log*

# env files (can opt-in for committing if needed)
.env*

# vercel
.vercel

# typescript
*.tsbuildinfo
next-env.d.ts

# Local documentation with secrets
docs/create_db.txt
```

## File: README.md
```markdown
# Photographer Portfolio Website

Website Portfolio cá nhân dành cho nhiếp ảnh gia chuyên nghiệp, tập trung vào trải nghiệm thị giác, kể chuyện (storytelling) và tối ưu hóa hiệu năng.

**Live Demo:** [https://dangk3.github.io/Photographer-Portfolio/](https://dangk3.github.io/Photographer-Portfolio/)

![Project Screenshot](https://dangk3.github.io/Photographer-Portfolio/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Fhero-background.webp&w=3840&q=90) 
*(Bạn có thể thay link ảnh trên bằng ảnh chụp màn hình thực tế sau này)*

## 🚀 Tính năng nổi bật (Version 1.0)

* **Trải nghiệm điện ảnh:** Hero Section với hiệu ứng Ken Burns và Typography động.
* **Editorial Layout:** Trang chi tiết dự án được trình bày như một bài tạp chí (Magazine style) thay vì chỉ là gallery ảnh đơn thuần.
* **Smart Navigation:**
    * Menu điều hướng dính (Sticky Nav) thông minh.
    * Chuyển đổi giao diện Sáng/Tối (Dark/Light Mode).
    * Infinite Scroll (Cuộn vô tận) cho các trang danh mục.
* **Layout linh hoạt:**
    * Masonry Grid (xếp gạch) cho mục Cá nhân.
    * Editorial Grid cho mục Thời trang & Thương mại.
* **Hiệu năng cao:** Tối ưu hóa SEO động, Static Site Generation (SSG) tải trang cực nhanh.

## 🛠 Công nghệ sử dụng

* **Core:** [Next.js 15](https://nextjs.org/) (App Router), [React 19](https://react.dev/), [TypeScript](https://www.typescriptlang.org/).
* **Styling:** [Tailwind CSS v4](https://tailwindcss.com/).
* **Animation:** [Framer Motion](https://www.framer.com/motion/).
* **Components:** * `yet-another-react-lightbox` (Gallery).
    * `react-type-animation` (Hiệu ứng chữ).
* **Deployment:** GitHub Pages (Static Export).
```

## File: src/app/admin/page.tsx
```typescript
'use client';

import { useEffect, useState } from 'react';
import { 
  getDashboardStats, 
  getTodaySchedule, 
  getGrowthChartData 
} from '@/lib/actions/stats';
import { 
  FolderOpen, 
  Image as ImageIcon, 
  Users, 
  CalendarCheck,
  TrendingUp,
  ArrowUpRight
} from 'lucide-react';
import Spinner from '@/components/Spinner';
import TodaySchedule from '@/components/admin/TodaySchedule';
import DashboardActions from '@/components/admin/DashboardActions';
import DashboardFilter from '@/components/admin/DashboardFilter';
import GrowthChart from '@/components/admin/GrowthChart';
import { useSearchParams } from 'next/navigation';

// --- 1. ĐỊNH NGHĨA TYPE CHUẨN ---

// Type cho biểu đồ (khớp với getGrowthChartData)
interface ChartItem {
  name: string;
  total: number;
}

// Type cho lịch trình (khớp với getTodaySchedule)
// Dựa trên query select trong stats.ts
export interface ScheduleItem {
  booking_item_id: number;
  start_dt: string;
  end_dt: string;
  rooms: { 
    name: string | null; 
    code: string | null; 
  } | null;
  bookings: {
    status: 'pending' | 'confirmed' | 'checked_in' | 'completed' | 'cancelled' | null;
    customers: { 
      full_name: string | null; 
      phone: string | null; 
    } | null;
  } | null;
}

interface DashboardStats {
  totalProjects: number;
  newProjects: number;
  totalStaff: number;
  todayBookings: number;
}

interface StatCardProps {
  title: string;
  value: string;
  trend: string;
  trendLabel: string;
  icon: React.ReactNode;
  colorClass: string;
}

// --- 2. COMPONENT CHÍNH ---

export default function AdminDashboard() {
  const searchParams = useSearchParams();
  const currentRange = searchParams.get('range') || '30d';

  const [stats, setStats] = useState<DashboardStats>({
    totalProjects: 0,
    newProjects: 0,
    totalStaff: 0,
    todayBookings: 0
  });

  // --- ÁP DỤNG TYPE Ở ĐÂY ---
  const [todaySchedule, setTodaySchedule] = useState<ScheduleItem[]>([]); 
  const [chartData, setChartData] = useState<ChartItem[]>([]);
  // ---------------------------

  const [loading, setLoading] = useState(true);

  useEffect(() => {
    const fetchData = async () => {
      setLoading(true);
      try {
        // Gọi song song để tối ưu tốc độ
        const [dashboardStats, schedule, chart] = await Promise.all([
          getDashboardStats(currentRange),
          getTodaySchedule(),
          getGrowthChartData(currentRange)
        ]);

        setStats(dashboardStats);
        
        // Ép kiểu an toàn (nếu DB trả về field null không mong muốn)
        setTodaySchedule(schedule as unknown as ScheduleItem[]);
        setChartData(chart);
        
      } catch (error) {
        console.error("Lỗi tải dashboard:", error);
      } finally {
        setLoading(false);
      }
    };

    fetchData();
  }, [currentRange]); // Re-fetch khi đổi filter

  // Helper hiển thị text
  const getTrendLabel = () => {
    if (currentRange === 'today') return 'hôm nay';
    if (currentRange === '7d') return 'trong tuần qua';
    if (currentRange === '30d') return 'trong tháng này';
    if (currentRange === '90d') return 'trong quý này';
    if (currentRange === '12m') return 'trong năm nay';
    return 'từ trước đến nay';
  };

  if (loading) return <div className="h-96 flex items-center justify-center"><Spinner /></div>;

  return (
    <div className="space-y-8 pb-10">
      {/* Header */}
      <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
        <div>
          <h1 className="text-3xl font-bold text-[var(--admin-fg)]">Dashboard</h1>
          <p className="text-[var(--admin-sub)]">Chào mừng trở lại, quản trị viên.</p>
        </div>
        <div className="flex flex-col sm:flex-row gap-3 w-full md:w-auto">
            <DashboardFilter />
            <DashboardActions />
        </div>
      </div>

      {/* Stats Cards Grid */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <StatCard 
          title="Booking Hôm Nay"
          value={stats.todayBookings.toString()}
          trend="Today"
          trendLabel="ca chụp trong ngày"
          icon={<CalendarCheck size={24} className="text-orange-600 dark:text-orange-400" />}
          colorClass="bg-orange-50 dark:bg-orange-900/20"
        />
        <StatCard 
          title="Tổng Dự Án"
          value={stats.totalProjects.toString()}
          trend={`+${stats.newProjects}`}
          trendLabel={getTrendLabel()}
          icon={<FolderOpen size={24} className="text-blue-600 dark:text-blue-400" />}
          colorClass="bg-blue-50 dark:bg-blue-900/20"
        />
        <StatCard 
          title="Dự Án Mới"
          value={stats.newProjects.toString()}
          trend="New"
          trendLabel={getTrendLabel()}
          icon={<ImageIcon size={24} className="text-green-600 dark:text-green-400" />}
          colorClass="bg-green-50 dark:bg-green-900/20"
        />
        <StatCard 
          title="Nhân Sự"
          value={stats.totalStaff.toString()}
          trend="Active"
          trendLabel="đang hoạt động"
          icon={<Users size={24} className="text-purple-600 dark:text-purple-400" />}
          colorClass="bg-purple-50 dark:bg-purple-900/20"
        />
      </div>

      {/* Main Content Grid */}
      <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        {/* CỘT TRÁI (2/3): Biểu đồ */}
        <div className="lg:col-span-2 bg-[var(--admin-card)] p-6 rounded-2xl border border-[var(--admin-border)] shadow-sm min-h-[400px]">
           <div className="flex items-center gap-3 mb-4">
              <div className="p-2 bg-[var(--admin-primary)]/10 rounded-lg text-[var(--admin-primary)]">
                  <TrendingUp size={20} />
              </div>
              <div>
                  <h3 className="text-lg font-bold text-[var(--admin-fg)]">Tăng trưởng Booking</h3>
                  <p className="text-xs text-[var(--admin-sub)]">Số liệu {getTrendLabel()}.</p>
              </div>
           </div>
           
           {chartData.length > 0 ? (
              <GrowthChart data={chartData} />
           ) : (
              <div className="h-[300px] flex items-center justify-center text-[var(--admin-sub)] italic">
                Chưa có dữ liệu trong khoảng thời gian này.
              </div>
           )}
        </div>

        {/* CỘT PHẢI (1/3): Lịch trình hôm nay */}
        <div className="bg-[var(--admin-card)] p-6 rounded-2xl border border-[var(--admin-border)] shadow-sm flex flex-col h-full max-h-[500px]">
           <div className="flex items-center justify-between mb-6">
              <h3 className="font-bold text-[var(--admin-fg)] text-lg">Lịch trình hôm nay</h3>
              <span className="text-xs bg-[var(--admin-primary)]/10 text-[var(--admin-primary)] px-2 py-1 rounded font-bold">
                {new Date().toLocaleDateString('vi-VN', { weekday: 'short', day: 'numeric', month: 'numeric' })}
              </span>
           </div>
           
           <div className="flex-1 overflow-y-auto pr-1 table-scrollbar">
              <TodaySchedule bookings={todaySchedule} />
           </div>
        </div>
      </div>
    </div>
  );
}

// Sub-component StatCard (Giữ nguyên UI)
function StatCard({ title, value, trend, trendLabel, icon, colorClass }: StatCardProps) {
  return (
    <div className="bg-[var(--admin-card)] p-6 rounded-2xl border border-[var(--admin-border)] shadow-sm hover:shadow-md transition-all duration-300 group">
      <div className="flex items-start justify-between mb-4">
        <div className={`p-3 rounded-xl ${colorClass} group-hover:scale-110 transition-transform duration-300`}>
          {icon}
        </div>
        <span className="flex items-center text-xs font-medium text-green-600 bg-green-50 dark:bg-green-900/20 px-2 py-1 rounded-full border border-green-100 dark:border-green-900">
          <ArrowUpRight size={12} className="mr-1" />
          {trend}
        </span>
      </div>
      <div>
        <h3 className="text-sm font-medium text-[var(--admin-sub)]">{title}</h3>
        <div className="mt-1 text-3xl font-bold text-[var(--admin-fg)] tracking-tight">{value}</div>
        <p className="text-xs text-[var(--admin-sub)]/80 mt-2 capitalize">{trendLabel}</p>
      </div>
    </div>
  );
}
```

## File: src/app/admin/projects/new/page.tsx
```typescript
// src/app/admin/projects/new/page.tsx
'use client';

import ProjectForm from '@/components/admin/ProjectForm';

export default function NewProjectPage() {
  return <ProjectForm mode="create" />;
}
```

## File: src/app/error.tsx
```typescript
// src/app/error.tsx
'use client';

import Container from '@/components/Container';
import Link from 'next/link';
export default function Error({
  reset,
}: {
  error: Error & { digest?: string };
  reset: () => void;
}) {

  return (
    <Container>
      <div className="flex flex-col items-center justify-center text-center py-24 md:py-32 min-h-[calc(100vh_-_250px)]">
        
        {/* Mã lỗi */}
        <span className="text-7xl md:text-9xl font-light tracking-tighter text-[var(--foreground)]">
          Lỗi
        </span>
        
        {/* Tiêu đề */}
        <h1 className="mt-4 text-3xl md:text-4xl font-light tracking-tight">
          Đã có lỗi xảy ra
        </h1>
        
        {/* Mô tả */}
        <p className="mt-2 text-lg text-[var(--sub-text)]">
          Rất tiếc, đã có sự cố ngoài ý muốn. Bạn có thể thử lại.
        </p>

        {/* Nút "Thử Lại"
          Hàm reset() sẽ cố gắng render lại trang một lần nữa.
        */}
        <div className="mt-10 flex flex-col md:flex-row justify-center gap-4">
          
          {/* Nút 1: Thử Lại */}
          <button
            onClick={() => reset()}
            className="py-3 px-8 bg-transparent 
                       border border-[var(--foreground)] 
                       text-[var(--foreground)] 
                       hover:bg-[var(--foreground)] hover:text-[var(--background)] 
                       transition-colors duration-300 cursor-pointer"
          >
            Thử Lại
          </button>
          
          {/* Nút 2: Trang chủ*/}
          <Link
            href="/"
            className="py-3 px-8 bg-transparent 
                       border border-[var(--foreground)] 
                       text-[var(--foreground)] 
                       hover:bg-[var(--foreground)] hover:text-[var(--background)] 
                       transition-colors duration-300 cursor-pointer"
          >
            Quay về Trang chủ
          </Link>
        </div>
      </div>
    </Container>
  );
}
```

## File: src/app/gioi-thieu/page.tsx
```typescript
// src/app/gioi-thieu/page.tsx
import type { Metadata } from 'next';
import AboutMilestonesSection from '@/components/AboutMilestonesSection';
import AboutPhilosophySection from '@/components/AboutPhilosophySection';

// 1. Thêm Metadata (SEO) cho trang Giới Thiệu
export const metadata: Metadata = {
  title: 'Giới Thiệu | Oni Studio',
  description: 'Tìm hiểu về hành trình, đội ngũ và triết lý sáng tạo đằng sau Oni Studio, từ những phác thảo đầu tiên đến một xưởng ảnh chuyên nghiệp.',
  openGraph: {
    title: 'Giới Thiệu | Oni Studio',
    description: 'Tìm hiểu về hành trình và triết lý sáng tạo của Oni Studio.',
    // Bạn nên thay thế bằng một ảnh đại diện cho trang Giới Thiệu
    images: ['/assets/about/carousel_04_2025.jpg'], 
  },
};

// 2. Nội dung trang
export default function GioiThieuPage() {
  return (
    <main>
      {/* Section 1: Hành trình (Carousel) */}
      <AboutMilestonesSection />

      <AboutPhilosophySection />

    </main>
  );
}
```

## File: src/app/login/page.tsx
```typescript
// src/app/login/page.tsx
'use client';

import React, { useState, useEffect, Suspense } from 'react';
import { useRouter, useSearchParams } from 'next/navigation';
// 1. XÓA dòng import supabase cũ này đi
// import { supabase } from '@/lib/supabase'; 

// 2. THÊM import này để tạo client hỗ trợ Cookie
import { createBrowserClient } from '@supabase/ssr';

import { toast } from 'sonner';
import { Mail, Lock, Loader2, ArrowRight } from 'lucide-react';
import localFont from 'next/font/local'; 

const logoFont = localFont({
  src: '../../fonts/cameliya-regular.ttf',
  display: 'swap',
  variable: '--font-logo',
});
function LoginFormContent() {
  const router = useRouter();
  const searchParams = useSearchParams();
  
  // 3. Khởi tạo Supabase Client có khả năng ghi Cookie
  const supabase = createBrowserClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
  );

  const [formData, setFormData] = useState({
    email: '',
    password: ''
  });
  const [isLoading, setIsLoading] = useState(false);

  // Check login
  useEffect(() => {
    const checkUser = async () => {
      const { data: { session } } = await supabase.auth.getSession();
      if (session) {
        // Refresh router để đảm bảo Server Component nhận được cookie mới
        router.refresh();
        router.replace('/admin');
      }
    };
    checkUser();
  }, [router, supabase]);

const handleLogin = async (e: React.FormEvent) => {
    e.preventDefault();
    setIsLoading(true);

    try {
      // 1. Đăng nhập với Supabase Auth
      const { data, error } = await supabase.auth.signInWithPassword({
        email: formData.email,
        password: formData.password,
      });

      if (error) throw error;
      if (!data.user) throw new Error("Không tìm thấy thông tin người dùng.");

      // 2. KIỂM TRA TRẠNG THÁI 'IS_ACTIVE'
      const { data: userProfile, error: profileError } = await supabase
        .from('users')
        .select('is_active, role')
        .eq('auth_id', data.user.id)
        .single();

      // Nếu không tìm thấy profile hoặc bị khóa
      if (profileError || (userProfile && !userProfile.is_active)) {
        await supabase.auth.signOut();
        throw new Error("Tài khoản của bạn đã bị KHÓA. Vui lòng liên hệ Admin.");
      }

      // 3. Nếu mọi thứ OK -> Cho vào
      toast.success(`Chào mừng trở lại, ${userProfile?.role === 'Admin' ? 'Sếp' : 'bạn'}!`);
      
      const nextUrl = searchParams.get('next');
      router.refresh(); 
      router.replace(nextUrl || '/admin');
      
    } catch (error: unknown) { // Dùng 'any' để dễ truy cập .message
      console.error("Login error:", error);
      
      // --- XỬ LÝ DỊCH LỖI TẠI ĐÂY ---
      let msg = (error as Error).message || 'Đăng nhập thất bại';

      // 1. Lỗi sai mật khẩu hoặc email không tồn tại
      if (msg === 'Invalid login credentials') {
        msg = 'Email hoặc mật khẩu không chính xác.';
      } 
      // 2. Lỗi chưa xác thực email (nếu có bật confirm)
      else if (msg.includes('Email not confirmed')) {
        msg = 'Email chưa được xác thực. Vui lòng kiểm tra hộp thư.';
      }
      // 3. Lỗi quá nhiều lần thử (Rate limit)
      else if (msg.includes('Too many requests') || msg.includes('rate limit')) {
        msg = 'Bạn đã thử quá nhiều lần. Vui lòng đợi giây lát.';
      }
      
      // Nếu là lỗi do mình tự throw ở trên ("Tài khoản bị khóa...") thì nó sẽ giữ nguyên tiếng Việt
      toast.error(msg);
    } finally {
      setIsLoading(false);
    }
  };

  // ... (PHẦN GIAO DIỆN RETURN GIỮ NGUYÊN KHÔNG ĐỔI) ...
  return (
    <div className="min-h-screen flex items-center justify-center bg-[var(--admin-bg)] p-4 transition-colors duration-300">
      <div className="w-full max-w-md bg-[var(--admin-card)] border border-[var(--admin-border)] rounded-2xl shadow-xl p-8 animate-fade-in-up">
        
        {/* Logo / Header */}
        <div className="text-center mb-8">
          <div className={`w-12 h-12 bg-[var(--admin-primary)] rounded-xl flex items-center justify-center text-white font-bold text-2xl mx-auto mb-4 shadow-lg shadow-indigo-500/30 ${logoFont.className}`}>
            O
          </div>
          <h1 className="text-2xl font-bold text-[var(--admin-fg)]">Oni Studio Admin</h1>
          <p className="text-[var(--admin-sub)] mt-2">Đăng nhập để quản lý hệ thống</p>
        </div>

        {/* Form */}
        <form onSubmit={handleLogin} className="space-y-5">
          <div>
            <label className="block text-sm font-medium text-[var(--admin-fg)] mb-1.5">Email</label>
            <div className="relative">
              <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <Mail size={18} className="text-[var(--admin-sub)]" />
              </div>
              <input
                type="email"
                required
                className="w-full pl-10 pr-4 py-2.5 bg-[var(--admin-bg)] border border-[var(--admin-border)] text-[var(--admin-fg)] rounded-lg focus:ring-2 focus:ring-[var(--admin-primary)] focus:border-transparent outline-none transition-all"
                placeholder="admin@onistudio.com"
                value={formData.email}
                onChange={(e) => setFormData({ ...formData, email: e.target.value })}
              />
            </div>
          </div>

          <div>
            <label className="block text-sm font-medium text-[var(--admin-fg)] mb-1.5">Mật khẩu</label>
            <div className="relative">
              <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <Lock size={18} className="text-[var(--admin-sub)]" />
              </div>
              <input
                type="password"
                required
                className="w-full pl-10 pr-4 py-2.5 bg-[var(--admin-bg)] border border-[var(--admin-border)] text-[var(--admin-fg)] rounded-lg focus:ring-2 focus:ring-[var(--admin-primary)] focus:border-transparent outline-none transition-all"
                placeholder="••••••••"
                value={formData.password}
                onChange={(e) => setFormData({ ...formData, password: e.target.value })}
              />
            </div>
          </div>

          <button
            type="submit"
            disabled={isLoading}
            className="w-full py-2.5 cursor-pointer bg-[var(--admin-primary)] text-[var(--admin-primary-fg)] rounded-lg font-medium hover:opacity-90 transition-all shadow-md shadow-indigo-500/25 flex items-center justify-center gap-2 disabled:opacity-70 disabled:cursor-not-allowed"
          >
            {isLoading ? (
              <>
                <Loader2 size={20} className="animate-spin" />
                Đang xác thực...
              </>
            ) : (
              <>
                Đăng nhập
                <ArrowRight size={18} />
              </>
            )}
          </button>
        </form>

        {/* Footer Text */}
        <div className="mt-6 text-center text-xs text-[var(--admin-sub)]">
          <p>Chỉ dành cho nhân viên được cấp quyền.</p>
        </div>
      </div>
    </div>
  );
}

// === COMPONENT CHÍNH (WRAPPER ĐỂ FIX LỖI BUILD) ===
export default function LoginPage() {
  return (
    <Suspense fallback={
      <div className="min-h-screen flex items-center justify-center bg-gray-100 dark:bg-neutral-950">
        <Loader2 className="animate-spin text-indigo-600" size={32} />
      </div>
    }>
      <LoginFormContent />
    </Suspense>
  );
}
```

## File: src/app/providers.tsx
```typescript
// src/app/providers.tsx
'use client';

import { ThemeProvider } from 'next-themes';
import { ReactNode } from 'react';

export function Providers({ children }: { children: ReactNode }) {
  return (
    <ThemeProvider attribute="class" storageKey="client-theme" defaultTheme="system" enableSystem>
      {children}
    </ThemeProvider>
  );
}
```

## File: src/components/AboutMilestonesSection.tsx
```typescript
// src/components/AboutMilestonesSection.tsx
'use client';

import Image from 'next/image';
import {
  SliderBtnGroup,
  ProgressSlider,
  SliderBtn,
  SliderContent,
  SliderWrapper,
} from '@/components/progressive-carousel'; // Đảm bảo đường dẫn này chính xác
import carousel_01_2020 from '../assets/about/carousel_01_2020.webp';
import carousel_02_2022 from '../assets/about/carousel_02_2022.webp';
import carousel_03_2024 from '../assets/about/carousel_03_2024.webp';
import carousel_04_2025 from '../assets/about/carousel_04_2025.webp';    
import Container from '@/components/Container';


// 1. DỮ LIỆU CÁC CỘT MỐC
// Chúng ta sẽ thay thế dữ liệu mẫu bằng nội dung câu chuyện của Oni Studio
const items = [
  {
    // Sử dụng đường dẫn ảnh từ thư mục /public
    img: carousel_01_2020,
    year: '2020',
    title: 'Phác Thảo Giấc Mơ',
    desc: 'Năm 2020, ý tưởng về Oni Studio được phác thảo, mang theo giấc mơ về một không gian sáng tạo kết hợp giữa studio và café.',
    sliderName: 'milestone-2020', // Tên định danh duy nhất
  },
  {
    img: carousel_02_2022,
    year: '2022',
    title: 'Không Gian Đầu Tiên',
    desc: 'Studio vật lý đầu tiên ra đời. Một không gian tối giản, tinh khôi, tập trung vào việc khai thác vẻ đẹp của ánh sáng tự nhiên.',
    sliderName: 'milestone-2022',
  },
  {
    img: carousel_03_2024,
    year: '2024',
    title: 'Nâng Cấp Toàn Diện',
    desc: 'Studio được mở rộng và trang bị chuyên nghiệp. Từ ánh sáng, phông nền đến thiết bị, tất cả sẵn sàng cho các dự án lớn và dịch vụ cho thuê.',
    sliderName: 'milestone-2024',
  },
  {
    img: carousel_04_2025,
    year: '2025',
    title: 'Định Hình Dịch Vụ',
    desc: 'Oni Studio khẳng định vị thế với dịch vụ cho thuê studio và thiết bị chuyên nghiệp, trở thành một địa chỉ tin cậy cho cộng đồng sáng tạo.',
    sliderName: 'milestone-2025',
  },
];

export default function AboutMilestonesSection() {
  return (
    // Bọc trong 1 <section> để dễ quản lý
    <section id="milestones" className="py-16 md:py-24">
    <Container>
        <div className="container mx-auto px-4 text-center mb-10">
            <h2 className="text-4xl md:text-5xl font-light tracking-tighter">
            Hành Trình Của Oni
            </h2>
            <p className="text-lg text-[var(--foreground)] mt-2">
            Từ ý tưởng đến một studio chuyên nghiệp.
            </p>
        </div>

        {/* 2. ÁP DỤNG COMPONENT CAROUSEL */}
        {/* Đặt activeSlider mặc định là cột mốc đầu tiên */}
        <ProgressSlider vertical={false} activeSlider="milestone-2020">
            
            {/* PHẦN HIỂN THỊ HÌNH ẢNH */}
            <SliderContent>
            {items.map((item, index) => (
                <SliderWrapper key={index} value={item.sliderName}>
                <Image
                    // Đặt chiều cao cố định và object-cover để ảnh đồng đều
                    className="rounded-xl h-[400px] md:h-[700px] w-full object-cover"
                    src={item.img}
                    width={1920} // Giữ chiều rộng lớn
                    height={1080} // Giữ chiều cao lớn
                    alt={item.title} // Dùng title cho alt text
                    priority={index === 0} // Ưu tiên tải ảnh đầu tiên
                    sizes="(max-width: 768px) 100vw, 100vw"
                />
                </SliderWrapper>
            ))}
            </SliderContent>

            {/* PHẦN HIỂN THỊ NỘI DUNG (NÚT BẤM) */}
            {/* Tùy chỉnh styling từ code mẫu cho phù hợp */}
            <SliderBtnGroup className="relative md:absolute bottom-0 h-fit dark:text-white text-black dark:bg-black/40 bg-white/40 backdrop-blur-md overflow-hidden grid grid-cols-2 md:grid-cols-4 rounded-md mt-4 md:mt-0">
            {items.map((item, index) => (
                <SliderBtn
                key={index}
                value={item.sliderName}
                className="text-left p-4 md:p-6 border-r border-white/20"
                progressBarClass="dark:bg-gray-900 bg-black h-full" // Đổi màu thanh progress
                >
                {/* Sử dụng 'year' cho thẻ badge */}
                <h3 className="relative px-4 py-1 rounded-full w-fit dark:bg-white dark:text-black text-white bg-gray-900 mb-3 text-sm font-semibold">
                    {item.year}
                </h3>
                {/* Sử dụng 'title' cho tiêu đề chính */}
                <h2 className="text-lg md:text-xl font-semibold mb-1">
                    {item.title}
                </h2>
                {/* Sử dụng 'desc' cho mô tả */}
                <p className="text-sm font-medium line-clamp-3 md:line-clamp-2">
                    {item.desc}
                </p>
                </SliderBtn>
            ))}
            </SliderBtnGroup>
        </ProgressSlider>
    </Container>
  </section>
);
}
```

## File: src/components/admin/PortfolioGridEditor.tsx
```typescript
// src/components/admin/PortfolioGridEditor.tsx
'use client';

import { useState } from 'react';
import Image, { StaticImageData } from 'next/image';
import { toast } from 'sonner';
// Thêm GripVertical vào import
import { Save, RotateCcw, Edit3, Check, MousePointerClick, GripVertical } from 'lucide-react';
import { ProjectData } from '@/data/projects-master-data';
import { updatePortfolioLayout, ProjectGridUpdate } from '@/lib/actions';
//import { supabase } from '../../../lib/supabase';
import { createBrowserClient } from '@supabase/ssr';

// --- IMPORT DND KIT ---
import {
  DndContext,
  closestCenter,
  KeyboardSensor,
  PointerSensor,
  useSensor,
  useSensors,
  DragEndEvent
} from '@dnd-kit/core';
import {
  arrayMove,
  SortableContext,
  rectSortingStrategy
} from '@dnd-kit/sortable';
import { SortableProjectItem } from './SortableProjectItem'; // Component vừa tạo ở B1



interface EditorProps {
  initialProjects: ProjectData[];
}

export default function PortfolioGridEditor({ initialProjects }: EditorProps) {
  const [projects, setProjects] = useState<ProjectData[]>(initialProjects);
  const [supabase] = useState(() => createBrowserClient(
      process.env.NEXT_PUBLIC_SUPABASE_URL!,
      process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
    ));
  const [isEditing, setIsEditing] = useState(false);
  const [isSaving, setIsSaving] = useState(false);
  // Cấu hình cảm biến kéo thả
  // activationConstraint: distance 5px -> Phải kéo 5px mới tính là drag (tránh click nhầm nút resize)
  const sensors = useSensors(
    useSensor(PointerSensor, {
      activationConstraint: {
        distance: 5,
      },
    }),
    useSensor(KeyboardSensor)
  );

  const getImageSrc = (img: string | StaticImageData) => {
    return typeof img === 'string' ? img : img.src;
  };

  // --- LOGIC XỬ LÝ KHI THẢ CHUỘT (DRAG END) ---
  const handleDragEnd = (event: DragEndEvent) => {
    const { active, over } = event;

    if (active.id !== over?.id) {
      setProjects((items) => {
        const oldIndex = items.findIndex((i) => i.id === active.id);
        const newIndex = items.findIndex((i) => i.id === over?.id);
        
        // Hàm này của dnd-kit sẽ đổi chỗ phần tử trong mảng
        return arrayMove(items, oldIndex, newIndex);
      });
    }
  };

  // Logic Resize (Giữ nguyên)
  const handleResize = (id: number, type: 'col' | 'row', delta: number) => {
    setProjects(prev => prev.map(p => {
      if (p.id !== id) return p;
      let newVal = 0;
      if (type === 'col') {
        newVal = Math.max(1, Math.min(3, (p.colSpan || 1) + delta));
        return { ...p, colSpan: newVal };
      } else {
        newVal = Math.max(1, Math.min(4, (p.rowSpan || 1) + delta));
        return { ...p, rowSpan: newVal };
      }
    }));
  };

  // Logic Lưu
  const handleSave = async () => {
    setIsSaving(true);
    try {
      const { data: { session } } = await supabase.auth.getSession();
      
      if (!session) {
        toast.error('Không tìm thấy phiên đăng nhập. Vui lòng F5.');
        return;
      }      
      // Chuẩn bị dữ liệu (Bao gồm cả displayOrder mới dựa trên vị trí index)
      const updates: ProjectGridUpdate[] = projects.map((p, index) => ({
        id: p.id,
        colSpan: p.colSpan || 1,
        rowSpan: p.rowSpan || 1,
        displayOrder: index + 1 // Quan trọng: Index trong mảng state chính là thứ tự hiển thị
      }));

      const res = await updatePortfolioLayout(session.access_token, updates);

      if (res.success) {
        toast.success('Đã lưu bố cục & thứ tự thành công!');
        setIsEditing(false);
      } else {
        toast.error(`Lỗi: ${res.error}`);
      }
    } catch (err) {
      const error = err as Error;
      toast.error(`Lỗi kết nối: ${error.message}`);
    } finally {
      setIsSaving(false);
    }
  };

  const handleReset = () => {
    if (confirm('Khôi phục lại ban đầu?')) setProjects(initialProjects);
  };

  return (
    <div className="space-y-6">
      {/* TOOLBAR */}
      <div className="sticky top-4 z-50 bg-[var(--admin-card)] border border-[var(--admin-border)] p-4 rounded-xl shadow-lg flex flex-col sm:flex-row justify-between items-center gap-4">
        <div className="flex items-center gap-3">
            <div className={`p-2 rounded-lg ${isEditing ? 'bg-indigo-100 text-indigo-600' : 'bg-green-100 text-green-600'}`}>
                {isEditing ? <Edit3 size={20} /> : <Check size={20} />}
            </div>
            <div>
                <h3 className="font-bold text-[var(--admin-fg)]">
                    {isEditing ? 'Chế độ Chỉnh sửa' : 'Chế độ Xem trước'}
                </h3>
                <p className="text-xs text-[var(--admin-sub)]">
                    {isEditing ? 'Kéo thả để sắp xếp. Bấm +/- để chỉnh size.' : 'Giao diện hiển thị giống hệt trang chủ.'}
                </p>
            </div>
        </div>

        <div className="flex gap-2">
          {!isEditing ? (
            <button
              onClick={() => setIsEditing(true)}
              className="px-6 py-2 bg-[var(--admin-primary)] text-white 
              rounded-lg text-sm font-medium hover:opacity-90 flex items-center gap-2 shadow-md cursor-pointer"
            >
              <MousePointerClick size={18} /> Bắt đầu sửa
            </button>
          ) : (
            <>
              <button onClick={handleReset} className="px-3 py-2 text-[var(--admin-sub)] hover:bg-[var(--admin-hover)] rounded-lg border border-transparent hover:border-[var(--admin-border)] cursor-pointer"><RotateCcw size={18} /></button>
              <button onClick={() => setIsEditing(false)} className="px-4 py-2 border border-[var(--admin-border)] text-[var(--admin-fg)] rounded-lg text-sm cursor-pointer">Hủy</button>
              <button onClick={handleSave} disabled={isSaving} className="px-6 py-2 bg-green-600 text-white rounded-lg text-sm font-medium hover:bg-green-700 shadow-md flex items-center gap-2 cursor-pointer">
                {isSaving ? '...' : <><Save size={18} /> Lưu thay đổi</>}
              </button>
            </>
          )}
        </div>
      </div>

      {/* GRID AREA */}
      <div className="border-2 border-dashed border-[var(--admin-border)] p-4 md:p-8 rounded-2xl bg-[var(--background)] min-h-[500px]">
        
        {/* --- DND CONTEXT WRAPPER --- */}
        <DndContext sensors={sensors} collisionDetection={closestCenter} onDragEnd={handleDragEnd}>
          <SortableContext items={projects.map(p => p.id)} strategy={rectSortingStrategy}>
            
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 auto-rows-[300px] md:auto-rows-[400px]">
              {projects.map((project) => (
                
                // Sử dụng Component Sortable Item
                <SortableProjectItem 
                    key={project.id} 
                    id={project.id} 
                    colSpan={project.colSpan || 1} 
                    rowSpan={project.rowSpan || 1}
                >
                  <div className={`relative w-full h-full rounded-lg overflow-hidden transition-all duration-300 ${isEditing ? 'ring-2 ring-offset-2 ring-indigo-500 z-10' : 'border border-transparent'}`}>
                    
                    {/* Hình ảnh */}
                    <div className="relative w-full h-full bg-gray-200 dark:bg-gray-800">
                      {project.image ? (
                          <Image
                          src={getImageSrc(project.image)}
                          alt={project.title}
                          fill
                          className={`object-cover transition-opacity ${isEditing ? 'opacity-40 grayscale' : 'opacity-100'}`}
                          />
                      ) : (
                          <div className="flex items-center justify-center h-full text-xs text-gray-500">No Image</div>
                      )}
                    </div>

                    {/* View Mode Overlay */}
                    {!isEditing && (
                      <div className="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex flex-col justify-end p-6 pointer-events-none">
                          <h3 className="text-xl font-bold text-white line-clamp-2">{project.title}</h3>
                      </div>
                    )}

                    {/* EDIT MODE CONTROLS */}
                    {isEditing && (
                      <div className="absolute inset-0 flex flex-col">
                         {/* --- NÚT KÉO THẢ (DRAG HANDLE) --- */}
                         {/* Class cursor-grab là quan trọng để báo hiệu có thể kéo */}
                         <div className="absolute top-2 right-2 p-2 bg-white text-black rounded cursor-grab active:cursor-grabbing shadow-lg hover:bg-gray-100 z-50">
                            <GripVertical size={20} />
                         </div>

                         {/* Info Badge */}
                         <div className="absolute top-2 left-2 bg-white/90 text-black px-2 py-1 rounded text-[10px] font-mono font-bold shadow-sm border border-gray-200">
                            W:{project.colSpan || 1} | H:{project.rowSpan || 1}
                         </div>

                         {/* Resize Controls (Không bị ảnh hưởng bởi drag) */}
                         <div className="flex-1 flex items-center justify-center gap-4" onPointerDown={(e) => e.stopPropagation()}> 
                            {/* e.stopPropagation() để ngăn việc bấm nút +/- bị hiểu nhầm là bắt đầu kéo */}
                            
                            {/* Width Control */}
                            <div className="flex flex-col items-center gap-1 bg-white/10 backdrop-blur-md p-2 rounded-lg border border-white/20">
                               <span className="text-[10px] font-bold text-white uppercase">Rộng</span>
                               <div className="flex gap-1">
                                  <button onClick={() => handleResize(project.id, 'col', -1)} disabled={(project.colSpan || 1) <= 1} className="w-8 h-8 bg-white text-black rounded font-bold hover:bg-indigo-50">-</button>
                                  <button onClick={() => handleResize(project.id, 'col', 1)} disabled={(project.colSpan || 1) >= 3} className="w-8 h-8 bg-white text-black rounded font-bold hover:bg-indigo-50">+</button>
                               </div>
                            </div>
                            {/* Height Control */}
                            <div className="flex flex-col items-center gap-1 bg-white/10 backdrop-blur-md p-2 rounded-lg border border-white/20">
                               <span className="text-[10px] font-bold text-white uppercase">Cao</span>
                               <div className="flex gap-1">
                                  <button onClick={() => handleResize(project.id, 'row', -1)} disabled={(project.rowSpan || 1) <= 1} className="w-8 h-8 bg-white text-black rounded font-bold hover:bg-indigo-50">-</button>
                                  <button onClick={() => handleResize(project.id, 'row', 1)} disabled={(project.rowSpan || 1) >= 4} className="w-8 h-8 bg-white text-black rounded font-bold hover:bg-indigo-50">+</button>
                               </div>
                            </div>
                         </div>
                         
                         <div className="absolute bottom-2 inset-x-0 text-center text-[10px] text-white/70 font-mono pointer-events-none">
                            {project.title}
                         </div>
                      </div>
                    )}
                  </div>
                </SortableProjectItem>
              ))}
            </div>

          </SortableContext>
        </DndContext>
      </div>
    </div>
  );
}
```

## File: src/components/admin/ProjectForm.tsx
```typescript
// src/components/admin/ProjectForm.tsx
'use client';

import React, { useEffect, useState } from 'react';
import { useRouter } from 'next/navigation';
import Image from 'next/image';
// 1. THAY ĐỔI QUAN TRỌNG: Dùng createBrowserClient thay vì client cũ
import { createBrowserClient } from '@supabase/ssr'; 
import { compressImage } from '@/lib/image-utils';
import { toast } from 'sonner';
import { 
  ArrowLeft, Upload, X, Save, Loader2, ImagePlus, Plus, Type, AlignLeft, Trash2 
} from 'lucide-react';
import SelectBox from '@/components/ui/SelectBox';
import { Layers } from 'lucide-react'; // Icon cho đẹp
// --- 1. ĐỊNH NGHĨA TYPES ---

export type FormMode = 'create' | 'edit';

interface Category {
  category_id: number;
  name: string;
}

interface CreditItem {
  label: string;
  value: string;
}

export interface BlockDB {
  type: 'heading' | 'paragraph' | 'imageRow';
  content?: string;
  images?: string[]; 
}

interface ContentBlockState {
  id: string;
  type: 'heading' | 'paragraph' | 'imageRow';
  content: string;
  existingImages: string[]; 
  newFiles: File[];         
  previews: string[];       
}

export interface ProjectInitialData {
  id?: number;
  title: string;
  client_name: string;
  description: string;
  category_id: string; 
  is_featured: boolean;
  thumbnail_url: string;
  credits: CreditItem[];
  content: BlockDB[];
}

interface ProjectFormProps {
  mode: FormMode;
  initialData?: ProjectInitialData;
}

// --- 2. COMPONENT CHÍNH ---

export default function ProjectForm({ mode, initialData }: ProjectFormProps) {
  // 2. KHỞI TẠO CLIENT SUPABASE CÓ COOKIE (Để Upload được)
  const [supabase] = useState(() => createBrowserClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
  ));

  const router = useRouter();
  const [isLoading, setIsLoading] = useState(false);
  const [categories, setCategories] = useState<Category[]>([]);

  // State Form
  const [formData, setFormData] = useState({
    title: '',
    client_name: '',
    description: '',
    category_id: '',
    is_featured: false,
  });

  const [thumbnailFile, setThumbnailFile] = useState<File | null>(null);
  const [thumbnailPreview, setThumbnailPreview] = useState<string | null>(null);
  const fillSampleCredits = () => {
    setCredits([
      { label: 'Producer', value: 'Thanh Hang - Choo Production' },
      { label: 'Art Director', value: 'Thien Nguyen' },
      { label: 'Photographer', value: 'Evis Tran' },
      { label: 'Model', value: 'Mai Phuoc Tri, Nguyễn Văn Long, Huế Hương, Fuka' },
      { label: 'Stylist', value: 'Bao Ngan' },
      { label: 'Stylist Assistant', value: 'Js Chucin' },
      { label: 'Lighting', value: 'An Pham, Huy Tran, Dat Ho Thanh' },
      { label: 'MUA', value: 'Hai Ngoc Nguyen, Tu Anh, Tu Linh' },
      { label: 'Set Designer', value: 'Harry Le, Long Tran' },
      { label: 'Accessories', value: 'Dat Duong' },
      { label: 'Support', value: 'Ngoc Ha' },
      { label: 'Location', value: 'Oni Studio' },
      ]);
  };
  const [credits, setCredits] = useState<CreditItem[]>([{ label: 'Photographer', value: '' }]);
  const [blocks, setBlocks] = useState<ContentBlockState[]>([]);

  // --- 3. KHỞI TẠO DỮ LIỆU ---
  useEffect(() => {
    const fetchCategories = async () => {
      const { data } = await supabase
        .from('portfolio_categories')
        .select('category_id, name')
        .eq('is_active', true)
        .order('display_order');
      if (data) setCategories(data as unknown as Category[]);
    };
    fetchCategories();

    if (mode === 'edit' && initialData) {
      setFormData({
        title: initialData.title || '',
        client_name: initialData.client_name || '',
        description: initialData.description || '',
        category_id: initialData.category_id || '',
        is_featured: initialData.is_featured || false,
      });

      if (initialData.thumbnail_url) {
        setThumbnailPreview(initialData.thumbnail_url);
      }

      if (initialData.credits?.length > 0) {
        setCredits(initialData.credits);
      }

      if (initialData.content?.length > 0) {
        const mappedBlocks: ContentBlockState[] = initialData.content.map((b) => ({
          id: Math.random().toString(36).substr(2, 9),
          type: b.type,
          content: b.content || '',
          existingImages: b.images || [],
          newFiles: [],
          previews: []
        }));
        setBlocks(mappedBlocks);
      }
    }
  }, [mode, initialData, supabase]);

  // --- 4. HELPER FUNCTIONS ---

  const addCredit = () => setCredits([...credits, { label: '', value: '' }]);
  const removeCredit = (index: number) => setCredits(credits.filter((_, i) => i !== index));
  const updateCredit = (index: number, field: keyof CreditItem, value: string) => {
    const newCredits = [...credits];
    newCredits[index][field] = value;
    setCredits(newCredits);
  };

  const addBlock = (type: ContentBlockState['type']) => {
    setBlocks([
      ...blocks, 
      { id: Math.random().toString(36).substr(2, 9), type, content: '', existingImages: [], newFiles: [], previews: [] }
    ]);
  };
  
  const removeBlock = (id: string) => setBlocks(blocks.filter(b => b.id !== id));
  
  const updateBlockContent = (id: string, content: string) => {
    setBlocks(blocks.map(b => b.id === id ? { ...b, content } : b));
  };

  const handleBlockImagesChange = (id: string, files: FileList | null) => {
    if (!files) return;
    const newFilesList = Array.from(files);
    const newPreviewsList = newFilesList.map(f => URL.createObjectURL(f));

    setBlocks(blocks.map(b => {
      if (b.id === id) {
        return {
          ...b,
          newFiles: [...b.newFiles, ...newFilesList],
          previews: [...b.previews, ...newPreviewsList]
        };
      }
      return b;
    }));
  };

  const removeImageFromBlock = (blockId: string, imgIndex: number, isExisting: boolean) => {
    setBlocks(blocks.map(b => {
      if (b.id !== blockId) return b;

      if (isExisting) {
        return { ...b, existingImages: b.existingImages.filter((_, i) => i !== imgIndex) };
      } else {
        const updatedFiles = b.newFiles.filter((_, i) => i !== imgIndex);
        const updatedPreviews = b.previews.filter((_, i) => i !== imgIndex);
        return { ...b, newFiles: updatedFiles, previews: updatedPreviews };
      }
    }));
  };

  // HÀM UPLOAD (Giờ sẽ hoạt động vì client 'supabase' đã có Auth Token)
  const uploadImage = async (file: File, folder: string): Promise<string | null> => {
    try {
      const compressedBlob = await compressImage(file);
      const compressedFile = new File([compressedBlob], file.name, { type: 'image/webp' });
      // Thêm timestamp để tránh trùng tên
      const fileName = `${folder}/${Date.now()}-${Math.random().toString(36).substring(7)}.webp`;
      
      const { error } = await supabase.storage.from('portfolio-images').upload(fileName, compressedFile);
      if (error) throw error;
      
      const { data } = supabase.storage.from('portfolio-images').getPublicUrl(fileName);
      return data.publicUrl;
    } catch (error) {
      console.error('Upload err:', error);
      return null;
    }
  };

  const generateSlug = (str: string) => {
    return str.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[đĐ]/g, 'd').replace(/[^a-z0-9\s-]/g, '').trim().replace(/\s+/g, '-') + '-' + Date.now();
  };

  // --- 5. SUBMIT FORM ---
  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!formData.title || !formData.category_id || (!thumbnailFile && !thumbnailPreview)) {
      toast.warning('Vui lòng điền tên, danh mục và ảnh đại diện.');
      return;
    }

    setIsLoading(true);
    const toastId = toast.loading('Đang xử lý dữ liệu...');

    try {
      // A. Upload Thumbnail
      let finalThumbnailUrl = thumbnailPreview; 
      if (thumbnailFile) {
        const url = await uploadImage(thumbnailFile, 'thumbnails');
        if (!url) throw new Error('Lỗi upload thumbnail');
        finalThumbnailUrl = url;
      }

      // B. Xử lý Content Blocks
      const finalContent = await Promise.all(blocks.map(async (block) => {
        let imageUrls: string[] = [...block.existingImages];

        if (block.type === 'imageRow' && block.newFiles.length > 0) {
          const uploadPromises = block.newFiles.map(file => uploadImage(file, 'gallery'));
          const newUrls = (await Promise.all(uploadPromises)).filter((url): url is string => url !== null);
          imageUrls = [...imageUrls, ...newUrls];
        }

        return {
          type: block.type,
          content: block.content,
          images: imageUrls.length > 0 ? imageUrls : undefined
        };
      }));

      // C. Chuẩn bị Payload
      const payload = {
        title: formData.title,
        client_name: formData.client_name,
        description: formData.description,
        category_id: parseInt(formData.category_id),
        is_featured: formData.is_featured,
        thumbnail_url: finalThumbnailUrl,
        credits: credits.filter(c => c.label && c.value), 
        content: finalContent,
        updated_at: new Date().toISOString(),
        ...(mode === 'create' ? { slug: generateSlug(formData.title) } : {}),
      };

      // D. Insert/Update
      if (mode === 'create') {
        const { data: { user } } = await supabase.auth.getUser();
        const { data: profile } = await supabase.from('users').select('user_id').eq('auth_id', user?.id).single();
        
        const { data, error } = await supabase
          .from('projects')
          .insert({ ...payload, created_by: profile?.user_id })
          .select('project_id')
          .single();
          
        if (error) throw error;
        toast.success('Tạo dự án mới thành công!', { id: toastId });
        
        if (data) router.push(`/admin/projects/${data.project_id}`);

      } else {
        const { error } = await supabase
          .from('projects')
          .update(payload)
          .eq('project_id', initialData?.id);
          
        if (error) throw error;
        toast.success('Cập nhật dự án thành công!', { id: toastId });
        router.refresh();
      }

    } catch (error: unknown) {
      let msg = 'Lỗi không xác định';
      if (error instanceof Error) msg = error.message;
      console.error(error);
      toast.error(`Lỗi: ${msg}`, { id: toastId });
    } finally {
      setIsLoading(false);
    }
  };

  // --- UI RENDER ---
  return (
    <div className="max-w-5xl mx-auto space-y-6 pb-20">
      <div className="flex items-center gap-4 mb-4">
        <button onClick={() => router.push('/admin/projects')} className="p-2 rounded-lg hover:bg-[var(--admin-hover)] text-[var(--admin-sub)] transition-colors">
          <ArrowLeft size={24} />
        </button>
        <div>
            <h1 className="text-2xl font-bold text-[var(--admin-fg)]">
            {mode === 'create' ? 'Thêm Dự án Mới' : 'Chỉnh sửa Dự án'}
            </h1>
            {mode === 'edit' && <p className="text-xs text-[var(--admin-sub)]">ID: {initialData?.id}</p>}
        </div>
      </div>

      <form onSubmit={handleSubmit} className="space-y-8">
        
        {/* INFO CARD */}
        <div className="p-6 bg-[var(--admin-card)] rounded-xl border border-[var(--admin-border)] shadow-sm space-y-6">
          <h2 className="text-lg font-semibold text-[var(--admin-fg)] border-b border-[var(--admin-border)] pb-4">Thông tin cơ bản</h2>
          
          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div className="space-y-2">
              <label className="text-sm font-medium text-[var(--admin-fg)]">Tên Dự án <span className="text-red-500">*</span></label>
              <input required type="text" className="admin-input" value={formData.title} onChange={e => setFormData({...formData, title: e.target.value})} placeholder="VD: Lookbook Summer 2024"/>
            </div>
            <div className="space-y-2">
              <label className="text-sm font-medium text-[var(--admin-fg)]">Khách hàng</label>
              <input type="text" className="admin-input" value={formData.client_name} onChange={e => setFormData({...formData, client_name: e.target.value})} placeholder="VD: Vogue Vietnam"/>
            </div>
            {/* THAY THẾ ĐOẠN SELECT CŨ BẰNG ĐOẠN NÀY */}
            <SelectBox
              label="Danh mục"
              required
              placeholder="-- Chọn danh mục dự án --"
              value={formData.category_id}
              onChange={(val) => setFormData({ ...formData, category_id: val })}
              icon={<Layers size={18} className="text-[var(--admin-sub)]" />}
              // Chuyển đổi mảng categories thành format chuẩn {label, value}
              options={categories.map(cat => ({
                label: cat.name,
                value: cat.category_id
              }))}
            />
            <div className="flex items-center space-x-3 mt-8">
              <input type="checkbox" id="is_featured" className="w-5 h-5 accent-[var(--admin-primary)]" checked={formData.is_featured} onChange={e => setFormData({...formData, is_featured: e.target.checked})} />
              <label htmlFor="is_featured" className="text-sm font-medium text-[var(--admin-fg)] cursor-pointer">Đánh dấu là <strong>Nổi bật</strong></label>
            </div>
          </div>

          <div className="space-y-2">
            <label className="text-sm font-medium text-[var(--admin-fg)]">Mô tả ngắn</label>
            <textarea rows={3} className="admin-input" value={formData.description} onChange={e => setFormData({...formData, description: e.target.value})} placeholder="Giới thiệu sơ lược về dự án..."/>
          </div>
          <div className="space-y-2">
            <label className="text-sm font-medium text-[var(--admin-fg)]">Ảnh đại diện (Thumbnail) 
              <span className="text-red-500">*</span>
              </label>
            
            {/* CONTAINER CHÍNH */}
            {/* Logic: Nếu có thumbnailPreview thì dùng 'h-auto' (cao tự do), ngược lại dùng 'aspect-video' (cố định) */}
            <div className={`
              relative w-full md:w-1/2 bg-[var(--admin-bg)] border-2 border-dashed border-[var(--admin-border)] rounded-lg overflow-hidden group hover:border-[var(--admin-primary)] transition-all duration-300
              ${thumbnailPreview ? 'h-auto' : 'aspect-video'}
            `}>
              
              {/* INPUT FILE (Luôn phủ lên trên cùng z-20 để click được ở mọi chỗ) */}
              <input 
                type="file" 
                accept="image/*" 
                className="absolute inset-0 w-full h-full opacity-0 z-20 cursor-pointer" 
                onChange={(e) => {
                  if(e.target.files?.[0]) {
                    setThumbnailFile(e.target.files[0]);
                    setThumbnailPreview(URL.createObjectURL(e.target.files[0]));
                  }
                }} 
              />

              {thumbnailPreview ? (
                <div className="relative w-full">
                  {/* Dùng thẻ <img> thường với w-full h-auto để container tự giãn theo ảnh */}
                  <Image 
                    src={thumbnailPreview} 
                    alt="Thumb" 
                    width={0} 
                    height={0} 
                    sizes="100vw"
                    className="w-full h-auto block" // Giữ nguyên class này để nó co giãn
                    unoptimized // QUAN TRỌNG: Bắt buộc có dòng này
                  />
                  
                  {/* Overlay hiển thị khi hover */}
                  <div className="absolute inset-0 bg-black/40 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity z-10">
                    <p className="text-white text-sm font-medium flex items-center gap-2">
                      <Upload size={16}/> Thay ảnh khác
                    </p>
                  </div>
                </div>
              ) : (
                /* Giao diện khi chưa có ảnh (Căn giữa trong khung aspect-video) */
                <div className="flex flex-col items-center justify-center h-full text-[var(--admin-sub)] group-hover:text-[var(--admin-primary)] transition-colors">
                  <ImagePlus size={32} className="mb-2" />
                  <span className="text-sm">Bấm để chọn ảnh</span>
                </div>
              )}
            </div>
          </div>
        </div>

        {/* CREDITS CARD */}
        <div className="p-6 bg-[var(--admin-card)] rounded-xl border border-[var(--admin-border)] shadow-sm space-y-4">
          <div className="flex justify-between items-center border-b border-[var(--admin-border)] pb-4">
          <h2 className="text-lg font-semibold text-[var(--admin-fg)]">Credits</h2>
          <div className="flex gap-2">
              {/* Nút điền mẫu */}
              <button type="button" onClick={fillSampleCredits} className="cursor-pointer text-sm text-[var(--admin-sub)] hover:text-white px-3 py-1.5 rounded-lg border border-[var(--admin-border)] hover:bg-[var(--admin-hover)] transition-colors">
                Điền mẫu
              </button>

              {/* Nút thêm dòng cũ */}
              <button type="button" onClick={addCredit} className="cursor-pointer text-sm text-[var(--admin-primary)] hover:bg-[var(--admin-hover)] px-3 py-1.5 rounded-lg flex items-center gap-1 transition-colors">
                  <Plus size={16}/> Thêm dòng
              </button>
          </div>
        </div>
          <div className="space-y-3">
            {credits.map((item, idx) => (
              <div key={idx} className="flex gap-4 items-center">
                <input placeholder="Vai trò (VD: Photo)" className="admin-input w-1/3" value={item.label} onChange={e => updateCredit(idx, 'label', e.target.value)} />
                <input placeholder="Tên (VD: Dang Tran)" className="admin-input w-1/2" value={item.value} onChange={e => updateCredit(idx, 'value', e.target.value)} />
                <button type="button" onClick={() => removeCredit(idx)} className="text-red-400 cursor-pointer hover:text-red-600 p-2 hover:bg-red-50 rounded-lg transition-colors"><Trash2 size={18} /></button>
              </div>
            ))}
          </div>
        </div>

        {/* CONTENT BUILDER */}
        <div className="p-6 bg-[var(--admin-card)] rounded-xl border border-[var(--admin-border)] shadow-sm space-y-6">
          <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center border-b border-[var(--admin-border)] pb-4 gap-4">
            <h2 className="text-lg font-semibold text-[var(--admin-fg)]">Nội dung bài viết</h2>
            <div className="flex gap-2">
              <button type="button" onClick={() => addBlock('heading')} className="btn-tool"><Type size={16}/> Tiêu đề</button>
              <button type="button" onClick={() => addBlock('paragraph')} className="btn-tool"><AlignLeft size={16}/> Đoạn văn</button>
              <button type="button" onClick={() => addBlock('imageRow')} className="btn-tool"><ImagePlus size={16}/> Hàng ảnh</button>
            </div>
          </div>

          <div className="space-y-6 min-h-[200px] bg-[var(--admin-bg)] p-4 rounded-lg border border-[var(--admin-border)]">
             {blocks.length === 0 && (
                <div className="flex flex-col items-center justify-center py-10 text-[var(--admin-sub)] opacity-60">
                    <AlignLeft size={48} className="mb-2" />
                    <p>Chưa có nội dung.</p>
                </div>
             )}
             
             {blocks.map((block, index) => (
               <div key={block.id} className="relative group bg-[var(--admin-card)] border border-[var(--admin-border)] rounded-lg p-6 shadow-sm transition-all hover:shadow-md">
                 <div className="absolute -left-3 -top-3 bg-[var(--admin-fg)] text-[var(--admin-bg)] text-[10px] font-bold px-2 py-1 rounded shadow uppercase tracking-wider">
                   {index + 1}. {block.type}
                 </div>
                 
                 <button type="button" onClick={() => removeBlock(block.id)} className="absolute top-2 right-2 text-[var(--admin-sub)] hover:text-red-500 hover:bg-[var(--admin-bg)] p-1.5 rounded-lg transition-all opacity-0 group-hover:opacity-100">
                    <X size={18}/>
                 </button>

                 <div className="mt-2">
                    {block.type === 'heading' && (
                        <input type="text" placeholder="Nhập tiêu đề section..." className="w-full text-xl font-bold bg-transparent border-b border-[var(--admin-border)] focus:border-[var(--admin-primary)] outline-none pb-2 text-[var(--admin-fg)]" value={block.content} onChange={e => updateBlockContent(block.id, e.target.value)} />
                    )}
                    
                    {block.type === 'paragraph' && (
                        <textarea rows={4} placeholder="Nhập nội dung đoạn văn..." className="w-full bg-[var(--admin-bg)] rounded p-3 resize-y outline-none text-[var(--admin-fg)] border border-transparent focus:border-[var(--admin-border)] transition-colors" value={block.content} onChange={e => updateBlockContent(block.id, e.target.value)} />
                    )}
                    
                    {block.type === 'imageRow' && (
                    <div>
                        <div className="grid grid-cols-2 sm:grid-cols-4 md:grid-cols-5 gap-4">
                            {/* ẢNH CŨ */}
                            {block.existingImages.map((src, i) => (
                                <div key={`exist-${i}`} className="relative aspect-square rounded-lg overflow-hidden border-2 border-green-500/50 group/img">
                                    <Image src={src} alt="exist" fill className="object-cover" />
                                    <div className="absolute inset-0 bg-black/0 group-hover/img:bg-black/20 transition-colors" />
                                    <button type="button" onClick={() => removeImageFromBlock(block.id, i, true)} className="absolute top-1 right-1 bg-red-500 text-white rounded-full p-1 opacity-0 group-hover/img:opacity-100 transition-opacity shadow-sm">
                                        <X size={12}/>
                                    </button>
                                </div>
                            ))}
                            {/* ẢNH MỚI */}
                            {block.previews.map((src, i) => (
                                <div key={`new-${i}`} className="relative aspect-square rounded-lg overflow-hidden border-2 border-blue-500/50 group/img">
                                    <Image src={src} alt="new" fill className="object-cover" />
                                    <div className="absolute inset-0 bg-black/0 group-hover/img:bg-black/20 transition-colors" />
                                    <button type="button" onClick={() => removeImageFromBlock(block.id, i, false)} className="absolute top-1 right-1 bg-red-500 text-white rounded-full p-1 opacity-0 group-hover/img:opacity-100 transition-opacity shadow-sm">
                                        <X size={12}/>
                                    </button>
                                </div>
                            ))}
                            <label className="flex flex-col items-center justify-center aspect-square border-2 border-dashed border-[var(--admin-border)] rounded-lg hover:bg-[var(--admin-hover)] hover:border-[var(--admin-primary)] cursor-pointer transition-all text-[var(--admin-sub)] hover:text-[var(--admin-primary)]">
                                <Upload size={24} className="mb-1"/>
                                <span className="text-xs font-medium">Thêm ảnh</span>
                                <input type="file" multiple accept="image/*" className="hidden" onChange={e => handleBlockImagesChange(block.id, e.target.files)} />
                            </label>
                        </div>
                    </div>
                    )}
                 </div>
               </div>
             ))}
          </div>
        </div>

        <div className="flex justify-end pt-6 border-t border-[var(--admin-border)] sticky bottom-0 bg-[var(--admin-bg)] py-4 z-20">
          <button type="submit" disabled={isLoading} className="flex items-center gap-2 px-8 py-3 bg-[var(--admin-primary)] text-white rounded-lg hover:opacity-90 shadow-lg shadow-indigo-500/30 font-medium disabled:opacity-70 transition-all transform hover:-translate-y-0.5">
            {isLoading ? <Loader2 className="animate-spin" /> : <Save size={20}/>} 
            {mode === 'create' ? 'Lưu & Tạo mới' : 'Cập nhật thay đổi'}
          </button>
        </div>
      </form>

      <style jsx global>{`
        .admin-input { width: 100%; padding: 0.75rem; background-color: var(--admin-bg); border: 1px solid var(--admin-border); border-radius: 0.5rem; outline: none; color: var(--admin-fg); transition: all 0.2s; }
        .admin-input:focus { border-color: var(--admin-primary); ring: 2px solid var(--admin-primary); }
        .btn-tool { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background-color: var(--admin-bg); border: 1px solid var(--admin-border); border-radius: 0.5rem; font-size: 0.875rem; color: var(--admin-fg); transition: all 0.2s; font-weight: 500; }
        .btn-tool:hover { background-color: var(--admin-hover); border-color: var(--admin-primary); color: var(--admin-primary); transform: translateY(-1px); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
      `}</style>
    </div>
  );
}
```

## File: src/components/admin/ProjectTable.tsx
```typescript
// src/components/admin/ProjectTable.tsx
'use client';

import React, { useState, useEffect, useMemo } from 'react';
import Image from 'next/image';
import Link from 'next/link';
import { Edit, Eye, Trash2, Search, Loader2, ArrowUpDown, ArrowDown, ArrowUp } from 'lucide-react';
import { useInView } from 'react-intersection-observer'; // Cần cài: npm install react-intersection-observer
import { toast } from 'sonner';
import { deleteProject, UserProfile } from '@/lib/actions';
import { createBrowserClient } from '@supabase/ssr';
import ConfirmModal from '@/components/ui/ConfirmModal';
import { ProjectData } from '@/data/projects-master-data';

interface ProjectTableProps {
  initialProjects: ProjectData[];
  itemsPerPage: number;
  userProfile: UserProfile | null;
}
// Định nghĩa các kiểu sort
type SortKey = 'id' | 'title' | 'categoryName' | 'isFeatured';
type SortDirection = 'asc' | 'desc';

interface SortConfig {
  key: SortKey;
  direction: SortDirection;
}

export default function ProjectTable({ initialProjects, itemsPerPage, userProfile }: ProjectTableProps) {
  // State Data
  const [projects, setProjects] = useState<ProjectData[]>(initialProjects);
  const [searchQuery, setSearchQuery] = useState('');
  // State Sort
  const [sortConfig, setSortConfig] = useState<SortConfig>({ key: 'id', direction: 'desc' });
  // State Pagination
  const [visibleCount, setVisibleCount] = useState(itemsPerPage);
  const { ref, inView } = useInView(); // Ref để gắn vào element đáy trang

  // State Delete Modal
  const [deleteModalOpen, setDeleteModalOpen] = useState(false);
  const [projectToDelete, setProjectToDelete] = useState<{ id: number, title: string } | null>(null);
  const [isDeleting, setIsDeleting] = useState(false);

  const supabase = createBrowserClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
  );

  // Hàm xử lý sắp xếp
  const handleSort = (key: SortKey) => {
    setSortConfig((current) => {
      if (current.key === key) {
        // Nếu đang click cột hiện tại -> Đảo chiều
        return { key, direction: current.direction === 'asc' ? 'desc' : 'asc' };
      }
      // Nếu click cột mới -> Mặc định tăng dần (A-Z)
      return { key, direction: 'asc' };
    });
  };
  // 3. LOGIC LỌC & SẮP XẾP (Dùng useMemo để tối ưu)
  const processedProjects = useMemo(() => {
    // A. Lọc theo Search
    const result = projects.filter(p => 
      p.title.toLowerCase().includes(searchQuery.toLowerCase()) ||
      p.client_name?.toLowerCase().includes(searchQuery.toLowerCase()) ||
      p.categoryName?.toLowerCase().includes(searchQuery.toLowerCase())
    );

    // B. Sắp xếp
    result.sort((a, b) => {
      const aValue = a[sortConfig.key];
      const bValue = b[sortConfig.key];

      // Xử lý trường hợp null/undefined
      if (aValue === undefined || aValue === null) return 1;
      if (bValue === undefined || bValue === null) return -1;

      // So sánh
      if (aValue < bValue) return sortConfig.direction === 'asc' ? -1 : 1;
      if (aValue > bValue) return sortConfig.direction === 'asc' ? 1 : -1;
      return 0;
    });

    return result;
  }, [projects, searchQuery, sortConfig]);

  // 2. Cắt danh sách để hiển thị (Infinite Scroll)
  const visibleProjects = processedProjects.slice(0, visibleCount);

  // 3. Tự động load thêm khi cuộn xuống đáy
  useEffect(() => {
    if (inView && visibleCount < processedProjects.length) {
      // Delay nhẹ để tạo cảm giác đang load (optional)
      const timer = setTimeout(() => {
        setVisibleCount(prev => prev + itemsPerPage);
      }, 300);
      return () => clearTimeout(timer);
    }
  }, [inView, visibleCount, processedProjects.length, itemsPerPage]);

  // Reset pagination khi search thay đổi
  useEffect(() => {
    setVisibleCount(itemsPerPage);
  }, [searchQuery, itemsPerPage]);

  // 4. Logic Xóa Dự án
  const openDeleteModal = (id: number, title: string) => {
    setProjectToDelete({ id, title });
    setDeleteModalOpen(true);
  };

  const handleDeleteConfirm = async () => {
    if (!projectToDelete) return;
    setIsDeleting(true);
    try {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) {
        toast.error("Hết phiên đăng nhập");
        return;
      }

      const res = await deleteProject(session.access_token, projectToDelete.id);
      if (res.success) {
        toast.success("Đã xóa dự án");
        // Cập nhật UI ngay lập tức (Không cần reload trang)
        setProjects(prev => prev.filter(p => p.id !== projectToDelete.id));
        setDeleteModalOpen(false);
      } else {
        toast.error(res.error);
      }
    } catch (error) {
        const msg = error instanceof Error ? error.message : "Lỗi hệ thống";
        toast.error(msg);
    } finally {
      setIsDeleting(false);
    }
  };
  // Component Header nhỏ để tái sử dụng
  const SortableHeader = ({ label, colKey, className = "" }: { label: string, colKey: SortKey, className?: string }) => {
    const isActive = sortConfig.key === colKey;
    return (
      <th 
        className={`p-4 cursor-pointer hover:bg-[var(--admin-hover)] transition-colors group select-none ${className}`}
        onClick={() => handleSort(colKey)}
      >
        <div className={`flex items-center gap-2 ${className.includes('text-center') ? 'justify-center' : ''}`}>
          {label}
          <span className={`text-[var(--admin-sub)] transition-opacity ${isActive ? 'opacity-100 text-[var(--admin-primary)]' : 'opacity-0 group-hover:opacity-50'}`}>
            {isActive ? (
              sortConfig.direction === 'asc' ? <ArrowUp size={14} /> : <ArrowDown size={14} />
            ) : (
              <ArrowUpDown size={14} />
            )}
          </span>
        </div>
      </th>
    );
  };
  return (
    <div className="space-y-6">
      
      {/* Toolbar */}
      <div className="flex gap-3 p-1 bg-[var(--admin-card)] rounded-xl border border-[var(--admin-border)] p-4 shadow-sm">
        <div className="relative flex-1">
            <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-[var(--admin-sub)]" size={18} />
            <input 
              type="text" 
              placeholder="Tìm kiếm dự án, khách hàng..." 
              className="w-full pl-10 pr-4 py-2.5 bg-[var(--admin-bg)] border border-[var(--admin-border)] rounded-lg text-sm outline-none focus:border-[var(--admin-primary)] text-[var(--admin-fg)] transition-all" 
              value={searchQuery}
              onChange={(e) => setSearchQuery(e.target.value)}
            />
        </div>
        <div className="text-sm text-[var(--admin-sub)] flex items-center px-3 bg-[var(--admin-bg)] rounded-lg border border-[var(--admin-border)]">
            {processedProjects.length} kết quả
        </div>
      </div>

      {/* Table */}
      <div className="bg-[var(--admin-card)] border border-[var(--admin-border)] rounded-xl overflow-hidden shadow-sm">
        <div className="overflow-x-auto">
          <table className="w-full text-left border-collapse">
            <thead>
              <tr className="bg-[var(--admin-bg)] border-b border-[var(--admin-border)] text-[var(--admin-sub)] text-xs uppercase tracking-wider">
                {/* 4. ÁP DỤNG SORTABLE HEADER */}
                <SortableHeader label="#ID" colKey="id" className="w-20 font-mono" />
                <th className="p-4 w-24">Ảnh</th>
                <SortableHeader label="Tên Dự Án" colKey="title" />
                <SortableHeader label="Danh Mục" colKey="categoryName" />
                <SortableHeader label="Trạng Thái" colKey="isFeatured" className="text-center" />
                <th className="p-4 text-right">Hành động</th>
              </tr>
            </thead>
            <tbody className="divide-y divide-[var(--admin-border)]">
              {visibleProjects.length === 0 ? (
                <tr>
                    <td colSpan={6} className="p-12 text-center text-[var(--admin-sub)] italic">
                        Không tìm thấy dự án nào.
                    </td>
                </tr>
              ) : (
                visibleProjects.map((project, index) => (
                  <tr key={project.id} className="hover:bg-[var(--admin-hover)] transition-colors group animate-fade-in-row"
                    // 3. TÍNH TOÁN ĐỘ TRỄ (STAGGER DELAY)
                    // index % itemsPerPage giúp reset delay khi qua trang mới (nếu có pagination) 
                    // hoặc chỉ đơn giản là index * 50ms
                    style={{ 
                      animationDelay: `${(index % itemsPerPage) * 0.05}s` 
                    }}>
                    <td className="p-4 text-xs text-[var(--admin-sub)] font-mono">#{project.id}</td>
                    <td className="p-4">
                      <div className="relative w-16 h-10 bg-gray-200 rounded overflow-hidden border border-[var(--admin-border)]">
                        {project.image ? (
                           <Image 
                             src={typeof project.image === 'string' ? project.image : project.image.src} 
                             alt={project.title} 
                             fill 
                             className="object-cover" 
                           />
                        ) : <div className="w-full h-full flex items-center justify-center text-[8px]">NO IMG</div>}
                      </div>
                    </td>
                    <td className="p-4">
                      <Link href={`/admin/projects/${project.id}`} className="font-medium text-[var(--admin-fg)] hover:text-[var(--admin-primary)] transition-colors block mb-0.5">
                        {project.title}
                      </Link>
                      <span className="text-xs text-[var(--admin-sub)]">{project.client_name}</span>
                    </td>
                    <td className="p-4">
                      <span className="inline-flex px-2.5 py-1 rounded-full text-xs font-medium bg-[var(--admin-bg)] border border-[var(--admin-border)] text-[var(--admin-fg)]">
                        {project.categoryName}
                      </span>
                    </td>
                    <td className="p-4 text-center">
                      {project.isFeatured && (
                        <span className="inline-flex items-center px-2 py-0.5 rounded text-[10px] font-bold bg-yellow-100 text-yellow-800 border border-yellow-200 shadow-sm">
                          NỔI BẬT
                        </span>
                      )}
                    </td>
                    <td className="p-4 text-right">
                      <div className="flex items-center justify-end gap-2 opacity-100 sm:opacity-0 sm:group-hover:opacity-100 transition-opacity">
                        <Link 
                          href={`/du-an/${project.slug}`} 
                          target="_blank"
                          className="p-2 text-[var(--admin-sub)] hover:text-[var(--admin-fg)] hover:bg-[var(--admin-card)] rounded-lg"
                          title="Xem trang web"
                        >
                          <Eye size={18} />
                        </Link>
                        
                        <Link 
                          href={`/admin/projects/${project.id}`} 
                          className="p-2 text-blue-500 hover:bg-[var(--admin-edit)] rounded-lg"
                          title="Chỉnh sửa"
                        >
                          <Edit size={18} />
                        </Link>
                        {/* CHỈ ADMIN MỚI THẤY */}
                        {userProfile?.role === 'Admin' && (
                          <>
                            <button 
                              onClick={() => openDeleteModal(Number(project.id), project.title)}
                              className="p-2 text-red-500 hover:bg-[var(--admin-delete)] rounded-lg cursor-pointer"
                              title="Xóa"
                            >
                              <Trash2 size={18} />
                            </button>
                           </>
                        )}
                        
                      </div>
                    </td>
                  </tr>
                ))
              )}
            </tbody>
          </table>
          
          {/* LOADER DƯỚI CÙNG ĐỂ KÍCH HOẠT LOAD MORE */}
          {visibleProjects.length < processedProjects.length && (
             <div ref={ref} className="p-4 flex justify-center">
                <Loader2 className="animate-spin text-[var(--admin-sub)]" />
             </div>
          )}
        </div>
      </div>

      {/* DELETE CONFIRM MODAL */}
      <ConfirmModal 
        isOpen={deleteModalOpen}
        onClose={() => !isDeleting && setDeleteModalOpen(false)}
        onConfirm={handleDeleteConfirm}
        title="Xóa dự án này?"
        description={`Bạn có chắc chắn muốn xóa dự án "${projectToDelete?.title}"? Hành động này sẽ xóa vĩnh viễn toàn bộ thông tin và hình ảnh liên quan.`}
        confirmText={isDeleting ? "Đang xóa..." : "Xóa vĩnh viễn"}
        cancelText="Đóng"
        variant="danger"
        isLoading={isDeleting}
      />
    </div>
  );
}
```

## File: src/components/AnimatedProfileImage.tsx
```typescript
// src/components/AnimatedProfileImage.tsx
'use client'; 

import { motion } from 'framer-motion';
import React from 'react';

export default function AnimatedProfileImage({ children }: { children: React.ReactNode }) {
  return (
    <motion.div
      className="w-full max-w-sm md:max-w-none bg-[var(--background)] shadow-2x"
      initial={{ opacity: 0, y: 20 }}
      whileInView={{ opacity: 1, y: 0 }}
      transition={{ duration: 0.5 }}
      viewport={{ once: true, amount: 0.3 }}
    >
      {children}
    </motion.div>
  );
}
```

## File: src/components/BrandScroller.tsx
```typescript
// src/components/BrandScroller.tsx
import React from 'react';
import Container from './Container';

// 1. CẬP NHẬT MÀU SẮC ICON
const brands = [
  {
    href: 'https://x.com',
    svg: (
      <svg width="120" height="109" viewBox="0 0 120 109" fill="none" xmlns="http://www.w3.org/2000/svg" 
           className="fill-[#ebebeb] dark:fill-gray-950 w-8 h-8"> {/* <-- THAY ĐỔI MÀU FILL */}
        <path d="M94.5068 0H112.907L72.7076 46.172L120 109H82.9692L53.9674 70.8942L20.7818 109H2.3693L45.3666 59.6147L0 0H37.9685L64.1848 34.8292L94.5068 0ZM88.0484 97.9318H98.2448L32.4288 10.4872H21.4882L88.0484 97.9318Z" />
      </svg>
    ),
  },
  {
    href: 'https://www.youtube.com',
    svg: (
      <svg width="206" height="143" viewBox="0 0 206 143" fill="none" xmlns="http://www.w3.org/2000/svg" 
           className="fill-[#ebebeb] dark:fill-gray-950 w-9 h-9"> {/* <-- THAY ĐỔI MÀU FILL */}
        <path fillRule="evenodd" clipRule="evenodd" d="M82.4536 97.9153V40.5946C102.803 50.1698 118.563 59.4196 137.202 69.3921C121.829 77.9181 102.803 87.4845 82.4536 97.9153ZM195.858 12.0864C192.348 7.46178 186.366 3.86191 179.996 2.6701C161.275 -0.884977 44.4825 -0.895089 25.7716 2.6701C20.664 3.62759 16.1159 5.94198 12.2089 9.53781C-4.25342 24.8174 0.905084 106.757 4.87314 120.03C6.54174 125.775 8.69882 129.918 11.4154 132.638C14.9154 136.234 19.7075 138.709 25.2119 139.82C40.6263 143.008 120.038 144.791 179.671 140.299C185.165 139.341 190.028 136.785 193.864 133.037C209.085 117.818 208.047 31.2775 195.858 12.0864Z" />
      </svg>
    ),
  },
  {
    href: 'https://github.com',
    svg: (
      <svg width="202" height="202" viewBox="0 0 202 202" fill="none" xmlns="http://www.w3.org/2000/svg" 
           className="fill-[#ebebeb] dark:fill-gray-950 w-9 h-9"> {/* <-- THAY ĐỔI MÀU FILL */}
        <path fillRule="evenodd" clipRule="evenodd" d="M101 0C156.782 0 202 46.3583 202 103.555C202 149.297 173.094 188.102 132.987 201.808C127.866 202.828 126.048 199.594 126.048 196.837C126.048 193.423 126.169 182.273 126.169 168.416C126.169 158.76 122.937 152.458 119.311 149.246C141.804 146.681 165.438 137.923 165.438 98.1495C165.438 86.8375 161.519 77.6066 155.035 70.3548C156.085 67.7389 159.55 57.2059 154.045 42.9447C154.045 42.9447 145.581 40.1699 126.3 53.5625C118.231 51.2698 109.585 50.1163 101 50.0759C92.415 50.1163 83.7795 51.2698 75.7197 53.5625C56.4186 40.1699 47.9346 42.9447 47.9346 42.9447C42.4503 57.2059 45.9146 67.7389 46.9549 70.3548C40.501 77.6066 36.5519 86.8375 36.5519 98.1495C36.5519 137.822 60.1354 146.714 82.5675 149.33C79.6789 151.916 77.063 156.477 76.154 163.173C70.397 165.819 55.7722 170.399 46.763 154.572C46.763 154.572 41.4201 144.623 31.2797 143.895C31.2797 143.895 21.4322 143.765 30.5929 150.188C30.5929 150.188 37.2084 153.37 41.8039 165.338C41.8039 165.338 47.7326 183.821 75.8308 177.559C75.8813 186.214 75.9722 194.372 75.9722 196.837C75.9722 199.574 74.1138 202.777 69.0739 201.818C28.9365 188.132 0 149.308 0 103.555C0 46.3583 45.2278 0 101 0Z" />
      </svg>
    ),
  },
  {
    href: 'https://instagram.com', // <-- Thay link
    svg: (
      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"
           className="fill-[#ebebeb] dark:fill-gray-950 w-8 h-8">
        <path fillRule="evenodd" clipRule="evenodd" d="M12 7.00004C9.23858 7.00004 7 9.23862 7 12.0001C7 14.7615 9.23858 17.0001 12 17.0001C14.7614 17.0001 17 14.7615 17 12.0001C17 9.23862 14.7614 7.00004 12 7.00004ZM9 12.0001C9 10.3432 10.3431 9.00004 12 9.00004C13.6569 9.00004 15 10.3432 15 12.0001C15 13.6569 13.6569 15.0001 12 15.0001C10.3431 15.0001 9 13.6569 9 12.0001Z" />
        <path d="M18 5.00002C17.4477 5.00002 17 5.44774 17 6.00002C17 6.5523 17.4477 7.00002 18 7.00002C18.5523 7.00002 19 6.5523 19 6.00002C19 5.44774 18.5523 5.00002 18 5.00002Z" />
        <path fillRule="evenodd" clipRule="evenodd" d="M5 1.00002C2.79086 1.00002 1 2.79088 1 5.00002V19.0001C1 21.2092 2.79086 23.0001 5 23.0001H19C21.2091 23.0001 23 21.2092 23 19.0001V5.00002C23 2.79088 21.2091 1.00002 19 1.00002H5ZM5 3.00002C3.89543 3.00002 3 3.89545 3 5.00002V19.0001C3 20.1046 3.89543 21.0001 5 21.0001H19C20.1046 21.0001 21 20.1046 21 19.0001V5.00002C21 3.89545 20.1046 3.00002 19 3.00002H5Z" />
      </svg>
    ),
  },
 {
    href: 'https://facebook.com', // <-- Thay link
    svg: (
      <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"
           className="fill-[#ebebeb] dark:fill-gray-950 w-8 h-8">
        <path d="M14,6h3a1,1,0,0,0,1-1V3a1,1,0,0,0-1-1H14A5,5,0,0,0,9,7v3H7a1,1,0,0,0-1,1v2a1,1,0,0,0,1,1H9v7a1,1,0,0,0,1,1h2a1,1,0,0,0,1-1V14h2.22a1,1,0,0,0,1-.76l.5-2a1,1,0,0,0-1-1.24H13V7A1,1,0,0,1,14,6Z"></path>
      </svg>
    )
  },
    {
    href: 'https://tiktok.com', // <-- Thay link
    svg: (
      <svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg"
           className="fill-[#ebebeb] dark:fill-gray-950 w-8 h-8">
        <path d="M16.656 1.029c1.637-0.025 3.262-0.012 4.886-0.025 0.054 2.031 0.878 3.859 2.189 5.213l-0.002-0.002c1.411 1.271 3.247 2.095 5.271 2.235l0.028 0.002v5.036c-1.912-0.048-3.71-0.489-5.331-1.247l0.082 0.034c-0.784-0.377-1.447-0.764-2.077-1.196l0.052 0.034c-0.012 3.649 0.012 7.298-0.025 10.934-0.103 1.853-0.719 3.543-1.707 4.954l0.020-0.031c-1.652 2.366-4.328 3.919-7.371 4.011l-0.014 0c-0.123 0.006-0.268 0.009-0.414 0.009-1.73 0-3.347-0.482-4.725-1.319l0.040 0.023c-2.508-1.509-4.238-4.091-4.558-7.094l-0.004-0.041c-0.025-0.625-0.037-1.25-0.012-1.862 0.49-4.779 4.494-8.476 9.361-8.476 0.547 0 1.083 0.047 1.604 0.136l-0.056-0.008c0.025 1.849-0.050 3.699-0.050 5.548-0.423-0.153-0.911-0.242-1.42-0.242-1.868 0-3.457 1.194-4.045 2.861l-0.009 0.030c-0.133 0.427-0.21 0.918-0.21 1.426 0 0.206 0.013 0.41 0.037 0.61l-0.002-0.024c0.332 2.046 2.086 3.59 4.201 3.59 0.061 0 0.121-0.001 0.181-0.004l-0.009 0c1.463-0.044 2.733-0.831 3.451-1.994l0.010-0.018c0.267-0.372 0.45-0.822 0.511-1.311l0.001-0.014c0.125-2.237 0.075-4.461 0.087-6.698 0.012-5.036-0.012-10.060 0.025-15.083z"></path>
      </svg>
    )
  },
  {
    href: 'https://behance.net', // <-- Thay link
    svg: (
      <svg viewBox="0 0 95.802 95.802" xmlns="http://www.w3.org/2000/svg"
           className="fill-[#ebebeb] dark:fill-gray-950 w-9 h-9"> {/* <-- Cỡ w-9 h-9 cho cân đối */}
        <g>
          <path d="M38.664,44.689c0,0,9.065-0.673,9.065-11.306c0-10.632-7.417-15.819-16.813-15.819H13.622h-0.508H0v59.414h13.114h0.508 h17.294c0,0,18.873,0.597,18.873-17.536C49.79,59.442,50.613,44.689,38.664,44.689z M13.622,28.125h15.069h2.226 c0,0,4.203,0,4.203,6.181c0,6.181-2.473,7.077-5.275,7.077H13.622V28.125z M30.119,66.42H13.622V50.541h17.294 c0,0,6.264-0.08,6.264,8.16C37.18,65.572,32.599,66.351,30.119,66.42z"></path>
          <rect x="62.18" y="21.064" width="24.514" height="7.317"></rect>
          <path d="M74.961,32.682c-22.848,0-22.828,22.826-22.828,22.826s-1.566,22.713,22.829,22.713c0,0,20.331,1.162,20.331-15.801 H84.837c0,0,0.349,6.391-9.526,6.391c0,0-10.455,0.699-10.455-10.34h30.785C95.641,58.471,99.009,32.682,74.961,32.682z M84.255,50.541H64.738c0,0,1.277-9.158,10.455-9.158C84.372,41.382,84.255,50.541,84.255,50.541z"></path>
        </g>
      </svg>
    )
  }
];

const repeatedBrands = [...brands, ...brands];

// 2. CẬP NHẬT NỀN CỦA ICON
const BrandList = ({ 'aria-hidden': ariaHidden = false }) => (
  <ul
    className="flex items-center justify-center md:justify-start [&_li]:mx-4 sm:[&_li]:mx-8 animate-infinite-scroll"
    aria-hidden={ariaHidden}
  >
    {repeatedBrands.map((brand, index) => (
      <li key={index}>
        <a
          target="_blank"
          rel="noopener noreferrer"
          href={brand.href}
          className="border border-[var(--foreground)]
                     bg-white 
                     grid place-content-center p-3 rounded-md
                     transition-opacity hover:opacity-70" /* <-- THAY ĐỔI NỀN ICON */
        >
          {brand.svg}
        </a>
      </li>
    ))}
  </ul>
);

export default function BrandScroller() {
  return (
    <Container>
      <div
        className="w-full py-8 inline-flex flex-nowrap overflow-hidden 
                  mask-[linear-gradient(to_right,transparent_0,black_128px,black_calc(100%-200px),transparent_100%)]"
      >
        <BrandList />
        <BrandList aria-hidden={true} />
      </div>
    </Container>
  );
}
```

## File: src/components/BtsSection.tsx
```typescript
// src/components/BtsSection.tsx
'use client';

import React, { useState, useEffect, useRef } from 'react';
import Image from 'next/image';
import Container from './Container'; // Tận dụng Container bạn đã có
import projects from '../data/bts'; // Import dữ liệu Section 04
import styles from '../app/styles/BtsSection.module.css'; // File CSS module mới

// Component con cho từng "cảnh" text
interface SceneProps {
  project: (typeof projects)[0];
  onVisible: () => void; // Hàm callback khi scene này active
  isActive: boolean;
}

const Scene: React.FC<SceneProps> = ({ project, onVisible, isActive }) => {
  const ref = useRef<HTMLDivElement>(null);

  useEffect(() => {
    const node = ref.current;
    if (!node) return;

    // Kích hoạt khi scene đi vào giữa màn hình
    const observer = new IntersectionObserver(
      (entries) => {
        const [entry] = entries;
        if (entry.isIntersecting) {
          onVisible(); // Gọi hàm callback để cập nhật activeIndex
        }
      },
      {
        threshold: 0.5, // Kích hoạt khi 50% nội dung lọt vào
        rootMargin: '0px 0px -40% 0px', // Thu hẹp vùng trigger vào giữa
      }
    );

    observer.observe(node);
    return () => observer.disconnect();
  }, [onVisible]);

  return (
      // Scene bây giờ là một "màn hình" full-height
      <div ref={ref} className={styles.scene}>
        {/* Bọc nội dung text trong Container để giữ chiều rộng */}
        <Container>
          <div className={`${styles.sceneContent} ${isActive ? styles.sceneActive : ''}`}>
            <span className={styles.sceneCategory}>
              {project.client} / {project.year}
            </span>
            <h3 className={styles.sceneTitle}>{project.title}</h3>
            <p className={styles.sceneDescription}>{project.description}</p>
          </div>
        </Container>
      </div>
    );
};

export default function BtsSection() {
  const [activeIndex, setActiveIndex] = useState(0);
  const btsProjects = projects.slice(0, 6);

  return (
    <section id="case-studies" className={styles.btsSection}>
      {/* 1. PHẦN HÌNH ẢNH (STICKY Ở NỀN) */}
      <div className={styles.stickyImageWrapper}>
        {btsProjects.map((project, index) => (
          <div
            key={project.title}
            className={`${styles.imageContainer} ${
              activeIndex === index ? styles.imageActive : ''
            }`}
          >
            <Image
              src={project.imageUrl} // Ảnh ngang của bạn
              alt={project.title}
              fill
              objectFit="cover" // object-fit: cover bây giờ sẽ hoạt động TỐT
              quality={90}
              priority={index === 0}
              className={styles.image}
            />
            <div className={styles.imageOverlay} /> {/* Thêm lớp phủ mờ */}
          </div>
        ))}
      </div>

      {/* 2. PHẦN NỘI DUNG (CUỘN LÊN TRÊN) */}
      {/* Tiêu đề cho Section (cuộn bình thường) */}
      <div className={styles.sectionHeader}>
        <Container>
          <h2 className={styles.sectionTitle}>Hậu trường</h2>
          <p className={styles.sectionSubtitle}>
            Câu chuyện và bối cảnh đằng sau những tác phẩm chọn lọc.
          </p>
        </Container>
      </div>

      {/* Cột text cuộn (đè lên trên ảnh) */}
      <div className={styles.textColumn}>
        {btsProjects.map((project, index) => (
          <Scene
           key={project.title}
            project={project}
            onVisible={() => setActiveIndex(index)}
            isActive={activeIndex === index}
          />
        ))}
      </div>
    </section>
  );
}
```

## File: src/components/project-grid.tsx
```typescript
// app/thoi-trang/project-grid.tsx
'use client';

import { useState, useEffect, useRef, useCallback } from 'react';
import Link from 'next/link';
import Image from 'next/image';
import type { Project } from '@/lib/seed-helpers';
import Spinner from '@/components/Spinner';
import {
  INITIAL_LOAD_COUNT,
  LOAD_MORE_COUNT,
  SLUG_CATE_PERSONAL,
  SLUG_CATE_COMMERCIAL,
  SLUG_CATE_FASHION,
} from '@/lib/constants';

interface ProjectGridProps {
  allProjects: Project[];
}

export default function ProjectGrid({ allProjects }: ProjectGridProps) {
  const [displayedProjects, setDisplayedProjects] = useState<Project[]>(
    allProjects.slice(0, INITIAL_LOAD_COUNT)
  );
  const [currentIndex, setCurrentIndex] = useState(INITIAL_LOAD_COUNT);
  const [hasMore, setHasMore] = useState(
    allProjects.length > INITIAL_LOAD_COUNT
  );
  const [isLoading, setIsLoading] = useState(false);
  const loaderRef = useRef<HTMLDivElement>(null);

  const loadMoreProjects = useCallback(() => {
    if (isLoading || !hasMore) return;
    setIsLoading(true);
    setTimeout(() => {
      const nextIndex = currentIndex + LOAD_MORE_COUNT;
      const newProjects = allProjects.slice(currentIndex, nextIndex);
      setDisplayedProjects((prev) => [...prev, ...newProjects]);
      setCurrentIndex(nextIndex);
      setHasMore(nextIndex < allProjects.length);
      setIsLoading(false);
    }, 500);
  }, [isLoading, hasMore, currentIndex, allProjects]);

  // ... (useEffect cho IntersectionObserver giữ nguyên) ...
  useEffect(() => {
    const observer = new IntersectionObserver(
      (entries) => {
        const firstEntry = entries[0];
        if (firstEntry.isIntersecting && hasMore && !isLoading) {
          loadMoreProjects();
        }
      },
      { threshold: 1.0 }
    );
    const currentLoader = loaderRef.current;
    if (currentLoader) {
      observer.observe(currentLoader);
    }
    return () => {
      if (currentLoader) {
        observer.unobserve(currentLoader);
      }
    };
  }, [hasMore, isLoading, loadMoreProjects]);

  // 3. (MỚI) Lấy category của grid này
  // (Giả định tất cả project trong `allProjects` đều cùng 1 category)
  const gridCategory = allProjects[0]?.cateSlug;

  // 4. (MỚI) Helper function để lấy class cho item <Link>
  const getLinkClassName = (project: Project, index: number): string => {
    const baseClasses = 'relative group rounded-sm';

    switch (gridCategory) {
      case SLUG_CATE_FASHION:
        // Logic cho 'thoi-trang': thêm top-[24px] cho ảnh chẵn
        const fashionClass = index % 2 !== 0 ? 'top-[24px]' : '';
        return `${baseClasses} ${fashionClass}`;

      case SLUG_CATE_PERSONAL:
        const colSpan = project.colSpan || 'col-span-1'; // Fallback
        const rowSpan = project.rowSpan || 'row-span-1'; // Fallback
        return `${baseClasses} ${colSpan} ${rowSpan}`;

      case SLUG_CATE_COMMERCIAL:
      default:
        // 'thuong-mai' và mặc định: không có class đặc biệt
        return baseClasses;
    }
  };

  // 5. (MỚI) Helper function để lấy class cho grid wrapper <div>
  const getGridWrapperClassName = (category: string | undefined): string => {
    const baseGap = 'gap-3 md:gap-4';

    switch (category) {
      case SLUG_CATE_PERSONAL:
      case SLUG_CATE_FASHION:
      case SLUG_CATE_COMMERCIAL:
      default:
        // Layout 4 cột, auto-rows như cũ
        return `grid grid-cols-2 md:grid-cols-4 auto-rows-[200px] md:auto-rows-[300px] ${baseGap}`;
    }
  };

  // 6. Render
  return (
    <>
      {/* (CẬP NHẬT) Dùng class wrapper động */}
      <div className={getGridWrapperClassName(gridCategory)}>
        {displayedProjects.map((project, index) => {
          let imageSizes: string;
          const colSpan = project.colSpan || '';

          if (gridCategory === SLUG_CATE_PERSONAL) {
            // Logic cho grid 'ca-nhan' (12 cột)
            if (colSpan.includes('md:col-span-6')) { // 6/12 cột
              imageSizes = '(max-width: 768px) 50vw, 50vw';
            } else if (colSpan.includes('md:col-span-4')) { // 4/12 cột
              imageSizes = '(max-width: 768px) 50vw, 33vw';
            } else {
              imageSizes = '(max-width: 768px) 50vw, 25vw'; // Fallback
            }
          } else {
            // Logic cho 'thoi-trang' và 'thuong-mai' (4 cột)
            // (Hiện tại layout 2 trang này đơn giản, nên dùng chung 1 sizes)
            imageSizes = '(max-width: 768px) 50vw, 25vw';
          }

          return (
          <Link
            key={project.id}
            href={`/du-an/${project.slug}`}
            // (CẬP NHẬT) Dùng class item động
            className={getLinkClassName(project, index)}
          >
            <Image
              src={project.src}
              alt={project.title}
              fill
              sizes={imageSizes}
              className="object-cover transition-transform duration-700 ease-in-out group-hover:scale-105"
            />
            <div className="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent opacity-0 transition-opacity duration-500 group-hover:opacity-100" />
            <div className="absolute inset-0 p-4 flex flex-col justify-end translate-y-4 opacity-0 transition-all duration-500 group-hover:translate-y-0 group-hover:opacity-100">
              <span className="text-[10px] md:text-xs text-white/80 uppercase tracking-widest mb-2">
                {project.category || 'Project'}
              </span>
              <h3 className="text-white text-lg md:text-xl font-medium flex items-center gap-2">
                {project.title}
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  fill="none"
                  viewBox="0 0 24 24"
                  strokeWidth={2}
                  stroke="currentColor"
                  className="w-4 h-4 opacity-0 -translate-x-2 transition-all duration-500 group-hover:opacity-100 group-hover:translate-x-0"
                >
                  <path
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    d="M13.5 4.5L21 12m0 0l-7.5 7.5M21 12H3"
                  />
                </svg>
              </h3>
            </div>
            {/* --- Hết nội dung bên trong Link --- */}
          </Link>
        );
      })}
      </div>

      {/* --- PHẦN LOADER (Giữ nguyên) --- */}
      <div
        ref={loaderRef}
        className="col-span-2 md:col-span-4 h-24 flex justify-center items-center"
      >
        {hasMore && <Spinner />}
        {!hasMore && (
          <p className="text-[var(--sub-text)]">Đã tải hết dự án.</p>
        )}
      </div>
    </>
  );
}
```

## File: src/components/ScrollToTopButton.tsx
```typescript
//ScrollToTopButton.tsx
'use client'; // Bắt buộc vì dùng hooks

import { useEffect, useState } from 'react';

export default function ScrollToTopButton() {
  const [isVisible, setIsVisible] = useState(false);

  // 1. Hook để theo dõi vị trí cuộn
  useEffect(() => {
    const toggleVisibility = () => {
      // Hiển thị nút khi cuộn qua 400px
      if (window.scrollY > 400) {
        setIsVisible(true);
      } else {
        setIsVisible(false);
      }
    };

    window.addEventListener('scroll', toggleVisibility);

    // Dọn dẹp listener khi component bị hủy
    return () => {
      window.removeEventListener('scroll', toggleVisibility);
    };
  }, []); // Chỉ chạy 1 lần khi mount

  // 2. Hàm xử lý khi click
  const scrollToTop = () => {
    window.scrollTo({
      top: 0,
      behavior: 'smooth', // Cuộn mượt
    });
  };

  return (
    <button
      onClick={scrollToTop}
      className={`fixed bottom-6 right-6 z-30 p-3
                 bg-[var(--foreground)] text-[var(--background)] hover:text-[var(--foreground)] rounded-full
                 shadow-lg cursor-pointer
                 transition-all duration-300 ease-in-out
                 hover:bg-[var(--background)] border-3 border-[var(--background)] hover:border-[var(--foreground)]
                 ${
                   isVisible
                     ? 'opacity-100 translate-y-0'
                     : 'opacity-0 translate-y-4 pointer-events-none'
                 }
                `}
      aria-label="Cuộn lên đầu trang"
    >
      {/* Đây là SVG mũi tên lên */}
      <svg
        xmlns="http://www.w3.org/2000/svg"
        fill="none"
        viewBox="0 0 24 24"
        strokeWidth={2}
        stroke="currentColor"
        className="w-5 h-5"
      >
        <path
          strokeLinecap="round"
          strokeLinejoin="round"
          d="m4.5 15.75 7.5-7.5 7.5 7.5"
        />
      </svg>
    </button>
  );
}
```

## File: src/components/ui/ConfirmModal.tsx
```typescript
// src/components/ui/ConfirmModal.tsx
'use client';

import React from 'react';
import { AlertTriangle, Loader2 } from 'lucide-react';
import ModalPortal from './ModalPortal';

interface ConfirmModalProps {
  isOpen: boolean;
  onClose: () => void;
  onConfirm: () => void;
  title: string;
  description: string;
  confirmText?: string;
  cancelText?: string;
  isLoading?: boolean;
  variant?: 'danger' | 'warning' | 'info';
}

export default function ConfirmModal({
  isOpen,
  onClose,
  onConfirm,
  title,
  description,
  confirmText = 'Xác nhận',
  cancelText = 'Hủy bỏ',
  isLoading = false,
  variant = 'danger'
}: ConfirmModalProps) {

  return (
    <ModalPortal isOpen={isOpen} onClose={isLoading ? () => {} : onClose} className="max-w-md">
        
        {/* Header Area */}
        <div className="p-6 pb-2 flex gap-5">
          <div className={`w-12 h-12 rounded-full flex items-center justify-center flex-shrink-0 ${
            variant === 'danger' ? 'bg-red-100 text-red-600 dark:bg-red-900/30' : 
            variant === 'warning' ? 'bg-yellow-100 text-yellow-600' : 'bg-blue-100 text-blue-600'
          }`}>
            <AlertTriangle size={24} />
          </div>
          
          <div className="flex-1 pt-1 pr-6">
            <h3 className="text-lg font-bold text-[var(--admin-fg)] leading-tight mb-2">
              {title}
            </h3>
            <p className="text-sm text-[var(--admin-sub)] leading-relaxed">
              {description}
            </p>
          </div>
        </div>

        {/* Footer Buttons */}
        <div className="p-6 pt-6 flex justify-end gap-3 bg-[var(--admin-bg)]/50 border-t border-[var(--admin-border)]">
          <button
            onClick={onClose}
            disabled={isLoading}
            className="px-5 py-2.5 rounded-xl text-sm font-medium text-[var(--admin-fg)] border border-[var(--admin-border)] hover:bg-[var(--admin-hover)] transition-colors disabled:opacity-50 cursor-pointer"
          >
            {cancelText}
          </button>
          
          <button
            onClick={onConfirm}
            disabled={isLoading}
            className={`
              px-5 py-2.5 rounded-xl text-sm font-medium text-white shadow-lg flex items-center gap-2 transition-all hover:translate-y-[-1px] cursor-pointer
              ${variant === 'danger' ? 'bg-red-600 hover:bg-red-700 shadow-red-500/20' : 'bg-indigo-600 hover:bg-indigo-700'}
              disabled:opacity-70 disabled:cursor-not-allowed disabled:transform-none
            `}
          >
            {isLoading && <Loader2 size={16} className="animate-spin" />}
            {confirmText}
          </button>
        </div>
    </ModalPortal>
  );
}
```

## File: src/lib/seed-helpers.ts
```typescript
// src/lib/seed-helpers.ts
import { StaticImageData } from 'next/image';

// Định nghĩa lại Project để bao gồm 'originalSlug' (cho mục đích demo)
export interface Project {
  id: number;
  slug: string;
  title: string;
  description?: string;
  src: StaticImageData;
  category: string;
  cateSlug: string;
  credits?: { label: string; value: string }[];
  articleBody?: ArticleBlock[];
  colSpan: string;
  rowSpan: string;
  // Thêm các trường tùy chọn cho demo
  isMock?: boolean;
  originalSlug?: string; // Sẽ lưu slug gốc ở đây
}

export type ArticleBlock =
  | { type: 'heading'; content: string }
  | { type: 'paragraph'; content: string }
  | { type: 'imageRow'; images: StaticImageData[] };

export function seedProjectsByCategory(
  allActualProjects: Project[],
  category: string,
  targetCount: number
): Project[] {
  
  const sourceProjects = allActualProjects.filter(
    (p) => p.category === category
  );

  if (sourceProjects.length === 0) {
    console.warn(`[seedProjects] Không tìm thấy dự án nào cho danh mục: ${category}`);
    return [];
  }

  const seededList: Project[] = [];
  const numSourceProjects = sourceProjects.length;

  for (let i = 0; i < targetCount; i++) {
    const projectToCopy = sourceProjects[i % numSourceProjects];
    const mockId = 10000 + i;

    const newProject: Project = { // Sử dụng kiểu Project đã định nghĩa
      ...projectToCopy,
      
      // 1. Tạo ID và Slug GIẢ (chỉ để dùng làm 'key' trong React)
      id: mockId,
      slug: `${projectToCopy.slug}-${i}`, // Slug giả duy nhất (ví dụ: ca-nhan-01-0, ca-nhan-01-1)
      
      // 2. Lưu lại Slug GỐC (để dùng cho href)
      originalSlug: projectToCopy.slug, // Đây là slug thật (ví dụ: ca-nhan-01)
      cateSlug : projectToCopy.cateSlug,
      isMock: true,
      colSpan: projectToCopy.colSpan,
      rowSpan: projectToCopy.rowSpan,
    };

    seededList.push(newProject);
  }

  return seededList;
}
```

## File: src/app/not-found.tsx
```typescript
// src/app/not-found.tsx

import Link from 'next/link';
import Container from '@/components/Container'; // Tái sử dụng Container
import type { Metadata } from 'next';

export const metadata: Metadata = {
  title: '404 - Không tìm thấy | Oni Studio',
  description: 'Trang bạn đang tìm kiếm không tồn tại.',
};

export default function NotFound() {
  return (
    <Container>
      <div className="flex flex-col items-center justify-center text-center py-24 md:py-32 min-h-[calc(100vh_-_250px)]">
        
        {/* Mã lỗi 404 */}
        <span className="text-7xl md:text-9xl font-light tracking-tighter text-[var(--foreground)]">
          404
        </span>
        
        {/* Tiêu đề */}
        <h1 className="mt-4 text-3xl md:text-4xl font-light tracking-tight">
          Không tìm thấy trang
        </h1>
        
        {/* Mô tả */}
        <p className="mt-2 text-lg text-[var(--sub-text)]">
          Rất tiếc, chúng tôi không thể tìm thấy trang bạn yêu cầu.
        </p>

        <Link
          href="/"
          className="mt-10 py-3 px-8 bg-transparent 
                     border border-[var(--foreground)] 
                     text-[var(--foreground)] hover:text-[var(--background)]
                     hover:bg-[var(--foreground)]
                     transition-colors duration-300 cursor-pointer"
        >
          Quay về Trang chủ
        </Link>
      </div>
    </Container>
  );
}
```

## File: src/components/admin/SettingsForm.tsx
```typescript
// src/components/admin/SettingsForm.tsx
'use client';

import { useState } from 'react'; // Bỏ useTransition vì không dùng nút riêng nữa
import { toast } from 'sonner';
import { Save, RotateCcw, Monitor, List, Database, Minus, Plus, Loader2, Clock } from 'lucide-react';
import { SettingItem, updateSettings } from '@/lib/actions/settings';

interface SettingsFormProps {
  initialSettings: SettingItem[];
  initialCleanupMinutes: number;
}

export default function SettingsForm({ initialSettings, initialCleanupMinutes }: SettingsFormProps) {
  // State chung
  const [settings, setSettings] = useState<SettingItem[]>(initialSettings);
  // State riêng cho cleanup (để bind vào input number)
  const [cleanupTime, setCleanupTime] = useState(initialCleanupMinutes);
  
  const [isSaving, setIsSaving] = useState(false);

  // Helper lấy value từ state chung
  const getValue = (key: string) => settings.find(s => s.key === key)?.value || '';

  // Helper update state chung
  const updateLocalSetting = (key: string, newValue: string) => {
    setSettings(prev => prev.map(s => s.key === key ? { ...s, value: newValue } : s));
  };

  // Logic tăng giảm số lượng (giữ nguyên)
  const handleNumberChange = (key: string, type: 'increase' | 'decrease') => {
    const currentVal = parseInt(getValue(key) || '10');
    let newVal = currentVal;
    if (type === 'increase') {
        newVal = currentVal < 5 ? 5 : currentVal + 5;
    } else {
        newVal = currentVal <= 5 ? 1 : currentVal - 5;
    }
    newVal = Math.max(1, Math.min(100, newVal));
    updateLocalSetting(key, newVal.toString());
  };

  // --- HÀM LƯU TỔNG HỢP (QUAN TRỌNG NHẤT) ---
  const handleSave = async () => {
    setIsSaving(true);
    const toastId = toast.loading('Đang lưu cấu hình...');

    try {
      // 1. Tạo payload từ danh sách settings hiện tại
      // Lọc bỏ key 'CLEANUP_GAP_MINUTES' cũ nếu lỡ nó có nằm trong mảng settings (để tránh trùng lặp)
      const baseUpdates = settings
        .filter(s => s.key !== 'CLEANUP_GAP_MINUTES')
        .map(s => ({ key: s.key, value: s.value }));

      // 2. Gộp giá trị Cleanup Time hiện tại vào payload
      const finalUpdates = [
        ...baseUpdates,
        { key: 'CLEANUP_GAP_MINUTES', value: cleanupTime.toString() }
      ];

      // 3. Gửi 1 request duy nhất update tất cả
      const res = await updateSettings(finalUpdates);

      if (res.success) {
        toast.success('Đã lưu tất cả cấu hình!', { id: toastId });
        // Dispatch event nếu cần
        if (typeof window !== 'undefined') {
            window.dispatchEvent(new Event('settings:updated'));
        }
      } else {
        toast.error(`Lỗi: ${res.error}`, { id: toastId });
      }
    } catch (error) {
        const msg = error instanceof Error ? error.message : 'Có lỗi xảy ra';
        toast.error(msg, { id: toastId });
    } finally {
      setIsSaving(false);
    }
  };

  return (
    <div className="max-w-4xl mx-auto space-y-8">
      
      {/* CARD 0: VẬN HÀNH STUDIO */}
      <div className="bg-[var(--admin-card)] border border-[var(--admin-border)] rounded-xl p-6 shadow-sm">
        <div className="flex items-center gap-3 mb-6 border-b border-[var(--admin-border)] pb-4">
          <div className="p-2 bg-purple-100 text-purple-600 rounded-lg">
            <Clock size={20} />
          </div>
          <div>
            <h3 className="font-bold text-[var(--admin-fg)]">Vận hành Studio</h3>
            <p className="text-xs text-[var(--admin-sub)]">Quản lý thời gian và quy trình.</p>
          </div>
        </div>
        <div className="flex flex-col md:flex-row gap-4 items-end">
            <div className="flex-1">
                <label className="block text-sm font-medium text-[var(--admin-sub)] mb-2">
                    Thời gian dọn dẹp (Phút)
                </label>
                <input
                    type="number" step="15" min="0"
                    value={cleanupTime}
                    onChange={(e) => setCleanupTime(Number(e.target.value))}
                    disabled
                    className="w-full max-w-[200px] p-2 rounded-lg bg-[var(--admin-bg)] border border-[var(--admin-border)] text-[var(--admin-fg)] focus:ring-2 focus:ring-[var(--admin-primary)] outline-none"
                />
                <p className="text-[10px] text-[var(--admin-sub)] mt-2">
                    * Giá trị này sẽ được lưu cùng nút Lưu cấu hình bên dưới.
                </p>
            </div>
        </div>
      </div>

      {/* CARD 1: HIỂN THỊ */}
      <div className="bg-[var(--admin-card)] border border-[var(--admin-border)] rounded-xl p-6 shadow-sm">
        <div className="flex items-center gap-3 mb-6 border-b border-[var(--admin-border)] pb-4">
          <div className="p-2 bg-indigo-100 text-indigo-600 rounded-lg">
            <List size={20} />
          </div>
          <div>
            <h3 className="font-bold text-[var(--admin-fg)]">Hiển thị & Danh sách</h3>
            <p className="text-xs text-[var(--admin-sub)]">Điều chỉnh số lượng dữ liệu trên bảng và trang chủ.</p>
          </div>
        </div>

        <div className="grid gap-6 md:grid-cols-2">
          {/* ITEMS PER PAGE CONTROL */}
          <div className="space-y-2">
            <label className="text-sm font-medium text-[var(--admin-fg)]">Số dự án mỗi lần tải (Admin Table)</label>
            <div className="flex items-center gap-4">
              <div className="flex items-center border border-[var(--admin-border)] rounded-lg bg-[var(--admin-bg)]">
                <button 
                  onClick={() => handleNumberChange('items_per_page', 'decrease')}
                  className="p-3 hover:bg-[var(--admin-hover)] text-[var(--admin-sub)]
                   hover:text-[var(--admin-fg)] border-r border-[var(--admin-border)] cursor-pointer"
                >
                  <Minus size={16} />
                </button>
                <input 
                  type="number" 
                  className="w-16 text-center bg-transparent outline-none font-bold text-[var(--admin-fg)]"
                  value={getValue('items_per_page')}
                  readOnly 
                />
                <button 
                  onClick={() => handleNumberChange('items_per_page', 'increase')}
                  className="p-3 hover:bg-[var(--admin-hover)] text-[var(--admin-sub)] 
                  hover:text-[var(--admin-fg)] border-l border-[var(--admin-border)] cursor-pointer"
                >
                  <Plus size={16} />
                </button>
              </div>
              <span className="text-xs text-[var(--admin-sub)]">dự án / trang</span>
            </div>
            <p className="text-[10px] text-[var(--admin-sub)] mt-1">
                * Mặc định là 10.
            </p>
          </div>
        </div>
      </div>

      {/* CARD 2: THÔNG TIN WEBSITE */}
      <div className="bg-[var(--admin-card)] border border-[var(--admin-border)] rounded-xl p-6 shadow-sm">
        <div className="flex items-center gap-3 mb-6 border-b border-[var(--admin-border)] pb-4">
          <div className="p-2 bg-blue-100 text-blue-600 rounded-lg">
            <Monitor size={20} />
          </div>
          <div>
            <h3 className="font-bold text-[var(--admin-fg)]">Thông tin Website</h3>
            <p className="text-xs text-[var(--admin-sub)]">Các thông tin hiển thị trên thanh tiêu đề trình duyệt.</p>
          </div>
        </div>

        <div className="space-y-4">
          <div className="space-y-2">
            <label className="text-sm font-medium text-[var(--admin-fg)]">Tiêu đề trang (Site Title)</label>
            <input 
              type="text" 
              className="w-full p-2.5 bg-[var(--admin-bg)] border border-[var(--admin-border)] rounded-lg outline-none focus:border-[var(--admin-primary)] text-[var(--admin-fg)] transition-all"
              value={getValue('site_title')}
              onChange={(e) => updateLocalSetting('site_title', e.target.value)}
            />
          </div>
        </div>
      </div>

      {/* CARD 3: HỆ THỐNG */}
      <div className="bg-[var(--admin-card)] border border-[var(--admin-border)] rounded-xl p-6 shadow-sm opacity-90 space-y-4">
        <div className="flex items-center gap-3 mb-6 border-b border-[var(--admin-border)] pb-4">
          <div className="p-2 bg-orange-100 text-orange-600 rounded-lg">
            <Database size={20} />
          </div>
          <div>
            <h3 className="font-bold text-[var(--admin-fg)]">Cấu hình Hệ thống</h3>
            <p className="text-xs text-[var(--admin-sub)]">Các thiết lập nâng cao.</p>
          </div>
        </div>

        <div className="flex items-center justify-between p-4 bg-[var(--admin-bg)] rounded-lg border border-[var(--admin-border)]">
          <div>
            <span className="font-medium text-[var(--admin-fg)] block">Chế độ Demo</span>
            <span className="text-xs text-[var(--admin-sub)]">Nếu bật, website sẽ hiển thị dữ liệu giả thay vì từ Database.</span>
          </div>
          <label className="relative inline-flex items-center cursor-pointer">
            <input 
              type="checkbox" 
              className="sr-only peer" 
              checked={getValue('is_demo_mode') === 'true'}
              onChange={(e) => updateLocalSetting('is_demo_mode', e.target.checked ? 'true' : 'false')}
            />
            <div className="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-indigo-300 dark:peer-focus:ring-indigo-800 rounded-full peer dark:bg-gray-700 peer-checked:bg-[var(--admin-primary)] after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:after:translate-x-full peer-checked:after:border-white"></div>
          </label>
        </div>
        <div className="flex items-center justify-between p-4 bg-[var(--admin-bg)] rounded-lg border border-[var(--admin-border)]">
            <div>
              <span className="font-medium text-[var(--admin-fg)] block">Tự động Đăng xuất</span>
              <span className="text-xs text-[var(--admin-sub)]">Hệ thống sẽ khóa phiên làm việc nếu không có hoạt động chuột/phím.</span>
            </div>
            
            <div className="flex items-center border border-[var(--admin-border)] rounded-lg bg-[var(--admin-card)]">
              <button 
                onClick={() => handleNumberChange('idle_timeout_minutes', 'decrease')}
                className="p-2 hover:bg-[var(--admin-hover)] text-[var(--admin-sub)] 
                border-r border-[var(--admin-border)] disabled:opacity-50 cursor-pointer"
                disabled={parseInt(getValue('idle_timeout_minutes')) <= 5}
              >
                <Minus size={16} />
              </button>
              
              <div className="w-20 text-center font-mono font-bold text-[var(--admin-fg)] flex items-center justify-center gap-1">
                 {getValue('idle_timeout_minutes') || '60'} <span className="text-[10px] font-normal text-[var(--admin-sub)]">phút</span>
              </div>
              
              <button 
                onClick={() => handleNumberChange('idle_timeout_minutes', 'increase')}
                className="p-2 hover:bg-[var(--admin-hover)] text-[var(--admin-sub)] 
                border-l border-[var(--admin-border)] cursor-pointer"
              >
                <Plus size={16} />
              </button>
            </div>
          </div>
      </div>

      {/* ACTION BAR - NÚT LƯU DUY NHẤT */}
      <div className="flex justify-end gap-4 sticky bottom-4 pt-4 bg-gradient-to-t from-[var(--admin-bg)] to-transparent pb-4 z-10">
        <button 
          onClick={() => {
              setSettings(initialSettings);
              setCleanupTime(initialCleanupMinutes);
          }}
          className="px-4 py-2 rounded-lg bg-[var(--admin-card)] border border-[var(--admin-border)] 
          text-[var(--admin-sub)] hover:bg-[var(--admin-hover)] flex items-center gap-2 shadow-sm cursor-pointer"
        >
          <RotateCcw size={18} /> Khôi phục
        </button>
        <button 
          onClick={handleSave}
          disabled={isSaving}
          className="px-6 py-2 rounded-lg bg-[var(--admin-primary)] text-[var(--admin-fg)] font-medium 
          hover:opacity-90 flex items-center gap-2 shadow-lg shadow-indigo-500/30 disabled:opacity-70 cursor-pointer"
        >
          {isSaving ? <Loader2 className="animate-spin" size={18} /> : <Save size={18} />}
          Lưu tất cả cấu hình
        </button>
      </div>
    </div>
  );
}
```

## File: src/components/Footer.tsx
```typescript
'use client'; // Bắt buộc vì dùng hook client-side

import { useEffect, useRef, useState } from 'react';

export default function Footer() {
  const footerRef = useRef<HTMLDivElement>(null);
  const [visible, setVisible] = useState(false);

  useEffect(() => {
    const footer = footerRef.current;
    if (!footer) return;

    const observer = new IntersectionObserver(
      (entries) => {
        const [entry] = entries;
        setVisible(entry.isIntersecting);
      },
      {
        root: null,
        threshold: 0.2, // hiển thị khi 20% footer vào khung nhìn
      }
    );

    observer.observe(footer);
    return () => observer.disconnect();
  }, []);

  return (
  <footer
      ref={footerRef}
      className={`w-full text-center py-8 transition-all duration-700 ease-out
        ${visible ? 'opacity-100 translate-y-0' : 'opacity-0 translate-y-10'}
        
        // Mặc định (Light): nền sáng, chữ tối
        bg-gray-100 text-gray-700 
        
        // Khi Dark: nền đen, chữ trắng
        dark:bg-black dark:text-white 
      `}
    >
  Đ. Lý Thường Kiệt, Phường Phú Thọ, Quận 11, Thành phố Hồ Chí Minh, Việt Nam </footer>
  );
}
```

## File: src/components/HeroSection.tsx
```typescript
// src/components/HeroSection.tsx

'use client'; // 1. Bắt buộc để sử dụng thư viện animation

import Image from 'next/image';
import Container from './Container';
import Background from '../assets/section_01/hero-background.webp';
import { TypeAnimation } from 'react-type-animation'; // 2. Import thư viện

export default function HeroSection() {
  return (
    <section
      id="welcome"
      className="relative h-screen flex items-center justify-center overflow-hidden text-white"
    >
      {/* Lớp chứa hình ảnh nền */}
      <div className="absolute inset-0 z-0">
        <Image
          src={Background}
          fill={true}
          quality={80}
          alt="Background"
          style={{ objectFit: 'cover' }}
          sizes="100vw"   // Báo cho browser biết nó chiếm full màn hình
        />
        <div className="absolute inset-0 bg-black/40"></div>
      </div>
      
      {/* Lớp chứa nội dung văn bản */}
      <Container className="relative z-10 text-center">
        {/* 3. Thay thế <h1> cũ bằng TypeAnimation */}
        <TypeAnimation
          // 'sequence' là mảng chứa các hành động
          // [Slogan 1, Dừng 2 giây, Slogan 2, Dừng 2 giây, Slogan 3, Dừng...]
          sequence={[
            'Chạm vào vẻ đẹp qua lăng kính ánh sáng.', // Slogan 1
            2000, // Dừng 2 giây
            'Uy tín trọn từng khoảnh khắc.', // Slogan 2 (thay thế Slogan 1)
            2000, // Dừng 2 giây
            'Bảo chứng khoảnh khắc bằng uy tín.', // Slogan 3
            2000, // Dừng 2 giây
          ]}
          wrapper="h1" // 4. Bắt buộc: Giữ thẻ <h1> để đảm bảo SEO
          cursor={true} // Có hiển thị con trỏ gõ chữ
          repeat={Infinity} // Lặp lại vô hạn
          // 5. Sao chép toàn bộ class của <h1> cũ,
          //    NHƯNG XÓA 'animate-fade-in-up'
          className="text-4xl md:text-6xl font-light tracking-tighter text-shadow-md text-gray-200"
        />

        {/* --- (PHƯƠNG ÁN THAY THẾ) ---
            Nếu bạn chỉ muốn 1 slogan lặp lại (gõ ra rồi xóa đi)
            Hãy dùng đoạn code bên dưới và xóa đoạn TypeAnimation ở trên */}

        {/* <TypeAnimation
          sequence={[
            'Uy tín trọn từng khoảnh khắc.',
            4000, // Dừng 4 giây
            '',     // Xóa đi
            1000, // Dừng 1 giây (trước khi gõ lại)
          ]}
          wrapper="h1"
          cursor={true}
          repeat={Infinity}
          className="text-4xl md:text-6xl font-light tracking-tighter text-shadow-md text-gray-200"
        /> */}
       
      </Container>

      {/* Chỉ báo cuộn xuống (Giữ nguyên) */}
      <div className="absolute bottom-8 left-1/2 -translate-x-1/2 z-10 animate-bounce">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
          strokeWidth={1.5}
          stroke="currentColor"
          className="w-6 h-6 text-white/80"
        >
          <path
            strokeLinecap="round"
            strokeLinejoin="round"
            d="m19.5 8.25-7.5 7.5-7.5-7.5"
          />
        </svg>
      </div>
    </section>
  );
}
```

## File: src/components/LayoutWrapper.tsx
```typescript
// src/components/LayoutWrapper.tsx
'use client'; 
import { useState, useEffect, useRef, ReactNode } from 'react';
import Header from '@/components/Header'; 
import Footer from '@/components/Footer';
import { usePathname } from 'next/navigation';

interface LayoutWrapperProps {
  children: ReactNode;
}

export default function LayoutWrapper({ children }: LayoutWrapperProps) {
  // State để quyết định có hiển thị header fixed hay không
  const [showFixedHeader, setShowFixedHeader] = useState(false);
  // State để lưu chiều cao của header gốc
  const [headerHeight, setHeaderHeight] = useState(0);
  // Ref để tham chiếu đến header gốc và đo chiều cao
  const originalHeaderRef = useRef<HTMLDivElement>(null);

  const pathname = usePathname();
  // Kiểm tra xem trang hiện tại có phải là Admin không
  const isAdminPage = pathname?.startsWith('/admin');
  const isAdminLoginPage = pathname === '/login';

  // 1. Đo chiều cao của header gốc sau khi component mount
  useEffect(() => {
    if (originalHeaderRef.current) {
      setHeaderHeight(originalHeaderRef.current.offsetHeight);
    }
  }, []); // Chỉ chạy 1 lần

  // 2. Thêm listener để theo dõi sự kiện cuộn
  useEffect(() => {
    // Chỉ chạy logic nếu đã đo được chiều cao (headerHeight > 0)
    if (headerHeight === 0) return;

    const handleScroll = () => {
      // Nếu vị trí cuộn (window.scrollY) lớn hơn chiều cao của header
      // -> hiển thị header fixed
      if (window.scrollY > headerHeight) {
        setShowFixedHeader(true);
      } else {
        setShowFixedHeader(false);
      }
    };

    // Đăng ký sự kiện
    window.addEventListener('scroll', handleScroll);

    // Hủy đăng ký sự kiện khi component unmount
    return () => {
      window.removeEventListener('scroll', handleScroll);
    };
  }, [headerHeight]); // Chạy lại mỗi khi headerHeight thay đổi
  if (isAdminPage || isAdminLoginPage) {
    return <>{children}</>;
  }
  return (
    <>
      {/* 1. HEADER GỐC (Static) */}
      {/* z-20: Nằm dưới header fixed (z-30) */}
      <div ref={originalHeaderRef} className="relative z-20">
        <Header />
      </div>

      {/* 2. HEADER MỚI (Fixed) */}
      {/* Header này luôn ở đó, nhưng được ẩn/hiện bằng 'translate' */}
      <div
        className={`fixed top-0 left-0 right-0 z-50 bg-[var(--background)] 
                      text-[var(--foreground)] border-b border-[var(--foreground)]
                   transition-transform duration-300 ease-in-out 
                   ${
                     showFixedHeader ? 'translate-y-0' : '-translate-y-full'
                   }`}
      >
        <Header />
      </div>

      <main className="flex-1">{children}</main>

      <Footer />
    </>
  );
}
```

## File: src/components/ProjectNavigation.tsx
```typescript
// src/components/ProjectNavigation.tsx
import React from 'react';
import Link from 'next/link';
import styles from '../app/styles/ProjectArticle.module.css';

interface ProjectNavigationProps {
  prevProjectLink: string | null; // <-- ĐỔI TÊN
  nextProjectLink: string | null; // <-- ĐỔI TÊN
}

const ProjectNavigation: React.FC<ProjectNavigationProps> = ({
  prevProjectLink,
  nextProjectLink,
}) => {
  return (
    <div className={styles.projectNavigation}>
      {/* Nút Previous */}
      {prevProjectLink ? (
        // Trường hợp 1: Có dự án trước -> Dùng link đã build
        <Link href={prevProjectLink} className={styles.navLink}>
          &larr; Dự án trước
        </Link>
      ) : (
        // Trường hợp 2: Đã ở đầu -> Link về Trang chủ
        <Link href="/" className={styles.navLink} title="Về trang chủ">
          &larr; Trang chủ
        </Link>
      )}

      {/* Nút Next */}
      {nextProjectLink ? (
        // Trường hợp 1: Có dự án tiếp theo -> Dùng link đã build
        <Link href={nextProjectLink} className={styles.navLink}>
          Dự án tiếp theo &rarr;
        </Link>
      ) : (
        // Trường hợp 2: Đã ở cuối -> Link về Trang chủ
        <Link href="/" className={styles.navLink} title="Về trang chủ">
          Trang chủ &rarr;
        </Link>
      )}
    </div>
  );
};

export default ProjectNavigation;
```

## File: src/components/ThemeToggle.tsx
```typescript
// src/components/ThemeToggle.tsx
'use client';

import { useState, useEffect } from 'react';
import { useTheme } from 'next-themes';

// Thêm prop isAdmin
interface ThemeToggleProps {
  isAdmin?: boolean;
}

export default function ThemeToggle({ isAdmin = false }: ThemeToggleProps) {
  const [mounted, setMounted] = useState(false);
  const { theme, setTheme } = useTheme();

  useEffect(() => {
    setMounted(true);
  }, []);

  if (!mounted) {
    return <div className="w-9 h-9" />;
  }

  const toggleTheme = () => {
    setTheme(theme === 'light' ? 'dark' : 'light');
  };

  // Cấu hình màu sắc dựa trên isAdmin
  const buttonClass = isAdmin
    ? "p-1 cursor-pointer rounded-lg transition-all duration-200 bg-[var(--admin-primary)] hover:bg-[var(--admin-hover)] text-[var(--admin-primary-fg)] hover:text-[var(--admin-fg)] border border-transparent border-[var(--admin-border)]"
    : "rounded-md transition-colors cursor-pointer";

  const iconClass = isAdmin
    ? "w-5 h-5" // Icon Admin nhỏ gọn hơn chút
    : "w-6 h-6 p-1";

  // Icon Admin (Dùng Lucide cho đồng bộ với Admin Layout)
  // Hoặc dùng SVG cũ nhưng đổi màu theo biến admin
  return (
    <button
      onClick={toggleTheme}
      className={buttonClass}
      aria-label="Chuyển chế độ Sáng/Tối"
    >
      {theme === 'light' ? (
        // DARK MODE ICON
        isAdmin ? (
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={iconClass}><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>
        ) : (
          // Icon Client cũ (Mặt trăng)
          <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" className="w-6 h-6 text-white bg-black/80 rounded-md p-1" fill="currentColor">
             <path d="M12 22C17.5228 22 22 17.5228 22 12C22 11.5373 21.3065 11.4608 21.0672 11.8568C19.9289 13.7406 17.8615 15 15.5 15C11.9101 15 9 12.0899 9 8.5C9 6.13845 10.2594 4.07105 12.1432 2.93276C12.5392 2.69347 12.4627 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z"></path>
          </svg>
        )
      ) : (
        // LIGHT MODE ICON
        isAdmin ? (
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={iconClass}><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>
        ) : (
           // Icon Client cũ (Mặt trời)
           <svg viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg" className="w-6 h-6 text-black bg-white/80 rounded-md p-1">
              <path d="M12 17.75C10.8628 17.75 9.75106 17.4128 8.80547 16.781C7.85989 16.1491 7.1229 15.2511 6.6877 14.2004C6.25249 13.1498 6.13862 11.9936 6.36049 10.8782C6.58235 9.76284 7.12999 8.73829 7.93414 7.93414C8.73829 7.12999 9.76284 6.58235 10.8782 6.36049C11.9936 6.13862 13.1498 6.25249 14.2004 6.6877C15.2511 7.1229 16.1491 7.85989 16.781 8.80547C17.4128 9.75106 17.75 10.8628 17.75 12C17.7474 13.5242 17.1407 14.9852 16.0629 16.0629C14.9852 17.1407 13.5242 17.7474 12 17.75ZM12 7.75C11.1594 7.75 10.3377 7.99926 9.63883 8.46626C8.93992 8.93325 8.39519 9.59701 8.07351 10.3736C7.75184 11.1502 7.66768 12.0047 7.83167 12.8291C7.99565 13.6536 8.40043 14.4108 8.9948 15.0052C9.58917 15.5996 10.3464 16.0044 11.1709 16.1683C11.9953 16.3323 12.8498 16.2482 13.6264 15.9265C14.403 15.6048 15.0668 15.0601 15.5337 14.3612C16.0007 13.6623 16.25 12.8406 16.25 12C16.2474 10.8736 15.7987 9.79417 15.0023 8.99772C14.2058 8.20126 13.1264 7.75264 12 7.75Z"></path>
              <path d="M12 5C11.8019 4.99741 11.6126 4.91756 11.4725 4.77747C11.3324 4.63737 11.2526 4.44811 11.25 4.25V2.75C11.25 2.55109 11.329 2.36032 11.4697 2.21967C11.6103 2.07902 11.8011 2 12 2C12.1989 2 12.3897 2.07902 12.5303 2.21967C12.671 2.36032 12.75 2.55109 12.75 2.75V4.25C12.7474 4.44811 12.6676 4.63737 12.5275 4.77747C12.3874 4.91756 12.1981 4.99741 12 5Z"></path>
              <path d="M12 22C11.8019 21.9974 11.6126 21.9176 11.4725 21.7775C11.3324 21.6374 11.2526 21.4481 11.25 21.25V19.75C11.25 19.5511 11.329 19.3603 11.4697 19.2197C11.6103 19.079 11.8011 19 12 19C12.1989 19 12.3897 19.079 12.5303 19.2197C12.671 19.3603 12.75 19.5511 12.75 19.75V21.25C12.7474 21.4481 12.6676 21.6374 12.5275 21.7775C12.3874 21.9176 12.1981 21.9974 12 22Z"></path>
              <path d="M21.25 12.75H19.75C19.5511 12.75 19.3603 12.671 19.2197 12.5303C19.079 12.3897 19 12.1989 19 12C19 11.8011 19.079 11.6103 19.2197 11.4697C19.3603 11.329 19.5511 11.25 19.75 11.25H21.25C21.4489 11.25 21.6397 11.329 21.7803 11.4697C21.921 11.6103 22 11.8011 22 12C22 12.1989 21.921 12.3897 21.7803 12.5303C21.6397 12.671 21.4489 12.75 21.25 12.75Z"></path>
              <path d="M4.25 12.75H2.75C2.55109 12.75 2.36032 12.671 2.21967 12.5303C2.07902 12.3897 2 12.1989 2 12C2 11.8011 2.07902 11.6103 2.21967 11.4697C2.36032 11.329 2.55109 11.25 2.75 11.25H4.25C4.44891 11.25 4.63968 11.329 4.78033 11.4697C4.92098 11.6103 5 11.8011 5 12C5 12.1989 4.92098 12.3897 4.78033 12.5303C4.63968 12.671 4.44891 12.75 4.25 12.75Z"></path>
              <path d="M6.50001 7.24995C6.30707 7.2352 6.12758 7.14545 6.00001 6.99995L4.91001 5.99995C4.83844 5.92838 4.78167 5.84341 4.74293 5.7499C4.7042 5.65639 4.68427 5.55617 4.68427 5.45495C4.68427 5.35373 4.7042 5.25351 4.74293 5.16C4.78167 5.06649 4.83844 4.98152 4.91001 4.90995C4.98158 4.83838 5.06655 4.78161 5.16006 4.74287C5.25357 4.70414 5.3538 4.6842 5.45501 4.6842C5.55623 4.6842 5.65645 4.70414 5.74996 4.74287C5.84347 4.78161 5.92844 4.83838 6.00001 4.90995L7.00001 5.99995C7.123 6.13746 7.19099 6.31547 7.19099 6.49995C7.19099 6.68443 7.123 6.86244 7.00001 6.99995C6.87244 7.14545 6.69295 7.2352 6.50001 7.24995Z"></path>
              <path d="M18.56 19.31C18.4615 19.3104 18.3638 19.2912 18.2728 19.2534C18.1818 19.2157 18.0993 19.1601 18.03 19.09L17 18C16.9332 17.86 16.9114 17.7028 16.9376 17.5499C16.9638 17.3971 17.0368 17.2561 17.1465 17.1464C17.2561 17.0368 17.3971 16.9638 17.55 16.9376C17.7028 16.9113 17.8601 16.9331 18 17L19.09 18C19.2305 18.1406 19.3094 18.3312 19.3094 18.53C19.3094 18.7287 19.2305 18.9194 19.09 19.06C19.0233 19.1355 18.9419 19.1967 18.8508 19.2397C18.7597 19.2827 18.6607 19.3066 18.56 19.31Z"></path>
              <path d="M17.5 7.24995C17.3071 7.2352 17.1276 7.14545 17 6.99995C16.877 6.86244 16.809 6.68443 16.809 6.49995C16.809 6.31547 16.877 6.13746 17 5.99995L18 4.90995C18.1445 4.76541 18.3406 4.6842 18.545 4.6842C18.7494 4.6842 18.9455 4.76541 19.09 4.90995C19.2345 5.05449 19.3158 5.25054 19.3158 5.45495C19.3158 5.65936 19.2345 5.85541 19.09 5.99995L18 6.99995C17.8724 7.14545 17.6929 7.2352 17.5 7.24995Z"></path>
              <path d="M5.44001 19.31C5.34147 19.3104 5.24383 19.2912 5.15282 19.2534C5.06181 19.2157 4.97926 19.1601 4.91001 19.09C4.76956 18.9494 4.69067 18.7587 4.69067 18.56C4.69067 18.3612 4.76956 18.1706 4.91001 18.03L6.00001 17C6.13997 16.9331 6.2972 16.9113 6.45006 16.9376C6.60293 16.9638 6.7439 17.0368 6.85357 17.1464C6.96324 17.2561 7.03621 17.3971 7.06244 17.5499C7.08866 17.7028 7.06685 17.86 7.00001 18L6.00001 19.09C5.92728 19.1638 5.83985 19.2216 5.74338 19.2595C5.64691 19.2974 5.54356 19.3146 5.44001 19.31Z"></path>
           </svg>
        )
      )}
    </button>
  );
}
```

## File: src/app/admin/projects/page.tsx
```typescript
// src/app/admin/projects/page.tsx
import Link from 'next/link';
import { getProjects, getCurrentUserProfile } from '@/lib/actions';
import { Plus } from 'lucide-react';
import ProjectTable from '@/components/admin/ProjectTable';
import { createClient } from '@supabase/supabase-js'; 


export default async function ProjectsListPage() {
  const [projects, userProfile] = await Promise.all([
    getProjects('all'),
    getCurrentUserProfile(), // 2. Lấy thông tin user
  ]);
  const supabase = createClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
  );
  const { data: setting } = await supabase
    .from('settings')
    .select('value')
    .eq('key', 'items_per_page')
    .single();
  const itemsLimit = setting?.value ? parseInt(setting.value) : 10;
  return (
    <div className="max-w-7xl mx-auto space-y-6 pb-20">
      
      {/* Header */}
      <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
        <div>
          <h1 className="text-3xl font-bold text-[var(--admin-fg)]">Quản lý Dự án</h1>
          <p className="text-[var(--admin-sub)] mt-1">
            Quản lý danh mục dự án và chi tiết nội dung.
          </p>
        </div>
        {userProfile?.role === 'Admin' && (
          <Link 
            href="/admin/projects/new" 
            className="flex items-center gap-2 px-5 py-2.5 bg-[var(--admin-primary)] text-white rounded-lg font-medium hover:opacity-90 transition-all shadow-lg shadow-indigo-500/30"
          >
            <Plus size={20} /> Thêm dự án mới
          </Link>
        )}
      </div>

      {/* Client Table Component (Xử lý Search & Infinite Scroll) */}
      <ProjectTable initialProjects={projects} itemsPerPage={itemsLimit} userProfile={userProfile} />
      
    </div>
  );
}
```

## File: src/app/admin/staff/page.tsx
```typescript
import { getStaffList } from '@/lib/actions';
import StaffTable from '@/components/admin/StaffTable';
import StaffPageHeader from '@/components/admin/StaffPageHeader';
import { createServerClient } from '@supabase/ssr'; // Dùng cái này cho Server Component
import { cookies } from 'next/headers';
import { redirect } from 'next/navigation';

export default async function StaffPage() {
  // 1. Check quyền ngay tại Server Page
  const cookieStore = await cookies(); // Await cookies() (Next.js 15)
  
  const supabase = createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        getAll() { return cookieStore.getAll() },
        setAll() {} // Server Component không set cookie
      },
    }
  );

  const { data: { user } } = await supabase.auth.getUser();
  
  if (!user) redirect('/login');

  // Lấy Role
  const { data: profile } = await supabase
    .from('users')
    .select('role, user_id')
    .eq('auth_id', user.id)
    .single();

  const currentRole = profile?.role || 'Staff';
  const currentUserId = profile?.user_id || 0; 

  // Nếu là Staff -> Đá về Dashboard (Chặn truy cập trang này luôn)
  if (currentRole !== 'Admin') {
    redirect('/admin');
  }

  // 2. Lấy danh sách (Chỉ chạy nếu là Admin)
  const staffList = await getStaffList();

  return (
    <div className="max-w-7xl mx-auto pb-20 space-y-6">
      {/* Truyền role xuống nếu muốn ẩn hiện nút (tuy nhiên ta đã chặn cả trang rồi) */}
      <StaffPageHeader total={staffList.length} />
      <StaffTable initialStaff={staffList} 
      currentUserRole={currentRole} currentUserId={currentUserId} />
    </div>
  );
}
```

## File: src/app/du-an/[slug]/page.tsx
```typescript
// src/app/du-an/[slug]/page.tsx
import React from 'react';
import { notFound } from 'next/navigation';
import { getProjects } from '@/lib/actions';
import { Metadata } from 'next';
import ProjectClientPage from './ProjectClientPage';

// 1. Định nghĩa Props
interface PageProps {
  params: Promise<{ slug: string }>;
}

// 2. Sinh đường dẫn tĩnh (Quan trọng để không bị 404 khi deploy)
export async function generateStaticParams() {
  const projects = await getProjects();
  
  if (!Array.isArray(projects) || projects.length === 0) return [];

  return projects.map((project) => ({
    slug: project.slug, // Chỉ cần slug là đủ
  }));
}

// 3. SEO Metadata
export async function generateMetadata({ params }: PageProps): Promise<Metadata> {
  const { slug } = await params;
  const projects = await getProjects();
  const project = projects.find((p) => p.slug === slug);

  if (!project) return { title: 'Dự án không tồn tại' };

  const ogImage = typeof project.image === 'string' ? project.image : (project.image.src || '');

  return {
    title: `${project.title} | Oni Studio`,
    description: project.description || `Chi tiết dự án ${project.title}`,
    openGraph: {
      images: [ogImage],
    },
  };
}
export const revalidate = 3600; // 1 hour
// 4. Component Chính (Server Component)
export default async function ProjectDetailPage({ params }: PageProps) {
  const { slug } = await params;
  const projects = await getProjects();
  
  // Tìm dự án hiện tại
  const project = projects.find((p) => p.slug === slug);

  if (!project) {
    notFound(); // Chuyển hướng sang trang 404 chuẩn
  }

  // Logic tìm bài Liên quan (Cùng danh mục) để điều hướng Next/Prev
  // Lọc danh sách chỉ gồm các bài cùng category
  const sameCategoryProjects = projects.filter(p => p.category === project.category);
  // Tìm vị trí của bài hiện tại trong danh sách đó
  const currentIndex = sameCategoryProjects.findIndex(p => p.id === project.id);
  
  // Lấy bài trước và sau
  const nextProject = sameCategoryProjects[currentIndex + 1] || null;
  const prevProject = sameCategoryProjects[currentIndex - 1] || null;

  // Tạo Link điều hướng
  const nextLink = nextProject ? `/du-an/${nextProject.slug}` : null;
  const prevLink = prevProject ? `/du-an/${prevProject.slug}` : null;

  return (
    <ProjectClientPage 
      project={project}
      prevProjectLink={prevLink}
      nextProjectLink={nextLink}
    />
  );
}
```

## File: src/components/AboutPhilosophySection.tsx
```typescript
import Image from 'next/image';
import Container from '@/components/Container';
import ProfileImage from '../assets/about/avatar.webp'; 
import PhilosophyBackground from './PhilosophyBackground';
import AnimatedProfileImage from './AnimatedProfileImage';
export default function AboutPhilosophySection() {

  return (
    <section
      id="philosophy"
      className="relative py-24 md:py-32 overflow-hidden bg-[var(--to-linear)]"
    >
      {/* LỚP 1: NỀN (HIỆU ỨNG SCROLL TEXT) */}
      <PhilosophyBackground />
      {/* LỚP 2: NỘI DUNG (ẢNH & TRIẾT LÝ) */}
      <Container className="relative z-20">
        <div className="grid grid-cols-1 md:grid-cols-5 gap-12 md:gap-16 items-center">
          
          {/* CỘT TRÁI (Ảnh) */}
          <div className="md:col-span-2 flex justify-center items-center py-8 md:py-0"> {/* Thêm padding y để cân đối nếu cần */}
            {/* CONTAINER BAO GỒM ẢNH VÀ KHUNG LỆCH */}
            <div className="relative w-full max-w-sm md:max-w-md lg:max-w-lg xl:max-w-xl mx-auto">
              {/* KHUNG LỆCH (Nằm phía sau ảnh) */}
              <div
                className="absolute bg-transparent border-2 border-[var(--foreground)]"
                style={{
                  width: '100%',     // Kích thước của khung lệch so với container
                  height: '100%',    // Chiều cao tương đương ảnh
                  top: '-25px',      // Dịch lên trên một chút
                  left: '35px',      // Dịch sang phải một chút
                  zIndex: 0,         // Đảm bảo nó nằm phía sau ảnh chính
                }}
              ></div>

              {/* ẢNH CHÍNH (Nằm phía trước khung lệch) */}
              <div className="relative z-10"> {/* Đảm bảo ảnh nằm trên khung lệch */}
              <AnimatedProfileImage>
                        {/* Component <Image> này vẫn được render trên SERVER
                          và được "truyền" vào <AnimatedProfileImage> như một prop 'children'
                        */}
                        <Image
                          src={ProfileImage}
                          alt="Chân dung Oni, nhiếp ảnh gia Oni Studio"
                          width={600}
                          height={800}
                          className="object-cover aspect-[3/4] w-full " 
                          placeholder="blur"
                        />
                </AnimatedProfileImage>
              </div>
            </div>
          </div>
        
          {/* CỘT PHẢI (Text) */}
          <div className="md:col-span-3">
            <h2 className="text-4xl md:text-5xl font-light tracking-tighter mb-6 text-[var(--foreground)]">
              Triết Lý Của Tôi
            </h2>
            <div className="text-lg md:text-xl space-y-6">
            <p className="leading-relaxed text-[var(--foreground)]">
              <strong>Ánh sáng</strong> là nền tảng của công việc. Niềm say mê bất tận nằm ở việc khai thác 
              cách ánh sáng <strong>điêu khắc</strong>, làm nổi bật, và <strong>tôn vinh</strong> một chủ thể. 
              Đó vừa là công cụ, là <strong>ngôn ngữ</strong>, vừa là <strong>nguồn cảm hứng chính</strong>.
            </p>

            <p className="leading-relaxed text-[var(--foreground)]">
              Tôi tin rằng một bức ảnh thành công là sự <strong>giao thoa hài hòa</strong> giữa <strong>tầm nhìn nghệ thuật</strong> và <strong>kỹ thuật chính xác</strong>. 
              Từ dự án thương mại phức tạp đến một bức chân dung tối giản, mục tiêu luôn là 
              sự <strong>chỉn chu trong từng chi tiết</strong>, mang lại giá trị vượt trên cả mong đợi.
            </p>
            </div>
          </div>

        </div>
      </Container>
    </section>
  );
}
```

## File: src/components/admin/StaffTable.tsx
```typescript
// src/components/admin/StaffTable.tsx
'use client';

import React, { useState, useMemo } from 'react';
import { Search, Mail, ArrowUpDown, UserX, UserCheck } from 'lucide-react';
import { toast } from 'sonner';
import { StaffUser, toggleStaffStatus } from '@/lib/actions'; 
import { createBrowserClient } from '@supabase/ssr';
import { useRouter } from 'next/navigation';
// 1. IMPORT MODAL
import ConfirmModal from '@/components/ui/ConfirmModal';

interface StaffTableProps {
  initialStaff: StaffUser[];
  currentUserRole: string;
  currentUserId: number;
}

type SortKey = 'full_name' | 'role' | 'email' | 'is_active';

export default function StaffTable({ initialStaff, currentUserRole, currentUserId }: StaffTableProps) {
  const [staffList, setStaffList] = useState(initialStaff);
  const [searchQuery, setSearchQuery] = useState('');
  const [sortConfig, setSortConfig] = useState<{ key: SortKey; direction: 'asc' | 'desc' }>({ key: 'full_name', direction: 'asc' });
  
  // State cho Loading & Modal
  const [isLoading, setIsLoading] = useState(false); // Loading chung cho modal
  
  // 2. STATE QUẢN LÝ MODAL
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [selectedStaff, setSelectedStaff] = useState<StaffUser | null>(null);

  const router = useRouter();
  const supabase = createBrowserClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
  );

  // --- LOGIC SORT & FILTER (Giữ nguyên) ---
  const handleSort = (key: SortKey) => {
    setSortConfig((current) => ({
      key,
      direction: current.key === key && current.direction === 'asc' ? 'desc' : 'asc',
    }));
  };

  const processedStaff = useMemo(() => {
    let data = [...staffList];
    if (searchQuery) {
      const lowerQuery = searchQuery.toLowerCase();
      data = data.filter(
        (s) =>
          s.full_name?.toLowerCase().includes(lowerQuery) ||
          s.email?.toLowerCase().includes(lowerQuery) ||
          s.role?.toLowerCase().includes(lowerQuery)
      );
    }
    data.sort((a, b) => {
      const aValue = a[sortConfig.key];
      const bValue = b[sortConfig.key];
      if (aValue < bValue) return sortConfig.direction === 'asc' ? -1 : 1;
      if (aValue > bValue) return sortConfig.direction === 'asc' ? 1 : -1;
      return 0;
    });
    return data;
  }, [staffList, searchQuery, sortConfig]);

  // --- 3. HÀM MỞ MODAL ---
  const openConfirmModal = (staff: StaffUser) => {
    setSelectedStaff(staff);
    setIsModalOpen(true);
  };

  // --- 4. HÀM XỬ LÝ CHÍNH (CHẠY KHI BẤM CONFIRM TRONG MODAL) ---
  const handleConfirmToggle = async () => {
    if (!selectedStaff) return;

    setIsLoading(true);

    try {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) {
        toast.error('Hết phiên đăng nhập');
        return;
      }

      const res = await toggleStaffStatus(session.access_token, selectedStaff.user_id, selectedStaff.is_active);

      if (res.success) {
        toast.success(`Đã ${selectedStaff.is_active ? 'khóa' : 'mở khóa'} tài khoản thành công!`);
        
        // Optimistic Update
        setStaffList((prev) =>
          prev.map((s) => (s.user_id === selectedStaff.user_id ? { ...s, is_active: !s.is_active } : s))
        );
        
        setIsModalOpen(false); // Đóng modal
        setSelectedStaff(null);
        router.refresh();
      } else {
        toast.error(`Lỗi: ${res.error}`);
      }
    } catch (error) {
        const msg = error instanceof Error ? error.message : 'Lỗi hệ thống';
        toast.error(msg);
    } finally {
      setIsLoading(false);
    }
  };

  const SortableHeader = ({ label, colKey, className = "" }: { label: string; colKey: SortKey; className?: string }) => (
    <th 
      className={`px-6 py-4 whitespace-nowrap cursor-pointer hover:bg-[var(--admin-hover)] transition-colors select-none group ${className}`}
      onClick={() => handleSort(colKey)}
    >
      <div className="flex items-center gap-2">
        {label}
        <ArrowUpDown size={14} className={`text-[var(--admin-sub)] transition-opacity ${sortConfig.key === colKey ? 'opacity-100 text-[var(--admin-primary)]' : 'opacity-0 group-hover:opacity-50'}`} />
      </div>
    </th>
  );

  return (
    <div className="space-y-6">
      {/* Search Bar (Giữ nguyên) */}
      <div className="flex items-center gap-4 bg-[var(--admin-card)] p-4 rounded-xl border border-[var(--admin-border)] shadow-sm">
        <div className="relative flex-1 max-w-md w-full">
          <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-[var(--admin-sub)]" size={18} />
          <input 
            type="text" 
            placeholder="Tìm kiếm theo tên, email, vai trò..." 
            className="w-full pl-10 pr-4 py-2 bg-[var(--admin-bg)] border border-[var(--admin-border)] rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--admin-primary)] text-[var(--admin-fg)] transition-all"
            value={searchQuery}
            onChange={(e) => setSearchQuery(e.target.value)}
          />
        </div>
        <div className="text-sm text-[var(--admin-sub)]">
            Tổng: <strong>{processedStaff.length}</strong> nhân sự
        </div>
      </div>

      {/* Table */}
      <div className="bg-[var(--admin-card)] rounded-xl border border-[var(--admin-border)] shadow-sm overflow-hidden">
        <div className="overflow-x-auto table-scrollbar">
          <table className="w-full text-sm text-left min-w-[800px]">
            <thead className="bg-[var(--admin-bg)] text-[var(--admin-sub)] uppercase text-xs font-semibold border-b border-[var(--admin-border)]">
              <tr>
                <SortableHeader label="Họ và Tên" colKey="full_name" />
                <SortableHeader label="Vai trò" colKey="role" />
                <th className="px-6 py-4 whitespace-nowrap">Liên hệ</th>
                <SortableHeader label="Trạng thái" colKey="is_active" />
                <th className="px-6 py-4 text-right whitespace-nowrap">Hành động</th>
              </tr>
            </thead>
            <tbody className="divide-y divide-[var(--admin-border)]">
              {processedStaff.length === 0 ? (
                 <tr><td colSpan={5} className="p-8 text-center text-[var(--admin-sub)] italic">Không tìm thấy nhân viên nào.</td></tr>
              ) : (
                processedStaff.map((staff) => (
                  <tr key={staff.user_id} className={`transition-colors ${staff.is_active ? 'hover:bg-[var(--admin-hover)]' : 'bg-gray-50 dark:bg-neutral-900/50 opacity-70'}`}>
                    {/* ... (Các cột hiển thị thông tin giữ nguyên) ... */}
                    <td className="px-6 py-4 font-medium text-[var(--admin-fg)]">
                      <div className="flex items-center gap-3">
                        <div className={`w-8 h-8 rounded-full flex items-center justify-center text-white font-bold shrink-0 shadow-sm ${staff.role === 'Admin' ? 'bg-indigo-500' : 'bg-pink-500'}`}>
                          {staff.full_name?.charAt(0).toUpperCase() || '?'}
                        </div>
                        <div>
                            <div className="whitespace-nowrap font-semibold">{staff.full_name}</div>
                            {staff.role === 'Admin' && <span className="text-[10px] text-[var(--admin-primary)] font-bold border border-[var(--admin-primary)] px-1 rounded">SUPER ADMIN</span>}
                        </div>
                      </div>
                    </td>
                    <td className="px-6 py-4 text-[var(--admin-sub)] whitespace-nowrap font-medium">{staff.role}</td>
                    <td className="px-6 py-4 text-[var(--admin-sub)] space-y-1 whitespace-nowrap">
                      <div className="flex items-center gap-2"><Mail size={14}/> {staff.email}</div>
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap">
                      <span className={`px-2.5 py-1 rounded-full text-xs font-bold border ${
                        staff.is_active 
                          ? 'bg-green-100 text-green-700 border-green-200' 
                          : 'bg-red-100 text-red-600 border-red-200'
                      }`}>
                        {staff.is_active ? 'Đang hoạt động' : 'Đã khóa'}
                      </span>
                    </td>
                    <td className="px-6 py-4 text-right whitespace-nowrap">
                      {/* CỘT HÀNH ĐỘNG */}
                     {currentUserRole === 'Admin' && staff.user_id !== currentUserId && (
                        <button 
                          onClick={() => openConfirmModal(staff)} 
                          className={`p-2 rounded-lg transition-colors group cursor-pointer ${
                              staff.is_active 
                              ? 'text-red-500 hover:bg-red-50' 
                              : 'text-green-500 hover:bg-green-50'
                          }`}
                          title={staff.is_active ? "Khóa tài khoản" : "Mở khóa tài khoản"}
                        >
                          {staff.is_active ? <UserX size={18} /> : <UserCheck size={18} />}
                        </button>
                      )}
                      {staff.user_id === currentUserId && (
                        <span className="text-xs text-[var(--admin-sub)] italic px-2">Bạn</span>
                      )}
                    </td>
                  </tr>
                ))
              )}
            </tbody>
          </table>
        </div>
      </div>

      {/* 5. RENDER MODAL */}
      <ConfirmModal 
        isOpen={isModalOpen}
        onClose={() => !isLoading && setIsModalOpen(false)}
        onConfirm={handleConfirmToggle}
        isLoading={isLoading}
        
        // Logic hiển thị động dựa trên trạng thái nhân viên
        title={selectedStaff?.is_active ? "Khóa tài khoản này?" : "Mở khóa tài khoản?"}
        
        description={selectedStaff?.is_active 
            ? `Bạn có chắc muốn khóa quyền truy cập của "${selectedStaff.full_name}"? Họ sẽ không thể đăng nhập vào hệ thống nữa.` 
            : `Bạn có chắc muốn kích hoạt lại tài khoản cho "${selectedStaff?.full_name}"? Họ sẽ có thể đăng nhập và làm việc bình thường.`
        }
        
        confirmText={selectedStaff?.is_active ? "Khóa tài khoản" : "Kích hoạt lại"}
        cancelText="Hủy bỏ"
        
        // Đổi màu sắc: Khóa = Đỏ, Mở = Xanh/Info
        variant={selectedStaff?.is_active ? 'danger' : 'info'} 
      />
    </div>
  );
}
```

## File: src/components/ContactSection.tsx
```typescript
// src/components/ContactSection.tsx
'use client'; // Bắt buộc vì dùng hook (useState)

import React, { useState } from 'react';
import Container from '@/components/Container';
import BrandScroller from "@/components/BrandScroller";

export default function ContactSection() {
  const email = 'hello@onistudio.com';
  const [copyText, setCopyText] = useState(email);
  const noiseOpacity = 0.05; // Điều chỉnh độ đậm/nhạt của noise

  // Hàm xử lý copy email (giữ nguyên)
  const handleCopy = () => {
    navigator.clipboard.writeText(email).then(
      () => {
        setCopyText('Đã sao chép!');
        setTimeout(() => {
          setCopyText(email);
        }, 2000);
      },
      (err) => {
        console.error('Không thể sao chép: ', err);
        setCopyText('Lỗi khi sao chép');
      }
    );
  };

  return (
<section
      id="contact"
      className="relative py-14 overflow-hidden 
                 bg-linear-to-b to-[var(--to-linear)] from-[var(--from-linear)] 
                 dark:text-white text-black" 
      style={{ minHeight: 0, fontSize: 'initial' }}
    >
      {/* 2. LỚP NỀN (GRID + MASK) */}
      <div
        className="absolute bottom-0 left-0 right-0 top-0 z-0
                   bg-[linear-gradient(to_right,#4f4f4f2e_1px,transparent_1px),linear-gradient(to_bottom,#4f4f4f2e_1px,transparent_1px)] 
                   bg-size-[35px_34px] 
                   mask-[radial-gradient(ellipse_60%_50%_at_50%_0%,#000_70%,transparent_100%)]"
      ></div>

      {/* 3. LỚP NỀN (NOISE) */}
      <div
        className="absolute top-0 left-0 w-full h-full content-[''] z-10 
                   pointer-events-none 
                   bg-[url('https://www.ui-layouts.com/noise.gif')]"
        style={{ opacity: noiseOpacity }}
      ></div>

      {/* 4. NỘI DUNG (đặt z-index cao hơn) */}
      <Container className="relative z-20 mt-16 mb-12 lg:mt-24 lg:mb-14">
        <div className="relative md:border-l-1 border-[var(--foreground)]">
       {/* 1. THAY ĐỔI: TIÊU ĐỀ DỌC (Chỉ hiện từ 'md' trở lên) */}
          <div className="hidden md:flex absolute top-0 -left-16 md:-left-24 w-16 md:w-24 h-full items-center justify-center pointer-events-none">
            <h2
              className="transform -rotate-90 whitespace-nowrap text-4xl md:text-5xl 
                         font-light tracking-widest uppercase text-[var(--foreground)]"
            >
              Liên Hệ
            </h2>
          </div>

          {/* 2. THÊM MỚI: TIÊU ĐỀ NGANG (Chỉ hiện trên di động) */}
          <div className="md:hidden mb-12">
            <h2 className="text-4xl font-light tracking-tighter text-[var(--foreground)]">
              Liên Hệ
            </h2>
          </div>

          {/* 3. THAY ĐỔI: NỘI DUNG CHÍNH (Bỏ padding trái trên di động) */}
          <div className="pl-0 md:pl-16 grid grid-cols-1 md:grid-cols-2 gap-12 md:gap-20 max-w-4xl mx-auto">
            
            {/* CỘT 1: FORM */}
            <div>
              <p className="text-lg text-[var(--foreground)] mb-6">
                Để lại lời nhắn cho chúng tôi bằng cách điền vào biểu mẫu bên dưới:
              </p>
              {/* ... (phần form giữ nguyên) ... */}
              <form
                onSubmit={(e) => {
                  e.preventDefault();
                  alert('Chức năng gửi form đang được phát triển!');
                }}
                className="space-y-6"
              >
                <div>
                  <label
                    htmlFor="email"
                    className="block border-[var(--foreground)]/60 focus:border-[var(--foreground)] text-sm font-medium mb-1 text-[var(--foreground)]"
                  >
                    Email của bạn
                  </label>
                  <input
                    type="email"
                    id="email"
                    name="email"
                    required
                    className="block w-full p-3 bg-transparent 
                               border border-[var(--foreground)]/60
                               focus:ring-0 focus:border-[var(--foreground)] 
                               transition-colors text-[var(--foreground)]"
                  />
                </div>
                <div>
                  <label
                    htmlFor="message"
                    className="block text-sm font-medium mb-1 text-[var(--foreground)]"
                  >
                    Lời nhắn
                  </label>
                  <textarea
                    id="message"
                    name="message"
                    rows={5}
                    required
                    className="block w-full p-3 bg-transparent text-[var(--foreground)]
                               border border-[var(--foreground)]/60
                               focus:ring-0 focus:border-[var(--foreground)] 
                               transition-colors"
                  ></textarea>
                </div>
                <div>
                  <button
                    type="submit"
                    className="py-3 px-8 bg-transparent 
                               border border-[var(--foreground)]/60
                               text-[var(--foreground)] 
                               hover:bg-black 
                               dark:hover:bg-white dark:hover:text-gray-950
                               transition-colors duration-300 cursor-pointer font-bold"
                  >
                    Gửi Lời Nhắn
                  </button>
                </div>
              </form>
            </div>

            {/* CỘT 2: EMAIL COPY */}
            <div>
              <p className="text-lg mb-6 text-[var(--foreground)]">
                Hoặc nhấn để sao chép email:
              </p>
              {/* ... (phần nút copy giữ nguyên) ... */}
              <button
                onClick={handleCopy}
                className="w-full text-left p-4 bg-transparent 
                           border border-[var(--foreground)]/60
                           text-lg md:text-xl font-mono 
                           hover:border-[var(--foreground)]
                           transition-all duration-300 cursor-pointer text-[var(--foreground)]"
              >
                {copyText}
              </button>
            </div>
          </div>
        </div>
      </Container>
  {/* 4. Đặt BrandScroller VÀO ĐÂY (Sau Container, trong Section) */}
      {/* Phải có relative z-20 để nổi lên trên nền */}
      <div className="relative z-20 mt-10 md:mt-4">
        <BrandScroller />
      </div>
    </section>
   


  );
}
```

## File: src/components/Header.tsx
```typescript
// src/components/Header.tsx
'use client'; 

import { useState, useEffect } from 'react'; 
import Container from "./Container";
import localFont from 'next/font/local'; 
import Link from 'next/link';
import ThemeToggle from './ThemeToggle';

const logoFont = localFont({
  src: '../fonts/cameliya-regular.ttf',
  display: 'swap',
  variable: '--font-logo',
});

export default function Header() {
  const [isMenuOpen, setIsMenuOpen] = useState(false);

  useEffect(() => {
    if (isMenuOpen) {
      document.body.style.overflow = 'hidden';
    } else {
      document.body.style.overflow = 'auto';
    }
    return () => {
      document.body.style.overflow = 'auto';
    };
  }, [isMenuOpen]); 

  const handleLinkClick = () => {
    setIsMenuOpen(false);
  };
  
  return (
   <header
      className={`border-b py-4 relative z-50 
                 animate-fade-in-up backdrop-blur-2xl bg-[var(--background)] 
                 border-[var(--foreground)]`} 
    >
      <Container>
        <div className="flex items-center justify-between">
          <h1
            className={`text-xl font-semibold tracking-widest cursor-pointer ${logoFont.className}`}
          >
            <Link href="/" className="menu-link-glow">
              Oni Studio
            </Link>
          </h1>

          <nav className="hidden md:flex items-center space-x-6 text-md">
            <Link href="/thuong-mai" className="menu-link-glow">
              Thương mại
            </Link>
            <Link href="/thoi-trang" className="menu-link-glow">
              Thời trang
            </Link>
            <Link href="/ca-nhan" className="menu-link-glow">
              Cá nhân
            </Link>
            <Link href="/dich-vu" className="menu-link-glow">
              Dịch Vụ
            </Link>
            <Link href="/gioi-thieu" className="menu-link-glow">
              Giới thiệu
            </Link>
            <ThemeToggle />
          </nav>

          {/* SỬA 2: Gộp ThemeToggle và Nút Hamburger vào chung 1 div */}
          <div className="md:hidden flex items-center space-x-4">
            <ThemeToggle />
            
            <button
              className="" // Đã xóa md:hidden vì div cha đã xử lý
              onClick={() => setIsMenuOpen(!isMenuOpen)}
              aria-label="Toggle navigation"
            >
              {isMenuOpen ? (
                // Icon 'X'
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  fill="none"
                  viewBox="0 0 24 24"
                  strokeWidth={1.5}
                  stroke="currentColor"
                  className="w-6 h-6 cursor-pointer"
                >
                  <path
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    d="M6 18 18 6M6 6l12 12"
                  />
                </svg>
              ) : (
                // Icon 'Hamburger'
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  fill="none"
                  viewBox="0 0 24 24"
                  strokeWidth={1.5}
                  stroke="currentColor"
                  className="w-6 h-6 cursor-pointer"
                >
                  <path
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5"
                  />
                </svg>
              )}
            </button>
          </div>
        </div>
      </Container>

      {/* Menu di động (Giữ nguyên) */}
      <div
        className={`fixed left-0 right-0 top-full h-screen bg-gray-900/75 backdrop-blur-lg border-b shadow-lg md:hidden transition-all duration-300 ease-in-out ${
          isMenuOpen ? 'block opacity-100' : 'hidden opacity-0'
        }`}
      >
       <nav className="flex flex-col ps-10 space-y-8 p-5 text-4xl font-bold text-white mt-5">
          <Link href="/thuong-mai" className="menu-link-glow" onClick={handleLinkClick}>
            Thương mại
          </Link>
          <Link href="/thoi-trang" className="menu-link-glow" onClick={handleLinkClick}>
            Thời trang
          </Link>
          <Link href="/ca-nhan" className="menu-link-glow" onClick={handleLinkClick}>
            Cá nhân
          </Link>
          <Link href="/dich-vu" className="menu-link-glow" onClick={handleLinkClick}>
            Dịch Vụ
          </Link>
          <Link href="/gioi-thieu" className="menu-link-glow" onClick={handleLinkClick}>
            Giới thiệu
          </Link>
        </nav>
      </div>
    </header>
  );
}
```

## File: src/data/projects-master-data.ts
```typescript
// src/data/projects-master-data.ts
import { StaticImageData } from 'next/image';

// --- IMPORT ẢNH (Giữ nguyên) ---
import Fashion_01_thumnails from '../assets/project/thoi-trang/Fashion_01_thumnails.webp';
import Fashion_02_thumnails from '../assets/project/thoi-trang/Fashion_02_thumnails.webp';
import Fashion_03_thumnails from '../assets/project/thoi-trang/Fashion_03_thumnails.webp';

import Commercial_01_thumnails from '../assets/project/thuong-mai/Commercial_01_thumnails.webp';
import Commercial_02_thumnails from '../assets/project/thuong-mai/Commercial_02_thumnails.webp';
import Commercial_02_01 from '../assets/project/thuong-mai/Commercial_02_01.webp';
import Commercial_02_02 from '../assets/project/thuong-mai/Commercial_02_02.webp';
import Commercial_02_03 from '../assets/project/thuong-mai/Commercial_02_03.webp';

import Personal_01_thumnails from '../assets/project/ca-nhan/Personal_01_thumnails.webp';

import Personal_02_thumnails from '../assets/project/ca-nhan/Personal_02_thumnails.webp';
import Personal_02_02 from '../assets/project/ca-nhan/Personal_02_02.webp';
import Personal_02_03 from '../assets/project/ca-nhan/Personal_02_03.webp';
import Personal_02_04 from '../assets/project/ca-nhan/Personal_02_04.webp';
import Personal_02_05 from '../assets/project/ca-nhan/Personal_02_05.webp';
import Personal_02_06 from '../assets/project/ca-nhan/Personal_02_06.webp';
import Personal_02_07 from '../assets/project/ca-nhan/Personal_02_07.webp';
import Personal_02_08 from '../assets/project/ca-nhan/Personal_02_08.webp';
import Personal_02_09 from '../assets/project/ca-nhan/Personal_02_09.webp';

// --- 1. ĐỊNH NGHĨA TYPE CHUẨN (Khớp với Supabase Logic) ---

export type ArticleBlock = 
  | { type: 'heading'; content: string }
  | { type: 'paragraph'; content: string }
  | { type: 'imageRow'; images: (StaticImageData | string)[] }; // Cho phép cả URL string và StaticImport

export interface ProjectData {
  id: number;
  slug: string;
  title: string;
  client_name?: string; // Tên hiển thị phụ (VD: Zara, Dior...)
  
  // Image: Cho phép cả StaticImageData (Demo) và string URL (Supabase)
  image: StaticImageData | string; 
  
  category: string;      // Slug danh mục (vd: thoi-trang)
  categoryName: string;  // Tên hiển thị (vd: Thời trang)
  
  year: string;
  
  // Grid Layout (Dùng số nguyên để tính toán logic kéo thả)
  colSpan: number; 
  rowSpan: number; 
  
  isFeatured: boolean;   // Thay cho featured?
  
  // Chi tiết bài viết
  description?: string;
  credits?: { label: string; value: string }[];
  articleBody?: ArticleBlock[];
  align?: 'left' | 'right';
}

// --- 2. DỮ LIỆU MASTER (Dùng cho Demo Mode) ---

export const PROJECTS_MASTER_DATA: ProjectData[] = [
  // ----------------------------------------------------
  // DỰ ÁN 1: THANH XUÂN
  // ----------------------------------------------------
  {
    id: 1,
    slug: 'thanh-xuan-vuon-truong',
    title: 'Thanh xuân vườn trường',
    client_name: 'Personal Project',
    image: Fashion_01_thumnails,
    category: 'thoi-trang',
    categoryName: 'Thời trang',
    year: '2023',
    colSpan: 2, // 2 cột
    rowSpan: 2, // 2 hàng
    isFeatured: false,
    description: "Vượt ra ngoài giới hạn của một bộ đồng phục, dự án này là một cuộc đối thoại với ký ức. Nó tái định nghĩa không gian quen thuộc của sân trường, biến nó thành một sàn diễn của hoài niệm.",
    credits: [
      { label: 'Producer', value: 'Thanh Hang - Choo Production' },
      { label: 'Art Director', value: 'Thien Nguyen' },
      { label: 'Photographer', value: 'Evis Tran' },
      { label: 'Location', value: 'Oni Studio' },
    ],
    articleBody: [
      { type: 'heading', content: 'Di sản của hoài niệm' },
      { type: 'imageRow', images: [Fashion_01_thumnails, Fashion_01_thumnails] },
      { type: 'paragraph', content: "Bối cảnh sân trường không chỉ là phông nền; nó là một nhân vật. Ánh sáng tự nhiên được lọc qua tán lá, tạo ra sự tương phản mềm mại." },
      { type: 'heading', content: 'Chi tiết và tĩnh lặng' },
      { type: 'imageRow', images: [Fashion_01_thumnails] },
      { type: 'paragraph', content: "Sự tập trung vào chi tiết biến bộ đồng phục từ một quy định trở thành một biểu tượng của cá tính." }
    ]
  },

  // ----------------------------------------------------
  // DỰ ÁN 2: CHỦ MÔ HÌNH (ZARA)
  // ----------------------------------------------------
  {
    id: 2,
    slug: 'chu-mo-hinh-zara',
    title: 'Chủ mô hình',
    client_name: 'ZARA',
    image: Commercial_01_thumnails,
    category: 'thuong-mai',
    categoryName: 'Thương mại',
    year: '2024',
    colSpan: 1,
    rowSpan: 1,
    isFeatured: false,
    description: "Trong lãnh địa của e-commerce, sự tối giản là tuyên ngôn tối thượng. Dự án này loại bỏ mọi chi tiết thừa để tập trung vào bản chất thuần túy.",
    credits: [
      { label: 'Client', value: 'ZARA' },
      { label: 'Photographer', value: 'Evis Tran' },
      { label: 'Location', value: 'Oni Studio' },
    ],
    articleBody: [
      { type: 'heading', content: 'Kiến trúc của ánh sáng' },
      { type: 'imageRow', images: [Commercial_01_thumnails] },
      { type: 'paragraph', content: "Ánh sáng được sử dụng như một 'con dao điêu khắc', tách chủ thể khỏi nền xám trơn." },
      { type: 'heading', content: 'Sự tĩnh lặng của chuyển động' },
      { type: 'imageRow', images: [Commercial_01_thumnails, Commercial_01_thumnails] },
      { type: 'paragraph', content: "Mỗi dáng pose là kết quả của kỷ luật, tạo ra những hình ảnh mạnh mẽ và trực diện." }
    ]
  },

  // ----------------------------------------------------
  // DỰ ÁN 3: CÁ NHÂN 01
  // ----------------------------------------------------
  {
    id: 3,
    slug: 'ca-nhan-01',
    title: 'Portrait Series 01',
    client_name: 'Cá nhân',
    image: Personal_01_thumnails,
    category: 'ca-nhan',
    categoryName: 'Cá nhân',
    year: '2023',
    colSpan: 1,
    rowSpan: 2,
    isFeatured: false,
    description: "Nhiếp ảnh chân dung không phải là ghi lại một khuôn mặt, mà là bắt giữ một thế giới nội tâm.",
    credits: [
      { label: 'Photographer', value: 'Evis Tran' },
      { label: 'Model', value: 'Mai Phuoc Tri' },
    ],
    articleBody: [
      { type: 'heading', content: 'Vẻ đẹp của Chiaroscuro' },
      { type: 'imageRow', images: [Personal_01_thumnails, Personal_01_thumnails, Personal_01_thumnails] },
      { type: 'paragraph', content: "Chúng tôi chọn ánh sáng cửa sổ duy nhất để tôn vinh nghệ thuật tương phản Chiaroscuro." }
    ]
  },

  // ----------------------------------------------------
  // DỰ ÁN 4: HOKKAIDO 
  // ----------------------------------------------------
  {
    id: 4,
    slug: 'ngon-lua-giua-tuyet',
    title: 'Ngọn lửa giữa Tuyết',
    client_name: 'Editorial',
    image: Fashion_02_thumnails,
    category: 'thoi-trang',
    categoryName: 'Thời trang',
    year: '2024',
    colSpan: 1,
    rowSpan: 2,
    isFeatured: false,
    description: "Dự án cá nhân này khám phá sự tương phản giữa cái lạnh buốt của ngoại cảnh và hơi ấm nội tâm.",
    credits: [
      { label: 'Location', value: 'Hokkaido, Japan' },
      { label: 'Photographer', value: 'Evis Tran' },
    ],
    articleBody: [
      { type: 'heading', content: 'Sức sống mỏng manh' },
      { type: 'imageRow', images: [Fashion_02_thumnails, Fashion_02_thumnails] },
      { type: 'paragraph', content: "Giữa khung cảnh bao la của tuyết trắng, ánh lửa đỏ cam trở thành tuyên ngôn duy nhất về sự tồn tại." }
    ]
  },

  // ----------------------------------------------------
  // DỰ ÁN 5: L'OFFICIEL 
  // ----------------------------------------------------
  {
    id: 5,
    slug: 'hoi-tho-golden-hour',
    title: "Hơi thở 'Golden Hour'",
    client_name: "L'Officiel Vietnam",
    image: Fashion_03_thumnails,
    category: 'thoi-trang',
    categoryName: 'Thời trang',
    year: '2023',
    colSpan: 2,
    rowSpan: 1,
    isFeatured: true,
    description: "Một bộ ảnh editorial khám phá sự kết nối giữa con người và thiên nhiên trong khoảnh khắc vàng.",
    credits: [
      { label: 'Client', value: "L'Officiel" },
      { label: 'Photographer', value: 'Evis Tran' },
    ],
    articleBody: [
      { type: 'heading', content: 'Đối thoại với hoàng hôn' },
      { type: 'imageRow', images: [Fashion_03_thumnails, Fashion_03_thumnails] },
      { type: 'paragraph', content: "Golden hour là khoảnh khắc ánh sáng không chỉ chiếu rọi, mà còn 'chạm' vào vạn vật." }
    ]
  },

  // ----------------------------------------------------
  // DỰ ÁN 6: DIOR 
  // ----------------------------------------------------
  {
    id: 6,
    slug: 'khoanh-khac-playful-dior',
    title: "Khoảnh khắc 'Playful' Dior",
    client_name: 'Dior Beauty',
    image: Commercial_02_thumnails,
    category: 'thuong-mai',
    categoryName: 'Thương mại',
    year: '2024',
    colSpan: 1,
    rowSpan: 1,
    isFeatured: true,
    description: "Nắm bắt tinh thần trẻ trung, phá cách tại sự kiện độc quyền của Dior.",
    credits: [
      { label: 'Client', value: 'Dior' },
      { label: 'Photographer', value: 'Evis Tran' },
    ],
    articleBody: [
      { type: 'heading', content: 'Tuyên ngôn của sự nổi loạn' },
      { type: 'imageRow', images: [Commercial_02_thumnails] },
      { type: 'imageRow', images: [Commercial_02_01, Commercial_02_02] },
      { type: 'imageRow', images: [Commercial_02_thumnails, Commercial_02_03] },
      { type: 'paragraph', content: "Khoảnh khắc 'playful' phá vỡ sự trang trọng của di sản Dior." }
    ]
  },

  // ----------------------------------------------------
  // DỰ ÁN 7: SG 1990 
  // ----------------------------------------------------
  {
    id: 7,
    slug: 'net-lang-du-sai-gon-thap-nien-90',
    title: "Nét Lãng Du Sài Gòn",
    client_name: 'Personal Project',
    image: Personal_02_thumnails,
    category: 'ca-nhan',
    categoryName: 'Cá nhân',
    year: '2022',
    colSpan: 1,
    rowSpan: 1,
    isFeatured: true,
    description: "Không khí hoài cổ, lãng mạn và có chút bụi bặm của Sài Gòn những năm 90.",
    credits: [
      { label: 'Concept', value: 'Saigon 1990' },
      { label: 'Photographer', value: 'Evis Tran' },
    ],
    articleBody: [
      { type: 'heading', content: 'Ý Tưởng & Chủ Đề' },
      { type: 'imageRow', images: [Personal_02_thumnails] },
      { type: 'imageRow', images: [Personal_02_02, Personal_02_03, Personal_02_04] },
      { type: 'imageRow', images: [Personal_02_05, Personal_02_06, Personal_02_07] },
      { type: 'imageRow', images: [Personal_02_thumnails, Personal_02_08, Personal_02_09] },
      { type: 'paragraph', content: "Tái hiện lại không khí hoài cổ, lãng mạn của Sài Gòn xưa." }
    ]
  },
];
```

## File: next.config.ts
```typescript
// next.config.ts
import type { NextConfig } from "next";

const nextConfig: NextConfig = {


  images: {
    remotePatterns: [
      {
        protocol: 'https',

        hostname: '**.supabase.co',

      },
      {
        protocol: 'https',
        hostname: 'images.unsplash.com',
      }
    ],
  },

  // Tắt strict mode nếu muốn (optional), nhưng nên để true
  reactStrictMode: true, 
  
  // Tắt cảnh báo ESLint lúc build để tránh fail build vì lỗi nhỏ (Optional)
  eslint: {
    ignoreDuringBuilds: true,
  },
  typescript: {
    ignoreBuildErrors: true,
  }
};

export default nextConfig;
```

## File: src/app/admin/settings/page.tsx
```typescript
// src/app/admin/settings/page.tsx
import SettingsForm from '@/components/admin/SettingsForm';
import { Settings } from 'lucide-react';
import { createServerClient } from '@supabase/ssr'; 
import { cookies } from 'next/headers'; 
import { redirect } from 'next/navigation'; 
import { getSettings, getCleanupMinutes } from '@/lib/actions/settings';

export default async function AdminSettingsPage() {
  const cookieStore = await cookies(); 
  
  // 1. Fetch dữ liệu song song (Server Side)
  const [settings, cleanupMinutes] = await Promise.all([
    getSettings(),
    getCleanupMinutes()
  ]);

  const supabase = createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        getAll() { return cookieStore.getAll() },
        setAll() {} 
      },
    }
  );

  const { data: { user } } = await supabase.auth.getUser();
  if (!user) redirect('/login');

  const { data: profile } = await supabase
    .from('users')
    .select('role')
    .eq('auth_id', user.id)
    .single();

  if (profile?.role !== 'Admin') {
    redirect('/admin');
  }

  // --- XÓA DÒNG NÀY (Vì biến settings đã có ở trên dòng 14) ---
  // const settings = await getSettings(); 

  return (
    <div className="max-w-7xl mx-auto pb-20">
      <div className="mb-8">
        <h1 className="text-3xl font-bold text-[var(--admin-fg)] flex items-center gap-3">
          <Settings className="text-[var(--admin-primary)]" size={32} />
          Cài đặt chung
        </h1>
        <p className="text-[var(--admin-sub)] mt-2">
          Quản lý các thông số cấu hình toàn cục của hệ thống.
        </p>
      </div>

      <SettingsForm 
        initialSettings={settings} 
        initialCleanupMinutes={cleanupMinutes} // Giờ Props này sẽ hợp lệ sau khi sửa bước 2
      />
    </div>
  );
}
```

## File: src/app/du-an/[slug]/ProjectClientPage.tsx
```typescript
// src/app/du-an/[slug]/ProjectClientPage.tsx
'use client';

import React, { useState, useMemo, useCallback } from 'react';
import Image, { StaticImageData } from 'next/image';
import { useInView } from 'react-intersection-observer';
import { ProjectData } from '@/data/projects-master-data'; 
import ProjectNavigation from '@/components/ProjectNavigation';
// Lưu ý: Đảm bảo đường dẫn CSS đúng với dự án của bạn
import styles from '../../styles/ProjectArticle.module.css';

// --- LIGHTBOX ---
import Lightbox from 'yet-another-react-lightbox';
import Zoom from 'yet-another-react-lightbox/plugins/zoom';
import Captions from 'yet-another-react-lightbox/plugins/captions';
import Thumbnails from 'yet-another-react-lightbox/plugins/thumbnails';
import 'yet-another-react-lightbox/styles.css';
import 'yet-another-react-lightbox/plugins/captions.css';
import 'yet-another-react-lightbox/plugins/thumbnails.css';

// --- 1. Component Ảnh Chi Tiết ---
interface ArticleImageProps {
  image: StaticImageData | string;
  onClick: () => void;
  imageCount: number;
}

const ArticleImage = React.memo(({ image, onClick, imageCount }: ArticleImageProps) => {
  // Logic chia cột thông minh
  const getWidthClass = (count: number): string => {
    switch (count) {
      case 1: return 'w-full'; // 1 ảnh -> Full
      case 2: return 'w-full md:w-[49%]'; // 2 ảnh -> 50%
      case 3: return 'w-full md:w-[32%]'; // 3 ảnh -> 33%
      default: return 'w-full md:w-[49%]'; // 4+ ảnh -> 50%
    }
  };

  const widthClass = getWidthClass(imageCount);

  return (
    <div
      className={`${widthClass} relative aspect-[3/4] flex-shrink-0 cursor-pointer overflow-hidden rounded-sm shadow-sm transition-all duration-500 hover:shadow-xl hover:scale-[1.01]`}
      onClick={onClick}
    >
      <Image
        src={image} 
        alt="Project detail"
        fill
        className="object-cover transition-opacity duration-300 hover:opacity-90"
        quality={90}
        sizes="(max-width: 768px) 100vw, 50vw"
      />
    </div>
  );
});
ArticleImage.displayName = 'ArticleImage';

// --- 2. Component Chính ---
interface ProjectClientPageProps {
  project: ProjectData;
  prevProjectLink: string | null;
  nextProjectLink: string | null;
}

export default function ProjectClientPage({
  project,
  prevProjectLink,
  nextProjectLink,
}: ProjectClientPageProps) {
  
  const [navRef, navInView] = useInView({ threshold: 0.1, triggerOnce: true });
  const [lightboxOpen, setLightboxOpen] = useState(false);
  const [lightboxIndex, setLightboxIndex] = useState(0);

  // Lấy thông tin Location & Client để hiển thị nổi bật
  const locationCredit = useMemo(() => project.credits?.find((c) => c.label.toLowerCase().includes('location')), [project.credits]);
  const clientCredit = useMemo(() => project.credits?.find((c) => c.label.toLowerCase().includes('client')), [project.credits]);

  // Gom toàn bộ ảnh để dùng cho Lightbox
  const allProjectImages = useMemo(() => {
    return (
      project.articleBody
        ?.filter((block) => block.type === 'imageRow')
        .flatMap((block) => (block as { images: (StaticImageData | string)[] }).images) || []
    );
  }, [project.articleBody]);

  const lightboxSlides = useMemo(
    () => allProjectImages.map((img) => ({ 
      src: typeof img === 'string' ? img : img.src 
    })),
    [allProjectImages]
  );

  const handleImageClick = useCallback(
    (clickedImage: StaticImageData | string) => {
      const clickedSrc = typeof clickedImage === 'string' ? clickedImage : clickedImage.src;
      const index = allProjectImages.findIndex((img) => {
        const imgSrc = typeof img === 'string' ? img : img.src;
        return imgSrc === clickedSrc;
      });

      if (index !== -1) {
        setLightboxIndex(index);
        setLightboxOpen(true);
      }
    },
    [allProjectImages]
  );

  return (
    <>
      <article className={styles.articleContainer}>
        
        {/* --- HEADER BÀI VIẾT --- */}
        <header className="mb-12 md:mb-20 text-center">
          {/* Category & Year */}
          <div className="flex items-center justify-center gap-3 text-xs font-bold tracking-[0.2em] text-[var(--sub-text)] uppercase mb-4">
            <span>{project.categoryName}</span>
            <span className="w-1 h-1 rounded-full bg-[var(--sub-text)]"></span>
            <span>{project.year}</span>
          </div>

          {/* Title */}
          <h1 className={styles.articleTitle}>{project.title}</h1>

          {/* Meta Info (Client / Location) */}
          <div className="flex flex-wrap justify-center gap-6 mt-6 text-sm font-medium text-[var(--foreground)]">
            {clientCredit && (
              <div className="flex items-center gap-2">
                <span className="text-[var(--sub-text)]">Client:</span>
                <span>{clientCredit.value}</span>
              </div>
            )}
            {locationCredit && (
              <div className="flex items-center gap-2">
                <span className="text-[var(--sub-text)]">Location:</span>
                <span>{locationCredit.value}</span>
              </div>
            )}
          </div>
        </header>

        {/* --- HERO THUMBNAIL (Nếu muốn hiển thị lại ảnh bìa) --- */}
        {/* <div className="w-full aspect-[16/9] relative mb-16 rounded-lg overflow-hidden shadow-lg">
           <Image src={project.image} alt={project.title} fill className="object-cover" priority />
        </div> */}

        {/* --- INTRO DESCRIPTION --- */}
        {project.description && (
          <div className={styles.textWrap}>
            <p className="text-lg md:text-xl leading-relaxed font-light italic text-[var(--sub-text)] border-l-2 border-[var(--foreground)] pl-6">
              {project.description}
            </p>
          </div>
        )}

        {/* --- MAIN CONTENT BODY --- */}
        <div className="space-y-12 md:space-y-20 mt-16">
          {project.articleBody?.map((block, index) => {
            switch (block.type) {
              case 'heading':
                return (
                  <div key={index} className={styles.highlightWrap}>
                    <h2 className="text-2xl md:text-3xl font-bold text-[var(--foreground)] mt-8 mb-4">
                      {block.content}
                    </h2>
                  </div>
                );
              case 'paragraph':
                return (
                  <div key={index} className={styles.textWrap}>
                    <p className="text-base md:text-lg leading-loose text-[var(--sub-text)]">
                      {block.content}
                    </p>
                  </div>
                );
              case 'imageRow':
                const imageCount = block.images.length;
                return (
                  <div key={index} className={`${styles.imageRow} flex flex-wrap gap-2 md:gap-4 justify-center`}>
                    {block.images.map((img, imgIndex) => (
                      <ArticleImage
                        key={`${index}-${imgIndex}`}
                        image={img}
                        onClick={() => handleImageClick(img)}
                        imageCount={imageCount}
                      />
                    ))}
                  </div>
                );
              default:
                return null;
            }
          })}
        </div>

        {/* --- FOOTER CREDITS --- */}
        {project.credits && project.credits.length > 0 && (
          <div className="mt-24 pt-12 border-t border-[var(--foreground)]/10">
            <h3 className="text-md text-center uppercase font-bold tracking-widest mb-8 text-[var(--foreground)]">
              Credit
            </h3>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-x-12 gap-y-4 max-w-2xl mx-auto">
              {project.credits.map((credit, index) => (
                <div key={index} className="flex justify-between items-baseline text-sm border-b border-dashed border-[var(--sub-text)]/20 pb-2">
                  <span className="font-semibold text-[var(--sub-text)] opacity-80">
                    {credit.label}
                  </span>
                  <span className="text-right text-[var(--foreground)] font-medium">
                    {credit.value}
                  </span>
                </div>
              ))}
            </div>
          </div>
        )}

        {/* --- NAVIGATION --- */}
        <div
          ref={navRef}
          className={`mt-24 transition-opacity duration-1000 ${
            navInView ? 'opacity-100 translate-y-0' : 'opacity-0 translate-y-10'
          }`}
        >
          <ProjectNavigation
            prevProjectLink={prevProjectLink}
            nextProjectLink={nextProjectLink}
          />
        </div>
      </article>

      {/* --- LIGHTBOX COMPONENT --- */}
      <Lightbox
        open={lightboxOpen}
        close={() => setLightboxOpen(false)}
        index={lightboxIndex}
        slides={lightboxSlides}
        plugins={[Zoom, Thumbnails, Captions]}
        animation={{ fade: 300, swipe: 250 }}
        carousel={{ finite: false }}
        controller={{ closeOnBackdropClick: true }}
        zoom={{ maxZoomPixelRatio: 3 }}
        styles={{ container: { backgroundColor: "rgba(0, 0, 0, .95)" } }}
      />
    </>
  );
}
```

## File: src/app/dich-vu/page.tsx
```typescript
// app/dich-vu/page.tsx
'use client'; // Bắt buộc vì dùng state và hooks

import React, { useState, useEffect, useRef } from 'react';
import Container from '@/components/Container';
import styles from '../styles/DichVu.module.css';
import Image from 'next/image';
import BtsSection from '@/components/BtsSection';
// ROOM IMAGES
import room_A_img from '../../assets/service/section_01/room_A.webp';
import room_B_img from '../../assets/service/section_01/room_B.webp';
import room_C_img from '../../assets/service/section_01/room_C.webp';
import room_D_img from '../../assets/service/section_01/room_D.webp';

// DEVICE IMAGES
import img_godox_dp600 from '../../assets/service/section_02/GODOX-DP600III-V.webp';
import img_godox_dp400 from '../../assets/service/section_02/GODOX-GD-DP400II-V.webp';
import img_godox_qt400 from '../../assets/service/section_02/GODOX-QT400IIIM.webp';
import img_godox_qt600 from '../../assets/service/section_02/GODOX-QT600II.webp';
import img_godox_qs400 from '../../assets/service/section_02/GODOX-QS-400.webp';
import img_godox_qs800 from '../../assets/service/section_02/GODOX-QS-800.webp';
import img_godox_qs1200 from '../../assets/service/section_02/GODOX-QS-1200.webp';
import img_amaran_300c from '../../assets/service/section_02/aputure-amaran-300c.webp';
import img_devices from '../../assets/service/section_02/devices.webp';

// MODIFIER IMAGES
import img_QR_p60t from '../../assets/service/section_02/GODOX-QR-P60T.webp';
import img_QR_p90 from '../../assets/service/section_02/GODOX-QR-P90.webp';
import img_QR_P120 from '../../assets/service/section_02/GODOX-QR-P120.webp';
import img_QR_P150t from '../../assets/service/section_02/GODOX-QR-P150T.webp';

// 1. ĐỊNH NGHĨA CÁC MỤC (Sections) - (Giữ nguyên, đã đúng)
const sections = [
  { id: 'bao-gia', title: 'Báo Giá Phòng', contentId: 'section-01' },
  { id: 'thiet-bi-mien-phi', title: 'Thiết Bị Đi Kèm', contentId: 'section-02' },
  { id: 'thiet-bi-thue-them', title: 'Thiết Bị Thuê Thêm', contentId: 'section-03' },
  { id: 'quy-dinh', title: 'Lưu Ý & Quy Định', contentId: 'section-04' },
];

// 2. COMPONENT "SCENE" (Giữ nguyên)
interface SceneProps {
  children: React.ReactNode;
  id: string;
  onVisible: (id: string) => void;
}

const Scene: React.FC<SceneProps> = ({ children, id, onVisible }) => {
  const ref = useRef<HTMLDivElement>(null);

useEffect(() => {
    const node = ref.current;
    if (!node) return;

    const observer = new IntersectionObserver(
      (entries) => {
        const [entry] = entries;
        if (entry.isIntersecting) {
          onVisible(id); // Báo cho component cha biết mục này đang active
        }
      },
      {
        rootMargin: '-50% 0px 0% 0px',
        threshold: 0,
      }
    );

    observer.observe(node);
    return () => observer.disconnect();
  }, [id, onVisible]);

  return (
    <div ref={ref} id={id} className={styles.sceneContent}>
      {children}
    </div>
  );
};
// 3. COMPONENT TRANG CHÍNH
export default function DichVuPage() {
  const [activeId, setActiveId] = useState(sections[0].id);
  
  // Dữ liệu cho Section 02 (Miễn Phí)
  const strobes = [
    { name: 'Godox DP400', img: img_godox_dp400 },
    { name: 'Godox DP600', img: img_godox_dp600 },
    { name: 'Godox QT400', img: img_godox_qt400 },
    { name: 'Godox QT600', img: img_godox_qt600 },
    { name: 'Godox QS400', img: img_godox_qs400 },
    { name: 'Godox QS800', img: img_godox_qs800 },
    { name: 'Godox QS1200', img: img_godox_qs1200 },
    { name: 'Aputure Amaran 300C', img: img_amaran_300c },

  ];

  const modifiers = [
    { name: 'Godox QR P60T', img: img_QR_p60t },
    { name: 'Godox QR P90', img: img_QR_p90 },
    { name: 'Godox QR P120', img: img_QR_P120 },
    { name: 'Godox QR P150T', img: img_QR_P150t },
  ];

  const rentalItems = [
    { name: 'Nanlite FS300B', price: '300k/đèn', note: '(có sẵn 2 đèn)' },
    { name: 'Nanlite FS200B', price: '200k/đèn', note: '(có sẵn 3 đèn)' },
    { name: 'Tolifo 1800W-Bi', price: '400k/đèn', note: '(có sẵn 1 đèn)' },
    { name: 'Nanlite FS150', price: '150k/đèn', note: '(có sẵn 1 đèn)' },
    { name: 'Nanlite Forza 60', price: '50k/đèn', note: '(có sẵn 2 đèn)' },
    { name: 'Tether (dây)', price: '75k/dây' },
    { name: 'iMac 27" 5k', price: '250k/buổi' },
    { name: 'Màn Dell 25"', price: '150k/buổi' },
    { name: 'Phông vải/xanh key (6x6.4m)', price: '200k' },
  ];

  const paperColors = [
    { name: '44 Jet', hex: '#1f1f1f' },
    { name: '04 Neutral Grey', hex: '#7c7f7e' },
    { name: '42 Morning Mist', hex: '#d9dadb' },
    { name: '01 Deep Blue', hex: '#35475e' },
    { name: '41 Marine Blue', hex: '#69819d' },
    { name: '61 Blue Lake', hex: '#4c7da6' },
    { name: '06 Nassau', hex: '#008bc0' },
    { name: '59 Lite Blue', hex: '#70c5d5' },
    { name: '55 Alpine', hex: '#b3d8d6' },
    { name: '67 Nutmeg', hex: '#8e6f5c' },
    { name: '33 Ivorine', hex: '#e5d9bb' },
    { name: '13 Deep Green', hex: '#1e4a42' },
    { name: '10 Leaf', hex: '#485f39' },
    { name: '54 Stinger', hex: '#78a34b' },
    { name: '63 Apple', hex: '#b7d296' },
    { name: '14 Forsythia Yellow', hex: '#f3c421' },
    { name: '83 Yellow-Orange', hex: '#f5822e' },
    { name: '27 Flame', hex: '#d44a3b' },
    { name: '56 Scarlet', hex: '#ba2429' },
    { name: '10 Bright Orange', hex: '#f3642c' },
    { name: '29 Thistle', hex: '#d6a9b9' },
    { name: '17 Carnation Pink', hex: '#f093a5' },
  ];

  // Mảng 2: Phông Vải Trơn
  const fabricColorsPlain = [
    { name: 'Đen', hex: '#000000' },
    { name: 'Đỏ', hex: '#cc3333' },
    { name: 'Xanh', hex: '#006633' },
  ];
  
  // Mảng 3: Phông Vải Loang
  const fabricColorsPatterned = [
    { name: 'Nâu Loang', hex: '#8c7a65' },
    { name: 'Xám Sáng Loang', hex: '#c1c1c1' },
    { name: 'Xám Tối Loang', hex: '#6e6e6e' },
  ];
  
  // Mảng 4: Thảm Nỉ
  const carpetColors = [
    { name: 'Đỏ Đô', hex: '#800000' },
    { name: 'Xanh Navy', hex: '#000080' },
  ];
  return (
    <main>
      <Container className="py-16 md:py-24">
        {/* Tiêu đề chung của trang */}
        <div className="text-center mb-16">
          <h1 className="text-4xl md:text-5xl font-light tracking-tighter">
            Dịch Vụ & Báo Giá
          </h1>
          <p className="text-lg mt-4 text-[var(--sub-text)]">
            Tất cả thông tin về các gói thuê và thiết bị tại studio.
          </p>
        </div>

        {/* BỐ CỤC 2 CỘT */}
        <div className={styles.stickyLayout}>
          {/* CỘT 1: MENU (DÍNH LẠI) */}
          <nav className={styles.stickyNav}>
            <ul>
              {sections.map((section) => (
                <li key={section.id}>
                  <a
                    href={`#${section.id}`}
                    className={activeId === section.id ? styles.active : ''}
                  >
                    {section.title}
                  </a>
                </li>
              ))}
            </ul>
          </nav>

          {/* CỘT 2: NỘI DUNG (CUỘN) */}
          <main className={styles.contentColumn}>
            {/* === MỤC 01: BÁO GIÁ PHÒNG === */}
            <Scene id="bao-gia" onVisible={setActiveId}>
              <h2 className={styles.contentTitle}>Báo Giá Thuê Phòng</h2>
              
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6 lg:gap-8">
                
                {/* --- THẺ 1: ROOM A --- */}
                <div className="border border-[var(--foreground)]/30 rounded-lg overflow-hidden bg-[var(--background)] flex flex-col">
                  <div className="relative w-full h-72">
                    <Image
                      src={room_A_img}
                      alt="Không gian phòng studio A"
                      fill
                      sizes="(max-width: 768px) 100vw, 50vw"
                      className="object-cover"
                      priority
                      placeholder="blur"
                    />
                  </div>
                  <div className="p-6 flex flex-col flex-grow">
                    <h3 className="text-2xl font-semibold mb-4">Room A</h3>
                    <div className="mb-4">
                      <span className="text-4xl font-bold">300k</span>
                      <span className="text-lg text-[var(--foreground)]/70">/giờ</span>
                      <p className="text-sm text-[var(--foreground)]/70 -mt-1">
                        (Áp dụng cho lịch book từ 2 tiếng)
                      </p>
                    </div>
                    <div className="mb-5 p-3 bg-[var(--foreground)]/5 border border-[var(--foreground)]/10 rounded-lg">
                      <span className="text-2xl font-bold">350k</span>
                      <span className="text-base text-[var(--foreground)]/70">/giờ</span>
                      <p className="text-sm text-[var(--foreground)]/70">
                        (Cho lịch book dưới 2 tiếng)
                      </p>
                    </div>
                    <ul className="space-y-1 text-sm list-disc list-inside mt-auto">
                      <li>60m²</li>
                      <li>(D8,5 x R5,8 x C4,3)</li>
                    </ul>
                  </div>
                </div>

                {/* --- THẺ 2: ROOM B --- */}
                <div className="border border-[var(--foreground)]/30 rounded-lg overflow-hidden bg-[var(--background)] flex flex-col">
                  <div className="relative w-full h-72">
                    <Image
                      src={room_B_img}
                      alt="Không gian phòng studio B"
                      fill
                      sizes="(max-width: 768px) 100vw, 50vw"
                      className="object-cover"
                      priority={true}
                      placeholder="blur" 
                    />
                  </div>
                  <div className="p-6 flex flex-col flex-grow">
                    <h3 className="text-2xl font-semibold mb-4">Room B</h3>
                    <div className="mb-4">
                      <span className="text-4xl font-bold">300k</span>
                      <span className="text-lg text-[var(--foreground)]/70">/giờ</span>
                      <p className="text-sm text-[var(--foreground)]/70 -mt-1">
                        (Áp dụng cho lịch book từ 2 tiếng)
                      </p>
                    </div>
                    <div className="mb-5 p-3 bg-[var(--foreground)]/5 border border-[var(--foreground)]/10 rounded-lg">
                      <span className="text-2xl font-bold">350k</span>
                      <span className="text-base text-[var(--foreground)]/70">/giờ</span>
                      <p className="text-sm text-[var(--foreground)]/70">
                        (Cho lịch book dưới 2 tiếng)
                      </p>
                    </div>
                    <ul className="space-y-1 text-sm list-disc list-inside mt-auto">
                      <li>65m²</li>
                      <li>(D9 x R3,7 x C3,8)</li>
                    </ul>
                  </div>
                </div>

                {/* --- THẺ 3: ROOM C --- */}
                <div className="border border-[var(--foreground)]/30 rounded-lg overflow-hidden bg-[var(--background)] flex flex-col">
                  <div className="relative w-full h-72">
                    <Image
                      src={room_C_img}
                      alt="Không gian phòng studio C"
                      fill
                      sizes="(max-width: 768px) 100vw, 50vw"
                      className="object-cover"
                      priority
                      placeholder="blur" 
                    />
                  </div>
                  <div className="p-6 flex flex-col flex-grow">
                    <h3 className="text-2xl font-semibold mb-4">Room C</h3>
                    <div className="mb-4">
                      <span className="text-4xl font-bold">300k</span>
                      <span className="text-lg text-[var(--foreground)]/70">/giờ</span>
                      <p className="text-sm text-[var(--foreground)]/70 -mt-1">
                        (Áp dụng cho lịch book từ 2 tiếng)
                      </p>
                    </div>
                    <div className="mb-5 p-3 bg-[var(--foreground)]/5 border border-[var(--foreground)]/10 rounded-lg">
                      <span className="text-2xl font-bold">350k</span>
                      <span className="text-base text-[var(--foreground)]/70">/giờ</span>
                      <p className="text-sm text-[var(--foreground)]/70">
                        (Cho lịch book dưới 2 tiếng)
                      </p>
                    </div>
                    <ul className="space-y-1 text-sm list-disc list-inside mt-auto">
                      <li>60m²</li>
                      <li>(D8,6 x R6 x C3,9)</li>
                    </ul>
                  </div>
                </div>

                {/* --- THẺ 4: ROOM D --- */}
                <div className="border border-[var(--foreground)]/30 rounded-lg overflow-hidden bg-[var(--background)] flex flex-col">
                  <div className="relative w-full h-72">
                    <Image
                      src={room_D_img}
                      alt="Không gian phòng studio D"
                      fill
                      sizes="(max-width: 768px) 100vw, 50vw"
                      className="object-cover"
                      priority
                      placeholder="blur"
                    />
                  </div>
                  <div className="p-6 flex flex-col flex-grow">
                    <h3 className="text-2xl font-semibold mb-4">Room D</h3>
                    <div className="mb-4">
                      <span className="text-4xl font-bold">280k</span>
                      <span className="text-lg text-[var(--foreground)]/70">/giờ</span>
                      <p className="text-sm text-[var(--foreground)]/70 -mt-1">
                        (Áp dụng cho lịch book từ 2 tiếng)
                      </p>
                    </div>
                    <div className="mb-5 p-3 bg-[var(--foreground)]/5 border border-[var(--foreground)]/10 rounded-lg">
                      <span className="text-2xl font-bold">320k</span>
                      <span className="text-base text-[var(--foreground)]/70">/giờ</span>
                      <p className="text-sm text-[var(--foreground)]/70">
                        (Cho lịch book dưới 2 tiếng)
                      </p>
                    </div>
                    <ul className="space-y-1 text-sm list-disc list-inside mt-auto">
                      <li>45m²</li>
                      <li>(D8,2 x R4,6 x C3,3)</li>
                    </ul>
                  </div>
                </div>
              </div> 
              
              <div className="mt-8">
                <div className="p-4 bg-[var(--foreground)]/5 border border-[var(--foreground)]/10 rounded-lg">
                  <p className="font-semibold text-center text-sm">
                    * Phụ thu 50k/h nếu có sử dụng đèn LED (đèn quay phim).
                  </p>
                </div>
              </div>
            </Scene>


            <Scene id="thiet-bi-mien-phi" onVisible={setActiveId}>
              <h2 className={styles.contentTitle}>Thiết Bị Đi Kèm (Miễn Phí)</h2>

              {/* 1. ẢNH HERO "WOW FACTOR" */}
              <div className="relative w-full h-72 md:h-96 rounded-lg overflow-hidden mb-12 border border-[var(--foreground)]/30">
                <Image
                  src={img_devices}
                  alt="Toàn bộ thiết bị tại Oni Studio"
                  fill
                  className="object-cover hover:scale-110"
                  sizes="(max-width: 768px) 100vw, 70vw"
                  placeholder="blur"
                />
                <div className="absolute inset-0" />
              </div>

              {/* 2. GRID ĐÈN STUDIO */}
              <h3 className="text-2xl font-semibold mb-6">Đèn Godox</h3>
              <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                {strobes.map((item) => (
                  <div key={item.name} className="border border-[var(--foreground)]/30 rounded-lg overflow-hidden bg-[var(--background)] flex flex-col">
                    <div className="relative w-full h-40 bg-white">
                      <Image
                        src={item.img}
                        alt={item.name}
                        fill
                        sizes="(max-width: 768px) 50vw, 25vw"
                        className="object-contain p-2"
                        placeholder="blur"
                      />
                    </div>
                    <div className="p-4 text-center">
                      <h4 className="font-semibold text-sm">{item.name}</h4>
                    </div>
                  </div>
                ))}
              </div>
              <p className="text-center text-sm text-[var(--foreground)]/70 mb-12">
                (Hỗ trợ setup tối đa 4 đèn flash)
              </p>

              {/* 3. GRID TẢN SÁNG */}
              <h3 className="text-2xl font-semibold mb-6">Tản Sáng</h3>
              <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-12">
                {modifiers.map((item) => (
                  <div key={item.name} className="border border-[var(--foreground)]/30 rounded-lg overflow-hidden bg-[var(--background)] flex flex-col">
                    <div className="relative w-full h-40 bg-white">
                      <Image
                        src={item.img}
                        alt={item.name}
                        fill
                        sizes="(max-width: 768px) 50vw, 25vw"
                        className="object-contain p-2"
                        placeholder="blur"
                      />
                    </div>
                    <div className="p-4 text-center">
                      <h4 className="font-semibold text-sm">{item.name}</h4>
                    </div>
                  </div>
                ))}
              </div>

              {/* 4. PHÔNG NỀN & PHỤ KIỆN */}
              <h3 className="text-2xl font-semibold mb-6">Phông Nền & Phụ Kiện</h3>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-8 p-6 bg-[var(--foreground)]/5 border border-[var(--foreground)]/10 rounded-lg">
                
                {/* --- CỘT 1: PHÔNG GIẤY & TƯỜNG (Nội dung dài) --- */}
                <div>
                  <h4 className="text-lg font-semibold mb-4">Phông Giấy & Tường</h4>
                  
                  {/* Tường Vô Cực */}
                  <div className="mb-4">
                    <h5 className="text-base font-semibold mb-2">Tường Trắng Vô Cực</h5>
                    <div className="flex items-center gap-2">
                      <div
                        className={styles.colorSwatch}
                        style={{ backgroundColor: '#ffffff' }}
                      />
                      <span className="text-sm">Sử dụng miễn phí</span>
                    </div>
                  </div>

                  {/* Phông Giấy */}
                  <div>
                    <h5 className="text-base font-semibold mb-2">Phông Giấy (11x2.7m)</h5>
                    <div className="flex flex-wrap gap-x-5 gap-y-3 mt-3">
                      {paperColors.map((color) => (
                        <div
                          key={color.name}
                          className={styles.colorSwatch}
                          style={{ backgroundColor: color.hex }}
                          title={color.name} // Hiện tên khi hover
                        />
                      ))}
                    </div>
                  </div>

                  {/* Phụ Kiện Chung */}
                  <div>
                    <h4 className="text-lg font-semibold my-4">Phụ Kiện Chung</h4>
                    <ul className="space-y-1.5 list-disc list-inside text-sm">
                      <li>Chóa đèn, Bandoor, Dù (đen/trắng/bạc)</li>
                      <li>Tản sáng, Hắt sáng 5-in-1, Poly (đen/trắng)</li>
                      <li>Gel màu, Snoot (gom sáng), Ngàm</li>
                      <li>C-stand, Boom, Chân đèn các loại</li>
                      <li>Bàn chụp sản phẩm, Ghế đôn</li>
                      <li>Bàn ủi hơi nước, Sào treo quần áo</li>
                      <li>Và nhiều phụ kiện khác...</li>
                    </ul>
                  </div>

                </div>

                {/* --- CỘT 2: VẢI, THẢM & PHỤ KIỆN (Nội dung ngắn hơn) --- */}
                <div>
                  {/* Phông Vải & Thảm */}
                  <div className="mb-6">
                    <h4 className="text-lg font-semibold mb-4">Phông Vải & Thảm</h4>
                    {/* Phông Vải */}
                    <div className="mb-4">
                      <h5 className="text-base font-semibold mb-2">Phông Vải</h5>
                      <div className="flex gap-12">
                        {/* Vải Trơn */}
                        <div>
                          <h6 className="text-sm font-semibold mb-2 opacity-70">Trơn</h6>
                          <div className="flex flex-wrap gap-x-4 gap-y-3">
                            {fabricColorsPlain.map((color) => (
                              <div
                                key={color.name}
                                className={styles.colorSwatch}
                                style={{ backgroundColor: color.hex }}
                                title={color.name}
                              />
                            ))}
                          </div>
                        </div>
                        {/* Vải Loang */}
                        <div>
                          <h6 className="text-sm font-semibold mb-2 opacity-70">Loang</h6>
                          <div className="flex flex-wrap gap-x-4 gap-y-3">
                            {fabricColorsPatterned.map((color) => (
                              <div
                                key={color.name}
                                className={styles.colorSwatch}
                                style={{ 
                                  background: `radial-gradient(ellipse at center, ${color.hex} 50%, #5c5c5c 100%)`
                                }}
                                title={color.name}
                              />
                            ))}
                          </div>
                        </div>
                      </div>
                    </div>
                    {/* Thảm Nỉ */}
                    <div>
                      <h5 className="text-base font-semibold mb-2">Thảm Nỉ (5x3.66m)</h5>
                      <div className="flex flex-wrap gap-x-4 gap-y-3 mb-1">
                        {carpetColors.map((color) => (
                          <div
                            key={color.name}
                            className={styles.colorSwatch}
                            style={{ backgroundColor: color.hex }}
                            title={color.name}
                          />
                        ))}
                      </div>
                      <p className="text-xs text-[var(--foreground)]/70">
                        (Phụ phí setup thảm 100k)
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            </Scene>

            <Scene id="thiet-bi-thue-them" onVisible={setActiveId}>
              <h2 className={styles.contentTitle}>Thiết Bị Thuê (Tính Phí)</h2>
              <p className="text-[var(--foreground)]/70 mb-6">
                Các thiết bị chuyên dụng cho nhu cầu cao hơn, vui lòng liên hệ trước để kiểm tra.
              </p>
              
              {/* Bảng giá trên desktop, layout thẻ trên mobile */}
              <div className="overflow-x-auto border border-[var(--foreground)]/30 rounded-lg">
                <table className="w-full min-w-full text-sm text-left">
                  <thead className="border-b border-[var(--foreground)]/30 bg-[var(--foreground)]/5">
                    <tr>
                      <th className="py-3 px-4 font-semibold">Thiết Bị</th>
                      <th className="py-3 px-4 font-semibold">Giá Thuê</th>
                      <th className="py-3 px-4 font-semibold">Ghi Chú</th>
                    </tr>
                  </thead>
                  <tbody>
                    {rentalItems.map((item) => (
                      <tr key={item.name} className="border-b border-[var(--foreground)]/10">
                        <td className="py-3 px-4 font-medium">{item.name}</td>
                        <td className="py-3 px-4">{item.price}</td>
                        <td className="py-3 px-4 text-[var(--foreground)]/70">
                          {item.note}
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </Scene>
            <Scene id="quy-dinh" onVisible={setActiveId}>
              <h2 className={styles.contentTitle}>Tiện ích & Quy Định Chung</h2>
              
              {/* THAY ĐỔI: Chuyển sang grid-cols-5 để chia 40% (col-span-2) / 60% (col-span-3) */}
              <div className="grid grid-cols-1 md:grid-cols-5 gap-8 p-6 bg-[var(--foreground)]/5 border border-[var(--foreground)]/10 rounded-lg">
                
                {/* Cột 1: Tiện Ích (40%) */}
                <div className="md:col-span-2"> {/* Sửa từ md:col-5 */}
                  <h4 className="text-lg font-semibold mb-4">Tiện ích Studio</h4>
                  <ul className="space-y-2 list-disc list-inside text-sm">
                    <li>Miễn phí hỗ trợ setup ánh sáng ban đầu.</li>
                    <li>Mini Canteen phục vụ (có tính phí).</li>
                    <li>Khu vực makeup riêng biệt, miễn phí.</li>
                    <li>Hỗ trợ bàn ủi hơi nước.</li>
                  </ul>
                </div>
                
                {/* Cột 2: Lưu Ý (60%) */}
                <div className="md:col-span-3"> {/* Sửa từ md:col-7 */}
                  <h4 className="text-lg font-semibold mb-4">Lưu Ý Chung</h4>
                  <ul className="space-y-2 list-disc list-inside text-sm">
                    <li>Hỗ trợ tối đa 7 người/ekip, phụ thu 50k/người nếu phát sinh.</li>
                    <li>Hỗ trợ thời gian makeup/chuẩn bị 01 tiếng trước giờ đặt.</li>
                    <li>Makeup/quay phim sử dụng khu vực makeup chung, không hỗ trợ đèn riêng (nếu quá 4 người).</li>
                    <li>Quý khách vui lòng xác nhận lịch và setup. Phí thuê tính từ giờ đã nhận phòng.</li>
                  </ul>
                </div>
              </div>
            </Scene>
          </main>
        </div>
      </Container>
      <BtsSection />
    </main>
  );
}
```

## File: src/app/layout.tsx
```typescript
import type { Metadata } from "next";
import "./globals.css";
import ScrollToTopButton from '@/components/ScrollToTopButton';
import LayoutWrapper from '@/components/LayoutWrapper';
import { Providers } from './providers';
import { Toaster } from 'sonner';

export const metadata: Metadata = {
  metadataBase: new URL(process.env.NEXT_PUBLIC_SITE_URL || 'http://localhost:3000'),
  title: "Oni Studio",
  description: "Showcase of professional photography projects.",
  openGraph: {
    title: 'Oni Studio',
    description: 'Mô tả mặc định...',
    images: ['/default-og-image.jpg'], // Một ảnh đại diện mặc định
  },
};


export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
   <html lang="vi" suppressHydrationWarning>
     <body className="bg-[var(--background)] 
                      text-[var(--foreground)]
                       antialiased flex flex-col min-h-screen
                       transition-colors duration-300">
        <Providers>
          <LayoutWrapper>{children}
            <Toaster position="bottom-right" richColors />
          </LayoutWrapper>
          <ScrollToTopButton />
        </Providers>
      </body>
    </html>
  );
}
```

## File: src/components/PortfolioSection.tsx
```typescript
// src/components/PortfolioSection.tsx
'use client';

import { useState, useEffect } from 'react';
import { motion, AnimatePresence } from 'motion/react';
// 1. Thêm StaticImageData vào import
import Image, { StaticImageData } from 'next/image'; 
import Link from 'next/link';
import { ArrowUpRight, Loader2 } from 'lucide-react';
import { getProjects } from '@/lib/actions'; 
import { ProjectData } from '@/data/projects-master-data'; 
import Container from './Container';

const CATEGORIES = [
  { id: 'all', label: 'Tất cả' },
  { id: 'thoi-trang', label: 'Thời trang' },
  { id: 'thuong-mai', label: 'Thương mại' },
  { id: 'ca-nhan', label: 'Cá nhân' },
];

export default function PortfolioSection() {
  const [activeCategory, setActiveCategory] = useState('all');
  const [projects, setProjects] = useState<ProjectData[]>([]);
  const [isLoading, setIsLoading] = useState(true);

  useEffect(() => {
    const fetchData = async () => {
      setIsLoading(true);
      try {
        const allData = await getProjects();
        // Chỉ lấy dự án Featured
        const featuredOnly = allData.filter(p => p.isFeatured === true);
        setProjects(featuredOnly);
      } catch (error) {
        console.error("Lỗi tải dự án:", error);
      } finally {
        setIsLoading(false);
      }
    };

    fetchData();
  }, []);

  const filteredProjects = projects.filter((project) => {
    if (activeCategory === 'all') return true;
    return project.category === activeCategory;
  });

  // 2. Sửa Helper Function: Dùng Union Type chuẩn xác
  const getImageSrc = (img: string | StaticImageData) => {
    return typeof img === 'string' ? img : img.src;
  };

  return (
    <Container className="py-20 px-4 md:px-8 bg-[var(--background)]">
      <div className="max-w-8xl mx-auto">
        
        {/* Header & Filter */}
        <div className="flex flex-col md:flex-row justify-between items-end mb-12 gap-6">
          <div>
            <h2 className="text-4xl md:text-6xl font-bold text-[var(--foreground)] tracking-tighter mb-4">
              Dự án Nổi bật
            </h2>
            <p className="text-[var(--sub-text)] max-w-md">
              Tuyển tập các dự án tiêu biểu, nơi ánh sáng và cảm xúc giao thoa.
            </p>
          </div>

          {/* Filter Buttons */}
          <div className="flex flex-wrap gap-2">
            {CATEGORIES.map((cat) => (
              <button
                key={cat.id}
                onClick={() => setActiveCategory(cat.id)}
                className={`px-4 py-2 rounded-full text-sm transition-all duration-300 border cursor-pointer ${
                  activeCategory === cat.id
                    ? 'bg-[var(--foreground)] text-[var(--background)] border-[var(--foreground)]'
                    : 'bg-transparent text-[var(--sub-text)] border-[var(--sub-text)] hover:border-[var(--foreground)] hover:text-[var(--foreground)]'
                }`}
              >
                {cat.label}
              </button>
            ))}
          </div>
        </div>

        {/* Loading State */}
        {isLoading && (
          <div className="flex justify-center items-center h-64">
            <Loader2 className="animate-spin text-[var(--sub-text)]" size={32} />
          </div>
        )}

        {/* Empty State */}
        {!isLoading && filteredProjects.length === 0 && (
          <div className="text-center py-20 text-[var(--sub-text)] border border-dashed border-[var(--sub-text)]/30 rounded-xl">
            <p>Chưa có dự án nổi bật nào trong danh mục này.</p>
            <Link href="/admin/projects" className="text-sm text-blue-500 hover:underline mt-2 inline-block">
              Vào Admin để thêm dự án hoặc điều chỉnh dự án <strong>Nổi bật</strong>
            </Link>
          </div>
        )}

        {/* Grid Display */}
        <motion.div 
          layout
          className="grid grid-cols-1 md:grid-cols-3 gap-4 auto-rows-[300px] md:auto-rows-[400px]"
        >
          <AnimatePresence>
            {filteredProjects.map((project) => (
              <motion.div
                layout
                initial={{ opacity: 0, scale: 0.9 }}
                animate={{ opacity: 1, scale: 1 }}
                exit={{ opacity: 0, scale: 0.9 }}
                transition={{ duration: 0.4 }}
                key={project.id}
                className="relative group overflow-hidden bg-gray-100 dark:bg-neutral-900 cursor-pointer"
                style={{
                  gridColumn: `span ${project.colSpan}`,
                  gridRow: `span ${project.rowSpan}`
                }}
              >
                <Link href={`/du-an/${project.slug}`} className="block h-full w-full">
                  {/* Image */}
                  <Image
                    src={getImageSrc(project.image)}
                    alt={project.title}
                    fill
                    className="object-cover transition-transform duration-700 group-hover:scale-105"
                    sizes="(max-width: 768px) 100vw, (max-width: 1200px) 50vw, 33vw"
                  />

                  {/* Overlay Info */}
                  <div className="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex flex-col justify-end p-6">
                    <div className="transform translate-y-4 group-hover:translate-y-0 transition-transform duration-300">
                      <span className="text-xs font-medium text-white/80 uppercase tracking-wider mb-2 block">
                        {project.categoryName} — {project.year}
                      </span>
                      <div className="flex justify-between items-center">
                        <h3 className="text-2xl font-bold text-white">
                          {project.title}
                        </h3>
                        <div className="bg-white/20 p-2 rounded-full backdrop-blur-sm">
                          <ArrowUpRight className="text-white w-5 h-5" />
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  {/* Badge Nổi Bật */}
                  <div className="absolute top-4 right-4 bg-[var(--foreground)] text-[var(--background)] text-[10px] font-bold uppercase px-2 py-1 rounded shadow-sm z-10">
                    Nổi bật
                  </div>
                </Link>
              </motion.div>
            ))}
          </AnimatePresence>
        </motion.div>

      </div>
    </Container>
  );
}
```

## File: src/lib/actions.ts
```typescript
// src/lib/actions.ts
'use server';
import { createClient } from '@supabase/supabase-js';
import { supabase } from '../../lib/supabase';
import { PROJECTS_MASTER_DATA, ProjectData, ArticleBlock } from '@/data/projects-master-data';
import { revalidatePath } from 'next/cache';
import { cookies } from 'next/headers';
import { createServerClient } from '@supabase/ssr';


// 1. Định nghĩa Interface CHÍNH XÁC khớp với Database
interface ProjectRow {
  project_id: number;
  title: string;
  client_name: string | null;
  description: string | null;
  thumbnail_url: string | null;
  created_at: string;
  slug: string;
  col_span: number | null;
  row_span: number | null;
  is_featured: boolean;
  
  // QUAN TRỌNG: Cột chứa nội dung bài viết
  content: ArticleBlock[] | null; 
  credits: { label: string; value: string }[] | null;

  // Join bảng categories
  portfolio_categories: {
    name: string;
    slug: string;
  } | null;
  
  // Join bảng ảnh cũ (Fallback)
  project_images: {
    image_url: string;
    display_order: number;
  }[];
}
async function requireAdmin(token: string) {
  const supabase = createClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    { global: { headers: { Authorization: `Bearer ${token}` } } }
  );

  const { data: { user } } = await supabase.auth.getUser();
  if (!user) throw new Error("Unauthorized");

  const { data: profile } = await supabase
    .from('users')
    .select('role')
    .eq('auth_id', user.id)
    .single();

  if (profile?.role !== 'Admin') {
    throw new Error("Forbidden: Chỉ Admin mới có quyền này.");
  }
}
// 2. Hàm lấy danh sách dự án, có thể lọc theo categorySlug
export async function getProjects(categorySlug?: string): Promise<ProjectData[]> {
  try {
    // --- CHECK DEMO MODE ---
    const { data: setting } = await supabase
      .from('settings')
      .select('value')
      .eq('key', 'is_demo_mode')
      .single();

    const isDemo = setting?.value === 'true';

    if (isDemo) {
      let data = PROJECTS_MASTER_DATA;
      if (categorySlug && categorySlug !== 'all') {
        data = data.filter(p => p.category === categorySlug);
      }
      return data;
    }

    // --- FETCH DATA TỪ SUPABASE ---
    let query = supabase
      .from('projects')
      .select(`
        *,
        portfolio_categories!inner ( name, slug ),
        project_images ( image_url, display_order )
      `)
      .order('display_order', { ascending: true }) 
      .order('created_at', { ascending: false });

    if (categorySlug && categorySlug !== 'all') {
      query = query.eq('portfolio_categories.slug', categorySlug);
    }

    const { data, error } = await query;

    if (error) {
      console.error('Lỗi Supabase:', error);
      return [];
    }

    const projectsRaw = data as unknown as ProjectRow[];

    // 3. Map dữ liệu
    return projectsRaw.map((p) => {
      
      // A. Xử lý nội dung bài viết (Article Body)
      let articleBody: ArticleBlock[] = [];

      // Ưu tiên 1: Lấy từ cột 'content' (Dự án mới tạo bằng Admin Builder)
      if (p.content && Array.isArray(p.content) && p.content.length > 0) {
        articleBody = p.content;
      } 
      // Ưu tiên 2: Fallback cho dự án cũ (Tự tạo từ bảng project_images)
      else {
        const galleryImages = p.project_images
          ?.sort((a, b) => a.display_order - b.display_order)
          .map(img => img.image_url) || [];

        if (galleryImages.length > 0) {
          // Gom ảnh thành các row (mỗi row 2-3 ảnh tùy logic, ở đây để đơn giản là 1 row chứa hết)
          articleBody.push({
            type: 'imageRow',
            images: galleryImages
          });
        } else if (p.description) {
           // Nếu không có ảnh, ít nhất hiện mô tả
           articleBody.push({
             type: 'paragraph',
             content: p.description
           });
        }
      }

      // B. Trả về ProjectData chuẩn
      return {
        id: p.project_id,
        title: p.title,
        client_name: p.client_name || '',
        description: p.description || '',
        category: p.portfolio_categories?.slug || 'uncategorized',
        categoryName: p.portfolio_categories?.name || 'Chưa phân loại',
        image: p.thumbnail_url || '', 
        year: new Date(p.created_at).getFullYear().toString(),
        slug: p.slug,
        colSpan: p.col_span || 1,
        rowSpan: p.row_span || 1,
        isFeatured: p.is_featured || false,
        
        credits: p.credits || [],
        articleBody: articleBody, 
      };
    });

  } catch (error) {
    console.error("Get projects error:", error);
    return [];
  }
}

// Định nghĩa kiểu cho cập nhật layout lưới dự án
export interface ProjectGridUpdate {
  id: number;
  colSpan: number;
  rowSpan: number;
  displayOrder: number;
}

// Cập nhật layout lưới dự án
export async function updatePortfolioLayout(token: string, updates: ProjectGridUpdate[]) {
  try {
    // 1. Tạo Supabase Client với Token của người dùng đang đăng nhập
    // Điều này giúp vượt qua RLS (Row Level Security) một cách hợp lệ
    const supabase = createClient(
      process.env.NEXT_PUBLIC_SUPABASE_URL!,
      process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
      {
        global: {
          headers: {
            Authorization: `Bearer ${token}`,
          },
        },
      }
    );

    console.log(`--> Đang cập nhật layout cho ${updates.length} dự án...`);

    // 2. Thực hiện Update từng dự án (Dùng Promise.all cho nhanh)
    const promises = updates.map(async (project) => {
      const { error } = await supabase
        .from('projects')
        .update({
          col_span: project.colSpan,
          row_span: project.rowSpan,
          display_order: project.displayOrder,
        })
        .eq('project_id', project.id);

      if (error) throw error;
    });

    await Promise.all(promises);

    // 3. Xóa Cache để Frontend cập nhật ngay lập tức
    revalidatePath('/'); 
    revalidatePath('/admin/portfolio-grid');

    return { success: true };
 } catch (error: unknown) {
    // Đảm bảo có dòng này hoặc tương tự
    const msg = error instanceof Error ? error.message : 'Lỗi update layout';
    console.error("Layout update error:", error);
    return { success: false, error: msg };
  }
}

// Lấy chi tiết dự án theo ID
export async function getProjectById(id: number) {
  try {
    const { data, error } = await supabase
      .from('projects')
      .select('*')
      .eq('project_id', id)
      .single();
      
    if (error) throw error;
    return data;
  } catch (error) {
    console.error("Error fetching project:", error);
    return null;
  }
}

// Xóa dự án theo ID
export async function deleteProject(token: string, projectId: number) {
  try {
    const supabase = createClient(
      process.env.NEXT_PUBLIC_SUPABASE_URL!,
      process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
      {
        global: {
          headers: {
            Authorization: `Bearer ${token}`,
          },
        },
      }
    );

    const { error } = await supabase
      .from('projects')
      .delete()
      .eq('project_id', projectId);

    if (error) throw error;

    // Xóa cache để danh sách cập nhật ngay
    revalidatePath('/');
    revalidatePath('/admin/projects');
    revalidatePath('/admin/portfolio-grid');

    return { success: true };
  } catch (error: unknown) {
    console.error("Delete error:", error); 
    return { success: false, error: 'Không thể xóa dự án này.' };
  }
}


export interface StaffUser {
  user_id: number;
  email: string;
  full_name: string;
  role: 'Admin' | 'Staff';
  is_active: boolean;
  created_at: string;
  auth_id: string;
}

// 1. Lấy danh sách nhân viên
export async function getStaffList() {
  try {
    // Dùng client thường (anon) cũng được nếu đã set Policy Public Read
    // Hoặc dùng Service Role để chắc chắn lấy được hết
    const { data, error } = await supabase
      .from('users')
      .select('*')
      .order('created_at', { ascending: false });

    if (error) throw error;
    return data as StaffUser[];
  } catch (error) {
    console.error("Error fetching staff:", error);
    return [];
  }
}

// 2. Đổi trạng thái (Khóa/Mở khóa)
export async function toggleStaffStatus(token: string, userId: number, currentStatus: boolean) {
  try {
    await requireAdmin(token);
    // Cần token của Admin đang đăng nhập để xác thực quyền
    const supabaseClient = createClient(
      process.env.NEXT_PUBLIC_SUPABASE_URL!,
      process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
      { global: { headers: { Authorization: `Bearer ${token}` } } }
    );
    // 1. Lấy thông tin người đang đăng nhập
    const { data: { user: currentUser } } = await supabaseClient.auth.getUser();
    
    // 2. Lấy thông tin người bị khóa (Target)
    const { data: targetUser } = await supabaseClient
      .from('users')
      .select('auth_id')
      .eq('user_id', userId)
      .single();

    // 3. So sánh: Nếu trùng nhau -> Chặn ngay
    if (currentUser && targetUser && currentUser.id === targetUser.auth_id) {
      throw new Error("Bạn không thể tự khóa tài khoản của chính mình.");
    }
    const { error } = await supabaseClient
      .from('users')
      .update({ is_active: !currentStatus })
      .eq('user_id', userId);

    if (error) throw error;
    
    revalidatePath('/admin/staff');
    return { success: true };
  } catch (error: unknown) {
    console.error("Toggle staff error:", error);
    return { success: false, error: 'Không thể thay đổi trạng thái tài khoản này. Chỉ Admin mới có quyền này.' };
  }
}

// 3. Tạo nhân viên mới (Dùng quyền tối cao Service Role)
export async function createStaffAccount(data: { email: string; password: string; fullName: string; role: string }) {
  try {
    // A. Kiểm tra Key
    const serviceKey = process.env.SUPABASE_SERVICE_ROLE_KEY;
    if (!serviceKey) {
      return { success: false, error: "Server chưa cấu hình Service Role Key (Kiểm tra .env.local)" };
    }

    // B. Tạo Client Admin (Bypass mọi RLS)
    const supabaseAdmin = createClient(
      process.env.NEXT_PUBLIC_SUPABASE_URL!,
      serviceKey,
      {
        auth: {
          autoRefreshToken: false,
          persistSession: false
        }
      }
    );

    // C. Tạo User bên hệ thống Auth (Tự động Confirm email)
    const { data: authData, error: authError } = await supabaseAdmin.auth.admin.createUser({
      email: data.email,
      password: data.password,
      email_confirm: true, // Quan trọng: User đăng nhập được ngay không cần check mail
      user_metadata: { full_name: data.fullName }
    });

    if (authError) throw authError;
    if (!authData.user) throw new Error("Không tạo được Auth User");

    // D. Lưu thông tin vào bảng public.users
    const { error: dbError } = await supabaseAdmin
      .from('users')
      .insert({
        email: data.email,
        username: data.email, // Tạm dùng email làm username (unique)
        full_name: data.fullName,
        role: data.role,
        auth_id: authData.user.id, // Link với Auth ID vừa tạo
        is_active: true
      });

    if (dbError) {
      // Nếu lưu DB thất bại -> Xóa luôn user bên Auth để tránh rác data
      console.error("Lỗi lưu DB, đang rollback xóa Auth User...");
      await supabaseAdmin.auth.admin.deleteUser(authData.user.id);
      throw dbError;
    }

    // Refresh lại trang danh sách
    revalidatePath('/admin/staff');
    return { success: true };

  } catch (error: unknown) {
    
    // Xử lý type safe
    let message = 'Lỗi không xác định';
    
    if (error instanceof Error) {
      message = error.message; // Lấy message từ Error object
    } else if (typeof error === 'string') {
      message = error; // Nếu throw "chuỗi"
    }

    // Trả về string cho Client hiển thị
    return { success: false, error: message };
  }
}

// Định nghĩa kiểu dữ liệu UserProfile
export interface UserProfile {
  user_id: number;
  email: string;
  full_name: string;
  role: 'Admin' | 'Staff';
}

// Hàm lấy thông tin người dùng hiện tại (Server-side)
export async function getCurrentUserProfile(): Promise<UserProfile | null> {
  const cookieStore = await cookies();
  
  const supabase = createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        getAll() { return cookieStore.getAll() },
        setAll() {} 
      },
    }
  );

  try {
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) return null;

    const { data: profile } = await supabase
      .from('users')
      .select('user_id, email, full_name, role')
      .eq('auth_id', user.id)
      .single();

    return profile as UserProfile;
  } catch (error) {
    console.error("Lỗi thông tin người dùng hiện tại:", error);
    return null;
  }
}

// --- DASHBOARD STATS ---
// Hàm lấy thống kê Dashboard
// Trả về tổng số dự án, dự án mới trong tháng này, và tổng số nhân sự
// Dùng để hiển thị trên trang Admin Dashboard
export async function getDashboardStats(range: string = '30d') {
  try {
    const startDate = getStartDate(range).toISOString();

    // 1. Tổng dự án (Toàn thời gian - Không đổi theo filter)
    const { count: totalProjects } = await supabase
      .from('projects')
      .select('*', { count: 'exact', head: true });

    // 2. Dự án MỚI (Thay đổi theo filter)
    const { count: newProjects } = await supabase
      .from('projects')
      .select('*', { count: 'exact', head: true })
      .gte('created_at', startDate);

    // 3. Tổng nhân sự
    const { count: totalStaff } = await supabase
      .from('users')
      .select('*', { count: 'exact', head: true });

    return {
      totalProjects: totalProjects || 0,
      newProjects: newProjects || 0, // Số lượng tăng thêm trong khoảng thời gian này
      totalStaff: totalStaff || 0
    };
  } catch (error) {
    console.error("Lỗi lấy thống kê Dashboard:", error);
    return { totalProjects: 0, newProjects: 0, totalStaff: 0 };
  }
}

export interface MonthlyStat {
  name: string; // VD: "Tháng 10"
  total: number;
}

export async function getMonthlyProjectStats() {
  try {
    // 1. Lấy tất cả dự án (Chỉ cần cột created_at)
    // Lưu ý: Nếu data quá lớn (>10k), nên dùng SQL function (RPC). 
    // Với Portfolio < 1000 bài, xử lý JS vẫn siêu nhanh.
    const { data, error } = await supabase
      .from('projects')
      .select('created_at')
      .order('created_at', { ascending: true });

    if (error) throw error;

    // 2. Xử lý dữ liệu: Nhóm theo tháng
    // Tạo mảng 6 tháng gần nhất mặc định là 0
    const statsMap = new Map<string, number>();
    const today = new Date();
    
    for (let i = 5; i >= 0; i--) {
      const d = new Date(today.getFullYear(), today.getMonth() - i, 1);
      // Format tên tháng tiếng Việt (VD: T1, T2...)
      const monthName = `T${d.getMonth() + 1}`;
      statsMap.set(monthName, 0);
    }

    // Đếm số lượng
    data?.forEach((p) => {
      const date = new Date(p.created_at);
      const monthName = `T${date.getMonth() + 1}`;
      // Chỉ đếm nếu tháng đó nằm trong danh sách 6 tháng gần nhất
      if (statsMap.has(monthName)) {
        statsMap.set(monthName, (statsMap.get(monthName) || 0) + 1);
      }
    });

    // Chuyển Map thành Array cho Recharts
    const result: MonthlyStat[] = Array.from(statsMap, ([name, total]) => ({ name, total }));
    
    return result;

  } catch (error) {
    console.error("Lỗi lấy thống kê tháng:", error);
    return [];
  }
}

// Hàm tính ngày bắt đầu dựa trên range (VD: '7d', '30d')
function getStartDate(range: string) {
  const now = new Date();
  if (range === '7d') return new Date(now.setDate(now.getDate() - 7));
  if (range === '30d') return new Date(now.setDate(now.getDate() - 30));
  if (range === '90d') return new Date(now.setDate(now.getDate() - 90));
  if (range === '12m') return new Date(now.setFullYear(now.getFullYear() - 1));
  return new Date(0); // 'all' -> Từ năm 1970
}
// Logic Biểu đồ linh hoạt (Ngày/Tháng)
export async function getGrowthChartData(range: string = '30d') {
  try {
    const startDate = getStartDate(range);
    
    // Lấy dữ liệu trong khoảng thời gian
    const { data } = await supabase
      .from('projects')
      .select('created_at')
      .gte('created_at', startDate.toISOString())
      .order('created_at', { ascending: true });

    if (!data) return [];

    // Xử lý nhóm dữ liệu
    // Nếu range ngắn (7d, 30d) -> Nhóm theo NGÀY
    // Nếu range dài (90d, 12m) -> Nhóm theo THÁNG
    const isDaily = range === '7d' || range === '30d';
    const statsMap = new Map<string, number>();

    // Khởi tạo trục X cho đẹp (tránh bị đứt đoạn)
    // (Logic này hơi dài dòng để viết ở đây, nên ta làm đơn giản: Nhóm theo data thực có)
    
    data.forEach((p) => {
      const date = new Date(p.created_at);
      let key = '';
      
      if (isDaily) {
        // Format: "DD/MM" (VD: 05/10)
        key = `${date.getDate()}/${date.getMonth() + 1}`;
      } else {
        // Format: "Tháng MM" (VD: T10)
        key = `T${date.getMonth() + 1}`;
      }

      statsMap.set(key, (statsMap.get(key) || 0) + 1);
    });

    return Array.from(statsMap, ([name, total]) => ({ name, total }));

  } catch (error) {
    console.error("Lỗi lấy dữ liệu biểu đồ tăng trưởng:", error);
    return [];
  }
}
```

## File: src/app/admin/layout.tsx
```typescript
// src/app/admin/layout.tsx
'use client';

import React, { useState, useEffect, useRef, useCallback } from 'react';
import Link from 'next/link';
import { usePathname, useRouter } from 'next/navigation';
import { createBrowserClient } from '@supabase/ssr';
import { toast } from 'sonner';
import { 
  LayoutDashboard, 
  Image as ImageIcon, 
  Settings, 
  LogOut, 
  Users,
  Menu,
  X,
  Home,
  Clock,
  LayoutTemplate 
} from 'lucide-react';
import ThemeToggle from '@/components/ThemeToggle';
import localFont from 'next/font/local'; 
import ConfirmModal from '@/components/ui/ConfirmModal';
import { getCurrentUserProfile } from '@/lib/actions';
import { getRooms, type RoomWithBranch } from '@/lib/actions/studio'; 
import NavCalendarWidget from '@/components/admin/calendar/NavCalendarWidget';
import { CalendarProvider } from '@/context/CalendarContext';

const logoFont = localFont({
  src: '../../fonts/cameliya-regular.ttf',
  display: 'swap',
  variable: '--font-logo',
});

interface NavLinkProps {
  href: string;
  icon: React.ReactNode;
  label: string;
  isActive?: boolean;
  onClick?: () => void;
}
// Type cho thông tin user hiển thị
interface UserProfile {
  full_name: string;
  role: string;
  email: string;
}
// Giá trị mặc định nếu chưa cấu hình trong DB
const DEFAULT_TIMEOUT = 60; 

export default function AdminLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  const router = useRouter();
  const pathname = usePathname();
  const [showModal, setShowModal] = useState(false); 
  // Supabase Client
  const [supabase] = useState(() => createBrowserClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
  ));
  // State quản lý menu mobile
  const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);
  const [isCheckingAuth, setIsCheckingAuth] = useState(true);
  const [timeLeft, setTimeLeft] = useState<string>('--:--:--');

  // State lưu thời gian timeout thực tế (Lấy từ DB)
  const [idleTimeoutMinutes, setIdleTimeoutMinutes] = useState(DEFAULT_TIMEOUT);

  // Ref lưu thời điểm hoạt động cuối cùng
  const lastActivityRef = useRef<number>(Date.now());
  
  // Ref lưu giá trị timeout để dùng trong setInterval mà không cần restart interval
  const timeoutRef = useRef(idleTimeoutMinutes);

  // --- THÊM LOGIC LẤY DANH SÁCH PHÒNG ---
  const [rooms, setRooms] = useState<RoomWithBranch[]>([]);

  useEffect(() => {
    // Fetch phòng để hiển thị trong Sidebar Calendar Widget
    const fetchRooms = async () => {
      try {
        const data = await getRooms();
        setRooms(data);
      } catch (error) {
        console.error("Lỗi lấy danh sách phòng:", error);
      }
    };
    fetchRooms();
  }, []); // Chỉ chạy 1 lần khi mount

  // State lưu thông tin user
  const [userProfile, setUserProfile] = useState<UserProfile | null>(null);
  // --- 1. ĐỒNG BỘ REF VỚI STATE ---
  useEffect(() => {
    timeoutRef.current = idleTimeoutMinutes;
  }, [idleTimeoutMinutes]);

// --- 2. LẤY CẤU HÌNH TỪ DATABASE (CÓ LẮNG NGHE SỰ KIỆN) ---
  useEffect(() => {
    // Hàm lấy dữ liệu (Tách ra để tái sử dụng)
    const fetchSettings = async () => {
      try {
        const { data } = await supabase
          .from('settings')
          .select('value')
          .eq('key', 'idle_timeout_minutes')
          .single();
        
        if (data?.value) {
          const dbValue = parseInt(data.value);
          if (!isNaN(dbValue) && dbValue > 0) {
            setIdleTimeoutMinutes(dbValue);
            // Cập nhật luôn vào ref để timer nhận ngay lập tức mà không đợi vòng lặp sau
            timeoutRef.current = dbValue; 
          }
        }
      } catch (error) {
        console.error("Lỗi fetch setting:", error);
      }
    };

    // Gọi lần đầu khi load trang
    fetchSettings();

    // Lắng nghe sự kiện 'settings:updated' từ trang SettingsForm
    const handleSettingsUpdate = () => {
      console.log("Phát hiện thay đổi cài đặt -> Cập nhật lại Layout...");
      fetchSettings();
    };

    window.addEventListener('settings:updated', handleSettingsUpdate);

    // Dọn dẹp khi component unmount
    return () => {
      window.removeEventListener('settings:updated', handleSettingsUpdate);
    };
  }, [supabase]);
  // --- 3. HÀM GHI NHẬN HOẠT ĐỘNG ---
  const resetTimer = useCallback(() => {
    lastActivityRef.current = Date.now();
  }, []);

  // --- 4. LOGIC CHÍNH (CHECK AUTH & TIMER) ---
  useEffect(() => {
    let intervalId: NodeJS.Timeout;

    const setupActivityListeners = () => {
      window.addEventListener('mousemove', resetTimer);
      window.addEventListener('keydown', resetTimer);
      window.addEventListener('click', resetTimer);
      window.addEventListener('scroll', resetTimer);
      window.addEventListener('touchstart', resetTimer);
    };

    const cleanupActivityListeners = () => {
      window.removeEventListener('mousemove', resetTimer);
      window.removeEventListener('keydown', resetTimer);
      window.removeEventListener('click', resetTimer);
      window.removeEventListener('scroll', resetTimer);
      window.removeEventListener('touchstart', resetTimer);
    };

    const checkAuthAndStartTimer = async () => {
      try {
        // 1. Lấy Session Auth
        const { data: { session } } = await supabase.auth.getSession();
        
        if (!session) {
          router.replace('/login');
          return;
        }

        // 2. (MỚI) Lấy thông tin chi tiết từ bảng public.users
        // Dùng auth_id (uid) để đối chiếu
        const profile = await getCurrentUserProfile();

        if (profile) {
          setUserProfile(profile);
        } else {
          // Fallback chỉ khi không tìm thấy profile trong DB
          setUserProfile({
            full_name: session.user.email?.split('@')[0] || 'Admin',
            role: 'Staff', // Mặc định an toàn là Staff nếu lỗi
            email: session.user.email || ''
          });
        }
        // 3. Khởi động Timer
        setupActivityListeners();
        setIsCheckingAuth(false);

        intervalId = setInterval(() => {
          const now = Date.now();
          const timeSinceLastActivity = now - lastActivityRef.current;
          const currentTimeoutMs = timeoutRef.current * 60 * 1000; 
          const timeRemaining = currentTimeoutMs - timeSinceLastActivity;

          if (timeRemaining <= 0) {
            clearInterval(intervalId);
            cleanupActivityListeners();
            supabase.auth.signOut().then(() => {
              toast.warning(`Đã đăng xuất do không hoạt động quá ${timeoutRef.current} phút.`);
              router.replace('/login');
            });
            return;
          }

          const h = Math.floor(timeRemaining / (1000 * 60 * 60));
          const m = Math.floor((timeRemaining % (1000 * 60 * 60)) / (1000 * 60));
          const s = Math.floor((timeRemaining % (1000 * 60)) / 1000);
          
          setTimeLeft(`${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`);
          
        }, 1000);

      } catch (error) {
        console.error("Auth error:", error);
        router.replace('/login');
      }
    };

    checkAuthAndStartTimer();

    return () => {
      if (intervalId) clearInterval(intervalId);
      cleanupActivityListeners();
    };
  }, [router, supabase, resetTimer]);

  const handleLogout = async () => {
    try {
      await supabase.auth.signOut();
      toast.success("Đăng xuất thành công!!");
      router.replace('/login');
      router.refresh();
    } catch (error) {
      const msg = (error as Error)?.message || "Lỗi không xác định";
      toast.error(msg);
    }
  };

  const handleLinkClick = () => setIsMobileMenuOpen(false);
  // Helper lấy chữ cái đầu
  const getInitials = (name?: string) => {
    return name ? name.charAt(0).toUpperCase() : 'A';
  };
  if (isCheckingAuth) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-[var(--admin-bg)]">
        <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-[var(--admin-primary)]"></div>
      </div>
    );
  }

  return (
    <CalendarProvider>
      <div className="flex min-h-screen bg-[var(--admin-bg)] text-[var(--admin-fg)] transition-colors duration-300 font-sans">
        {isMobileMenuOpen && (
          <div className="fixed inset-0 bg-black/60 z-40 md:hidden backdrop-blur-sm" onClick={() => setIsMobileMenuOpen(false)} />
        )}

        <aside className={`fixed top-0 left-0 z-50 h-full w-64 bg-[var(--admin-card)] border-r border-[var(--admin-border)] transform transition-transform duration-300 ease-in-out shadow-xl md:shadow-none ${isMobileMenuOpen ? 'translate-x-0' : '-translate-x-full'} md:translate-x-0 md:static md:flex md:flex-col`}>
          <div className="h-16 flex items-center justify-between px-6 border-b border-[var(--admin-border)]">
            <div className="flex items-center gap-2">
              <div className={`w-8 h-8 bg-[var(--admin-primary)] rounded-lg flex items-center justify-center text-[var(--admin-primary-fg)] font-bold ${logoFont.className}`}>O</div>
              <span className={`${logoFont.variable} text-xl font-bold tracking-widest text-[var(--admin-fg)] ${logoFont.className}`}>Oni Admin</span>
            </div>
            <button onClick={() => setIsMobileMenuOpen(false)} className="md:hidden text-[var(--admin-sub)]"><X size={24} /></button>
          </div>

          <nav className="flex-1 p-4 space-y-1 overflow-y-auto no-scrollbar">
            <div className="text-xs font-bold text-[var(--admin-sub)] uppercase tracking-wider mb-3 px-4 mt-2">Studio</div>
            <NavLink href="/admin" title="Đi tới trang Tổng quan" icon={<LayoutDashboard size={20} />} label="Tổng quan" isActive={pathname === '/admin'} onClick={handleLinkClick} />
            <NavCalendarWidget rooms={rooms} />
            <NavLink href="/admin/projects" title="Quản lý dự án" icon={<ImageIcon size={20} />} label="Dự án" isActive={pathname === '/admin/projects' || pathname === '/admin/projects/new' || pathname.startsWith('/admin/projects/')} onClick={handleLinkClick} />
            <NavLink href="/admin/grid" title="Bố cục Portfolio" icon={<LayoutTemplate size={20} />} label="Bố cục Portfolio" isActive={pathname.startsWith('/admin/grid')} onClick={handleLinkClick} />
            {userProfile?.role === 'Admin' && (
              <>
                <NavLink href="/admin/staff" title="Quản lý nhân sự" icon={<Users size={20} />} label="Nhân sự" isActive={pathname.startsWith('/admin/staff')} onClick={handleLinkClick} />
              </>
            )}
          </nav>

          <div className="p-4 border-t border-[var(--admin-border)] space-y-2">
            {userProfile?.role === 'Admin' && (
              <>
                <div className="text-xs font-bold text-[var(--admin-sub)] uppercase tracking-wider mt-8 mb-3 px-4">Hệ thống</div>
                <NavLink href="/admin/settings" title="Cài đặt chung" icon={<Settings size={20} />} label="Cài đặt chung" isActive={pathname.startsWith('/admin/settings')} onClick={handleLinkClick} />
              </>
            )}
            <Link href="/" className="flex items-center gap-3 px-4 py-3 w-full text-sm font-medium text-[var(--admin-sub)] hover:bg-[var(--admin-bg)] hover:text-[var(--admin-fg)] rounded-lg transition-colors"><Home size={20} /> Xem Website</Link>
            <button onClick={() => setShowModal(true)} className="flex cursor-pointer items-center gap-3 px-4 py-3 w-full text-left text-sm font-medium text-red-500 hover:bg-red-500/10 rounded-lg transition-colors"><LogOut size={20} /> Đăng xuất</button>
          </div>
        </aside>

        <div className="flex-1 flex flex-col min-w-0 overflow-hidden">
          <header className="h-16 bg-[var(--admin-card)]/80 backdrop-blur-md border-b border-[var(--admin-border)] flex items-center justify-between px-4 md:px-8 sticky top-0 z-30">
            <div className="flex items-center gap-4">
              <button onClick={() => setIsMobileMenuOpen(true)} className="md:hidden p-2 -ml-2 text-[var(--admin-sub)] rounded-lg"><Menu size={24} /></button>
              <h1 className="font-semibold text-lg text-[var(--admin-fg)] hidden sm:block">{getPageTitle(pathname)}</h1>
            </div>

            <div className="flex items-center gap-3 md:gap-4">
              <div className="hidden sm:flex items-center gap-2 px-3 py-1.5 bg-[var(--admin-bg)] border border-[var(--admin-border)] rounded-full text-xs font-mono font-medium text-[var(--admin-sub)]" title="Tự động đăng xuất nếu không hoạt động">
                <Clock size={14} className="text-[var(--admin-primary)] animate-pulse" />
                <span>{timeLeft}</span>
              </div>
              <div className="h-6 w-px bg-[var(--admin-border)] hidden sm:block"></div>
              <ThemeToggle isAdmin={true}/>
              <div className="flex items-center gap-3 pl-2">
                  <div className="hidden md:block text-sm text-right">
                    <p className="font-medium text-[var(--admin-fg)] leading-tight">
                      {userProfile?.full_name || 'Đang tải...'}
                    </p>
                    <p className="text-[10px] text-[var(--admin-sub)] uppercase tracking-wider">
                      {userProfile?.role || '...'}
                    </p>
                  </div>
                  <div className="h-9 w-9 rounded-full bg-gradient-to-br from-[var(--admin-primary)] to-purple-600 border-2 border-[var(--admin-card)] shadow-sm flex items-center justify-center text-white font-bold text-xs">
                    {getInitials(userProfile?.full_name)}
                  </div>
                </div>
            </div>
          </header>

          <main className="flex-1 p-4 md:p-8 overflow-auto table-scrollbar">
            <ConfirmModal isOpen={showModal} onClose={() => setShowModal(false)} onConfirm={handleLogout} title="Đăng xuất?" description="Bạn có chắc chắn muốn đăng xuất?" confirmText="Đăng xuất" cancelText="Hủy bỏ" variant="danger" />
            <div className="mx-auto max-w-7xl animate-fade-in-up">{children}</div>
          </main>
        </div>
      </div>
    </CalendarProvider>
  );
}

function NavLink({ href, icon, label, isActive, onClick, title }: NavLinkProps & { title?: string }) {
  return (
    <Link href={href} onClick={onClick} title={title} className={`flex items-center gap-3 px-4 py-2.5 text-sm font-medium rounded-lg transition-all duration-200 mb-1 ${isActive ? 'bg-[var(--admin-bg)] text-[var(--admin-primary)] shadow-md shadow-gray-500/20' : 'text-[var(--admin-sub)] hover:bg-[var(--admin-hover)] hover:text-[var(--admin-fg)]'}`}>{icon}{label}</Link>
  );
}

function getPageTitle(pathname: string) {
  if (pathname === '/admin') return 'Bảng tổng quan';
  if (pathname.startsWith('/admin/grid')) return 'Bố cục Portfolio';
  if (pathname.startsWith('/admin/projects')) return 'Quản lý Dự án';
  if (pathname.startsWith('/admin/staff')) return 'Nhân sự';
  if (pathname.startsWith('/admin/settings')) return 'Cài đặt hệ thống';
  return 'Bảng điều khiển';
}
```

## File: src/app/ca-nhan/page.tsx
```typescript
import React from 'react';
import { getProjects } from '@/lib/actions';
import { Metadata } from 'next';
import Container from '@/components/Container';
import ProjectMasonryGrid from '@/components/ProjectMasonryGrid';

// Metadata cho SEO
export const metadata: Metadata = {
  title: 'Dự án Cá nhân | Oni Studio',
  description: 'Những dự án thể hiện cái tôi cá nhân và thử nghiệm sáng tạo.',
};
export const revalidate = 3600; // 1 hour
export default async function PersonalPage() {
  // 1. Gọi dữ liệu thật từ Supabase (hoặc Demo)
  const projects = await getProjects('ca-nhan'); // <-- Slug của danh mục

  return (
    <Container className="min-h-screen bg-[var(--background)] pt-32 pb-20 px-4 md:px-8">
      <div className="max-w-8xl mx-auto">
        
        {/* Header */}
        <div className="mb-16">
          <h1 className="text-4xl md:text-6xl font-bold text-[var(--foreground)] tracking-tighter mb-4">
            Cá nhân
          </h1>
          <p className="text-[var(--sub-text)] text-lg max-w-xl">
            Những thử nghiệm, cảm hứng và góc nhìn riêng.
          </p>
        </div>

        {/* Empty State */}
        {projects.length === 0 && (
          <div className="py-20 text-center text-[var(--sub-text)] border-y border-[var(--foreground)]/10">
            Chưa có dự án nào trong danh mục này.
          </div>
        )}

        {/* Project Grid */}
        <ProjectMasonryGrid projects={projects} variant="cascade" />
      </div>
    </Container>
  );
}
```

## File: src/components/ProjectShowcase.tsx
```typescript
// src/components/ProjectShowcase.tsx
'use client';

import React, { useEffect, useState } from 'react';
import Image from 'next/image';
import Link from 'next/link';
import { motion } from 'framer-motion';
import { ArrowRight } from 'lucide-react';
import { getProjects } from '@/lib/actions';
import { ProjectData } from '@/data/projects-master-data';

// --- Component Con: ProjectItem ---
function ProjectItem({ project, index }: { project: ProjectData; index: number }) {
  const isImageRight = index % 2 !== 0;

  return (
    <motion.div 
      initial={{ opacity: 0, y: 50 }}
      whileInView={{ opacity: 1, y: 0 }}
      transition={{ duration: 0.8, ease: "easeOut" }}
      viewport={{ once: true, margin: "-100px" }}
      className={`flex flex-col md:flex-row items-center gap-8 md:gap-16 mb-24 md:mb-32 ${
        isImageRight ? 'md:flex-row-reverse' : ''
      }`}
    >
      {/* Image Side */}
      <div className="w-full md:w-3/5 relative group cursor-pointer overflow-hidden rounded-lg shadow-2xl">
        <Link href={`/du-an/${project.slug}`}>
          <div className="relative aspect-[16/9] w-full overflow-hidden">
            <Image
              src={typeof project.image === 'string' ? project.image : project.image.src}
              alt={project.title}
              fill
              className="object-cover transition-transform duration-700 group-hover:scale-105"
              sizes="(max-width: 768px) 100vw, 60vw"
            />
            <div className="absolute inset-0 bg-black/20 group-hover:bg-transparent transition-colors duration-500" />
            
            {/* Badge Danh mục nổi bật */}
            <div className="absolute top-4 left-4 bg-white/90 dark:bg-black/80 backdrop-blur px-3 py-1 text-xs font-bold uppercase tracking-wider text-[var(--foreground)] rounded">
              {project.categoryName}
            </div>
          </div>
        </Link>
      </div>

      {/* Text Side */}
      <div className="w-full md:w-2/5 text-center md:text-left space-y-6">
        <span className="inline-block text-xs font-bold tracking-[0.2em] text-[var(--sub-text)] uppercase border-b border-[var(--glow-color)] pb-1">
          Dự án {project.categoryName} mới
        </span>
        
        <h3 className="text-3xl md:text-5xl font-bold text-[var(--foreground)] leading-tight">
          <Link href={`/du-an/${project.slug}`} className="hover:text-[var(--sub-text)] transition-colors">
            {project.title}
          </Link>
        </h3>

        {project.description && (
          <p className="text-[var(--sub-text)] text-lg font-light leading-relaxed line-clamp-3">
            {project.description}
          </p>
        )}
        {project.credits && project.credits.length > 0 && (
          <ul className="mt-5 space-y-2 text-sm text-[var(--sub-text)] border-l border-[var(--foreground)]/20 pl-4 text-left">
            {project.credits.slice(0, 3).map((credit, idx) => (
              <li key={idx}>
                <strong className="font-semibold text-[var(--foreground)]">
                  {credit.label}:
                </strong> {credit.value}
              </li>
            ))}
          </ul>
        )}
        <div className="pt-4">
          <Link 
            href={`/du-an/${project.slug}`}
            className="inline-flex items-center gap-2 text-sm font-medium uppercase tracking-wider text-[var(--foreground)] hover:gap-4 transition-all duration-300 group/link"
          >
            Xem dự án <ArrowRight size={16} className="transition-transform group-hover/link:translate-x-1" />
          </Link>
        </div>
      </div>
    </motion.div>
  );
}

// --- Component Chính ---
export default function ProjectShowcase() {
  const [showcaseProjects, setShowcaseProjects] = useState<ProjectData[]>([]);
  const [isLoading, setIsLoading] = useState(true);

  useEffect(() => {
    const fetchAndFilter = async () => {
      try {
        const all = await getProjects();
        
        // 1. Lấy tất cả dự án Featured
        const allFeatured = all.filter(p => p.isFeatured);

        // 2. Lọc: Mỗi danh mục chỉ lấy 1 đại diện MỚI NHẤT
        // Danh sách các category slug cần lấy
        const targetCategories = ['thoi-trang', 'thuong-mai', 'ca-nhan'];
        
        const uniqueFeatured: ProjectData[] = [];

        targetCategories.forEach(catSlug => {
          // Tìm dự án Featured mới nhất của danh mục này
          const bestProject = allFeatured.find(p => p.category === catSlug);
          if (bestProject) {
            uniqueFeatured.push(bestProject);
          }
        });

        // Nếu thiếu (ví dụ chưa có dự án Cá nhân nào Featured), có thể lấy bù từ danh sách chung
        // (Ở đây mình giữ logic chặt: Không có thì không hiện)
        
        setShowcaseProjects(uniqueFeatured);
      } catch (error) {
        console.error("Lỗi tải showcase:", error);
      } finally {
        setIsLoading(false);
      }
    };

    fetchAndFilter();
  }, []);

  if (isLoading || showcaseProjects.length === 0) return null;

  return (
    <div className="max-w-8xl mx-auto px-4 md:px-8 py-20 border-t border-[var(--foreground)]/10">
      {showcaseProjects.map((project, index) => (
        <ProjectItem key={project.id} project={project} index={index} />
      ))}
    </div>
  );
}
```

## File: src/app/thoi-trang/page.tsx
```typescript
import React from 'react';
import { getProjects } from '@/lib/actions';
import { Metadata } from 'next';
import Container from '@/components/Container';
import ProjectMasonryGrid from '@/components/ProjectMasonryGrid';

export const metadata: Metadata = {
  title: 'Dự án Thời Trang | Oni Studio',
  description: 'Các dự án editorial, lookbook và nhiếp ảnh thời trang.',
};

export const revalidate = 3600; // 1 hour
export default async function FashionPage() {
  const projects = await getProjects('thoi-trang'); // <-- Slug của danh mục

  return (
    <Container className="min-h-screen bg-[var(--background)] pt-32 pb-20 px-4 md:px-8">
      <div className="max-w-8xl mx-auto">
        
        <div className="mb-16">
          <h1 className="text-4xl md:text-6xl font-bold text-[var(--foreground)] tracking-tighter mb-4">
            Thời Trang
          </h1>
          <p className="text-[var(--sub-text)] text-lg max-w-xl">
            Khám phá các dự án thời trang, lookbook và editorial.
          </p>
        </div>

        {projects.length === 0 && (
          <div className="py-20 text-center text-[var(--sub-text)] border-y border-[var(--foreground)]/10">
            Chưa có dự án nào trong danh mục này.
          </div>
        )}

      <ProjectMasonryGrid projects={projects} variant="staggered" />

      </div>
    </Container>
  );
}
```

## File: src/app/thuong-mai/page.tsx
```typescript
import React from 'react';
import { getProjects } from '@/lib/actions';
import { Metadata } from 'next';
import Container from '@/components/Container';
import ProjectMasonryGrid from '@/components/ProjectMasonryGrid';

export const metadata: Metadata = {
  title: 'Dự án Thương mại | Oni Studio',
  description: 'Các dự án Commercial, Editorial và Lookbook thực hiện bởi Oni Studio.',
};
export const revalidate = 3600; // 1 hour
export default async function CommercialPage() {
  const projects = await getProjects('thuong-mai'); // <-- Slug của danh mục

  return (
    <Container className="min-h-screen bg-[var(--background)] pt-32 pb-20 px-4 md:px-8">
      <div className="max-w-8xl mx-auto">
        
        <div className="mb-16">
          <h1 className="text-4xl md:text-6xl font-bold text-[var(--foreground)] tracking-tighter mb-4">
            Thương mại
          </h1>
          <p className="text-[var(--sub-text)] text-lg max-w-xl">
            Những chiến dịch quảng cáo và bộ ảnh thương mại được thực hiện với sự chỉn chu và sáng tạo.
          </p>
        </div>

        {projects.length === 0 && (
          <div className="py-20 text-center text-[var(--sub-text)] border-y border-[var(--foreground)]/10">
            Chưa có dự án nào trong danh mục này.
          </div>
        )}

        {/* Project Grid */}
        <ProjectMasonryGrid projects={projects} variant="flat" />
      </div>
    </Container>
  );
}
```

## File: src/app/page.tsx
```typescript
// src/app/page.tsx

import type { Metadata } from 'next';
import HomePageContent from '@/components/HomePageContent';
export const revalidate = 3600; // 1 hour
export const metadata: Metadata = {
  title: 'Oni Studio',
  description: 'Oni Studio - Chuyên cung cấp dịch vụ nhiếp ảnh thương mại, thời trang, và cá nhân chuyên nghiệp. Khám phá portfolio và liên hệ để hợp tác.',
  keywords: ['nhiếp ảnh gia', 'photographer', 'commercial photography', 'fashion photography', 'Oni Studio'],

  openGraph: {
    title: 'Oni Studio',
    description: 'Khám phá portfolio ảnh thương mại, thời trang, và cá nhân từ Oni Studio.',
    url: 'https://www.your-domain.com', 
    siteName: 'Oni Studio',
    images: [
      {
        url: 'https://www.your-domain.com/og-image.png', 
        width: 1200,
        height: 630,
      },
    ],
    locale: 'vi_VN',
    type: 'website',
  },

  twitter: {
    card: 'summary_large_image',
    title: 'Oni Studio | Nhiếp ảnh Thương mại & Thời trang Chuyên nghiệp',
    description: 'Khám phá portfolio ảnh thương mại, thời trang, và cá nhân từ Oni Studio.',
    images: ['https://www.your-domain.com/twitter-image.png'], 
  },
};

export default function HomePage() {
  return (
    <HomePageContent />
  );
}
```

## File: package.json
```json
{
  "name": "photographer-portfolio",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "eslint",
    "deploy": "cross-env NEXT_PUBLIC_IS_GH_PAGES=true next build"
  },
  "dependencies": {
    "@dnd-kit/core": "^6.3.1",
    "@dnd-kit/sortable": "^10.0.0",
    "@dnd-kit/utilities": "^3.2.2",
    "@supabase/ssr": "^0.7.0",
    "@supabase/supabase-js": "^2.81.1",
    "clsx": "^2.1.1",
    "date-fns": "^4.1.0",
    "lucide-react": "^0.554.0",
    "moment": "^2.30.1",
    "motion": "^12.23.24",
    "next": "15.5.4",
    "next-themes": "^0.4.6",
    "react": "19.1.0",
    "react-big-calendar": "^1.19.4",
    "react-dom": "19.1.0",
    "react-intersection-observer": "^9.16.0",
    "react-type-animation": "^3.2.0",
    "recharts": "^3.5.0",
    "sonner": "^2.0.7",
    "tailwind-merge": "^3.3.1",
    "yet-another-react-lightbox": "^3.25.0"
  },
  "devDependencies": {
    "@eslint/eslintrc": "^3",
    "@tailwindcss/postcss": "^4",
    "@types/node": "^20",
    "@types/react": "^19",
    "@types/react-big-calendar": "^1.16.3",
    "@types/react-dom": "^19",
    "cross-env": "^10.1.0",
    "eslint": "^9",
    "eslint-config-next": "15.5.4",
    "gh-pages": "^6.3.0",
    "tailwindcss": "^4",
    "typescript": "^5"
  }
}
```

## File: src/app/globals.css
```css
@import "tailwindcss";
@import "yet-another-react-lightbox/styles.css";
@import "yet-another-react-lightbox/plugins/captions.css";
@import "yet-another-react-lightbox/plugins/thumbnails.css";
/* src/app/globals.css */

:root {
  /* Chuyển từ hex sang các giá trị RGB (không có 'rgb()' ) */
  --background: #f4f4f4;
  --foreground: #171717;
  --sub-text: #555555;
  --glow-color: #aa9f9f;
  --gradient-color-1: #f9fafb; /* gray-50 */
  --gradient-color-2: #f3f4f6; /* gray-100 */
  --gradient-color-3: #f9fafb; /* gray-50 */
  --to-linear: #dadada;
  --from-linear: #ebebeb;

  /* === ADMIN THEME (LIGHT MODE - Modern Slate) === */
  --admin-bg: #f8fafc;          /* Slate-50: Nền tổng thể sáng, hơi xanh nhẹ */
  --admin-card: #ffffff;        /* White: Nền thẻ */
  --admin-fg: #0f172a;          /* Slate-900: Chữ chính đậm */
  --admin-sub: #64748b;         /* Slate-500: Chữ phụ */
  --admin-border: #e2e8f0;      /* Slate-200: Viền nhạt */
  --admin-primary: #4f46e5;     /* Indigo-600: Màu chủ đạo (Button/Active) */
  --admin-primary-fg: #ffffff;  /* Chữ trên nền chủ đạo */
  --admin-hover: #f1f5f9;       /* Slate-100: Màu khi hover */
  --admin-edit: #EBF6FF;        /* bg-blue-50: Màu nền ô edit */
  --admin-delete: #FFE5E5;      /* bg-red-50: Màu nền ô xóa */
  --admin-ot: #f97316;       /* Orange-500 */
  --admin-ot-bg: #fff7ed;    /* Orange-50 */
  --admin-ot-border: #fdba74;/* Orange-300 */
  --status-checked-in: #22c55e; /* Green-500 */
  --status-completed: #64748b
}

html.dark { 
    /* --- MÀU CƠ BẢN --- */
    --background: #1E201E; /* Màu nền chính (Màu 1) */
    --foreground: #ECDFCC; /* Màu chữ chính (Màu 4) - Tương phản tốt trên nền tối */
    --sub-text: #9CA3AF;   /* Màu chữ phụ: Pha giữa Sage và Beige để dễ đọc hơn màu #697565 gốc */
    
    /* Hiệu ứng Glow/Shadow: Dùng màu Sage Green nhưng tối hơn */
    --glow-color: #697565; 

    /* Gradient: Chuyển từ nền chính sang nền thẻ */
    --gradient-color-1: #1E201E; 
    --gradient-color-2: #2D2E2B; /* Màu trung gian pha giữa Màu 1 và 2 */
    --gradient-color-3: #3C3D37; 
    
    --to-linear: #1E201E;
    --from-linear: #3C3D37;

    /* --- ADMIN DASHBOARD --- */

    /* Nền tổng thể của trang Admin */
    --admin-bg: #1E201E; 

    /* Nền của các khối/thẻ (Card) */
    --admin-card: #3C3D37; /* (Màu 2) */

    /* Màu chữ chính trong Admin */
    --admin-fg: #ECDFCC; /* (Màu 4) */

    /* Màu chữ phụ/Label/Icon ít quan trọng */
    --admin-sub: #AAB3A6; /* Phiên bản sáng hơn của #697565 để đảm bảo đọc được trên nền #3C3D37 */

    /* Viền ngăn cách: Dùng màu Sage Green gốc */
    --admin-border: #697565; /* (Màu 3) */

    /* Hiệu ứng Hover: Sáng hơn nền thẻ một chút */
    --admin-hover: #4B4C46; 

    /* --- NÚT BẤM CHÍNH (PRIMARY) --- */
    /* Dùng màu Beige sáng nhất để làm nút nổi bật trên nền tối */
    --admin-primary: #ECDFCC; 
    --admin-primary-fg: #1E201E; /* Chữ trên nút phải là màu tối nhất để dễ đọc */

    /* --- CÁC TRẠNG THÁI (STATUS / ACTIONS) --- */
    /* Điều chỉnh các màu này trầm xuống (desaturated) để hợp với theme Earth Tone */

    /* Nút Edit: Màu xanh đá (Slate/Teal) trầm */
    --admin-edit: #3A4A45;  

    /* Nút Delete: Màu đỏ gạch/đỏ đất (Brick Red) thay vì đỏ tươi */
    --admin-delete: #5C2B2B;  

    /* OT / Warning: Màu cam đất (Ochre/Burnt Orange) */
    --admin-ot: #D98E53;       /* Màu chữ/icon OT */
    --admin-ot-bg: #2C2520;    /* Nền thẻ OT (pha cam vào nền đen) */
    --admin-ot-border: #8C5E35; /* Viền thẻ OT */

    /* Status Checked-in: Dùng chính màu Sage Green của palette nhưng tươi hơn xíu */
    --status-checked-in: #84A98C; 

    /* Status Completed: Màu xám ấm */
    --status-completed: #8E8E86; 
}

html, body {
  height: 100%;
  margin: 0;
  padding: 0;
  background: var(--background);
  font-family: Arial, Helvetica, sans-serif;
  scroll-behavior: smooth;
}

/* MAIN WRAPPER */
main {
  width: 100%;
  /* overflow-x: hidden; */
}

/* FOOTER */
footer {
  will-change: opacity, transform;
}

/* KEYFRAMES CHO HIỆU ỨNG */
@keyframes ken-burns {
  0% {
    transform: scale(1) translate(0, 0);
    filter: brightness(1);
  }
  100% {
    transform: scale(1.1) translate(-1%, 1%);
    filter: brightness(0.95);
  }
}

@keyframes fade-in-up {
  0% {
    opacity: 0;
    transform: translateY(20px);
  }
  100% {
    opacity: 1;
    transform: translateY(0);
  }
}

/* CLASS TIỆN ÍCH */
.ken-burns-effect {
  /* Hiệu ứng chạy trong 25 giây, lặp lại vô hạn và luân phiên */
  animation: ken-burns 25s ease-in-out infinite alternate;
}

.animate-fade-in-up {
  /* Hiệu ứng xuất hiện trong 1.2 giây, có độ trễ 0.3 giây */
  animation: fade-in-up 1.2s ease-out 0.3s forwards;
  opacity: 0; /* Trạng thái ban đầu trước khi animation bắt đầu */
}

.text-shadow-md {
  text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
}


.menu-link-glow {
  transition: text-shadow 0.3s ease-out;
  will-change: text-shadow;
  text-shadow: 0 0 0 var(--glow-color);
}

.menu-link-glow:hover {
  text-shadow: 0 0 10px var(--glow-color), 0 0 20px var(--glow-color), 0 0 30px var(--glow-color);
}

/* === CSS CHO NỀN CHUYỂN ĐỘNG (SECTION 3) === */

/* 2. Keyframes (Giữ nguyên) */
@keyframes moveGradient {
  0% {
    background-position: 0% 50%;
  }
  50% {
    background-position: 100% 50%;
  }
  100% {
    background-position: 0% 50%;
  }
}

/* 3. Class animation (Chỉ cần 1 class duy nhất) */
.animated-gradient {
  /* Dùng 2 biến màu đã định nghĩa ở trên */
  background-image: linear-gradient(
    -45deg,
    var(--gradient-color-1),
    var(--gradient-color-2),
    var(--gradient-color-3)
  );
  background-size: 200% 200%;
  animation: moveGradient 5s ease-in-out infinite;
}


/* === CSS CHO BRAND SCROLLER (MỚI) === */
@keyframes infinite-scroll {
  from {
    transform: translateX(0);
  }
  to {
    transform: translateX(-100%);
  }
}

.animate-infinite-scroll {
  /* Tốc độ 40s. Bạn có thể điều chỉnh 40s thành số khác để nhanh/chậm hơn */
  animation: infinite-scroll 40s linear infinite;
}

/* === THANH CUỘN TINH TẾ === */

/* Áp dụng cho Firefox */
html {
  /* 1. Màu của Thumb (vị trí) - Dùng màu glow-color của bạn */
  scrollbar-color: var(--glow-color) var(--background);
  /* 2. Chiều rộng thanh cuộn */
  scrollbar-width: thin;
}

/* Áp dụng cho Chrome, Safari, Edge */

/* 1. Chiều rộng thanh cuộn */
body::-webkit-scrollbar {
  width: 8px;
}

/* 2. Màu của Track (đường chạy) - Đồng màu với nền */
body::-webkit-scrollbar-track {
  background: transparent;
}

/* 3. Màu của Thumb (vị trí) - Dùng màu của bạn */
body::-webkit-scrollbar-thumb {
  background-color: var(--foreground);
  border-radius: 4px;
}

/* 4. Tăng độ đậm khi hover lên thanh cuộn */
body::-webkit-scrollbar-thumb:hover {
  background-color: #ededed; /* Tùy chỉnh màu đậm hơn nếu muốn */
}

/* HTML: <div class="loader"></div> */
.loader {
  width: 50px;
  aspect-ratio: 1;
  display: grid;
  border: 4px solid #0000;
  border-radius: 50%;
  border-right-color: #25b09b;
  animation: l15 1s infinite linear;
}
.loader::before,
.loader::after {    
  content: "";
  grid-area: 1/1;
  margin: 2px;
  border: inherit;
  border-radius: 50%;
  animation: l15 2s infinite;
}
.loader::after {
  margin: 8px;
  animation-duration: 3s;
}
@keyframes l15{ 
  100%{transform: rotate(1turn)}
}

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.animate-fade-in-row {
  /* opacity ban đầu là 0 để tránh bị nháy */
  opacity: 0; 
  /* forwards giúp giữ trạng thái cuối cùng (opacity: 1) sau khi chạy xong */
  animation: fadeInUp 1s cubic-bezier(0.4, 0, 0.2, 1) forwards;
}

@layer utilities {
  /* Ẩn thanh cuộn cho Chrome, Safari and Opera */
  .no-scrollbar::-webkit-scrollbar {
    display: none;
  }
  /* Ẩn thanh cuộn cho IE, Edge and Firefox */
  .no-scrollbar {
    -ms-overflow-style: none;  /* IE and Edge */
    scrollbar-width: none;  /* Firefox */
  }

  /* Class dành riêng cho bảng */
  .table-scrollbar {
    /* Hỗ trợ Firefox (bắt buộc phải có dòng này Firefox mới hiện custom) */
    scrollbar-width: thin;
    scrollbar-color: var(--admin-sub) transparent;
  }

  /* Chrome, Edge, Safari */
  .table-scrollbar::-webkit-scrollbar {
    height: 8px; /* Chiều cao cho thanh ngang */
    width: 8px;  /* Chiều rộng cho thanh dọc */
  }

  .table-scrollbar::-webkit-scrollbar-track {
    background: transparent;
  }

  .table-scrollbar::-webkit-scrollbar-thumb {
    /* Dùng background-clip để tạo cảm giác thumb có padding */
    background-color: var(--admin-sub); 
    border-radius: 20px;
    border: 2px solid transparent; /* Tạo khoảng hở xung quanh thumb */
    background-clip: content-box; 
  }

  .table-scrollbar::-webkit-scrollbar-thumb:hover {
    background-color: var(--admin-fg);
  }
}

/* === GOOGLE CALENDAR RESOURCE VIEW OVERRIDES === */

/* 1. Header Cột Phòng (Day View) */
.rbc-time-header-content {
  border-left: 1px solid var(--admin-border) !important;
  background-color: var(--admin-card);
}

.rbc-resource-header-cell {
  /* Style cho tên phòng trên đầu cột */
  padding: 12px 0 !important;
  color: var(--admin-fg) !important;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

/* Màu riêng cho từng cột phòng (Optional: Tạo hiệu ứng xen kẽ) */
.rbc-day-slot {
  background-color: var(--admin-card);
  transition: background-color 0.2s;
}
.rbc-day-slot:hover {
  background-color: var(--admin-bg); /* Highlight nhẹ khi rê chuột vào cột phòng */
}
.rbc-events-container:hover {
  background-color: var(--admin-bg)/20; /* Đồng bộ với phần khung giờ */
}

/* 2. Grid & Lines */
.rbc-timeslot-group {
  border-bottom: none !important; /* Bỏ viền thừa giữa các khung giờ */
  min-height: 50px !important; /* Chiều cao mỗi giờ, đủ rộng để hiển thị thông tin */
}

.rbc-time-content {
  border-top: none !important; /* Bỏ viền thừa */
}

.rbc-time-gutter .rbc-timeslot-group {
  border-bottom: none !important; /* Cột giờ bên trái sạch sẽ */
}

/* 3. Sự kiện (Event Box) */
.rbc-event {
  border: none !important;
  padding: 0 !important;
  margin: 1px 2px !important; /* Cách lề một chút cho đẹp */
  border-radius: 4px !important;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  transition: transform 0.1s, z-index 0.1s;
  z-index: 50 !important;
}

.rbc-event:hover {
  transform: scale(1.02); /* Phóng to nhẹ khi hover sự kiện */
  z-index: 50 !important;
  box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

/* 4. Current Time Indicator (Vạch đỏ chỉ giờ) */
.rbc-current-time-indicator {
  background-color: #ea4335 !important;
  height: 2px !important;
}

/* 5. Ẩn các phần thừa */
.rbc-header {
  /* Ẩn header ngày tháng mặc định vì trong Resource View ta quan tâm tên phòng hơn */
  /* Hoặc giữ lại nếu muốn hiện cả Thứ ngày + Tên phòng */
  border-bottom: none !important; 
}
.rbc-allday-cell {
  /* Tùy chọn: Ẩn dòng All Day nếu ít dùng để tiết kiệm diện tích */
  display: none; 
}
.rbc-time-view-resources .rbc-time-gutter, .rbc-time-view-resources .rbc-time-header-gutter {
  background-color: var(--admin-card) !important;
}

.rbc-today {
  background-color: var(--admin-card) !important;
}



.rbc-time-view{
  border: none !important;
}

.rbc-day-slot .rbc-time-slot{
  border: none !important;
}

.rbc-timeslot-group{
  border-top: 1px solid var(--admin-border);
}



/* 1. Ẩn label của ô đầu tiên (00:00) */
.rbc-time-gutter .rbc-timeslot-group:first-child .rbc-label {
    display: none; /* Hoặc visibility: hidden; */
}

.rbc-time-slot .rbc-label {
  position: relative;
}

.rbc-label .rbc-time-header-gutter{
  min-width: 37.55px;
}
.rbc-label {
  width: 100%;
  position: absolute;
  top: -14px;
  background-color: var(--admin-card);
  font-size: 0.65em; 
  font-weight: 700;
  z-index: 10;
}

.rbc-time-view-resources .rbc-time-gutter, .rbc-time-view-resources .rbc-time-header-gutter{
  border-right: 1px solid var(--admin-border) !important;
}
.rbc-time-header-content > .rbc-row.rbc-row-resources {
  border-bottom: 1px solid var(--admin-border) !important;
}
.rbc-time-content > * + * > * {
  border-left: 1px solid var(--admin-border) !important;
}
.rbc-time-header-content > .rbc-row.rbc-row-resource {
  border-bottom: 1px solid var(--admin-border) !important;
}
.rbc-time-header.rbc-overflowing {
  border-right: none !important;
}


/* 1. Target vào container chứa nội dung lịch */
.rbc-time-content::-webkit-scrollbar {
    width: 3px; /* Độ rộng thanh cuộn (nhỏ gọn) */
    height: 3px; /* Độ cao thanh cuộn ngang (nếu có) */
}

/* 2. Phần rãnh (Track) - Nền của thanh cuộn */
.rbc-time-content::-webkit-scrollbar-track {
    background: transparent; /* Để trong suốt cho đẹp */
    /* Hoặc dùng màu: background: var(--admin-bg); */
}

/* 3. Phần tay cầm (Thumb) - Cái cục để kéo */
.rbc-time-content::-webkit-scrollbar-thumb {
    background-color: var(--admin-border); /* Màu xám nhẹ */
    border-radius: 10px; /* Bo tròn 2 đầu */
}

/* 4. Hiệu ứng khi di chuột vào tay cầm */
.rbc-time-content::-webkit-scrollbar-thumb:hover {
    background-color: var(--admin-sub); /* Đậm hơn chút khi hover */
}
```
